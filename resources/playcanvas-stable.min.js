/**
 * @license
 * PlayCanvas Engine v1.43.1 revision 49927b7
 * Copyright 2011-2021 PlayCanvas Ltd. All rights reserved.
 */
!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?factory(exports):"function"==typeof define&&define.amd?define(["exports"],factory):factory((global="undefined"!=typeof globalThis?globalThis:global||self).pc={})}(this,(function(exports){"use strict";Array.prototype.fill||Object.defineProperty(Array.prototype,"fill",{value:function value(_value){if(null==this)throw new TypeError("this is null or not defined");for(var O=Object(this),len=O.length>>>0,start=arguments[1],relativeStart=start>>0,k=relativeStart<0?Math.max(len+relativeStart,0):Math.min(relativeStart,len),end=arguments[2],relativeEnd=void 0===end?len:end>>0,finalValue=relativeEnd<0?Math.max(len+relativeEnd,0):Math.min(relativeEnd,len);k<finalValue;)O[k]=_value,k++;return O}}),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function value(predicate){if(null==this)throw TypeError('"this" is null or not defined');var o=Object(this),len=o.length>>>0;if("function"!=typeof predicate)throw TypeError("predicate must be a function");for(var thisArg=arguments[1],k=0;k<len;){var kValue=o[k];if(predicate.call(thisArg,kValue,k,o))return kValue;k++}},configurable:!0,writable:!0}),Array.prototype.findIndex||Object.defineProperty(Array.prototype,"findIndex",{value:function value(predicate){if(null==this)throw new TypeError('"this" is null or not defined');var o=Object(this),len=o.length>>>0;if("function"!=typeof predicate)throw new TypeError("predicate must be a function");for(var thisArg=arguments[1],k=0;k<len;){var kValue=o[k];if(predicate.call(thisArg,kValue,k,o))return k;k++}return-1},configurable:!0,writable:!0}),Math.log2=Math.log2||function(x){return Math.log(x)*Math.LOG2E},Math.sign||(Math.sign=function(x){return(x>0)-(x<0)||+x}),void 0===Number.isFinite&&(Number.isFinite=function(value){return"number"==typeof value&&isFinite(value)}),"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function assign(target,varArgs){if(null==target)throw new TypeError("Cannot convert undefined or null to object");for(var to=Object(target),index=1;index<arguments.length;index++){var nextSource=arguments[index];if(null!=nextSource)for(var nextKey in nextSource)Object.prototype.hasOwnProperty.call(nextSource,nextKey)&&(to[nextKey]=nextSource[nextKey])}return to},writable:!0,configurable:!0}),function(){if("undefined"!=typeof navigator&&"undefined"!=typeof document){navigator.pointer=navigator.pointer||navigator.webkitPointer||navigator.mozPointer;var pointerlockchange=function pointerlockchange(){var e=document.createEvent("CustomEvent");e.initCustomEvent("pointerlockchange",!0,!1,null),document.dispatchEvent(e)},pointerlockerror=function pointerlockerror(){var e=document.createEvent("CustomEvent");e.initCustomEvent("pointerlockerror",!0,!1,null),document.dispatchEvent(e)};document.addEventListener("webkitpointerlockchange",pointerlockchange,!1),document.addEventListener("webkitpointerlocklost",pointerlockchange,!1),document.addEventListener("mozpointerlockchange",pointerlockchange,!1),document.addEventListener("mozpointerlocklost",pointerlockchange,!1),document.addEventListener("webkitpointerlockerror",pointerlockerror,!1),document.addEventListener("mozpointerlockerror",pointerlockerror,!1),Element.prototype.mozRequestPointerLock?Element.prototype.requestPointerLock=function(){this.mozRequestPointerLock()}:Element.prototype.requestPointerLock=Element.prototype.requestPointerLock||Element.prototype.webkitRequestPointerLock||Element.prototype.mozRequestPointerLock,!Element.prototype.requestPointerLock&&navigator.pointer&&(Element.prototype.requestPointerLock=function(){var el=this;document.pointerLockElement=el,navigator.pointer.lock(el,pointerlockchange,pointerlockerror)}),document.exitPointerLock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock,document.exitPointerLock||(document.exitPointerLock=function(){navigator.pointer&&(document.pointerLockElement=null,navigator.pointer.unlock())})}}(),function(){if("undefined"!=typeof window){for(var lastTime=0,vendors=["ms","moz","webkit","o"],x=0;x<vendors.length&&!window.requestAnimationFrame;++x)window.requestAnimationFrame=window[vendors[x]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[vendors[x]+"CancelAnimationFrame"]||window[vendors[x]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(callback,element){var currTime=(new Date).getTime(),timeToCall=Math.max(0,16-(currTime-lastTime)),id=window.setTimeout((function(){callback(currTime+timeToCall)}),timeToCall);return lastTime=currTime+timeToCall,id}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(id){clearTimeout(id)})}}(),String.prototype.endsWith||(String.prototype.endsWith=function(search,this_len){return(void 0===this_len||this_len>this.length)&&(this_len=this.length),this.substring(this_len-search.length,this_len)===search}),String.prototype.includes||(String.prototype.includes=function(search,start){return"number"!=typeof start&&(start=0),!(start+search.length>this.length)&&-1!==this.indexOf(search,start)}),String.prototype.startsWith||(String.prototype.startsWith=function(search,pos){return this.substr(!pos||pos<0?0:+pos,search.length)===search}),Int8Array.prototype.fill||(Int8Array.prototype.fill=Array.prototype.fill),Uint8Array.prototype.fill||(Uint8Array.prototype.fill=Array.prototype.fill),Uint8ClampedArray.prototype.fill||(Uint8ClampedArray.prototype.fill=Array.prototype.fill),Int16Array.prototype.fill||(Int16Array.prototype.fill=Array.prototype.fill),Uint16Array.prototype.fill||(Uint16Array.prototype.fill=Array.prototype.fill),Int32Array.prototype.fill||(Int32Array.prototype.fill=Array.prototype.fill),Uint32Array.prototype.fill||(Uint32Array.prototype.fill=Array.prototype.fill),Float32Array.prototype.fill||(Float32Array.prototype.fill=Array.prototype.fill),function(){var glErrorShadow={};function error(msg){window.console&&window.console.error&&window.console.error(msg)}function log(msg){window.console&&window.console.log&&window.console.log(msg)}function synthesizeGLError(err,opt_msg){glErrorShadow[err]=!0,void 0!==opt_msg&&error(opt_msg)}function wrapGLError(gl){var f=gl.getError;gl.getError=function(){var err;do{(err=f.apply(gl))!=gl.NO_ERROR&&(glErrorShadow[err]=!0)}while(err!=gl.NO_ERROR);for(var err in glErrorShadow)if(glErrorShadow[err])return delete glErrorShadow[err],parseInt(err);return gl.NO_ERROR}}var WebGLVertexArrayObjectOES=function WebGLVertexArrayObjectOES(ext){var gl=ext.gl;this.ext=ext,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(ext.maxVertexAttribs);for(var n=0;n<this.attribs.length;n++){var attrib=new WebGLVertexArrayObjectOES.VertexAttrib(gl);this.attribs[n]=attrib}this.maxAttrib=0};(WebGLVertexArrayObjectOES.VertexAttrib=function VertexAttrib(gl){this.enabled=!1,this.buffer=null,this.size=4,this.type=gl.FLOAT,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()}).prototype.recache=function recache(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var OESVertexArrayObject=function OESVertexArrayObject(gl){var self=this;this.gl=gl,wrapGLError(gl);var original=this.original={getParameter:gl.getParameter,enableVertexAttribArray:gl.enableVertexAttribArray,disableVertexAttribArray:gl.disableVertexAttribArray,bindBuffer:gl.bindBuffer,getVertexAttrib:gl.getVertexAttrib,vertexAttribPointer:gl.vertexAttribPointer};gl.getParameter=function getParameter(pname){return pname==self.VERTEX_ARRAY_BINDING_OES?self.currentVertexArrayObject==self.defaultVertexArrayObject?null:self.currentVertexArrayObject:original.getParameter.apply(this,arguments)},gl.enableVertexAttribArray=function enableVertexAttribArray(index){var vao=self.currentVertexArrayObject;vao.maxAttrib=Math.max(vao.maxAttrib,index);var attrib=vao.attribs[index];return attrib.enabled=!0,original.enableVertexAttribArray.apply(this,arguments)},gl.disableVertexAttribArray=function disableVertexAttribArray(index){var vao=self.currentVertexArrayObject;vao.maxAttrib=Math.max(vao.maxAttrib,index);var attrib=vao.attribs[index];return attrib.enabled=!1,original.disableVertexAttribArray.apply(this,arguments)},gl.bindBuffer=function bindBuffer(target,buffer){switch(target){case gl.ARRAY_BUFFER:self.currentArrayBuffer=buffer;break;case gl.ELEMENT_ARRAY_BUFFER:self.currentVertexArrayObject.elementArrayBuffer=buffer}return original.bindBuffer.apply(this,arguments)},gl.getVertexAttrib=function getVertexAttrib(index,pname){var vao=self.currentVertexArrayObject,attrib=vao.attribs[index];switch(pname){case gl.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:return attrib.buffer;case gl.VERTEX_ATTRIB_ARRAY_ENABLED:return attrib.enabled;case gl.VERTEX_ATTRIB_ARRAY_SIZE:return attrib.size;case gl.VERTEX_ATTRIB_ARRAY_STRIDE:return attrib.stride;case gl.VERTEX_ATTRIB_ARRAY_TYPE:return attrib.type;case gl.VERTEX_ATTRIB_ARRAY_NORMALIZED:return attrib.normalized;default:return original.getVertexAttrib.apply(this,arguments)}},gl.vertexAttribPointer=function vertexAttribPointer(indx,size,type,normalized,stride,offset){var vao=self.currentVertexArrayObject;vao.maxAttrib=Math.max(vao.maxAttrib,indx);var attrib=vao.attribs[indx];return attrib.buffer=self.currentArrayBuffer,attrib.size=size,attrib.type=type,attrib.normalized=normalized,attrib.stride=stride,attrib.offset=offset,attrib.recache(),original.vertexAttribPointer.apply(this,arguments)},gl.instrumentExtension&&gl.instrumentExtension(this,"OES_vertex_array_object"),gl.canvas.addEventListener("webglcontextrestored",(function(){log("OESVertexArrayObject emulation library context restored"),self.reset_()}),!0),this.reset_()};OESVertexArrayObject.prototype.VERTEX_ARRAY_BINDING_OES=34229,OESVertexArrayObject.prototype.reset_=function reset_(){var contextWasLost;if(void 0!==this.vertexArrayObjects)for(var ii=0;ii<this.vertexArrayObjects.length;++ii)this.vertexArrayObjects.isAlive=!1;var gl=this.gl;this.maxVertexAttribs=gl.getParameter(gl.MAX_VERTEX_ATTRIBS),this.defaultVertexArrayObject=new WebGLVertexArrayObjectOES(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)},OESVertexArrayObject.prototype.createVertexArrayOES=function createVertexArrayOES(){var arrayObject=new WebGLVertexArrayObjectOES(this);return this.vertexArrayObjects.push(arrayObject),arrayObject},OESVertexArrayObject.prototype.deleteVertexArrayOES=function deleteVertexArrayOES(arrayObject){arrayObject.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(arrayObject),1),this.currentVertexArrayObject==arrayObject&&this.bindVertexArrayOES(null)},OESVertexArrayObject.prototype.isVertexArrayOES=function isVertexArrayOES(arrayObject){return!!(arrayObject&&arrayObject instanceof WebGLVertexArrayObjectOES&&arrayObject.hasBeenBound&&arrayObject.ext==this)},OESVertexArrayObject.prototype.bindVertexArrayOES=function bindVertexArrayOES(arrayObject){var gl=this.gl;if(!arrayObject||arrayObject.isAlive){var original=this.original,oldVAO=this.currentVertexArrayObject;this.currentVertexArrayObject=arrayObject||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;var newVAO=this.currentVertexArrayObject;if(oldVAO!=newVAO){oldVAO&&newVAO.elementArrayBuffer==oldVAO.elementArrayBuffer||original.bindBuffer.call(gl,gl.ELEMENT_ARRAY_BUFFER,newVAO.elementArrayBuffer);for(var currentBinding=this.currentArrayBuffer,maxAttrib=Math.max(oldVAO?oldVAO.maxAttrib:0,newVAO.maxAttrib),n=0;n<=maxAttrib;n++){var attrib=newVAO.attribs[n],oldAttrib=oldVAO?oldVAO.attribs[n]:null;if(oldVAO&&attrib.enabled==oldAttrib.enabled||(attrib.enabled?original.enableVertexAttribArray.call(gl,n):original.disableVertexAttribArray.call(gl,n)),attrib.enabled){var bufferChanged=!1;oldVAO&&attrib.buffer==oldAttrib.buffer||(currentBinding!=attrib.buffer&&(original.bindBuffer.call(gl,gl.ARRAY_BUFFER,attrib.buffer),currentBinding=attrib.buffer),bufferChanged=!0),(bufferChanged||attrib.cached!=oldAttrib.cached)&&original.vertexAttribPointer.call(gl,n,attrib.size,attrib.type,attrib.normalized,attrib.stride,attrib.offset)}}this.currentArrayBuffer!=currentBinding&&original.bindBuffer.call(gl,gl.ARRAY_BUFFER,this.currentArrayBuffer)}}else synthesizeGLError(gl.INVALID_OPERATION,"bindVertexArrayOES: attempt to bind deleted arrayObject")},window.setupVertexArrayObject=function(gl){var exts;if(gl.getSupportedExtensions){if(-1!=gl.getSupportedExtensions().indexOf("OES_vertex_array_object"))return}else if(gl.getExtension){var vao;if(gl.getExtension("OES_vertex_array_object"))return}if(gl.getSupportedExtensions){var original_getSupportedExtensions=gl.getSupportedExtensions;gl.getSupportedExtensions=function getSupportedExtensions(){var list=original_getSupportedExtensions.call(this)||[];return list.push("OES_vertex_array_object"),list}}var original_getExtension=gl.getExtension;gl.getExtension=function getExtension(name){return"OES_vertex_array_object"==name?(gl.__OESVertexArrayObject||(gl.__OESVertexArrayObject=new OESVertexArrayObject(gl)),gl.__OESVertexArrayObject):original_getExtension?original_getExtension.call(this,name):null}}}();var _typeLookup=function(){for(var result={},names=["Array","Object","Function","Date","RegExp","Float32Array"],i=0;i<names.length;i++)result["[object "+names[i]+"]"]=names[i].toLowerCase();return result}(),version="1.43.1",revision="49927b7",config={},common={},apps={},data={};function type$1(obj){if(null===obj)return"null";var type=typeof obj;return"undefined"===type||"number"===type||"string"===type||"boolean"===type?type:_typeLookup[Object.prototype.toString.call(obj)]}function extend(target,ex){for(var prop in ex){var copy=ex[prop];"object"===type$1(copy)?target[prop]=extend({},copy):"array"===type$1(copy)?target[prop]=extend([],copy):target[prop]=copy}return target}function isDefined(o){var a;return o!==a}var table=null,row=null,title=null,field=null;function init(){table=document.createElement("table"),row=document.createElement("tr"),title=document.createElement("td"),field=document.createElement("td"),table.style.cssText="position:absolute;font-family:sans-serif;font-size:12px;color:#cccccc",table.style.top="0px",table.style.left="0px",table.style.border="thin solid #cccccc",document.body.appendChild(table)}var debug={display:function display(data){for(var key in table||init(),table.innerHTML="",data){var r=row.cloneNode(),t=title.cloneNode(),f=field.cloneNode();t.textContent=key,f.textContent=data[key],r.appendChild(t),r.appendChild(f),table.appendChild(r)}}},EventHandler=function(){function EventHandler(){this.initEventHandler()}var _proto=EventHandler.prototype;return _proto.initEventHandler=function initEventHandler(){this._callbacks={},this._callbackActive={}},_proto._addCallback=function _addCallback(name,callback,scope,once){void 0===once&&(once=!1),name&&"string"==typeof name&&callback&&(this._callbacks[name]||(this._callbacks[name]=[]),this._callbackActive[name]&&this._callbackActive[name]===this._callbacks[name]&&(this._callbackActive[name]=this._callbackActive[name].slice()),this._callbacks[name].push({callback:callback,scope:scope||this,once:once}))},_proto.on=function on(name,callback,scope){return this._addCallback(name,callback,scope,!1),this},_proto.off=function off(name,callback,scope){if(name)this._callbackActive[name]&&this._callbackActive[name]===this._callbacks[name]&&(this._callbackActive[name]=this._callbackActive[name].slice());else for(var key in this._callbackActive)this._callbacks[key]&&this._callbacks[key]===this._callbackActive[key]&&(this._callbackActive[key]=this._callbackActive[key].slice());if(name)if(callback){var events=this._callbacks[name];if(!events)return this;for(var count=events.length,i=0;i<count;i++)events[i].callback===callback&&(scope&&events[i].scope!==scope||(events[i--]=events[--count]));events.length=count}else this._callbacks[name]&&(this._callbacks[name]=[]);else this._callbacks={};return this},_proto.fire=function fire(name,arg1,arg2,arg3,arg4,arg5,arg6,arg7,arg8){if(!name||!this._callbacks[name])return this;var callbacks;this._callbackActive[name]?(this._callbackActive[name]===this._callbacks[name]&&(this._callbackActive[name]=this._callbackActive[name].slice()),callbacks=this._callbacks[name].slice()):this._callbackActive[name]=this._callbacks[name];for(var i=0;(callbacks||this._callbackActive[name])&&i<(callbacks||this._callbackActive[name]).length;i++){var evt=(callbacks||this._callbackActive[name])[i];if(evt.callback.call(evt.scope,arg1,arg2,arg3,arg4,arg5,arg6,arg7,arg8),evt.once){var existingCallback=this._callbacks[name],ind=existingCallback?existingCallback.indexOf(evt):-1;-1!==ind&&(this._callbackActive[name]===existingCallback&&(this._callbackActive[name]=this._callbackActive[name].slice()),this._callbacks[name].splice(ind,1))}}return callbacks||(this._callbackActive[name]=null),this},_proto.once=function once(name,callback,scope){return this._addCallback(name,callback,scope,!0),this},_proto.hasEvent=function hasEvent(name){return this._callbacks[name]&&0!==this._callbacks[name].length||!1},EventHandler}(),events={attach:function attach(target){var ev=events;return target._addCallback=ev._addCallback,target.on=ev.on,target.off=ev.off,target.fire=ev.fire,target.once=ev.once,target.hasEvent=ev.hasEvent,target._callbacks={},target._callbackActive={},target},_addCallback:EventHandler.prototype._addCallback,on:EventHandler.prototype.on,off:EventHandler.prototype.off,fire:EventHandler.prototype.fire,once:EventHandler.prototype.once,hasEvent:EventHandler.prototype.hasEvent},guid={create:function create(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(c){var r=16*Math.random()|0,v;return("x"===c?r:3&r|8).toString(16)}))}},path={delimiter:"/",join:function join(){for(var num=arguments.length,result=arguments[0],index=0;index<num-1;++index){var one=arguments[index],two=arguments[index+1];if(!isDefined(one)||!isDefined(two))throw new Error("undefined argument to pc.path.join");two[0]!==path.delimiter?one&&two&&one[one.length-1]!==path.delimiter&&two[0]!==path.delimiter?result+=path.delimiter+two:result+=two:result=two}return result},normalize:function normalize(pathname){for(var lead=pathname.startsWith(path.delimiter),trail=pathname.endsWith(path.delimiter),parts=pathname.split("/"),result="",cleaned=[],i=0;i<parts.length;i++)""!==parts[i]&&"."!==parts[i]&&(".."===parts[i]&&cleaned.length>0?cleaned=cleaned.slice(0,cleaned.length-2):(i>0&&cleaned.push(path.delimiter),cleaned.push(parts[i])));return result=cleaned.join(""),lead||result[0]!==path.delimiter||(result=result.slice(1)),trail&&result[result.length-1]!==path.delimiter&&(result+=path.delimiter),result},split:function split(pathname){var parts=pathname.split(path.delimiter),tail=parts.slice(parts.length-1)[0],head;return[parts.slice(0,parts.length-1).join(path.delimiter),tail]},getBasename:function getBasename(pathname){return path.split(pathname)[1]},getDirectory:function getDirectory(pathname){var parts=pathname.split(path.delimiter);return parts.slice(0,parts.length-1).join(path.delimiter)},getExtension:function getExtension(pathname){var ext=pathname.split("?")[0].split(".").pop();return ext!==pathname?"."+ext:""},isRelativePath:function isRelativePath(pathname){return"/"!==pathname.charAt(0)&&null===pathname.match(/:\/\//)},extractPath:function extractPath(pathname){var result="",parts=pathname.split("/"),i=0;if(parts.length>1)if(path.isRelativePath(pathname))if("."===parts[0])for(i=0;i<parts.length-1;++i)result+=0===i?parts[i]:"/"+parts[i];else if(".."===parts[0])for(i=0;i<parts.length-1;++i)result+=0===i?parts[i]:"/"+parts[i];else for(result=".",i=0;i<parts.length-1;++i)result+="/"+parts[i];else for(i=0;i<parts.length-1;++i)result+=0===i?parts[i]:"/"+parts[i];return result}},desktop=!1,mobile=!1,windows=!1,xbox=!1,android=!1,ios=!1,touch=!1,gamepads=!1,workers=!1,passiveEvents=!1;if("undefined"!=typeof navigator){var ua=navigator.userAgent;/(windows|mac os|linux|cros)/i.test(ua)&&(desktop=!0),/xbox/i.test(ua)&&(xbox=!0),/(windows phone|iemobile|wpdesktop)/i.test(ua)?(desktop=!1,mobile=!0,windows=!0):/android/i.test(ua)?(desktop=!1,mobile=!0,android=!0):/ip([ao]d|hone)/i.test(ua)&&(desktop=!1,mobile=!0,ios=!0),"undefined"!=typeof window&&(touch="ontouchstart"in window||"maxTouchPoints"in navigator&&navigator.maxTouchPoints>0),gamepads="getGamepads"in navigator,workers="undefined"!=typeof Worker;try{var opts=Object.defineProperty({},"passive",{get:function get(){return passiveEvents=!0,!1}});window.addEventListener("testpassive",null,opts),window.removeEventListener("testpassive",null,opts)}catch(e){}}var platform={desktop:desktop,mobile:mobile,ios:ios,android:android,windows:windows,xbox:xbox,gamepads:gamepads,touch:touch,workers:workers,passiveEvents:passiveEvents},ASCII_LOWERCASE="abcdefghijklmnopqrstuvwxyz",ASCII_UPPERCASE="ABCDEFGHIJKLMNOPQRSTUVWXYZ",ASCII_LETTERS,HIGH_SURROGATE_BEGIN=55296,HIGH_SURROGATE_END=56319,LOW_SURROGATE_BEGIN=56320,LOW_SURROGATE_END=57343,ZERO_WIDTH_JOINER=8205,REGIONAL_INDICATOR_BEGIN=127462,REGIONAL_INDICATOR_END=127487,FITZPATRICK_MODIFIER_BEGIN=127995,FITZPATRICK_MODIFIER_END=127999,DIACRITICAL_MARKS_BEGIN=8400,DIACRITICAL_MARKS_END=8447,VARIATION_MODIFIER_BEGIN=65024,VARIATION_MODIFIER_END=65039;function getCodePointData(string,i){void 0===i&&(i=0);var size=string.length;if(i<0||i>=size)return null;var first=string.charCodeAt(i);if(size>1&&first>=55296&&first<=56319){var second=string.charCodeAt(i+1);if(second>=56320&&second<=57343)return{code:1024*(first-55296)+second-56320+65536,long:!0}}return{code:first,long:!1}}function isCodeBetween(string,begin,end){if(!string)return!1;var codeData=getCodePointData(string);if(codeData){var code=codeData.code;return code>=begin&&code<=end}return!1}function numCharsToTakeForNextSymbol(string,index){if(index===string.length-1)return 1;if(isCodeBetween(string[index],55296,56319)){var first=string.substring(index,index+2),second=string.substring(index+2,index+4);return isCodeBetween(second,127995,127999)||isCodeBetween(first,127462,127487)&&isCodeBetween(second,127462,127487)?4:isCodeBetween(second,65024,65039)?3:2}return isCodeBetween(string[index+1],65024,65039)?2:1}var string={ASCII_LOWERCASE:ASCII_LOWERCASE,ASCII_UPPERCASE:ASCII_UPPERCASE,ASCII_LETTERS:ASCII_LOWERCASE+ASCII_UPPERCASE,format:function format(s){for(var i=1;i<arguments.length;i++)s=s.replace("{"+(i-1)+"}",arguments[i]);return s},toBool:function toBool(s,strict){if(void 0===strict&&(strict=!1),"true"===s)return!0;if(strict){if("false"===s)return!1;throw new TypeError("Not a boolean string")}return!1},getCodePoint:function getCodePoint(string,i){var codePointData=getCodePointData(string,i);return codePointData&&codePointData.code},getCodePoints:function getCodePoints(string){if("string"!=typeof string)throw new TypeError("Not a string");for(var i=0,arr=[],codePoint;codePoint=getCodePointData(string,i);)arr.push(codePoint.code),i+=codePoint.long?2:1;return arr},getSymbols:function getSymbols(string){if("string"!=typeof string)throw new TypeError("Not a string");for(var index=0,length=string.length,output=[],take=0,ch;index<length;)if(isCodeBetween(ch=string[index+(take+=numCharsToTakeForNextSymbol(string,index+take))],8400,8447)&&(ch=string[index+take++]),isCodeBetween(ch,65024,65039)&&(ch=string[index+take++]),ch&&8205===ch.charCodeAt(0))ch=string[index+take++];else{var char=string.substring(index,index+take);output.push(char),index+=take,take=0}return output},fromCodePoint:function fromCodePoint(){for(var chars=[],current,codePoint,units,i=0;i<arguments.length;++i)codePoint=(current=Number(arguments[i]))-65536,units=current>65535?[55296+(codePoint>>10),codePoint%1024+56320]:[current],chars.push(String.fromCharCode.apply(null,units));return chars.join("")}},IndexedList=function(){function IndexedList(){this._list=[],this._index={}}var _proto=IndexedList.prototype;return _proto.push=function push(key,item){if(this._index[key])throw Error("Key already in index "+key);var location=this._list.push(item)-1;this._index[key]=location},_proto.has=function has(key){return void 0!==this._index[key]},_proto.get=function get(key){var location=this._index[key];return void 0!==location?this._list[location]:null},_proto.remove=function remove(key){var location=this._index[key];if(void 0!==location){for(key in this._list.splice(location,1),delete this._index[key],this._index){var idx=this._index[key];idx>location&&(this._index[key]=idx-1)}return!0}return!1},_proto.list=function list(){return this._list},_proto.clear=function clear(){for(var prop in this._list.length=0,this._index)delete this._index[prop]},IndexedList}(),SortedLoopArray=function(){function SortedLoopArray(args){this._sortBy=args.sortBy,this.items=[],this.length=0,this.loopIndex=-1,this._sortHandler=this._doSort.bind(this)}var _proto=SortedLoopArray.prototype;return _proto._binarySearch=function _binarySearch(item){for(var left=0,right=this.items.length-1,search=item[this._sortBy],middle,current;left<=right;)middle=Math.floor((left+right)/2),(current=this.items[middle][this._sortBy])<=search?left=middle+1:current>search&&(right=middle-1);return left},_proto._doSort=function _doSort(a,b){var sortBy=this._sortBy;return a[sortBy]-b[sortBy]},_proto.insert=function insert(item){var index=this._binarySearch(item);this.items.splice(index,0,item),this.length++,this.loopIndex>=index&&this.loopIndex++},_proto.append=function append(item){this.items.push(item),this.length++},_proto.remove=function remove(item){var idx=this.items.indexOf(item);idx<0||(this.items.splice(idx,1),this.length--,this.loopIndex>=idx&&this.loopIndex--)},_proto.sort=function sort(){var current=this.loopIndex>=0?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler),null!==current&&(this.loopIndex=this.items.indexOf(current))},SortedLoopArray}();function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}function _extends(){return(_extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target}).apply(this,arguments)}function _inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype),subClass.prototype.constructor=subClass,_setPrototypeOf(subClass,superClass)}function _setPrototypeOf(o,p){return(_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(o,p){return o.__proto__=p,o})(o,p)}function _assertThisInitialized(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}function _unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(o,minLen):void 0}}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function _createForOfIteratorHelperLoose(o,allowArrayLike){var it="undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(it)return(it=it.call(o)).next.bind(it);if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0;return function(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var Tags=function(_EventHandler){function Tags(parent){var _this;return(_this=_EventHandler.call(this)||this)._index={},_this._list=[],_this._parent=parent,_this}_inheritsLoose(Tags,_EventHandler);var _proto=Tags.prototype;return _proto.add=function add(){var changed=!1,tags=this._processArguments(arguments,!0);if(!tags.length)return changed;for(var i=0;i<tags.length;i++)this._index[tags[i]]||(changed=!0,this._index[tags[i]]=!0,this._list.push(tags[i]),this.fire("add",tags[i],this._parent));return changed&&this.fire("change",this._parent),changed},_proto.remove=function remove(){var changed=!1;if(!this._list.length)return changed;var tags=this._processArguments(arguments,!0);if(!tags.length)return changed;for(var i=0;i<tags.length;i++)this._index[tags[i]]&&(changed=!0,delete this._index[tags[i]],this._list.splice(this._list.indexOf(tags[i]),1),this.fire("remove",tags[i],this._parent));return changed&&this.fire("change",this._parent),changed},_proto.clear=function clear(){if(this._list.length){var tags=this._list.slice(0);this._list=[],this._index={};for(var i=0;i<tags.length;i++)this.fire("remove",tags[i],this._parent);this.fire("change",this._parent)}},_proto.has=function has(){return!!this._list.length&&this._has(this._processArguments(arguments))},_proto._has=function _has(tags){if(!this._list.length||!tags.length)return!1;for(var i=0;i<tags.length;i++)if(1===tags[i].length){if(this._index[tags[i][0]])return!0}else{for(var multiple=!0,t=0;t<tags[i].length;t++)if(!this._index[tags[i][t]]){multiple=!1;break}if(multiple)return!0}return!1},_proto.list=function list(){return this._list.slice(0)},_proto._processArguments=function _processArguments(args,flat){var tags=[],tmp=[];if(!args||!args.length)return tags;for(var i=0;i<args.length;i++)if(args[i]instanceof Array){flat||(tmp=[]);for(var t=0;t<args[i].length;t++)"string"==typeof args[i][t]&&(flat?tags.push(args[i][t]):tmp.push(args[i][t]));!flat&&tmp.length&&tags.push(tmp)}else"string"==typeof args[i]&&(flat?tags.push(args[i]):tags.push([args[i]]));return tags},_createClass(Tags,[{key:"size",get:function get(){return this._list.length}}]),Tags}(EventHandler),now="undefined"!=typeof window&&window.performance&&window.performance.now&&window.performance.timing?function(){return window.performance.now()}:Date.now,Timer=function(){function Timer(){this._isRunning=!1,this._a=0,this._b=0}var _proto=Timer.prototype;return _proto.start=function start(){this._isRunning=!0,this._a=now()},_proto.stop=function stop(){this._isRunning=!1,this._b=now()},_proto.getMilliseconds=function getMilliseconds(){return this._b-this._a},Timer}();function createURI(options){var s="";if((options.authority||options.scheme)&&(options.host||options.hostpath))throw new Error("Can't have 'scheme' or 'authority' and 'host' or 'hostpath' option");if(options.host&&options.hostpath)throw new Error("Can't have 'host' and 'hostpath' option");if(options.path&&options.hostpath)throw new Error("Can't have 'path' and 'hostpath' option");return options.scheme&&(s+=options.scheme+":"),options.authority&&(s+="//"+options.authority),options.host&&(s+=options.host),options.path&&(s+=options.path),options.hostpath&&(s+=options.hostpath),options.query&&(s+="?"+options.query),options.fragment&&(s+="#"+options.fragment),s}var re=/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/,URI=function(){function URI(uri){var result=uri.match(re);this.scheme=result[2],this.authority=result[4],this.path=result[5],this.query=result[7],this.fragment=result[9]}var _proto=URI.prototype;return _proto.toString=function toString(){var s="";return this.scheme&&(s+=this.scheme+":"),this.authority&&(s+="//"+this.authority),s+=this.path,this.query&&(s+="?"+this.query),this.fragment&&(s+="#"+this.fragment),s},_proto.getQuery=function getQuery(){var result={};if(this.query)for(var queryParams,_iterator=_createForOfIteratorHelperLoose(decodeURIComponent(this.query).split("&")),_step;!(_step=_iterator()).done;){var queryParam,pair=_step.value.split("=");result[pair[0]]=pair[1]}return result},_proto.setQuery=function setQuery(params){var q="";for(var key in params)params.hasOwnProperty(key)&&(""!==q&&(q+="&"),q+=encodeURIComponent(key)+"="+encodeURIComponent(params[key]));this.query=q},URI}(),math={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:function clamp(value,min,max){return value>=max?max:value<=min?min:value},intToBytes24:function intToBytes24(i){var r,g,b;return[i>>16&255,i>>8&255,255&i]},intToBytes32:function intToBytes32(i){var r,g,b,a;return[i>>24&255,i>>16&255,i>>8&255,255&i]},bytesToInt24:function bytesToInt24(r,g,b){return r.length&&(b=r[2],g=r[1],r=r[0]),r<<16|g<<8|b},bytesToInt32:function bytesToInt32(r,g,b,a){return r.length&&(a=r[3],b=r[2],g=r[1],r=r[0]),(r<<24|g<<16|b<<8|a)>>>32},lerp:function lerp(a,b,alpha){return a+(b-a)*math.clamp(alpha,0,1)},lerpAngle:function lerpAngle(a,b,alpha){return b-a>180&&(b-=360),b-a<-180&&(b+=360),math.lerp(a,b,math.clamp(alpha,0,1))},powerOfTwo:function powerOfTwo(x){return 0!==x&&!(x&x-1)},nextPowerOfTwo:function nextPowerOfTwo(val){return val--,val|=val>>1,val|=val>>2,val|=val>>4,val|=val>>8,val|=val>>16,++val},random:function random(min,max){var diff=max-min;return Math.random()*diff+min},smoothstep:function smoothstep(min,max,x){return x<=min?0:x>=max?1:(x=(x-min)/(max-min))*x*(3-2*x)},smootherstep:function smootherstep(min,max,x){return x<=min?0:x>=max?1:(x=(x-min)/(max-min))*x*x*(x*(6*x-15)+10)},roundUp:function roundUp(numToRound,multiple){return 0===multiple?numToRound:Math.ceil(numToRound/multiple)*multiple},float2Half:(floatView=new Float32Array(1),int32View=new Int32Array(floatView.buffer),function(val){floatView[0]=val;var x=int32View[0],bits=x>>16&32768,m=x>>12&2047,e=x>>23&255;return e<103?bits:e>142?(bits|=31744,bits|=(255===e?0:1)&&8388607&x):e<113?bits|=((m|=2048)>>114-e)+(m>>113-e&1):(bits|=e-112<<10|m>>1,bits+=1&m)}),between:function between(num,a,b,inclusive){var min=Math.min(a,b),max=Math.max(a,b);return inclusive?num>=min&&num<=max:num>min&&num<max}},floatView,int32View,Http=function(){function Http(){this.ContentType=Http.ContentType,this.ResponseType=Http.ResponseType,this.binaryExtensions=Http.binaryExtensions}var _proto=Http.prototype;return _proto.get=function get(url,options,callback){return"function"==typeof options&&(callback=options,options={}),this.request("GET",url,options,callback)},_proto.post=function post(url,data,options,callback){return"function"==typeof options&&(callback=options,options={}),options.postdata=data,this.request("POST",url,options,callback)},_proto.put=function put(url,data,options,callback){return"function"==typeof options&&(callback=options,options={}),options.postdata=data,this.request("PUT",url,options,callback)},_proto.del=function del(url,options,callback){return"function"==typeof options&&(callback=options,options={}),this.request("DELETE",url,options,callback)},_proto.request=function request(method,url,options,callback){var uri,query,timestamp,postdata,xhr,errored=!1;if("function"==typeof options&&(callback=options,options={}),options.retry&&(options=Object.assign({retries:0,maxRetries:5},options)),options.callback=callback,null==options.async&&(options.async=!0),null==options.headers&&(options.headers={}),null!=options.postdata)if(options.postdata instanceof Document)postdata=options.postdata;else if(options.postdata instanceof FormData)postdata=options.postdata;else if(options.postdata instanceof Object){var contentType=options.headers["Content-Type"];switch(void 0===contentType&&(options.headers["Content-Type"]=Http.ContentType.FORM_URLENCODED,contentType=options.headers["Content-Type"]),contentType){case Http.ContentType.FORM_URLENCODED:postdata="";var bFirstItem=!0;for(var key in options.postdata)options.postdata.hasOwnProperty(key)&&(bFirstItem?bFirstItem=!1:postdata+="&",postdata+=escape(key)+"="+escape(options.postdata[key]));break;default:case Http.ContentType.JSON:null==contentType&&(options.headers["Content-Type"]=Http.ContentType.JSON),postdata=JSON.stringify(options.postdata)}}else postdata=options.postdata;for(var header in!1===options.cache&&(timestamp=now(),(uri=new URI(url)).query?uri.query=uri.query+"&ts="+timestamp:uri.query="ts="+timestamp,url=uri.toString()),options.query&&(query=extend((uri=new URI(url)).getQuery(),options.query),uri.setQuery(query),url=uri.toString()),(xhr=new XMLHttpRequest).open(method,url,options.async),xhr.withCredentials=void 0!==options.withCredentials&&options.withCredentials,xhr.responseType=options.responseType||this._guessResponseType(url),options.headers)options.headers.hasOwnProperty(header)&&xhr.setRequestHeader(header,options.headers[header]);xhr.onreadystatechange=function(){this._onReadyStateChange(method,url,options,xhr)}.bind(this),xhr.onerror=function(){this._onError(method,url,options,xhr),errored=!0}.bind(this);try{xhr.send(postdata)}catch(e){errored||options.error(xhr.status,xhr,e)}return xhr},_proto._guessResponseType=function _guessResponseType(url){var uri=new URI(url),ext=path.getExtension(uri.path);return Http.binaryExtensions.indexOf(ext)>=0?Http.ResponseType.ARRAY_BUFFER:".xml"===ext?Http.ResponseType.DOCUMENT:Http.ResponseType.TEXT},_proto._isBinaryContentType=function _isBinaryContentType(contentType){var binTypes;return[Http.ContentType.MP4,Http.ContentType.WAV,Http.ContentType.OGG,Http.ContentType.MP3,Http.ContentType.BIN,Http.ContentType.DDS,Http.ContentType.BASIS,Http.ContentType.GLB].indexOf(contentType)>=0},_proto._onReadyStateChange=function _onReadyStateChange(method,url,options,xhr){if(4===xhr.readyState)switch(xhr.status){case 0:xhr.responseURL&&xhr.responseURL.startsWith("file:///")?this._onSuccess(method,url,options,xhr):this._onError(method,url,options,xhr);break;case 200:case 201:case 206:case 304:this._onSuccess(method,url,options,xhr);break;default:this._onError(method,url,options,xhr)}},_proto._onSuccess=function _onSuccess(method,url,options,xhr){var response,header,contentType,parts;(header=xhr.getResponseHeader("Content-Type"))&&(contentType=(parts=header.split(";"))[0].trim());try{response=contentType===this.ContentType.JSON||url.split("?")[0].endsWith(".json")?JSON.parse(xhr.responseText):this._isBinaryContentType(contentType)?xhr.response:xhr.responseType===Http.ResponseType.ARRAY_BUFFER?xhr.response:xhr.responseType===Http.ResponseType.BLOB||xhr.responseType===Http.ResponseType.JSON?xhr.response:xhr.responseType===Http.ResponseType.DOCUMENT||contentType===this.ContentType.XML?xhr.responseXML:xhr.responseText,options.callback(null,response)}catch(err){options.callback(err)}},_proto._onError=function _onError(method,url,options,xhr){if(!options.retrying)if(options.retry&&options.retries<options.maxRetries){options.retries++,options.retrying=!0;var retryDelay=math.clamp(Math.pow(2,options.retries)*Http.retryDelay,0,options.maxRetryDelay||5e3);console.log(method+": "+url+" - Error "+xhr.status+". Retrying in "+retryDelay+" ms"),setTimeout(function(){options.retrying=!1,this.request(method,url,options,options.callback)}.bind(this),retryDelay)}else options.callback(0===xhr.status?"Network error":xhr.status,null)},Http}();Http.ContentType={FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",JPEG:"image/jpeg",DDS:"image/dds",JSON:"application/json",PNG:"image/png",TEXT:"text/plain",XML:"application/xml",WAV:"audio/x-wav",OGG:"audio/ogg",MP3:"audio/mpeg",MP4:"audio/mp4",AAC:"audio/aac",BIN:"application/octet-stream",BASIS:"image/basis",GLB:"model/gltf-binary"},Http.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"},Http.binaryExtensions=[".model",".wav",".ogg",".mp3",".mp4",".m4a",".aac",".dds",".basis",".glb"],Http.retryDelay=100;var http=new Http,CURVE_LINEAR=0,CURVE_SMOOTHSTEP=1,CURVE_CATMULL=2,CURVE_CARDINAL=3,CURVE_SPLINE=4,CURVE_STEP=5,Color=function(){function Color(r,g,b,a){void 0===r&&(r=0),void 0===g&&(g=0),void 0===b&&(b=0),void 0===a&&(a=1);var length=r.length;3===length||4===length?(this.r=r[0],this.g=r[1],this.b=r[2],this.a=void 0!==r[3]?r[3]:1):(this.r=r,this.g=g,this.b=b,this.a=a)}var _proto=Color.prototype;return _proto.clone=function clone(){return new Color(this.r,this.g,this.b,this.a)},_proto.copy=function copy(rhs){return this.r=rhs.r,this.g=rhs.g,this.b=rhs.b,this.a=rhs.a,this},_proto.equals=function equals(rhs){return this.r===rhs.r&&this.g===rhs.g&&this.b===rhs.b&&this.a===rhs.a},_proto.set=function set(r,g,b,a){return void 0===a&&(a=1),this.r=r,this.g=g,this.b=b,this.a=a,this},_proto.lerp=function lerp(lhs,rhs,alpha){return this.r=lhs.r+alpha*(rhs.r-lhs.r),this.g=lhs.g+alpha*(rhs.g-lhs.g),this.b=lhs.b+alpha*(rhs.b-lhs.b),this.a=lhs.a+alpha*(rhs.a-lhs.a),this},_proto.fromString=function fromString(hex){var i=parseInt(hex.replace("#","0x"),16),bytes;return hex.length>7?bytes=math.intToBytes32(i):(bytes=math.intToBytes24(i))[3]=255,this.set(bytes[0]/255,bytes[1]/255,bytes[2]/255,bytes[3]/255),this},_proto.toString=function toString(alpha){var s="#"+((1<<24)+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)).toString(16).slice(1);if(!0===alpha){var a=Math.round(255*this.a).toString(16);this.a<16/255?s+="0"+a:s+=a}return s},Color}();Color.BLACK=Object.freeze(new Color(0,0,0,1)),Color.BLUE=Object.freeze(new Color(0,0,1,1)),Color.CYAN=Object.freeze(new Color(0,1,1,1)),Color.GRAY=Object.freeze(new Color(.5,.5,.5,1)),Color.GREEN=Object.freeze(new Color(0,1,0,1)),Color.MAGENTA=Object.freeze(new Color(1,0,1,1)),Color.RED=Object.freeze(new Color(1,0,0,1)),Color.WHITE=Object.freeze(new Color(1,1,1,1)),Color.YELLOW=Object.freeze(new Color(1,1,0,1));var CurveEvaluator=function(){function CurveEvaluator(curve,time){this._curve=curve,this._left=-1/0,this._right=1/0,this._recip=0,this._p0=0,this._p1=0,this._m0=0,this._m1=0,this._reset(time||0)}var _proto=CurveEvaluator.prototype;return _proto.evaluate=function evaluate(time,forceReset){var result;(forceReset||time<this._left||time>=this._right)&&this._reset(time);var type=this._curve.type;if(5===type)result=this._p0;else{var t=0===this._recip?0:(time-this._left)*this._recip;result=0===type?math.lerp(this._p0,this._p1,t):1===type?math.lerp(this._p0,this._p1,t*t*(3-2*t)):this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,t)}return result},_proto._reset=function _reset(time){var keys=this._curve.keys,len=keys.length;if(len)if(time<keys[0][0])this._left=-1/0,this._right=keys[0][0],this._recip=0,this._p0=this._p1=keys[0][1],this._m0=this._m1=0;else if(time>=keys[len-1][0])this._left=keys[len-1][0],this._right=1/0,this._recip=0,this._p0=this._p1=keys[len-1][1],this._m0=this._m1=0;else{for(var index=0;time>=keys[index+1][0];)index++;this._left=keys[index][0],this._right=keys[index+1][0];var diff=1/(this._right-this._left);this._recip=isFinite(diff)?diff:0,this._p0=keys[index][1],this._p1=keys[index+1][1],this._isHermite()&&this._calcTangents(keys,index)}else this._left=-1/0,this._right=1/0,this._recip=0,this._p0=this._p1=this._m0=this._m1=0},_proto._isHermite=function _isHermite(){return 2===this._curve.type||3===this._curve.type||4===this._curve.type},_proto._calcTangents=function _calcTangents(keys,index){var a,b=keys[index],c=keys[index+1],d;if(a=0===index?[keys[0][0]+(keys[0][0]-keys[1][0]),keys[0][1]+(keys[0][1]-keys[1][1])]:keys[index-1],d=index===keys.length-2?[keys[index+1][0]+(keys[index+1][0]-keys[index][0]),keys[index+1][1]+(keys[index+1][1]-keys[index][1])]:keys[index+2],4===this._curve.type){var s1_=2*(c[0]-b[0])/(c[0]-a[0]),s2_=2*(c[0]-b[0])/(d[0]-b[0]);this._m0=this._curve.tension*(isFinite(s1_)?s1_:0)*(c[1]-a[1]),this._m1=this._curve.tension*(isFinite(s2_)?s2_:0)*(d[1]-b[1])}else{var s1=(c[0]-b[0])/(b[0]-a[0]),s2=(c[0]-b[0])/(d[0]-c[0]),a_=b[1]+(a[1]-b[1])*(isFinite(s1)?s1:0),d_=c[1]+(d[1]-c[1])*(isFinite(s2)?s2:0),tension=2===this._curve.type?.5:this._curve.tension;this._m0=tension*(c[1]-a_),this._m1=tension*(d_-b[1])}},_proto._evaluateHermite=function _evaluateHermite(p0,p1,m0,m1,t){var t2=t*t,twot=t+t,omt=1-t,omt2=omt*omt;return p0*((1+twot)*omt2)+m0*(t*omt2)+p1*(t2*(3-twot))+m1*(t2*(t-1))},CurveEvaluator}(),Curve=function(){function Curve(data){if(this.keys=[],this.type=1,this.tension=.5,this._eval=new CurveEvaluator(this),data)for(var i=0;i<data.length-1;i+=2)this.keys.push([data[i],data[i+1]]);this.sort()}var _proto=Curve.prototype;return _proto.add=function add(time,value){for(var keys=this.keys,len=keys.length,i=0;i<len&&!(keys[i][0]>time);i++);var key=[time,value];return this.keys.splice(i,0,key),key},_proto.get=function get(index){return this.keys[index]},_proto.sort=function sort(){this.keys.sort((function(a,b){return a[0]-b[0]}))},_proto.value=function value(time){return this._eval.evaluate(time,!0)},_proto.closest=function closest(time){for(var keys=this.keys,length=keys.length,min=2,result=null,i=0;i<length;i++){var diff=Math.abs(time-keys[i][0]);if(!(min>=diff))break;min=diff,result=keys[i]}return result},_proto.clone=function clone(){var result=new Curve;return result.keys=extend(result.keys,this.keys),result.type=this.type,result.tension=this.tension,result},_proto.quantize=function quantize(precision){precision=Math.max(precision,2);var values=new Float32Array(precision),step=1/(precision-1);values[0]=this._eval.evaluate(0,!0);for(var i=1;i<precision;i++)values[i]=this._eval.evaluate(step*i);return values},_proto.quantizeClamped=function quantizeClamped(precision,min,max){for(var result=this.quantize(precision),i=0;i<result.length;++i)result[i]=Math.min(max,Math.max(min,result[i]));return result},_createClass(Curve,[{key:"length",get:function get(){return this.keys.length}}]),Curve}(),CurveSet=function(){function CurveSet(){if(this.curves=[],this._type=1,arguments.length>1)for(var i=0;i<arguments.length;i++)this.curves.push(new Curve(arguments[i]));else if(0===arguments.length)this.curves.push(new Curve);else{var arg=arguments[0];if("number"==typeof arg)for(var _i=0;_i<arg;_i++)this.curves.push(new Curve);else for(var _i2=0;_i2<arg.length;_i2++)this.curves.push(new Curve(arg[_i2]))}}var _proto=CurveSet.prototype;return _proto.get=function get(index){return this.curves[index]},_proto.value=function value(time,result){void 0===result&&(result=[]);var length=this.curves.length;result.length=length;for(var i=0;i<length;i++)result[i]=this.curves[i].value(time);return result},_proto.clone=function clone(){var result=new CurveSet;result.curves=[];for(var i=0;i<this.curves.length;i++)result.curves.push(this.curves[i].clone());return result._type=this._type,result},_proto.quantize=function quantize(precision){precision=Math.max(precision,2);for(var numCurves=this.curves.length,values=new Float32Array(precision*numCurves),step=1/(precision-1),c=0;c<numCurves;c++)for(var ev=new CurveEvaluator(this.curves[c]),i=0;i<precision;i++)values[i*numCurves+c]=ev.evaluate(step*i);return values},_proto.quantizeClamped=function quantizeClamped(precision,min,max){for(var result=this.quantize(precision),i=0;i<result.length;++i)result[i]=Math.min(max,Math.max(min,result[i]));return result},_createClass(CurveSet,[{key:"length",get:function get(){return this.curves.length}},{key:"type",get:function get(){return this._type},set:function set(value){this._type=value;for(var i=0;i<this.curves.length;i++)this.curves[i].type=value}}]),CurveSet}(),Vec3=function(){function Vec3(x,y,z){void 0===x&&(x=0),void 0===y&&(y=0),void 0===z&&(z=0),3===x.length?(this.x=x[0],this.y=x[1],this.z=x[2]):(this.x=x,this.y=y,this.z=z)}var _proto=Vec3.prototype;return _proto.add=function add(rhs){return this.x+=rhs.x,this.y+=rhs.y,this.z+=rhs.z,this},_proto.add2=function add2(lhs,rhs){return this.x=lhs.x+rhs.x,this.y=lhs.y+rhs.y,this.z=lhs.z+rhs.z,this},_proto.addScalar=function addScalar(scalar){return this.x+=scalar,this.y+=scalar,this.z+=scalar,this},_proto.clone=function clone(){return new Vec3(this.x,this.y,this.z)},_proto.copy=function copy(rhs){return this.x=rhs.x,this.y=rhs.y,this.z=rhs.z,this},_proto.cross=function cross(lhs,rhs){var lx=lhs.x,ly=lhs.y,lz=lhs.z,rx=rhs.x,ry=rhs.y,rz=rhs.z;return this.x=ly*rz-ry*lz,this.y=lz*rx-rz*lx,this.z=lx*ry-rx*ly,this},_proto.distance=function distance(rhs){var x=this.x-rhs.x,y=this.y-rhs.y,z=this.z-rhs.z;return Math.sqrt(x*x+y*y+z*z)},_proto.div=function div(rhs){return this.x/=rhs.x,this.y/=rhs.y,this.z/=rhs.z,this},_proto.div2=function div2(lhs,rhs){return this.x=lhs.x/rhs.x,this.y=lhs.y/rhs.y,this.z=lhs.z/rhs.z,this},_proto.divScalar=function divScalar(scalar){return this.x/=scalar,this.y/=scalar,this.z/=scalar,this},_proto.dot=function dot(rhs){return this.x*rhs.x+this.y*rhs.y+this.z*rhs.z},_proto.equals=function equals(rhs){return this.x===rhs.x&&this.y===rhs.y&&this.z===rhs.z},_proto.length=function length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},_proto.lengthSq=function lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z},_proto.lerp=function lerp(lhs,rhs,alpha){return this.x=lhs.x+alpha*(rhs.x-lhs.x),this.y=lhs.y+alpha*(rhs.y-lhs.y),this.z=lhs.z+alpha*(rhs.z-lhs.z),this},_proto.mul=function mul(rhs){return this.x*=rhs.x,this.y*=rhs.y,this.z*=rhs.z,this},_proto.mul2=function mul2(lhs,rhs){return this.x=lhs.x*rhs.x,this.y=lhs.y*rhs.y,this.z=lhs.z*rhs.z,this},_proto.mulScalar=function mulScalar(scalar){return this.x*=scalar,this.y*=scalar,this.z*=scalar,this},_proto.normalize=function normalize(){var lengthSq=this.x*this.x+this.y*this.y+this.z*this.z;if(lengthSq>0){var invLength=1/Math.sqrt(lengthSq);this.x*=invLength,this.y*=invLength,this.z*=invLength}return this},_proto.floor=function floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this},_proto.ceil=function ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this},_proto.round=function round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this},_proto.min=function min(rhs){return rhs.x<this.x&&(this.x=rhs.x),rhs.y<this.y&&(this.y=rhs.y),rhs.z<this.z&&(this.z=rhs.z),this},_proto.max=function max(rhs){return rhs.x>this.x&&(this.x=rhs.x),rhs.y>this.y&&(this.y=rhs.y),rhs.z>this.z&&(this.z=rhs.z),this},_proto.project=function project(rhs){var a_dot_b,b_dot_b,s=(this.x*rhs.x+this.y*rhs.y+this.z*rhs.z)/(rhs.x*rhs.x+rhs.y*rhs.y+rhs.z*rhs.z);return this.x=rhs.x*s,this.y=rhs.y*s,this.z=rhs.z*s,this},_proto.set=function set(x,y,z){return this.x=x,this.y=y,this.z=z,this},_proto.sub=function sub(rhs){return this.x-=rhs.x,this.y-=rhs.y,this.z-=rhs.z,this},_proto.sub2=function sub2(lhs,rhs){return this.x=lhs.x-rhs.x,this.y=lhs.y-rhs.y,this.z=lhs.z-rhs.z,this},_proto.subScalar=function subScalar(scalar){return this.x-=scalar,this.y-=scalar,this.z-=scalar,this},_proto.toString=function toString(){return"["+this.x+", "+this.y+", "+this.z+"]"},Vec3}();Vec3.ZERO=Object.freeze(new Vec3(0,0,0)),Vec3.ONE=Object.freeze(new Vec3(1,1,1)),Vec3.UP=Object.freeze(new Vec3(0,1,0)),Vec3.DOWN=Object.freeze(new Vec3(0,-1,0)),Vec3.RIGHT=Object.freeze(new Vec3(1,0,0)),Vec3.LEFT=Object.freeze(new Vec3(-1,0,0)),Vec3.FORWARD=Object.freeze(new Vec3(0,0,-1)),Vec3.BACK=Object.freeze(new Vec3(0,0,1));var Mat3=function(){function Mat3(){var data=new Float32Array(9);data[0]=data[4]=data[8]=1,this.data=data}var _proto=Mat3.prototype;return _proto.clone=function clone(){return(new Mat3).copy(this)},_proto.copy=function copy(rhs){var src=rhs.data,dst=this.data;return dst[0]=src[0],dst[1]=src[1],dst[2]=src[2],dst[3]=src[3],dst[4]=src[4],dst[5]=src[5],dst[6]=src[6],dst[7]=src[7],dst[8]=src[8],this},_proto.set=function set(src){var dst=this.data;return dst[0]=src[0],dst[1]=src[1],dst[2]=src[2],dst[3]=src[3],dst[4]=src[4],dst[5]=src[5],dst[6]=src[6],dst[7]=src[7],dst[8]=src[8],this},_proto.equals=function equals(rhs){var l=this.data,r=rhs.data;return l[0]===r[0]&&l[1]===r[1]&&l[2]===r[2]&&l[3]===r[3]&&l[4]===r[4]&&l[5]===r[5]&&l[6]===r[6]&&l[7]===r[7]&&l[8]===r[8]},_proto.isIdentity=function isIdentity(){var m=this.data;return 1===m[0]&&0===m[1]&&0===m[2]&&0===m[3]&&1===m[4]&&0===m[5]&&0===m[6]&&0===m[7]&&1===m[8]},_proto.setIdentity=function setIdentity(){var m=this.data;return m[0]=1,m[1]=0,m[2]=0,m[3]=0,m[4]=1,m[5]=0,m[6]=0,m[7]=0,m[8]=1,this},_proto.toString=function toString(){for(var t="[",i=0;i<9;i++)t+=this.data[i],t+=8!==i?", ":"";return t+="]"},_proto.transpose=function transpose(){var m=this.data,tmp;return tmp=m[1],m[1]=m[3],m[3]=tmp,tmp=m[2],m[2]=m[6],m[6]=tmp,tmp=m[5],m[5]=m[7],m[7]=tmp,this},_proto.setFromMat4=function setFromMat4(m){var src=m.data,dst=this.data;return dst[0]=src[0],dst[1]=src[1],dst[2]=src[2],dst[3]=src[4],dst[4]=src[5],dst[5]=src[6],dst[6]=src[8],dst[7]=src[9],dst[8]=src[10],this},_proto.transformVector=function transformVector(vec,res){void 0===res&&(res=new Vec3);var m=this.data,x=vec.x,y=vec.y,z=vec.z;return res.x=x*m[0]+y*m[3]+z*m[6],res.y=x*m[1]+y*m[4]+z*m[7],res.z=x*m[2]+y*m[5]+z*m[8],res},Mat3}();Mat3.IDENTITY=Object.freeze(new Mat3),Mat3.ZERO=Object.freeze((new Mat3).set([0,0,0,0,0,0,0,0,0]));var Vec2=function(){function Vec2(x,y){void 0===x&&(x=0),void 0===y&&(y=0),2===x.length?(this.x=x[0],this.y=x[1]):(this.x=x,this.y=y)}var _proto=Vec2.prototype;return _proto.add=function add(rhs){return this.x+=rhs.x,this.y+=rhs.y,this},_proto.add2=function add2(lhs,rhs){return this.x=lhs.x+rhs.x,this.y=lhs.y+rhs.y,this},_proto.addScalar=function addScalar(scalar){return this.x+=scalar,this.y+=scalar,this},_proto.clone=function clone(){return new Vec2(this.x,this.y)},_proto.copy=function copy(rhs){return this.x=rhs.x,this.y=rhs.y,this},_proto.cross=function cross(rhs){return this.x*rhs.y-this.y*rhs.x},_proto.distance=function distance(rhs){var x=this.x-rhs.x,y=this.y-rhs.y;return Math.sqrt(x*x+y*y)},_proto.div=function div(rhs){return this.x/=rhs.x,this.y/=rhs.y,this},_proto.div2=function div2(lhs,rhs){return this.x=lhs.x/rhs.x,this.y=lhs.y/rhs.y,this},_proto.divScalar=function divScalar(scalar){return this.x/=scalar,this.y/=scalar,this},_proto.dot=function dot(rhs){return this.x*rhs.x+this.y*rhs.y},_proto.equals=function equals(rhs){return this.x===rhs.x&&this.y===rhs.y},_proto.length=function length(){return Math.sqrt(this.x*this.x+this.y*this.y)},_proto.lengthSq=function lengthSq(){return this.x*this.x+this.y*this.y},_proto.lerp=function lerp(lhs,rhs,alpha){return this.x=lhs.x+alpha*(rhs.x-lhs.x),this.y=lhs.y+alpha*(rhs.y-lhs.y),this},_proto.mul=function mul(rhs){return this.x*=rhs.x,this.y*=rhs.y,this},_proto.mul2=function mul2(lhs,rhs){return this.x=lhs.x*rhs.x,this.y=lhs.y*rhs.y,this},_proto.mulScalar=function mulScalar(scalar){return this.x*=scalar,this.y*=scalar,this},_proto.normalize=function normalize(){var lengthSq=this.x*this.x+this.y*this.y;if(lengthSq>0){var invLength=1/Math.sqrt(lengthSq);this.x*=invLength,this.y*=invLength}return this},_proto.floor=function floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},_proto.ceil=function ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},_proto.round=function round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},_proto.min=function min(rhs){return rhs.x<this.x&&(this.x=rhs.x),rhs.y<this.y&&(this.y=rhs.y),this},_proto.max=function max(rhs){return rhs.x>this.x&&(this.x=rhs.x),rhs.y>this.y&&(this.y=rhs.y),this},_proto.set=function set(x,y){return this.x=x,this.y=y,this},_proto.sub=function sub(rhs){return this.x-=rhs.x,this.y-=rhs.y,this},_proto.sub2=function sub2(lhs,rhs){return this.x=lhs.x-rhs.x,this.y=lhs.y-rhs.y,this},_proto.subScalar=function subScalar(scalar){return this.x-=scalar,this.y-=scalar,this},_proto.toString=function toString(){return"["+this.x+", "+this.y+"]"},Vec2.angleRad=function angleRad(lhs,rhs){return Math.atan2(lhs.x*rhs.y-lhs.y*rhs.x,lhs.x*rhs.x+lhs.y*rhs.y)},Vec2}();Vec2.ZERO=Object.freeze(new Vec2(0,0)),Vec2.ONE=Object.freeze(new Vec2(1,1)),Vec2.UP=Object.freeze(new Vec2(0,1)),Vec2.DOWN=Object.freeze(new Vec2(0,-1)),Vec2.RIGHT=Object.freeze(new Vec2(1,0)),Vec2.LEFT=Object.freeze(new Vec2(-1,0));var Vec4=function(){function Vec4(x,y,z,w){void 0===x&&(x=0),void 0===y&&(y=0),void 0===z&&(z=0),void 0===w&&(w=0),4===x.length?(this.x=x[0],this.y=x[1],this.z=x[2],this.w=x[3]):(this.x=x,this.y=y,this.z=z,this.w=w)}var _proto=Vec4.prototype;return _proto.add=function add(rhs){return this.x+=rhs.x,this.y+=rhs.y,this.z+=rhs.z,this.w+=rhs.w,this},_proto.add2=function add2(lhs,rhs){return this.x=lhs.x+rhs.x,this.y=lhs.y+rhs.y,this.z=lhs.z+rhs.z,this.w=lhs.w+rhs.w,this},_proto.addScalar=function addScalar(scalar){return this.x+=scalar,this.y+=scalar,this.z+=scalar,this.w+=scalar,this},_proto.clone=function clone(){return new Vec4(this.x,this.y,this.z,this.w)},_proto.copy=function copy(rhs){return this.x=rhs.x,this.y=rhs.y,this.z=rhs.z,this.w=rhs.w,this},_proto.div=function div(rhs){return this.x/=rhs.x,this.y/=rhs.y,this.z/=rhs.z,this.w/=rhs.w,this},_proto.div2=function div2(lhs,rhs){return this.x=lhs.x/rhs.x,this.y=lhs.y/rhs.y,this.z=lhs.z/rhs.z,this.w=lhs.w/rhs.w,this},_proto.divScalar=function divScalar(scalar){return this.x/=scalar,this.y/=scalar,this.z/=scalar,this.w/=scalar,this},_proto.dot=function dot(rhs){return this.x*rhs.x+this.y*rhs.y+this.z*rhs.z+this.w*rhs.w},_proto.equals=function equals(rhs){return this.x===rhs.x&&this.y===rhs.y&&this.z===rhs.z&&this.w===rhs.w},_proto.length=function length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},_proto.lengthSq=function lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},_proto.lerp=function lerp(lhs,rhs,alpha){return this.x=lhs.x+alpha*(rhs.x-lhs.x),this.y=lhs.y+alpha*(rhs.y-lhs.y),this.z=lhs.z+alpha*(rhs.z-lhs.z),this.w=lhs.w+alpha*(rhs.w-lhs.w),this},_proto.mul=function mul(rhs){return this.x*=rhs.x,this.y*=rhs.y,this.z*=rhs.z,this.w*=rhs.w,this},_proto.mul2=function mul2(lhs,rhs){return this.x=lhs.x*rhs.x,this.y=lhs.y*rhs.y,this.z=lhs.z*rhs.z,this.w=lhs.w*rhs.w,this},_proto.mulScalar=function mulScalar(scalar){return this.x*=scalar,this.y*=scalar,this.z*=scalar,this.w*=scalar,this},_proto.normalize=function normalize(){var lengthSq=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;if(lengthSq>0){var invLength=1/Math.sqrt(lengthSq);this.x*=invLength,this.y*=invLength,this.z*=invLength,this.w*=invLength}return this},_proto.floor=function floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this},_proto.ceil=function ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this},_proto.round=function round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this},_proto.min=function min(rhs){return rhs.x<this.x&&(this.x=rhs.x),rhs.y<this.y&&(this.y=rhs.y),rhs.z<this.z&&(this.z=rhs.z),rhs.w<this.w&&(this.w=rhs.w),this},_proto.max=function max(rhs){return rhs.x>this.x&&(this.x=rhs.x),rhs.y>this.y&&(this.y=rhs.y),rhs.z>this.z&&(this.z=rhs.z),rhs.w>this.w&&(this.w=rhs.w),this},_proto.set=function set(x,y,z,w){return this.x=x,this.y=y,this.z=z,this.w=w,this},_proto.sub=function sub(rhs){return this.x-=rhs.x,this.y-=rhs.y,this.z-=rhs.z,this.w-=rhs.w,this},_proto.sub2=function sub2(lhs,rhs){return this.x=lhs.x-rhs.x,this.y=lhs.y-rhs.y,this.z=lhs.z-rhs.z,this.w=lhs.w-rhs.w,this},_proto.subScalar=function subScalar(scalar){return this.x-=scalar,this.y-=scalar,this.z-=scalar,this.w-=scalar,this},_proto.toString=function toString(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"},Vec4}();Vec4.ZERO=Object.freeze(new Vec4(0,0,0,0)),Vec4.ONE=Object.freeze(new Vec4(1,1,1,1));var _halfSize$1=new Vec2,x=new Vec3,y=new Vec3,z=new Vec3,scale=new Vec3,Mat4=function(){function Mat4(){var data=new Float32Array(16);data[0]=data[5]=data[10]=data[15]=1,this.data=data}Mat4._getPerspectiveHalfSize=function _getPerspectiveHalfSize(halfSize,fov,aspect,znear,fovIsHorizontal){fovIsHorizontal?(halfSize.x=znear*Math.tan(fov*Math.PI/360),halfSize.y=halfSize.x/aspect):(halfSize.y=znear*Math.tan(fov*Math.PI/360),halfSize.x=halfSize.y*aspect)};var _proto=Mat4.prototype;return _proto.add2=function add2(lhs,rhs){var a=lhs.data,b=rhs.data,r=this.data;return r[0]=a[0]+b[0],r[1]=a[1]+b[1],r[2]=a[2]+b[2],r[3]=a[3]+b[3],r[4]=a[4]+b[4],r[5]=a[5]+b[5],r[6]=a[6]+b[6],r[7]=a[7]+b[7],r[8]=a[8]+b[8],r[9]=a[9]+b[9],r[10]=a[10]+b[10],r[11]=a[11]+b[11],r[12]=a[12]+b[12],r[13]=a[13]+b[13],r[14]=a[14]+b[14],r[15]=a[15]+b[15],this},_proto.add=function add(rhs){return this.add2(this,rhs)},_proto.clone=function clone(){return(new Mat4).copy(this)},_proto.copy=function copy(rhs){var src=rhs.data,dst=this.data;return dst[0]=src[0],dst[1]=src[1],dst[2]=src[2],dst[3]=src[3],dst[4]=src[4],dst[5]=src[5],dst[6]=src[6],dst[7]=src[7],dst[8]=src[8],dst[9]=src[9],dst[10]=src[10],dst[11]=src[11],dst[12]=src[12],dst[13]=src[13],dst[14]=src[14],dst[15]=src[15],this},_proto.equals=function equals(rhs){var l=this.data,r=rhs.data;return l[0]===r[0]&&l[1]===r[1]&&l[2]===r[2]&&l[3]===r[3]&&l[4]===r[4]&&l[5]===r[5]&&l[6]===r[6]&&l[7]===r[7]&&l[8]===r[8]&&l[9]===r[9]&&l[10]===r[10]&&l[11]===r[11]&&l[12]===r[12]&&l[13]===r[13]&&l[14]===r[14]&&l[15]===r[15]},_proto.isIdentity=function isIdentity(){var m=this.data;return 1===m[0]&&0===m[1]&&0===m[2]&&0===m[3]&&0===m[4]&&1===m[5]&&0===m[6]&&0===m[7]&&0===m[8]&&0===m[9]&&1===m[10]&&0===m[11]&&0===m[12]&&0===m[13]&&0===m[14]&&1===m[15]},_proto.mul2=function mul2(lhs,rhs){var a=lhs.data,b=rhs.data,r=this.data,a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b0,b1,b2,b3;return b0=b[0],b1=b[1],b2=b[2],b3=b[3],r[0]=a00*b0+a10*b1+a20*b2+a30*b3,r[1]=a01*b0+a11*b1+a21*b2+a31*b3,r[2]=a02*b0+a12*b1+a22*b2+a32*b3,r[3]=a03*b0+a13*b1+a23*b2+a33*b3,b0=b[4],b1=b[5],b2=b[6],b3=b[7],r[4]=a00*b0+a10*b1+a20*b2+a30*b3,r[5]=a01*b0+a11*b1+a21*b2+a31*b3,r[6]=a02*b0+a12*b1+a22*b2+a32*b3,r[7]=a03*b0+a13*b1+a23*b2+a33*b3,b0=b[8],b1=b[9],b2=b[10],b3=b[11],r[8]=a00*b0+a10*b1+a20*b2+a30*b3,r[9]=a01*b0+a11*b1+a21*b2+a31*b3,r[10]=a02*b0+a12*b1+a22*b2+a32*b3,r[11]=a03*b0+a13*b1+a23*b2+a33*b3,b0=b[12],b1=b[13],b2=b[14],b3=b[15],r[12]=a00*b0+a10*b1+a20*b2+a30*b3,r[13]=a01*b0+a11*b1+a21*b2+a31*b3,r[14]=a02*b0+a12*b1+a22*b2+a32*b3,r[15]=a03*b0+a13*b1+a23*b2+a33*b3,this},_proto.mulAffine2=function mulAffine2(lhs,rhs){var a=lhs.data,b=rhs.data,r=this.data,a00=a[0],a01=a[1],a02=a[2],a10=a[4],a11=a[5],a12=a[6],a20=a[8],a21=a[9],a22=a[10],a30=a[12],a31=a[13],a32=a[14],b0,b1,b2;return b0=b[0],b1=b[1],b2=b[2],r[0]=a00*b0+a10*b1+a20*b2,r[1]=a01*b0+a11*b1+a21*b2,r[2]=a02*b0+a12*b1+a22*b2,r[3]=0,b0=b[4],b1=b[5],b2=b[6],r[4]=a00*b0+a10*b1+a20*b2,r[5]=a01*b0+a11*b1+a21*b2,r[6]=a02*b0+a12*b1+a22*b2,r[7]=0,b0=b[8],b1=b[9],b2=b[10],r[8]=a00*b0+a10*b1+a20*b2,r[9]=a01*b0+a11*b1+a21*b2,r[10]=a02*b0+a12*b1+a22*b2,r[11]=0,b0=b[12],b1=b[13],b2=b[14],r[12]=a00*b0+a10*b1+a20*b2+a30,r[13]=a01*b0+a11*b1+a21*b2+a31,r[14]=a02*b0+a12*b1+a22*b2+a32,r[15]=1,this},_proto.mul=function mul(rhs){return this.mul2(this,rhs)},_proto.transformPoint=function transformPoint(vec,res){void 0===res&&(res=new Vec3);var m=this.data,x=vec.x,y=vec.y,z=vec.z;return res.x=x*m[0]+y*m[4]+z*m[8]+m[12],res.y=x*m[1]+y*m[5]+z*m[9]+m[13],res.z=x*m[2]+y*m[6]+z*m[10]+m[14],res},_proto.transformVector=function transformVector(vec,res){void 0===res&&(res=new Vec3);var m=this.data,x=vec.x,y=vec.y,z=vec.z;return res.x=x*m[0]+y*m[4]+z*m[8],res.y=x*m[1]+y*m[5]+z*m[9],res.z=x*m[2]+y*m[6]+z*m[10],res},_proto.transformVec4=function transformVec4(vec,res){void 0===res&&(res=new Vec4);var m=this.data,x=vec.x,y=vec.y,z=vec.z,w=vec.w;return res.x=x*m[0]+y*m[4]+z*m[8]+w*m[12],res.y=x*m[1]+y*m[5]+z*m[9]+w*m[13],res.z=x*m[2]+y*m[6]+z*m[10]+w*m[14],res.w=x*m[3]+y*m[7]+z*m[11]+w*m[15],res},_proto.setLookAt=function setLookAt(position,target,up){z.sub2(position,target).normalize(),y.copy(up).normalize(),x.cross(y,z).normalize(),y.cross(z,x);var r=this.data;return r[0]=x.x,r[1]=x.y,r[2]=x.z,r[3]=0,r[4]=y.x,r[5]=y.y,r[6]=y.z,r[7]=0,r[8]=z.x,r[9]=z.y,r[10]=z.z,r[11]=0,r[12]=position.x,r[13]=position.y,r[14]=position.z,r[15]=1,this},_proto.setFrustum=function setFrustum(left,right,bottom,top,znear,zfar){var temp1=2*znear,temp2=right-left,temp3=top-bottom,temp4=zfar-znear,r=this.data;return r[0]=temp1/temp2,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=temp1/temp3,r[6]=0,r[7]=0,r[8]=(right+left)/temp2,r[9]=(top+bottom)/temp3,r[10]=(-zfar-znear)/temp4,r[11]=-1,r[12]=0,r[13]=0,r[14]=-temp1*zfar/temp4,r[15]=0,this},_proto.setPerspective=function setPerspective(fov,aspect,znear,zfar,fovIsHorizontal){return Mat4._getPerspectiveHalfSize(_halfSize$1,fov,aspect,znear,fovIsHorizontal),this.setFrustum(-_halfSize$1.x,_halfSize$1.x,-_halfSize$1.y,_halfSize$1.y,znear,zfar)},_proto.setOrtho=function setOrtho(left,right,bottom,top,near,far){var r=this.data;return r[0]=2/(right-left),r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=2/(top-bottom),r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=-2/(far-near),r[11]=0,r[12]=-(right+left)/(right-left),r[13]=-(top+bottom)/(top-bottom),r[14]=-(far+near)/(far-near),r[15]=1,this},_proto.setFromAxisAngle=function setFromAxisAngle(axis,angle){angle*=math.DEG_TO_RAD;var x=axis.x,y=axis.y,z=axis.z,c=Math.cos(angle),s=Math.sin(angle),t=1-c,tx=t*x,ty=t*y,m=this.data;return m[0]=tx*x+c,m[1]=tx*y+s*z,m[2]=tx*z-s*y,m[3]=0,m[4]=tx*y-s*z,m[5]=ty*y+c,m[6]=ty*z+s*x,m[7]=0,m[8]=tx*z+s*y,m[9]=ty*z-x*s,m[10]=t*z*z+c,m[11]=0,m[12]=0,m[13]=0,m[14]=0,m[15]=1,this},_proto.setTranslate=function setTranslate(x,y,z){var m=this.data;return m[0]=1,m[1]=0,m[2]=0,m[3]=0,m[4]=0,m[5]=1,m[6]=0,m[7]=0,m[8]=0,m[9]=0,m[10]=1,m[11]=0,m[12]=x,m[13]=y,m[14]=z,m[15]=1,this},_proto.setScale=function setScale(x,y,z){var m=this.data;return m[0]=x,m[1]=0,m[2]=0,m[3]=0,m[4]=0,m[5]=y,m[6]=0,m[7]=0,m[8]=0,m[9]=0,m[10]=z,m[11]=0,m[12]=0,m[13]=0,m[14]=0,m[15]=1,this},_proto.setViewport=function setViewport(x,y,width,height){var m=this.data;return m[0]=.5*width,m[1]=0,m[2]=0,m[3]=0,m[4]=0,m[5]=.5*height,m[6]=0,m[7]=0,m[8]=0,m[9]=0,m[10]=.5,m[11]=0,m[12]=x+.5*width,m[13]=y+.5*height,m[14]=.5,m[15]=1,this},_proto.invert=function invert(){var m=this.data,a00=m[0],a01=m[1],a02=m[2],a03=m[3],a10=m[4],a11=m[5],a12=m[6],a13=m[7],a20=m[8],a21=m[9],a22=m[10],a23=m[11],a30=m[12],a31=m[13],a32=m[14],a33=m[15],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32,det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;if(0===det)this.setIdentity();else{var invDet=1/det;m[0]=(a11*b11-a12*b10+a13*b09)*invDet,m[1]=(-a01*b11+a02*b10-a03*b09)*invDet,m[2]=(a31*b05-a32*b04+a33*b03)*invDet,m[3]=(-a21*b05+a22*b04-a23*b03)*invDet,m[4]=(-a10*b11+a12*b08-a13*b07)*invDet,m[5]=(a00*b11-a02*b08+a03*b07)*invDet,m[6]=(-a30*b05+a32*b02-a33*b01)*invDet,m[7]=(a20*b05-a22*b02+a23*b01)*invDet,m[8]=(a10*b10-a11*b08+a13*b06)*invDet,m[9]=(-a00*b10+a01*b08-a03*b06)*invDet,m[10]=(a30*b04-a31*b02+a33*b00)*invDet,m[11]=(-a20*b04+a21*b02-a23*b00)*invDet,m[12]=(-a10*b09+a11*b07-a12*b06)*invDet,m[13]=(a00*b09-a01*b07+a02*b06)*invDet,m[14]=(-a30*b03+a31*b01-a32*b00)*invDet,m[15]=(a20*b03-a21*b01+a22*b00)*invDet}return this},_proto.set=function set(src){var dst=this.data;return dst[0]=src[0],dst[1]=src[1],dst[2]=src[2],dst[3]=src[3],dst[4]=src[4],dst[5]=src[5],dst[6]=src[6],dst[7]=src[7],dst[8]=src[8],dst[9]=src[9],dst[10]=src[10],dst[11]=src[11],dst[12]=src[12],dst[13]=src[13],dst[14]=src[14],dst[15]=src[15],this},_proto.setIdentity=function setIdentity(){var m=this.data;return m[0]=1,m[1]=0,m[2]=0,m[3]=0,m[4]=0,m[5]=1,m[6]=0,m[7]=0,m[8]=0,m[9]=0,m[10]=1,m[11]=0,m[12]=0,m[13]=0,m[14]=0,m[15]=1,this},_proto.setTRS=function setTRS(t,r,s){var qx=r.x,qy=r.y,qz=r.z,qw=r.w,sx=s.x,sy=s.y,sz=s.z,x2=qx+qx,y2=qy+qy,z2=qz+qz,xx=qx*x2,xy=qx*y2,xz=qx*z2,yy=qy*y2,yz=qy*z2,zz=qz*z2,wx=qw*x2,wy=qw*y2,wz=qw*z2,m=this.data;return m[0]=(1-(yy+zz))*sx,m[1]=(xy+wz)*sx,m[2]=(xz-wy)*sx,m[3]=0,m[4]=(xy-wz)*sy,m[5]=(1-(xx+zz))*sy,m[6]=(yz+wx)*sy,m[7]=0,m[8]=(xz+wy)*sz,m[9]=(yz-wx)*sz,m[10]=(1-(xx+yy))*sz,m[11]=0,m[12]=t.x,m[13]=t.y,m[14]=t.z,m[15]=1,this},_proto.transpose=function transpose(){var tmp,m=this.data;return tmp=m[1],m[1]=m[4],m[4]=tmp,tmp=m[2],m[2]=m[8],m[8]=tmp,tmp=m[3],m[3]=m[12],m[12]=tmp,tmp=m[6],m[6]=m[9],m[9]=tmp,tmp=m[7],m[7]=m[13],m[13]=tmp,tmp=m[11],m[11]=m[14],m[14]=tmp,this},_proto.invertTo3x3=function invertTo3x3(res){var m=this.data,r=res.data,m0=m[0],m1=m[1],m2=m[2],m4=m[4],m5=m[5],m6=m[6],m8=m[8],m9=m[9],m10=m[10],a11=m10*m5-m6*m9,a21=-m10*m1+m2*m9,a31=m6*m1-m2*m5,a12=-m10*m4+m6*m8,a22=m10*m0-m2*m8,a32=-m6*m0+m2*m4,a13=m9*m4-m5*m8,a23=-m9*m0+m1*m8,a33=m5*m0-m1*m4,det=m0*a11+m1*a12+m2*a13;if(0===det)return this;var idet=1/det;return r[0]=idet*a11,r[1]=idet*a21,r[2]=idet*a31,r[3]=idet*a12,r[4]=idet*a22,r[5]=idet*a32,r[6]=idet*a13,r[7]=idet*a23,r[8]=idet*a33,this},_proto.getTranslation=function getTranslation(t){return void 0===t&&(t=new Vec3),t.set(this.data[12],this.data[13],this.data[14])},_proto.getX=function getX(x){return void 0===x&&(x=new Vec3),x.set(this.data[0],this.data[1],this.data[2])},_proto.getY=function getY(y){return void 0===y&&(y=new Vec3),y.set(this.data[4],this.data[5],this.data[6])},_proto.getZ=function getZ(z){return void 0===z&&(z=new Vec3),z.set(this.data[8],this.data[9],this.data[10])},_proto.getScale=function getScale(scale){return void 0===scale&&(scale=new Vec3),this.getX(x),this.getY(y),this.getZ(z),scale.set(x.length(),y.length(),z.length()),scale},_proto.setFromEulerAngles=function setFromEulerAngles(ex,ey,ez){ex*=math.DEG_TO_RAD,ey*=math.DEG_TO_RAD,ez*=math.DEG_TO_RAD;var s1=Math.sin(-ex),c1=Math.cos(-ex),s2=Math.sin(-ey),c2=Math.cos(-ey),s3=Math.sin(-ez),c3=Math.cos(-ez),m=this.data;return m[0]=c2*c3,m[1]=-c2*s3,m[2]=s2,m[3]=0,m[4]=c1*s3+c3*s1*s2,m[5]=c1*c3-s1*s2*s3,m[6]=-c2*s1,m[7]=0,m[8]=s1*s3-c1*c3*s2,m[9]=c3*s1+c1*s2*s3,m[10]=c1*c2,m[11]=0,m[12]=0,m[13]=0,m[14]=0,m[15]=1,this},_proto.getEulerAngles=function getEulerAngles(eulers){void 0===eulers&&(eulers=new Vec3),this.getScale(scale);var sx=scale.x,sy=scale.y,sz=scale.z;if(0===sx||0===sy||0===sz)return eulers.set(0,0,0);var m=this.data,y=Math.asin(-m[2]/sx),halfPi=.5*Math.PI,x,z;return y<halfPi?y>-halfPi?(x=Math.atan2(m[6]/sy,m[10]/sz),z=Math.atan2(m[1]/sx,m[0]/sx)):(z=0,x=-Math.atan2(m[4]/sy,m[5]/sy)):(z=0,x=Math.atan2(m[4]/sy,m[5]/sy)),eulers.set(x,y,z).mulScalar(math.RAD_TO_DEG)},_proto.toString=function toString(){for(var t="[",i=0;i<16;i+=1)t+=this.data[i],t+=15!==i?", ":"";return t+="]"},Mat4}();Mat4.IDENTITY=Object.freeze(new Mat4),Mat4.ZERO=Object.freeze((new Mat4).set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]));var Quat=function(){function Quat(x,y,z,w){void 0===x&&(x=0),void 0===y&&(y=0),void 0===z&&(z=0),void 0===w&&(w=1),4===x.length?(this.x=x[0],this.y=x[1],this.z=x[2],this.w=x[3]):(this.x=x,this.y=y,this.z=z,this.w=w)}var _proto=Quat.prototype;return _proto.clone=function clone(){return new Quat(this.x,this.y,this.z,this.w)},_proto.conjugate=function conjugate(){return this.x*=-1,this.y*=-1,this.z*=-1,this},_proto.copy=function copy(rhs){return this.x=rhs.x,this.y=rhs.y,this.z=rhs.z,this.w=rhs.w,this},_proto.equals=function equals(rhs){return this.x===rhs.x&&this.y===rhs.y&&this.z===rhs.z&&this.w===rhs.w},_proto.getAxisAngle=function getAxisAngle(axis){var rad=2*Math.acos(this.w),s=Math.sin(rad/2);return 0!==s?(axis.x=this.x/s,axis.y=this.y/s,axis.z=this.z/s,(axis.x<0||axis.y<0||axis.z<0)&&(axis.x*=-1,axis.y*=-1,axis.z*=-1,rad*=-1)):(axis.x=1,axis.y=0,axis.z=0),rad*math.RAD_TO_DEG},_proto.getEulerAngles=function getEulerAngles(eulers){var x,y,z;void 0===eulers&&(eulers=new Vec3);var qx=this.x,qy=this.y,qz=this.z,qw=this.w,a2=2*(qw*qy-qx*qz);return a2<=-.99999?(x=2*Math.atan2(qx,qw),y=-Math.PI/2,z=0):a2>=.99999?(x=2*Math.atan2(qx,qw),y=Math.PI/2,z=0):(x=Math.atan2(2*(qw*qx+qy*qz),1-2*(qx*qx+qy*qy)),y=Math.asin(a2),z=Math.atan2(2*(qw*qz+qx*qy),1-2*(qy*qy+qz*qz))),eulers.set(x,y,z).mulScalar(math.RAD_TO_DEG)},_proto.invert=function invert(){return this.conjugate().normalize()},_proto.length=function length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},_proto.lengthSq=function lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},_proto.mul=function mul(rhs){var q1x=this.x,q1y=this.y,q1z=this.z,q1w=this.w,q2x=rhs.x,q2y=rhs.y,q2z=rhs.z,q2w=rhs.w;return this.x=q1w*q2x+q1x*q2w+q1y*q2z-q1z*q2y,this.y=q1w*q2y+q1y*q2w+q1z*q2x-q1x*q2z,this.z=q1w*q2z+q1z*q2w+q1x*q2y-q1y*q2x,this.w=q1w*q2w-q1x*q2x-q1y*q2y-q1z*q2z,this},_proto.mul2=function mul2(lhs,rhs){var q1x=lhs.x,q1y=lhs.y,q1z=lhs.z,q1w=lhs.w,q2x=rhs.x,q2y=rhs.y,q2z=rhs.z,q2w=rhs.w;return this.x=q1w*q2x+q1x*q2w+q1y*q2z-q1z*q2y,this.y=q1w*q2y+q1y*q2w+q1z*q2x-q1x*q2z,this.z=q1w*q2z+q1z*q2w+q1x*q2y-q1y*q2x,this.w=q1w*q2w-q1x*q2x-q1y*q2y-q1z*q2z,this},_proto.normalize=function normalize(){var len=this.length();return 0===len?(this.x=this.y=this.z=0,this.w=1):(len=1/len,this.x*=len,this.y*=len,this.z*=len,this.w*=len),this},_proto.set=function set(x,y,z,w){return this.x=x,this.y=y,this.z=z,this.w=w,this},_proto.setFromAxisAngle=function setFromAxisAngle(axis,angle){angle*=.5*math.DEG_TO_RAD;var sa=Math.sin(angle),ca=Math.cos(angle);return this.x=sa*axis.x,this.y=sa*axis.y,this.z=sa*axis.z,this.w=ca,this},_proto.setFromEulerAngles=function setFromEulerAngles(ex,ey,ez){var halfToRad=.5*math.DEG_TO_RAD;ex*=halfToRad,ey*=halfToRad,ez*=halfToRad;var sx=Math.sin(ex),cx=Math.cos(ex),sy=Math.sin(ey),cy=Math.cos(ey),sz=Math.sin(ez),cz=Math.cos(ez);return this.x=sx*cy*cz-cx*sy*sz,this.y=cx*sy*cz+sx*cy*sz,this.z=cx*cy*sz-sx*sy*cz,this.w=cx*cy*cz+sx*sy*sz,this},_proto.setFromMat4=function setFromMat4(m){var m00,m01,m02,m10,m11,m12,m20,m21,m22,s,rs,lx,ly,lz;if(m00=(m=m.data)[0],m01=m[1],m02=m[2],m10=m[4],m11=m[5],m12=m[6],m20=m[8],m21=m[9],m22=m[10],0===(lx=m00*m00+m01*m01+m02*m02))return this;if(lx=1/Math.sqrt(lx),0===(ly=m10*m10+m11*m11+m12*m12))return this;if(ly=1/Math.sqrt(ly),0===(lz=m20*m20+m21*m21+m22*m22))return this;m01*=lx,m02*=lx,m10*=ly,m12*=ly,m20*=lz=1/Math.sqrt(lz),m21*=lz;var tr=(m00*=lx)+(m11*=ly)+(m22*=lz);return tr>=0?(s=Math.sqrt(tr+1),this.w=.5*s,s=.5/s,this.x=(m12-m21)*s,this.y=(m20-m02)*s,this.z=(m01-m10)*s):m00>m11?m00>m22?(rs=m00-(m11+m22)+1,rs=Math.sqrt(rs),this.x=.5*rs,rs=.5/rs,this.w=(m12-m21)*rs,this.y=(m01+m10)*rs,this.z=(m02+m20)*rs):(rs=m22-(m00+m11)+1,rs=Math.sqrt(rs),this.z=.5*rs,rs=.5/rs,this.w=(m01-m10)*rs,this.x=(m20+m02)*rs,this.y=(m21+m12)*rs):m11>m22?(rs=m11-(m22+m00)+1,rs=Math.sqrt(rs),this.y=.5*rs,rs=.5/rs,this.w=(m20-m02)*rs,this.z=(m12+m21)*rs,this.x=(m10+m01)*rs):(rs=m22-(m00+m11)+1,rs=Math.sqrt(rs),this.z=.5*rs,rs=.5/rs,this.w=(m01-m10)*rs,this.x=(m20+m02)*rs,this.y=(m21+m12)*rs),this},_proto.slerp=function slerp(lhs,rhs,alpha){var lx=lhs.x,ly=lhs.y,lz=lhs.z,lw=lhs.w,rx=rhs.x,ry=rhs.y,rz=rhs.z,rw=rhs.w,cosHalfTheta=lw*rw+lx*rx+ly*ry+lz*rz;if(cosHalfTheta<0&&(rw=-rw,rx=-rx,ry=-ry,rz=-rz,cosHalfTheta=-cosHalfTheta),Math.abs(cosHalfTheta)>=1)return this.w=lw,this.x=lx,this.y=ly,this.z=lz,this;var halfTheta=Math.acos(cosHalfTheta),sinHalfTheta=Math.sqrt(1-cosHalfTheta*cosHalfTheta);if(Math.abs(sinHalfTheta)<.001)return this.w=.5*lw+.5*rw,this.x=.5*lx+.5*rx,this.y=.5*ly+.5*ry,this.z=.5*lz+.5*rz,this;var ratioA=Math.sin((1-alpha)*halfTheta)/sinHalfTheta,ratioB=Math.sin(alpha*halfTheta)/sinHalfTheta;return this.w=lw*ratioA+rw*ratioB,this.x=lx*ratioA+rx*ratioB,this.y=ly*ratioA+ry*ratioB,this.z=lz*ratioA+rz*ratioB,this},_proto.transformVector=function transformVector(vec,res){void 0===res&&(res=new Vec3);var x=vec.x,y=vec.y,z=vec.z,qx=this.x,qy=this.y,qz=this.z,qw=this.w,ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;return res.x=ix*qw+iw*-qx+iy*-qz-iz*-qy,res.y=iy*qw+iw*-qy+iz*-qx-ix*-qz,res.z=iz*qw+iw*-qz+ix*-qy-iy*-qx,res},_proto.toString=function toString(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"},Quat}();Quat.IDENTITY=Object.freeze(new Quat(0,0,0,1)),Quat.ZERO=Object.freeze(new Quat(0,0,0,0));var tmpVecA$2=new Vec3,tmpVecB$1=new Vec3,tmpVecC=new Vec3,tmpVecD=new Vec3,tmpVecE=new Vec3,BoundingBox=function(){function BoundingBox(center,halfExtents){void 0===center&&(center=new Vec3),void 0===halfExtents&&(halfExtents=new Vec3(.5,.5,.5)),this.center=center,this.halfExtents=halfExtents,this._min=new Vec3,this._max=new Vec3}var _proto=BoundingBox.prototype;return _proto.add=function add(other){var tc=this.center,tcx=tc.x,tcy=tc.y,tcz=tc.z,th=this.halfExtents,thx=th.x,thy=th.y,thz=th.z,tminx=tcx-thx,tmaxx=tcx+thx,tminy=tcy-thy,tmaxy=tcy+thy,tminz=tcz-thz,tmaxz=tcz+thz,oc=other.center,ocx=oc.x,ocy=oc.y,ocz=oc.z,oh=other.halfExtents,ohx=oh.x,ohy=oh.y,ohz=oh.z,ominx=ocx-ohx,omaxx=ocx+ohx,ominy=ocy-ohy,omaxy=ocy+ohy,ominz=ocz-ohz,omaxz=ocz+ohz;ominx<tminx&&(tminx=ominx),omaxx>tmaxx&&(tmaxx=omaxx),ominy<tminy&&(tminy=ominy),omaxy>tmaxy&&(tmaxy=omaxy),ominz<tminz&&(tminz=ominz),omaxz>tmaxz&&(tmaxz=omaxz),tc.x=.5*(tminx+tmaxx),tc.y=.5*(tminy+tmaxy),tc.z=.5*(tminz+tmaxz),th.x=.5*(tmaxx-tminx),th.y=.5*(tmaxy-tminy),th.z=.5*(tmaxz-tminz)},_proto.copy=function copy(src){this.center.copy(src.center),this.halfExtents.copy(src.halfExtents)},_proto.clone=function clone(){return new BoundingBox(this.center.clone(),this.halfExtents.clone())},_proto.intersects=function intersects(other){var aMax=this.getMax(),aMin=this.getMin(),bMax=other.getMax(),bMin=other.getMin();return aMin.x<=bMax.x&&aMax.x>=bMin.x&&aMin.y<=bMax.y&&aMax.y>=bMin.y&&aMin.z<=bMax.z&&aMax.z>=bMin.z},_proto._intersectsRay=function _intersectsRay(ray,point){var tMin=tmpVecA$2.copy(this.getMin()).sub(ray.origin),tMax=tmpVecB$1.copy(this.getMax()).sub(ray.origin),dir=ray.direction;0===dir.x?(tMin.x=tMin.x<0?-Number.MAX_VALUE:Number.MAX_VALUE,tMax.x=tMax.x<0?-Number.MAX_VALUE:Number.MAX_VALUE):(tMin.x/=dir.x,tMax.x/=dir.x),0===dir.y?(tMin.y=tMin.y<0?-Number.MAX_VALUE:Number.MAX_VALUE,tMax.y=tMax.y<0?-Number.MAX_VALUE:Number.MAX_VALUE):(tMin.y/=dir.y,tMax.y/=dir.y),0===dir.z?(tMin.z=tMin.z<0?-Number.MAX_VALUE:Number.MAX_VALUE,tMax.z=tMax.z<0?-Number.MAX_VALUE:Number.MAX_VALUE):(tMin.z/=dir.z,tMax.z/=dir.z);var realMin=tmpVecC.set(Math.min(tMin.x,tMax.x),Math.min(tMin.y,tMax.y),Math.min(tMin.z,tMax.z)),realMax=tmpVecD.set(Math.max(tMin.x,tMax.x),Math.max(tMin.y,tMax.y),Math.max(tMin.z,tMax.z)),minMax=Math.min(Math.min(realMax.x,realMax.y),realMax.z),maxMin=Math.max(Math.max(realMin.x,realMin.y),realMin.z),intersects=minMax>=maxMin&&maxMin>=0;return intersects&&point.copy(ray.direction).mulScalar(maxMin).add(ray.origin),intersects},_proto._fastIntersectsRay=function _fastIntersectsRay(ray){var diff=tmpVecA$2,cross=tmpVecB$1,prod=tmpVecC,absDiff=tmpVecD,absDir=tmpVecE,rayDir=ray.direction;return diff.sub2(ray.origin,this.center),absDiff.set(Math.abs(diff.x),Math.abs(diff.y),Math.abs(diff.z)),prod.mul2(diff,rayDir),!(absDiff.x>this.halfExtents.x&&prod.x>=0)&&(!(absDiff.y>this.halfExtents.y&&prod.y>=0)&&(!(absDiff.z>this.halfExtents.z&&prod.z>=0)&&(absDir.set(Math.abs(rayDir.x),Math.abs(rayDir.y),Math.abs(rayDir.z)),cross.cross(rayDir,diff),cross.set(Math.abs(cross.x),Math.abs(cross.y),Math.abs(cross.z)),!(cross.x>this.halfExtents.y*absDir.z+this.halfExtents.z*absDir.y)&&(!(cross.y>this.halfExtents.x*absDir.z+this.halfExtents.z*absDir.x)&&!(cross.z>this.halfExtents.x*absDir.y+this.halfExtents.y*absDir.x)))))},_proto.intersectsRay=function intersectsRay(ray,point){return point?this._intersectsRay(ray,point):this._fastIntersectsRay(ray)},_proto.setMinMax=function setMinMax(min,max){this.center.add2(max,min).mulScalar(.5),this.halfExtents.sub2(max,min).mulScalar(.5)},_proto.getMin=function getMin(){return this._min.copy(this.center).sub(this.halfExtents)},_proto.getMax=function getMax(){return this._max.copy(this.center).add(this.halfExtents)},_proto.containsPoint=function containsPoint(point){var min=this.getMin(),max=this.getMax();return!(point.x<min.x||point.x>max.x||point.y<min.y||point.y>max.y||point.z<min.z||point.z>max.z)},_proto.setFromTransformedAabb=function setFromTransformedAabb(aabb,m){var ac=aabb.center,ar=aabb.halfExtents,d=m.data,mx0=d[0],mx1=d[4],mx2=d[8],my0=d[1],my1=d[5],my2=d[9],mz0=d[2],mz1=d[6],mz2=d[10];this.center.set(d[12]+mx0*ac.x+mx1*ac.y+mx2*ac.z,d[13]+my0*ac.x+my1*ac.y+my2*ac.z,d[14]+mz0*ac.x+mz1*ac.y+mz2*ac.z),this.halfExtents.set(Math.abs(mx0)*ar.x+Math.abs(mx1)*ar.y+Math.abs(mx2)*ar.z,Math.abs(my0)*ar.x+Math.abs(my1)*ar.y+Math.abs(my2)*ar.z,Math.abs(mz0)*ar.x+Math.abs(mz1)*ar.y+Math.abs(mz2)*ar.z)},_proto.compute=function compute(vertices,numVerts){if((numVerts=void 0===numVerts?vertices.length/3:numVerts)>0){for(var min=tmpVecA$2.set(vertices[0],vertices[1],vertices[2]),max=tmpVecB$1.set(vertices[0],vertices[1],vertices[2]),i=1;i<numVerts;i++){var x=vertices[3*i+0],y=vertices[3*i+1],z=vertices[3*i+2];x<min.x&&(min.x=x),y<min.y&&(min.y=y),z<min.z&&(min.z=z),x>max.x&&(max.x=x),y>max.y&&(max.y=y),z>max.z&&(max.z=z)}this.setMinMax(min,max)}},_proto.intersectsBoundingSphere=function intersectsBoundingSphere(sphere){var sq;return this._distanceToBoundingSphereSq(sphere)<=sphere.radius*sphere.radius},_proto._distanceToBoundingSphereSq=function _distanceToBoundingSphereSq(sphere){for(var boxMin=this.getMin(),boxMax=this.getMax(),sq=0,axis=["x","y","z"],i=0;i<3;++i){var out=0,pn=sphere.center[axis[i]],bMin=boxMin[axis[i]],bMax=boxMax[axis[i]],val=0;pn<bMin&&(out+=(val=bMin-pn)*val),pn>bMax&&(out+=(val=pn-bMax)*val),sq+=out}return sq},_proto._expand=function _expand(expandMin,expandMax){tmpVecA$2.add2(this.getMin(),expandMin),tmpVecB$1.add2(this.getMax(),expandMax),this.setMinMax(tmpVecA$2,tmpVecB$1)},BoundingBox}(),tmpVecA$1=new Vec3,tmpVecB=new Vec3,BoundingSphere=function(){function BoundingSphere(center,radius){void 0===center&&(center=new Vec3),void 0===radius&&(radius=.5),this.center=center,this.radius=radius}var _proto=BoundingSphere.prototype;return _proto.containsPoint=function containsPoint(point){var lenSq=tmpVecA$1.sub2(point,this.center).lengthSq(),r=this.radius;return lenSq<r*r},_proto.intersectsRay=function intersectsRay(ray,point){var m=tmpVecA$1.copy(ray.origin).sub(this.center),b=m.dot(tmpVecB.copy(ray.direction).normalize()),c=m.dot(m)-this.radius*this.radius;if(c>0&&b>0)return null;var discr=b*b-c;if(discr<0)return!1;var t=Math.abs(-b-Math.sqrt(discr));return point&&point.copy(ray.direction).mulScalar(t).add(ray.origin),!0},_proto.intersectsBoundingSphere=function intersectsBoundingSphere(sphere){tmpVecA$1.sub2(sphere.center,this.center);var totalRadius=sphere.radius+this.radius;return tmpVecA$1.lengthSq()<=totalRadius*totalRadius},BoundingSphere}(),BLEND_SUBTRACTIVE=0,BLEND_ADDITIVE=1,BLEND_NORMAL=2,BLEND_NONE=3,BLEND_PREMULTIPLIED=4,BLEND_MULTIPLICATIVE=5,BLEND_ADDITIVEALPHA=6,BLEND_MULTIPLICATIVE2X=7,BLEND_SCREEN=8,BLEND_MIN=9,BLEND_MAX=10,FOG_NONE="none",FOG_LINEAR="linear",FOG_EXP="exp",FOG_EXP2="exp2",FRESNEL_NONE=0,FRESNEL_SCHLICK=2,LAYER_HUD=0,LAYER_GIZMO=1,LAYER_FX=2,LAYER_WORLD=15,LAYERID_WORLD=0,LAYERID_DEPTH=1,LAYERID_SKYBOX=2,LAYERID_IMMEDIATE=3,LAYERID_UI=4,LIGHTTYPE_DIRECTIONAL=0,LIGHTTYPE_OMNI=1,LIGHTTYPE_POINT=1,LIGHTTYPE_SPOT=2,LIGHTSHAPE_PUNCTUAL=0,LIGHTSHAPE_RECT=1,LIGHTSHAPE_DISK=2,LIGHTSHAPE_SPHERE=3,LIGHTFALLOFF_LINEAR=0,LIGHTFALLOFF_INVERSESQUARED=1,SHADOW_PCF3=0,SHADOW_DEPTH=0,SHADOW_VSM8=1,SHADOW_VSM16=2,SHADOW_VSM32=3,SHADOW_PCF5=4,SHADOW_COUNT=5,BLUR_BOX=0,BLUR_GAUSSIAN=1,PARTICLESORT_NONE=0,PARTICLESORT_DISTANCE=1,PARTICLESORT_NEWER_FIRST=2,PARTICLESORT_OLDER_FIRST=3,PARTICLEMODE_GPU=0,PARTICLEMODE_CPU=1,EMITTERSHAPE_BOX=0,EMITTERSHAPE_SPHERE=1,PARTICLEORIENTATION_SCREEN=0,PARTICLEORIENTATION_WORLD=1,PARTICLEORIENTATION_EMITTER=2,PROJECTION_PERSPECTIVE=0,PROJECTION_ORTHOGRAPHIC=1,RENDERSTYLE_SOLID=0,RENDERSTYLE_WIREFRAME=1,RENDERSTYLE_POINTS=2,CUBEPROJ_NONE=0,CUBEPROJ_BOX=1,SPECULAR_PHONG=0,SPECULAR_BLINN=1,DETAILMODE_MUL="mul",DETAILMODE_ADD="add",DETAILMODE_SCREEN="screen",DETAILMODE_OVERLAY="overlay",DETAILMODE_MIN="min",DETAILMODE_MAX="max",GAMMA_NONE=0,GAMMA_SRGB=1,GAMMA_SRGBFAST=2,GAMMA_SRGBHDR=3,TONEMAP_LINEAR=0,TONEMAP_FILMIC=1,TONEMAP_HEJL=2,TONEMAP_ACES=3,TONEMAP_ACES2=4,SPECOCC_NONE=0,SPECOCC_AO=1,SPECOCC_GLOSSDEPENDENT=2,SHADERDEF_NOSHADOW=1,SHADERDEF_SKIN=2,SHADERDEF_UV0=4,SHADERDEF_UV1=8,SHADERDEF_VCOLOR=16,SHADERDEF_INSTANCING=32,SHADERDEF_LM=64,SHADERDEF_DIRLM=128,SHADERDEF_SCREENSPACE=256,SHADERDEF_TANGENTS=512,SHADERDEF_MORPH_POSITION=1024,SHADERDEF_MORPH_NORMAL=2048,SHADERDEF_MORPH_TEXTURE_BASED=4096,LINEBATCH_WORLD=0,LINEBATCH_OVERLAY=1,LINEBATCH_GIZMO=2,SHADOWUPDATE_NONE=0,SHADOWUPDATE_THISFRAME=1,SHADOWUPDATE_REALTIME=2,SORTKEY_FORWARD=0,SORTKEY_DEPTH=1,MASK_DYNAMIC=1,MASK_BAKED=2,MASK_LIGHTMAP=4,SHADER_FORWARD=0,SHADER_FORWARDHDR=1,SHADER_DEPTH=2,SHADER_SHADOW=3,SHADER_PICK=18,SPRITE_RENDERMODE_SIMPLE=0,SPRITE_RENDERMODE_SLICED=1,SPRITE_RENDERMODE_TILED=2,BAKE_COLOR=0,BAKE_COLORDIR=1,VIEW_CENTER=0,VIEW_LEFT=1,VIEW_RIGHT=2,SORTMODE_NONE=0,SORTMODE_MANUAL=1,SORTMODE_MATERIALMESH=2,SORTMODE_BACK2FRONT=3,SORTMODE_FRONT2BACK=4,SORTMODE_CUSTOM=5,COMPUPDATED_INSTANCES=1,COMPUPDATED_LIGHTS=2,COMPUPDATED_CAMERAS=4,COMPUPDATED_BLEND=8,ASPECT_AUTO=0,ASPECT_MANUAL=1,ORIENTATION_HORIZONTAL=0,ORIENTATION_VERTICAL=1,_frustumPoints=[new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3],Frustum=function(){function Frustum(){this.planes=[];for(var i=0;i<6;i++)this.planes[i]=[]}var _proto=Frustum.prototype;return _proto.setFromMat4=function setFromMat4(matrix){var vpm=matrix.data,plane,planes=this.planes;(plane=planes[0])[0]=vpm[3]-vpm[0],plane[1]=vpm[7]-vpm[4],plane[2]=vpm[11]-vpm[8],plane[3]=vpm[15]-vpm[12];var t=Math.sqrt(plane[0]*plane[0]+plane[1]*plane[1]+plane[2]*plane[2]);plane[0]/=t,plane[1]/=t,plane[2]/=t,plane[3]/=t,(plane=planes[1])[0]=vpm[3]+vpm[0],plane[1]=vpm[7]+vpm[4],plane[2]=vpm[11]+vpm[8],plane[3]=vpm[15]+vpm[12],t=Math.sqrt(plane[0]*plane[0]+plane[1]*plane[1]+plane[2]*plane[2]),plane[0]/=t,plane[1]/=t,plane[2]/=t,plane[3]/=t,(plane=planes[2])[0]=vpm[3]+vpm[1],plane[1]=vpm[7]+vpm[5],plane[2]=vpm[11]+vpm[9],plane[3]=vpm[15]+vpm[13],t=Math.sqrt(plane[0]*plane[0]+plane[1]*plane[1]+plane[2]*plane[2]),plane[0]/=t,plane[1]/=t,plane[2]/=t,plane[3]/=t,(plane=planes[3])[0]=vpm[3]-vpm[1],plane[1]=vpm[7]-vpm[5],plane[2]=vpm[11]-vpm[9],plane[3]=vpm[15]-vpm[13],t=Math.sqrt(plane[0]*plane[0]+plane[1]*plane[1]+plane[2]*plane[2]),plane[0]/=t,plane[1]/=t,plane[2]/=t,plane[3]/=t,(plane=planes[4])[0]=vpm[3]-vpm[2],plane[1]=vpm[7]-vpm[6],plane[2]=vpm[11]-vpm[10],plane[3]=vpm[15]-vpm[14],t=Math.sqrt(plane[0]*plane[0]+plane[1]*plane[1]+plane[2]*plane[2]),plane[0]/=t,plane[1]/=t,plane[2]/=t,plane[3]/=t,(plane=planes[5])[0]=vpm[3]+vpm[2],plane[1]=vpm[7]+vpm[6],plane[2]=vpm[11]+vpm[10],plane[3]=vpm[15]+vpm[14],t=Math.sqrt(plane[0]*plane[0]+plane[1]*plane[1]+plane[2]*plane[2]),plane[0]/=t,plane[1]/=t,plane[2]/=t,plane[3]/=t},_proto.containsPoint=function containsPoint(point){var p,plane;for(p=0;p<6;p++)if((plane=this.planes[p])[0]*point.x+plane[1]*point.y+plane[2]*point.z+plane[3]<=0)return!1;return!0},_proto.containsSphere=function containsSphere(sphere){var c=0,d,p,sr=sphere.radius,sc=sphere.center,scx=sc.x,scy=sc.y,scz=sc.z,planes=this.planes,plane;for(p=0;p<6;p++){if((d=(plane=planes[p])[0]*scx+plane[1]*scy+plane[2]*scz+plane[3])<=-sr)return 0;d>sr&&c++}return 6===c?2:1},Frustum.getPoints=function getPoints(camera,near,far){near=near||camera._nearClip,far=far||camera._farClip;var fov=camera._fov*Math.PI/180,y=0===camera._projection?Math.tan(fov/2)*near:camera._orthoHeight,x=y*camera._aspectRatio,points=_frustumPoints;return points[0].x=x,points[0].y=-y,points[0].z=-near,points[1].x=x,points[1].y=y,points[1].z=-near,points[2].x=-x,points[2].y=y,points[2].z=-near,points[3].x=-x,points[3].y=-y,points[3].z=-near,0===camera._projection&&(x=(y=Math.tan(fov/2)*far)*camera._aspectRatio),points[4].x=x,points[4].y=-y,points[4].z=-far,points[5].x=x,points[5].y=y,points[5].z=-far,points[6].x=-x,points[6].y=y,points[6].z=-far,points[7].x=-x,points[7].y=-y,points[7].z=-far,points},Frustum}(),Ray=function(){function Ray(origin,direction){void 0===origin&&(origin=new Vec3),void 0===direction&&(direction=new Vec3(0,0,-1)),this.origin=origin,this.direction=direction}var _proto;return Ray.prototype.set=function set(origin,direction){return this.origin.copy(origin),this.direction.copy(direction),this},Ray}(),tmpRay=new Ray,tmpVec3$2=new Vec3,tmpSphere=new BoundingSphere,tmpMat4$1=new Mat4,OrientedBox=function(){function OrientedBox(worldTransform,halfExtents){void 0===worldTransform&&(worldTransform=new Mat4),void 0===halfExtents&&(halfExtents=new Vec3(.5,.5,.5)),this.halfExtents=halfExtents,this._modelTransform=worldTransform.clone().invert(),this._worldTransform=worldTransform.clone(),this._aabb=new BoundingBox(new Vec3,this.halfExtents)}var _proto=OrientedBox.prototype;return _proto.intersectsRay=function intersectsRay(ray,point){if(this._modelTransform.transformPoint(ray.origin,tmpRay.origin),this._modelTransform.transformVector(ray.direction,tmpRay.direction),point){var result=this._aabb._intersectsRay(tmpRay,point);return tmpMat4$1.copy(this._modelTransform).invert().transformPoint(point,point),result}return this._aabb._fastIntersectsRay(tmpRay)},_proto.containsPoint=function containsPoint(point){return this._modelTransform.transformPoint(point,tmpVec3$2),this._aabb.containsPoint(tmpVec3$2)},_proto.intersectsBoundingSphere=function intersectsBoundingSphere(sphere){return this._modelTransform.transformPoint(sphere.center,tmpSphere.center),tmpSphere.radius=sphere.radius,!!this._aabb.intersectsBoundingSphere(tmpSphere)},_createClass(OrientedBox,[{key:"worldTransform",get:function get(){return this._worldTransform},set:function set(value){this._worldTransform.copy(value),this._modelTransform.copy(value).invert()}}]),OrientedBox}(),tmpVecA=new Vec3,Plane=function(){function Plane(point,normal){void 0===point&&(point=new Vec3),void 0===normal&&(normal=new Vec3(0,0,1)),this.normal=normal,this.point=point}var _proto=Plane.prototype;return _proto.intersectsLine=function intersectsLine(start,end,point){var d=-this.normal.dot(this.point),d0=this.normal.dot(start)+d,d1,t=d0/(d0-(this.normal.dot(end)+d)),intersects=t>=0&&t<=1;return intersects&&point&&point.lerp(start,end,t),intersects},_proto.intersectsRay=function intersectsRay(ray,point){var pointToOrigin=tmpVecA.sub2(this.point,ray.origin),t=this.normal.dot(pointToOrigin)/this.normal.dot(ray.direction),intersects=t>=0;return intersects&&point&&point.copy(ray.direction).mulScalar(t).add(ray.origin),intersects},Plane}(),ADDRESS_REPEAT=0,ADDRESS_CLAMP_TO_EDGE=1,ADDRESS_MIRRORED_REPEAT=2,BLENDMODE_ZERO=0,BLENDMODE_ONE=1,BLENDMODE_SRC_COLOR=2,BLENDMODE_ONE_MINUS_SRC_COLOR=3,BLENDMODE_DST_COLOR=4,BLENDMODE_ONE_MINUS_DST_COLOR=5,BLENDMODE_SRC_ALPHA=6,BLENDMODE_SRC_ALPHA_SATURATE=7,BLENDMODE_ONE_MINUS_SRC_ALPHA=8,BLENDMODE_DST_ALPHA=9,BLENDMODE_ONE_MINUS_DST_ALPHA=10,BLENDEQUATION_ADD=0,BLENDEQUATION_SUBTRACT=1,BLENDEQUATION_REVERSE_SUBTRACT=2,BLENDEQUATION_MIN=3,BLENDEQUATION_MAX=4,BUFFER_STATIC=0,BUFFER_DYNAMIC=1,BUFFER_STREAM=2,BUFFER_GPUDYNAMIC=3,CLEARFLAG_COLOR=1,CLEARFLAG_DEPTH=2,CLEARFLAG_STENCIL=4,CUBEFACE_POSX=0,CUBEFACE_NEGX=1,CUBEFACE_POSY=2,CUBEFACE_NEGY=3,CUBEFACE_POSZ=4,CUBEFACE_NEGZ=5,CULLFACE_NONE=0,CULLFACE_BACK=1,CULLFACE_FRONT=2,CULLFACE_FRONTANDBACK=3,FILTER_NEAREST=0,FILTER_LINEAR=1,FILTER_NEAREST_MIPMAP_NEAREST=2,FILTER_NEAREST_MIPMAP_LINEAR=3,FILTER_LINEAR_MIPMAP_NEAREST=4,FILTER_LINEAR_MIPMAP_LINEAR=5,FUNC_NEVER=0,FUNC_LESS=1,FUNC_EQUAL=2,FUNC_LESSEQUAL=3,FUNC_GREATER=4,FUNC_NOTEQUAL=5,FUNC_GREATEREQUAL=6,FUNC_ALWAYS=7,INDEXFORMAT_UINT8=0,INDEXFORMAT_UINT16=1,INDEXFORMAT_UINT32=2,PIXELFORMAT_A8=0,PIXELFORMAT_L8=1,PIXELFORMAT_L8_A8=2,PIXELFORMAT_R5_G6_B5=3,PIXELFORMAT_R5_G5_B5_A1=4,PIXELFORMAT_R4_G4_B4_A4=5,PIXELFORMAT_R8_G8_B8=6,PIXELFORMAT_R8_G8_B8_A8=7,PIXELFORMAT_DXT1=8,PIXELFORMAT_DXT3=9,PIXELFORMAT_DXT5=10,PIXELFORMAT_RGB16F=11,PIXELFORMAT_RGBA16F=12,PIXELFORMAT_RGB32F=13,PIXELFORMAT_RGBA32F=14,PIXELFORMAT_R32F=15,PIXELFORMAT_DEPTH=16,PIXELFORMAT_DEPTHSTENCIL=17,PIXELFORMAT_111110F=18,PIXELFORMAT_SRGB=19,PIXELFORMAT_SRGBA=20,PIXELFORMAT_ETC1=21,PIXELFORMAT_ETC2_RGB=22,PIXELFORMAT_ETC2_RGBA=23,PIXELFORMAT_PVRTC_2BPP_RGB_1=24,PIXELFORMAT_PVRTC_2BPP_RGBA_1=25,PIXELFORMAT_PVRTC_4BPP_RGB_1=26,PIXELFORMAT_PVRTC_4BPP_RGBA_1=27,PIXELFORMAT_ASTC_4x4=28,PIXELFORMAT_ATC_RGB=29,PIXELFORMAT_ATC_RGBA=30,PRIMITIVE_POINTS=0,PRIMITIVE_LINES=1,PRIMITIVE_LINELOOP=2,PRIMITIVE_LINESTRIP=3,PRIMITIVE_TRIANGLES=4,PRIMITIVE_TRISTRIP=5,PRIMITIVE_TRIFAN=6,SEMANTIC_POSITION="POSITION",SEMANTIC_NORMAL="NORMAL",SEMANTIC_TANGENT="TANGENT",SEMANTIC_BLENDWEIGHT="BLENDWEIGHT",SEMANTIC_BLENDINDICES="BLENDINDICES",SEMANTIC_COLOR="COLOR",SEMANTIC_TEXCOORD="TEXCOORD",SEMANTIC_TEXCOORD0="TEXCOORD0",SEMANTIC_TEXCOORD1="TEXCOORD1",SEMANTIC_TEXCOORD2="TEXCOORD2",SEMANTIC_TEXCOORD3="TEXCOORD3",SEMANTIC_TEXCOORD4="TEXCOORD4",SEMANTIC_TEXCOORD5="TEXCOORD5",SEMANTIC_TEXCOORD6="TEXCOORD6",SEMANTIC_TEXCOORD7="TEXCOORD7",SEMANTIC_ATTR="ATTR",SEMANTIC_ATTR0="ATTR0",SEMANTIC_ATTR1="ATTR1",SEMANTIC_ATTR2="ATTR2",SEMANTIC_ATTR3="ATTR3",SEMANTIC_ATTR4="ATTR4",SEMANTIC_ATTR5="ATTR5",SEMANTIC_ATTR6="ATTR6",SEMANTIC_ATTR7="ATTR7",SEMANTIC_ATTR8="ATTR8",SEMANTIC_ATTR9="ATTR9",SEMANTIC_ATTR10="ATTR10",SEMANTIC_ATTR11="ATTR11",SEMANTIC_ATTR12="ATTR12",SEMANTIC_ATTR13="ATTR13",SEMANTIC_ATTR14="ATTR14",SEMANTIC_ATTR15="ATTR15",SHADERTAG_MATERIAL=1,STENCILOP_KEEP=0,STENCILOP_ZERO=1,STENCILOP_REPLACE=2,STENCILOP_INCREMENT=3,STENCILOP_INCREMENTWRAP=4,STENCILOP_DECREMENT=5,STENCILOP_DECREMENTWRAP=6,STENCILOP_INVERT=7,TEXTURELOCK_READ=1,TEXTURELOCK_WRITE=2,TEXTURETYPE_DEFAULT="default",TEXTURETYPE_RGBM="rgbm",TEXTURETYPE_RGBE="rgbe",TEXTURETYPE_SWIZZLEGGGR="swizzleGGGR",TEXHINT_NONE=0,TEXHINT_SHADOWMAP=1,TEXHINT_ASSET=2,TEXHINT_LIGHTMAP=3,TEXTUREPROJECTION_NONE="none",TEXTUREPROJECTION_CUBE="cube",TEXTUREPROJECTION_EQUIRECT="equirect",TEXTUREPROJECTION_OCTAHEDRAL="octahedral",TYPE_INT8=0,TYPE_UINT8=1,TYPE_INT16=2,TYPE_UINT16=3,TYPE_INT32=4,TYPE_UINT32=5,TYPE_FLOAT32=6,UNIFORMTYPE_BOOL=0,UNIFORMTYPE_INT=1,UNIFORMTYPE_FLOAT=2,UNIFORMTYPE_VEC2=3,UNIFORMTYPE_VEC3=4,UNIFORMTYPE_VEC4=5,UNIFORMTYPE_IVEC2=6,UNIFORMTYPE_IVEC3=7,UNIFORMTYPE_IVEC4=8,UNIFORMTYPE_BVEC2=9,UNIFORMTYPE_BVEC3=10,UNIFORMTYPE_BVEC4=11,UNIFORMTYPE_MAT2=12,UNIFORMTYPE_MAT3=13,UNIFORMTYPE_MAT4=14,UNIFORMTYPE_TEXTURE2D=15,UNIFORMTYPE_TEXTURECUBE=16,UNIFORMTYPE_FLOATARRAY=17,UNIFORMTYPE_TEXTURE2D_SHADOW=18,UNIFORMTYPE_TEXTURECUBE_SHADOW=19,UNIFORMTYPE_TEXTURE3D=20,UNIFORMTYPE_VEC2ARRAY=21,UNIFORMTYPE_VEC3ARRAY=22,UNIFORMTYPE_VEC4ARRAY=23,typedArrayTypes=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array],typedArrayTypesByteSize=[1,1,2,2,4,4,4],typedArrayToType={Int8Array:0,Uint8Array:1,Int16Array:2,Uint16Array:3,Int32Array:4,Uint32Array:5,Float32Array:6},typedArrayIndexFormats=[Uint8Array,Uint16Array,Uint32Array],typedArrayIndexFormatsByteSize=[1,2,4],semanticToLocation={POSITION:0,NORMAL:1,BLENDWEIGHT:2,BLENDINDICES:3,COLOR:4,TEXCOORD0:5,TEXCOORD1:6,TEXCOORD2:7,TEXCOORD3:8,TEXCOORD4:9,TEXCOORD5:10,TEXCOORD6:11,TEXCOORD7:12,TANGENT:13,ATTR0:0,ATTR1:1,ATTR2:2,ATTR3:3,ATTR4:4,ATTR5:5,ATTR6:6,ATTR7:7,ATTR8:8,ATTR9:9,ATTR10:10,ATTR11:11,ATTR12:12,ATTR13:13,ATTR14:14,ATTR15:15},id$2=0,VertexBuffer=function(){function VertexBuffer(graphicsDevice,format,numVertices,usage,initialData){void 0===usage&&(usage=0),this.device=graphicsDevice,this.format=format,this.numVertices=numVertices,this.usage=usage,this.id=id$2++,this._vao=null,this.numBytes=format.verticesByteSize?format.verticesByteSize:format.size*numVertices,graphicsDevice._vram.vb+=this.numBytes,initialData?this.setData(initialData):this.storage=new ArrayBuffer(this.numBytes),this.device.buffers.push(this)}var _proto=VertexBuffer.prototype;return _proto.destroy=function destroy(){var device=this.device,idx=device.buffers.indexOf(this);if(-1!==idx&&device.buffers.splice(idx,1),this.bufferId){var gl=device.gl;device.boundVao=null,gl.bindVertexArray(null),gl.deleteBuffer(this.bufferId),device._vram.vb-=this.storage.byteLength,this.bufferId=null}},_proto.loseContext=function loseContext(){this.bufferId=void 0,this._vao=null},_proto.getFormat=function getFormat(){return this.format},_proto.getUsage=function getUsage(){return this.usage},_proto.getNumVertices=function getNumVertices(){return this.numVertices},_proto.lock=function lock(){return this.storage},_proto.unlock=function unlock(){var gl=this.device.gl,glUsage;switch(this.bufferId||(this.bufferId=gl.createBuffer()),this.usage){case 0:glUsage=gl.STATIC_DRAW;break;case 1:glUsage=gl.DYNAMIC_DRAW;break;case 2:glUsage=gl.STREAM_DRAW;break;case 3:glUsage=this.device.webgl2?gl.DYNAMIC_COPY:gl.STATIC_DRAW}gl.bindBuffer(gl.ARRAY_BUFFER,this.bufferId),gl.bufferData(gl.ARRAY_BUFFER,this.storage,glUsage)},_proto.setData=function setData(data){return data.byteLength!==this.numBytes?(console.error("VertexBuffer: wrong initial data size: expected "+this.numBytes+", got "+data.byteLength),!1):(this.storage=data,this.unlock(),!0)},VertexBuffer}();function hashCode(str){for(var hash=0,i=0,len=str.length;i<len;i++)hash=(hash<<5)-hash+str.charCodeAt(i),hash|=0;return hash}var VertexFormat=function(){function VertexFormat(graphicsDevice,description,vertexCount){var i,len,element;this.elements=[],this.hasUv0=!1,this.hasUv1=!1,this.hasColor=!1,this.hasTangents=!1,this.verticesByteSize=0,this.vertexCount=vertexCount,this.interleaved=void 0===vertexCount,this.size=description.reduce((function(total,desc){return total+4*Math.ceil(desc.components*typedArrayTypesByteSize[desc.type]/4)}),0);var offset=0,elementSize;for(i=0,len=description.length;i<len;i++){var elementDesc=description[i];elementSize=elementDesc.components*typedArrayTypesByteSize[elementDesc.type],vertexCount&&(offset=math.roundUp(offset,elementSize)),element={name:elementDesc.semantic,offset:vertexCount?offset:elementDesc.hasOwnProperty("offset")?elementDesc.offset:offset,stride:vertexCount?elementSize:elementDesc.hasOwnProperty("stride")?elementDesc.stride:this.size,dataType:elementDesc.type,numComponents:elementDesc.components,normalize:void 0!==elementDesc.normalize&&elementDesc.normalize,size:elementSize},this.elements.push(element),offset+=vertexCount?elementSize*vertexCount:4*Math.ceil(elementSize/4),"TEXCOORD0"===elementDesc.semantic?this.hasUv0=!0:"TEXCOORD1"===elementDesc.semantic?this.hasUv1=!0:"COLOR"===elementDesc.semantic?this.hasColor=!0:"TANGENT"===elementDesc.semantic&&(this.hasTangents=!0)}vertexCount&&(this.verticesByteSize=offset),this.update()}VertexFormat.init=function init(graphicsDevice){var formatDesc=[{semantic:"TEXCOORD2",components:4,type:6},{semantic:"TEXCOORD3",components:4,type:6},{semantic:"TEXCOORD4",components:4,type:6},{semantic:"TEXCOORD5",components:4,type:6}];VertexFormat._defaultInstancingFormat=new VertexFormat(graphicsDevice,formatDesc)};var _proto=VertexFormat.prototype;return _proto.update=function update(){this._evaluateHash()},_proto._evaluateHash=function _evaluateHash(){var stringElementBatch,stringElementsBatch=[],stringElementRender,stringElementsRender=[],i,len=this.elements.length,element;for(i=0;i<len;i++)stringElementBatch=(element=this.elements[i]).name,stringElementBatch+=element.dataType,stringElementBatch+=element.numComponents,stringElementBatch+=element.normalize,stringElementsBatch.push(stringElementBatch),stringElementRender=stringElementBatch,stringElementRender+=element.offset,stringElementRender+=element.stride,stringElementRender+=element.size,stringElementsRender.push(stringElementRender);stringElementsBatch.sort(),this.batchingHash=hashCode(stringElementsBatch.join()),this.renderingingHash=hashCode(stringElementsRender.join())},_createClass(VertexFormat,null,[{key:"defaultInstancingFormat",get:function get(){return VertexFormat._defaultInstancingFormat}}]),VertexFormat}();function set1(a){this.array[this.index]=a}function set2(a,b){this.array[this.index]=a,this.array[this.index+1]=b}function set3(a,b,c){this.array[this.index]=a,this.array[this.index+1]=b,this.array[this.index+2]=c}function set4(a,b,c,d){this.array[this.index]=a,this.array[this.index+1]=b,this.array[this.index+2]=c,this.array[this.index+3]=d}function arraySet1(index,inputArray,inputIndex){this.array[index]=inputArray[inputIndex]}function arraySet2(index,inputArray,inputIndex){this.array[index]=inputArray[inputIndex],this.array[index+1]=inputArray[inputIndex+1]}function arraySet3(index,inputArray,inputIndex){this.array[index]=inputArray[inputIndex],this.array[index+1]=inputArray[inputIndex+1],this.array[index+2]=inputArray[inputIndex+2]}function arraySet4(index,inputArray,inputIndex){this.array[index]=inputArray[inputIndex],this.array[index+1]=inputArray[inputIndex+1],this.array[index+2]=inputArray[inputIndex+2],this.array[index+3]=inputArray[inputIndex+3]}function arrayGet1(offset,outputArray,outputIndex){outputArray[outputIndex]=this.array[offset]}function arrayGet2(offset,outputArray,outputIndex){outputArray[outputIndex]=this.array[offset],outputArray[outputIndex+1]=this.array[offset+1]}function arrayGet3(offset,outputArray,outputIndex){outputArray[outputIndex]=this.array[offset],outputArray[outputIndex+1]=this.array[offset+1],outputArray[outputIndex+2]=this.array[offset+2]}function arrayGet4(offset,outputArray,outputIndex){outputArray[outputIndex]=this.array[offset],outputArray[outputIndex+1]=this.array[offset+1],outputArray[outputIndex+2]=this.array[offset+2],outputArray[outputIndex+3]=this.array[offset+3]}VertexFormat._defaultInstancingFormat=null;var VertexIteratorAccessor=function(){function VertexIteratorAccessor(buffer,vertexElement,vertexFormat){switch(this.index=0,this.numComponents=vertexElement.numComponents,vertexFormat.interleaved?this.array=new typedArrayTypes[vertexElement.dataType](buffer,vertexElement.offset):this.array=new typedArrayTypes[vertexElement.dataType](buffer,vertexElement.offset,vertexFormat.vertexCount*vertexElement.numComponents),this.stride=vertexElement.stride/this.array.constructor.BYTES_PER_ELEMENT,vertexElement.numComponents){case 1:this.set=set1,this.getToArray=arrayGet1,this.setFromArray=arraySet1;break;case 2:this.set=set2,this.getToArray=arrayGet2,this.setFromArray=arraySet2;break;case 3:this.set=set3,this.getToArray=arrayGet3,this.setFromArray=arraySet3;break;case 4:this.set=set4,this.getToArray=arrayGet4,this.setFromArray=arraySet4}}var _proto=VertexIteratorAccessor.prototype;return _proto.get=function get(offset){return this.array[this.index+offset]},_proto.set=function set(a,b,c,d){},_proto.getToArray=function getToArray(offset,outputArray,outputIndex){},_proto.setFromArray=function setFromArray(index,inputArray,inputIndex){},VertexIteratorAccessor}(),VertexIterator=function(){function VertexIterator(vertexBuffer){this.vertexBuffer=vertexBuffer,this.vertexFormatSize=vertexBuffer.getFormat().size,this.buffer=this.vertexBuffer.lock(),this.accessors=[],this.element={};for(var vertexFormat=this.vertexBuffer.getFormat(),i=0;i<vertexFormat.elements.length;i++){var vertexElement=vertexFormat.elements[i];this.accessors[i]=new VertexIteratorAccessor(this.buffer,vertexElement,vertexFormat),this.element[vertexElement.name]=this.accessors[i]}}var _proto2=VertexIterator.prototype;return _proto2.next=function next(count){void 0===count&&(count=1);for(var i=0,accessors=this.accessors,numAccessors=this.accessors.length;i<numAccessors;){var accessor=accessors[i++];accessor.index+=count*accessor.stride}},_proto2.end=function end(){this.vertexBuffer.unlock()},_proto2.writeData=function writeData(semantic,data,numVertices){var element=this.element[semantic];if(element){numVertices>this.vertexBuffer.numVertices&&(numVertices=this.vertexBuffer.numVertices);var i,numComponents=element.numComponents;if(this.vertexBuffer.getFormat().interleaved){var index=0;for(i=0;i<numVertices;i++)element.setFromArray(index,data,i*numComponents),index+=element.stride}else if(data.length>numVertices*numComponents){var copyCount=numVertices*numComponents;if(ArrayBuffer.isView(data))data=data.subarray(0,copyCount),element.array.set(data);else for(i=0;i<copyCount;i++)element.array[i]=data[i]}else element.array.set(data)}},_proto2.readData=function readData(semantic,data){var element=this.element[semantic],count=0;if(element){count=this.vertexBuffer.numVertices;var i,numComponents=element.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(data)&&(data.length=0),element.index=0;var offset=0;for(i=0;i<count;i++)element.getToArray(offset,data,i*numComponents),offset+=element.stride}else if(ArrayBuffer.isView(data))data.set(element.array);else{data.length=0;var copyCount=count*numComponents;for(i=0;i<copyCount;i++)data[i]=element.array[i]}}return count},VertexIterator}(),_postEffectQuadVB=null,_postEffectQuadDraw={type:5,base:0,count:4,indexed:!1};function drawQuadWithShader(device,target,shader,rect,scissorRect,useBlend){if(void 0===useBlend&&(useBlend=!1),null===_postEffectQuadVB){var vertexFormat=new VertexFormat(device,[{semantic:"POSITION",components:2,type:6}]);_postEffectQuadVB=new VertexBuffer(device,vertexFormat,4);var iterator=new VertexIterator(_postEffectQuadVB);iterator.element.POSITION.set(-1,-1),iterator.next(),iterator.element.POSITION.set(1,-1),iterator.next(),iterator.element.POSITION.set(-1,1),iterator.next(),iterator.element.POSITION.set(1,1),iterator.end()}var oldRt=device.renderTarget,x,y,w,h,sx,sy,sw,sh;device.setRenderTarget(target),device.updateBegin(),rect?(x=rect.x,y=rect.y,w=rect.z,h=rect.w):(w=target?target.width:device.width,h=target?target.height:device.height,x=0,y=0),scissorRect?(sx=scissorRect.x,sy=scissorRect.y,sw=scissorRect.z,sh=scissorRect.w):(sx=x,sy=y,sw=w,sh=h);var oldVx=device.vx,oldVy=device.vy,oldVw=device.vw,oldVh=device.vh;device.setViewport(x,y,w,h);var oldSx=device.sx,oldSy=device.sy,oldSw=device.sw,oldSh=device.sh;device.setScissor(sx,sy,sw,sh);var oldDepthTest=device.getDepthTest(),oldDepthWrite=device.getDepthWrite(),oldCullMode=device.getCullMode(),oldWR=device.writeRed,oldWG=device.writeGreen,oldWB=device.writeBlue,oldWA=device.writeAlpha;device.setDepthTest(!1),device.setDepthWrite(!1),device.setCullMode(0),device.setColorWrite(!0,!0,!0,!0),useBlend||device.setBlending(!1),device.setVertexBuffer(_postEffectQuadVB,0),device.setShader(shader),device.draw(_postEffectQuadDraw),device.setDepthTest(oldDepthTest),device.setDepthWrite(oldDepthWrite),device.setCullMode(oldCullMode),device.setColorWrite(oldWR,oldWG,oldWB,oldWA),device.updateEnd(),device.setRenderTarget(oldRt),device.updateBegin(),device.setViewport(oldVx,oldVy,oldVw,oldVh),device.setScissor(oldSx,oldSy,oldSw,oldSh)}function destroyPostEffectQuad(){_postEffectQuadVB&&(_postEffectQuadVB.destroy(),_postEffectQuadVB=null)}function drawTexture(device,texture,target,shader,rect,scissorRect,useBlend){void 0===useBlend&&(useBlend=!1),shader=shader||device.getCopyShader(),device.constantTexSource.setValue(texture),drawQuadWithShader(device,target,shader,rect,scissorRect,useBlend)}var Shader=function(){function Shader(graphicsDevice,definition){this.device=graphicsDevice,this.definition=definition,this.init(),this.device.createShader(this)}var _proto=Shader.prototype;return _proto.init=function init(){this.attributes=[],this.uniforms=[],this.samplers=[],this.ready=!1,this.failed=!1},_proto.destroy=function destroy(){this.device.destroyShader(this)},_proto.loseContext=function loseContext(){this.init()},Shader}(),alphaTestPS,ambientConstantPS,ambientPrefilteredCubePS,ambientPrefilteredCubeLodPS,ambientSHPS,aoPS,aoSpecOccPS,aoSpecOccConstPS,aoSpecOccConstSimplePS,aoSpecOccSimplePS,bakeDirLmEndPS,bakeLmEndPS,basePS,baseVS,baseNineSlicedPS,baseNineSlicedVS,baseNineSlicedTiledPS,biasConstPS,blurVSMPS,clearCoatPS,clearCoatGlossPS,clearCoatNormalPS,clusteredLightLoopPS,clusteredLightPS,combineClearCoatPS,combineDiffusePS,combineDiffuseSpecularPS,combineDiffuseSpecularNoConservePS,combineDiffuseSpecularNoReflPS,combineDiffuseSpecularNoReflSeparateAmbientPS,combineDiffuseSpecularOldPS,cookiePS,cubeMapProjectBoxPS,cubeMapProjectNonePS,cubeMapRotatePS,detailModesPS,diffusePS,diffuseDetailMapPS,dilatePS,dpAtlasQuadPS,emissivePS,endPS,endVS="\n",envConstPS,envMultiplyPS,extensionPS="\n",extensionVS="\n",falloffInvSquaredPS,falloffLinearPS,fixCubemapSeamsNonePS,fixCubemapSeamsStretchPS,fogExpPS,fogExp2PS,fogLinearPS,fogNonePS,fresnelSchlickPS,fullscreenQuadPS,fullscreenQuadVS,gamma1_0PS,gamma2_2PS,genParaboloidPS,gles3PS,gles3VS,glossPS,instancingVS,lightDiffuseLambertPS,lightDirPointPS,lightmapDirPS,lightmapSinglePS,lightmapSingleVertPS,lightSpecularAnisoGGXPS,lightSpecularBlinnPS,lightSpecularPhongPS,ltc,metalnessPS,msdfPS,normalVS,normalDetailMapPS,normalInstancedVS,normalMapPS,normalMapFastPS,normalSkinnedVS,normalVertexPS,normalXYPS,normalXYZPS,opacityPS,outputAlphaPS,outputAlphaOpaquePS,outputAlphaPremulPS,outputCubemapPS,outputTex2DPS,packDepthPS,packDepthMaskPS,parallaxPS,particlePS,particleVS,particleAnimFrameClampVS,particleAnimFrameLoopVS,particleAnimTexVS,particleInputFloatPS,particleInputRgba8PS,particleOutputFloatPS,particleOutputRgba8PS,particleUpdaterAABBPS,particleUpdaterEndPS,particleUpdaterInitPS,particleUpdaterNoRespawnPS,particleUpdaterOnStopPS,particleUpdaterRespawnPS,particleUpdaterSpherePS,particleUpdaterStartPS,particle_billboardVS,particle_blendAddPS,particle_blendMultiplyPS,particle_blendNormalPS,particle_cpuVS,particle_cpu_endVS,particle_customFaceVS,particle_endPS,particle_endVS,particle_halflambertPS,particle_initVS,particle_lambertPS,particle_lightingPS,particle_localShiftVS,particle_meshVS,particle_normalVS,particle_normalMapPS,particle_pointAlongVS,particle_softPS,particle_softVS,particle_stretchVS,particle_TBNVS,particle_wrapVS,precisionTestPS,precisionTest2PS,prefilterCubemapPS,reflDirPS,reflDirAnisoPS,reflectionCCPS,reflectionCubePS,reflectionDpAtlasPS,reflectionPrefilteredCubePS,reflectionPrefilteredCubeLodPS,reflectionSpherePS,reflectionSphereLowPS,refractionPS,reprojectPS,rgbmPS,screenDepthPS,shadowCascadesPS,shadowCommonPS,shadowCoordPS,shadowCoordPerspZbufferPS,shadowEVSMPS,shadowEVSMnPS,shadowStandardPS,shadowStandardGL2PS,shadowVSM8PS,shadowVSM_commonPS,skinBatchConstVS,skinBatchTexVS,skinConstVS,skinTexVS,skyboxPS,skyboxVS,skyboxHDRPS,skyboxPrefilteredCubePS,specularPS,specularAaNonePS,specularAaToksvigPS,specularAaToksvigFastPS,spotPS,startPS,startVS,startNineSlicedPS,startNineSlicedTiledPS,storeEVSMPS,tangentBinormalVS,TBNPS,TBNderivativePS,TBNfastPS,TBNObjectSpacePS,tonemappingAcesPS,tonemappingAces2PS,tonemappingFilmicPS,tonemappingHejlPS,tonemappingLinearPS,tonemappingNonePS,transformVS,transformDeclVS,uv0VS,uv1VS,viewDirPS,viewNormalVS,shaderChunks={alphaTestPS:"uniform float alpha_ref;\nvoid alphaTest(float a) {\n\tif (a < alpha_ref) discard;\n}\n",ambientConstantPS:"void addAmbient() {\n\tdDiffuseLight += light_globalAmbient;\n}\n",ambientPrefilteredCubePS:"#ifndef PMREM4\n#define PMREM4\nuniform samplerCube texture_prefilteredCubeMap4;\n#endif\nvoid addAmbient() {\n\tvec3 fixedReflDir = fixSeamsStatic(cubeMapRotate(dNormalW), 1.0 - 1.0 / 4.0);\n#ifndef RIGHT_HANDED_CUBEMAP\n\tfixedReflDir.x *= -1.0;\n#endif\n\tdDiffuseLight += processEnvironment($DECODE(textureCube(texture_prefilteredCubeMap4, fixedReflDir)).rgb);\n}\n",ambientPrefilteredCubeLodPS:"#ifndef PMREM4\n#define PMREM4\n#extension GL_EXT_shader_texture_lod : enable\nuniform samplerCube texture_prefilteredCubeMap128;\n#endif\nvoid addAmbient() {\n\tvec3 fixedReflDir = fixSeamsStatic(cubeMapRotate(dNormalW), 1.0 - 1.0 / 4.0);\n#ifndef RIGHT_HANDED_CUBEMAP\n\tfixedReflDir.x *= -1.0;\n#endif\n\tdDiffuseLight += processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, 5.0) ).rgb);\n}\n",ambientSHPS:"uniform vec3 ambientSH[9];\nvoid addAmbient() {\n\tvec3 n = cubeMapRotate(dNormalW);\n\tvec3 color =\n\t\tambientSH[0] +\n\t\tambientSH[1] * n.x +\n\t\tambientSH[2] * n.y +\n\t\tambientSH[3] * n.z +\n\t\tambientSH[4] * n.x * n.z +\n\t\tambientSH[5] * n.z * n.y +\n\t\tambientSH[6] * n.y * n.x +\n\t\tambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n\t\tambientSH[8] * (n.x * n.x - n.y * n.y);\n\tdDiffuseLight += processEnvironment(max(color, vec3(0.0)));\n}\n",aoPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_aoMap;\n#endif\nvoid applyAO() {\n\tdAo = 1.0;\n\t#ifdef MAPTEXTURE\n\tdAo *= texture2D(texture_aoMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAo *= saturate(vVertexColor.$VC);\n\t#endif\n\tdDiffuseLight *= dAo;\n}\n",aoSpecOccPS:"uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n\tfloat specPow = exp2(dGlossiness * 11.0);\n\tfloat specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n\tspecOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",aoSpecOccConstPS:"void occludeSpecular() {\n\tfloat specPow = exp2(dGlossiness * 11.0);\n\tfloat specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",aoSpecOccConstSimplePS:"void occludeSpecular() {\n\tfloat specOcc = dAo;\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",aoSpecOccSimplePS:"uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n\tfloat specOcc = mix(1.0, dAo, material_occludeSpecularIntensity);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",bakeDirLmEndPS:"\tvec4 dirLm = texture2D(texture_dirLightMap, vUv1);\n\tif (bakeDir > 0.5) {\n\t\tif (dAtten > 0.00001) {\n\t\t\tdirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);\n\t\t\tdAtten = saturate(dAtten);\n\t\t\tgl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);\n\t\t\tgl_FragColor.a = dirLm.w + dAtten;\n\t\t\tgl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);\n\t\t} else {\n\t\t\tgl_FragColor = dirLm;\n\t\t}\n\t} else {\n\t\tgl_FragColor.rgb = dirLm.xyz;\n\t\tgl_FragColor.a = max(dirLm.w, dAtten > 0.00001? (1.0/255.0) : 0.0);\n\t}\n",bakeLmEndPS:"\tgl_FragColor.rgb = dDiffuseLight;\n\tgl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));\n\tgl_FragColor.rgb /= 8.0;\n\tgl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );\n\tgl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;\n\tgl_FragColor.rgb /= gl_FragColor.a;\n",basePS:"uniform vec3 view_position;\nuniform vec3 light_globalAmbient;\nfloat square(float x) {\n\treturn x*x;\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 saturate(vec3 x) {\n\treturn clamp(x, vec3(0.0), vec3(1.0));\n}\n",baseVS:"attribute vec3 vertex_position;\nattribute vec3 vertex_normal;\nattribute vec4 vertex_tangent;\nattribute vec2 vertex_texCoord0;\nattribute vec2 vertex_texCoord1;\nattribute vec4 vertex_color;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nvec3 dPositionW;\nmat4 dModelMatrix;\nmat3 dNormalMatrix;\n",baseNineSlicedPS:"#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",baseNineSlicedVS:"#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n",baseNineSlicedTiledPS:"#define NINESLICED\n#define NINESLICETILED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",biasConstPS:"#define SHADOWBIAS\nfloat getShadowBias(float resolution, float maxBias) {\n\treturn maxBias;\n}\n",blurVSMPS:"varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n#ifdef GAUSS\nuniform float weight[SAMPLES];\n#endif\n#ifdef PACKED\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nvec2 encodeFloatRG( float v ) {\n\tvec2 enc = vec2(1.0, 255.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n\treturn enc;\n}\n#endif\nvoid main(void) {\n\tvec3 moments = vec3(0.0);\n\tvec2 uv = vUv0 - pixelOffset * (float(SAMPLES) * 0.5);\n\tfor (int i=0; i<SAMPLES; i++) {\n\t\tvec4 c = texture2D(source, uv + pixelOffset * float(i));\n\t\t#ifdef PACKED\n\t\tc.xy = vec2(decodeFloatRG(c.xy), decodeFloatRG(c.zw));\n\t\t#endif\n\t\t#ifdef GAUSS\n\t\tmoments += c.xyz * weight[i];\n\t\t#else\n\t\tmoments += c.xyz;\n\t\t#endif\n\t}\n\t#ifndef GAUSS\n\tmoments /= float(SAMPLES);\n\t#endif\n\t#ifdef PACKED\n\tgl_FragColor = vec4(encodeFloatRG(moments.x), encodeFloatRG(moments.y));\n\t#else\n\tgl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);\n\t#endif\n}\n",clearCoatPS:"#ifdef MAPFLOAT\nuniform float material_clearCoat;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatMap;\n#endif\nvoid getClearCoat() {\n\tccSpecularity = 1.0;\n\t#ifdef MAPFLOAT\n\tccSpecularity *= material_clearCoat;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tccSpecularity *= texture2D(texture_clearCoatMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tccSpecularity *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",clearCoatGlossPS:"#ifdef MAPFLOAT\nuniform float material_clearCoatGlossiness;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatGlossMap;\n#endif\nvoid getClearCoatGlossiness() {\n\tccGlossiness = 1.0;\n\t#ifdef MAPFLOAT\n\tccGlossiness *= material_clearCoatGlossiness;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tccGlossiness *= texture2D(texture_clearCoatGlossMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tccGlossiness *= saturate(vVertexColor.$VC);\n\t#endif\n\tccGlossiness += 0.0000001;\n}\n",clearCoatNormalPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatNormalMap;\nuniform float material_clearCoatBumpiness;\n#endif\nvoid getClearCoatNormal() {\n\t#ifdef MAPTEXTURE\n\tvec3 normalMap = unpackNormal(texture2D(texture_clearCoatNormalMap, $UV));\n\tnormalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_clearCoatBumpiness));\n\tccNormalW = dTBN * normalMap;\n\t#else\n\tccNormalW = normalize(dVertexNormalW);\n\t#endif\n\tccReflDirW = normalize(-reflect(dViewDirW, ccNormalW));\n}\n",clusteredLightLoopPS:"\nvec3 cellCoords = floor((vPositionW - clusterBoundsMin) * clusterCellsCountByBoundsSize);\nif (!(any(lessThan(cellCoords, vec3(0.0))) || any(greaterThanEqual(cellCoords, clusterCellsMax)))) {\n\tfloat cellIndex = dot(clusterCellsDot, cellCoords);\n\tfloat clusterV = floor(cellIndex * clusterTextureSize.y);\n\tfloat clusterU = cellIndex - (clusterV * clusterTextureSize.x);\n\tclusterV = (clusterV + 0.5) * clusterTextureSize.z;\n\tconst float maxLightCells = 256.0 / 4.0;\n\tfor (float lightCellIndex = 0.5; lightCellIndex < maxLightCells; lightCellIndex++) {\n\t\tvec4 lightIndices = texture2D(clusterWorldTexture, vec2(clusterTextureSize.y * (clusterU + lightCellIndex), clusterV));\n\t\tvec4 indices = lightIndices * 255.0;\n\t\tif (indices.x <= 0.0)\n\t\t\tbreak;\n\t\tEvaluateClusterLight(indices.x);\n\t\tif (indices.y <= 0.0)\n\t\t\tbreak;\n\t\tEvaluateClusterLight(indices.y);\n\t\tif (indices.z <= 0.0)\n\t\t\tbreak;\n\t\tEvaluateClusterLight(indices.z);\n\t\tif (indices.w <= 0.0)\n\t\t\tbreak;\n\t\tEvaluateClusterLight(indices.w);\n\t\tif (lightCellIndex > clusterPixelsPerCell) {\n\t\t\tbreak;\n\t\t}\n\t}\n}\n",clusteredLightPS:"uniform sampler2D clusterWorldTexture;\nuniform sampler2D lightsTexture8;\nuniform highp sampler2D lightsTextureFloat;\nuniform float clusterPixelsPerCell;\nuniform vec3 clusterCellsCountByBoundsSize;\nuniform vec4 lightsTextureInvSize;\nuniform vec3 clusterTextureSize;\nuniform vec3 clusterBoundsMin;\nuniform vec3 clusterBoundsDelta;\nuniform vec3 clusterCellsDot;\nuniform vec3 clusterCellsMax;\nuniform vec2 clusterCompressionLimit0;\nfloat DecodeClusterFloat4(vec4 data) {\n\treturn dot(data, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\nfloat DecodeClusterFloat2(vec2 data) {\n\treturn dot(data, vec2(1.0, 1.0 / 255.0));\n}\nvoid EvaluateClusterLight(float lightIndex) {\n\tfloat lightV = (lightIndex + 0.5) * lightsTextureInvSize.w;\n\tvec4 lightInfo = texture2D(lightsTexture8, vec2(0.5 * lightsTextureInvSize.z, lightV));\n\tfloat lightType = lightInfo.x;\n\tfloat lightShape = lightInfo.y;\n\tfloat falloffMode = lightInfo.z;\n\tvec4 colorA = texture2D(lightsTexture8, vec2(1.5 * lightsTextureInvSize.z, lightV));\n\tvec4 colorB = texture2D(lightsTexture8, vec2(2.5 * lightsTextureInvSize.z, lightV));\n\tvec3 lightColor = vec3(\n\t\tDecodeClusterFloat2(colorA.xy),\n\t\tDecodeClusterFloat2(colorA.zw),\n\t\tDecodeClusterFloat2(colorB.xy)\n\t) * clusterCompressionLimit0.y;\n\tvec4 coneAngle = texture2D(lightsTexture8, vec2(3.5 * lightsTextureInvSize.z, lightV));\n\tfloat innerConeAngleCos = DecodeClusterFloat2(coneAngle.xy) * 2.0 - 1.0;\n\tfloat outerConeAngleCos = DecodeClusterFloat2(coneAngle.zw) * 2.0 - 1.0;\n\t#ifdef CLUSTER_TEXTURE_FLOAT\n\t\tvec4 lightPosRange = texture2D(lightsTextureFloat, vec2(0.5 * lightsTextureInvSize.x, lightV));\n\t\tvec3 lightPos = lightPosRange.xyz;\n\t\tfloat range = lightPosRange.w;\n\t\tvec4 lightDir_Unused = texture2D(lightsTextureFloat, vec2(1.5 * lightsTextureInvSize.x, lightV));\n\t\tvec3 lightDir = lightDir_Unused.xyz;\n\t#else\n\t\tvec4 encPosX = texture2D(lightsTexture8, vec2(4.5 * lightsTextureInvSize.z, lightV));\n\t\tvec4 encPosY = texture2D(lightsTexture8, vec2(5.5 * lightsTextureInvSize.z, lightV));\n\t\tvec4 encPosZ = texture2D(lightsTexture8, vec2(6.5 * lightsTextureInvSize.z, lightV));\n\t\tvec3 lightPos = vec3(\n\t\t\tDecodeClusterFloat4(encPosX),\n\t\t\tDecodeClusterFloat4(encPosY),\n\t\t\tDecodeClusterFloat4(encPosZ)\n\t\t) * clusterBoundsDelta + clusterBoundsMin;\n\t\tvec4 encRange = texture2D(lightsTexture8, vec2(7.5 * lightsTextureInvSize.z, lightV));\n\t\tfloat range = DecodeClusterFloat4(encRange) * clusterCompressionLimit0.x;\n\t\tvec4 encDirX = texture2D(lightsTexture8, vec2(8.5 * lightsTextureInvSize.z, lightV));\n\t\tvec4 encDirY = texture2D(lightsTexture8, vec2(9.5 * lightsTextureInvSize.z, lightV));\n\t\tvec4 encDirZ = texture2D(lightsTexture8, vec2(10.5 * lightsTextureInvSize.z, lightV));\n\t\tvec3 lightDir = vec3(\n\t\t\tDecodeClusterFloat4(encDirX),\n\t\t\tDecodeClusterFloat4(encDirY),\n\t\t\tDecodeClusterFloat4(encDirZ)\n\t\t) * 2.0 - 1.0;\n\t#endif\n\tgetLightDirPoint(lightPos);\n\tdAtten = getFalloffLinear(range);\n\tif (dAtten > 0.00001) {\n\t\tif (lightType > 0.5) {\n\t\t\tdAtten *= getSpotEffect(lightDir, innerConeAngleCos, outerConeAngleCos);\n\t\t}\n\t\tdAtten *= getLightDiffuse();\n\t\tdDiffuseLight += dAtten * lightColor;\n\t}\n}\n",combineClearCoatPS:"vec3 combineColorCC() {\n\treturn combineColor()+(ccSpecularLight*ccSpecularity+ccReflection.rgb*ccSpecularity*ccReflection.a);\n}\n",combineDiffusePS:"vec3 combineColor() {\n\treturn dAlbedo * dDiffuseLight;\n}\n",combineDiffuseSpecularPS:"vec3 combineColor() {\n\treturn mix(dAlbedo * dDiffuseLight, dSpecularLight + dReflection.rgb * dReflection.a, dSpecularity);\n}\n",combineDiffuseSpecularNoConservePS:"vec3 combineColor() {\n\treturn dAlbedo * dDiffuseLight + (dSpecularLight + dReflection.rgb * dReflection.a) * dSpecularity;\n}\n",combineDiffuseSpecularNoReflPS:"vec3 combineColor() {\n\treturn dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity;\n}\n",combineDiffuseSpecularNoReflSeparateAmbientPS:"uniform vec3 material_ambient;\nvec3 combineColor() {\n\treturn (dDiffuseLight - light_globalAmbient) * dAlbedo + dSpecularLight * dSpecularity + material_ambient * light_globalAmbient;\n}\n",combineDiffuseSpecularOldPS:"vec3 combineColor() {\n\treturn mix(dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity, dReflection.rgb, dReflection.a);\n}\n",cookiePS:"vec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {\n\treturn mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);\n}\n",cubeMapProjectBoxPS:"uniform vec3 envBoxMin, envBoxMax;\nvec3 cubeMapProject(vec3 nrdir) {\n\tnrdir = cubeMapRotate(nrdir);\n\tvec3 rbmax = (envBoxMax - vPositionW) / nrdir;\n\tvec3 rbmin = (envBoxMin - vPositionW) / nrdir;\n\tvec3 rbminmax;\n\trbminmax.x = nrdir.x>0.0? rbmax.x : rbmin.x;\n\trbminmax.y = nrdir.y>0.0? rbmax.y : rbmin.y;\n\trbminmax.z = nrdir.z>0.0? rbmax.z : rbmin.z;\n\tfloat fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n\tvec3 posonbox = vPositionW + nrdir * fa;\n\tvec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;\n\treturn posonbox - envBoxPos;\n}\n",cubeMapProjectNonePS:"vec3 cubeMapProject(vec3 dir) {\n\treturn cubeMapRotate(dir);\n}\n",cubeMapRotatePS:"#ifdef CUBEMAP_ROTATION\nuniform mat3 cubeMapRotationMatrix;\n#endif\nvec3 cubeMapRotate(vec3 refDir) {\n#ifdef CUBEMAP_ROTATION\n\treturn refDir * cubeMapRotationMatrix;\n#else\n\treturn refDir;\n#endif\n}\n",detailModesPS:"vec3 detailMode_mul(vec3 c1, vec3 c2) {\n\treturn c1 * c2;\n}\nvec3 detailMode_add(vec3 c1, vec3 c2) {\n\treturn c1 + c2;\n}\nvec3 detailMode_screen(vec3 c1, vec3 c2) {\n\treturn 1.0 - (1.0 - c1)*(1.0 - c2);\n}\nvec3 detailMode_overlay(vec3 c1, vec3 c2) {\n\treturn mix(1.0 - 2.0*(1.0 - c1)*(1.0 - c2), 2.0*c1*c2, step(c1, vec3(0.5)));\n}\nvec3 detailMode_min(vec3 c1, vec3 c2) {\n\treturn min(c1, c2);\n}\nvec3 detailMode_max(vec3 c1, vec3 c2) {\n\treturn max(c1, c2);\n}\n",diffusePS:"#ifdef MAPCOLOR\nuniform vec3 material_diffuse;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseMap;\n#endif\nvoid getAlbedo() {\n\tdAlbedo = vec3(1.0);\n\t#ifdef MAPCOLOR\n\tdAlbedo *= material_diffuse.rgb;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdAlbedo *= gammaCorrectInput(addAlbedoDetail(texture2D(texture_diffuseMap, $UV).$CH));\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAlbedo *= gammaCorrectInput(saturate(vVertexColor.$VC));\n\t#endif\n}\n",diffuseDetailMapPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseDetailMap;\n#endif\nvec3 addAlbedoDetail(vec3 albedo) {\n\t#ifdef MAPTEXTURE\n\tvec3 albedoDetail = vec3(texture2D(texture_diffuseDetailMap, $UV).$CH);\n\treturn detailMode_$DETAILMODE(albedo, albedoDetail);\n\t#else\n\treturn albedo;\n\t#endif\n}\n",dilatePS:"varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nvoid main(void) {\n\tvec4 c = texture2D(source, vUv0);\n\tc = c.a>0.0? c : texture2D(source, vUv0 - pixelOffset);\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, -pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, 0));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, 0));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + pixelOffset);\n\tgl_FragColor = c;\n}\n",dpAtlasQuadPS:"varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec4 params;\nvoid main(void) {\n\tvec2 uv = vUv0;\n\tuv = uv * 2.0 - vec2(1.0);\n\tuv *= params.xy;\n\tuv = uv * 0.5 + 0.5;\n\tgl_FragColor = texture2D(source, uv);\n}\n",emissivePS:"#ifdef MAPCOLOR\nuniform vec3 material_emissive;\n#endif\n#ifdef MAPFLOAT\nuniform float material_emissiveIntensity;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_emissiveMap;\n#endif\nvec3 getEmission() {\n\tvec3 emission = vec3(1.0);\n\t#ifdef MAPFLOAT\n\temission *= material_emissiveIntensity;\n\t#endif\n\t#ifdef MAPCOLOR\n\temission *= material_emissive;\n\t#endif\n\t#ifdef MAPTEXTURE\n\temission *= $texture2DSAMPLE(texture_emissiveMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\temission *= gammaCorrectInput(saturate(vVertexColor.$VC));\n\t#endif\n\treturn emission;\n}\n",endPS:"\t#ifdef CLEARCOAT\n\tgl_FragColor.rgb = combineColorCC();\n\t#else\n\tgl_FragColor.rgb = combineColor();\n\t#endif\n\tgl_FragColor.rgb += getEmission();\n\tgl_FragColor.rgb = addFog(gl_FragColor.rgb);\n\t#ifndef HDR\n\tgl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n\tgl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n\t#endif\n",endVS:"\n",envConstPS:"vec3 processEnvironment(vec3 color) {\n\treturn color;\n}\n",envMultiplyPS:"uniform float skyboxIntensity;\nvec3 processEnvironment(vec3 color) {\n\treturn color * skyboxIntensity;\n}\n",extensionPS:"\n",extensionVS:"\n",falloffInvSquaredPS:"float getFalloffWindow(float lightRadius) {\n\tfloat sqrDist = dot(dLightDirW, dLightDirW);\n\tfloat invRadius = 1.0 / lightRadius;\n\treturn square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n}\nfloat getFalloffInvSquared(float lightRadius) {\n\tfloat sqrDist = dot(dLightDirW, dLightDirW);\n\tfloat falloff = 1.0 / (sqrDist + 1.0);\n\tfloat invRadius = 1.0 / lightRadius;\n\tfalloff *= 16.0;\n\tfalloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n\treturn falloff;\n}\n",falloffLinearPS:"float getFalloffLinear(float lightRadius) {\n\tfloat d = length(dLightDirW);\n\treturn max(((lightRadius - d) / lightRadius), 0.0);\n}\n",fixCubemapSeamsNonePS:"vec3 fixSeams(vec3 vec, float mipmapIndex) {\n\treturn vec;\n}\nvec3 fixSeams(vec3 vec) {\n\treturn vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n\treturn vec;\n}\nvec3 calcSeam(vec3 vec) {\n\treturn vec3(0);\n}\nvec3 applySeam(vec3 vec, vec3 seam, float scale) {\n\treturn vec;\n}\n",fixCubemapSeamsStretchPS:"vec3 fixSeams(vec3 vec, float mipmapIndex) {\n\tfloat scale = 1.0 - exp2(mipmapIndex) / 128.0;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 fixSeams(vec3 vec) {\n\tfloat scale = 1.0 - 1.0 / 128.0;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n\tfloat scale = invRecMipSize;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 calcSeam(vec3 vec) {\n\tvec3 avec = abs(vec);\n\tfloat M = max(avec.x, max(avec.y, avec.z));\n\treturn vec3(avec.x != M ? 1.0 : 0.0,\n\t\t\t\tavec.y != M ? 1.0 : 0.0,\n\t\t\t\tavec.z != M ? 1.0 : 0.0);\n}\nvec3 applySeam(vec3 vec, vec3 seam, float scale) {\n\treturn vec * (seam * -scale + vec3(1.0));\n}\n",fogExpPS:"uniform vec3 fog_color;\nuniform float fog_density;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = exp(-depth * fog_density);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogExp2PS:"uniform vec3 fog_color;\nuniform float fog_density;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = exp(-depth * depth * fog_density * fog_density);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogLinearPS:"uniform vec3 fog_color;\nuniform float fog_start;\nuniform float fog_end;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = (fog_end - depth) / (fog_end - fog_start);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\tfogFactor = gammaCorrectInput(fogFactor);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogNonePS:"float dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\treturn color;\n}\n",fresnelSchlickPS:"\nuniform float material_fresnelFactor;\nvoid getFresnel() {\n\tfloat fresnel = 1.0 - max(dot(dNormalW, dViewDirW), 0.0);\n\tfloat fresnel2 = fresnel * fresnel;\n\tfresnel *= fresnel2 * fresnel2;\n\tfresnel *= dGlossiness * dGlossiness;\n\tdSpecularity = dSpecularity + (1.0 - dSpecularity) * fresnel;\n\t#ifdef CLEARCOAT\n\tfresnel = 1.0 - max(dot(ccNormalW, dViewDirW), 0.0);\n\tfresnel2 = fresnel * fresnel;\n\tfresnel *= fresnel2 * fresnel2;\n\tfresnel *= ccGlossiness * ccGlossiness;\n\tccSpecularity = ccSpecularity + (1.0 - ccSpecularity) * fresnel;\n\t#endif\n}\n",fullscreenQuadPS:"varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",fullscreenQuadVS:"attribute vec2 vertex_position;\nvarying vec2 vUv0;\nvoid main(void)\n{\n\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\tvUv0 = vertex_position.xy*0.5+0.5;\n}\n",gamma1_0PS:"vec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n\treturn texture2D(tex, uv);\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n\treturn texture2D(tex, uv, bias);\n}\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n\treturn textureCube(tex, uvw);\n}\nvec3 gammaCorrectOutput(vec3 color) {\n\treturn color;\n}\nvec3 gammaCorrectInput(vec3 color) {\n\treturn color;\n}\nfloat gammaCorrectInput(float color) {\n\treturn color;\n}\nvec4 gammaCorrectInput(vec4 color) {\n\treturn color;\n}\n",gamma2_2PS:"vec3 gammaCorrectInput(vec3 color) {\n\treturn pow(color, vec3(2.2));\n}\nfloat gammaCorrectInput(float color) {\n\treturn pow(color, 2.2);\n}\nvec4 gammaCorrectInput(vec4 color) {\n\treturn vec4(pow(color.rgb, vec3(2.2)), color.a);\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n\tvec4 rgba = texture2D(tex, uv);\n\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\treturn rgba;\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n\tvec4 rgba = texture2D(tex, uv, bias);\n\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\treturn rgba;\n}\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n\tvec4 rgba = textureCube(tex, uvw);\n\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\treturn rgba;\n}\nvec3 gammaCorrectOutput(vec3 color) {\n\t#ifdef HDR\n\treturn color;\n\t#else\n\tcolor += vec3(0.0000001);\n\treturn pow(color, vec3(0.45));\n\t#endif\n}\n",genParaboloidPS:"varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nvoid main(void) {\n\tvec2 uv = vUv0;\n\tfloat side = uv.x < 0.5? 1.0 : -1.0;\n\tvec2 tc;\n\ttc.x = fract(uv.x * 2.0) * 2.0 - 1.0;\n\ttc.y = uv.y * 2.0 - 1.0;\n\tconst float scale = 1.1;\n\ttc *= scale;\n\tvec3 dir;\n\tdir.y = (dot(tc, tc) - 1.0) * side;\n\tdir.xz = tc * -2.0;\n\tdir.x *= -side * params.y;\n\tdir = fixSeams(dir, params.x);\n\tvec4 color = textureCube(source, dir, -100.0);\n\tgl_FragColor = color;\n}\n",gles3PS:"#define varying in\nout highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n#define GL2\n",gles3VS:"#define attribute in\n#define varying out\n#define texture2D texture\n#define GL2\n#define VERTEXSHADER\n",glossPS:"#ifdef MAPFLOAT\nuniform float material_shininess;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_glossMap;\n#endif\nvoid getGlossiness() {\n\tdGlossiness = 1.0;\n\t#ifdef MAPFLOAT\n\tdGlossiness *= material_shininess;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdGlossiness *= texture2D(texture_glossMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdGlossiness *= saturate(vVertexColor.$VC);\n\t#endif\n\tdGlossiness += 0.0000001;\n}\n",instancingVS:"attribute vec4 instance_line1;\nattribute vec4 instance_line2;\nattribute vec4 instance_line3;\nattribute vec4 instance_line4;\n",lightDiffuseLambertPS:"float getLightDiffuse() {\n\treturn max(dot(dNormalW, -dLightDirNormW), 0.0);\n}\n",lightDirPointPS:"void getLightDirPoint(vec3 lightPosW) {\n\tdLightDirW = vPositionW - lightPosW;\n\tdLightDirNormW = normalize(dLightDirW);\n\tdLightPosW = lightPosW;\n}\n",lightmapDirPS:"uniform sampler2D texture_lightMap;\nuniform sampler2D texture_dirLightMap;\nvoid addLightMap() {\n\tvec3 color = $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n\tvec3 dir = texture2D(texture_dirLightMap, $UV).xyz;\n\tif (dot(dir, vec3(1.0)) < 0.00001) {\n\t\tdDiffuseLight += color;\n\t} else {\n\t\tdLightDirNormW = normalize(dir * 2.0 - vec3(1.0));\n\t\tfloat vlight = saturate(dot(dLightDirNormW, -dVertexNormalW));\n\t\tfloat flight = saturate(dot(dLightDirNormW, -dNormalW));\n\t\tfloat nlight = (flight / max(vlight, 0.01)) * 0.5;\n\t\tdDiffuseLight += color * nlight * 2.0;\n\t}\n\tdSpecularLight += color * getLightSpecular();\n}\n",lightmapSinglePS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_lightMap;\n#endif\nvoid addLightMap() {\n\tvec3 lm = vec3(1.0);\n\t#ifdef MAPTEXTURE\n\tlm *= $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tlm *= saturate(vVertexColor.$VC);\n\t#endif\n\tdDiffuseLight += lm;\n}\n",lightmapSingleVertPS:"void addLightMap() {\n\tdDiffuseLight += saturate(vVertexColor.$CH);\n}\n",lightSpecularAnisoGGXPS:"\nfloat calcLightSpecular(float tGlossiness, vec3 tNormalW) {\n\tfloat PI = 3.141592653589793;\n\tfloat roughness = max((1.0 - tGlossiness) * (1.0 - tGlossiness), 0.001);\n\tfloat anisotropy = material_anisotropy * roughness;\n\tfloat at = max((roughness + anisotropy), roughness / 4.0);\n\tfloat ab = max((roughness - anisotropy), roughness / 4.0);\n\tvec3 h = normalize(normalize(-dLightDirNormW) + normalize(dViewDirW));\n\tfloat NoH = dot(tNormalW, h);\n\tfloat ToH = dot(dTBN[0], h);\n\tfloat BoH = dot(dTBN[1], h);\n\tfloat a2 = at * ab;\n\tvec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);\n\tfloat v2 = dot(v, v);\n\tfloat w2 = a2 / v2;\n\tfloat D = a2 * w2 * w2 * (1.0 / PI);\n\tfloat ToV = dot(dTBN[0], dViewDirW);\n\tfloat BoV = dot(dTBN[1], dViewDirW);\n\tfloat ToL = dot(dTBN[0], -dLightDirNormW);\n\tfloat BoL = dot(dTBN[1], -dLightDirNormW);\n\tfloat NoV = dot(tNormalW, dViewDirW);\n\tfloat NoL = dot(tNormalW, -dLightDirNormW);\n\tfloat lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));\n\tfloat lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));\n\tfloat G = 0.5 / (lambdaV + lambdaL);\n\treturn D * G;\n}\nfloat getLightSpecular() {\n\treturn calcLightSpecular(dGlossiness, dNormalW);\n}\nfloat getLightSpecularCC() {\n\treturn calcLightSpecular(ccGlossiness, ccNormalW);\n}\n",lightSpecularBlinnPS:"\nfloat calcLightSpecular(float tGlossiness, vec3 tNormalW) {\n\tvec3 h = normalize( -dLightDirNormW + dViewDirW );\n\tfloat nh = max( dot( h, tNormalW ), 0.0 );\n\tfloat specPow = exp2(tGlossiness * 11.0);\n\tspecPow = antiAliasGlossiness(specPow);\n\tspecPow = max(specPow, 0.0001);\n\treturn pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\nfloat getLightSpecular() {\n\treturn calcLightSpecular(dGlossiness, dNormalW);\n}\nfloat getLightSpecularCC() {\n\treturn calcLightSpecular(ccGlossiness, ccNormalW);\n}\n",lightSpecularPhongPS:"float calcLightSpecular(float tGlossiness, vec3 tReflDirW) {\n\tfloat specPow = tGlossiness;\n\tspecPow = antiAliasGlossiness(specPow);\n\treturn pow(max(dot(tReflDirW, -dLightDirNormW), 0.0), specPow + 0.0001);\n}\nfloat getLightSpecular() {\n\treturn calcLightSpecular(dGlossiness, dReflDirW);\n}\nfloat getLightSpecularCC() {\n\treturn calcLightSpecular(ccGlossiness, ccReflDirW);\n}\n",ltc:"\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nstruct Coords {\n\tvec3 coord0;\n\tvec3 coord1;\n\tvec3 coord2;\n\tvec3 coord3;\n};\nfloat LTC_EvaluateRect( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in Coords rectCoords) {\n\tvec3 v1 = rectCoords.coord1 - rectCoords.coord0;\n\tvec3 v2 = rectCoords.coord3 - rectCoords.coord0;\n\tvec3 lightNormal = cross( v1, v2 );\n\tfloat factor = sign(-dot( lightNormal, P - rectCoords.coord0 ));\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 =  factor * cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords.coord0 - P );\n\tcoords[ 1 ] = mat * ( rectCoords.coord1 - P );\n\tcoords[ 2 ] = mat * ( rectCoords.coord2 - P );\n\tcoords[ 3 ] = mat * ( rectCoords.coord3 - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn result;\n}\nCoords dLTCCoords;\nCoords getLTCLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\tCoords coords;\n\tcoords.coord0 = lightPos + halfWidth - halfHeight;\n\tcoords.coord1 = lightPos - halfWidth - halfHeight;\n\tcoords.coord2 = lightPos - halfWidth + halfHeight;\n\tcoords.coord3 = lightPos + halfWidth + halfHeight;\n\treturn coords;\n}\nfloat dSphereRadius;\nCoords getSphereLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\tCoords coords;\n\tfloat radius = max(length(halfWidth), length(halfWidth));\n\tdSphereRadius = radius;\n\tvec3 f = normalize(lightPos-view_position);\n\tvec3 w = normalize(cross(f, halfHeight));\n\tvec3 h = normalize(cross(f, w));\n\tcoords.coord0 = lightPos + w * radius - h * radius;\n\tcoords.coord1 = lightPos - w * radius - h * radius;\n\tcoords.coord2 = lightPos - w * radius + h * radius;\n\tcoords.coord3 = lightPos + w * radius + h * radius;\n\treturn coords;\n}\nvec2 dLTCUV;\n#ifdef CLEARCOAT\nvec2 ccLTCUV;\n#endif\nvec2 getLTCLightUV(float tGlossiness, vec3 tNormalW)\n{\n\tfloat roughness = max((1.0 - tGlossiness) * (1.0 - tGlossiness), 0.001);\n\treturn LTC_Uv( tNormalW, dViewDirW, roughness );\n}\nvec3 dLTCSpecFres;\n#ifdef CLEARCOAT\nvec3 ccLTCSpecFres;\n#endif\nvec3 getLTCLightSpecFres(vec2 uv, vec3 tSpecularity)\n{\n\tvec4 t2 = texture2D( areaLightsLutTex2, uv );\n\t#ifdef AREA_R8_G8_B8_A8_LUTS\n\tt2 *= vec4(0.693103,1,1,1);\n\tt2 += vec4(0.306897,0,0,0);\n\t#endif\n\treturn tSpecularity * t2.x + ( vec3( 1.0 ) - tSpecularity) * t2.y;\n}\nvoid calcLTCLightValues()\n{\n\tdLTCUV = getLTCLightUV(dGlossiness, dNormalW);\n\tdLTCSpecFres = getLTCLightSpecFres(dLTCUV, dSpecularityNoFres);\n#ifdef CLEARCOAT\n\tccLTCUV = getLTCLightUV(ccGlossiness, ccNormalW);\n\tccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3(ccSpecularityNoFres));\n#endif\n}\nvoid calcRectLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tdLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);\n\tcalcLTCLightValues();\n}\nvoid calcDiskLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tcalcRectLightValues(lightPos, halfWidth, halfHeight);\n}\nvoid calcSphereLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tdLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);\n\tcalcLTCLightValues();\n}\nvec3 SolveCubic(vec4 Coefficient)\n{\n\tfloat pi = 3.14159;\n\tCoefficient.xyz /= Coefficient.w;\n\tCoefficient.yz /= 3.0;\n\tfloat A = Coefficient.w;\n\tfloat B = Coefficient.z;\n\tfloat C = Coefficient.y;\n\tfloat D = Coefficient.x;\n\tvec3 Delta = vec3(\n\t\t-Coefficient.z * Coefficient.z + Coefficient.y,\n\t\t-Coefficient.y * Coefficient.z + Coefficient.x,\n\t\tdot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)\n\t);\n\tfloat Discriminant = dot(vec2(4.0 * Delta.x, -Delta.y), Delta.zy);\n\tvec3 RootsA, RootsD;\n\tvec2 xlc, xsc;\n\t{\n\t\tfloat A_a = 1.0;\n\t\tfloat C_a = Delta.x;\n\t\tfloat D_a = -2.0 * B * Delta.x + Delta.y;\n\t\tfloat Theta = atan(sqrt(Discriminant), -D_a) / 3.0;\n\t\tfloat x_1a = 2.0 * sqrt(-C_a) * cos(Theta);\n\t\tfloat x_3a = 2.0 * sqrt(-C_a) * cos(Theta + (2.0 / 3.0) * pi);\n\t\tfloat xl;\n\t\tif ((x_1a + x_3a) > 2.0 * B)\n\t\t\txl = x_1a;\n\t\telse\n\t\t\txl = x_3a;\n\t\txlc = vec2(xl - B, A);\n\t}\n\t{\n\t\tfloat A_d = D;\n\t\tfloat C_d = Delta.z;\n\t\tfloat D_d = -D * Delta.y + 2.0 * C * Delta.z;\n\t\tfloat Theta = atan(D * sqrt(Discriminant), -D_d) / 3.0;\n\t\tfloat x_1d = 2.0 * sqrt(-C_d) * cos(Theta);\n\t\tfloat x_3d = 2.0 * sqrt(-C_d) * cos(Theta + (2.0 / 3.0) * pi);\n\t\tfloat xs;\n\t\tif (x_1d + x_3d < 2.0 * C)\n\t\t\txs = x_1d;\n\t\telse\n\t\t\txs = x_3d;\n\t\txsc = vec2(-D, xs + C);\n\t}\n\tfloat E =  xlc.y * xsc.y;\n\tfloat F = -xlc.x * xsc.y - xlc.y * xsc.x;\n\tfloat G =  xlc.x * xsc.x;\n\tvec2 xmc = vec2(C * F - B * G, -B * F + C * E);\n\tvec3 Root = vec3(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);\n\tif (Root.x < Root.y && Root.x < Root.z)\n\t\tRoot.xyz = Root.yxz;\n\telse if (Root.z < Root.x && Root.z < Root.y)\n\t\tRoot.xyz = Root.xzy;\n\treturn Root;\n}\nfloat LTC_EvaluateDisk(vec3 N, vec3 V, vec3 P, mat3 Minv, Coords points)\n{\n\tvec3 T1, T2;\n\tT1 = normalize(V - N * dot(V, N));\n\tT2 = cross(N, T1);\n\tmat3 R = transposeMat3( mat3( T1, T2, N ) );\n\tvec3 L_[ 3 ];\n\tL_[ 0 ] = R * ( points.coord0 - P );\n\tL_[ 1 ] = R * ( points.coord1 - P );\n\tL_[ 2 ] = R * ( points.coord2 - P );\n\tvec3 Lo_i = vec3(0);\n\tvec3 C  = 0.5 * (L_[0] + L_[2]);\n\tvec3 V1 = 0.5 * (L_[1] - L_[2]);\n\tvec3 V2 = 0.5 * (L_[1] - L_[0]);\n\tC  = Minv * C;\n\tV1 = Minv * V1;\n\tV2 = Minv * V2;\n\tfloat a, b;\n\tfloat d11 = dot(V1, V1);\n\tfloat d22 = dot(V2, V2);\n\tfloat d12 = dot(V1, V2);\n\tif (abs(d12) / sqrt(d11 * d22) > 0.0001)\n\t{\n\t\tfloat tr = d11 + d22;\n\t\tfloat det = -d12 * d12 + d11 * d22;\n\t\tdet = sqrt(det);\n\t\tfloat u = 0.5 * sqrt(tr - 2.0 * det);\n\t\tfloat v = 0.5 * sqrt(tr + 2.0 * det);\n\t\tfloat e_max = (u + v) * (u + v);\n\t\tfloat e_min = (u - v) * (u - v);\n\t\tvec3 V1_, V2_;\n\t\tif (d11 > d22)\n\t\t{\n\t\t\tV1_ = d12 * V1 + (e_max - d11) * V2;\n\t\t\tV2_ = d12 * V1 + (e_min - d11) * V2;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tV1_ = d12*V2 + (e_max - d22)*V1;\n\t\t\tV2_ = d12*V2 + (e_min - d22)*V1;\n\t\t}\n\t\ta = 1.0 / e_max;\n\t\tb = 1.0 / e_min;\n\t\tV1 = normalize(V1_);\n\t\tV2 = normalize(V2_);\n\t}\n\telse\n\t{\n\t\ta = 1.0 / dot(V1, V1);\n\t\tb = 1.0 / dot(V2, V2);\n\t\tV1 *= sqrt(a);\n\t\tV2 *= sqrt(b);\n\t}\n\tvec3 V3 = cross(V1, V2);\n\tif (dot(C, V3) < 0.0)\n\t\tV3 *= -1.0;\n\tfloat L  = dot(V3, C);\n\tfloat x0 = dot(V1, C) / L;\n\tfloat y0 = dot(V2, C) / L;\n\tfloat E1 = inversesqrt(a);\n\tfloat E2 = inversesqrt(b);\n\ta *= L * L;\n\tb *= L * L;\n\tfloat c0 = a * b;\n\tfloat c1 = a * b * (1.0 + x0 * x0 + y0 * y0) - a - b;\n\tfloat c2 = 1.0 - a * (1.0 + x0 * x0) - b * (1.0 + y0 * y0);\n\tfloat c3 = 1.0;\n\tvec3 roots = SolveCubic(vec4(c0, c1, c2, c3));\n\tfloat e1 = roots.x;\n\tfloat e2 = roots.y;\n\tfloat e3 = roots.z;\n\tvec3 avgDir = vec3(a * x0 / (a - e2), b * y0 / (b - e2), 1.0);\n\tmat3 rotate = mat3(V1, V2, V3);\n\tavgDir = rotate * avgDir;\n\tavgDir = normalize(avgDir);\n\tfloat L1 = sqrt(-e2 / e3);\n\tfloat L2 = sqrt(-e2 / e1);\n\tfloat formFactor = L1 * L2 * inversesqrt((1.0 + L1 * L1) * (1.0 + L2 * L2));\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tvec2 uv = vec2(avgDir.z * 0.5 + 0.5, formFactor);\n\tuv = uv*LUT_SCALE + LUT_BIAS;\n\tfloat scale = texture2D( areaLightsLutTex2, uv ).w;\n\treturn formFactor*scale;\n}\nfloat getRectLightDiffuse() {\n\treturn LTC_EvaluateRect( dNormalW, dViewDirW, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\nfloat getDiskLightDiffuse() {\n\treturn LTC_EvaluateDisk( dNormalW, dViewDirW, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\nfloat getSphereLightDiffuse() {\n\tfloat falloff = dSphereRadius / (dot(dLightDirW, dLightDirW) + dSphereRadius);\n\treturn getLightDiffuse()*falloff;\n}\nmat3 getLTCLightInvMat(vec2 uv)\n{\n\tvec4 t1 = texture2D( areaLightsLutTex1, uv );\n\t#ifdef AREA_R8_G8_B8_A8_LUTS\n\tt1 *= vec4(1.001, 0.3239, 0.60437568, 1.0);\n\tt1 += vec4(0.0, -0.2976, -0.01381, 0.0);\n\t#endif\n\treturn mat3(\n\t\tvec3( t1.x, 0, t1.y ),\n\t\tvec3(\t0, 1,\t0 ),\n\t\tvec3( t1.z, 0, t1.w )\n\t);\n}\nfloat calcRectLightSpecular(vec3 tNormalW, vec2 uv) {\n\tmat3 mInv = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateRect( tNormalW, dViewDirW, vPositionW, mInv, dLTCCoords );\n}\nfloat getRectLightSpecular() {\n\treturn calcRectLightSpecular(dNormalW, dLTCUV);\n}\n#ifdef CLEARCOAT\nfloat getRectLightSpecularCC() {\n\treturn calcRectLightSpecular(ccNormalW, ccLTCUV);\n}\n#endif\nfloat calcDiskLightSpecular(vec3 tNormalW, vec2 uv) {\n\tmat3 mInv = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateDisk( tNormalW, dViewDirW, vPositionW, mInv, dLTCCoords );\n}\nfloat getDiskLightSpecular() {\n\treturn calcDiskLightSpecular(dNormalW, dLTCUV);\n}\n#ifdef CLEARCOAT\nfloat getDiskLightSpecularCC() {\n\treturn calcDiskLightSpecular(ccNormalW, ccLTCUV);\n}\n#endif\nfloat getSphereLightSpecular() {\n\treturn calcDiskLightSpecular(dNormalW, dLTCUV);\n}\n#ifdef CLEARCOAT\nfloat getSphereLightSpecularCC() {\n\treturn calcDiskLightSpecular(ccNormalW, ccLTCUV);\n}\n#endif\n",metalnessPS:"void processMetalness(float metalness) {\n\tconst float dielectricF0 = 0.04;\n\tdSpecularity = mix(vec3(dielectricF0), dAlbedo, metalness);\n\tdAlbedo *= 1.0 - metalness;\n}\n#ifdef MAPFLOAT\nuniform float material_metalness;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_metalnessMap;\n#endif\nvoid getSpecularity() {\n\tfloat metalness = 1.0;\n\t#ifdef MAPFLOAT\n\tmetalness *= material_metalness;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tmetalness *= texture2D(texture_metalnessMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tmetalness *= saturate(vVertexColor.$VC);\n\t#endif\n\tprocessMetalness(metalness);\n}\n",msdfPS:"uniform sampler2D texture_msdfMap;\n#ifdef GL_OES_standard_derivatives\n#define USE_FWIDTH\n#endif\n#ifdef GL2\n#define USE_FWIDTH\n#endif\nfloat median(float r, float g, float b) {\n\treturn max(min(r, g), min(max(r, g), b));\n}\nfloat map (float min, float max, float v) {\n\treturn (v - min) / (max - min);\n}\nuniform float font_sdfIntensity;\nuniform float font_pxrange;\nuniform float font_textureWidth;\nuniform vec4 outline_color;\nuniform float outline_thickness;\nuniform vec4 shadow_color;\nuniform vec2 shadow_offset;\nvec4 applyMsdf(vec4 color) {\n\tvec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;\n\tvec2 uvShdw = vUv0 - shadow_offset;\n\tvec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;\n\tfloat sigDist = median(tsample.r, tsample.g, tsample.b);\n\tfloat sigDistShdw = median(ssample.r, ssample.g, ssample.b);\n\t#ifdef USE_FWIDTH\n\tvec2 w = fwidth(vUv0);\n\tfloat smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, 0.5);\n\t#else\n\tfloat font_size = 16.0;\n\tfloat smoothing = clamp(font_pxrange / font_size, 0.0, 0.5);\n\t#endif\n\tfloat mapMin = 0.05;\n\tfloat mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);\n\tfloat sigDistInner = map(mapMin, mapMax, sigDist);\n\tfloat sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);\n\tsigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);\n\tfloat center = 0.5;\n\tfloat inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);\n\tfloat outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);\n\tfloat shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);\n\tvec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);\n\ttcolor = mix(tcolor, color, inside);\n\tvec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;\n\ttcolor = mix(scolor, tcolor, outline);\n\treturn tcolor;\n}\n",normalVS:"#ifdef MORPHING_TEXTURE_BASED_NORMAL\nuniform highp sampler2D morphNormalTex;\n#endif\nvec3 getNormal() {\n\t#ifdef SKIN\n\tdNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n\t#elif defined(INSTANCING)\n\tdNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n\t#else\n\tdNormalMatrix = matrix_normal;\n\t#endif\n\tvec3 tempNormal = vertex_normal;\n\t#ifdef MORPHING\n\t#ifdef MORPHING_NRM03\n\ttempNormal += morph_weights_a[0] * morph_nrm0;\n\ttempNormal += morph_weights_a[1] * morph_nrm1;\n\ttempNormal += morph_weights_a[2] * morph_nrm2;\n\ttempNormal += morph_weights_a[3] * morph_nrm3;\n\t#endif\n\t#ifdef MORPHING_NRM47\n\ttempNormal += morph_weights_b[0] * morph_nrm4;\n\ttempNormal += morph_weights_b[1] * morph_nrm5;\n\ttempNormal += morph_weights_b[2] * morph_nrm6;\n\ttempNormal += morph_weights_b[3] * morph_nrm7;\n\t#endif\n\t#endif\n\t#ifdef MORPHING_TEXTURE_BASED_NORMAL\n\tvec2 morphUV = getTextureMorphCoords();\n\tvec3 morphNormal = texture2D(morphNormalTex, morphUV).xyz;\n\ttempNormal += morphNormal;\n\t#endif\n\treturn normalize(dNormalMatrix * tempNormal);\n}\n",normalDetailMapPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_normalDetailMap;\nuniform float material_normalDetailMapBumpiness;\nvec3 blendNormals(vec3 n1, vec3 n2) {\n\tn1 += vec3(0, 0, 1);\n\tn2 *= vec3(-1, -1, 1);\n\treturn normalize(n1*dot(n1, n2)/n1.z - n2);\n}\n#endif\nvec3 addNormalDetail(vec3 normalMap) {\n\t#ifdef MAPTEXTURE\n\tvec3 normalDetailMap = unpackNormal(texture2D(texture_normalDetailMap, $UV));\n\tnormalDetailMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness));\n\treturn blendNormals(normalMap, normalDetailMap);\n\t#else\n\treturn normalMap;\n\t#endif\n}\n",normalInstancedVS:"vec3 getNormal() {\n\tdNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n\treturn normalize(dNormalMatrix * vertex_normal);\n}\n",normalMapPS:"uniform sampler2D texture_normalMap;\nuniform float material_bumpiness;\nvoid getNormal() {\n\tvec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n\tnormalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness));\n\tdNormalMap = addNormalDetail(normalMap);\n\tdNormalW = dTBN * dNormalMap;\n}\n",normalMapFastPS:"uniform sampler2D texture_normalMap;\nvoid getNormal() {\n\tvec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n\tdNormalMap = addNormalDetail(normalMap);\n\tdNormalW = dTBN * dNormalMap;\n}\n",normalSkinnedVS:"vec3 getNormal() {\n\tdNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n\treturn normalize(dNormalMatrix * vertex_normal);\n}\n",normalVertexPS:"void getNormal() {\n\tdNormalW = normalize(dVertexNormalW);\n}\n",normalXYPS:"vec3 unpackNormal(vec4 nmap) {\n\tvec3 normal;\n\tnormal.xy = nmap.wy * 2.0 - 1.0;\n\tnormal.z = sqrt(1.0 - saturate(dot(normal.xy, normal.xy)));\n\treturn normal;\n}\n",normalXYZPS:"vec3 unpackNormal(vec4 nmap) {\n\treturn nmap.xyz * 2.0 - 1.0;\n}\n",opacityPS:"#ifdef MAPFLOAT\nuniform float material_opacity;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_opacityMap;\n#endif\nvoid getOpacity() {\n\tdAlpha = 1.0;\n\t#ifdef MAPFLOAT\n\tdAlpha *= material_opacity;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdAlpha *= texture2D(texture_opacityMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAlpha *= clamp(vVertexColor.$VC, 0.0, 1.0);\n\t#endif\n}\n",outputAlphaPS:"gl_FragColor.a = dAlpha;\n",outputAlphaOpaquePS:"gl_FragColor.a = 1.0;\n",outputAlphaPremulPS:"gl_FragColor.rgb *= dAlpha;\ngl_FragColor.a = dAlpha;\n",outputCubemapPS:"varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 encodeRGBM(vec4 color) {\n\tcolor.rgb = pow(color.rgb, vec3(0.5));\n\tcolor.rgb *= 1.0 / 8.0;\n\tcolor.a = saturate( max( max( color.r, color.g ), max( color.b, 1.0 / 255.0 ) ) );\n\tcolor.a = ceil(color.a * 255.0) / 255.0;\n\tcolor.rgb /= color.a;\n\treturn color;\n}\nvoid main(void) {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tfloat face = params.x;\n\tvec3 vec;\n\tif (face==0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face==1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face==2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face==3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face==4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\tgl_FragColor = textureCube(source, vec);\n\tif (params.w >= 2.0) gl_FragColor = encodeRGBM(gl_FragColor);\n}\n",outputTex2DPS:"varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",packDepthPS:"\nvec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\n",packDepthMaskPS:"vec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres.x = 0.0;\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\n",parallaxPS:"uniform sampler2D texture_heightMap;\nuniform float material_heightMapFactor;\nvoid getParallax() {\n\tfloat parallaxScale = material_heightMapFactor;\n\tfloat height = texture2D(texture_heightMap, $UV).$CH;\n\theight = height * parallaxScale - parallaxScale*0.5;\n\tvec3 viewDirT = dViewDirW * dTBN;\n\tviewDirT.z += 0.42;\n\tdUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n",particlePS:"varying vec4 texCoordsAlphaLife;\nuniform sampler2D colorMap;\nuniform sampler2D colorParam;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nuniform float softening;\nuniform float colorMult;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\tfloat depth = dot(rgbaDepth, bitShift);\n\treturn depth;\n}\n#endif\nvoid main(void) {\n\tvec4 tex  = texture2DSRGB(colorMap, texCoordsAlphaLife.xy);\n\tvec4 ramp = texture2DSRGB(colorParam, vec2(texCoordsAlphaLife.w, 0.0));\n\tramp.rgb *= colorMult;\n\tramp.a += texCoordsAlphaLife.z;\n\tvec3 rgb = tex.rgb * ramp.rgb;\n\tfloat a  = tex.a * ramp.a;\n",particleVS:"vec3 unpack3NFloats(float src) {\n\tfloat r = fract(src);\n\tfloat g = fract(src * 256.0);\n\tfloat b = fract(src * 65536.0);\n\treturn vec3(r, g, b);\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc) {\n\treturn mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\nvec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {\n\tvec4 a = texture2D(tex,tc);\n\tvec4 b = texture2D(tex,tc + graphSampleSize);\n\tfloat c = fract(tc.x*graphNumSamples);\n\tvec3 unpackedA = unpack3NFloats(a.w);\n\tvec3 unpackedB = unpack3NFloats(b.w);\n\tw = mix(unpackedA, unpackedB, c);\n\treturn mix(a, b, c);\n}\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n\tfloat c = cos(pRotation);\n\tfloat s = sin(pRotation);\n\tmat2 m = mat2(c, -s, s, c);\n\trotMatrix = m;\n\treturn m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY) {\n\t#ifdef SCREEN_SPACE\n\t\tvec3 pos = vec3(-1, 0, 0) * quadXY.x + vec3(0, -1, 0) * quadXY.y;\n\t#else\n\t\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\t#endif\n\treturn pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY) {\n\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\treturn pos;\n}\nvec2 safeNormalize(vec2 v) {\n\tfloat l = length(v);\n\treturn (l > 1e-06) ? v / l : v;\n}\nvoid main(void) {\n\tvec3 meshLocalPos = particle_vertexData.xyz;\n\tfloat id = floor(particle_vertexData.w);\n\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\tfloat uv = id / numParticlesPot;\n\treadInput(uv);\n#ifdef LOCAL_SPACE\n\tinVel = mat3(matrix_model) * inVel;\n#endif\n\tvec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy);\n\tfloat particleLifetime = lifetime;\n\tif (inLife <= 0.0 || inLife > particleLifetime || !inShow) meshLocalPos = vec3(0.0);\n\tvec2 quadXY = meshLocalPos.xy;\n\tfloat nlife = clamp(inLife / particleLifetime, 0.0, 1.0);\n\tvec3 paramDiv;\n\tvec4 params = tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n\tfloat scale = params.y;\n\tfloat scaleDiv = paramDiv.x;\n\tfloat alphaDiv = paramDiv.z;\n\tscale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n#ifndef USE_MESH\n\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#else\n\ttexCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#endif\n\tvec3 particlePos = inPos;\n\tvec3 particlePosMoved = vec3(0.0);\n\tmat2 rotMatrix;\n",particleAnimFrameClampVS:"\tfloat animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);\n",particleAnimFrameLoopVS:"\tfloat animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));\n",particleAnimTexVS:"\tfloat animationIndex;\n\tif (animTexIndexParams.y == 1.0) {\n\t\tanimationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);\n\t} else {\n\t\tanimationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);\n\t}\n\tfloat atlasX = (animationIndex + animFrame) * animTexTilesParams.x;\n\tfloat atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;\n\tatlasX = fract(atlasX);\n\ttexCoordsAlphaLife.xy *= animTexTilesParams.xy;\n\ttexCoordsAlphaLife.xy += vec2(atlasX, atlasY);\n",particleInputFloatPS:"void readInput(float uv) {\n\tvec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));\n\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));\n\tinPos = tex.xyz;\n\tinVel = tex2.xyz;\n\tinAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;\n\tinShow = tex.w >= 0.0;\n\tinLife = tex2.w;\n}\n",particleInputRgba8PS:"\n#define PI2 6.283185307179586\nuniform vec3 inBoundsSize;\nuniform vec3 inBoundsCenter;\nuniform float maxVel;\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nfloat decodeFloatRGBA( vec4 rgba ) {\n  return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );\n}\nvoid readInput(float uv) {\n\tvec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));\n\tvec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));\n\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));\n\tvec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));\n\tinPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));\n\tinPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;\n\tinVel = tex2.xyz;\n\tinVel = (inVel - vec3(0.5)) * maxVel;\n\tinAngle = decodeFloatRG(tex1.ba) * PI2;\n\tinShow = tex2.a > 0.5;\n\tinLife = decodeFloatRGBA(tex3);\n\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\tfloat maxPosLife = lifetime+1.0;\n\tinLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;\n}\n",particleOutputFloatPS:"void writeOutput() {\n\tif (gl_FragCoord.y<1.0) {\n\t\tgl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);\n\t} else {\n\t\tgl_FragColor = vec4(outVel, outLife);\n\t}\n}\n",particleOutputRgba8PS:"uniform vec3 outBoundsMul;\nuniform vec3 outBoundsAdd;\nvec2 encodeFloatRG( float v ) {\n\tvec2 enc = vec2(1.0, 255.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n\treturn enc;\n}\nvec4 encodeFloatRGBA( float v ) {\n\tvec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n\treturn enc;\n}\nvoid writeOutput() {\n\toutPos = outPos * outBoundsMul + outBoundsAdd;\n\toutAngle = fract(outAngle / PI2);\n\toutVel = (outVel / maxVel) + vec3(0.5);\n\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\tfloat maxPosLife = lifetime+1.0;\n\toutLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);\n\tif (gl_FragCoord.y < 1.0) {\n\t\tgl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));\n\t} else if (gl_FragCoord.y < 2.0) {\n\t\tgl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));\n\t} else if (gl_FragCoord.y < 3.0) {\n\t\tgl_FragColor = vec4(outVel, visMode*0.5+0.5);\n\t} else {\n\t\tgl_FragColor = encodeFloatRGBA(outLife);\n\t}\n}\n",particleUpdaterAABBPS:"uniform mat3 spawnBounds;\nuniform vec3 spawnPosInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\tvec3 pos = inBounds - vec3(0.5);\n\tvec3 posAbs = abs(pos);\n\tvec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));\n\tvec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;\n\tpos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);\n\tpos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);\n\tpos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);\n#ifndef LOCAL_SPACE\n\treturn emitterPos + spawnBounds * pos;\n#else\n\treturn spawnBounds * pos;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\tlocalVelocity -= vec3(0, 0, initialVelocity);\n}\n",particleUpdaterEndPS:"\twriteOutput();\n}\n",particleUpdaterInitPS:"varying vec2 vUv0;\nuniform highp sampler2D particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform highp sampler2D internalTex3;\nuniform mat3 emitterMatrix, emitterMatrixInv;\nuniform vec3 emitterScale;\nuniform vec3 emitterPos, frameRandom, localVelocityDivMult, velocityDivMult;\nuniform float delta, rate, rateDiv, lifetime, numParticles, rotSpeedDivMult, radialSpeedDivMult, seed;\nuniform float startAngle, startAngle2;\nuniform float initialVelocity;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\nfloat visMode;\nvec3 outPos;\nvec3 outVel;\nfloat outAngle;\nbool outShow;\nfloat outLife;\n",particleUpdaterNoRespawnPS:"\tif (outLife >= lifetime) {\n\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\tvisMode = -1.0;\n\t}\n",particleUpdaterOnStopPS:"\tvisMode = outLife < 0.0? -1.0: visMode;\n",particleUpdaterRespawnPS:"\tif (outLife >= lifetime) {\n\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\tvisMode = 1.0;\n\t}\n\tvisMode = outLife < 0.0? 1.0: visMode;\n",particleUpdaterSpherePS:"uniform float spawnBoundsSphere;\nuniform float spawnBoundsSphereInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\tfloat rnd4 = fract(rndFactor * 1000.0);\n\tvec3 norm = normalize(inBounds.xyz - vec3(0.5));\n\tfloat r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;\n#ifndef LOCAL_SPACE\n\treturn emitterPos + norm * r * spawnBoundsSphere;\n#else\n\treturn norm * r * spawnBoundsSphere;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\tlocalVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;\n}\n",particleUpdaterStartPS:"float saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 unpack3NFloats(float src) {\n\tfloat r = fract(src);\n\tfloat g = fract(src * 256.0);\n\tfloat b = fract(src * 65536.0);\n\treturn vec3(r, g, b);\n}\nvec3 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {\n\tvec4 a = texture2D(tex, tc);\n\tvec4 b = texture2D(tex, tc + graphSampleSize);\n\tfloat c = fract(tc.x * graphNumSamples);\n\tvec3 unpackedA = unpack3NFloats(a.w);\n\tvec3 unpackedB = unpack3NFloats(b.w);\n\tw = mix(unpackedA, unpackedB, c);\n\treturn mix(a.xyz, b.xyz, c);\n}\n#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)\nvec4 hash41(float p) {\n\tvec4 p4 = fract(vec4(p) * HASHSCALE4);\n\tp4 += dot(p4, p4.wzxy+19.19);\n\treturn fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));\n}\nvoid main(void) {\n\tif (gl_FragCoord.x > numParticles) discard;\n\treadInput(vUv0.x);\n\tvisMode = inShow? 1.0 : -1.0;\n\tvec4 rndFactor = hash41(gl_FragCoord.x + seed);\n\tfloat particleRate = rate + rateDiv * rndFactor.x;\n\toutLife = inLife + delta;\n\tfloat nlife = clamp(outLife / lifetime, 0.0, 1.0);\n\tvec3 localVelocityDiv;\n\tvec3 velocityDiv;\n\tvec3 paramDiv;\n\tvec3 localVelocity = tex1Dlod_lerp(internalTex0, vec2(nlife, 0), localVelocityDiv);\n\tvec3 velocity =\t  tex1Dlod_lerp(internalTex1, vec2(nlife, 0), velocityDiv);\n\tvec3 params =\t\ttex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n\tfloat rotSpeed = params.x;\n\tfloat rotSpeedDiv = paramDiv.y;\n\tvec3 radialParams = tex1Dlod_lerp(internalTex3, vec2(nlife, 0), paramDiv);\n\tfloat radialSpeed = radialParams.x;\n\tfloat radialSpeedDiv = radialParams.y;\n\tbool respawn = inLife <= 0.0 || outLife >= lifetime;\n\tinPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;\n\tinAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;\n#ifndef LOCAL_SPACE\n\tvec3 radialVel = inPos - emitterPos;\n#else\n\tvec3 radialVel = inPos;\n#endif\n\tradialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);\n\tradialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;\n\tlocalVelocity +=\t(localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;\n\tvelocity +=\t\t (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;\n\trotSpeed +=\t\t (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;\n\taddInitialVelocity(localVelocity, rndFactor.xyz);\n#ifndef LOCAL_SPACE\n\toutVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;\n#else\n\toutVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;\n#endif\n\toutPos = inPos + outVel * delta;\n\toutAngle = inAngle + rotSpeed * delta;\n",particle_billboardVS:"\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\tvec3 localPos = billboard(particlePos, quadXY);\n",particle_blendAddPS:"\tdBlendModeFogFactor = 0.0;\n\trgb *= saturate(gammaCorrectInput(max(a, 0.0)));\n\tif ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n",particle_blendMultiplyPS:"\trgb = mix(vec3(1.0), rgb, vec3(a));\n\tif (rgb.r + rgb.g + rgb.b > 2.99) discard;\n",particle_blendNormalPS:"\tif (a < 0.01) discard;\n",particle_cpuVS:"attribute vec4 particle_vertexData;\nattribute vec4 particle_vertexData2;\nattribute vec4 particle_vertexData3;\nattribute float particle_vertexData4;\n#ifndef USE_MESH\n#define VDATA5TYPE vec2\n#else\n#define VDATA5TYPE vec4\n#endif\nattribute VDATA5TYPE particle_vertexData5;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\nuniform float numParticles;\nuniform float lifetime;\nuniform float stretch;\nuniform float seed;\nuniform vec3 wrapBounds, emitterScale, faceTangent, faceBinorm;\nuniform sampler2D texLifeAndSourcePosOUT;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform vec3 emitterPos;\nvarying vec4 texCoordsAlphaLife;\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n\tfloat c = cos(pRotation);\n\tfloat s = sin(pRotation);\n\tmat2 m = mat2(c, -s, s, c);\n\trotMatrix = m;\n\treturn m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY)\n{\n\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\treturn pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY)\n{\n\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\treturn pos;\n}\nvoid main(void)\n{\n\tvec3 particlePos = particle_vertexData.xyz;\n\tvec3 inPos = particlePos;\n\tvec3 vertPos = particle_vertexData3.xyz;\n\tvec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);\n\tfloat id = floor(particle_vertexData4);\n\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n#ifdef LOCAL_SPACE\n\tinVel = mat3(matrix_model) * inVel;\n#endif\n\tvec2 velocityV = normalize((mat3(matrix_view) * inVel).xy);\n\tvec2 quadXY = vertPos.xy;\n#ifndef USE_MESH\n\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n#else\n\ttexCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);\n#endif\n\tmat2 rotMatrix;\n\tfloat inAngle = particle_vertexData2.x;\n\tvec3 particlePosMoved = vec3(0.0);\n\tvec3 meshLocalPos = particle_vertexData3.xyz;\n",particle_cpu_endVS:"\tlocalPos *= particle_vertexData2.y * emitterScale;\n\tlocalPos += particlePos;\n\tgl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n",particle_customFaceVS:"\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\tvec3 localPos = customFace(particlePos, quadXY);\n",particle_endPS:"\trgb = addFog(rgb);\n\trgb = toneMap(rgb);\n\trgb = gammaCorrectOutput(rgb);\n\tgl_FragColor = vec4(rgb, a);\n}\n",particle_endVS:"\tlocalPos *= scale * emitterScale;\n\tlocalPos += particlePos;\n\t#ifdef SCREEN_SPACE\n\tgl_Position = vec4(localPos.x, localPos.y, 0.0, 1.0);\n\t#else\n\tgl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n\t#endif\n",particle_halflambertPS:"\tvec3 negNormal = normal*0.5+0.5;\n\tvec3 posNormal = -normal*0.5+0.5;\n\tnegNormal *= negNormal;\n\tposNormal *= posNormal;\n",particle_initVS:"attribute vec4 particle_vertexData;\n#ifdef USE_MESH\nattribute vec2 particle_uv;\n#endif\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform float numParticles, numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale, emitterPos, faceTangent, faceBinorm;\nuniform float rate, rateDiv, lifetime, deltaRandomnessStatic, scaleDivMult, alphaDivMult, seed, delta;\nuniform sampler2D particleTexOUT, particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nvarying vec4 texCoordsAlphaLife;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\n",particle_lambertPS:"\tvec3 negNormal = max(normal, vec3(0.0));\n\tvec3 posNormal = max(-normal, vec3(0.0));\n",particle_lightingPS:"\tvec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n\t\t\t\t\t\tnegNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n\t\t\t\t\t\tnegNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n\trgb *= light;\n",particle_localShiftVS:"\tparticlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;\n",particle_meshVS:"\tvec3 localPos = meshLocalPos;\n\tlocalPos.xy = rotate(localPos.xy, inAngle, rotMatrix);\n\tlocalPos.yz = rotate(localPos.yz, inAngle, rotMatrix);\n\tbillboard(particlePos, quadXY);\n",particle_normalVS:"\tNormal = normalize(localPos + matrix_viewInverse[2].xyz);\n",particle_normalMapPS:"\tvec3 normalMap = normalize(texture2D(normalMap, texCoordsAlphaLife.xy).xyz * 2.0 - 1.0);\n\tvec3 normal = ParticleMat * normalMap;\n",particle_pointAlongVS:"\tinAngle = atan(velocityV.x, velocityV.y);\n",particle_softPS:"\tfloat depth = getLinearScreenDepth();\n\tfloat particleDepth = vDepth;\n\tfloat depthDiff = saturate(abs(particleDepth - depth) * softening);\n\ta *= depthDiff;\n",particle_softVS:"\tvDepth = getLinearDepth(localPos);\n",particle_stretchVS:"\tvec3 moveDir = inVel * stretch;\n\tvec3 posPrev = particlePos - moveDir;\n\tposPrev += particlePosMoved;\n\tvec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);\n\tfloat interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n\tparticlePos = mix(particlePos, posPrev, interpolation);\n",particle_TBNVS:"\tmat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0, rotMatrix[1][0], rotMatrix[1][1], 0.0, 0.0, 0.0, 1.0);\n\tParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;\n",particle_wrapVS:"\tvec3 origParticlePos = particlePos;\n\tparticlePos -= matrix_model[3].xyz;\n\tparticlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n\tparticlePos += matrix_model[3].xyz;\n\tparticlePosMoved = particlePos - origParticlePos;\n",precisionTestPS:"void main(void) {\n\tgl_FragColor = vec4(2147483648.0);\n}\n",precisionTest2PS:"uniform sampler2D source;\nvec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\nvoid main(void) {\n\tfloat c = texture2D(source, vec2(0.0)).r;\n\tfloat diff = abs(c - 2147483648.0) / 2147483648.0;\n\tgl_FragColor = packFloat(diff);\n}\n",prefilterCubemapPS:"varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nfloat rnd(vec2 uv) {\n\treturn fract(sin(dot(uv, vec2(12.9898, 78.233) * 2.0)) * 43758.5453);\n}\nconst float PI = 3.14159265358979;\nvec3 hemisphereSample_cos(vec2 uv, mat3 vecSpace, vec3 cubeDir, float gloss) {\n\tfloat phi = uv.y * 2.0 * PI;\n\tfloat cosTheta = sqrt(1.0 - uv.x);\n\tfloat sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n\tvec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n\treturn normalize(mix(vecSpace * sampleDir, cubeDir, params.y));\n}\nvec3 hemisphereSample_phong(vec2 uv, mat3 vecSpace, vec3 cubeDir, float specPow) {\n\tfloat phi = uv.y * 2.0 * PI;\n\tfloat cosTheta = pow(1.0 - uv.x, 1.0 / (specPow + 1.0));\n\tfloat sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n\tvec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n\treturn vecSpace * sampleDir;\n}\nmat3 matrixFromVector(vec3 n) {\n\tfloat a = 1.0 / (1.0 + n.z);\n\tfloat b = -n.x * n.y * a;\n\tvec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n\tvec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n\treturn mat3(b1, b2, n);\n}\nvec4 encodeRGBM(vec3 color) {\n\tvec4 encoded;\n\tencoded.rgb = pow(color.rgb, vec3(0.5));\n\tencoded.rgb *= 1.0 / 8.0;\n\tencoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );\n\tencoded.a = ceil(encoded.a * 255.0) / 255.0;\n\tencoded.rgb /= encoded.a;\n\treturn encoded;\n}\nvoid main(void) {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tif (params.w==1.0 || params.w==3.0) {\n\t\tst = 2.0 * floor(gl_FragCoord.xy) / (params.z - 1.0) - 1.0;\n\t}\n\tfloat face = params.x;\n\tvec3 vec;\n\tif (face==0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face==1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face==2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face==3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face==4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\tmat3 vecSpace = matrixFromVector(normalize(vec));\n\tvec3 color = vec3(0.0);\n\tconst int samples = $NUMSAMPLES;\n\tvec3 vect;\n\tfor(int i=0; i<samples; i++) {\n\t\tfloat sini = sin(float(i));\n\t\tfloat cosi = cos(float(i));\n\t\tfloat rand = rnd(vec2(sini, cosi));\n\t\tvect = hemisphereSample_$METHOD(vec2(float(i) / float(samples), rand), vecSpace, vec, params.y);\n\t\tcolor += $textureCube(source, vect).rgb;\n\t}\n\tcolor /= float(samples);\n\tgl_FragColor = params.w < 2.0? vec4(color, 1.0) : encodeRGBM(color);\n}\n",reflDirPS:"void getReflDir() {\n\tdReflDirW = normalize(-reflect(dViewDirW, dNormalW));\n}\n",reflDirAnisoPS:"void getReflDir() {\n\tfloat roughness = sqrt(1.0 - min(dGlossiness, 1.0));\n\tfloat anisotropy = material_anisotropy * roughness;\n\tvec3 anisotropicDirection = anisotropy >= 0.0 ? dTBN[1] : dTBN[0];\n\tvec3 anisotropicTangent = cross(anisotropicDirection, dViewDirW);\n\tvec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);\n\tvec3 bentNormal = normalize(mix(normalize(dNormalW), normalize(anisotropicNormal), anisotropy));\n\tdReflDirW = reflect(-dViewDirW, bentNormal);\n}\n",reflectionCCPS:"#ifdef CLEARCOAT\nuniform float material_clearCoatReflectivity;\nvoid addReflectionCC() {\n\tccReflection += vec4(calcReflection(ccReflDirW, ccGlossiness), material_clearCoatReflectivity);\n}\n#endif\n",reflectionCubePS:"uniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 lookupVec = fixSeams(cubeMapProject(tReflDirW));\n#ifndef RIGHT_HANDED_CUBEMAP\n\tlookupVec.x *= -1.0;\n#endif\n\treturn $textureCubeSAMPLE(texture_cubeMap, lookupVec).rgb;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionDpAtlasPS:"uniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec2 getDpAtlasUv(vec2 uv, float mip) {\n\tvec4 rect;\n\tfloat sx = saturate(mip - 2.0);\n\trect.x = sx * 0.5;\n\tfloat t = mip - rect.x * 6.0;\n\tfloat i = 1.0 - rect.x;\n\trect.y = min(t * 0.5, 0.75) * i + rect.x;\n\tfloat st = saturate(t);\n\trect.z = (1.0 - st * 0.5) * i;\n\trect.w = rect.z * 0.5;\n\tfloat rcRectZ = 1.0 / rect.z;\n\tfloat scaleFactor = 0.00390625 * rcRectZ;\n\tvec2 scale = vec2(scaleFactor, scaleFactor * 2.0);\n\tuv = uv * (vec2(1.0) - scale) + scale * 0.5;\n\tuv = uv * rect.zw + rect.xy;\n\treturn uv;\n}\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 reflDir = normalize(cubeMapProject(tReflDirW));\n\tbool up = reflDir.y > 0.0;\n\tfloat scale = 0.90909090909090909090909090909091;\n\tvec3 reflDirWarp = reflDir.xzx * vec3(-0.25, 0.5, 0.25);\n\tfloat reflDirVer = abs(reflDir.y) + 1.0;\n\treflDirWarp /= reflDirVer;\n\treflDirWarp *= scale;\n\treflDirWarp = vec3(0.75, 0.5, 0.25) - reflDirWarp;\n\tvec2 tc = up? reflDirWarp.xy : reflDirWarp.zy;\n\tfloat bias = saturate(1.0 - tGlossiness) * 5.0;\n\tfloat mip = floor(bias);\n\tvec3 tex1 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n\tmip = min(mip + 1.0, 5.0);\n\tvec3 tex2 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n\ttex1 = mix(tex1, tex2, fract(bias));\n\ttex1 = processEnvironment(tex1);\n\treturn tex1;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionPrefilteredCubePS:"uniform samplerCube texture_prefilteredCubeMap128;\nuniform samplerCube texture_prefilteredCubeMap64;\nuniform samplerCube texture_prefilteredCubeMap32;\nuniform samplerCube texture_prefilteredCubeMap16;\nuniform samplerCube texture_prefilteredCubeMap8;\n#ifndef PMREM4\n#define PMREM4\nuniform samplerCube texture_prefilteredCubeMap4;\n#endif\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 refl = cubeMapProject(tReflDirW);\n#ifndef RIGHT_HANDED_CUBEMAP\n\trefl.x *= -1.0;\n#endif\n\tvec3 seam = calcSeam(refl);\n\tvec4 c0 = textureCube(texture_prefilteredCubeMap128, applySeam(refl, seam, 1.0 / 128.0));\n\tvec4 c1 = textureCube(texture_prefilteredCubeMap64, applySeam(refl, seam, 2.0 / 128.0));\n\tvec4 c2 = textureCube(texture_prefilteredCubeMap32, applySeam(refl, seam, 4.0 / 128.0));\n\tvec4 c3 = textureCube(texture_prefilteredCubeMap16, applySeam(refl, seam, 8.0 / 128.0));\n\tvec4 c4 = textureCube(texture_prefilteredCubeMap8, applySeam(refl, seam, 16.0 / 128.0));\n\tvec4 c5 = textureCube(texture_prefilteredCubeMap4, applySeam(refl, seam, 32.0 / 128.0));\n\tfloat bias = saturate(1.0 - tGlossiness) * 5.0;\n\tvec4 cubes0;\n\tvec4 cubes1;\n\tif (bias < 1.0) {\n\t\tcubes0 = c0;\n\t\tcubes1 = c1;\n\t} else if (bias < 2.0) {\n\t\tcubes0 = c1;\n\t\tcubes1 = c2;\n\t} else if (bias < 3.0) {\n\t\tcubes0 = c2;\n\t\tcubes1 = c3;\n\t} else if (bias < 4.0) {\n\t\tcubes0 = c3;\n\t\tcubes1 = c4;\n\t} else {\n\t\tcubes0 = c4;\n\t\tcubes1 = c5;\n\t}\n\tvec4 cubeFinal = mix(cubes0, cubes1, fract(bias));\n\treturn processEnvironment($DECODE(cubeFinal).rgb);\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionPrefilteredCubeLodPS:"#ifndef PMREM4\n#define PMREM4\n#ifndef GL2\n#extension GL_EXT_shader_texture_lod : enable\n#endif\nuniform samplerCube texture_prefilteredCubeMap128;\n#endif\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tfloat bias = saturate(1.0 - tGlossiness) * 5.0;\n\tvec3 fixedReflDir = fixSeams(cubeMapProject(tReflDirW), bias);\n#ifndef RIGHT_HANDED_CUBEMAP\n\tfixedReflDir.x *= -1.0;\n#endif\n\tvec3 refl = processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, bias) ).rgb);\n\treturn refl;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionSpherePS:"#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 reflDirV = (mat3(matrix_view) * tReflDirW).xyz;\n\tfloat m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );\n\tvec2 sphereMapUv = reflDirV.xy / m + 0.5;\n\treturn $texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionSphereLowPS:"uniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 reflDirV = vNormalV;\n\tvec2 sphereMapUv = reflDirV.xy * 0.5 + 0.5;\n\treturn $texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",refractionPS:"uniform float material_refraction, material_refractionIndex;\nvec3 refract2(vec3 viewVec, vec3 Normal, float IOR) {\n\tfloat vn = dot(viewVec, Normal);\n\tfloat k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n\tvec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * Normal;\n\treturn refrVec;\n}\nvoid addRefraction() {\n\tvec3 tmp = dReflDirW;\n\tvec4 tmp2 = dReflection;\n\tdReflection = vec4(0.0);\n\tdReflDirW = refract2(-dViewDirW, dNormalW, material_refractionIndex);\n\taddReflection();\n\tdDiffuseLight = mix(dDiffuseLight, dReflection.rgb * dAlbedo, material_refraction);\n\tdReflDirW = tmp;\n\tdReflection = tmp2;\n}\n",reprojectPS:"\nvarying vec2 vUv0;\nuniform sampler2D sourceTex;\nuniform samplerCube sourceCube;\nuniform vec4 params;\nfloat targetFace() { return params.x; }\nfloat specularPower() { return params.y; }\nfloat sourceCubeSeamScale() { return params.z; }\nfloat targetCubeSeamScale() { return params.w; }\nfloat PI = 3.141592653589793;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 decodeLinear(vec4 source) {\n\treturn source.rgb;\n}\nvec4 encodeLinear(vec3 source) {\n\treturn vec4(source, 1.0);\n}\nvec3 decodeGamma(vec4 source) {\n\treturn pow(source.xyz, vec3(2.2));\n}\nvec4 encodeGamma(vec3 source) {\n\treturn vec4(pow(source + 0.0000001, vec3(1.0 / 2.2)), 1.0);\n}\nvec3 decodeRGBM(vec4 rgbm) {\n\tvec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n\treturn color * color;\n}\nvec4 encodeRGBM(vec3 source) {\n\tvec4 result;\n\tresult.rgb = pow(source.rgb, vec3(0.5));\n\tresult.rgb *= 1.0 / 8.0;\n\tresult.a = saturate( max( max( result.r, result.g ), max( result.b, 1.0 / 255.0 ) ) );\n\tresult.a = ceil(result.a * 255.0) / 255.0;\n\tresult.rgb /= result.a;\n\treturn result;\n}\nvec3 decodeRGBE(vec4 source) {\n\tif (source.a == 0.0) {\n\t\treturn vec3(0.0, 0.0, 0.0);\n\t} else {\n\t\treturn source.xyz * pow(2.0, source.w * 255.0 - 128.0);\n\t}\n}\nvec4 encodeRGBE(vec3 source) {\n\tfloat maxVal = max(source.x, max(source.y, source.z));\n\tif (maxVal < 1e-32) {\n\t\treturn vec4(0, 0, 0, 0);\n\t} else {\n\t\tfloat e = ceil(log2(maxVal));\n\t\treturn vec4(source / pow(2.0, e), (e + 128.0) / 255.0);\n\t}\n}\nvec3 modifySeams(vec3 dir, float amount) {\n\tif (amount != 1.0) {\n\t\tvec3 adir = abs(dir);\n\t\tfloat M = max(max(adir.x, adir.y), adir.z);\n\t\tif (adir.x == M) {\n\t\t\tdir.y *= amount;\n\t\t\tdir.z *= amount;\n\t\t}\n\t\telse if (adir.y == M) {\n\t\t\tdir.x *= amount;\n\t\t\tdir.z *= amount;\n\t\t} else {\n\t\t\tdir.x *= amount;\n\t\t\tdir.y *= amount;\n\t\t}\n\t}\n\treturn dir;\n}\nvec2 toSpherical(vec3 dir) {\n\treturn vec2(atan(dir.z, dir.x), asin(dir.y));\n}\nvec3 fromSpherical(vec2 uv) {\n\treturn vec3(cos(uv.y) * cos(uv.x),\n\t\t\t\tsin(uv.y),\n\t\t\t\tcos(uv.y) * sin(uv.x));\n}\nvec4 sampleEquirect(vec2 sph) {\n\treturn texture2D(sourceTex, sph / vec2(PI * 2.0, PI) + 0.5);\n}\nvec4 sampleEquirect(vec3 dir) {\n\treturn sampleEquirect(toSpherical(dir));\n}\nvec4 sampleCubemap(vec3 dir) {\n\treturn textureCube(sourceCube, modifySeams(dir, sourceCubeSeamScale()));\n}\nvec4 sampleCubemap(vec2 sph) {\n\treturn sampleCubemap(fromSpherical(sph));\n}\nvec3 getDirectionEquirect() {\n\treturn fromSpherical((vUv0 * 2.0 - 1.0) * vec2(PI, PI * 0.5));\n}\nfloat signNotZero(float k){\n\treturn(k >= 0.0) ? 1.0 : -1.0;\n}\nvec2 signNotZero(vec2 v) {\n\treturn vec2(signNotZero(v.x), signNotZero(v.y));\n}\nvec3 octDecode(vec2 o) {\n\tvec3 v = vec3(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);\n\tif (v.y < 0.0) {\n\t\tv.xz = (1.0 - abs(v.zx)) * signNotZero(v.xz);\n\t}\n\treturn normalize(v);\n}\nvec3 getDirectionOctahedral() {\n\treturn octDecode(vUv0 * 2.0 - 1.0);\n}\nvec2 octEncode(in vec3 v) {\n\tfloat l1norm = abs(v.x) + abs(v.y) + abs(v.z);\n\tvec2 result = v.xz * (1.0 / l1norm);\n\tif (v.y < 0.0) {\n\t\tresult = (1.0 - abs(result.yx)) * signNotZero(result.xy);\n\t}\n\treturn result;\n}\nvec4 sampleOctahedral(vec3 dir) {\n\treturn texture2D(sourceTex, octEncode(dir) * 0.5 + 0.5);\n}\nvec4 sampleOctahedral(vec2 sph) {\n\treturn sampleOctahedral(fromSpherical(sph));\n}\nvec3 getDirectionCubemap() {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tfloat face = targetFace();\n\tvec3 vec;\n\tif (face == 0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face == 1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face == 2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face == 3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face == 4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\treturn normalize(modifySeams(vec, 1.0 / targetCubeSeamScale()));\n}\nmat3 matrixFromVector(vec3 n) {\n\tfloat a = 1.0 / (1.0 + n.z);\n\tfloat b = -n.x * n.y * a;\n\tvec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n\tvec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n\treturn mat3(b1, b2, n);\n}\nmat3 matrixFromVectorSlow(vec3 n) {\n\tvec3 a = normalize(cross(n, vec3(0, 1, 0)));\n\tvec3 b = cross(n, a);\n\treturn mat3(a, b, n);\n}\nfloat rnd(int i) {\n\tfloat sini = sin(float(i));\n\tfloat cosi = cos(float(i));\n\treturn fract(sin(dot(vec2(sini, cosi), vec2(12.9898, 78.233) * 2.0)) * 43758.5453);\n}\nvec3 hemisphereSamplePhong(vec2 uv, float specPow) {\n\tfloat phi = uv.y * 2.0 * PI;\n\tfloat cosTheta = pow(1.0 - uv.x, 1.0 / (specPow + 1.0));\n\tfloat sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n\treturn vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n}\nvec4 reproject() {\n\tif (NUM_SAMPLES <= 1) {\n\t\treturn ENCODE_FUNC(DECODE_FUNC(SOURCE_FUNC(TARGET_FUNC())));\n\t} else {\n\t\tvec2 sph = toSpherical(TARGET_FUNC());\n\t\tvec2 sphu = dFdx(sph);\n\t\tvec2 sphv = dFdy(sph);\n\t\tvec3 result = vec3(0.0);\n\t\tfor (float u = 0.0; u < NUM_SAMPLES_SQRT; ++u) {\n\t\t\tfor (float v = 0.0; v < NUM_SAMPLES_SQRT; ++v) {\n\t\t\t\tresult += DECODE_FUNC(SOURCE_FUNC(sph +\n\t\t\t\t\t\t\t\t\t\t\t\t  sphu * (u / NUM_SAMPLES_SQRT - 0.5) +\n\t\t\t\t\t\t\t\t\t\t\t\t  sphv * (v / NUM_SAMPLES_SQRT - 0.5)));\n\t\t\t}\n\t\t}\n\t\treturn ENCODE_FUNC(result / (NUM_SAMPLES_SQRT * NUM_SAMPLES_SQRT));\n\t}\n}\nvec4 prefilter() {\n\tvec3 vec = TARGET_FUNC();\n\tmat3 vecSpace = matrixFromVectorSlow(vec);\n\tvec3 result = vec3(0.0);\n\tfor (int i=0; i<NUM_SAMPLES; ++i) {\n\t\tvec2 uv = vec2(float(i) / float(NUM_SAMPLES), rnd(i));\n\t\tvec3 dir = vecSpace * hemisphereSamplePhong(uv, specularPower());\n\t\tresult += DECODE_FUNC(SOURCE_FUNC(dir));\n\t}\n\treturn ENCODE_FUNC(result / float(NUM_SAMPLES));\n}\nvoid main(void) {\n\tgl_FragColor = PROCESS_FUNC();\n}\n",rgbmPS:"vec3 decodeRGBM(vec4 rgbm) {\n\tvec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n\treturn color * color;\n}\nvec3 texture2DRGBM(sampler2D tex, vec2 uv) {\n\treturn decodeRGBM(texture2D(tex, uv));\n}\nvec3 textureCubeRGBM(samplerCube tex, vec3 uvw) {\n\treturn decodeRGBM(textureCube(tex, uvw));\n}\n",screenDepthPS:"uniform sampler2D uDepthMap;\n#ifndef SCREENSIZE\n#define SCREENSIZE\nuniform vec4 uScreenSize;\n#endif\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\n#ifdef GL2\nfloat linearizeDepth(float z) {\n\tz = z * 2.0 - 1.0;\n\treturn 1.0 / (camera_params.z * z + camera_params.w);\n}\n#else\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\treturn dot(rgbaDepth, bitShift);\n}\n#endif\n#endif\nfloat getLinearScreenDepth(vec2 uv) {\n\t#ifdef GL2\n\treturn linearizeDepth(texture2D(uDepthMap, uv).r) * camera_params.y;\n\t#else\n\treturn unpackFloat(texture2D(uDepthMap, uv)) * camera_params.y;\n\t#endif\n}\n#ifndef VERTEXSHADER\nfloat getLinearScreenDepth() {\n\tvec2 uv = gl_FragCoord.xy * uScreenSize.zw;\n\treturn getLinearScreenDepth(uv);\n}\n#endif\nfloat getLinearDepth(vec3 pos) {\n\treturn -(matrix_view * vec4(pos, 1.0)).z;\n}\n",shadowCascadesPS:"const float maxCascades = 4.0;\nmat4 cascadeShadowMat;\nvoid getShadowCascadeMatrix(mat4 shadowMatrixPalette[4], float shadowCascadeDistances[4], float shadowCascadeCount) {\n\tfloat depth = 1.0 / gl_FragCoord.w;\n\tfloat cascadeIndex = 0.0;\n\tfor (float i = 0.0; i < maxCascades; i++) {\n\t\tif (depth < shadowCascadeDistances[int(i)]) {\n\t\t\tcascadeIndex = i;\n\t\t\tbreak;\n\t\t}\n\t}\n\tcascadeIndex = min(cascadeIndex, shadowCascadeCount - 1.0);\n\t#ifdef GL2\n\t\tcascadeShadowMat = shadowMatrixPalette[int(cascadeIndex)];\n\t#else\n\t\tif (cascadeIndex == 0.0) {\n\t\t\tcascadeShadowMat = shadowMatrixPalette[0];\n\t\t}\n\t\telse if (cascadeIndex == 1.0) {\n\t\t\tcascadeShadowMat = shadowMatrixPalette[1];\n\t\t}\n\t\telse if (cascadeIndex == 2.0) {\n\t\t\tcascadeShadowMat = shadowMatrixPalette[2];\n\t\t}\n\t\telse {\n\t\t\tcascadeShadowMat = shadowMatrixPalette[3];\n\t\t}\n\t#endif\n}\nvoid fadeShadow(float shadowCascadeDistances[4]) {\n\tfloat depth = 1.0 / gl_FragCoord.w;\n\tif (depth > shadowCascadeDistances[int(maxCascades - 1.0)]) {\n\t\tdShadowCoord.z = -9999999.0;\n\t}\n}\n",shadowCommonPS:"void normalOffsetPointShadow(vec4 shadowParams) {\n\tfloat distScale = length(dLightDirW);\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\tvec3 dir = wPos - dLightPosW;\n\tdLightDirW = dir;\n}\n",shadowCoordPS:"void _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n\tdShadowCoord = (shadowMatrix * vec4(wPos, 1.0)).xyz;\n\tdShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n\t#ifdef SHADOWBIAS\n\tdShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t#endif\n}\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tprojPos.xy /= projPos.w;\n\tdShadowCoord.xy = projPos.xy;\n\tdShadowCoord.z = length(dLightDirW) * shadowParams.w;\n\t#ifdef SHADOWBIAS\n\tdShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t#endif\n}\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams) {\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n\tfloat distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW));\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0);\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n",shadowCoordPerspZbufferPS:"void _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tprojPos.xyz /= projPos.w;\n\tdShadowCoord = projPos.xyz;\n}\nvoid getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n\tfloat distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW));\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\t_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams) {\n\t_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, vPositionW);\n}\n",shadowEVSMPS:"float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tvec3 moments = texture2D(tex, texCoords).xyz;\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowEVSMnPS:"float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tfloat pixelSize = 1.0 / resolution;\n\ttexCoords -= vec2(pixelSize);\n\tvec3 s00 = texture2D(tex, texCoords).xyz;\n\tvec3 s10 = texture2D(tex, texCoords + vec2(pixelSize, 0)).xyz;\n\tvec3 s01 = texture2D(tex, texCoords + vec2(0, pixelSize)).xyz;\n\tvec3 s11 = texture2D(tex, texCoords + vec2(pixelSize)).xyz;\n\tvec2 fr = fract(texCoords * resolution);\n\tvec3 h0 = mix(s00, s10, fr.x);\n\tvec3 h1 = mix(s01, s11, fr.x);\n\tvec3 moments = mix(h0, h1, fr.y);\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowStandardPS:"vec3 lessThan2(vec3 a, vec3 b) {\n\treturn clamp((b - a)*1000.0, 0.0, 1.0);\n}\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\treturn dot(rgbaDepth, bitShift);\n}\n#endif\n#ifdef GL2\nfloat _getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n\tfloat z = dShadowCoord.z;\n\tvec2 uv = dShadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat sum = 0.0;\n\tfloat uw0 = (3.0 - 2.0 * s);\n\tfloat uw1 = (1.0 + 2.0 * s);\n\tfloat u0 = (2.0 - s) / uw0 - 1.0;\n\tfloat u1 = s / uw1 + 1.0;\n\tfloat vw0 = (3.0 - 2.0 * t);\n\tfloat vw1 = (1.0 + 2.0 * t);\n\tfloat v0 = (2.0 - t) / vw0 - 1.0;\n\tfloat v1 = t / vw1 + 1.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n\tsum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n\tsum *= 1.0f / 16.0;\n\treturn sum;\n}\nfloat getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF3x3(sampler2DShadow shadowMap, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n}\n#else\nfloat _xgetShadowPCF3x3(mat3 depthKernel, sampler2D shadowMap, vec3 shadowParams) {\n\tmat3 shadowKernel;\n\tvec3 shadowCoord = dShadowCoord;\n\tvec3 shadowZ = vec3(shadowCoord.z);\n\tshadowKernel[0] = vec3(greaterThan(depthKernel[0], shadowZ));\n\tshadowKernel[1] = vec3(greaterThan(depthKernel[1], shadowZ));\n\tshadowKernel[2] = vec3(greaterThan(depthKernel[2], shadowZ));\n\tvec2 fractionalCoord = fract( shadowCoord.xy * shadowParams.x );\n\tshadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n\tshadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\tvec4 shadowValues;\n\tshadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n\tshadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n\tshadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n\tshadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\treturn dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\nfloat _getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n\tvec3 shadowCoord = dShadowCoord;\n\tfloat xoffset = 1.0 / shadowParams.x;\n\tfloat dx0 = -xoffset;\n\tfloat dx1 = xoffset;\n\tmat3 depthKernel;\n\tdepthKernel[0][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx0)));\n\tdepthKernel[0][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)));\n\tdepthKernel[0][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx1)));\n\tdepthKernel[1][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx0)));\n\tdepthKernel[1][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy));\n\tdepthKernel[1][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx1)));\n\tdepthKernel[2][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx0)));\n\tdepthKernel[2][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)));\n\tdepthKernel[2][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx1)));\n\treturn _xgetShadowPCF3x3(depthKernel, shadowMap, shadowParams);\n}\nfloat getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF3x3(sampler2D shadowMap, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n}\n#endif\nfloat _getShadowPoint(samplerCube shadowMap, vec4 shadowParams, vec3 dir) {\n\tvec3 tc = normalize(dir);\n\tvec3 tcAbs = abs(tc);\n\tvec4 dirX = vec4(1,0,0, tc.x);\n\tvec4 dirY = vec4(0,1,0, tc.y);\n\tfloat majorAxisLength = tc.z;\n\tif ((tcAbs.x > tcAbs.y) && (tcAbs.x > tcAbs.z)) {\n\t\tdirX = vec4(0,0,1, tc.z);\n\t\tdirY = vec4(0,1,0, tc.y);\n\t\tmajorAxisLength = tc.x;\n\t} else if ((tcAbs.y > tcAbs.x) && (tcAbs.y > tcAbs.z)) {\n\t\tdirX = vec4(1,0,0, tc.x);\n\t\tdirY = vec4(0,0,1, tc.z);\n\t\tmajorAxisLength = tc.y;\n\t}\n\tfloat shadowParamsInFaceSpace = ((1.0/shadowParams.x) * 2.0) * abs(majorAxisLength);\n\tvec3 xoffset = (dirX.xyz * shadowParamsInFaceSpace);\n\tvec3 yoffset = (dirY.xyz * shadowParamsInFaceSpace);\n\tvec3 dx0 = -xoffset;\n\tvec3 dy0 = -yoffset;\n\tvec3 dx1 = xoffset;\n\tvec3 dy1 = yoffset;\n\tmat3 shadowKernel;\n\tmat3 depthKernel;\n\tdepthKernel[0][0] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy0));\n\tdepthKernel[0][1] = unpackFloat(textureCube(shadowMap, tc + dx0));\n\tdepthKernel[0][2] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy1));\n\tdepthKernel[1][0] = unpackFloat(textureCube(shadowMap, tc + dy0));\n\tdepthKernel[1][1] = unpackFloat(textureCube(shadowMap, tc));\n\tdepthKernel[1][2] = unpackFloat(textureCube(shadowMap, tc + dy1));\n\tdepthKernel[2][0] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy0));\n\tdepthKernel[2][1] = unpackFloat(textureCube(shadowMap, tc + dx1));\n\tdepthKernel[2][2] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy1));\n\tvec3 shadowZ = vec3(length(dir) * shadowParams.w + shadowParams.z);\n\tshadowKernel[0] = vec3(lessThan2(depthKernel[0], shadowZ));\n\tshadowKernel[1] = vec3(lessThan2(depthKernel[1], shadowZ));\n\tshadowKernel[2] = vec3(lessThan2(depthKernel[2], shadowZ));\n\tvec2 uv = (vec2(dirX.w, dirY.w) / abs(majorAxisLength)) * 0.5;\n\tvec2 fractionalCoord = fract( uv * shadowParams.x );\n\tshadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n\tshadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\tvec4 shadowValues;\n\tshadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n\tshadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n\tshadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n\tshadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\treturn 1.0 - dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\nfloat getShadowPointPCF3x3(samplerCube shadowMap, vec4 shadowParams) {\n\treturn _getShadowPoint(shadowMap, shadowParams, dLightDirW);\n}\n",shadowStandardGL2PS:"float _getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n\tfloat z = dShadowCoord.z;\n\tvec2 uv = dShadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat uw0 = (4.0 - 3.0 * s);\n\tfloat uw1 = 7.0;\n\tfloat uw2 = (1.0 + 3.0 * s);\n\tfloat u0 = (3.0 - 2.0 * s) / uw0 - 2.0;\n\tfloat u1 = (3.0 + s) / uw1;\n\tfloat u2 = s / uw2 + 2.0;\n\tfloat vw0 = (4.0 - 3.0 * t);\n\tfloat vw1 = 7.0;\n\tfloat vw2 = (1.0 + 3.0 * t);\n\tfloat v0 = (3.0 - 2.0 * t) / vw0 - 2.0;\n\tfloat v1 = (3.0 + t) / vw1;\n\tfloat v2 = t / vw2 + 2.0;\n\tfloat sum = 0.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tu2 = u2 * shadowMapSizeInv + base_uv.x;\n\tv2 = v2 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n\tsum += uw2 * vw0 * texture(shadowMap, vec3(u2, v0, z));\n\tsum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n\tsum += uw2 * vw1 * texture(shadowMap, vec3(u2, v1, z));\n\tsum += uw0 * vw2 * texture(shadowMap, vec3(u0, v2, z));\n\tsum += uw1 * vw2 * texture(shadowMap, vec3(u1, v2, z));\n\tsum += uw2 * vw2 * texture(shadowMap, vec3(u2, v2, z));\n\tsum *= 1.0f / 144.0;\n\tsum = gammaCorrectInput(sum);\n\tsum = saturate(sum);\n\treturn sum;\n}\nfloat getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n\treturn _getShadowPCF5x5(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF5x5(sampler2DShadow shadowMap, vec4 shadowParams) {\n\treturn _getShadowPCF5x5(shadowMap, shadowParams.xyz);\n}\n",shadowVSM8PS:"float calculateVSM8(vec3 moments, float Z, float vsmBias) {\n\tfloat VSMBias = vsmBias;\n\tfloat depthScale = VSMBias * Z;\n\tfloat minVariance1 = depthScale * depthScale;\n\treturn chebyshevUpperBound(moments.xy, Z, minVariance1, 0.1);\n}\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nfloat VSM8(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tvec4 c = texture2D(tex, texCoords);\n\tvec3 moments = vec3(decodeFloatRG(c.xy), decodeFloatRG(c.zw), 0.0);\n\treturn calculateVSM8(moments, Z, vsmBias);\n}\nfloat getShadowVSM8(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\treturn VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, 0.0);\n}\nfloat getShadowSpotVSM8(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\treturn VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, 0.0);\n}\n",shadowVSM_commonPS:"float linstep(float a, float b, float v) {\n\treturn saturate((v - a) / (b - a));\n}\nfloat reduceLightBleeding(float pMax, float amount) {\n   return linstep(amount, 1.0, pMax);\n}\nfloat chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {\n\tfloat variance = moments.y - (moments.x * moments.x);\n\tvariance = max(variance, minVariance);\n\tfloat d = mean - moments.x;\n\tfloat pMax = variance / (variance + (d * d));\n\tpMax = reduceLightBleeding(pMax, lightBleedingReduction);\n\treturn (mean <= moments.x ? 1.0 : pMax);\n}\nfloat calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {\n\tZ = 2.0 * Z - 1.0;\n\tfloat warpedDepth = exp(exponent * Z);\n\tmoments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);\n\tfloat VSMBias = vsmBias;\n\tfloat depthScale = VSMBias * exponent * warpedDepth;\n\tfloat minVariance1 = depthScale * depthScale;\n\treturn chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);\n}\n",skinBatchConstVS:"attribute float vertex_boneIndices;\nuniform vec4 matrix_pose[BONE_LIMIT * 3];\nmat4 getBoneMatrix(const in float i) {\n\tvec4 v1 = matrix_pose[int(3.0 * i)];\n\tvec4 v2 = matrix_pose[int(3.0 * i + 1.0)];\n\tvec4 v3 = matrix_pose[int(3.0 * i + 2.0)];\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, 1\n\t);\n}\n",skinBatchTexVS:"attribute float vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\nmat4 getBoneMatrix(const in float i) {\n\tfloat j = i * 3.0;\n\tfloat dx = texture_poseMapSize.z;\n\tfloat dy = texture_poseMapSize.w;\n\tfloat y = floor(j * dx);\n\tfloat x = j - (y * texture_poseMapSize.x);\n\ty = dy * (y + 0.5);\n\tvec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\tvec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\tvec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, 1\n\t);\n}\n",skinConstVS:"attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform vec4 matrix_pose[BONE_LIMIT * 3];\nvoid getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {\n\tv1 = matrix_pose[int(3.0 * i)];\n\tv2 = matrix_pose[int(3.0 * i + 1.0)];\n\tv3 = matrix_pose[int(3.0 * i + 2.0)];\n}\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n\tvec4 a1, a2, a3;\n\tgetBoneMatrix(indices.x, a1, a2, a3);\n\tvec4 b1, b2, b3;\n\tgetBoneMatrix(indices.y, b1, b2, b3);\n\tvec4 c1, c2, c3;\n\tgetBoneMatrix(indices.z, c1, c2, c3);\n\tvec4 d1, d2, d3;\n\tgetBoneMatrix(indices.w, d1, d2, d3);\n\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\tfloat one = dot(weights, vec4(1.0));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, one\n\t);\n}\n",skinTexVS:"attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\nvoid getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {\n\tfloat j = i * 3.0;\n\tfloat dx = texture_poseMapSize.z;\n\tfloat dy = texture_poseMapSize.w;\n\tfloat y = floor(j * dx);\n\tfloat x = j - (y * texture_poseMapSize.x);\n\ty = dy * (y + 0.5);\n\tv1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\tv2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\tv3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n}\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n\tvec4 a1, a2, a3;\n\tgetBoneMatrix(indices.x, a1, a2, a3);\n\tvec4 b1, b2, b3;\n\tgetBoneMatrix(indices.y, b1, b2, b3);\n\tvec4 c1, c2, c3;\n\tgetBoneMatrix(indices.z, c1, c2, c3);\n\tvec4 d1, d2, d3;\n\tgetBoneMatrix(indices.w, d1, d2, d3);\n\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\tfloat one = dot(weights, vec4(1.0));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, one\n\t);\n}\n",skyboxPS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvoid main(void) {\n\tgl_FragColor = textureCube(texture_cubeMap, fixSeams(vViewDir));\n}\n",skyboxVS:"attribute vec3 aPosition;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat4 matrix_projectionSkybox;\nvarying vec3 vViewDir;\nvoid main(void) {\n\tmat4 view = matrix_view;\n\tview[3][0] = view[3][1] = view[3][2] = 0.0;\n\tgl_Position = matrix_projectionSkybox * view * vec4(aPosition, 1.0);\n\tgl_Position.z = gl_Position.w - 0.00001;\n\tvViewDir = aPosition;\n}\n",skyboxHDRPS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\n#ifdef CUBEMAP_ROTATION\nuniform mat3 cubeMapRotationMatrix;\n#endif\nvoid main(void) {\n#ifdef CUBEMAP_ROTATION\n\tvec3 dir=vViewDir * cubeMapRotationMatrix;\n#else\n\tvec3 dir=vViewDir;\n#endif\n#ifndef RIGHT_HANDED_CUBEMAP\n\tdir.x *= -1.0;\n#endif\n\tvec3 color = processEnvironment($textureCubeSAMPLE(texture_cubeMap, fixSeamsStatic(dir, $FIXCONST)).rgb);\n\tcolor = toneMap(color);\n\tcolor = gammaCorrectOutput(color);\n\tgl_FragColor = vec4(color, 1.0);\n}\n",skyboxPrefilteredCubePS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvec3 fixSeamsStretch(vec3 vec, float mipmapIndex, float cubemapSize) {\n\tfloat scale = 1.0 - exp2(mipmapIndex) / cubemapSize;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\nvoid main(void) {\n\tvec3 color = textureCubeRGBM(texture_cubeMap, fixSeamsStretch(vViewDir, 0.0, 128.0));\n\tcolor = toneMap(color);\n\tcolor = gammaCorrectOutput(color);\n\tgl_FragColor = vec4(color, 1.0);\n}\n",specularPS:"#ifdef MAPCOLOR\nuniform vec3 material_specular;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_specularMap;\n#endif\nvoid getSpecularity() {\n\tdSpecularity = vec3(1.0);\n\t#ifdef MAPCOLOR\n\tdSpecularity *= material_specular;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdSpecularity *= texture2D(texture_specularMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdSpecularity *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",specularAaNonePS:"float antiAliasGlossiness(float power) {\n\treturn power;\n}\n",specularAaToksvigPS:"float antiAliasGlossiness(float power) {\n\tfloat rlen = 1.0 / saturate(length(dNormalMap));\n\tfloat toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n\treturn power * mix(1.0, toksvig, material_bumpiness);\n}\n",specularAaToksvigFastPS:"float antiAliasGlossiness(float power) {\n\tfloat rlen = 1.0 / saturate(length(dNormalMap));\n\tfloat toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n\treturn power * toksvig;\n}\n",spotPS:"float getSpotEffect(vec3 lightSpotDirW, float lightInnerConeAngle, float lightOuterConeAngle) {\n\tfloat cosAngle = dot(dLightDirNormW, lightSpotDirW);\n\treturn smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n",startPS:"void main(void) {\n\tdDiffuseLight = vec3(0);\n\tdSpecularLight = vec3(0);\n\tdReflection = vec4(0);\n\tdSpecularity = vec3(0);\n\t#ifdef CLEARCOAT\n\tccSpecularLight = vec3(0);\n\tccReflection = vec4(0);\n\t#endif\n",startVS:"void main(void) {\n\tgl_Position = getPosition();\n",startNineSlicedPS:"\tnineSlicedUv = vUv0;\n",startNineSlicedTiledPS:"\tvec2 tileMask = step(vMask, vec2(0.99999));\n\tvec2 tileSize = 0.5 * (innerOffset.xy + innerOffset.zw);\n\tvec2 tileScale = vec2(1.0) / (vec2(1.0) - tileSize);\n\tvec2 clampedUv = mix(innerOffset.xy * 0.5, vec2(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));\n\tclampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\n\tnineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);\n",storeEVSMPS:"float exponent = VSM_EXPONENT;\ndepth = 2.0 * depth - 1.0;\ndepth =  exp(exponent * depth);\ngl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);\n",tangentBinormalVS:"vec3 getTangent() {\n\treturn normalize(dNormalMatrix * vertex_tangent.xyz);\n}\nvec3 getBinormal() {\n\treturn cross(vNormalW, vTangentW) * vertex_tangent.w;\n}\nvec3 getObjectSpaceUp() {\n\treturn normalize(dNormalMatrix * vec3(0, 1, 0));\n}\n",TBNPS:"void getTBN() {\n\tdTBN = mat3(normalize(dTangentW), normalize(dBinormalW), normalize(dVertexNormalW));\n}\n",TBNderivativePS:"\nvoid getTBN() {\n\tvec2 uv = $UV;\n\tvec3 dp1 = dFdx( vPositionW );\n\tvec3 dp2 = dFdy( vPositionW );\n\tvec2 duv1 = dFdx( uv );\n\tvec2 duv2 = dFdy( uv );\n\tvec3 dp2perp = cross( dp2, dVertexNormalW );\n\tvec3 dp1perp = cross( dVertexNormalW, dp1 );\n\tvec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n\tvec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\tfloat invmax = 1.0 / sqrt( max( dot(T,T), dot(B,B) ) );\n\tdTBN = mat3( T * invmax, B * invmax, dVertexNormalW );\n}\n",TBNfastPS:"void getTBN() {\n\tdTBN = mat3(dTangentW, dBinormalW, dVertexNormalW);\n}\n",TBNObjectSpacePS:"void getTBN() {\n\tvec3 B = cross(dVertexNormalW, vObjectSpaceUpW);\n\tvec3 T = cross(dVertexNormalW, B);\n\tif (dot(B,B)==0.0)\n\t{\n\t\tfloat major=max(max(dVertexNormalW.x, dVertexNormalW.y),dVertexNormalW.z);\n\t\tif (dVertexNormalW.x==major)\n\t\t{\n\t\t\tB=cross(dVertexNormalW, vec3(0,1,0));\n\t\t\tT=cross(dVertexNormalW, B);\n\t\t}\n\t\telse if (dVertexNormalW.y==major)\n\t\t{\n\t\t\tB=cross(dVertexNormalW, vec3(0,0,1));\n\t\t\tT=cross(dVertexNormalW, B);\n\t\t}\n\t\telse if (dVertexNormalW.z==major)\n\t\t{\n\t\t\tB=cross(dVertexNormalW, vec3(1,0,0));\n\t\t\tT=cross(dVertexNormalW, B);\n\t\t}\n\t}\n\tdTBN = mat3(normalize(T), normalize(B), normalize(dVertexNormalW));\n}\n",tonemappingAcesPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\tfloat tA = 2.51;\n\tfloat tB = 0.03;\n\tfloat tC = 2.43;\n\tfloat tD = 0.59;\n\tfloat tE = 0.14;\n\tvec3 x = color * exposure;\n\treturn (x*(tA*x+tB))/(x*(tC*x+tD)+tE);\n}\n",tonemappingAces2PS:"uniform float exposure;\nconst mat3 ACESInputMat = mat3(\n\t0.59719, 0.35458, 0.04823,\n\t0.07600, 0.90834, 0.01566,\n\t0.02840, 0.13383, 0.83777\n);\nconst mat3 ACESOutputMat = mat3(\n\t 1.60475, -0.53108, -0.07367,\n\t-0.10208,  1.10813, -0.00605,\n\t-0.00327, -0.07276,  1.07602\n);\nvec3 RRTAndODTFit(vec3 v) {\n\tvec3 a = v * (v + 0.0245786) - 0.000090537;\n\tvec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;\n\treturn a / b;\n}\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tcolor = color * ACESInputMat;\n\tcolor = RRTAndODTFit(color);\n\tcolor = color * ACESOutputMat;\n\tcolor = clamp(color, 0.0, 1.0);\n\treturn color;\n}\n",tonemappingFilmicPS:"const float A =  0.15;\nconst float B =  0.50;\nconst float C =  0.10;\nconst float D =  0.20;\nconst float E =  0.02;\nconst float F =  0.30;\nconst float W =  11.2;\nuniform float exposure;\nvec3 uncharted2Tonemap(vec3 x) {\n   return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\nvec3 toneMap(vec3 color) {\n\tcolor = uncharted2Tonemap(color * exposure);\n\tvec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n\tcolor = color * whiteScale;\n\treturn color;\n}\n",tonemappingHejlPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tconst float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;\n\tconst float Scl = 1.25;\n\tvec3 h = max( vec3(0.0), color - vec3(0.004) );\n\treturn (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);\n}\n",tonemappingLinearPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\treturn color * exposure;\n}\n",tonemappingNonePS:"vec3 toneMap(vec3 color) {\n\treturn color;\n}\n",transformVS:"#ifdef PIXELSNAP\nuniform vec4 uScreenSize;\n#endif\n#ifdef MORPHING\nuniform vec4 morph_weights_a;\nuniform vec4 morph_weights_b;\n#endif\n#ifdef MORPHING_TEXTURE_BASED\nuniform vec4 morph_tex_params;\nvec2 getTextureMorphCoords() {\n\tfloat vertexId = morph_vertex_id;\n\tvec2 textureSize = morph_tex_params.xy;\n\tvec2 invTextureSize = morph_tex_params.zw;\n\tfloat morphGridV = floor(vertexId * invTextureSize.x);\n\tfloat morphGridU = vertexId - (morphGridV * textureSize.x);\n\treturn (vec2(morphGridU, morphGridV) * invTextureSize) + (0.5 * invTextureSize);\n}\n#endif\n#ifdef MORPHING_TEXTURE_BASED_POSITION\nuniform highp sampler2D morphPositionTex;\n#endif\nmat4 getModelMatrix() {\n\t#ifdef DYNAMICBATCH\n\treturn getBoneMatrix(vertex_boneIndices);\n\t#elif defined(SKIN)\n\treturn matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);\n\t#elif defined(INSTANCING)\n\treturn mat4(instance_line1, instance_line2, instance_line3, instance_line4);\n\t#else\n\treturn matrix_model;\n\t#endif\n}\nvec4 getPosition() {\n\tdModelMatrix = getModelMatrix();\n\tvec3 localPos = vertex_position;\n\t#ifdef NINESLICED\n\tlocalPos.xz *= outerScale;\n\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\tlocalPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\tvTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0;\n\tlocalPos.xz *= -0.5;\n\tlocalPos = localPos.xzy;\n\t#endif\n\t#ifdef MORPHING\n\t#ifdef MORPHING_POS03\n\tlocalPos.xyz += morph_weights_a[0] * morph_pos0;\n\tlocalPos.xyz += morph_weights_a[1] * morph_pos1;\n\tlocalPos.xyz += morph_weights_a[2] * morph_pos2;\n\tlocalPos.xyz += morph_weights_a[3] * morph_pos3;\n\t#endif\n\t#ifdef MORPHING_POS47\n\tlocalPos.xyz += morph_weights_b[0] * morph_pos4;\n\tlocalPos.xyz += morph_weights_b[1] * morph_pos5;\n\tlocalPos.xyz += morph_weights_b[2] * morph_pos6;\n\tlocalPos.xyz += morph_weights_b[3] * morph_pos7;\n\t#endif\n\t#endif\n\t#ifdef MORPHING_TEXTURE_BASED_POSITION\n\tvec2 morphUV = getTextureMorphCoords();\n\tvec3 morphPos = texture2D(morphPositionTex, morphUV).xyz;\n\tlocalPos += morphPos;\n\t#endif\n\tvec4 posW = dModelMatrix * vec4(localPos, 1.0);\n\t#ifdef SCREENSPACE\n\tposW.zw = vec2(0.0, 1.0);\n\t#endif\n\tdPositionW = posW.xyz;\n\tvec4 screenPos;\n\t#ifdef UV1LAYOUT\n\tscreenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n\t#else\n\t#ifdef SCREENSPACE\n\tscreenPos = posW;\n\t#else\n\tscreenPos = matrix_viewProjection * posW;\n\t#endif\n\t#ifdef PIXELSNAP\n\tscreenPos.xy = (screenPos.xy * 0.5) + 0.5;\n\tscreenPos.xy *= uScreenSize.xy;\n\tscreenPos.xy = floor(screenPos.xy);\n\tscreenPos.xy *= uScreenSize.zw;\n\tscreenPos.xy = (screenPos.xy * 2.0) - 1.0;\n\t#endif\n\t#endif\n\treturn screenPos;\n}\nvec3 getWorldPosition() {\n\treturn dPositionW;\n}\n",transformDeclVS:"attribute vec3 vertex_position;\nuniform mat4 matrix_model;\nuniform mat4 matrix_viewProjection;\nvec3 dPositionW;\nmat4 dModelMatrix;\n",uv0VS:"#ifdef NINESLICED\nvec2 getUv0() {\n\tvec2 uv = vertex_position.xz;\n\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\tuv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\tuv = uv * -0.5 + 0.5;\n\tuv = uv * atlasRect.zw + atlasRect.xy;\n\tvMask = vertex_texCoord0.xy;\n\treturn uv;\n}\n#else\nvec2 getUv0() {\n\treturn vertex_texCoord0;\n}\n#endif\n",uv1VS:"vec2 getUv1() {\n\treturn vertex_texCoord1;\n}\n",viewDirPS:"void getViewDir() {\n\tdViewDirW = normalize(view_position - vPositionW);\n}\n",viewNormalVS:"#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nvec3 getViewNormal() {\n\treturn mat3(matrix_view) * vNormalW;\n}\n"};function gammaCode(value,chunks){return chunks||(chunks=shaderChunks),1===value||2===value?chunks.gamma2_2PS?chunks.gamma2_2PS:shaderChunks.gamma2_2PS:3===value?"#define HDR\n"+(chunks.gamma2_2PS?chunks.gamma2_2PS:shaderChunks.gamma2_2PS):chunks.gamma1_0PS?chunks.gamma1_0PS:shaderChunks.gamma1_0PS}function tonemapCode(value,chunks){return chunks||(chunks=shaderChunks),1===value?chunks.tonemappingFilmicPS?chunks.tonemappingFilmicPS:shaderChunks.tonemappingFilmicPS:0===value?chunks.tonemappingLinearPS?chunks.tonemappingLinearPS:shaderChunks.tonemappingLinearPS:2===value?chunks.tonemappingHejlPS?chunks.tonemappingHejlPS:shaderChunks.tonemappingHejlPS:3===value?chunks.tonemappingAcesPS?chunks.tonemappingAcesPS:shaderChunks.tonemappingAcesPS:4===value?chunks.tonemappingAces2PS?chunks.tonemappingAces2PS:shaderChunks.tonemappingAces2PS:chunks.tonemapingNonePS?chunks.tonemapingNonePS:shaderChunks.tonemappingNonePS}function fogCode(value,chunks){return chunks||(chunks=shaderChunks),"linear"===value?chunks.fogLinearPS?chunks.fogLinearPS:shaderChunks.fogLinearPS:"exp"===value?chunks.fogExpPS?chunks.fogExpPS:shaderChunks.fogExpPS:"exp2"===value?chunks.fogExp2PS?chunks.fogExp2PS:shaderChunks.fogExp2PS:chunks.fogNonePS?chunks.fogNonePS:shaderChunks.fogNonePS}function skinCode(device,chunks){return chunks||(chunks=shaderChunks),device.supportsBoneTextures?chunks.skinTexVS:"#define BONE_LIMIT "+device.getBoneLimit()+"\n"+chunks.skinConstVS}function precisionCode(device){var pcode="precision "+device.precision+" float;\n";return device.webgl2&&(pcode+="#ifdef GL2\nprecision "+device.precision+" sampler2DShadow;\n#endif\n"),pcode}function versionCode(device){return device.webgl2?"#version 300 es\n":""}function dummyFragmentCode(){return"void main(void) {gl_FragColor = vec4(0.0);}"}function begin(){return"void main(void)\n{\n"}function end(){return"}\n"}var attrib2Semantic={vertex_position:"POSITION",vertex_normal:"NORMAL",vertex_tangent:"TANGENT",vertex_texCoord0:"TEXCOORD0",vertex_texCoord1:"TEXCOORD1",vertex_texCoord2:"TEXCOORD2",vertex_texCoord3:"TEXCOORD3",vertex_texCoord4:"TEXCOORD4",vertex_texCoord5:"TEXCOORD5",vertex_texCoord6:"TEXCOORD6",vertex_texCoord7:"TEXCOORD7",vertex_color:"COLOR",vertex_boneIndices:"BLENDINDICES",vertex_boneWeights:"BLENDWEIGHT"};function collectAttribs(vsCode){for(var attribs={},attrs=0,found=vsCode.indexOf("attribute");found>=0&&!(found>0&&"/"===vsCode[found-1]);){var endOfLine=vsCode.indexOf(";",found),startOfAttribName=vsCode.lastIndexOf(" ",endOfLine),attribName=vsCode.substr(startOfAttribName+1,endOfLine-(startOfAttribName+1)),semantic=attrib2Semantic[attribName];void 0!==semantic?attribs[attribName]=semantic:(attribs[attribName]="ATTR"+attrs,attrs++),found=vsCode.indexOf("attribute",found+1)}return attribs}function createShader(device,vsName,psName,useTransformFeedback){var vsCode=shaderChunks[vsName],psCode=precisionCode(device)+"\n"+shaderChunks[psName],attribs=collectAttribs(vsCode);return device.webgl2&&(vsCode=versionCode(device)+shaderChunks.gles3VS+vsCode,psCode=versionCode(device)+shaderChunks.gles3PS+psCode),new Shader(device,{attributes:attribs,vshader:vsCode,fshader:psCode,useTransformFeedback:useTransformFeedback})}function createShaderFromCode(device,vsCode,psCode,uName,useTransformFeedback,psPreamble){var shaderCache=device.programLib._cache,cached=shaderCache[uName];if(void 0!==cached)return cached;psCode=precisionCode(device)+"\n"+(psCode||"void main(void) {gl_FragColor = vec4(0.0);}");var attribs=collectAttribs(vsCode);return device.webgl2&&(vsCode=versionCode(device)+shaderChunks.gles3VS+vsCode,psCode=versionCode(device)+shaderChunks.gles3PS+psCode),shaderCache[uName]=new Shader(device,{attributes:attribs,vshader:vsCode,fshader:(psPreamble||"")+psCode,useTransformFeedback:useTransformFeedback}),shaderCache[uName]}shaderChunks.collectAttribs=collectAttribs,shaderChunks.createShader=createShader,shaderChunks.createShaderFromCode=createShaderFromCode;var basic={generateKey:function generateKey(options){var key="basic";return options.fog&&(key+="_fog"),options.alphaTest&&(key+="_atst"),options.vertexColors&&(key+="_vcol"),options.diffuseMap&&(key+="_diff"),key+="_"+options.pass},createShaderDefinition:function createShaderDefinition(device,options){var attributes={vertex_position:"POSITION"};options.skin&&(attributes.vertex_boneWeights="BLENDWEIGHT",attributes.vertex_boneIndices="BLENDINDICES"),options.vertexColors&&(attributes.vertex_color="COLOR"),options.diffuseMap&&(attributes.vertex_texCoord0="TEXCOORD0");var code="";code+=shaderChunks.transformDeclVS,options.skin?(code+=skinCode(device),code+=shaderChunks.transformSkinnedVS):code+=shaderChunks.transformVS,options.vertexColors&&(code+="attribute vec4 vertex_color;\n",code+="varying vec4 vColor;\n"),options.diffuseMap&&(code+="attribute vec2 vertex_texCoord0;\n",code+="varying vec2 vUv0;\n"),2===options.pass&&(code+="varying float vDepth;\n",code+="#ifndef VIEWMATRIX\n",code+="#define VIEWMATRIX\n",code+="uniform mat4 matrix_view;\n",code+="#endif\n",code+="#ifndef CAMERAPLANES\n",code+="#define CAMERAPLANES\n",code+="uniform vec4 camera_params;\n\n",code+="#endif\n"),code+="void main(void)\n{\n",code+="\t gl_Position = getPosition();\n",2===options.pass&&(code+="\t\tvDepth = -(matrix_view * vec4(getWorldPosition(),1.0)).z * camera_params.x;\n"),options.vertexColors&&(code+="\t\tvColor = vertex_color;\n"),options.diffuseMap&&(code+="\t\tvUv0 = vertex_texCoord0;\n");var vshader=code+="}\n",fshader;return code=precisionCode(device),options.vertexColors?code+="varying vec4 vColor;\n":code+="uniform vec4 uColor;\n",options.diffuseMap&&(code+="varying vec2 vUv0;\n",code+="uniform sampler2D texture_diffuseMap;\n"),options.fog&&(code+=fogCode(options.fog)),options.alphatest&&(code+=shaderChunks.alphaTestPS),2===options.pass&&(code+="varying float vDepth;\n",code+=shaderChunks.packDepthPS),code+="void main(void)\n{\n",options.vertexColors?code+="\t\tgl_FragColor = vColor;\n":code+="\t\tgl_FragColor = uColor;\n",options.diffuseMap&&(code+="\t\tgl_FragColor *= texture2D(texture_diffuseMap, vUv0);\n"),options.alphatest&&(code+="\t alphaTest(gl_FragColor.a);\n"),18!==options.pass&&(2===options.pass?code+="\t\tgl_FragColor = packFloat(vDepth);\n":options.fog&&(code+="\t glFragColor.rgb = addFog(gl_FragColor.rgb);\n")),{attributes:attributes,vshader:vshader,fshader:code+="}\n"}}},particle={generateKey:function generateKey(options){var key="particle";for(var prop in options)options.hasOwnProperty(prop)&&(key+=options[prop]);return key},_animTex:function _animTex(options){var vshader="";return vshader+=options.animTexLoop?shaderChunks.particleAnimFrameLoopVS:shaderChunks.particleAnimFrameClampVS,vshader+=shaderChunks.particleAnimTexVS},createShaderDefinition:function createShaderDefinition(device,options){var vshader="",fshader=precisionCode(device)+"\n";fshader+="#define PARTICLE\n",device.webgl2&&(vshader+="#define GL2\n",fshader+="#define GL2\n"),vshader+="#define VERTEXSHADER\n",options.mesh&&(vshader+="#define USE_MESH\n"),options.localSpace&&(vshader+="#define LOCAL_SPACE\n"),options.screenSpace&&(vshader+="#define SCREEN_SPACE\n"),options.animTex&&(vshader+="\nuniform vec2 animTexTilesParams;\n"),options.animTex&&(vshader+="\nuniform vec4 animTexParams;\n"),options.animTex&&(vshader+="\nuniform vec2 animTexIndexParams;\n"),2===options.normal&&(vshader+="\nvarying mat3 ParticleMat;\n"),1===options.normal&&(vshader+="\nvarying vec3 Normal;\n"),options.soft&&(vshader+="\nvarying float vDepth;\n");var faceVS=options.customFace?shaderChunks.particle_customFaceVS:shaderChunks.particle_billboardVS,attributes;return options.useCpu?(options.soft>0&&(vshader+=shaderChunks.screenDepthPS),vshader+=shaderChunks.particle_cpuVS,options.localSpace&&(vshader+=shaderChunks.particle_localShiftVS),options.animTex&&(vshader+=this._animTex(options)),options.alignToMotion&&(vshader+=shaderChunks.particle_pointAlongVS),vshader+=options.mesh?shaderChunks.particle_meshVS:faceVS,1===options.normal&&(vshader+=shaderChunks.particle_normalVS),2===options.normal&&(vshader+=shaderChunks.particle_TBNVS),options.stretch>0&&(vshader+=shaderChunks.particle_stretchVS),vshader+=shaderChunks.particle_cpu_endVS,options.soft>0&&(vshader+=shaderChunks.particle_softVS)):(vshader+=shaderChunks.particle_initVS,vshader+=options.pack8?shaderChunks.particleInputRgba8PS:shaderChunks.particleInputFloatPS,options.soft>0&&(vshader+=shaderChunks.screenDepthPS),vshader+=shaderChunks.particleVS,options.localSpace&&(vshader+=shaderChunks.particle_localShiftVS),options.animTex&&(vshader+=this._animTex(options)),options.wrap&&(vshader+=shaderChunks.particle_wrapVS),options.alignToMotion&&(vshader+=shaderChunks.particle_pointAlongVS),vshader+=options.mesh?shaderChunks.particle_meshVS:faceVS,1===options.normal&&(vshader+=shaderChunks.particle_normalVS),2===options.normal&&(vshader+=shaderChunks.particle_TBNVS),options.stretch>0&&(vshader+=shaderChunks.particle_stretchVS),vshader+=shaderChunks.particle_endVS,options.soft>0&&(vshader+=shaderChunks.particle_softVS)),vshader+="}\n",options.normal>0&&(1===options.normal?fshader+="\nvarying vec3 Normal;\n":2===options.normal&&(fshader+="\nvarying mat3 ParticleMat;\n"),fshader+="\nuniform vec3 lightCube[6];\n"),options.soft&&(fshader+="\nvarying float vDepth;\n"),0===options.normal&&"none"===options.fog&&(options.srgb=!1),fshader+=gammaCode(options.gamma),fshader+=tonemapCode(options.toneMap),"linear"===options.fog?fshader+=shaderChunks.fogLinearPS:"exp"===options.fog?fshader+=shaderChunks.fogExpPS:"exp2"===options.fog?fshader+=shaderChunks.fogExp2PS:fshader+=shaderChunks.fogNonePS,2===options.normal&&(fshader+="\nuniform sampler2D normalMap;\n"),options.soft>0&&(fshader+=shaderChunks.screenDepthPS),fshader+=shaderChunks.particlePS,options.soft>0&&(fshader+=shaderChunks.particle_softPS),1===options.normal&&(fshader+="\nvec3 normal = Normal;\n"),2===options.normal&&(fshader+=shaderChunks.particle_normalMapPS),options.normal>0&&(fshader+=options.halflambert?shaderChunks.particle_halflambertPS:shaderChunks.particle_lambertPS),options.normal>0&&(fshader+=shaderChunks.particle_lightingPS),2===options.blend?fshader+=shaderChunks.particle_blendNormalPS:1===options.blend?fshader+=shaderChunks.particle_blendAddPS:5===options.blend&&(fshader+=shaderChunks.particle_blendMultiplyPS),fshader+=shaderChunks.particle_endPS,{attributes:collectAttribs(vshader),vshader:vshader,fshader:fshader}}},skybox={generateKey:function generateKey(options){var key;return"skybox"+options.rgbm+" "+options.hdr+" "+options.fixSeams+options.toneMapping+options.gamma+options.useIntensity+options.useCubeMapRotation+options.useRightHandedCubeMap+options.mip},createShaderDefinition:function createShaderDefinition(device,options){var mip2size=[128,64,32,16,8,4,2],fshader;return fshader=precisionCode(device),fshader+=options.useCubeMapRotation?"#define CUBEMAP_ROTATION\n":"",fshader+=options.useRightHandedCubeMap?"#define RIGHT_HANDED_CUBEMAP\n":"",fshader+=options.mip?shaderChunks.fixCubemapSeamsStretchPS:shaderChunks.fixCubemapSeamsNonePS,fshader+=options.useIntensity?shaderChunks.envMultiplyPS:shaderChunks.envConstPS,fshader+=gammaCode(options.gamma),fshader+=tonemapCode(options.toneMapping),fshader+=shaderChunks.rgbmPS,fshader+=shaderChunks.skyboxHDRPS.replace(/\$textureCubeSAMPLE/g,options.rgbm?"textureCubeRGBM":options.hdr?"textureCube":"textureCubeSRGB").replace(/\$FIXCONST/g,1-1/mip2size[options.mip]+""),{attributes:{aPosition:"POSITION"},vshader:shaderChunks.skyboxVS,fshader:fshader}}},_pixelSizeTable=null,_blockSizeTable=null,Texture=function(){function Texture(graphicsDevice,options){this.device=graphicsDevice,this.name=null,this._width=4,this._height=4,this._depth=1,this._format=7,this.type="default",this.projection="none",this._cubemap=!1,this._volume=!1,this.fixCubemapSeams=!1,this._flipY=!0,this._premultiplyAlpha=!1,this._isRenderTarget=!1,this._mipmaps=!0,this._minFilter=5,this._magFilter=1,this._anisotropy=1,this._addressU=0,this._addressV=0,this._addressW=0,this._compareOnRead=!1,this._compareFunc=1,void 0!==options&&(void 0!==options.name&&(this.name=options.name),this._width=void 0!==options.width?options.width:this._width,this._height=void 0!==options.height?options.height:this._height,this._format=void 0!==options.format?options.format:this._format,options.hasOwnProperty("type")?this.type=options.type:options.hasOwnProperty("rgbm")?this.type=options.rgbm?"rgbm":"default":options.hasOwnProperty("swizzleGGGR")&&(this.type=options.swizzleGGGR?"swizzleGGGR":"default"),void 0!==options.mipmaps?this._mipmaps=options.mipmaps:this._mipmaps=void 0!==options.autoMipmap?options.autoMipmap:this._mipmaps,this._levels=options.levels,this._cubemap=void 0!==options.cubemap?options.cubemap:this._cubemap,this.fixCubemapSeams=void 0!==options.fixCubemapSeams?options.fixCubemapSeams:this.fixCubemapSeams,this._cubemap?this.projection="cube":options.projection&&"cube"!==options.projection&&(this.projection=options.projection),this._minFilter=void 0!==options.minFilter?options.minFilter:this._minFilter,this._magFilter=void 0!==options.magFilter?options.magFilter:this._magFilter,this._anisotropy=void 0!==options.anisotropy?options.anisotropy:this._anisotropy,this._addressU=void 0!==options.addressU?options.addressU:this._addressU,this._addressV=void 0!==options.addressV?options.addressV:this._addressV,this._compareOnRead=void 0!==options.compareOnRead?options.compareOnRead:this._compareOnRead,this._compareFunc=void 0!==options._compareFunc?options._compareFunc:this._compareFunc,this._flipY=void 0!==options.flipY?options.flipY:this._flipY,this._premultiplyAlpha=void 0!==options.premultiplyAlpha?options.premultiplyAlpha:this._premultiplyAlpha,graphicsDevice.webgl2&&(this._depth=void 0!==options.depth?options.depth:this._depth,this._volume=void 0!==options.volume?options.volume:this._volume,this._addressW=void 0!==options.addressW?options.addressW:this._addressW)),this._compressed=8===this._format||9===this._format||10===this._format||this._format>=21,this._invalid=!1,this._lockedLevel=-1,this._levels||(this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]),this.dirtyAll(),this._gpuSize=0}Texture.calcGpuSize=function calcGpuSize(width,height,depth,format,mipmaps,cubemap){_pixelSizeTable||((_pixelSizeTable=[])[0]=1,_pixelSizeTable[1]=1,_pixelSizeTable[2]=2,_pixelSizeTable[3]=2,_pixelSizeTable[4]=2,_pixelSizeTable[5]=2,_pixelSizeTable[6]=4,_pixelSizeTable[7]=4,_pixelSizeTable[11]=8,_pixelSizeTable[12]=8,_pixelSizeTable[13]=16,_pixelSizeTable[14]=16,_pixelSizeTable[15]=4,_pixelSizeTable[16]=4,_pixelSizeTable[17]=4,_pixelSizeTable[18]=4,_pixelSizeTable[19]=4,_pixelSizeTable[20]=4),_blockSizeTable||((_blockSizeTable=[])[21]=8,_blockSizeTable[22]=8,_blockSizeTable[24]=8,_blockSizeTable[25]=8,_blockSizeTable[26]=8,_blockSizeTable[27]=8,_blockSizeTable[8]=8,_blockSizeTable[29]=8,_blockSizeTable[23]=16,_blockSizeTable[9]=16,_blockSizeTable[10]=16,_blockSizeTable[28]=16,_blockSizeTable[30]=16);for(var pixelSize=_pixelSizeTable.hasOwnProperty(format)?_pixelSizeTable[format]:0,blockSize=_blockSizeTable.hasOwnProperty(format)?_blockSizeTable[format]:0,result=0;;){if(pixelSize>0)result+=width*height*depth*pixelSize;else{var blockWidth=Math.floor((width+3)/4),blockHeight=Math.floor((height+3)/4),blockDepth=Math.floor((depth+3)/4);24!==format&&25!==format||(blockWidth=Math.max(Math.floor(blockWidth/2),1)),result+=blockWidth*blockHeight*blockDepth*blockSize}if(!mipmaps||1===width&&1===height&&1===depth)break;width=Math.max(Math.floor(width/2),1),height=Math.max(Math.floor(height/2),1),depth=Math.max(Math.floor(depth/2),1)}return result*(cubemap?6:1)};var _proto=Texture.prototype;return _proto.destroy=function destroy(){this.device&&this.device.destroyTexture(this),this.device=null,this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]},_proto.dirtyAll=function dirtyAll(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0],this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=!1,this._parameterFlags=255},_proto.lock=function lock(options){if(void 0===options&&(options={}),void 0===options.level&&(options.level=0),void 0===options.face&&(options.face=0),void 0===options.mode&&(options.mode=2),this._lockedLevel=options.level,null===this._levels[options.level])switch(this._format){case 0:case 1:this._levels[options.level]=new Uint8Array(this._width*this._height*this._depth);break;case 2:this._levels[options.level]=new Uint8Array(this._width*this._height*this._depth*2);break;case 3:case 4:case 5:this._levels[options.level]=new Uint16Array(this._width*this._height*this._depth);break;case 6:this._levels[options.level]=new Uint8Array(this._width*this._height*this._depth*3);break;case 7:this._levels[options.level]=new Uint8Array(this._width*this._height*this._depth*4);break;case 8:this._levels[options.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*8*this._depth);break;case 9:case 10:this._levels[options.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*16*this._depth);break;case 11:this._levels[options.level]=new Uint16Array(this._width*this._height*this._depth*3);break;case 13:this._levels[options.level]=new Float32Array(this._width*this._height*this._depth*3);break;case 12:this._levels[options.level]=new Uint16Array(this._width*this._height*this._depth*4);break;case 14:this._levels[options.level]=new Float32Array(this._width*this._height*this._depth*4)}return this._levels[options.level]},_proto.setSource=function setSource(source,mipLevel){var i;void 0===mipLevel&&(mipLevel=0);var invalid=!1,width,height;if(this._cubemap){if(source[0])for(width=source[0].width||0,height=source[0].height||0,i=0;i<6;i++){var face=source[i];if(!face||face.width!==width||face.height!==height||!this.device._isBrowserInterface(face)){invalid=!0;break}}else invalid=!0;if(!invalid)for(i=0;i<6;i++)this._levels[mipLevel][i]!==source[i]&&(this._levelsUpdated[mipLevel][i]=!0)}else this.device._isBrowserInterface(source)||(invalid=!0),invalid||(source!==this._levels[mipLevel]&&(this._levelsUpdated[mipLevel]=!0),width=source.width,height=source.height);if(invalid)if(this._width=4,this._height=4,this._cubemap)for(i=0;i<6;i++)this._levels[mipLevel][i]=null,this._levelsUpdated[mipLevel][i]=!0;else this._levels[mipLevel]=null,this._levelsUpdated[mipLevel]=!0;else 0===mipLevel&&(this._width=width,this._height=height),this._levels[mipLevel]=source;this._invalid===invalid&&invalid||(this._invalid=invalid,this.upload())},_proto.getSource=function getSource(mipLevel){return void 0===mipLevel&&(mipLevel=0),this._levels[mipLevel]},_proto.unlock=function unlock(){this.upload(),this._lockedLevel=-1},_proto.upload=function upload(){this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps},_proto.getDds=function getDds(){for(var fsize=128,i=0,j,face;this._levels[i];){var mipSize;if(this.cubemap)for(face=0;face<6;face++){if(!this._levels[i][face])return;if(!(mipSize=this._levels[i][face].length))return;fsize+=mipSize}else{if(!(mipSize=this._levels[i].length))return;fsize+=mipSize}fsize+=this._levels[i].length,i++}var buff=new ArrayBuffer(fsize),header=new Uint32Array(buff,0,32),DDS_MAGIC=542327876,DDS_HEADER_SIZE=124,DDS_FLAGS_REQUIRED=528391,DDS_FLAGS_MIPMAP=131072,DDS_PIXELFORMAT_SIZE=32,DDS_PIXELFLAGS_RGBA8=65,DDS_CAPS_REQUIRED=4096,DDS_CAPS_MIPMAP=4194304,DDS_CAPS_COMPLEX=8,DDS_CAPS2_CUBEMAP=65024,flags=528391;this._levels.length>1&&(flags|=131072);var caps=4096;this._levels.length>1&&(caps|=4194304),(this._levels.length>1||this.cubemap)&&(caps|=8);var caps2=this.cubemap?65024:0;for(header[0]=542327876,header[1]=124,header[2]=flags,header[3]=this.height,header[4]=this.width,header[5]=this.width*this.height*4,header[6]=0,header[7]=this._levels.length,i=0;i<11;i++)header[8+i]=0;header[19]=32,header[20]=65,header[21]=0,header[22]=32,header[23]=16711680,header[24]=65280,header[25]=255,header[26]=4278190080,header[27]=caps,header[28]=caps2,header[29]=0,header[30]=0,header[31]=0;var offset=128,level,mip;if(this.cubemap)for(face=0;face<6;face++)for(i=0;i<this._levels.length;i++){for(level=this._levels[i][face],mip=new Uint8Array(buff,offset,level.length),j=0;j<level.length;j++)mip[j]=level[j];offset+=level.length}else for(i=0;i<this._levels.length;i++){for(level=this._levels[i],mip=new Uint8Array(buff,offset,level.length),j=0;j<level.length;j++)mip[j]=level[j];offset+=level.length}return buff},_createClass(Texture,[{key:"minFilter",get:function get(){return this._minFilter},set:function set(v){this._minFilter!==v&&(this._minFilter=v,this._parameterFlags|=1)}},{key:"magFilter",get:function get(){return this._magFilter},set:function set(v){this._magFilter!==v&&(this._magFilter=v,this._parameterFlags|=2)}},{key:"addressU",get:function get(){return this._addressU},set:function set(v){this._addressU!==v&&(this._addressU=v,this._parameterFlags|=4)}},{key:"addressV",get:function get(){return this._addressV},set:function set(v){this._addressV!==v&&(this._addressV=v,this._parameterFlags|=8)}},{key:"addressW",get:function get(){return this._addressW},set:function set(addressW){this.device.webgl2&&this._volume&&addressW!==this._addressW&&(this._addressW=addressW,this._parameterFlags|=16)}},{key:"compareOnRead",get:function get(){return this._compareOnRead},set:function set(v){this._compareOnRead!==v&&(this._compareOnRead=v,this._parameterFlags|=32)}},{key:"compareFunc",get:function get(){return this._compareFunc},set:function set(v){this._compareFunc!==v&&(this._compareFunc=v,this._parameterFlags|=64)}},{key:"anisotropy",get:function get(){return this._anisotropy},set:function set(v){this._anisotropy!==v&&(this._anisotropy=v,this._parameterFlags|=128)}},{key:"autoMipmap",get:function get(){return this._mipmaps},set:function set(v){this._mipmaps=v}},{key:"mipmaps",get:function get(){return this._mipmaps},set:function set(v){this._mipmaps!==v&&(this._mipmaps=v,this._minFilterDirty=!0,v&&(this._needsMipmapsUpload=!0))}},{key:"width",get:function get(){return this._width}},{key:"height",get:function get(){return this._height}},{key:"depth",get:function get(){return this._depth}},{key:"format",get:function get(){return this._format}},{key:"cubemap",get:function get(){return this._cubemap}},{key:"gpuSize",get:function get(){var mips=this.pot&&this._mipmaps&&!(this._compressed&&1===this._levels.length);return Texture.calcGpuSize(this._width,this._height,this._depth,this._format,mips,this._cubemap)}},{key:"volume",get:function get(){return this._volume}},{key:"flipY",get:function get(){return this._flipY},set:function set(flipY){this._flipY!==flipY&&(this._flipY=flipY,this._needsUpload=!0)}},{key:"premultiplyAlpha",get:function get(){return this._premultiplyAlpha},set:function set(premultiplyAlpha){this._premultiplyAlpha!==premultiplyAlpha&&(this._premultiplyAlpha=premultiplyAlpha,this._needsUpload=!0)}},{key:"pot",get:function get(){return math.powerOfTwo(this._width)&&math.powerOfTwo(this._height)}}]),Texture}(),tempVec3=new Vec3,tempMin3=new Vec3,tempMax3=new Vec3,tempBox=new BoundingBox,epsilon=1e-6,oneDiv255=1/255;function packFloatToBytes(value,array,offset,numBytes){var enc1=255*value%1;if(array[offset+0]=Math.round(255*(value%1-1/255*enc1)),numBytes>1){var enc2=65025*value%1;if(array[offset+1]=Math.round(255*(enc1-1/255*enc2)),numBytes>2){var enc3=16581375*value%1;array[offset+2]=Math.round(255*(enc2-1/255*enc3)),numBytes>3&&(array[offset+3]=Math.round(255*enc3))}}}var ClusterLight=function ClusterLight(){this.light=null,this.min=new Vec3,this.max=new Vec3},WorldClusters=function(){function WorldClusters(device,cells,maxCellLightCount){this.device=device,this.name="Untitled",this.reportCount=0,this._bounds=new BoundingBox,this.boundsMin=new Vec3,this.boundsMax=new Vec3,this.boundsDelta=new Vec3,this._cells=new Vec3,this._cellsLimit=new Vec3,this.cells=cells,this._maxCellLightCount=0,this._pixelsPerCellCount=0,this.maxCellLightCount=maxCellLightCount,this._maxAttenuation=0,this._maxColorValue=0,this._usedLights=[],this._usedLights.push(new ClusterLight),this.registerUniforms(device),this.initLightsTexture()}WorldClusters.init=function init(device){device.extTextureFloat?WorldClusters.lightTextureFormat=WorldClusters.FORMAT_FLOAT:WorldClusters.lightTextureFormat=WorldClusters.FORMAT_8BIT};var _proto=WorldClusters.prototype;return _proto.destroy=function destroy(){this.lightsTexture8&&(this.lightsTexture8.destroy(),this.lightsTexture8=null),this.lightsTextureFloat&&(this.lightsTextureFloat.destroy(),this.lightsTextureFloat=null),this.releaseClusterTexture()},_proto.releaseClusterTexture=function releaseClusterTexture(){this.clusterTexture&&(this.clusterTexture.destroy(),this.clusterTexture=null)},_proto.registerUniforms=function registerUniforms(device){this._clusterWorldTextureId=device.scope.resolve("clusterWorldTexture"),this._clusterPixelsPerCellId=device.scope.resolve("clusterPixelsPerCell"),this._clusterTextureSizeId=device.scope.resolve("clusterTextureSize"),this._clusterTextureSizeData=new Float32Array(3),this._clusterBoundsMinId=device.scope.resolve("clusterBoundsMin"),this._clusterBoundsMinData=new Float32Array(3),this._clusterBoundsDeltaId=device.scope.resolve("clusterBoundsDelta"),this._clusterBoundsDeltaData=new Float32Array(3),this._clusterCellsCountByBoundsSizeId=device.scope.resolve("clusterCellsCountByBoundsSize"),this._clusterCellsCountByBoundsSizeData=new Float32Array(3),this._clusterCellsDotId=device.scope.resolve("clusterCellsDot"),this._clusterCellsDotData=new Float32Array(3),this._clusterCellsMaxId=device.scope.resolve("clusterCellsMax"),this._clusterCellsMaxData=new Float32Array(3),this._clusterCompressionLimit0Id=device.scope.resolve("clusterCompressionLimit0"),this._clusterCompressionLimit0Data=new Float32Array(2)},_proto.createTexture=function createTexture(width,height,format){var tex;return new Texture(this.device,{width:width,height:height,mipmaps:!1,format:format,addressU:1,addressV:1,type:"default",magFilter:0,minFilter:0,anisotropy:1})},_proto.initLightsTexture=function initLightsTexture(){this.maxLights=255;var pixelsPerLight8=4,pixelsPerLightFloat=0;WorldClusters.lightTextureFormat===WorldClusters.FORMAT_FLOAT?pixelsPerLightFloat=2:pixelsPerLight8=11,this.lights8=new Uint8ClampedArray(4*pixelsPerLight8*this.maxLights),this.lightsTexture8=this.createTexture(pixelsPerLight8,this.maxLights,7),this._lightsTexture8Id=this.device.scope.resolve("lightsTexture8"),pixelsPerLightFloat?(this.lightsFloat=new Float32Array(4*pixelsPerLightFloat*this.maxLights),this.lightsTextureFloat=this.createTexture(pixelsPerLightFloat,this.maxLights,14),this._lightsTextureFloatId=this.device.scope.resolve("lightsTextureFloat")):(this.lightsFloat=null,this.lightsTextureFloat=null,this._lightsTextureFloatId=void 0),this._lightsTextureInvSizeId=this.device.scope.resolve("lightsTextureInvSize"),this._lightsTextureInvSizeData=new Float32Array(4),this._lightsTextureInvSizeData[0]=pixelsPerLightFloat?1/this.lightsTextureFloat.width:0,this._lightsTextureInvSizeData[1]=pixelsPerLightFloat?1/this.lightsTextureFloat.height:0,this._lightsTextureInvSizeData[2]=1/this.lightsTexture8.width,this._lightsTextureInvSizeData[3]=1/this.lightsTexture8.height},_proto.getSpotDirection=function getSpotDirection(direction,spot){var mat;spot._node.getWorldTransform().getY(direction).mulScalar(-1),direction.normalize()},_proto.addLightData=function addLightData(light,lightIndex,gammaCorrection){var isSpot=2===light._type,pos=light._node.getPosition(),data8=this.lights8,data8Index=lightIndex*this.lightsTexture8.width*4;data8[data8Index+0]=isSpot?255:0,data8[data8Index+1]=255*light._shape,data8[data8Index+2]=255*light._falloffMode,data8Index+=4;var invMaxColorValue=1/this._maxColorValue,color=gammaCorrection?light._linearFinalColor:light._finalColor;if(packFloatToBytes(color[0]*invMaxColorValue,data8,data8Index+0,2),packFloatToBytes(color[1]*invMaxColorValue,data8,data8Index+2,2),packFloatToBytes(color[2]*invMaxColorValue,data8,data8Index+4,2),data8Index+=8,isSpot&&(packFloatToBytes(.499999*light._innerConeAngleCos+.5,data8,data8Index+0,2),packFloatToBytes(.499999*light._outerConeAngleCos+.5,data8,data8Index+2,2)),data8Index+=4,WorldClusters.lightTextureFormat===WorldClusters.FORMAT_FLOAT){var dataFloat=this.lightsFloat,dataFloatIndex=lightIndex*this.lightsTextureFloat.width*4;dataFloat[dataFloatIndex+0]=pos.x,dataFloat[dataFloatIndex+1]=pos.y,dataFloat[dataFloatIndex+2]=pos.z,dataFloat[dataFloatIndex+3]=light.attenuationEnd,isSpot&&(this.getSpotDirection(tempVec3,light),dataFloat[dataFloatIndex+4]=tempVec3.x,dataFloat[dataFloatIndex+5]=tempVec3.y,dataFloat[dataFloatIndex+6]=tempVec3.z)}else{var normPos=tempVec3.sub2(pos,this.boundsMin).div(this.boundsDelta);packFloatToBytes(normPos.x,data8,data8Index+0,4),packFloatToBytes(normPos.y,data8,data8Index+4,4),packFloatToBytes(normPos.z,data8,data8Index+8,4),packFloatToBytes(light.attenuationEnd/this._maxAttenuation,data8,data8Index+12,4),data8Index+=16,isSpot&&(this.getSpotDirection(tempVec3,light),packFloatToBytes(.499999*tempVec3.x+.5,data8,data8Index+0,4),packFloatToBytes(.499999*tempVec3.y+.5,data8,data8Index+4,4),packFloatToBytes(.499999*tempVec3.z+.5,data8,data8Index+8,4))}},_proto.updateCells=function updateCells(){if(this._cellsDirty){this._cellsDirty=!1;var cx=this._cells.x,cy=this._cells.y,cz=this._cells.z,numCells=cx*cy*cz,totalPixels=this._pixelsPerCellCount*numCells,width=Math.ceil(Math.sqrt(totalPixels));width=math.roundUp(width,this._pixelsPerCellCount);var height=Math.ceil(totalPixels/width);this._clusterCellsMaxData[0]=cx,this._clusterCellsMaxData[1]=cy,this._clusterCellsMaxData[2]=cz,this._clusterCellsDotData[0]=this._pixelsPerCellCount,this._clusterCellsDotData[1]=cx*cz*this._pixelsPerCellCount,this._clusterCellsDotData[2]=cx*this._pixelsPerCellCount,this.clusters=new Uint8ClampedArray(4*totalPixels),this.counts=new Int32Array(numCells),this._clusterTextureSizeData[0]=width,this._clusterTextureSizeData[1]=1/width,this._clusterTextureSizeData[2]=1/height,this.releaseClusterTexture(),this.clusterTexture=this.createTexture(width,height,7)}},_proto.uploadTextures=function uploadTextures(){var pixels=this.clusterTexture.lock();pixels.set(this.clusters),this.clusterTexture.unlock(),this.lightsTextureFloat&&((pixels=this.lightsTextureFloat.lock()).set(this.lightsFloat),this.lightsTextureFloat.unlock()),(pixels=this.lightsTexture8.lock()).set(this.lights8),this.lightsTexture8.unlock()},_proto.updateUniforms=function updateUniforms(){this._clusterWorldTextureId.setValue(this.clusterTexture),this._lightsTexture8Id.setValue(this.lightsTexture8),WorldClusters.lightTextureFormat===WorldClusters.FORMAT_FLOAT&&this._lightsTextureFloatId.setValue(this.lightsTextureFloat);var boundsDelta=this.boundsDelta;this._clusterCellsCountByBoundsSizeData[0]=this._cells.x/boundsDelta.x,this._clusterCellsCountByBoundsSizeData[1]=this._cells.y/boundsDelta.y,this._clusterCellsCountByBoundsSizeData[2]=this._cells.z/boundsDelta.z,this._clusterCellsCountByBoundsSizeId.setValue(this._clusterCellsCountByBoundsSizeData),this._clusterBoundsMinData[0]=this.boundsMin.x,this._clusterBoundsMinData[1]=this.boundsMin.y,this._clusterBoundsMinData[2]=this.boundsMin.z,this._clusterBoundsDeltaData[0]=boundsDelta.x,this._clusterBoundsDeltaData[1]=boundsDelta.y,this._clusterBoundsDeltaData[2]=boundsDelta.z,this._clusterCompressionLimit0Data[0]=this._maxAttenuation,this._clusterCompressionLimit0Data[1]=this._maxColorValue,this._clusterPixelsPerCellId.setValue(this._pixelsPerCellCount),this._lightsTextureInvSizeId.setValue(this._lightsTextureInvSizeData),this._clusterTextureSizeId.setValue(this._clusterTextureSizeData),this._clusterBoundsMinId.setValue(this._clusterBoundsMinData),this._clusterBoundsDeltaId.setValue(this._clusterBoundsDeltaData),this._clusterCellsDotId.setValue(this._clusterCellsDotData),this._clusterCellsMaxId.setValue(this._clusterCellsMaxData),this._clusterCompressionLimit0Id.setValue(this._clusterCompressionLimit0Data)},_proto.evalLightCellMinMax=function evalLightCellMinMax(clusteredLight,min,max){min.copy(clusteredLight.min),min.sub(this.boundsMin),min.div(this.boundsDelta),min.mul2(min,this.cells),min.floor(),max.copy(clusteredLight.max),max.sub(this.boundsMin),max.div(this.boundsDelta),max.mul2(max,this.cells),max.ceil(),min.max(Vec3.ZERO),max.min(this._cellsLimit)},_proto.collectLights=function collectLights(lights){for(var usedLights=this._usedLights,lightIndex=1,i=0;i<lights.length;i++){var light=lights[i];if(light.enabled&&0!==light.type&&light.visibleThisFrame){if(!(lightIndex<this.maxLights)){console.warn("Clustered lighting: more than "+(this.maxLights-1)+" lights in the frame, ignoring some.");break}var clusteredLight=void 0;lightIndex<usedLights.length?clusteredLight=usedLights[lightIndex]:(clusteredLight=new ClusterLight,usedLights.push(clusteredLight)),clusteredLight.light=light,light.getBoundingBox(tempBox),clusteredLight.min.copy(tempBox.getMin()),clusteredLight.max.copy(tempBox.getMax()),lightIndex++}}usedLights.length=lightIndex},_proto.evaluateBounds=function evaluateBounds(){var usedLights=this._usedLights,min=this.boundsMin,max=this.boundsMax;if(usedLights.length>1){min.copy(usedLights[1].min),max.copy(usedLights[1].max);for(var i=2;i<usedLights.length;i++)min.min(usedLights[i].min),max.max(usedLights[i].max)}else min.set(0,0,0),max.set(1,1,1);this.boundsDelta.sub2(max,min)},_proto.evaluateCompressionLimits=function evaluateCompressionLimits(gammaCorrection){for(var maxAttenuation=0,maxColorValue=0,usedLights=this._usedLights,i=1;i<usedLights.length;i++){var light=usedLights[i].light;maxAttenuation=Math.max(light.attenuationEnd,maxAttenuation);var color=gammaCorrection?light._linearFinalColor:light._finalColor;maxColorValue=Math.max(color[0],maxColorValue),maxColorValue=Math.max(color[1],maxColorValue),maxColorValue=Math.max(color[2],maxColorValue)}this._maxAttenuation=maxAttenuation+1e-6,this._maxColorValue=maxColorValue+1e-6},_proto.updateClusters=function updateClusters(gammaCorrection){this.counts.fill(0),this.clusters.fill(0);for(var divX=this._cells.x,divZ=this._cells.z,counts=this.counts,limit=this._maxCellLightCount,clusters=this.clusters,pixelsPerCellCount=this._pixelsPerCellCount,usedLights=this._usedLights,i=1;i<usedLights.length;i++){var clusteredLight=usedLights[i],light=clusteredLight.light;this.addLightData(light,i,gammaCorrection),this.evalLightCellMinMax(clusteredLight,tempMin3,tempMax3);for(var xStart=tempMin3.x,xEnd=tempMax3.x,yStart=tempMin3.y,yEnd=tempMax3.y,zStart=tempMin3.z,zEnd=tempMax3.z,x=xStart;x<=xEnd;x++)for(var z=zStart;z<=zEnd;z++)for(var y=yStart;y<=yEnd;y++){var clusterIndex=x+divX*(z+y*divZ),count=counts[clusterIndex];count<limit&&(clusters[pixelsPerCellCount*clusterIndex*4+count]=i,counts[clusterIndex]=count+1)}}},_proto.update=function update(lights,gammaCorrection){this.updateCells(),this.collectLights(lights),this.evaluateBounds(),this.evaluateCompressionLimits(gammaCorrection),this.updateClusters(gammaCorrection),this.uploadTextures()},_proto.activate=function activate(){this.updateUniforms()},_createClass(WorldClusters,[{key:"maxCellLightCount",get:function get(){return this._maxCellLightCount},set:function set(count){var maxCellLightCount=math.roundUp(count,4);maxCellLightCount!==this._maxCellLightCount&&(this._maxCellLightCount=maxCellLightCount,this._pixelsPerCellCount=this._maxCellLightCount/4,this._cellsDirty=!0)}},{key:"cells",get:function get(){return this._cells},set:function set(value){tempVec3.copy(value).floor(),this._cells.equals(tempVec3)||(this._cells.copy(tempVec3),this._cellsLimit.copy(tempVec3).sub(Vec3.ONE),this._cellsDirty=!0)}}]),WorldClusters}();WorldClusters.FORMAT_FLOAT=0,WorldClusters.FORMAT_8BIT=1,WorldClusters.lightTextureFormat=WorldClusters.FORMAT_8BIT;var set_equals=function equals(set1,set2){if(set1.size!==set2.size)return!1;for(var _iterator=_createForOfIteratorHelperLoose(set1),_step;!(_step=_iterator()).done;){var item=_step.value;if(!set2.has(item))return!1}return!0},RenderAction=function(){function RenderAction(){this.layerIndex=0,this.cameraIndex=0,this.camera=null,this.renderTarget=null,this.lightClusters=null,this.clearColor=!1,this.clearDepth=!1,this.clearStencil=!1,this.triggerPostprocess=!1,this.firstCameraUse=!1,this.directionalLightsSet=new Set,this.directionalLights=[],this.directionalLightsIndices=[]}var _proto=RenderAction.prototype;return _proto.reset=function reset(){this.lightClusters=null,this.directionalLightsSet.clear(),this.directionalLights.length=0,this.directionalLightsIndices.length=0},_proto.collectDirectionalLights=function collectDirectionalLights(cameraLayers,dirLights,allLights){this.directionalLightsSet.clear(),this.directionalLights.length=0,this.directionalLightsIndices.length=0;for(var i=0;i<dirLights.length;i++){var light=dirLights[i];if(light.castShadows)for(var l=0;l<cameraLayers.length;l++)if(cameraLayers[l]._splitLights[0].indexOf(light)>=0&&!this.directionalLightsSet.has(light)){this.directionalLightsSet.add(light),this.directionalLights.push(light);var lightIndex=allLights.indexOf(light);this.directionalLightsIndices.push(lightIndex)}}},RenderAction}(),LightCompositionData=function(){function LightCompositionData(){this.shadowCastersSet=new Set,this.shadowCastersList=[]}var _proto=LightCompositionData.prototype;return _proto.clearShadowCasters=function clearShadowCasters(){this.shadowCastersSet.clear(),this.shadowCastersList.length=0},_proto.addShadowCasters=function addShadowCasters(casters){for(var i=0;i<casters.length;i++){var item=casters[i];this.shadowCastersSet.has(item)||(this.shadowCastersSet.add(item),this.shadowCastersList.push(item))}},LightCompositionData}(),currentApplication;function getApplication(){return currentApplication}function setApplication(app){currentApplication=app}var tempSet$1=new Set,tempClusterArray=[],LayerComposition=function(_EventHandler){function LayerComposition(graphicsDevice,name){var _getApplication,_this;return void 0===name&&(name="Untitled"),"string"==typeof graphicsDevice&&(name=graphicsDevice=null),(_this=_EventHandler.call(this)||this).device=graphicsDevice||(null==(_getApplication=getApplication())?void 0:_getApplication.graphicsDevice),_this.name=name,_this.logRenderActions=!1,_this.layerList=[],_this.subLayerList=[],_this.subLayerEnabled=[],_this._opaqueOrder={},_this._transparentOrder={},_this._dirty=!1,_this._dirtyBlend=!1,_this._dirtyLights=!1,_this._dirtyCameras=!1,_this._meshInstances=[],_this._meshInstancesSet=new Set,_this._lights=[],_this._lightsMap=new Map,_this._lightCompositionData=[],_this._splitLights=[[],[],[]],_this.cameras=[],_this._renderActions=[],_this._worldClusters=[],_this._emptyWorldClusters=null,_this._clusteredLightingCells=new Vec3(10,3,10),_this._clusteredLightingMaxLights=64,_this}_inheritsLoose(LayerComposition,_EventHandler);var _proto=LayerComposition.prototype;return _proto.destroy=function destroy(){this._emptyWorldClusters&&(this._emptyWorldClusters.destroy(),this._emptyWorldClusters=null),this._worldClusters.forEach((function(cluster){return cluster.destroy()})),this._worldClusters=null},_proto.updateWorldClusters=function updateWorldClusters(){var _this2=this;this._worldClusters.forEach((function(cluster){cluster.cells=_this2._clusteredLightingCells,cluster.maxCellLightCount=_this2._clusteredLightingMaxLights}))},_proto._splitLightsArray=function _splitLightsArray(target){var light,lights=target._lights;target._splitLights[0].length=0,target._splitLights[1].length=0,target._splitLights[2].length=0;for(var i=0;i<lights.length;i++)(light=lights[i]).enabled&&target._splitLights[light._type].push(light)},_proto._update=function _update(){var i,j,layer,len=this.layerList.length,result=0,camera,index,cameraIndex;if(!this._dirty||!this._dirtyLights||!this._dirtyCameras)for(i=0;i<len;i++)(layer=this.layerList[i])._dirty&&(this._dirty=!0),layer._dirtyLights&&(this._dirtyLights=!0),layer._dirtyCameras&&(this._dirtyCameras=!0);function addUniqueMeshInstance(destArray,destSet,srcArray){for(var meshInst,material,dirtyBlend=!1,srcLen=srcArray.length,s=0;s<srcLen;s++)meshInst=srcArray[s],destSet.has(meshInst)||(destSet.add(meshInst),destArray.push(meshInst),(material=meshInst.material)&&material._dirtyBlend&&(dirtyBlend=!0,material._dirtyBlend=!1));return dirtyBlend}if(this._dirty){for(result|=1,this._meshInstances.length=0,this._meshInstancesSet.clear(),i=0;i<len;i++)(layer=this.layerList[i]).passThrough||(this._dirtyBlend=addUniqueMeshInstance(this._meshInstances,this._meshInstancesSet,layer.opaqueMeshInstances)||this._dirtyBlend,this._dirtyBlend=addUniqueMeshInstance(this._meshInstances,this._meshInstancesSet,layer.transparentMeshInstances)||this._dirtyBlend),layer._dirty=!1;this._dirty=!1}function moveByBlendType(dest,src,moveTransparent){for(var material,isTransparent,s=0;s<src.length;)(isTransparent=(material=src[s].material)&&3!==material.blendType)===moveTransparent?(dest.push(src[s]),src[s]=src[src.length-1],src.length--):s++}if(this._dirtyBlend){for(result|=8,i=0;i<len;i++)(layer=this.layerList[i]).passThrough||(moveByBlendType(layer.opaqueMeshInstances,layer.transparentMeshInstances,!1),moveByBlendType(layer.transparentMeshInstances,layer.opaqueMeshInstances,!0));this._dirtyBlend=!1}if(this._dirtyLights&&(result|=2,this._dirtyLights=!1,this.updateLights()),result&&this.updateShadowCasters(),this._dirtyCameras||2&result){for(this._dirtyCameras=!1,result|=4,this.cameras.length=0,i=0;i<len;i++)for((layer=this.layerList[i])._dirtyCameras=!1,j=0;j<layer.cameras.length;j++)camera=layer.cameras[j],(index=this.cameras.indexOf(camera))<0&&this.cameras.push(camera);this.cameras.length>1&&this.cameras.sort((function(a,b){return a.priority-b.priority}));var cameraLayers=[],renderActionCount=0;for(i=0;i<this.cameras.length;i++){camera=this.cameras[i],cameraLayers.length=0;var cameraFirstRenderAction=!0,cameraFirstRenderActionIndex=renderActionCount,lastRenderAction=null,postProcessMarked=!1;for(j=0;j<len;j++)(layer=this.layerList[j])&&layer.cameras.length>0&&camera.layers.indexOf(layer.id)>=0&&(cameraLayers.push(layer),postProcessMarked||layer.id!==camera.disablePostEffectsLayer||(postProcessMarked=!0,lastRenderAction&&(lastRenderAction.triggerPostprocess=!0)),(cameraIndex=layer.cameras.indexOf(camera))>=0&&(lastRenderAction=this.addRenderAction(this._renderActions,renderActionCount,layer,j,cameraIndex,cameraFirstRenderAction,postProcessMarked),renderActionCount++,cameraFirstRenderAction=!1));cameraFirstRenderActionIndex<renderActionCount&&this._renderActions[cameraFirstRenderActionIndex].collectDirectionalLights(cameraLayers,this._splitLights[0],this._lights),!postProcessMarked&&lastRenderAction&&(lastRenderAction.triggerPostprocess=!0),camera.renderTarget&&camera.postEffectsEnabled&&this.propagateRenderTarget(cameraFirstRenderActionIndex-1,camera)}this._renderActions.length=renderActionCount,LayerComposition.clusteredLightingEnabled&&this.allocateLightClusters()}return(2&result||4&result)&&this._logRenderActions(),result},_proto.updateShadowCasters=function updateShadowCasters(){for(var lightCount=this._lights.length,i=0;i<lightCount;i++)this._lightCompositionData[i].clearShadowCasters();for(var len=this.layerList.length,_i=0;_i<len;_i++){var layer=this.layerList[_i];if(!tempSet$1.has(layer)){tempSet$1.add(layer);for(var lights=layer._lights,j=0;j<lights.length;j++)if(lights[j].castShadows){var lightIndex=this._lightsMap.get(lights[j]),lightCompData;this._lightCompositionData[lightIndex].addShadowCasters(layer.shadowCasters)}}}tempSet$1.clear()},_proto.updateLights=function updateLights(){this._lights.length=0,this._lightsMap.clear();for(var count=this.layerList.length,i=0;i<count;i++){var layer=this.layerList[i];if(!tempSet$1.has(layer)){tempSet$1.add(layer);for(var lights=layer._lights,j=0;j<lights.length;j++){var light=lights[j],lightIndex=this._lightsMap.get(light);if(void 0===lightIndex){lightIndex=this._lights.length,this._lightsMap.set(light,lightIndex),this._lights.push(light);var lightCompData=this._lightCompositionData[lightIndex];lightCompData||(lightCompData=new LightCompositionData,this._lightCompositionData[lightIndex]=lightCompData)}}}this._splitLightsArray(layer),layer._dirtyLights=!1}tempSet$1.clear(),this._splitLightsArray(this);var lightCount=this._lights.length;this._lightCompositionData.length=lightCount},_proto.findCompatibleCluster=function findCompatibleCluster(layer,renderActionCount){for(var i=0;i<renderActionCount;i++){var ra=this._renderActions[i],raLayer=this.layerList[ra.layerIndex];if(layer===raLayer)return ra.lightClusters;if(ra.lightClusters&&set_equals(layer._clusteredLightsSet,raLayer._clusteredLightsSet))return ra.lightClusters}return null},_proto.allocateLightClusters=function allocateLightClusters(){tempClusterArray.push.apply(tempClusterArray,this._worldClusters),this._worldClusters.length=0;for(var count=this._renderActions.length,i=0;i<count;i++){var ra=this._renderActions[i],layer=this.layerList[ra.layerIndex],transparent,meshInstances;if(layer._clusteredLightsSet.size)if((this.subLayerList[ra.layerIndex]?layer.transparentMeshInstances:layer.opaqueMeshInstances).length){var clusters=this.findCompatibleCluster(layer,i);clusters||(tempClusterArray.length&&(clusters=tempClusterArray.pop()),clusters||(clusters=new WorldClusters(this.device,this._clusteredLightingCells,this._clusteredLightingMaxLights)),clusters.name="Cluster-"+this._worldClusters.length,this._worldClusters.push(clusters)),ra.lightClusters=clusters}ra.lightClusters||(ra.lightClusters=this.emptyWorldClusters)}tempClusterArray.forEach((function(item){return item.destroy()})),tempClusterArray.length=0},_proto.addRenderAction=function addRenderAction(renderActions,renderActionIndex,layer,layerIndex,cameraIndex,cameraFirstRenderAction,postProcessMarked){var renderAction=renderActions[renderActionIndex];renderAction||(renderAction=renderActions[renderActionIndex]=new RenderAction);var rt=layer.renderTarget,camera=layer.cameras[cameraIndex];camera&&camera.renderTarget&&1!==layer.id&&(rt=camera.renderTarget);for(var used=!1,i=renderActionIndex-1;i>=0;i--)if(renderActions[i].camera===camera&&renderActions[i].renderTarget===rt){used=!0;break}var needsClear=cameraFirstRenderAction||!used,clearColor=!!needsClear&&camera.clearColorBuffer,clearDepth=!!needsClear&&camera.clearDepthBuffer,clearStencil=!!needsClear&&camera.clearStencilBuffer;return clearColor|=layer.clearColorBuffer,clearDepth|=layer.clearDepthBuffer,clearStencil|=layer.clearStencilBuffer,postProcessMarked&&camera.postEffectsEnabled&&(rt=null),renderAction.reset(),renderAction.triggerPostprocess=!1,renderAction.layerIndex=layerIndex,renderAction.cameraIndex=cameraIndex,renderAction.camera=camera,renderAction.renderTarget=rt,renderAction.clearColor=clearColor,renderAction.clearDepth=clearDepth,renderAction.clearStencil=clearStencil,renderAction.firstCameraUse=cameraFirstRenderAction,renderAction},_proto.propagateRenderTarget=function propagateRenderTarget(startIndex,fromCamera){for(var a=startIndex;a>=0;a--){var ra=this._renderActions[a],layer=this.layerList[ra.layerIndex];if(ra.renderTarget&&1!==layer.id)break;if(1!==layer.id){var thisCamera=null==ra?void 0:ra.camera.camera;if(thisCamera&&(!fromCamera.camera.rect.equals(thisCamera.rect)||!fromCamera.camera.scissorRect.equals(thisCamera.scissorRect)))break;ra.renderTarget=fromCamera.renderTarget}}},_proto._logRenderActions=function _logRenderActions(){},_proto._isLayerAdded=function _isLayerAdded(layer){return this.layerList.indexOf(layer)>=0},_proto._isSublayerAdded=function _isSublayerAdded(layer,transparent){for(var i=0;i<this.layerList.length;i++)if(this.layerList[i]===layer&&this.subLayerList[i]===transparent)return!0;return!1},_proto.push=function push(layer){this._isLayerAdded(layer)||(this.layerList.push(layer),this.layerList.push(layer),this._opaqueOrder[layer.id]=this.subLayerList.push(!1)-1,this._transparentOrder[layer.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this.subLayerEnabled.push(!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",layer))},_proto.insert=function insert(layer,index){if(!this._isLayerAdded(layer)){this.layerList.splice(index,0,layer,layer),this.subLayerList.splice(index,0,!1,!0);var count=this.layerList.length;this._updateOpaqueOrder(index,count-1),this._updateTransparentOrder(index,count-1),this.subLayerEnabled.splice(index,0,!0,!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",layer)}},_proto.remove=function remove(layer){var id=this.layerList.indexOf(layer);for(delete this._opaqueOrder[id],delete this._transparentOrder[id];id>=0;)this.layerList.splice(id,1),this.subLayerList.splice(id,1),this.subLayerEnabled.splice(id,1),id=this.layerList.indexOf(layer),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("remove",layer);var count=this.layerList.length;this._updateOpaqueOrder(0,count-1),this._updateTransparentOrder(0,count-1)},_proto.pushOpaque=function pushOpaque(layer){this._isSublayerAdded(layer,!1)||(this.layerList.push(layer),this._opaqueOrder[layer.id]=this.subLayerList.push(!1)-1,this.subLayerEnabled.push(!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",layer))},_proto.insertOpaque=function insertOpaque(layer,index){if(!this._isSublayerAdded(layer,!1)){this.layerList.splice(index,0,layer),this.subLayerList.splice(index,0,!1);var count=this.subLayerList.length;this._updateOpaqueOrder(index,count-1),this.subLayerEnabled.splice(index,0,!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",layer)}},_proto.removeOpaque=function removeOpaque(layer){for(var i=0,len=this.layerList.length;i<len;i++)if(this.layerList[i]===layer&&!this.subLayerList[i])return this.layerList.splice(i,1),this.subLayerList.splice(i,1),len--,this._updateOpaqueOrder(i,len-1),this.subLayerEnabled.splice(i,1),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,void(this.layerList.indexOf(layer)<0&&this.fire("remove",layer))},_proto.pushTransparent=function pushTransparent(layer){this._isSublayerAdded(layer,!0)||(this.layerList.push(layer),this._transparentOrder[layer.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",layer))},_proto.insertTransparent=function insertTransparent(layer,index){if(!this._isSublayerAdded(layer,!0)){this.layerList.splice(index,0,layer),this.subLayerList.splice(index,0,!0);var count=this.subLayerList.length;this._updateTransparentOrder(index,count-1),this.subLayerEnabled.splice(index,0,!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",layer)}},_proto.removeTransparent=function removeTransparent(layer){for(var i=0,len=this.layerList.length;i<len;i++)if(this.layerList[i]===layer&&this.subLayerList[i])return this.layerList.splice(i,1),this.subLayerList.splice(i,1),len--,this._updateTransparentOrder(i,len-1),this.subLayerEnabled.splice(i,1),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,void(this.layerList.indexOf(layer)<0&&this.fire("remove",layer))},_proto._getSublayerIndex=function _getSublayerIndex(layer,transparent){var id=this.layerList.indexOf(layer);if(id<0)return-1;if(this.subLayerList[id]!==transparent){if((id=this.layerList.indexOf(layer,id+1))<0)return-1;if(this.subLayerList[id]!==transparent)return-1}return id},_proto.getOpaqueIndex=function getOpaqueIndex(layer){return this._getSublayerIndex(layer,!1)},_proto.getTransparentIndex=function getTransparentIndex(layer){return this._getSublayerIndex(layer,!0)},_proto.getLayerById=function getLayerById(id){for(var i=0;i<this.layerList.length;i++)if(this.layerList[i].id===id)return this.layerList[i];return null},_proto.getLayerByName=function getLayerByName(name){for(var i=0;i<this.layerList.length;i++)if(this.layerList[i].name===name)return this.layerList[i];return null},_proto._updateOpaqueOrder=function _updateOpaqueOrder(startIndex,endIndex){for(var i=startIndex;i<=endIndex;i++)!1===this.subLayerList[i]&&(this._opaqueOrder[this.layerList[i].id]=i)},_proto._updateTransparentOrder=function _updateTransparentOrder(startIndex,endIndex){for(var i=startIndex;i<=endIndex;i++)!0===this.subLayerList[i]&&(this._transparentOrder[this.layerList[i].id]=i)},_proto._sortLayersDescending=function _sortLayersDescending(layersA,layersB,order){var i=0,len=0,id=0,topLayerA=-1,topLayerB=-1;for(i=0,len=layersA.length;i<len;i++)id=layersA[i],order.hasOwnProperty(id)&&(topLayerA=Math.max(topLayerA,order[id]));for(i=0,len=layersB.length;i<len;i++)id=layersB[i],order.hasOwnProperty(id)&&(topLayerB=Math.max(topLayerB,order[id]));return-1===topLayerA&&-1!==topLayerB?1:-1===topLayerB&&-1!==topLayerA?-1:topLayerB-topLayerA},_proto.sortTransparentLayers=function sortTransparentLayers(layersA,layersB){return this._sortLayersDescending(layersA,layersB,this._transparentOrder)},_proto.sortOpaqueLayers=function sortOpaqueLayers(layersA,layersB){return this._sortLayersDescending(layersA,layersB,this._opaqueOrder)},_createClass(LayerComposition,[{key:"clusteredLightingCells",get:function get(){return this._clusteredLightingCells},set:function set(value){this._clusteredLightingCells.equals(value)||(this._clusteredLightingCells.copy(value),this.updateWorldClusters())}},{key:"clusteredLightingMaxLights",get:function get(){return this._clusteredLightingMaxLights},set:function set(value){this._clusteredLightingMaxLights!==value&&(this._clusteredLightingMaxLights=value,this.updateWorldClusters())}},{key:"emptyWorldClusters",get:function get(){return this._emptyWorldClusters||(this._emptyWorldClusters=new WorldClusters(this.device,new Vec3(1,1,1),4),this._emptyWorldClusters.name="ClusterEmpty",this._emptyWorldClusters.update([],!1)),this._emptyWorldClusters}}]),LayerComposition}(EventHandler);LayerComposition.clusteredLightingEnabled=!1;var _oldChunkFloat=function _oldChunkFloat(s,o,p){return"\n#ifdef MAPFLOAT\n"+s+"\n#else\n"+shaderChunks[o]+"\n#endif\n"},_oldChunkColor=function _oldChunkColor(s,o,p){return"\n#ifdef MAPCOLOR\n"+s+"\n#else\n"+shaderChunks[o]+"\n#endif\n"},_oldChunkTex=function _oldChunkTex(s,o,p){return"\n#ifdef MAPTEXTURE\n"+s+"\n#else\n"+shaderChunks[o]+"\n#endif\n"},_oldChunkTexColor=function _oldChunkTexColor(s,o,p){return"#undef MAPTEXTURECOLOR\n#ifdef MAPTEXTURE\n#ifdef MAPCOLOR\n#define MAPTEXTURECOLOR\n#endif\n#endif\n#ifdef MAPTEXTURECOLOR\n"+s+"\n#else\n"+shaderChunks[o]+"\n#endif\n"},_oldChunkTexFloat=function _oldChunkTexFloat(s,o,p){return"#undef MAPTEXTUREFLOAT\n#ifdef MAPTEXTURE\n#ifdef MAPFLOAT\n#define MAPTEXTUREFLOAT\n#endif\n#endif\n#ifdef MAPTEXTUREFLOAT\n"+s+"\n#else\n"+shaderChunks[o]+"\n#endif\n"},_oldChunkVert=function _oldChunkVert(s,o,p){return"\n#ifdef MAPVERTEX\n"+s+"\n#else\n"+shaderChunks[o]+"\n#endif\n"},_oldChunkVertColor=function _oldChunkVertColor(s,o,p){return"#undef MAPVERTEXCOLOR\n#ifdef MAPVERTEX\n#ifdef MAPCOLOR\n#define MAPVERTEXCOLOR\n#endif\n#endif\n#ifdef MAPVERTEXCOLOR\n"+s+"\n#else\n"+shaderChunks[o]+"\n#endif\n"},_oldChunkVertFloat=function _oldChunkVertFloat(s,o,p){return"#undef MAPVERTEXFLOAT\n#ifdef MAPVERTEX\n#ifdef MAPFLOAT\n#define MAPVERTEXFLOAT\n#endif\n#endif\n#ifdef MAPVERTEXFLOAT\n"+s+"\n#else\n"+shaderChunks[o]+"\n#endif\n"},_oldChunkTransformSkin,_oldChunkTransformDynbatch,_oldChunkTransformInstanced,_oldChunkTransformPixelSnap,_oldChunkTransformScreenSpace,_oldChunkTransformScreenSpaceBatch,_oldChunkTransformUv1,_matTex2D=[],standard={_oldChunkToNew:{aoTexPS:{n:"aoPS",f:_oldChunkTex},aoVertPS:{n:"aoPS",f:_oldChunkVert},diffuseConstPS:{n:"diffusePS",f:_oldChunkColor},diffuseTexPS:{n:"diffusePS",f:_oldChunkTex},diffuseTexConstPS:{n:"diffusePS",f:_oldChunkTexColor},diffuseVertPS:{n:"diffusePS",f:_oldChunkVert},diffuseVertConstPS:{n:"diffusePS",f:_oldChunkVertColor},emissiveConstPS:{n:"emissivePS",f:_oldChunkColor},emissiveTexPS:{n:"emissivePS",f:_oldChunkTex},emissiveTexConstPS:{n:"emissivePS",f:_oldChunkTexColor},emissiveTexConstFloatPS:{n:"emissivePS",f:_oldChunkTexFloat},emissiveVertPS:{n:"emissivePS",f:_oldChunkVert},emissiveVertConstPS:{n:"emissivePS",f:_oldChunkVertColor},emissiveVertConstFloatPS:{n:"emissivePS",f:_oldChunkVertFloat},glossConstPS:{n:"glossPS",f:_oldChunkFloat},glossTexPS:{n:"glossPS",f:_oldChunkTex},glossTexConstPS:{n:"glossPS",f:_oldChunkTexFloat},glossVertPS:{n:"glossPS",f:_oldChunkVert},glossVertConstPS:{n:"glossPS",f:_oldChunkVertFloat},metalnessConstPS:{n:"metalnessPS",f:_oldChunkFloat},metalnessTexPS:{n:"metalnessPS",f:_oldChunkTex},metalnessTexConstPS:{n:"metalnessPS",f:_oldChunkTexFloat},metalnessVertPS:{n:"metalnessPS",f:_oldChunkVert},metalnessVertConstPS:{n:"metalnessPS",f:_oldChunkVertFloat},opacityConstPS:{n:"opacityPS",f:_oldChunkFloat},opacityTexPS:{n:"opacityPS",f:_oldChunkTex},opacityTexConstPS:{n:"opacityPS",f:_oldChunkTexFloat},opacityVertPS:{n:"opacityPS",f:_oldChunkVert},opacityVertConstPS:{n:"opacityPS",f:_oldChunkVertFloat},specularConstPS:{n:"specularPS",f:_oldChunkColor},specularTexPS:{n:"specularPS",f:_oldChunkTex},specularTexConstPS:{n:"specularPS",f:_oldChunkTexColor},specularVertPS:{n:"specularPS",f:_oldChunkVert},specularVertConstPS:{n:"specularPS",f:_oldChunkVertColor},transformBatchSkinnedVS:{n:"transformVS",f:function _oldChunkTransformDynbatch(s,o,p){return"\n#ifdef DYNAMICBATCH\n"+s+"\n#else\n"+shaderChunks[o]+"\n#endif\n"}},transformInstancedVS:{n:"transformVS",f:function _oldChunkTransformInstanced(s,o,p){return"\n#ifdef INSTANCING\n"+s+"\n#else\n"+shaderChunks[o]+"\n#endif\n"}},transformPixelSnapVS:{n:"transformVS",f:function _oldChunkTransformPixelSnap(s,o,p){return"\n#ifdef PIXELSNAP\n"+s+"\n#else\n"+shaderChunks[o]+"\n#endif\n"}},transformScreenSpaceVS:{n:"transformVS",f:function _oldChunkTransformScreenSpace(s,o,p){return"\n#ifdef SCREENSPACE\n"+s+"\n#else\n"+shaderChunks[o]+"\n#endif\n"}},transformScreenSpaceBatchSkinned:{n:"transformVS",f:function _oldChunkTransformScreenSpaceBatch(s,o,p){return"#undef SCREENSPACEBATCH\n#ifdef SCREENSPACE\n#ifdef BATCH\n#define SCREENSPACEBATCH\n#endif\n#endif\n#ifdef SCREENSPACEBATCH\n"+s+"\n#else\n"+shaderChunks[o]+"\n#endif\n"}},transformSkinned:{n:"transformVS",f:function _oldChunkTransformSkin(s,o,p){return"\n#ifdef SKIN\n"+s+"\n#else\n"+shaderChunks[o]+"\n#endif\n"}},transformUv1:{n:"transformVS",f:function _oldChunkTransformUv1(s,o,p){return"\n#ifdef UV1LAYOUT\n"+s+"\n#else\n"+shaderChunks[o]+"\n#endif\n"}}},optionsContext:{},optionsContextMin:{},generateKey:function generateKey(options){var buildPropertiesList=function buildPropertiesList(options){var props=[];for(var prop in options)options.hasOwnProperty(prop)&&"chunks"!==prop&&"lights"!==prop&&props.push(prop);return props.sort()},props;options===this.optionsContextMin?(this.propsMin||(this.propsMin=buildPropertiesList(options)),props=this.propsMin):options===this.optionsContext?(this.props||(this.props=buildPropertiesList(options)),props=this.props):props=buildPropertiesList(options);var key="standard",i;for(i=0;i<props.length;i++)options[props[i]]&&(key+=props[i]+options[props[i]]);if(options.chunks){var chunks=[];for(var p in options.chunks)options.chunks.hasOwnProperty(p)&&chunks.push(p+options.chunks[p]);chunks.sort(),key+=chunks}if(options.lights)for(i=0;i<options.lights.length;i++)key+=options.lights[i].key;return hashCode(key)},_correctChannel:function _correctChannel(p,chan){if(_matTex2D[p]>0){if(_matTex2D[p]<chan.length)return chan.substring(0,_matTex2D[p]);if(_matTex2D[p]>chan.length){for(var str=chan,chr=str.charAt(str.length-1),addLen=_matTex2D[p]-str.length,i=0;i<addLen;i++)str+=chr;return str}return chan}},_setMapTransform:function _setMapTransform(codes,name,id,uv){codes[0]+="uniform vec4 texture_"+name+"MapTransform;\n";var checkId=id+100*uv;return codes[3][checkId]||(codes[1]+="varying vec2 vUV"+uv+"_"+id+";\n",codes[2]+="\t vUV"+uv+"_"+id+" = uv"+uv+" * texture_"+name+"MapTransform.xy + texture_"+name+"MapTransform.zw;\n",codes[3][checkId]=!0),codes},_getUvSourceExpression:function _getUvSourceExpression(transformPropName,uVPropName,options){var transformId=options[transformPropName],uvChannel=options[uVPropName],expression,isMainPass=0===options.pass||1===options.pass;return isMainPass&&1===options.nineSlicedMode?expression="nineSlicedUv":isMainPass&&2===options.nineSlicedMode?expression="nineSlicedUv, -1000.0":(expression=0===transformId?"vUv"+uvChannel:"vUV"+uvChannel+"_"+transformId,options.heightMap&&"heightMapTransform"!==transformPropName&&(expression+=" + dUvOffset")),expression},_addMapDef:function _addMapDef(name,enabled){var s="\n#undef "+name+"\n";return enabled&&(s+=" #define "+name+"\n"),s},_addMapDefs:function _addMapDefs(float,color,vertex,map){var s="";return s+=this._addMapDef("MAPFLOAT",float),s+=this._addMapDef("MAPCOLOR",color),s+=this._addMapDef("MAPVERTEX",vertex),s+=this._addMapDef("MAPTEXTURE",map)},_addMap:function _addMap(propName,chunkName,options,chunks,samplerFormat){var mapPropName=propName+"Map",uVPropName=mapPropName+"Uv",transformPropName=mapPropName+"Transform",channelPropName=mapPropName+"Channel",vertexColorChannelPropName=propName+"VertexColorChannel",tintPropName,vertexColorPropName=propName+"VertexColor",detailModePropName=propName+"Mode",tintOption=options[propName+"Tint"],vertexColorOption=options[vertexColorPropName],textureOption=options[mapPropName],detailModeOption=options[detailModePropName],subCode=chunks[chunkName];if(textureOption){var uv=this._getUvSourceExpression(transformPropName,uVPropName,options);if(subCode=subCode.replace(/\$UV/g,uv).replace(/\$CH/g,options[channelPropName]),void 0!==samplerFormat){var fmt=0===samplerFormat?"texture2DSRGB":1===samplerFormat?"texture2DRGBM":"texture2D";subCode=subCode.replace(/\$texture2DSAMPLE/g,fmt)}}vertexColorOption&&(subCode=subCode.replace(/\$VC/g,options[vertexColorChannelPropName])),detailModeOption&&(subCode=subCode.replace(/\$DETAILMODE/g,detailModeOption));var isFloatTint=1===tintOption,isVecTint=3===tintOption;return(subCode=this._addMapDefs(isFloatTint,isVecTint,vertexColorOption,textureOption)+subCode).replace(/\$/g,"")},_directionalShadowMapProjection:function _directionalShadowMapProjection(light,shadowCoordArgs,shadowParamArg,lightIndex,coordsFunctioName){var code="";return light.numCascades>1&&(code+="getShadowCascadeMatrix(light"+lightIndex+"_shadowMatrixPalette, light"+lightIndex+"_shadowCascadeDistances, light"+lightIndex+"_shadowCascadeCount);\n",shadowCoordArgs="(cascadeShadowMat, "+shadowParamArg+");\n"),code+=coordsFunctioName+shadowCoordArgs,code+="fadeShadow(light"+lightIndex+"_shadowCascadeDistances);\n"},_nonPointShadowMapProjection:function _nonPointShadowMapProjection(device,light,shadowMatArg,shadowParamArg,lightIndex){var shadowCoordArgs="("+shadowMatArg+", "+shadowParamArg+");\n";return!light._normalOffsetBias||light._isVsm?2===light._type?light._isPcf&&(device.webgl2||device.extStandardDerivatives)?"\t\t\t getShadowCoordPerspZbuffer"+shadowCoordArgs:"\t\t\t getShadowCoordPersp"+shadowCoordArgs:this._directionalShadowMapProjection(light,shadowCoordArgs,shadowParamArg,lightIndex,"getShadowCoordOrtho"):2===light._type?light._isPcf&&(device.webgl2||device.extStandardDerivatives)?"\t\t\t getShadowCoordPerspZbufferNormalOffset"+shadowCoordArgs:"\t\t\t getShadowCoordPerspNormalOffset"+shadowCoordArgs:this._directionalShadowMapProjection(light,shadowCoordArgs,shadowParamArg,lightIndex,"getShadowCoordOrthoNormalOffset")},_addVaryingIfNeeded:function _addVaryingIfNeeded(code,type,name){return code.indexOf(name)>=0?"varying "+type+" "+name+";\n":""},_getLightSourceShapeString:function _getLightSourceShapeString(shape){switch(shape){case 1:return"Rect";case 2:return"Disk";case 3:return"Sphere";default:return""}},_vsAddTransformCode:function _vsAddTransformCode(code,device,chunks,options){return code+=chunks.transformVS},_vsAddBaseCode:function _vsAddBaseCode(code,device,chunks,options){return code+=chunks.baseVS,1!==options.nineSlicedMode&&2!==options.nineSlicedMode||(code+=chunks.baseNineSlicedVS),code},_fsAddBaseCode:function _fsAddBaseCode(code,device,chunks,options){return code+=chunks.basePS,1===options.nineSlicedMode?code+=chunks.baseNineSlicedPS:2===options.nineSlicedMode&&(code+=chunks.baseNineSlicedTiledPS),code},_fsAddStartCode:function _fsAddStartCode(code,device,chunks,options){return code+=chunks.startPS,1===options.nineSlicedMode?code+=chunks.startNineSlicedPS:2===options.nineSlicedMode&&(code+=chunks.startNineSlicedTiledPS),code},createShaderDefinition:function createShaderDefinition(device,options){var i,p,lighting=options.lights.length>0;options.dirLightMap&&(lighting=!0),LayerComposition.clusteredLightingEnabled&&(lighting=!0),0===options.shadingModel?(options.fresnelModel=0,options.specularAntialias=!1,options.prefilteredCubemap=!1,options.dpAtlas=!1,options.ambientSH=!1):options.fresnelModel=0===options.fresnelModel?2:options.fresnelModel;var cubemapReflection=(options.cubeMap||options.prefilteredCubemap&&options.useSpecular)&&!options.sphereMap&&!options.dpAtlas,reflections=options.sphereMap||cubemapReflection||options.dpAtlas,useTexCubeLod=options.useTexCubeLod;options.cubeMap&&(options.sphereMap=null),options.dpAtlas&&(options.prefilteredCubemap=null),options.useSpecular||(options.specularMap=options.glossMap=null);var needsNormal=lighting||reflections||options.ambientSH||options.prefilteredCubemap||options.heightMap||options.enableGGXSpecular,shadowPass=options.pass>=3&&options.pass<=17;this.options=options;var code="",codeBody="",varyings="",chunks=shaderChunks,lightType,shadowCoordArgs,chunk,attributes={vertex_position:"POSITION"};if(options.chunks){var customChunks={},newP;for(p in chunks)chunks.hasOwnProperty(p)&&(options.chunks[p]?((chunk=options.chunks[p]).indexOf("vertex_normal")>=0&&(attributes.vertex_normal="NORMAL"),chunk.indexOf("vertex_tangent")>=0&&(attributes.vertex_tangent="TANGENT"),chunk.indexOf("vertex_texCoord0")>=0&&(attributes.vertex_texCoord0="TEXCOORD0"),chunk.indexOf("vertex_texCoord1")>=0&&(attributes.vertex_texCoord1="TEXCOORD1"),chunk.indexOf("vertex_color")>=0&&(attributes.vertex_color="COLOR"),chunk.indexOf("vertex_boneWeights")>=0&&(attributes.vertex_boneWeights="BLENDWEIGHT"),chunk.indexOf("vertex_boneIndices")>=0&&(attributes.vertex_boneIndices="BLENDINDICES"),customChunks[p]=chunk):customChunks[p]=chunks[p]);for(p in options.chunks)(newP=this._oldChunkToNew[p])&&(customChunks[newP.n]=newP.f(options.chunks[p],newP.n,p));chunks=customChunks}code=this._vsAddBaseCode(code,device,chunks,options),codeBody+="\t vPositionW\t\t= getWorldPosition();\n",2===options.pass&&(code+="varying float vDepth;\n",code+="#ifndef VIEWMATRIX\n",code+="#define VIEWMATRIX\n",code+="uniform mat4 matrix_view;\n",code+="#endif\n",code+="#ifndef CAMERAPLANES\n",code+="#define CAMERAPLANES\n",code+="uniform vec4 camera_params;\n\n",code+="#endif\n",codeBody+="\t\tvDepth = -(matrix_view * vec4(vPositionW,1.0)).z * camera_params.x;\n"),options.useInstancing&&(attributes.instance_line1="TEXCOORD2",attributes.instance_line2="TEXCOORD3",attributes.instance_line3="TEXCOORD4",attributes.instance_line4="TEXCOORD5",code+=chunks.instancingVS),needsNormal&&(attributes.vertex_normal="NORMAL",codeBody+="\t vNormalW = getNormal();\n",options.sphereMap&&device.fragmentUniformsCount<=16&&(code+=chunks.viewNormalVS,codeBody+="\t vNormalV\t\t= getViewNormal();\n"),(options.heightMap||options.normalMap||options.enableGGXSpecular)&&options.hasTangents?(attributes.vertex_tangent="TANGENT",code+=chunks.tangentBinormalVS,codeBody+="\t vTangentW\t = getTangent();\n",codeBody+="\t vBinormalW\t= getBinormal();\n"):options.enableGGXSpecular&&(code+=chunks.tangentBinormalVS,codeBody+="\t vObjectSpaceUpW\t= getObjectSpaceUp();\n"));var useUv=[],useUnmodifiedUv=[],maxUvSets=2,cname,mname,tname,uname;for(p in _matTex2D)if(mname=p+"Map",options[p+"VertexColor"]&&(options[cname=p+"VertexColorChannel"]=this._correctChannel(p,options[cname])),options[mname]){cname=mname+"Channel",tname=mname+"Transform",options[uname=mname+"Uv"]=Math.min(options[uname],1),options[cname]=this._correctChannel(p,options[cname]);var uvSet=options[uname];useUv[uvSet]=!0,useUnmodifiedUv[uvSet]=useUnmodifiedUv[uvSet]||options[mname]&&!options[tname]}for(options.forceUv1&&(useUv[1]=!0,useUnmodifiedUv[1]=void 0===useUnmodifiedUv[1]||useUnmodifiedUv[1]),i=0;i<2;i++)useUv[i]&&(attributes["vertex_texCoord"+i]="TEXCOORD"+i,code+=chunks["uv"+i+"VS"],codeBody+="\t vec2 uv"+i+" = getUv"+i+"();\n"),useUnmodifiedUv[i]&&(codeBody+="\t vUv"+i+" = uv"+i+";\n");var codes=[code,varyings,codeBody,[]];for(p in _matTex2D)options[mname=p+"Map"]&&options[tname=mname+"Transform"]&&(uname=mname+"Uv",this._setMapTransform(codes,p,options[tname],options[uname]));code=codes[0],varyings=codes[1],codeBody=codes[2],options.vertexColors&&(attributes.vertex_color="COLOR",codeBody+="\t vVertexColor = vertex_color;\n"),(options.useMorphPosition||options.useMorphNormal)&&(options.useMorphTextureBased?(code+="#define MORPHING_TEXTURE_BASED\n",options.useMorphPosition&&(code+="#define MORPHING_TEXTURE_BASED_POSITION\n"),options.useMorphNormal&&(code+="#define MORPHING_TEXTURE_BASED_NORMAL\n"),attributes.morph_vertex_id="ATTR15",code+="attribute float morph_vertex_id;\n"):(code+="#define MORPHING\n",options.useMorphPosition?(attributes.morph_pos0="ATTR8",attributes.morph_pos1="ATTR9",attributes.morph_pos2="ATTR10",attributes.morph_pos3="ATTR11",code+="#define MORPHING_POS03\n",code+="attribute vec3 morph_pos0;\n",code+="attribute vec3 morph_pos1;\n",code+="attribute vec3 morph_pos2;\n",code+="attribute vec3 morph_pos3;\n"):options.useMorphNormal&&(attributes.morph_nrm0="ATTR8",attributes.morph_nrm1="ATTR9",attributes.morph_nrm2="ATTR10",attributes.morph_nrm3="ATTR11",code+="#define MORPHING_NRM03\n",code+="attribute vec3 morph_nrm0;\n",code+="attribute vec3 morph_nrm1;\n",code+="attribute vec3 morph_nrm2;\n",code+="attribute vec3 morph_nrm3;\n"),options.useMorphNormal?(attributes.morph_nrm4="ATTR12",attributes.morph_nrm5="ATTR13",attributes.morph_nrm6="ATTR14",attributes.morph_nrm7="ATTR15",code+="#define MORPHING_NRM47\n",code+="attribute vec3 morph_nrm4;\n",code+="attribute vec3 morph_nrm5;\n",code+="attribute vec3 morph_nrm6;\n",code+="attribute vec3 morph_nrm7;\n"):(attributes.morph_pos4="ATTR12",attributes.morph_pos5="ATTR13",attributes.morph_pos6="ATTR14",attributes.morph_pos7="ATTR15",code+="#define MORPHING_POS47\n",code+="attribute vec3 morph_pos4;\n",code+="attribute vec3 morph_pos5;\n",code+="attribute vec3 morph_pos6;\n",code+="attribute vec3 morph_pos7;\n"))),options.skin?(attributes.vertex_boneWeights="BLENDWEIGHT",attributes.vertex_boneIndices="BLENDINDICES",code+=skinCode(device,chunks),code+="#define SKIN\n"):options.useInstancing&&(code+="#define INSTANCING\n"),options.screenSpace&&(code+="#define SCREENSPACE\n"),options.pixelSnap&&(code+="#define PIXELSNAP\n"),code=this._vsAddTransformCode(code,device,chunks,options),needsNormal&&(code+=chunks.normalVS),code+="\n",code+=chunks.startVS,code+=codeBody,code+=chunks.endVS;var vshader=code+="}",oldVars=varyings;varyings="",varyings+=this._addVaryingIfNeeded(code,"vec4","vVertexColor"),varyings+=this._addVaryingIfNeeded(code,"vec3","vPositionW"),varyings+=this._addVaryingIfNeeded(code,"vec3","vNormalV"),varyings+=this._addVaryingIfNeeded(code,"vec3","vNormalW"),varyings+=this._addVaryingIfNeeded(code,"vec3","vTangentW"),varyings+=this._addVaryingIfNeeded(code,"vec3","vBinormalW"),varyings+=this._addVaryingIfNeeded(code,"vec3","vObjectSpaceUpW"),varyings+=this._addVaryingIfNeeded(code,"vec2","vUv0"),varyings+=this._addVaryingIfNeeded(code,"vec2","vUv1"),vshader=(varyings+=oldVars)+vshader;var startCode="",fshader;if(device.webgl2?(startCode=versionCode(device),chunks.extensionVS&&(startCode+=chunks.extensionVS+"\n"),vshader=startCode+chunks.gles3VS+vshader):(chunks.extensionVS&&(startCode=chunks.extensionVS+"\n"),vshader=startCode+vshader),options.forceFragmentPrecision&&"highp"!==options.forceFragmentPrecision&&"mediump"!==options.forceFragmentPrecision&&"lowp"!==options.forceFragmentPrecision&&(options.forceFragmentPrecision=null),options.forceFragmentPrecision&&("highp"===options.forceFragmentPrecision&&"highp"!==device.maxPrecision&&(options.forceFragmentPrecision="mediump"),"mediump"===options.forceFragmentPrecision&&"lowp"===device.maxPrecision&&(options.forceFragmentPrecision="lowp")),code="",device.webgl2&&(code+=versionCode(device)),device.extStandardDerivatives&&!device.webgl2&&(code+="#extension GL_OES_standard_derivatives : enable\n\n"),chunks.extensionPS&&(code+=chunks.extensionPS+"\n"),device.webgl2&&(code+=chunks.gles3PS),code+=options.forceFragmentPrecision?"precision "+options.forceFragmentPrecision+" float;\n\n":precisionCode(device),18===options.pass)return code+="uniform vec4 uColor;\n",code+=varyings,options.alphaTest&&(code+="float dAlpha;\n",code+=this._addMap("opacity","opacityPS",options,chunks),code+=chunks.alphaTestPS),code+="void main(void)\n{\n",options.alphaTest&&(code+="\t getOpacity();\n",code+="\t alphaTest(dAlpha);\n"),code+="\t\tgl_FragColor = uColor;\n",{attributes:attributes,vshader:vshader,fshader:code+="}\n"};if(2===options.pass)return code+="varying float vDepth;\n",code+=varyings,code+=chunks.packDepthPS,options.alphaTest&&(code+="float dAlpha;\n",code+=this._addMap("opacity","opacityPS",options,chunks),code+=chunks.alphaTestPS),code+="void main(void)\n{\n",options.alphaTest&&(code+="\t getOpacity();\n",code+="\t alphaTest(dAlpha);\n"),code+="\t\tgl_FragColor = packFloat(vDepth);\n",{attributes:attributes,vshader:vshader,fshader:code+="}\n"};if(shadowPass){var smode=options.pass-3,numShadowModes=5,shadowType=smode-5*(lightType=Math.floor(smode/5)),isVsm;return device.extStandardDerivatives&&!device.webgl2&&(code+="uniform vec2 polygonOffset;\n"),3===shadowType?device.textureFloatHighPrecision?code+="#define VSM_EXPONENT 15.0\n\n":code+="#define VSM_EXPONENT 5.54\n\n":2===shadowType&&(code+="#define VSM_EXPONENT 5.54\n\n"),0!==lightType&&(code+="uniform vec3 view_position;\n",code+="uniform float light_radius;\n"),code+=varyings,options.alphaTest&&(code+="float dAlpha;\n",code+=this._addMap("opacity","opacityPS",options,chunks),code+=chunks.alphaTestPS),0!==shadowType||device.webgl2&&1!==lightType?1===shadowType&&(code+="vec2 encodeFloatRG( float v ) {\n",code+="\t\tvec2 enc = vec2(1.0, 255.0) * v;\n",code+="\t\tenc = fract(enc);\n",code+="\t\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n",code+="\t\treturn enc;\n",code+="}\n\n"):code+=chunks.packDepthPS,code+="void main(void)\n{\n",options.alphaTest&&(code+="\t getOpacity();\n",code+="\t alphaTest(dAlpha);\n"),code+=1===lightType||(1===shadowType||2===shadowType||3===shadowType)&&0!==lightType?"\t float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);\n":"\t float depth = gl_FragCoord.z;\n",0!==shadowType||device.webgl2&&1!==lightType?code+=0===shadowType||4===shadowType?"\t gl_FragColor = vec4(1.0);\n":1===shadowType?"\t gl_FragColor = vec4(encodeFloatRG(depth), encodeFloatRG(depth*depth));\n":chunks.storeEVSMPS:device.extStandardDerivatives&&!device.webgl2?(code+="\t float minValue = 2.3374370500153186e-10; //(1.0 / 255.0) / (256.0 * 256.0 * 256.0);\n",code+="\t depth += polygonOffset.x * max(abs(dFdx(depth)), abs(dFdy(depth))) + minValue * polygonOffset.y;\n",code+="\t gl_FragColor = packFloat(depth);\n"):code+="\t gl_FragColor = packFloat(depth);\n",{attributes:attributes,vshader:vshader,fshader:code+="}\n"}}if(options.customFragmentShader)return{attributes:attributes,vshader:vshader,fshader:fshader=code+options.customFragmentShader,tag:1};code+=varyings,code=this._fsAddBaseCode(code,device,chunks,options),options.detailModes&&(code+=chunks.detailModesPS);var codeBegin=code;code="",options.clearCoat>0&&(code+="#define CLEARCOAT\n"),!1===options.opacityFadesSpecular&&(code+="uniform float material_alphaFade;\n");var numShadowLights=0,shadowTypeUsed=[],shadowedDirectionalLightUsed=!1,useVsm=!1,usePerspZbufferShadow=!1,light,hasAreaLights=options.lights.some((function(light){return light._shape&&0!==light._shape}));7===device.areaLightLutFormat?(code+="#define AREA_R8_G8_B8_A8_LUTS\n",code+="#define AREA_LUTS_PRECISION lowp\n"):code+="#define AREA_LUTS_PRECISION highp\n",hasAreaLights&&(code+="#define AREA_LIGHTS\n",code+="uniform AREA_LUTS_PRECISION sampler2D areaLightsLutTex1;\n",code+="uniform AREA_LUTS_PRECISION sampler2D areaLightsLutTex2;\n");var lightShape=0,tbn;for(i=0;i<options.lights.length;i++)code+="uniform vec3 light"+i+"_color;\n",0===(lightType=(light=options.lights[i])._type)?code+="uniform vec3 light"+i+"_direction;\n":(code+="uniform vec3 light"+i+"_position;\n",code+="uniform float light"+i+"_radius;\n",2===lightType&&(code+="uniform vec3 light"+i+"_direction;\n",code+="uniform float light"+i+"_innerConeAngle;\n",code+="uniform float light"+i+"_outerConeAngle;\n")),0!==(lightShape=hasAreaLights&&light._shape?light._shape:0)&&(0===lightType&&(code+="uniform vec3 light"+i+"_position;\n"),code+="uniform vec3 light"+i+"_halfWidth;\n",code+="uniform vec3 light"+i+"_halfHeight;\n"),light.castShadows&&!options.noShadow&&(code+="uniform mat4 light"+i+"_shadowMatrix;\n",0===lightType&&(code+="uniform mat4 light"+i+"_shadowMatrixPalette[4];\n",code+="uniform float light"+i+"_shadowCascadeDistances[4];\n",code+="uniform float light"+i+"_shadowCascadeCount;\n"),0!==lightType?code+="uniform vec4 light"+i+"_shadowParams;\n":(shadowedDirectionalLightUsed=!0,code+="uniform vec3 light"+i+"_shadowParams;\n"),1===lightType?code+="uniform samplerCube light"+i+"_shadowMap;\n":light._isPcf&&device.webgl2?code+="uniform sampler2DShadow light"+i+"_shadowMap;\n":code+="uniform sampler2D light"+i+"_shadowMap;\n",numShadowLights++,shadowTypeUsed[light._shadowType]=!0,light._isVsm&&(useVsm=!0),light._isPcf&&(device.webgl2||device.extStandardDerivatives)&&2===lightType&&(usePerspZbufferShadow=!0)),light._cookie&&(light._cookie._cubemap?1===lightType&&(code+="uniform samplerCube light"+i+"_cookie;\n",code+="uniform float light"+i+"_cookieIntensity;\n",light.castShadows&&!options.noShadow||(code+="uniform mat4 light"+i+"_shadowMatrix;\n")):2===lightType&&(code+="uniform sampler2D light"+i+"_cookie;\n",code+="uniform float light"+i+"_cookieIntensity;\n",light.castShadows&&!options.noShadow||(code+="uniform mat4 light"+i+"_shadowMatrix;\n"),light._cookieTransform&&(code+="uniform vec4 light"+i+"_cookieMatrix;\n",code+="uniform vec2 light"+i+"_cookieOffset;\n")));if(code+="\n",tbn=!options.hasTangents&&device.extStandardDerivatives?chunks.TBNderivativePS:options.fastTbn?chunks.TBNfastPS:chunks.TBNPS,needsNormal)if(options.normalMap||options.clearCoatNormalMap){if(code+=options.packedNormal?chunks.normalXYPS:chunks.normalXYZPS,!options.hasTangents){var normalMapUv=this._getUvSourceExpression("normalMapTransform","normalMapUv",options);tbn=tbn.replace(/\$UV/g,normalMapUv)}code+=tbn}else options.enableGGXSpecular&&!options.heightMap&&(code+=chunks.normalVertexPS,code+=chunks.TBNObjectSpacePS);if(needsNormal)if(options.normalMap){options.normalDetail&&(code+=this._addMap("normalDetail","normalDetailMapPS",options,chunks));var transformedNormalMapUv=this._getUvSourceExpression("normalMapTransform","normalMapUv",options);options.normalizeNormalMap?code+=chunks.normalMapPS.replace(/\$UV/g,transformedNormalMapUv):code+=chunks.normalMapFastPS.replace(/\$UV/g,transformedNormalMapUv)}else options.enableGGXSpecular&&!options.heightMap||(code+=chunks.normalVertexPS);if(code+=gammaCode(options.gamma,chunks),code+=tonemapCode(options.toneMap,chunks),code+=fogCode(options.fog,chunks),options.useRgbm&&(code+=chunks.rgbmPS),(cubemapReflection||options.prefilteredCubemap)&&(code+=options.fixSeams?chunks.fixCubemapSeamsStretchPS:chunks.fixCubemapSeamsNonePS),options.useCubeMapRotation&&(code+="#define CUBEMAP_ROTATION\n"),options.useRightHandedCubeMap&&(code+="#define RIGHT_HANDED_CUBEMAP\n"),needsNormal&&(code+=chunks.cubeMapRotatePS,code+=options.cubeMapProjection>0?chunks.cubeMapProjectBoxPS:chunks.cubeMapProjectNonePS,code+=options.skyboxIntensity?chunks.envMultiplyPS:chunks.envConstPS),options.diffuseDetail&&(code+=this._addMap("diffuseDetail","diffuseDetailMapPS",options,chunks)),code+=this._addMap("diffuse","diffusePS",options,chunks),(3!==options.blendType||options.alphaTest||options.alphaToCoverage)&&(code+=this._addMap("opacity","opacityPS",options,chunks)),code+=this._addMap("emissive","emissivePS",options,chunks,options.emissiveFormat),lighting&&options.useSpecular||reflections){options.specularAntialias&&options.normalMap?options.normalizeNormalMap&&needsNormal?code+=chunks.specularAaToksvigPS:code+=chunks.specularAaToksvigFastPS:code+=chunks.specularAaNonePS;var specularPropName=options.useMetalness?"metalness":"specular";code+=this._addMap(specularPropName,specularPropName+"PS",options,chunks),code+=this._addMap("gloss","glossPS",options,chunks),2===options.fresnelModel&&(code+=chunks.fresnelSchlickPS)}if(options.clearCoat>0&&(code+=this._addMap("clearCoat","clearCoatPS",options,chunks),code+=this._addMap("clearCoatGloss","clearCoatGlossPS",options,chunks),code+=this._addMap("clearCoatNormal","clearCoatNormalPS",options,chunks)),options.heightMap){if(!options.normalMap){var transformedHeightMapUv=this._getUvSourceExpression("heightMapTransform","heightMapUv",options);options.hasTangents||(tbn=tbn.replace(/\$UV/g,transformedHeightMapUv)),code+=tbn}code+=this._addMap("height","parallaxPS",options,chunks)}var useAo=options.aoMap||options.aoVertexColor;useAo&&(code+=this._addMap("ao","aoPS",options,chunks),options.occludeSpecular&&(1===options.occludeSpecular?code+=options.occludeSpecularFloat?chunks.aoSpecOccSimplePS:chunks.aoSpecOccConstSimplePS:code+=options.occludeSpecularFloat?chunks.aoSpecOccPS:chunks.aoSpecOccConstPS));var reflectionDecode=options.rgbmReflection?"decodeRGBM":options.hdrReflection?"":"gammaCorrectInput";if(options.sphereMap){var scode=device.fragmentUniformsCount>16?chunks.reflectionSpherePS:chunks.reflectionSphereLowPS;code+=scode=scode.replace(/\$texture2DSAMPLE/g,options.rgbmReflection?"texture2DRGBM":options.hdrReflection?"texture2D":"texture2DSRGB")}else cubemapReflection?options.prefilteredCubemap?code+=useTexCubeLod?chunks.reflectionPrefilteredCubeLodPS.replace(/\$DECODE/g,reflectionDecode):chunks.reflectionPrefilteredCubePS.replace(/\$DECODE/g,reflectionDecode):code+=chunks.reflectionCubePS.replace(/\$textureCubeSAMPLE/g,options.rgbmReflection?"textureCubeRGBM":options.hdrReflection?"textureCube":"textureCubeSRGB"):options.dpAtlas&&(code+=chunks.reflectionDpAtlasPS.replace(/\$texture2DSAMPLE/g,options.rgbmReflection?"texture2DRGBM":options.hdrReflection?"texture2D":"texture2DSRGB"));(cubemapReflection||options.sphereMap||options.dpAtlas)&&(options.clearCoat>0&&(code+=chunks.reflectionCCPS),options.refraction&&(code+=chunks.refractionPS)),numShadowLights>0&&(shadowedDirectionalLightUsed&&(code+=shaderChunks.shadowCascadesPS),shadowTypeUsed[0]&&(code+=chunks.shadowStandardPS),shadowTypeUsed[4]&&(code+=chunks.shadowStandardGL2PS),useVsm&&(code+=chunks.shadowVSM_commonPS,shadowTypeUsed[1]&&(code+=chunks.shadowVSM8PS),shadowTypeUsed[2]&&(code+=device.extTextureHalfFloatLinear?chunks.shadowEVSMPS.replace(/\$/g,"16"):chunks.shadowEVSMnPS.replace(/\$/g,"16")),shadowTypeUsed[3]&&(code+=device.extTextureFloatLinear?chunks.shadowEVSMPS.replace(/\$/g,"32"):chunks.shadowEVSMnPS.replace(/\$/g,"32"))),device.webgl2||device.extStandardDerivatives||(code+=chunks.biasConstPS),code+=chunks.shadowCoordPS+chunks.shadowCommonPS,usePerspZbufferShadow&&(code+=chunks.shadowCoordPerspZbufferPS)),options.enableGGXSpecular&&(code+="uniform float material_anisotropy;\n"),lighting&&(code+=chunks.lightDiffuseLambertPS,hasAreaLights&&(code+=chunks.ltc));var useOldAmbient=!1;options.useSpecular?(lighting&&(code+=0===options.shadingModel?chunks.lightSpecularPhongPS:options.enableGGXSpecular?chunks.lightSpecularAnisoGGXPS:chunks.lightSpecularBlinnPS),options.sphereMap||cubemapReflection||options.dpAtlas||options.fresnelModel>0?options.fresnelModel>0?options.conserveEnergy&&!hasAreaLights?code+=chunks.combineDiffuseSpecularPS:code+=chunks.combineDiffuseSpecularNoConservePS:code+=chunks.combineDiffuseSpecularOldPS:options.diffuseMap?code+=chunks.combineDiffuseSpecularNoReflPS:(code+=chunks.combineDiffuseSpecularNoReflSeparateAmbientPS,useOldAmbient=!0)):code+=chunks.combineDiffusePS,options.clearCoat>0&&(code+=chunks.combineClearCoatPS);var addAmbient=!0;if(options.lightMap||options.lightVertexColor){var lightmapChunkPropName=options.dirLightMap&&options.useSpecular?"lightmapDirPS":"lightmapSinglePS";code+=this._addMap("light",lightmapChunkPropName,options,chunks,options.lightMapFormat),addAmbient=options.lightMapWithoutAmbient}if(addAmbient){var ambientDecode=options.rgbmAmbient?"decodeRGBM":options.hdrAmbient?"":"gammaCorrectInput";options.ambientSH?code+=chunks.ambientSHPS:options.prefilteredCubemap?code+=useTexCubeLod?chunks.ambientPrefilteredCubeLodPS.replace(/\$DECODE/g,ambientDecode):chunks.ambientPrefilteredCubePS.replace(/\$DECODE/g,ambientDecode):code+=chunks.ambientConstantPS}options.ambientTint&&!useOldAmbient&&(code+="uniform vec3 material_ambient;\n"),options.alphaTest&&(code+=chunks.alphaTestPS),options.msdf&&(code+=chunks.msdfPS),needsNormal&&(code+=chunks.viewDirPS,options.useSpecular&&(code+=options.enableGGXSpecular?chunks.reflDirAnisoPS:chunks.reflDirPS));var hasPointLights=!1,usesLinearFalloff=!1,usesInvSquaredFalloff=!1,usesSpot=!1,usesCookie=!1,usesCookieNow,clusterTextureFormat;LayerComposition.clusteredLightingEnabled&&(usesSpot=!0,hasPointLights=!0,usesLinearFalloff=!0,code+="\n#define CLUSTER_TEXTURE_"+(WorldClusters.lightTextureFormat===WorldClusters.FORMAT_FLOAT?"FLOAT":"8BIT")+"\n",code+=chunks.clusteredLightPS);options.twoSidedLighting&&(code+="uniform float twoSidedLightingNegScaleFactor;\n"),code=this._fsAddStartCode(code,device,chunks,options),needsNormal&&(options.hasTangents||!device.extStandardDerivatives||options.fastTbn?options.twoSidedLighting?code+="\t dVertexNormalW = gl_FrontFacing ? vNormalW * twoSidedLightingNegScaleFactor : -vNormalW * twoSidedLightingNegScaleFactor;\n":code+="\t dVertexNormalW = vNormalW;\n":options.twoSidedLighting?code+="\t dVertexNormalW = normalize(gl_FrontFacing ? vNormalW * twoSidedLightingNegScaleFactor : -vNormalW * twoSidedLightingNegScaleFactor);\n":code+="\t dVertexNormalW = normalize(vNormalW);\n",(options.heightMap||options.normalMap)&&options.hasTangents&&(options.twoSidedLighting?(code+="\t dTangentW = gl_FrontFacing ? vTangentW * twoSidedLightingNegScaleFactor : -vTangentW * twoSidedLightingNegScaleFactor;\n",code+="\t dBinormalW = gl_FrontFacing ? vBinormalW * twoSidedLightingNegScaleFactor : -vBinormalW * twoSidedLightingNegScaleFactor;\n"):(code+="\t dTangentW = vTangentW;\n",code+="\t dBinormalW = vBinormalW;\n")));var opacityParallax=!1;3!==options.blendType||options.alphaTest||options.alphaToCoverage?options.heightMap&&options.opacityMap?opacityParallax=!0:(code+="\t getOpacity();\n",options.alphaTest&&(code+="\t alphaTest(dAlpha);\n")):code+="\t dAlpha = 1.0;\n";var getGlossinessCalled=!1;if(needsNormal&&(code+="\t getViewDir();\n",(options.heightMap||options.normalMap||options.clearCoatNormalMap||options.enableGGXSpecular)&&(code+="\t getTBN();\n"),options.heightMap&&(code+="\t getParallax();\n"),opacityParallax&&(code+="\t getOpacity();\n",options.alphaTest&&(code+="\t alphaTest(dAlpha);\n")),code+="\t getNormal();\n",options.useSpecular&&(options.enableGGXSpecular&&(code+="\t getGlossiness();\n",getGlossinessCalled=!0),code+="\t getReflDir();\n")),code+="\t getAlbedo();\n",options.clearCoat>0&&(code+="\t getClearCoat();\n",code+="\t getClearCoatGlossiness();\n",code+="\t getClearCoatNormal();\n"),(lighting&&options.useSpecular||reflections)&&(code+="\t getSpecularity();\n",getGlossinessCalled||(code+="\t getGlossiness();\n"),hasAreaLights&&(code+="\t #ifdef AREA_LIGHTS\n",code+="\t dSpecularityNoFres = dSpecularity;\n",code+="\t #ifdef CLEARCOAT\n",code+="\t ccSpecularityNoFres = ccSpecularity;\n",code+="\t #endif\n",code+="\t #endif\n"),options.fresnelModel>0&&(code+="\t getFresnel();\n")),addAmbient&&(code+="\t addAmbient();\n"),options.ambientTint&&!useOldAmbient&&(code+="\t dDiffuseLight *= material_ambient;\n"),useAo&&!options.occludeDirect&&(code+="\t\tapplyAO();\n"),(options.lightMap||options.lightVertexColor)&&(code+="\t addLightMap();\n"),lighting||reflections){(cubemapReflection||options.sphereMap||options.dpAtlas)&&(options.clearCoat>0&&(code+="\t addReflectionCC();\n"),code+="\t addReflection();\n"),hasAreaLights&&(code+="\t ccReflection.rgb *= ccSpecularity;\n",code+="\t dReflection.rgb *= dSpecularity;\n",code+="\t dSpecularLight *= dSpecularity;\n",code+="\t float roughness = max((1.0 - dGlossiness) * (1.0 - dGlossiness), 0.001);\n");var shapeString="";for(LayerComposition.clusteredLightingEnabled&&(usesLinearFalloff=!0,hasPointLights=!0,code+=chunks.clusteredLightLoopPS),i=0;i<options.lights.length;i++)if(lightType=(light=options.lights[i])._type,!LayerComposition.clusteredLightingEnabled||0===lightType){if(usesCookieNow=!1,hasAreaLights&&light._shape?(lightShape=light._shape,shapeString=this._getLightSourceShapeString(lightShape)):(lightShape=0,shapeString=""),0!==lightShape&&(code+="\t calc"+shapeString+"LightValues(light"+i+"_position, light"+i+"_halfWidth, light"+i+"_halfHeight);\n"),0===lightType?(code+="\t dLightDirNormW = light"+i+"_direction;\n",code+="\t dAtten = 1.0;\n"):(light._cookie&&(2!==lightType||light._cookie._cubemap?1===lightType&&light._cookie._cubemap&&(usesCookie=!0,usesCookieNow=!0):(usesCookie=!0,usesCookieNow=!0)),code+="\t getLightDirPoint(light"+i+"_position);\n",hasPointLights=!0,usesCookieNow&&(code+=2===lightType?"\t dAtten3 = getCookie2D"+(light._cookieFalloff?"":"Clip")+(light._cookieTransform?"Xform":"")+"(light"+i+"_cookie, light"+i+"_shadowMatrix, light"+i+"_cookieIntensity"+(light._cookieTransform?", light"+i+"_cookieMatrix, light"+i+"_cookieOffset":"")+")."+light._cookieChannel+";\n":"\t dAtten3 = getCookieCube(light"+i+"_cookie, light"+i+"_shadowMatrix, light"+i+"_cookieIntensity)."+light._cookieChannel+";\n"),0===lightShape?0===light._falloffMode?(code+="\t dAtten = getFalloffLinear(light"+i+"_radius);\n",usesLinearFalloff=!0):(code+="\t dAtten = getFalloffInvSquared(light"+i+"_radius);\n",usesInvSquaredFalloff=!0):(code+="\t dAtten = getFalloffWindow(light"+i+"_radius);\n",usesInvSquaredFalloff=!0),code+="\t if (dAtten > 0.00001) {\n",2===lightType&&(usesCookieNow&&!light._cookieFalloff||(code+="\t\t\t dAtten *= getSpotEffect(light"+i+"_direction, light"+i+"_innerConeAngle, light"+i+"_outerConeAngle);\n",usesSpot=!0))),code+=0!==lightShape?0===lightType?"\t\t\t dAttenD = getLightDiffuse();\n":"\t\t\t dAttenD = get"+shapeString+"LightDiffuse() * 16.0;\n":"\t\t\t dAtten *= getLightDiffuse();\n",light.castShadows&&!options.noShadow){var shadowReadMode=null,evsmExp;if(1===light._shadowType?(shadowReadMode="VSM8",evsmExp="0.0"):2===light._shadowType?(shadowReadMode="VSM16",evsmExp="5.54"):3===light._shadowType?(shadowReadMode="VSM32",evsmExp=device.textureFloatHighPrecision?"15.0":"5.54"):shadowReadMode=4===light._shadowType?"PCF5x5":"PCF3x3",null!==shadowReadMode)if(1===lightType)shadowCoordArgs="(light"+i+"_shadowMap, light"+i+"_shadowParams);\n",light._normalOffsetBias&&(code+="\t\t\t normalOffsetPointShadow(light"+i+"_shadowParams);\n"),code+="\t\t\t dAtten *= getShadowPoint"+shadowReadMode+shadowCoordArgs;else{var shadowMatArg="light"+i+"_shadowMatrix",shadowParamArg="light"+i+"_shadowParams";code+=this._nonPointShadowMapProjection(device,options.lights[i],shadowMatArg,shadowParamArg,i),2===lightType&&(shadowReadMode="Spot"+shadowReadMode),code+="\t\t\t dAtten *= getShadow"+shadowReadMode+"(light"+i+"_shadowMap, light"+i+"_shadowParams"+(light._isVsm?", "+evsmExp:"")+");\n"}}0!==lightShape?options.conserveEnergy&&options.useSpecular?code+="\t\t\t dDiffuseLight += mix((dAttenD * dAtten) * light"+i+"_color"+(usesCookieNow?" * dAtten3":"")+", vec3(0), dLTCSpecFres);\n":code+="\t\t\t dDiffuseLight += (dAttenD * dAtten) * light"+i+"_color"+(usesCookieNow?" * dAtten3":"")+";\n":hasAreaLights&&options.conserveEnergy&&options.useSpecular?code+="\t\t\t dDiffuseLight += mix(dAtten * light"+i+"_color"+(usesCookieNow?" * dAtten3":"")+", vec3(0), dSpecularity);\n":code+="\t\t\t dDiffuseLight += dAtten * light"+i+"_color"+(usesCookieNow?" * dAtten3":"")+";\n",0!==lightShape?(options.clearCoat>0&&(code+="\t\t\t ccSpecularLight += ccLTCSpecFres * get"+shapeString+"LightSpecularCC() * dAtten * light"+i+"_color"+(usesCookieNow?" * dAtten3":"")+";\n"),options.useSpecular&&(code+="\t\t\t dSpecularLight += dLTCSpecFres * get"+shapeString+"LightSpecular() * dAtten * light"+i+"_color"+(usesCookieNow?" * dAtten3":"")+";\n")):hasAreaLights?(options.clearCoat>0&&(code+="\t\t\t ccSpecularLight += ccSpecularity * getLightSpecularCC() * dAtten * light"+i+"_color"+(usesCookieNow?" * dAtten3":"")+";\n"),options.useSpecular&&(code+="\t\t\t dSpecularLight += dSpecularity * getLightSpecular() * dAtten * light"+i+"_color"+(usesCookieNow?" * dAtten3":"")+";\n")):(options.clearCoat>0&&(code+="\t\t\t ccSpecularLight += getLightSpecularCC() * dAtten * light"+i+"_color"+(usesCookieNow?" * dAtten3":"")+";\n"),options.useSpecular&&(code+="\t\t\t dSpecularLight += getLightSpecular() * dAtten * light"+i+"_color"+(usesCookieNow?" * dAtten3":"")+";\n")),0!==lightType&&(code+="\t }\n"),code+="\n"}hasAreaLights&&(options.clearCoat>0&&(code+="\t ccSpecularity = 1.0;\n"),options.useSpecular&&(code+="\t dSpecularity = vec3(1);\n")),(cubemapReflection||options.sphereMap||options.dpAtlas)&&options.refraction&&(code+="\t addRefraction();\n")}code+="\n",useAo&&(options.occludeDirect&&(code+="\t\tapplyAO();\n"),options.occludeSpecular&&(code+="\t\toccludeSpecular();\n")),!1===options.opacityFadesSpecular&&(2!==options.blendType&&4!==options.blendType||(code+="float specLum = dot((dSpecularLight + dReflection.rgb * dReflection.a) * dSpecularity, vec3( 0.2126, 0.7152, 0.0722 ));\n",code+="#ifdef CLEARCOAT\n specLum += dot(ccSpecularLight * ccSpecularity + ccReflection.rgb * ccReflection.a * ccSpecularity, vec3( 0.2126, 0.7152, 0.0722 ));\n#endif\n",code+="dAlpha = clamp(dAlpha + gammaCorrectInput(specLum), 0.0, 1.0);\n"),code+="dAlpha *= material_alphaFade;\n"),code+=chunks.endPS,2===options.blendType||6===options.blendType||options.alphaToCoverage?code+=chunks.outputAlphaPS:4===options.blendType?code+=chunks.outputAlphaPremulPS:code+=chunks.outputAlphaOpaquePS,options.msdf&&(code+="\t gl_FragColor = applyMsdf(gl_FragColor);\n"),code+="\n",code+="}\n",hasPointLights&&(code=chunks.lightDirPointPS+code),usesLinearFalloff&&(code=chunks.falloffLinearPS+code),usesInvSquaredFalloff&&(code=chunks.falloffInvSquaredPS+code),usesSpot&&(code=chunks.spotPS+code),usesCookie&&(code=chunks.cookiePS+code);var structCode="";return code.includes("dReflection")&&(structCode+="vec4 dReflection;\n"),code.includes("dTBN")&&(structCode+="mat3 dTBN;\n"),code.includes("dAlbedo")&&(structCode+="vec3 dAlbedo;\n"),code.includes("dEmission")&&(structCode+="vec3 dEmission;\n"),code.includes("dNormalW")&&(structCode+="vec3 dNormalW;\n"),code.includes("dVertexNormalW")&&(structCode+="vec3 dVertexNormalW;\n"),code.includes("dTangentW")&&(structCode+="vec3 dTangentW;\n"),code.includes("dBinormalW")&&(structCode+="vec3 dBinormalW;\n"),code.includes("dViewDirW")&&(structCode+="vec3 dViewDirW;\n"),code.includes("dReflDirW")&&(structCode+="vec3 dReflDirW;\n"),code.includes("dDiffuseLight")&&(structCode+="vec3 dDiffuseLight;\n"),code.includes("dSpecularLight")&&(structCode+="vec3 dSpecularLight;\n"),code.includes("dLightDirNormW")&&(structCode+="vec3 dLightDirNormW;\n"),code.includes("dLightDirW")&&(structCode+="vec3 dLightDirW;\n"),code.includes("dLightPosW")&&(structCode+="vec3 dLightPosW;\n"),code.includes("dShadowCoord")&&(structCode+="vec3 dShadowCoord;\n"),code.includes("dNormalMap")&&(structCode+="vec3 dNormalMap;\n"),code.includes("dSpecularity")&&(structCode+="vec3 dSpecularity;\n"),code.includes("dSpecularityNoFres")&&(structCode+="vec3 dSpecularityNoFres;\n"),code.includes("dUvOffset")&&(structCode+="vec2 dUvOffset;\n"),code.includes("dGlossiness")&&(structCode+="float dGlossiness;\n"),code.includes("dAlpha")&&(structCode+="float dAlpha;\n"),code.includes("dAtten")&&(structCode+="float dAtten;\n"),code.includes("dAttenD")&&(structCode+="float dAttenD;\n"),code.includes("dAtten3")&&(structCode+="vec3 dAtten3;\n"),code.includes("dAo")&&(structCode+="float dAo;\n"),code.includes("dMsdf")&&(structCode+="vec4 dMsdf;\n"),code.includes("ccReflection")&&(structCode+="vec4 ccReflection;\n"),code.includes("ccNormalW")&&(structCode+="vec3 ccNormalW;\n"),code.includes("ccReflDirW")&&(structCode+="vec3 ccReflDirW;\n"),code.includes("ccSpecularLight")&&(structCode+="vec3 ccSpecularLight;\n"),code.includes("ccSpecularity")&&(structCode+="float ccSpecularity;\n"),code.includes("ccSpecularityNoFres")&&(structCode+="float ccSpecularityNoFres;\n"),code.includes("ccGlossiness")&&(structCode+="float ccGlossiness;\n"),{attributes:attributes,vshader:vshader,fshader:fshader=code=codeBegin+structCode+code,tag:1}}},programlib={begin:begin,dummyFragmentCode:dummyFragmentCode,end:end,fogCode:fogCode,gammaCode:gammaCode,precisionCode:precisionCode,skinCode:skinCode,tonemapCode:tonemapCode,versionCode:versionCode,basic:basic,particle:particle,skybox:skybox,standard:standard},dpMult=2;function paraboloidFromCubemap(device,sourceCubemap,fixSeamsAmount,dontFlipX){var seamsCode=sourceCubemap.fixCubemapSeams?shaderChunks.fixCubemapSeamsStretchPS:shaderChunks.fixCubemapSeamsNonePS,shader=createShaderFromCode(device,shaderChunks.fullscreenQuadVS,seamsCode+shaderChunks.genParaboloidPS,"genParaboloid"),constantTexSource=device.scope.resolve("source"),constantParams=device.scope.resolve("params"),params=new Float32Array(4),size=sourceCubemap.width,format=sourceCubemap.format;size=2*Math.max(size,8);var tex=new Texture(device,{type:sourceCubemap.type,format:format,width:2*size,height:size,mipmaps:!1});tex.name="paraboloid";var targ=new RenderTarget({colorBuffer:tex,depth:!1});return params[0]=fixSeamsAmount,params[1]=dontFlipX?-1:1,constantTexSource.setValue(sourceCubemap),constantParams.setValue(params),drawQuadWithShader(device,targ,shader),tex}function getDpAtlasRect(rect,mip){rect.x=.5*math.clamp(mip-2,0,1);var t=mip-6*rect.x,i=1-rect.x;return rect.y=Math.min(.5*t,.75)*i+rect.x,rect.z=(1-.5*math.clamp(t,0,1))*i,rect.w=.5*rect.z,1/rect.z}function generateDpAtlas(device,sixCubemaps,dontFlipX){var dp,rect=new Vec4,params=new Float32Array(4),size=2*sixCubemaps[0].width*2,shader=createShaderFromCode(device,shaderChunks.fullscreenQuadVS,shaderChunks.dpAtlasQuadPS,"dpAtlasQuad"),constantTexSource=device.scope.resolve("source"),constantParams=device.scope.resolve("params"),tex=new Texture(device,{type:sixCubemaps[0].type,format:sixCubemaps[0].format,width:size,height:size,mipmaps:!1});tex.name="paraboloid";for(var targ=new RenderTarget({colorBuffer:tex,depth:!1}),borderSize=2,mip0Width=size,scaleFactor=(size+2)/size-1,scaleAmount,i=0;i<6;i++)dp=paraboloidFromCubemap(device,sixCubemaps[i],i,dontFlipX),constantTexSource.setValue(dp),scaleAmount=getDpAtlasRect(rect,i),params[0]=scaleAmount*scaleFactor,params[1]=2*params[0],params[0]+=1,params[1]+=1,constantParams.setValue(params),rect.x*=size,rect.y*=size,rect.z*=size,rect.w*=size,drawQuadWithShader(device,targ,shader,rect);return tex}var id$1=0,Material=function(){function Material(){this.name="Untitled",this.id=id$1++,this._shader=null,this.variants={},this.parameters={},this.alphaTest=0,this.alphaToCoverage=!1,this.blend=!1,this.blendSrc=1,this.blendDst=0,this.blendEquation=0,this.separateAlphaBlend=!1,this.blendSrcAlpha=1,this.blendDstAlpha=0,this.blendAlphaEquation=0,this.cull=1,this.depthTest=!0,this.depthWrite=!0,this.stencilFront=null,this.stencilBack=null,this.depthBias=0,this.slopeDepthBias=0,this.redWrite=!0,this.greenWrite=!0,this.blueWrite=!0,this.alphaWrite=!0,this.meshInstances=[],this._shaderVersion=0,this._scene=null,this._dirtyBlend=!1,this.dirty=!0}var _proto=Material.prototype;return _proto._cloneInternal=function _cloneInternal(clone){clone.name=this.name,clone.shader=this.shader,clone.alphaTest=this.alphaTest,clone.alphaToCoverage=this.alphaToCoverage,clone.blend=this.blend,clone.blendSrc=this.blendSrc,clone.blendDst=this.blendDst,clone.blendEquation=this.blendEquation,clone.separateAlphaBlend=this.separateAlphaBlend,clone.blendSrcAlpha=this.blendSrcAlpha,clone.blendDstAlpha=this.blendDstAlpha,clone.blendAlphaEquation=this.blendAlphaEquation,clone.cull=this.cull,clone.depthTest=this.depthTest,clone.depthWrite=this.depthWrite,clone.depthBias=this.depthBias,clone.slopeDepthBias=this.slopeDepthBias,this.stencilFront&&(clone.stencilFront=this.stencilFront.clone()),this.stencilBack&&(this.stencilFront===this.stencilBack?clone.stencilBack=clone.stencilFront:clone.stencilBack=this.stencilBack.clone()),clone.redWrite=this.redWrite,clone.greenWrite=this.greenWrite,clone.blueWrite=this.blueWrite,clone.alphaWrite=this.alphaWrite},_proto.clone=function clone(){var clone=new Material;return this._cloneInternal(clone),clone},_proto._updateMeshInstanceKeys=function _updateMeshInstanceKeys(){var i,meshInstances=this.meshInstances;for(i=0;i<meshInstances.length;i++)meshInstances[i].updateKey()},_proto.updateUniforms=function updateUniforms(){},_proto.updateShader=function updateShader(device,scene,objDefs){},_proto.update=function update(){this.dirty=!0,this._shader&&(this._shader.failed=!1)},_proto.clearParameters=function clearParameters(){this.parameters={}},_proto.getParameters=function getParameters(){return this.parameters},_proto.clearVariants=function clearVariants(){var meshInstance,j;this.variants={};for(var i=0;i<this.meshInstances.length;i++)for(meshInstance=this.meshInstances[i],j=0;j<meshInstance._shader.length;j++)meshInstance._shader[j]=null},_proto.getParameter=function getParameter(name){return this.parameters[name]},_proto.setParameter=function setParameter(name,data){if(void 0===data&&"object"==typeof name){var uniformObject=name;if(uniformObject.length){for(var i=0;i<uniformObject.length;i++)this.setParameter(uniformObject[i]);return}name=uniformObject.name,data=uniformObject.value}var param=this.parameters[name];param?param.data=data:this.parameters[name]={scopeId:null,data:data}},_proto.deleteParameter=function deleteParameter(name){this.parameters[name]&&delete this.parameters[name]},_proto.setParameters=function setParameters(device,names){var parameter,parameters=this.parameters;for(var paramName in void 0===names&&(names=parameters),names)(parameter=parameters[paramName])&&(parameter.scopeId||(parameter.scopeId=device.scope.resolve(paramName)),parameter.scopeId.setValue(parameter.data))},_proto.destroy=function destroy(){var meshInstance,j;this.variants={},this.shader=null;for(var i=0;i<this.meshInstances.length;i++){for(meshInstance=this.meshInstances[i],j=0;j<meshInstance._shader.length;j++)meshInstance._shader[j]=null;meshInstance._material=null;var defaultMaterial=Material.defaultMaterial;this!==defaultMaterial&&(meshInstance.material=defaultMaterial)}},_createClass(Material,[{key:"shader",get:function get(){return this._shader},set:function set(shader){this._shader=shader}},{key:"blendType",get:function get(){return this.blend||1!==this.blendSrc||0!==this.blendDst||0!==this.blendEquation?this.blend&&6===this.blendSrc&&8===this.blendDst&&0===this.blendEquation?2:this.blend&&1===this.blendSrc&&1===this.blendDst&&0===this.blendEquation?1:this.blend&&6===this.blendSrc&&1===this.blendDst&&0===this.blendEquation?6:this.blend&&4===this.blendSrc&&2===this.blendDst&&0===this.blendEquation?7:this.blend&&5===this.blendSrc&&1===this.blendDst&&0===this.blendEquation?8:this.blend&&1===this.blendSrc&&1===this.blendDst&&3===this.blendEquation?9:this.blend&&1===this.blendSrc&&1===this.blendDst&&4===this.blendEquation?10:this.blend&&4===this.blendSrc&&0===this.blendDst&&0===this.blendEquation?5:this.blend&&1===this.blendSrc&&8===this.blendDst&&0===this.blendEquation?4:2:3},set:function set(type){var prevBlend=this.blend;switch(type){case 3:this.blend=!1,this.blendSrc=1,this.blendDst=0,this.blendEquation=0;break;case 2:this.blend=!0,this.blendSrc=6,this.blendDst=8,this.blendEquation=0;break;case 4:this.blend=!0,this.blendSrc=1,this.blendDst=8,this.blendEquation=0;break;case 1:this.blend=!0,this.blendSrc=1,this.blendDst=1,this.blendEquation=0;break;case 6:this.blend=!0,this.blendSrc=6,this.blendDst=1,this.blendEquation=0;break;case 7:this.blend=!0,this.blendSrc=4,this.blendDst=2,this.blendEquation=0;break;case 8:this.blend=!0,this.blendSrc=5,this.blendDst=1,this.blendEquation=0;break;case 5:this.blend=!0,this.blendSrc=4,this.blendDst=0,this.blendEquation=0;break;case 9:this.blend=!0,this.blendSrc=1,this.blendDst=1,this.blendEquation=3;break;case 10:this.blend=!0,this.blendSrc=1,this.blendDst=1,this.blendEquation=4}prevBlend!==this.blend&&(this._scene?this._scene.layers._dirtyBlend=!0:this._dirtyBlend=!0),this._updateMeshInstanceKeys()}}]),Material}();function StandardMaterialOptionsBuilder(){this._mapXForms=null}Material.defaultMaterial=null,StandardMaterialOptionsBuilder.prototype.updateMinRef=function(options,device,scene,stdMat,objDefs,staticLightList,pass,sortedLights,prefilteredCubeMap128){this._updateSharedOptions(options,stdMat,objDefs,pass),this._updateMinOptions(options,stdMat),this._updateUVOptions(options,stdMat,objDefs,!0)},StandardMaterialOptionsBuilder.prototype.updateRef=function(options,device,scene,stdMat,objDefs,staticLightList,pass,sortedLights,prefilteredCubeMap128){this._updateSharedOptions(options,stdMat,objDefs,pass),options.useTexCubeLod=device.useTexCubeLod,this._updateEnvOptions(options,stdMat,scene,prefilteredCubeMap128),this._updateMaterialOptions(options,stdMat),1===pass&&(options.gamma&&(options.gamma=3),options.toneMap=0),options.hasTangents=objDefs&&stdMat.normalMap&&0!=(512&objDefs),this._updateLightOptions(options,stdMat,objDefs,sortedLights,staticLightList),this._updateUVOptions(options,stdMat,objDefs,!1)},StandardMaterialOptionsBuilder.prototype._updateSharedOptions=function(options,stdMat,objDefs,pass){options.pass=pass,options.alphaTest=stdMat.alphaTest>0,options.forceFragmentPrecision=stdMat.forceFragmentPrecision||"",options.chunks=stdMat.chunks||"",options.blendType=stdMat.blendType,options.forceUv1=stdMat.forceUv1,options.screenSpace=objDefs&&0!=(256&objDefs),options.skin=objDefs&&0!=(2&objDefs),options.useInstancing=objDefs&&0!=(32&objDefs),options.useMorphPosition=objDefs&&0!=(1024&objDefs),options.useMorphNormal=objDefs&&0!=(2048&objDefs),options.useMorphTextureBased=objDefs&&0!=(4096&objDefs),options.nineSlicedMode=stdMat.nineSlicedMode||0},StandardMaterialOptionsBuilder.prototype._updateUVOptions=function(options,stdMat,objDefs,minimalOptions){var hasUv0=!1,hasUv1=!1,hasVcolor=!1;for(var p in objDefs&&(hasUv0=0!=(4&objDefs),hasUv1=0!=(8&objDefs),hasVcolor=0!=(16&objDefs)),options.vertexColors=!1,this._mapXForms=[],_matTex2D)this._updateTexOptions(options,stdMat,p,hasUv0,hasUv1,hasVcolor,minimalOptions);this._mapXForms=null},StandardMaterialOptionsBuilder.prototype._updateMinOptions=function(options,stdMat){options.opacityTint=1!==stdMat.opacity&&3!==stdMat.blendType,options.lights=[]},StandardMaterialOptionsBuilder.prototype._updateMaterialOptions=function(options,stdMat){var diffuseTint=1===stdMat.diffuse.r&&1===stdMat.diffuse.g&&1===stdMat.diffuse.b||!stdMat.diffuseTint&&(stdMat.diffuseMap||stdMat.diffuseVertexColor)?0:3,specularTint=!1,useSpecular=!!(stdMat.useMetalness||stdMat.specularMap||stdMat.sphereMap||stdMat.cubeMap||stdMat.dpAtlas);(useSpecular=(useSpecular=(useSpecular=useSpecular||!!stdMat.useMetalness||!(0===stdMat.specular.r&&0===stdMat.specular.g&&0===stdMat.specular.b))||stdMat.enableGGXSpecular)||stdMat.clearCoat>0)&&(!stdMat.specularTint&&(stdMat.specularMap||stdMat.specularVertexColor)||stdMat.useMetalness||(specularTint=1!==stdMat.specular.r||1!==stdMat.specular.g||1!==stdMat.specular.b));var emissiveTint=stdMat.emissiveMap?0:3;emissiveTint||(emissiveTint=(emissiveTint=(1!==stdMat.emissive.r||1!==stdMat.emissive.g||1!==stdMat.emissive.b||1!==stdMat.emissiveIntensity)&&stdMat.emissiveTint)?3:1!==stdMat.emissiveIntensity?1:0);var isPackedNormalMap=!!stdMat.normalMap&&(10===stdMat.normalMap.format||"swizzleGGGR"===stdMat.normalMap.type);options.opacityTint=1!==stdMat.opacity&&3!==stdMat.blendType?1:0,options.blendMapsWithColors=!0,options.ambientTint=stdMat.ambientTint,options.diffuseTint=diffuseTint,options.specularTint=specularTint?3:0,options.metalnessTint=stdMat.useMetalness&&stdMat.metalness<1?1:0,options.glossTint=1,options.emissiveTint=emissiveTint,options.alphaToCoverage=stdMat.alphaToCoverage,options.normalizeNormalMap=stdMat.normalizeNormalMap,options.sphereMap=!!stdMat.sphereMap,options.cubeMap=!!stdMat.cubeMap,options.dpAtlas=!!stdMat.dpAtlas,options.ambientSH=!!stdMat.ambientSH,options.useSpecular=useSpecular,options.emissiveFormat=stdMat.emissiveMap?"rgbm"===stdMat.emissiveMap.type?1:14===stdMat.emissiveMap.format?2:0:null,options.lightMapFormat=stdMat.lightMap?"rgbm"===stdMat.lightMap.type?1:14===stdMat.lightMap.format?2:0:null,options.specularAntialias=stdMat.specularAntialias&&!!stdMat.normalMap&&!!stdMat.normalMap.mipmaps&&!isPackedNormalMap,options.conserveEnergy=stdMat.conserveEnergy,options.opacityFadesSpecular=stdMat.opacityFadesSpecular,options.alphaFade=stdMat.alphaFade,options.occludeSpecular=stdMat.occludeSpecular,options.occludeSpecularFloat=1!==stdMat.occludeSpecularIntensity,options.occludeDirect=stdMat.occludeDirect,options.shadingModel=stdMat.shadingModel,options.fresnelModel=stdMat.fresnelModel,options.packedNormal=isPackedNormalMap,options.fastTbn=stdMat.fastTbn,options.cubeMapProjection=stdMat.cubeMapProjection,options.customFragmentShader=stdMat.customFragmentShader,options.refraction=!!stdMat.refraction,options.useMetalness=stdMat.useMetalness,options.enableGGXSpecular=stdMat.enableGGXSpecular,options.msdf=!!stdMat.msdfMap,options.twoSidedLighting=stdMat.twoSidedLighting,options.pixelSnap=stdMat.pixelSnap,options.aoMapUv=stdMat.aoUvSet,options.diffuseDetail=!!stdMat.diffuseMap,options.normalDetail=!!stdMat.normalMap,options.diffuseDetailMode=stdMat.diffuseDetailMode,options.detailModes=!!options.diffuseDetail,options.clearCoat=!!stdMat.clearCoat,options.clearCoatTint=1!==stdMat.clearCoat?1:0,options.clearCoatGlossiness=!!stdMat.clearCoatGlossiness,options.clearCoatGlossTint=1!==stdMat.clearCoatGlossiness?1:0},StandardMaterialOptionsBuilder.prototype._updateEnvOptions=function(options,stdMat,scene,prefilteredCubeMap128){var rgbmAmbient=prefilteredCubeMap128&&"rgbm"===prefilteredCubeMap128.type||stdMat.cubeMap&&"rgbm"===stdMat.cubeMap.type||stdMat.dpAtlas&&"rgbm"===stdMat.dpAtlas.type,hdrAmbient=prefilteredCubeMap128&&("rgbm"===prefilteredCubeMap128.type||14===prefilteredCubeMap128.format)||stdMat.cubeMap&&("rgbm"===stdMat.cubeMap.type||14===stdMat.cubeMap.format)||stdMat.dpAtlas&&("rgbm"===stdMat.dpAtlas.type||14===stdMat.dpAtlas.format),rgbmReflection=prefilteredCubeMap128&&!stdMat.cubeMap&&!stdMat.sphereMap&&!stdMat.dpAtlas&&"rgbm"===prefilteredCubeMap128.type||stdMat.cubeMap&&"rgbm"===stdMat.cubeMap.type||stdMat.sphereMap&&"rgbm"===stdMat.sphereMap.type||stdMat.dpAtlas&&"rgbm"===stdMat.dpAtlas.type,hdrReflection=!(!prefilteredCubeMap128||stdMat.cubeMap||stdMat.sphereMap||stdMat.dpAtlas)&&("rgbm"===prefilteredCubeMap128.type||14===prefilteredCubeMap128.format)||stdMat.cubeMap&&("rgbm"===stdMat.cubeMap.type||14===stdMat.cubeMap.format)||stdMat.sphereMap&&("rgbm"===stdMat.sphereMap.type||14===stdMat.sphereMap.format)||stdMat.dpAtlas&&("rgbm"===stdMat.dpAtlas.type||14===stdMat.dpAtlas.format),globalSky128;stdMat.useSkybox&&scene._skyboxPrefiltered&&(globalSky128=scene._skyboxPrefiltered[0]),options.fog=stdMat.useFog?scene.fog:"none",options.gamma=stdMat.useGammaTonemap?scene.gammaCorrection:0,options.toneMap=stdMat.useGammaTonemap?scene.toneMapping:-1,options.rgbmAmbient=rgbmAmbient,options.hdrAmbient=hdrAmbient,options.rgbmReflection=rgbmReflection,options.hdrReflection=hdrReflection,options.useRgbm=rgbmReflection||rgbmAmbient||stdMat.emissiveMap&&"rgbm"===stdMat.emissiveMap.type||stdMat.lightMap&&"rgbm"===stdMat.lightMap.type,options.fixSeams=prefilteredCubeMap128?prefilteredCubeMap128.fixCubemapSeams:!!stdMat.cubeMap&&stdMat.cubeMap.fixCubemapSeams,options.prefilteredCubemap=!!prefilteredCubeMap128,options.skyboxIntensity=prefilteredCubeMap128&&globalSky128&&prefilteredCubeMap128===globalSky128&&1!==scene.skyboxIntensity,options.useCubeMapRotation=!stdMat.cubeMap&&!stdMat.prefilteredCubeMap128&&stdMat.useSkybox&&scene&&scene.skyboxRotation&&!scene.skyboxRotation.equals(Quat.IDENTITY),options.useRightHandedCubeMap=stdMat.cubeMap?stdMat.cubeMap._isRenderTarget:!stdMat.prefilteredCubeMap128&&stdMat.useSkybox&&scene&&scene._skyboxIsRenderTarget},StandardMaterialOptionsBuilder.prototype._updateLightOptions=function(options,stdMat,objDefs,sortedLights,staticLightList){if(options.lightMap=!1,options.lightMapChannel="",options.lightMapUv=0,options.lightMapTransform=0,options.lightMapWithoutAmbient=!1,options.dirLightMap=!1,objDefs&&(options.noShadow=0!=(1&objDefs),0!=(64&objDefs)&&(options.lightMapFormat=1,options.lightMap=!0,options.lightMapChannel="rgb",options.lightMapUv=1,options.lightMapTransform=0,options.lightMapWithoutAmbient=!stdMat.lightMap,options.useRgbm=!0,0!=(128&objDefs)&&(options.dirLightMap=!0))),stdMat.useLighting){var lightsFiltered=[],mask=objDefs?objDefs>>16:1;sortedLights&&(this._collectLights(0,sortedLights[0],lightsFiltered,mask),this._collectLights(1,sortedLights[1],lightsFiltered,mask,staticLightList),this._collectLights(2,sortedLights[2],lightsFiltered,mask,staticLightList)),options.lights=lightsFiltered}else options.lights=[];0===options.lights.length&&(options.noShadow=!0)},StandardMaterialOptionsBuilder.prototype._updateTexOptions=function(options,stdMat,p,hasUv0,hasUv1,hasVcolor,minimalOptions){var mname=p+"Map",vname=p+"VertexColor",vcname=p+"VertexColorChannel",cname=mname+"Channel",tname=mname+"Transform",uname=mname+"Uv";"light"!==p&&(options[mname]=!1,options[cname]="",options[tname]=0,options[uname]=0),options[vname]=!1,options[vcname]="";var isOpacity="opacity"===p;if(isOpacity&&3===stdMat.blendType&&0===stdMat.alphaTest&&!stdMat.alphaToCoverage)return options;if((!minimalOptions||isOpacity)&&("height"!==p&&stdMat[vname]&&hasVcolor&&(options[vname]=stdMat[vname],options[vcname]=stdMat[vcname],options.vertexColors=!0),stdMat[mname])){var allow=!0;0!==stdMat[uname]||hasUv0||(allow=!1),1!==stdMat[uname]||hasUv1||(allow=!1),allow&&(options[mname]=!!stdMat[mname],options[tname]=this._getMapTransformID(stdMat[tname],stdMat[uname]),options[cname]=stdMat[cname],options[uname]=stdMat[uname])}},StandardMaterialOptionsBuilder.prototype._collectLights=function(lType,lights,lightsFiltered,mask,staticLightList){var light,i;for(i=0;i<lights.length;i++)if((light=lights[i]).enabled&&light.mask&mask){if(0!==lType&&light.isStatic)continue;lightsFiltered.push(light)}if(staticLightList)for(i=0;i<staticLightList.length;i++)(light=staticLightList[i])._type===lType&&lightsFiltered.push(light)},StandardMaterialOptionsBuilder.prototype._getMapTransformID=function(xform,uv){if(!xform)return 0;var i,same;for(this._mapXForms[uv]||(this._mapXForms[uv]=[]),i=0;i<this._mapXForms[uv].length;i++){if(same=!0,this._mapXForms[uv][i][0]!==xform.x){same=!1;break}if(this._mapXForms[uv][i][1]!==xform.y){same=!1;break}if(this._mapXForms[uv][i][2]!==xform.z){same=!1;break}if(this._mapXForms[uv][i][3]!==xform.w){same=!1;break}if(same)return i+1}var newID=this._mapXForms[uv].length;return this._mapXForms[uv][newID]=[],this._mapXForms[uv][newID][0]=xform.x,this._mapXForms[uv][newID][1]=xform.y,this._mapXForms[uv][newID][2]=xform.z,this._mapXForms[uv][newID][3]=xform.w,newID+1};var standardMaterialParameterTypes={name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb",ambientTint:"boolean",aoVertexColor:"boolean",aoVertexColorChannel:"string",aoMap:"texture",aoMapChannel:"string",aoMapUv:"number",aoMapTiling:"vec2",aoMapOffset:"vec2",diffuse:"rgb",diffuseTint:"boolean",diffuseVertexColor:"boolean",diffuseVertexColorChannel:"string",diffuseMap:"texture",diffuseMapChannel:"string",diffuseMapUv:"number",diffuseMapTiling:"vec2",diffuseMapOffset:"vec2",diffuseDetailMap:"texture",diffuseDetailMapChannel:"string",diffuseDetailMapUv:"number",diffuseDetailMapTiling:"vec2",diffuseDetailMapOffset:"vec2",diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean",specularVertexColor:"boolean",specularVertexColorChannel:"string",specularMap:"texture",specularMapChannel:"string",specularMapUv:"number",specularMapTiling:"vec2",specularMapOffset:"vec2",specularAntialias:"boolean",occludeSpecular:"enum:occludeSpecular",useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",anisotropy:"number",metalnessTint:"boolean",metalnessVertexColor:"boolean",metalnessVertexColorChannel:"string",metalnessMap:"texture",metalnessMapChannel:"string",metalnessMapUv:"number",metalnessMapTiling:"vec2",metalnessMapOffset:"vec2",conserveEnergy:"boolean",shininess:"number",glossVertexColor:"boolean",glossVertexColorChannel:"string",glossMap:"texture",glossMapChannel:"string",glossMapUv:"number",glossMapTiling:"vec2",glossMapOffset:"vec2",clearCoat:"number",clearCoatVertexColor:"boolean",clearCoatVertexColorChannel:"string",clearCoatMap:"texture",clearCoatMapChannel:"string",clearCoatMapUv:"number",clearCoatMapTiling:"vec2",clearCoatMapOffset:"vec2",clearCoatGlossiness:"number",clearCoatGlossVertexColor:"boolean",clearCoatGlossVertexColorChannel:"string",clearCoatGlossMap:"texture",clearCoatGlossMapChannel:"string",clearCoatGlossMapUv:"number",clearCoatGlossMapTiling:"vec2",clearCoatGlossMapOffset:"vec2",clearCoatBumpiness:"number",clearCoatNormalMap:"texture",clearCoatNormalMapUv:"number",clearCoatNormalMapTiling:"vec2",clearCoatNormalMapOffset:"vec2",fresnelModel:"number",emissive:"rgb",emissiveTint:"boolean",emissiveVertexColor:"boolean",emissiveVertexColorChannel:"string",emissiveMap:"texture",emissiveMapChannel:"string",emissiveMapUv:"number",emissiveMapTiling:"vec2",emissiveMapOffset:"vec2",emissiveIntensity:"number",normalMap:"texture",normalMapTiling:"vec2",normalMapOffset:"vec2",normalMapUv:"number",bumpiness:"number",normalDetailMap:"texture",normalDetailMapTiling:"vec2",normalDetailMapOffset:"vec2",normalDetailMapUv:"number",normalDetailMapBumpiness:"number",heightMap:"texture",heightMapChannel:"string",heightMapUv:"number",heightMapTiling:"vec2",heightMapOffset:"vec2",heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",alphaFade:"number",opacity:"number",opacityVertexColor:"boolean",opacityVertexColorChannel:"string",opacityMap:"texture",opacityMapChannel:"string",opacityMapUv:"number",opacityMapTiling:"vec2",opacityMapOffset:"vec2",opacityFadesSpecular:"boolean",reflectivity:"number",refraction:"number",refractionIndex:"number",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",lightVertexColor:"boolean",lightVertexColorChannel:"string",lightMap:"texture",lightMapChannel:"string",lightMapUv:"number",lightMapTiling:"vec2",lightMapOffset:"vec2",depthTest:"boolean",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",shadingModel:"enum:shadingModel",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useGammaTonemap:"boolean",prefilteredCubeMap128:"texture",prefilteredCubeMap64:"texture",prefilteredCubeMap32:"texture",prefilteredCubeMap16:"texture",prefilteredCubeMap8:"texture",prefilteredCubeMap4:"texture"},key,type,standardMaterialTextureParameters=[];for(key in standardMaterialParameterTypes)"texture"===(type=standardMaterialParameterTypes[key])&&standardMaterialTextureParameters.push(key);var standardMaterialCubemapParameters=[];for(key in standardMaterialParameterTypes)"cubemap"===(type=standardMaterialParameterTypes[key])&&standardMaterialCubemapParameters.push(key);var _propsSerial=[],_propsSerialDefaultVal=[],_propsInternalNull=[],_propsInternalVec3=[],_prop2Uniform={},_propsColor=[],Chunks=function(){function Chunks(){}var _proto;return Chunks.prototype.copy=function copy(from){for(var p in from)from.hasOwnProperty(p)&&"copy"!==p&&(this[p]=from[p])},Chunks}(),StandardMaterial=function(_Material){function StandardMaterial(){var _this;return(_this=_Material.call(this)||this)._assetReferences={},_this._validator=null,_this.shaderOptBuilder=new StandardMaterialOptionsBuilder,_this.reset(),_this}_inheritsLoose(StandardMaterial,_Material);var _proto2=StandardMaterial.prototype;return _proto2.reset=function reset(){for(var i=0;i<_propsSerial.length;i++){var defVal=_propsSerialDefaultVal[i];this[_propsSerial[i]]=defVal&&defVal.clone?defVal.clone():defVal}for(var _i=0;_i<_propsInternalNull.length;_i++)this[_propsInternalNull[_i]]=null;for(var _i2=0;_i2<_propsInternalVec3.length;_i2++)this[_propsInternalVec3[_i2]]=new Float32Array(3);this._chunks=new Chunks,this.cubeMapMinUniform=new Float32Array(3),this.cubeMapMaxUniform=new Float32Array(3)},_proto2.clone=function clone(){var clone=new StandardMaterial;this._cloneInternal(clone);for(var i=0;i<_propsSerial.length;i++){var pname=_propsSerial[i];void 0!==this[pname]&&(this[pname]&&this[pname].copy?clone[pname]?clone[pname].copy(this[pname]):clone[pname]=this[pname].clone():clone[pname]=this[pname])}return clone},_proto2._updateMapTransform=function _updateMapTransform(transform,tiling,offset){return 1===tiling.x&&1===tiling.y&&0===offset.x&&0===offset.y?null:((transform=transform||new Vec4).set(tiling.x,tiling.y,offset.x,offset.y),transform)},_proto2._setParameter=function _setParameter(name,value){this.parameters[name]||this._propsSet.push(name),this.setParameter(name,value)},_proto2._clearParameters=function _clearParameters(){for(var props=this._propsSet,i=0;i<props.length;i++)delete this.parameters[props[i]];this._propsSet=[]},_proto2._updateMap=function _updateMap(p){var mname=p+"Map",map=this[mname];if(map){this._setParameter("texture_"+mname,map);var tname=mname+"Transform";this[tname]=this._updateMapTransform(this[tname],this[mname+"Tiling"],this[mname+"Offset"]);var transform=this[tname];if(transform){var uname=mname+"TransformUniform",uniform=this[uname];uniform||(uniform=new Float32Array(4),this[uname]=uniform),uniform[0]=transform.x,uniform[1]=transform.y,uniform[2]=transform.z,uniform[3]=transform.w,this._setParameter("texture_"+tname,uniform)}}},_proto2.getUniform=function getUniform(varName,value,changeMat){var func=_prop2Uniform[varName];return func?func(this,value,changeMat):null},_proto2.updateUniforms=function updateUniforms(){this._clearParameters(),this._setParameter("material_ambient",this.ambientUniform),this.diffuseMap&&!this.diffuseTint||this._setParameter("material_diffuse",this.diffuseUniform),this.useMetalness?(!this.metalnessMap||this.metalness<1)&&this._setParameter("material_metalness",this.metalness):this.specularMap&&!this.specularTint||this._setParameter("material_specular",this.specularUniform),this.enableGGXSpecular&&this._setParameter("material_anisotropy",this.anisotropy),this.clearCoat>0&&(this._setParameter("material_clearCoat",this.clearCoat),this._setParameter("material_clearCoatGlossiness",this.clearCoatGlossiness),this._setParameter("material_clearCoatReflectivity",this.clearCoat),this._setParameter("material_clearCoatBumpiness",this.clearCoatBumpiness));var uniform=this.getUniform("shininess",this.shininess,!0);for(var p in this._setParameter(uniform.name,uniform.value),this.emissiveMap&&!this.emissiveTint||this._setParameter("material_emissive",this.emissiveUniform),this.emissiveMap&&this._setParameter("material_emissiveIntensity",this.emissiveIntensity),this.refraction>0&&(this._setParameter("material_refraction",this.refraction),this._setParameter("material_refractionIndex",this.refractionIndex)),this._setParameter("material_opacity",this.opacity),!1===this.opacityFadesSpecular&&this._setParameter("material_alphaFade",this.alphaFade),this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity),1===this.cubeMapProjection&&this._setParameter(this.getUniform("cubeMapProjectionBox",this.cubeMapProjectionBox,!0)),_matTex2D)this._updateMap(p);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH),this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness),this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness),this.heightMap&&(uniform=this.getUniform("heightMapFactor",this.heightMapFactor,!0),this._setParameter(uniform.name,uniform.value)),this.cubeMap&&this._setParameter("texture_cubeMap",this.cubeMap),this.prefilteredCubeMap128?this._setParameter("texture_prefilteredCubeMap128",this.prefilteredCubeMap128):this._scene&&this._scene._skyboxPrefiltered[0]&&this._setParameter("texture_prefilteredCubeMap128",this._scene._skyboxPrefiltered[0]),this.prefilteredCubeMap64?this._setParameter("texture_prefilteredCubeMap64",this.prefilteredCubeMap64):this._scene&&this._scene._skyboxPrefiltered[1]&&this._setParameter("texture_prefilteredCubeMap64",this._scene._skyboxPrefiltered[1]),this.prefilteredCubeMap32?this._setParameter("texture_prefilteredCubeMap32",this.prefilteredCubeMap32):this._scene&&this._scene._skyboxPrefiltered[2]&&this._setParameter("texture_prefilteredCubeMap32",this._scene._skyboxPrefiltered[2]),this.prefilteredCubeMap16?this._setParameter("texture_prefilteredCubeMap16",this.prefilteredCubeMap16):this._scene&&this._scene._skyboxPrefiltered[3]&&this._setParameter("texture_prefilteredCubeMap16",this._scene._skyboxPrefiltered[3]),this.prefilteredCubeMap8?this._setParameter("texture_prefilteredCubeMap8",this.prefilteredCubeMap8):this._scene&&this._scene._skyboxPrefiltered[4]&&this._setParameter("texture_prefilteredCubeMap8",this._scene._skyboxPrefiltered[4]),this.prefilteredCubeMap4?this._setParameter("texture_prefilteredCubeMap4",this.prefilteredCubeMap4):this._scene&&this._scene._skyboxPrefiltered[5]&&this._setParameter("texture_prefilteredCubeMap4",this._scene._skyboxPrefiltered[5]),this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap),this.dpAtlas&&this._setParameter("texture_sphereMap",this.dpAtlas),this._setParameter("material_reflectivity",this.reflectivity),!this.dirtyShader&&this._scene||(this.shader=null,this.clearVariants()),this._processColor()},_proto2._processColor=function _processColor(){if(this.dirtyColor&&(this._scene||!this.useGammaTonemap)){var gammaCorrection=!1;this.useGammaTonemap&&(gammaCorrection=this._scene.gammaCorrection);for(var i=0;i<_propsColor.length;i++){var clr=this["_"+_propsColor[i]],arr=this[_propsColor[i]+"Uniform"];gammaCorrection?(arr[0]=Math.pow(clr.r,2.2),arr[1]=Math.pow(clr.g,2.2),arr[2]=Math.pow(clr.b,2.2)):(arr[0]=clr.r,arr[1]=clr.g,arr[2]=clr.b)}for(var c=0;c<3;c++)this.emissiveUniform[c]*=this.emissiveIntensity;this.dirtyColor=!1}},_proto2.updateShader=function updateShader(device,scene,objDefs,staticLightList,pass,sortedLights){!this._colorProcessed&&this._scene&&(this._colorProcessed=!0,this._processColor());var useTexCubeLod=device.useTexCubeLod,useDp=!device.extTextureLod,globalSky128,globalSky64,globalSky32,globalSky16,globalSky8,globalSky4;this.useSkybox&&(globalSky128=scene._skyboxPrefiltered[0],globalSky64=scene._skyboxPrefiltered[1],globalSky32=scene._skyboxPrefiltered[2],globalSky16=scene._skyboxPrefiltered[3],globalSky8=scene._skyboxPrefiltered[4],globalSky4=scene._skyboxPrefiltered[5]);var prefilteredCubeMap128=this.prefilteredCubeMap128||globalSky128,prefilteredCubeMap64=this.prefilteredCubeMap64||globalSky64,prefilteredCubeMap32=this.prefilteredCubeMap32||globalSky32,prefilteredCubeMap16=this.prefilteredCubeMap16||globalSky16,prefilteredCubeMap8=this.prefilteredCubeMap8||globalSky8,prefilteredCubeMap4=this.prefilteredCubeMap4||globalSky4;if(prefilteredCubeMap128){var allMips=prefilteredCubeMap128&&prefilteredCubeMap64&&prefilteredCubeMap32&&prefilteredCubeMap16&&prefilteredCubeMap8&&prefilteredCubeMap4;if(useDp&&allMips){if(!prefilteredCubeMap128.dpAtlas){var atlas=[prefilteredCubeMap128,prefilteredCubeMap64,prefilteredCubeMap32,prefilteredCubeMap16,prefilteredCubeMap8,prefilteredCubeMap4];prefilteredCubeMap128.dpAtlas=generateDpAtlas(device,atlas),prefilteredCubeMap128.sh=shFromCubemap(device,prefilteredCubeMap16)}this.dpAtlas=prefilteredCubeMap128.dpAtlas,this.ambientSH=prefilteredCubeMap128.sh,this._setParameter("ambientSH[0]",this.ambientSH),this._setParameter("texture_sphereMap",this.dpAtlas)}else useTexCubeLod?prefilteredCubeMap128._levels.length<6?allMips?this._setParameter("texture_prefilteredCubeMap128",prefilteredCubeMap128):console.log("Can't use prefiltered cubemap: "+allMips+", "+useTexCubeLod+", "+prefilteredCubeMap128._levels):this._setParameter("texture_prefilteredCubeMap128",prefilteredCubeMap128):allMips?(this._setParameter("texture_prefilteredCubeMap128",prefilteredCubeMap128),this._setParameter("texture_prefilteredCubeMap64",prefilteredCubeMap64),this._setParameter("texture_prefilteredCubeMap32",prefilteredCubeMap32),this._setParameter("texture_prefilteredCubeMap16",prefilteredCubeMap16),this._setParameter("texture_prefilteredCubeMap8",prefilteredCubeMap8),this._setParameter("texture_prefilteredCubeMap4",prefilteredCubeMap4)):console.log("Can't use prefiltered cubemap: "+allMips+", "+useTexCubeLod+", "+prefilteredCubeMap128._levels);this.useSkybox&&!scene.skyboxRotation.equals(Quat.IDENTITY)&&scene._skyboxRotationMat3&&this._setParameter("cubeMapRotationMatrix",scene._skyboxRotationMat3.data)}var minimalOptions=pass>1&&pass<=18,options=minimalOptions?standard.optionsContextMin:standard.optionsContext;minimalOptions?this.shaderOptBuilder.updateMinRef(options,device,scene,this,objDefs,staticLightList,pass,sortedLights,prefilteredCubeMap128):this.shaderOptBuilder.updateRef(options,device,scene,this,objDefs,staticLightList,pass,sortedLights,prefilteredCubeMap128),this.onUpdateShader&&(options=this.onUpdateShader(options));var library=device.getProgramLibrary();this.shader=library.getProgram("standard",options),objDefs||(this.clearVariants(),this.variants[0]=this.shader),this.dirtyShader=!1},_proto2.destroy=function destroy(){for(var asset in this._assetReferences)this._assetReferences[asset]._unbind();this._assetReferences=null,this._validator=null,_Material.prototype.destroy.call(this)},StandardMaterial}(Material);function _defineTex2D(obj,name,uv,channels,defChannel,vertexColor,detailMode){var privMap="_"+name+"Map",privMapTiling=privMap+"Tiling",privMapOffset=privMap+"Offset",mapTransform=privMap.substring(1)+"Transform",mapTransformUniform=mapTransform+"Uniform",privMapUv=privMap+"Uv",privMapChannel=privMap+"Channel",privMapVertexColor="_"+name+"VertexColor",privMapVertexColorChannel="_"+name+"VertexColorChannel",privMapDetailMode="_"+name+"Mode";if(obj[privMap]=null,obj[privMapTiling]=new Vec2(1,1),obj[privMapOffset]=new Vec2(0,0),obj[mapTransform]=null,obj[mapTransformUniform]=null,obj[privMapUv]=uv,channels>0){var channel=defChannel||(channels>1?"rgb":"g");obj[privMapChannel]=channel,vertexColor&&(obj[privMapVertexColorChannel]=channel)}vertexColor&&(obj[privMapVertexColor]=!1),detailMode&&(obj[privMapDetailMode]="mul"),_matTex2D[name]=channels,Object.defineProperty(StandardMaterial.prototype,privMap.substring(1),{get:function get(){return this[privMap]},set:function set(value){var oldVal=this[privMap];!!oldVal^!!value&&(this.dirtyShader=!0),oldVal&&value&&(oldVal.type===value.type&&oldVal.fixCubemapSeams===value.fixCubemapSeams&&oldVal.format===value.format||(this.dirtyShader=!0)),this[privMap]=value}});var mapTiling=privMapTiling.substring(1),mapOffset=privMapOffset.substring(1);Object.defineProperty(StandardMaterial.prototype,mapTiling,{get:function get(){return this[privMapTiling]},set:function set(value){this.dirtyShader=!0,this[privMapTiling]=value}}),_prop2Uniform[mapTiling]=function(mat,val,changeMat){var tform=mat._updateMapTransform(changeMat?mat[mapTransform]:null,val,mat[privMapOffset]);return{name:"texture_"+mapTransform,value:tform.data}},Object.defineProperty(StandardMaterial.prototype,mapOffset,{get:function get(){return this[privMapOffset]},set:function set(value){this.dirtyShader=!0,this[privMapOffset]=value}}),_prop2Uniform[mapOffset]=function(mat,val,changeMat){var tform=mat._updateMapTransform(changeMat?mat[mapTransform]:null,mat[privMapTiling],val);return{name:"texture_"+mapTransform,value:tform.data}},Object.defineProperty(StandardMaterial.prototype,privMapUv.substring(1),{get:function get(){return this[privMapUv]},set:function set(value){this[privMapUv]!==value&&(this.dirtyShader=!0),this[privMapUv]=value}}),Object.defineProperty(StandardMaterial.prototype,privMapChannel.substring(1),{get:function get(){return this[privMapChannel]},set:function set(value){this[privMapChannel]!==value&&(this.dirtyShader=!0),this[privMapChannel]=value}}),vertexColor&&(Object.defineProperty(StandardMaterial.prototype,privMapVertexColor.substring(1),{get:function get(){return this[privMapVertexColor]},set:function set(value){this.dirtyShader=!0,this[privMapVertexColor]=value}}),Object.defineProperty(StandardMaterial.prototype,privMapVertexColorChannel.substring(1),{get:function get(){return this[privMapVertexColorChannel]},set:function set(value){this[privMapVertexColorChannel]!==value&&(this.dirtyShader=!0),this[privMapVertexColorChannel]=value}})),detailMode&&Object.defineProperty(StandardMaterial.prototype,privMapDetailMode.substring(1),{get:function get(){return this[privMapDetailMode]},set:function set(value){this.dirtyShader=!0,this[privMapDetailMode]=value}}),_propsSerial.push(privMap.substring(1)),_propsSerial.push(privMapTiling.substring(1)),_propsSerial.push(privMapOffset.substring(1)),_propsSerial.push(privMapUv.substring(1)),_propsSerial.push(privMapChannel.substring(1)),vertexColor&&(_propsSerial.push(privMapVertexColor.substring(1)),_propsSerial.push(privMapVertexColorChannel.substring(1))),detailMode&&_propsSerial.push(privMapDetailMode.substring(1)),_propsInternalNull.push(mapTransform)}function _defineColor(obj,name,defaultValue,hasMultiplier){var priv="_"+name,uform=name+"Uniform",mult=name+"Intensity",pmult="_"+mult;obj[priv]=defaultValue,obj[uform]=new Float32Array(3),Object.defineProperty(StandardMaterial.prototype,name,{get:function get(){return this.dirtyColor=!0,this.dirtyShader=!0,this[priv]},set:function set(newValue){var oldValue=this[priv],wasRound,isRound;(0===oldValue.r&&0===oldValue.g&&0===oldValue.b||1===oldValue.r&&1===oldValue.g&&1===oldValue.b)^(0===newValue.r&&0===newValue.g&&0===newValue.b||1===newValue.r&&1===newValue.g&&1===newValue.b)&&(this.dirtyShader=!0),this.dirtyColor=!0,this[priv]=newValue}}),_propsSerial.push(name),_propsInternalVec3.push(uform),_propsColor.push(name),_prop2Uniform[name]=function(mat,val,changeMat){var arr=changeMat?mat[uform]:new Float32Array(3),gammaCorrection=!1,scene;mat.useGammaTonemap&&(gammaCorrection=(mat._scene||getApplication().scene).gammaCorrection);for(var c=0;c<3;c++)arr[c]=gammaCorrection?Math.pow(val.data[c],2.2):val.data[c],hasMultiplier&&(arr[c]*=mat[pmult]);return{name:"material_"+name,value:arr}},hasMultiplier&&(obj[pmult]=1,Object.defineProperty(StandardMaterial.prototype,mult,{get:function get(){return this[pmult]},set:function set(newValue){var oldValue=this[pmult],wasRound,isRound;(0===oldValue||1===oldValue)^(0===newValue||1===newValue)&&(this.dirtyShader=!0),this.dirtyColor=!0,this[pmult]=newValue}}),_propsSerial.push(mult),_prop2Uniform[mult]=function(mat,val,changeMat){var arr=changeMat?mat[uform]:new Float32Array(3),gammaCorrection=!1,scene;mat.useGammaTonemap&&(gammaCorrection=(mat._scene||getApplication().scene).gammaCorrection);for(var c=0;c<3;c++)arr[c]=gammaCorrection?Math.pow(mat[priv].data[c],2.2):mat[priv].data[c],arr[c]*=mat[pmult];return{name:"material_"+name,value:arr}})}function _defineFloat(obj,name,defaultValue,func){var priv="_"+name;obj[priv]=defaultValue,Object.defineProperty(StandardMaterial.prototype,name,{get:function get(){return this[priv]},set:function set(newValue){var oldValue=this[priv],wasRound,isRound;oldValue!==newValue&&(this[priv]=newValue,(0===oldValue||1===oldValue||(0===newValue||1===newValue))&&(this.dirtyShader=!0))}}),_propsSerial.push(name),_prop2Uniform[name]=void 0!==func?func:function(mat,val,changeMat){return{name:"material_"+name,value:val}}}function _defineObject(obj,name,func){var priv="_"+name;obj[priv]=null,Object.defineProperty(StandardMaterial.prototype,name,{get:function get(){return this[priv]},set:function set(value){var oldVal;!!this[priv]^!!value&&(this.dirtyShader=!0),this[priv]=value}}),_propsSerial.push(name),_prop2Uniform[name]=func}function _defineAlias(obj,newName,oldName){Object.defineProperty(StandardMaterial.prototype,oldName,{get:function get(){return this[newName]},set:function set(value){this[newName]=value}})}function _defineChunks(obj){Object.defineProperty(StandardMaterial.prototype,"chunks",{get:function get(){return this.dirtyShader=!0,this._chunks},set:function set(value){this.dirtyShader=!0,this._chunks=value}}),_propsSerial.push("chunks")}function _defineFlag(obj,name,defaultValue){var priv="_"+name;obj[priv]=defaultValue,Object.defineProperty(StandardMaterial.prototype,name,{get:function get(){return this[priv]},set:function set(value){this[priv]!==value&&(this.dirtyShader=!0),this[priv]=value}}),_propsSerial.push(name)}function _defineMaterialProps(obj){obj.dirtyShader=!0,obj.dirtyColor=!0,obj._scene=null,obj._colorProcessed=!1,_defineColor(obj,"ambient",new Color(.7,.7,.7)),_defineColor(obj,"diffuse",new Color(1,1,1)),_defineColor(obj,"specular",new Color(0,0,0)),_defineColor(obj,"emissive",new Color(0,0,0),!0),_defineFloat(obj,"shininess",25,(function(mat,shininess){var value;return{name:"material_shininess",value:value=0===mat.shadingModel?Math.pow(2,.01*shininess*11):.01*shininess}})),_defineFloat(obj,"heightMapFactor",1,(function(mat,height){return{name:"material_heightMapFactor",value:.025*height}})),_defineFloat(obj,"opacity",1),_defineFloat(obj,"alphaFade",1),_defineFloat(obj,"alphaTest",0),_defineFloat(obj,"bumpiness",1),_defineFloat(obj,"normalDetailMapBumpiness",1),_defineFloat(obj,"reflectivity",1),_defineFloat(obj,"occludeSpecularIntensity",1),_defineFloat(obj,"refraction",0),_defineFloat(obj,"refractionIndex",1/1.5),_defineFloat(obj,"metalness",1),_defineFloat(obj,"anisotropy",0),_defineFloat(obj,"clearCoat",0),_defineFloat(obj,"clearCoatGlossiness",1),_defineFloat(obj,"clearCoatBumpiness",1),_defineFloat(obj,"aoUvSet",0,null),_defineObject(obj,"ambientSH",(function(mat,val,changeMat){return{name:"ambientSH[0]",value:val}})),_defineObject(obj,"cubeMapProjectionBox",(function(mat,val,changeMat){var bmin=changeMat?mat.cubeMapMinUniform:new Float32Array(3),bmax=changeMat?mat.cubeMapMaxUniform:new Float32Array(3);return bmin[0]=val.center.x-val.halfExtents.x,bmin[1]=val.center.y-val.halfExtents.y,bmin[2]=val.center.z-val.halfExtents.z,bmax[0]=val.center.x+val.halfExtents.x,bmax[1]=val.center.y+val.halfExtents.y,bmax[2]=val.center.z+val.halfExtents.z,[{name:"envBoxMin",value:bmin},{name:"envBoxMax",value:bmax}]})),_defineChunks(),_defineFlag(obj,"ambientTint",!1),_defineFlag(obj,"diffuseTint",!1),_defineFlag(obj,"specularTint",!1),_defineFlag(obj,"emissiveTint",!1),_defineFlag(obj,"fastTbn",!1),_defineFlag(obj,"specularAntialias",!1),_defineFlag(obj,"useMetalness",!1),_defineFlag(obj,"enableGGXSpecular",!1),_defineFlag(obj,"occludeDirect",!1),_defineFlag(obj,"normalizeNormalMap",!0),_defineFlag(obj,"conserveEnergy",!0),_defineFlag(obj,"opacityFadesSpecular",!0),_defineFlag(obj,"occludeSpecular",1),_defineFlag(obj,"shadingModel",1),_defineFlag(obj,"fresnelModel",2),_defineFlag(obj,"cubeMapProjection",0),_defineFlag(obj,"customFragmentShader",null),_defineFlag(obj,"forceFragmentPrecision",null),_defineFlag(obj,"useFog",!0),_defineFlag(obj,"useLighting",!0),_defineFlag(obj,"useGammaTonemap",!0),_defineFlag(obj,"useSkybox",!0),_defineFlag(obj,"forceUv1",!1),_defineFlag(obj,"pixelSnap",!1),_defineFlag(obj,"twoSidedLighting",!1),_defineFlag(obj,"nineSlicedMode",void 0),_defineTex2D(obj,"diffuse",0,3,"",!0),_defineTex2D(obj,"specular",0,3,"",!0),_defineTex2D(obj,"emissive",0,3,"",!0),_defineTex2D(obj,"normal",0,-1,"",!1),_defineTex2D(obj,"metalness",0,1,"",!0),_defineTex2D(obj,"gloss",0,1,"",!0),_defineTex2D(obj,"opacity",0,1,"a",!0),_defineTex2D(obj,"height",0,1,"",!1),_defineTex2D(obj,"ao",0,1,"",!0),_defineTex2D(obj,"light",1,3,"",!0),_defineTex2D(obj,"msdf",0,3,"",!1),_defineTex2D(obj,"diffuseDetail",0,3,"",!1,!0),_defineTex2D(obj,"normalDetail",0,-1,"",!1),_defineTex2D(obj,"clearCoat",0,1,"",!0),_defineTex2D(obj,"clearCoatGloss",0,1,"",!0),_defineTex2D(obj,"clearCoatNormal",0,-1,"",!1),_defineObject(obj,"cubeMap"),_defineObject(obj,"sphereMap"),_defineObject(obj,"dpAtlas"),_defineObject(obj,"prefilteredCubeMap128"),_defineObject(obj,"prefilteredCubeMap64"),_defineObject(obj,"prefilteredCubeMap32"),_defineObject(obj,"prefilteredCubeMap16"),_defineObject(obj,"prefilteredCubeMap8"),_defineObject(obj,"prefilteredCubeMap4"),_defineAlias(obj,"diffuseTint","diffuseMapTint"),_defineAlias(obj,"specularTint","specularMapTint"),_defineAlias(obj,"emissiveTint","emissiveMapTint"),_defineAlias(obj,"aoVertexColor","aoMapVertexColor"),_defineAlias(obj,"diffuseVertexColor","diffuseMapVertexColor"),_defineAlias(obj,"specularVertexColor","specularMapVertexColor"),_defineAlias(obj,"emissiveVertexColor","emissiveMapVertexColor"),_defineAlias(obj,"metalnessVertexColor","metalnessMapVertexColor"),_defineAlias(obj,"glossVertexColor","glossMapVertexColor"),_defineAlias(obj,"opacityVertexColor","opacityMapVertexColor"),_defineAlias(obj,"lightVertexColor","lightMapVertexColor");for(var i=0;i<_propsSerial.length;i++)_propsSerialDefaultVal[i]=obj[_propsSerial[i]];obj._propsSet=[]}StandardMaterial.TEXTURE_PARAMETERS=standardMaterialTextureParameters,StandardMaterial.CUBEMAP_PARAMETERS=standardMaterialCubemapParameters,_defineMaterialProps(StandardMaterial.prototype);var ProgramLibrary=function(){function ProgramLibrary(device){this._device=device,this._cache={},this._generators={},this._isClearingCache=!1,this._precached=!1,this._programsCollection=[],this._defaultStdMatOption={},this._defaultStdMatOptionMin={};var m=new StandardMaterial;m.shaderOptBuilder.updateRef(this._defaultStdMatOption,device,{},m,null,[],0,null,null),m.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,device,{},m,null,[],3,null,null)}var _proto=ProgramLibrary.prototype;return _proto.register=function register(name,generator){this.isRegistered(name)||(this._generators[name]=generator)},_proto.unregister=function unregister(name){this.isRegistered(name)&&delete this._generators[name]},_proto.isRegistered=function isRegistered(name){var generator;return void 0!==this._generators[name]},_proto.getProgram=function getProgram(name,options){var generator=this._generators[name];if(void 0===generator)return null;var gd=this._device,key=generator.generateKey(options),shader=this._cache[key];if(!shader){var lights;options.lights&&(lights=options.lights,options.lights=lights.map((function(l){var lcopy=l.clone?l.clone():l;return lcopy.key=l.key,lcopy}))),this.storeNewProgram(name,options),options.lights&&(options.lights=lights),this._precached&&console.warn("ProgramLibrary#getProgram: Cache miss for shader",name,"key",key,"after shaders precaching");var shaderDefinition=generator.createShaderDefinition(gd,options);shader=this._cache[key]=new Shader(gd,shaderDefinition)}return shader},_proto.storeNewProgram=function storeNewProgram(name,options){var opt={};if("standard"===name){var defaultMat=this._getDefaultStdMatOptions(options.pass);for(var p in options)(options.hasOwnProperty(p)&&defaultMat[p]!==options[p]||"pass"===p)&&(opt[p]=options[p])}else opt=options;this._programsCollection.push(JSON.stringify({name:name,options:opt}))},_proto.dumpPrograms=function dumpPrograms(){var text="var device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;\n";text+="var shaders = [",this._programsCollection[0]&&(text+="\n\t"+this._programsCollection[0]);for(var i=1;i<this._programsCollection.length;++i)text+=",\n\t"+this._programsCollection[i];text+="\n];\n",text+="device.programLib.precompile(shaders);\n",text+='if (pc.version != "1.43.1" || pc.revision != "49927b7")\n',text+='\tconsole.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");';var element=document.createElement("a");element.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(text)),element.setAttribute("download","precompile-shaders.js"),element.style.display="none",document.body.appendChild(element),element.click(),document.body.removeChild(element)},_proto.clearCache=function clearCache(){var cache=this._cache;for(var key in this._isClearingCache=!0,cache)cache.hasOwnProperty(key)&&cache[key].destroy();this._cache={},this._isClearingCache=!1},_proto.removeFromCache=function removeFromCache(shader){if(!this._isClearingCache){var cache=this._cache;for(var key in cache)if(cache.hasOwnProperty(key)&&cache[key]===shader){delete cache[key];break}}},_proto._getDefaultStdMatOptions=function _getDefaultStdMatOptions(pass){return pass>1&&pass<=18?this._defaultStdMatOptionMin:this._defaultStdMatOption},_proto.precompile=function precompile(cache){if(cache)for(var shaders=new Array(cache.length),i=0;i<cache.length;i++){if("standard"===cache[i].name){var opt=cache[i].options,defaultMat=this._getDefaultStdMatOptions(opt.pass);for(var p in defaultMat)defaultMat.hasOwnProperty(p)&&void 0===opt[p]&&(opt[p]=defaultMat[p]);opt.useTexCubeLod=this._device.useTexCubeLod}shaders[i]=this.getProgram(cache[i].name,cache[i].options)}this._precached=!0},ProgramLibrary}(),Version=function(){function Version(){this.globalId=0,this.revision=0}var _proto=Version.prototype;return _proto.equals=function equals(other){return this.globalId===other.globalId&&this.revision===other.revision},_proto.copy=function copy(other){this.globalId=other.globalId,this.revision=other.revision},_proto.reset=function reset(){this.globalId=0,this.revision=0},Version}(),idCounter=0,VersionedObject=function(){function VersionedObject(){idCounter++,this.version=new Version,this.version.globalId=idCounter}var _proto;return VersionedObject.prototype.increment=function increment(){this.version.revision++},VersionedObject}(),ScopeId=function(){function ScopeId(name){this.name=name,this.value=null,this.versionObject=new VersionedObject}var _proto=ScopeId.prototype;return _proto.setValue=function setValue(value){this.value=value,this.versionObject.increment()},_proto.getValue=function getValue(){return this.value},ScopeId}(),ScopeSpace=function(){function ScopeSpace(name){this.name=name,this.variables=new Map}var _proto=ScopeSpace.prototype;return _proto.resolve=function resolve(name){return this.variables.has(name)||this.variables.set(name,new ScopeId(name)),this.variables.get(name)},_proto.removeValue=function removeValue(value){for(var uniformName in this.variables){var uniform=this.variables[uniformName];uniform.value===value&&(uniform.value=null)}},ScopeSpace}(),ShaderInput=function ShaderInput(graphicsDevice,name,type,locationId){if(this.locationId=locationId,this.scopeId=graphicsDevice.scope.resolve(name),this.version=new Version,"[0]"===name.substr(name.length-3))switch(type){case 2:type=17;break;case 3:type=21;break;case 4:type=22;break;case 5:type=23}this.dataType=type,this.value=[null,null,null,null],this.array=[]},EVENT_RESIZE="resizecanvas";function downsampleImage(image,size){var srcW=image.width,srcH=image.height;if(srcW>size||srcH>size){var scale=size/Math.max(srcW,srcH),dstW=Math.floor(srcW*scale),dstH=Math.floor(srcH*scale),canvas=document.createElement("canvas"),context;return canvas.width=dstW,canvas.height=dstH,canvas.getContext("2d").drawImage(image,0,0,srcW,srcH,0,0,dstW,dstH),canvas}return image}function testRenderable(gl,pixelFormat){var result=!0,texture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,texture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,2,2,0,gl.RGBA,pixelFormat,null);var framebuffer=gl.createFramebuffer();return gl.bindFramebuffer(gl.FRAMEBUFFER,framebuffer),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,texture,0),gl.checkFramebufferStatus(gl.FRAMEBUFFER)!==gl.FRAMEBUFFER_COMPLETE&&(result=!1),gl.bindTexture(gl.TEXTURE_2D,null),gl.deleteTexture(texture),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.deleteFramebuffer(framebuffer),result}function testTextureHalfFloatUpdatable(gl,pixelFormat){var result=!0,texture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,texture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);var data=new Uint16Array(16);return gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,2,2,0,gl.RGBA,pixelFormat,data),gl.getError()!==gl.NO_ERROR&&(result=!1,console.log("Above error related to HALF_FLOAT_OES can be ignored, it was triggered by testing half float texture support")),gl.bindTexture(gl.TEXTURE_2D,null),gl.deleteTexture(texture),result}function testTextureFloatHighPrecision(device){if(!device.textureFloatRenderable)return!1;var test1=createShaderFromCode(device,shaderChunks.fullscreenQuadVS,shaderChunks.precisionTestPS,"ptest1"),test2=createShaderFromCode(device,shaderChunks.fullscreenQuadVS,shaderChunks.precisionTest2PS,"ptest2"),textureOptions={format:14,width:1,height:1,mipmaps:!1,minFilter:0,magFilter:0},tex1=new Texture(device,textureOptions);tex1.name="testFHP";var targ1=new RenderTarget({colorBuffer:tex1,depth:!1});drawQuadWithShader(device,targ1,test1),textureOptions.format=7;var tex2=new Texture(device,textureOptions);tex2.name="testFHP";var targ2=new RenderTarget({colorBuffer:tex2,depth:!1});device.constantTexSource.setValue(tex1),drawQuadWithShader(device,targ2,test2);var prevFramebuffer=device.activeFramebuffer;device.setFramebuffer(targ2._glFrameBuffer);var pixels=new Uint8Array(4);device.readPixels(0,0,1,1,pixels),device.setFramebuffer(prevFramebuffer);var x,y,z,w,f=pixels[0]/255/16777216+pixels[1]/255/65536+pixels[2]/255/256+pixels[3]/255;return tex1.destroy(),targ1.destroy(),tex2.destroy(),targ2.destroy(),0===f}var GraphicsDevice=function(_EventHandler){function GraphicsDevice(canvas,options){var _this;(_this=_EventHandler.call(this)||this).canvas=canvas,_this._enableAutoInstancing=!1,_this.autoInstancingMaxObjects=16384,_this.defaultFramebuffer=null,_this._maxPixelRatio=1,_this._width=0,_this._height=0,_this.updateClientRect(),_this.shaders=[],_this.buffers=[],_this.textures=[],_this.targets=[],_this.contextLost=!1,_this._contextLostHandler=function(event){event.preventDefault(),_this.contextLost=!0,_this.loseContext(),_this.fire("devicelost")},_this._contextRestoredHandler=function(){_this.restoreContext(),_this.contextLost=!1,_this.fire("devicerestored")};var preferWebGl2,names=!options||void 0===options.preferWebGl2||options.preferWebGl2?["webgl2","webgl","experimental-webgl"]:["webgl","experimental-webgl"],gl=null;(options=options||{}).stencil=!0;for(var i=0;i<names.length;i++)if(gl=canvas.getContext(names[i],options)){_this.webgl2="webgl2"===names[i];break}if(!gl)throw new Error("WebGL not supported");_this.gl=gl,_this._tempEnableSafariTextureUnitWorkaround=!!window.safari;var isChrome=!!window.chrome,isMac=-1!==navigator.appVersion.indexOf("Mac"),scopeX,scopeY,scopeZ,scopeW,uniformValue;for(var generator in _this._tempMacChromeBlitFramebufferWorkaround=isMac&&isChrome&&!options.alpha,window.setupVertexArrayObject(gl),canvas.addEventListener("webglcontextlost",_this._contextLostHandler,!1),canvas.addEventListener("webglcontextrestored",_this._contextRestoredHandler,!1),_this.initializeExtensions(),_this.initializeCapabilities(),_this.initializeRenderState(),_this.initializeContextCaches(),_this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:3},_this.glAddress=[gl.REPEAT,gl.CLAMP_TO_EDGE,gl.MIRRORED_REPEAT],_this.glBlendEquation=[gl.FUNC_ADD,gl.FUNC_SUBTRACT,gl.FUNC_REVERSE_SUBTRACT,_this.webgl2?gl.MIN:_this.extBlendMinmax?_this.extBlendMinmax.MIN_EXT:gl.FUNC_ADD,_this.webgl2?gl.MAX:_this.extBlendMinmax?_this.extBlendMinmax.MAX_EXT:gl.FUNC_ADD],_this.glBlendFunction=[gl.ZERO,gl.ONE,gl.SRC_COLOR,gl.ONE_MINUS_SRC_COLOR,gl.DST_COLOR,gl.ONE_MINUS_DST_COLOR,gl.SRC_ALPHA,gl.SRC_ALPHA_SATURATE,gl.ONE_MINUS_SRC_ALPHA,gl.DST_ALPHA,gl.ONE_MINUS_DST_ALPHA],_this.glComparison=[gl.NEVER,gl.LESS,gl.EQUAL,gl.LEQUAL,gl.GREATER,gl.NOTEQUAL,gl.GEQUAL,gl.ALWAYS],_this.glStencilOp=[gl.KEEP,gl.ZERO,gl.REPLACE,gl.INCR,gl.INCR_WRAP,gl.DECR,gl.DECR_WRAP,gl.INVERT],_this.glClearFlag=[0,gl.COLOR_BUFFER_BIT,gl.DEPTH_BUFFER_BIT,gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT,gl.STENCIL_BUFFER_BIT,gl.STENCIL_BUFFER_BIT|gl.COLOR_BUFFER_BIT,gl.STENCIL_BUFFER_BIT|gl.DEPTH_BUFFER_BIT,gl.STENCIL_BUFFER_BIT|gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT],_this.glCull=[0,gl.BACK,gl.FRONT,gl.FRONT_AND_BACK],_this.glFilter=[gl.NEAREST,gl.LINEAR,gl.NEAREST_MIPMAP_NEAREST,gl.NEAREST_MIPMAP_LINEAR,gl.LINEAR_MIPMAP_NEAREST,gl.LINEAR_MIPMAP_LINEAR],_this.glPrimitive=[gl.POINTS,gl.LINES,gl.LINE_LOOP,gl.LINE_STRIP,gl.TRIANGLES,gl.TRIANGLE_STRIP,gl.TRIANGLE_FAN],_this.glType=[gl.BYTE,gl.UNSIGNED_BYTE,gl.SHORT,gl.UNSIGNED_SHORT,gl.INT,gl.UNSIGNED_INT,gl.FLOAT],_this.pcUniformType={},_this.pcUniformType[gl.BOOL]=0,_this.pcUniformType[gl.INT]=1,_this.pcUniformType[gl.FLOAT]=2,_this.pcUniformType[gl.FLOAT_VEC2]=3,_this.pcUniformType[gl.FLOAT_VEC3]=4,_this.pcUniformType[gl.FLOAT_VEC4]=5,_this.pcUniformType[gl.INT_VEC2]=6,_this.pcUniformType[gl.INT_VEC3]=7,_this.pcUniformType[gl.INT_VEC4]=8,_this.pcUniformType[gl.BOOL_VEC2]=9,_this.pcUniformType[gl.BOOL_VEC3]=10,_this.pcUniformType[gl.BOOL_VEC4]=11,_this.pcUniformType[gl.FLOAT_MAT2]=12,_this.pcUniformType[gl.FLOAT_MAT3]=13,_this.pcUniformType[gl.FLOAT_MAT4]=14,_this.pcUniformType[gl.SAMPLER_2D]=15,_this.pcUniformType[gl.SAMPLER_CUBE]=16,_this.webgl2&&(_this.pcUniformType[gl.SAMPLER_2D_SHADOW]=18,_this.pcUniformType[gl.SAMPLER_CUBE_SHADOW]=19,_this.pcUniformType[gl.SAMPLER_3D]=20),_this.targetToSlot={},_this.targetToSlot[gl.TEXTURE_2D]=0,_this.targetToSlot[gl.TEXTURE_CUBE_MAP]=1,_this.targetToSlot[gl.TEXTURE_3D]=2,_this.commitFunction=[],_this.commitFunction[0]=function(uniform,value){uniform.value!==value&&(gl.uniform1i(uniform.locationId,value),uniform.value=value)},_this.commitFunction[1]=_this.commitFunction[0],_this.commitFunction[2]=function(uniform,value){uniform.value!==value&&(gl.uniform1f(uniform.locationId,value),uniform.value=value)},_this.commitFunction[3]=function(uniform,value){uniformValue=uniform.value,scopeX=value[0],scopeY=value[1],uniformValue[0]===scopeX&&uniformValue[1]===scopeY||(gl.uniform2fv(uniform.locationId,value),uniformValue[0]=scopeX,uniformValue[1]=scopeY)},_this.commitFunction[4]=function(uniform,value){uniformValue=uniform.value,scopeX=value[0],scopeY=value[1],scopeZ=value[2],uniformValue[0]===scopeX&&uniformValue[1]===scopeY&&uniformValue[2]===scopeZ||(gl.uniform3fv(uniform.locationId,value),uniformValue[0]=scopeX,uniformValue[1]=scopeY,uniformValue[2]=scopeZ)},_this.commitFunction[5]=function(uniform,value){uniformValue=uniform.value,scopeX=value[0],scopeY=value[1],scopeZ=value[2],scopeW=value[3],uniformValue[0]===scopeX&&uniformValue[1]===scopeY&&uniformValue[2]===scopeZ&&uniformValue[3]===scopeW||(gl.uniform4fv(uniform.locationId,value),uniformValue[0]=scopeX,uniformValue[1]=scopeY,uniformValue[2]=scopeZ,uniformValue[3]=scopeW)},_this.commitFunction[6]=function(uniform,value){uniformValue=uniform.value,scopeX=value[0],scopeY=value[1],uniformValue[0]===scopeX&&uniformValue[1]===scopeY||(gl.uniform2iv(uniform.locationId,value),uniformValue[0]=scopeX,uniformValue[1]=scopeY)},_this.commitFunction[9]=_this.commitFunction[6],_this.commitFunction[7]=function(uniform,value){uniformValue=uniform.value,scopeX=value[0],scopeY=value[1],scopeZ=value[2],uniformValue[0]===scopeX&&uniformValue[1]===scopeY&&uniformValue[2]===scopeZ||(gl.uniform3iv(uniform.locationId,value),uniformValue[0]=scopeX,uniformValue[1]=scopeY,uniformValue[2]=scopeZ)},_this.commitFunction[10]=_this.commitFunction[7],_this.commitFunction[8]=function(uniform,value){uniformValue=uniform.value,scopeX=value[0],scopeY=value[1],scopeZ=value[2],scopeW=value[3],uniformValue[0]===scopeX&&uniformValue[1]===scopeY&&uniformValue[2]===scopeZ&&uniformValue[3]===scopeW||(gl.uniform4iv(uniform.locationId,value),uniformValue[0]=scopeX,uniformValue[1]=scopeY,uniformValue[2]=scopeZ,uniformValue[3]=scopeW)},_this.commitFunction[11]=_this.commitFunction[8],_this.commitFunction[12]=function(uniform,value){gl.uniformMatrix2fv(uniform.locationId,!1,value)},_this.commitFunction[13]=function(uniform,value){gl.uniformMatrix3fv(uniform.locationId,!1,value)},_this.commitFunction[14]=function(uniform,value){gl.uniformMatrix4fv(uniform.locationId,!1,value)},_this.commitFunction[17]=function(uniform,value){gl.uniform1fv(uniform.locationId,value)},_this.commitFunction[21]=function(uniform,value){gl.uniform2fv(uniform.locationId,value)},_this.commitFunction[22]=function(uniform,value){gl.uniform3fv(uniform.locationId,value)},_this.commitFunction[23]=function(uniform,value){gl.uniform4fv(uniform.locationId,value)},_this.scope=new ScopeSpace("Device"),_this.programLib=new ProgramLibrary(_assertThisInitialized(_this)),programlib)_this.programLib.register(generator,programlib[generator]);_this.supportsBoneTextures=_this.extTextureFloat&&_this.maxVertexTextures>0,_this.useTexCubeLod=_this.extTextureLod&&_this.maxTextures<16;var numUniforms=_this.vertexUniformsCount;numUniforms-=16,numUniforms-=8,numUniforms-=1,numUniforms-=16,_this.boneLimit=Math.floor(numUniforms/3),_this.boneLimit=Math.min(_this.boneLimit,128),"Mali-450 MP"===_this.unmaskedRenderer&&(_this.boneLimit=34),_this._drawCallsPerFrame=0,_this._shaderSwitchesPerFrame=0,_this._primsPerFrame=[];for(var _i=0;_i<=6;_i++)_this._primsPerFrame[_i]=0;return _this._renderTargetCreationTime=0,_this._vram={tex:0,vb:0,ib:0},_this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0},_this.constantTexSource=_this.scope.resolve("source"),_this.extTextureFloat?_this.webgl2?_this.textureFloatRenderable=!!_this.extColorBufferFloat:_this.textureFloatRenderable=testRenderable(gl,gl.FLOAT):_this.textureFloatRenderable=!1,_this.extColorBufferHalfFloat?_this.textureHalfFloatRenderable=!!_this.extColorBufferHalfFloat:_this.extTextureHalfFloat?_this.webgl2?_this.textureHalfFloatRenderable=!!_this.extColorBufferFloat:_this.textureHalfFloatRenderable=testRenderable(gl,_this.extTextureHalfFloat.HALF_FLOAT_OES):_this.textureHalfFloatRenderable=!1,_this.supportsMorphTargetTexturesCore="highp"===_this.maxPrecision&&_this.maxVertexTextures>=2,_this._textureFloatHighPrecision=void 0,_this._textureHalfFloatUpdatable=void 0,_this.grabPassAvailable=!0,_this.grabPassAlpha=options.alpha,_this.createGrabPass(),VertexFormat.init(_assertThisInitialized(_this)),_this.areaLightLutFormat=7,_this.extTextureHalfFloat&&_this.textureHalfFloatUpdatable&&_this.extTextureHalfFloatLinear?_this.areaLightLutFormat=12:_this.extTextureFloat&&_this.extTextureFloatLinear&&(_this.areaLightLutFormat=14),_this}_inheritsLoose(GraphicsDevice,_EventHandler);var _proto=GraphicsDevice.prototype;return _proto.toJSON=function toJSON(key){},_proto.getPrecision=function getPrecision(){var gl=this.gl,precision="highp";if(gl.getShaderPrecisionFormat){var vertexShaderPrecisionHighpFloat=gl.getShaderPrecisionFormat(gl.VERTEX_SHADER,gl.HIGH_FLOAT),vertexShaderPrecisionMediumpFloat=gl.getShaderPrecisionFormat(gl.VERTEX_SHADER,gl.MEDIUM_FLOAT),fragmentShaderPrecisionHighpFloat=gl.getShaderPrecisionFormat(gl.FRAGMENT_SHADER,gl.HIGH_FLOAT),fragmentShaderPrecisionMediumpFloat=gl.getShaderPrecisionFormat(gl.FRAGMENT_SHADER,gl.MEDIUM_FLOAT),highpAvailable=vertexShaderPrecisionHighpFloat.precision>0&&fragmentShaderPrecisionHighpFloat.precision>0,mediumpAvailable=vertexShaderPrecisionMediumpFloat.precision>0&&fragmentShaderPrecisionMediumpFloat.precision>0;highpAvailable||(precision=mediumpAvailable?"mediump":"lowp")}return precision},_proto.initializeExtensions=function initializeExtensions(){var gl=this.gl,ext,supportedExtensions=gl.getSupportedExtensions(),getExtension=function getExtension(){for(var i=0;i<arguments.length;i++)if(-1!==supportedExtensions.indexOf(arguments[i]))return gl.getExtension(arguments[i]);return null};this.webgl2?(this.extBlendMinmax=!0,this.extDrawBuffers=!0,this.extInstancing=!0,this.extStandardDerivatives=!0,this.extTextureFloat=!0,this.extTextureHalfFloat=!0,this.extTextureHalfFloatLinear=!0,this.extTextureLod=!0,this.extUintElement=!0,this.extVertexArrayObject=!0,this.extColorBufferFloat=getExtension("EXT_color_buffer_float"),this.extDisjointTimerQuery=getExtension("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query")):(this.extBlendMinmax=getExtension("EXT_blend_minmax"),this.extDrawBuffers=getExtension("EXT_draw_buffers"),this.extInstancing=getExtension("ANGLE_instanced_arrays"),this.extInstancing&&(ext=this.extInstancing,gl.drawArraysInstanced=ext.drawArraysInstancedANGLE.bind(ext),gl.drawElementsInstanced=ext.drawElementsInstancedANGLE.bind(ext),gl.vertexAttribDivisor=ext.vertexAttribDivisorANGLE.bind(ext)),this.extStandardDerivatives=getExtension("OES_standard_derivatives"),this.extTextureFloat=getExtension("OES_texture_float"),this.extTextureHalfFloat=getExtension("OES_texture_half_float"),this.extTextureHalfFloatLinear=getExtension("OES_texture_half_float_linear"),this.extTextureLod=getExtension("EXT_shader_texture_lod"),this.extUintElement=getExtension("OES_element_index_uint"),this.extVertexArrayObject=getExtension("OES_vertex_array_object"),this.extVertexArrayObject&&(ext=this.extVertexArrayObject,gl.createVertexArray=ext.createVertexArrayOES.bind(ext),gl.deleteVertexArray=ext.deleteVertexArrayOES.bind(ext),gl.isVertexArray=ext.isVertexArrayOES.bind(ext),gl.bindVertexArray=ext.bindVertexArrayOES.bind(ext)),this.extColorBufferFloat=null,this.extDisjointTimerQuery=null),this.extDebugRendererInfo=getExtension("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=getExtension("OES_texture_float_linear"),this.extFloatBlend=getExtension("EXT_float_blend"),this.extTextureFilterAnisotropic=getExtension("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extCompressedTextureETC1=getExtension("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=getExtension("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=getExtension("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=getExtension("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extCompressedTextureATC=getExtension("WEBGL_compressed_texture_atc"),this.extCompressedTextureASTC=getExtension("WEBGL_compressed_texture_astc"),this.extParallelShaderCompile=getExtension("KHR_parallel_shader_compile"),this.extColorBufferHalfFloat=getExtension("EXT_color_buffer_half_float"),this.supportsInstancing=!!this.extInstancing},_proto.initializeCapabilities=function initializeCapabilities(){var gl=this.gl,ext;this.maxPrecision=this.precision=this.getPrecision();var contextAttribs=gl.getContextAttributes();this.supportsMsaa=contextAttribs.antialias,this.supportsStencil=contextAttribs.stencil,this.maxTextureSize=gl.getParameter(gl.MAX_TEXTURE_SIZE),this.maxCubeMapSize=gl.getParameter(gl.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=gl.getParameter(gl.MAX_RENDERBUFFER_SIZE),this.maxTextures=gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=gl.getParameter(gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=gl.getParameter(gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=gl.getParameter(gl.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=gl.getParameter(gl.MAX_FRAGMENT_UNIFORM_VECTORS),this.webgl2?(this.maxDrawBuffers=gl.getParameter(gl.MAX_DRAW_BUFFERS),this.maxColorAttachments=gl.getParameter(gl.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=gl.getParameter(gl.MAX_3D_TEXTURE_SIZE)):(ext=this.extDrawBuffers,this.maxDrawBuffers=ext?gl.getParameter(ext.MAX_DRAW_BUFFERS_EXT):1,this.maxColorAttachments=ext?gl.getParameter(ext.MAX_COLOR_ATTACHMENTS_EXT):1,this.maxVolumeSize=1),ext=this.extDebugRendererInfo,this.unmaskedRenderer=ext?gl.getParameter(ext.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=ext?gl.getParameter(ext.UNMASKED_VENDOR_WEBGL):"",ext=this.extTextureFilterAnisotropic,this.maxAnisotropy=ext?gl.getParameter(ext.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1,this.samples=gl.getParameter(gl.SAMPLES),this.maxSamples=this.webgl2?gl.getParameter(gl.MAX_SAMPLES):1},_proto.initializeRenderState=function initializeRenderState(){var gl=this.gl;this.blending=!1,gl.disable(gl.BLEND),this.blendSrc=1,this.blendDst=0,this.blendSrcAlpha=1,this.blendDstAlpha=0,this.separateAlphaBlend=!1,this.blendEquation=0,this.blendAlphaEquation=0,this.separateAlphaEquation=!1,gl.blendFunc(gl.ONE,gl.ZERO),gl.blendEquation(gl.FUNC_ADD),this.writeRed=!0,this.writeGreen=!0,this.writeBlue=!0,this.writeAlpha=!0,gl.colorMask(!0,!0,!0,!0),this.cullMode=1,gl.enable(gl.CULL_FACE),gl.cullFace(gl.BACK),this.depthTest=!0,gl.enable(gl.DEPTH_TEST),this.depthFunc=3,gl.depthFunc(gl.LEQUAL),this.depthWrite=!0,gl.depthMask(!0),this.stencil=!1,gl.disable(gl.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=7,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,gl.stencilFunc(gl.ALWAYS,0,255),this.stencilFailFront=this.stencilFailBack=0,this.stencilZfailFront=this.stencilZfailBack=0,this.stencilZpassFront=this.stencilZpassBack=0,this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255,gl.stencilOp(gl.KEEP,gl.KEEP,gl.KEEP),gl.stencilMask(255),this.alphaToCoverage=!1,this.raster=!0,this.webgl2&&(gl.disable(gl.SAMPLE_ALPHA_TO_COVERAGE),gl.disable(gl.RASTERIZER_DISCARD)),this.depthBiasEnabled=!1,gl.disable(gl.POLYGON_OFFSET_FILL),this.clearDepth=1,gl.clearDepth(1),this.clearRed=0,this.clearBlue=0,this.clearGreen=0,this.clearAlpha=0,gl.clearColor(0,0,0,0),this.clearStencil=0,gl.clearStencil(0),this.vx=this.vy=this.vw=this.vh=0,this.sx=this.sy=this.sw=this.sh=0,this.webgl2?gl.hint(gl.FRAGMENT_SHADER_DERIVATIVE_HINT,gl.NICEST):this.extStandardDerivatives&&gl.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,gl.NICEST),gl.enable(gl.SCISSOR_TEST),gl.pixelStorei(gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,gl.NONE),this.unpackFlipY=!1,gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!1),this.unpackPremultiplyAlpha=!1,gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1)},_proto.initializeContextCaches=function initializeContextCaches(){this.vertexShaderCache={},this.fragmentShaderCache={},this._vaoMap=new Map,this.boundVao=null,this.indexBuffer=null,this.vertexBuffers=[],this.shader=null,this.renderTarget=null,this.activeFramebuffer=null,this.feedback=null,this.transformFeedbackBuffer=null,this.textureUnit=0,this.textureUnits=[];for(var i=0;i<this.maxCombinedTextures;i++)this.textureUnits.push([null,null,null])},_proto.loseContext=function loseContext(){for(var _iterator=_createForOfIteratorHelperLoose(this.shaders),_step;!(_step=_iterator()).done;){var shader;_step.value.loseContext()}for(this.destroyGrabPass();this.textures.length>0;){var texture=this.textures[0];this.destroyTexture(texture),texture.dirtyAll()}for(var _iterator2=_createForOfIteratorHelperLoose(this.buffers),_step2;!(_step2=_iterator2()).done;){var buffer;_step2.value.loseContext()}for(var _iterator3=_createForOfIteratorHelperLoose(this.targets),_step3;!(_step3=_iterator3()).done;){var target;_step3.value.loseContext()}},_proto.restoreContext=function restoreContext(){this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches();for(var _iterator4=_createForOfIteratorHelperLoose(this.shaders),_step4;!(_step4=_iterator4()).done;){var shader=_step4.value;this.compileAndLinkShader(shader)}for(var _iterator5=_createForOfIteratorHelperLoose(this.buffers),_step5;!(_step5=_iterator5()).done;){var buffer;_step5.value.unlock()}this.createGrabPass()},_proto.createGrabPass=function createGrabPass(){if(!this.grabPassTexture){var grabPassTexture=new Texture(this,{format:!1===this.grabPassAlpha?6:7,minFilter:1,magFilter:1,addressU:1,addressV:1,mipmaps:!1});grabPassTexture.name="texture_grabPass";var grabPassTextureId=this.scope.resolve(grabPassTexture.name);grabPassTextureId.setValue(grabPassTexture);var grabPassRenderTarget=new RenderTarget({colorBuffer:grabPassTexture,depth:!1});this.grabPassRenderTarget=grabPassRenderTarget,this.grabPassTextureId=grabPassTextureId,this.grabPassTexture=grabPassTexture}},_proto.updateGrabPass=function updateGrabPass(){var gl=this.gl;if(!this.grabPassAvailable)return!1;var renderTarget=this.renderTarget,resolveRenderTarget=renderTarget&&renderTarget._glResolveFrameBuffer,grabPassTexture=this.grabPassTexture,width=this.width,height=this.height;if(this.webgl2&&!this._tempMacChromeBlitFramebufferWorkaround&&width===grabPassTexture._width&&height===grabPassTexture._height){resolveRenderTarget&&renderTarget.resolve(!0);var currentFrameBuffer=renderTarget?renderTarget._glFrameBuffer:null,resolvedFrameBuffer=renderTarget?renderTarget._glResolveFrameBuffer||renderTarget._glFrameBuffer:null;this.initRenderTarget(this.grabPassRenderTarget);var grabPassFrameBuffer=this.grabPassRenderTarget._glFrameBuffer;gl.bindFramebuffer(gl.READ_FRAMEBUFFER,resolvedFrameBuffer),gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,grabPassFrameBuffer),gl.blitFramebuffer(0,0,width,height,0,0,width,height,gl.COLOR_BUFFER_BIT,gl.NEAREST),gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,currentFrameBuffer)}else{resolveRenderTarget&&(renderTarget.resolve(!0),gl.bindFramebuffer(gl.FRAMEBUFFER,renderTarget._glResolveFrameBuffer));var format=grabPassTexture._glFormat;gl.copyTexImage2D(gl.TEXTURE_2D,0,format,0,0,width,height,0),grabPassTexture._width=width,grabPassTexture._height=height,resolveRenderTarget&&gl.bindFramebuffer(gl.FRAMEBUFFER,renderTarget._glFrameBuffer)}return!0},_proto.destroyGrabPass=function destroyGrabPass(){this.grabPassRenderTarget.destroy(),this.grabPassRenderTarget=null,this.grabPassTextureId=null,this.grabPassTexture.destroy(),this.grabPassTexture=null},_proto.updateClientRect=function updateClientRect(){this.clientRect=this.canvas.getBoundingClientRect()},_proto.setViewport=function setViewport(x,y,w,h){this.vx===x&&this.vy===y&&this.vw===w&&this.vh===h||(this.gl.viewport(x,y,w,h),this.vx=x,this.vy=y,this.vw=w,this.vh=h)},_proto.setScissor=function setScissor(x,y,w,h){this.sx===x&&this.sy===y&&this.sw===w&&this.sh===h||(this.gl.scissor(x,y,w,h),this.sx=x,this.sy=y,this.sw=w,this.sh=h)},_proto.getProgramLibrary=function getProgramLibrary(){return this.programLib},_proto.setProgramLibrary=function setProgramLibrary(programLib){this.programLib=programLib},_proto.setFramebuffer=function setFramebuffer(fb){this.activeFramebuffer!==fb&&(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,fb),this.activeFramebuffer=fb)},_proto._checkFbo=function _checkFbo(){var gl=this.gl,status;switch(gl.checkFramebufferStatus(gl.FRAMEBUFFER)){case gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case gl.FRAMEBUFFER_UNSUPPORTED:console.error("ERROR: FRAMEBUFFER_UNSUPPORTED");break;case gl.FRAMEBUFFER_COMPLETE:}},_proto.copyRenderTarget=function copyRenderTarget(source,dest,color,depth){var gl=this.gl;if(!this.webgl2&&depth)return!1;if(color)if(dest){if(!source._colorBuffer||!dest._colorBuffer)return!1;if(source._colorBuffer._format!==dest._colorBuffer._format)return!1}else if(!source._colorBuffer)return!1;if(depth){if(!source._depthBuffer||!dest._depthBuffer)return!1;if(source._depthBuffer._format!==dest._depthBuffer._format)return!1}if(this.webgl2&&dest){var prevRt=this.renderTarget;this.renderTarget=dest,this.updateBegin(),gl.bindFramebuffer(gl.READ_FRAMEBUFFER,source?source._glFrameBuffer:null),gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,dest._glFrameBuffer);var w=source?source.width:dest.width,h=source?source.height:dest.height;gl.blitFramebuffer(0,0,w,h,0,0,w,h,(color?gl.COLOR_BUFFER_BIT:0)|(depth?gl.DEPTH_BUFFER_BIT:0),gl.NEAREST),this.renderTarget=prevRt,gl.bindFramebuffer(gl.FRAMEBUFFER,prevRt?prevRt._glFrameBuffer:null)}else{var shader=this.getCopyShader();this.constantTexSource.setValue(source._colorBuffer),drawQuadWithShader(this,dest,shader)}return!0},_proto.initRenderTarget=function initRenderTarget(target){if(!target._glFrameBuffer){target._device=this;var gl=this.gl;target._glFrameBuffer=gl.createFramebuffer(),this.setFramebuffer(target._glFrameBuffer);var colorBuffer=target._colorBuffer;colorBuffer&&(colorBuffer._glTexture||(colorBuffer._width=Math.min(colorBuffer.width,this.maxRenderBufferSize),colorBuffer._height=Math.min(colorBuffer.height,this.maxRenderBufferSize),this.setTexture(colorBuffer,0)),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,colorBuffer._cubemap?gl.TEXTURE_CUBE_MAP_POSITIVE_X+target._face:gl.TEXTURE_2D,colorBuffer._glTexture,0));var depthBuffer=target._depthBuffer;if(depthBuffer&&this.webgl2)depthBuffer._glTexture||(depthBuffer._width=Math.min(depthBuffer.width,this.maxRenderBufferSize),depthBuffer._height=Math.min(depthBuffer.height,this.maxRenderBufferSize),this.setTexture(depthBuffer,0)),target._stencil?gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.DEPTH_STENCIL_ATTACHMENT,depthBuffer._cubemap?gl.TEXTURE_CUBE_MAP_POSITIVE_X+target._face:gl.TEXTURE_2D,target._depthBuffer._glTexture,0):gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,depthBuffer._cubemap?gl.TEXTURE_CUBE_MAP_POSITIVE_X+target._face:gl.TEXTURE_2D,target._depthBuffer._glTexture,0);else if(target._depth){var willRenderMsaa;target._samples>1&&this.webgl2||(target._glDepthBuffer||(target._glDepthBuffer=gl.createRenderbuffer()),gl.bindRenderbuffer(gl.RENDERBUFFER,target._glDepthBuffer),target._stencil?(gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_STENCIL,target.width,target.height),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,target._glDepthBuffer)):(gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,target.width,target.height),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,target._glDepthBuffer)),gl.bindRenderbuffer(gl.RENDERBUFFER,null))}this.webgl2&&target._samples>1&&(target._glResolveFrameBuffer=target._glFrameBuffer,target._glFrameBuffer=gl.createFramebuffer(),this.setFramebuffer(target._glFrameBuffer),colorBuffer&&(target._glMsaaColorBuffer||(target._glMsaaColorBuffer=gl.createRenderbuffer()),gl.bindRenderbuffer(gl.RENDERBUFFER,target._glMsaaColorBuffer),gl.renderbufferStorageMultisample(gl.RENDERBUFFER,target._samples,colorBuffer._glInternalFormat,target.width,target.height),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,target._glMsaaColorBuffer)),target._depth&&(target._glMsaaDepthBuffer||(target._glMsaaDepthBuffer=gl.createRenderbuffer()),gl.bindRenderbuffer(gl.RENDERBUFFER,target._glMsaaDepthBuffer),target._stencil?(gl.renderbufferStorageMultisample(gl.RENDERBUFFER,target._samples,gl.DEPTH24_STENCIL8,target.width,target.height),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,target._glMsaaDepthBuffer)):(gl.renderbufferStorageMultisample(gl.RENDERBUFFER,target._samples,gl.DEPTH_COMPONENT32F,target.width,target.height),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,target._glMsaaDepthBuffer)))),this.targets.push(target)}},_proto.getCopyShader=function getCopyShader(){return this._copyShader||(this._copyShader=createShaderFromCode(this,shaderChunks.fullscreenQuadVS,shaderChunks.outputTex2DPS,"outputTex2D")),this._copyShader},_proto.updateBegin=function updateBegin(){if(this.boundVao=null,this._tempEnableSafariTextureUnitWorkaround)for(var unit=0;unit<this.textureUnits.length;++unit)for(var slot=0;slot<3;++slot)this.textureUnits[unit][slot]=null;var target=this.renderTarget;target?target._glFrameBuffer?this.setFramebuffer(target._glFrameBuffer):this.initRenderTarget(target):this.setFramebuffer(this.defaultFramebuffer)},_proto.updateEnd=function updateEnd(){var gl=this.gl;this.boundVao=null,this.gl.bindVertexArray(null);var target=this.renderTarget;if(target){var colorBuffer=target._colorBuffer;colorBuffer&&colorBuffer._glTexture&&colorBuffer.mipmaps&&(colorBuffer.pot||this.webgl2)&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(colorBuffer),gl.generateMipmap(colorBuffer._glTarget)),this.webgl2&&target._samples>1&&target.autoResolve&&target.resolve()}},_proto.initializeTexture=function initializeTexture(texture){var gl=this.gl,ext;switch(texture._glTexture=gl.createTexture(),texture._glTarget=texture._cubemap?gl.TEXTURE_CUBE_MAP:texture._volume?gl.TEXTURE_3D:gl.TEXTURE_2D,texture._format){case 0:texture._glFormat=gl.ALPHA,texture._glInternalFormat=gl.ALPHA,texture._glPixelType=gl.UNSIGNED_BYTE;break;case 1:texture._glFormat=gl.LUMINANCE,texture._glInternalFormat=gl.LUMINANCE,texture._glPixelType=gl.UNSIGNED_BYTE;break;case 2:texture._glFormat=gl.LUMINANCE_ALPHA,texture._glInternalFormat=gl.LUMINANCE_ALPHA,texture._glPixelType=gl.UNSIGNED_BYTE;break;case 3:texture._glFormat=gl.RGB,texture._glInternalFormat=gl.RGB,texture._glPixelType=gl.UNSIGNED_SHORT_5_6_5;break;case 4:texture._glFormat=gl.RGBA,texture._glInternalFormat=gl.RGBA,texture._glPixelType=gl.UNSIGNED_SHORT_5_5_5_1;break;case 5:texture._glFormat=gl.RGBA,texture._glInternalFormat=gl.RGBA,texture._glPixelType=gl.UNSIGNED_SHORT_4_4_4_4;break;case 6:texture._glFormat=gl.RGB,texture._glInternalFormat=this.webgl2?gl.RGB8:gl.RGB,texture._glPixelType=gl.UNSIGNED_BYTE;break;case 7:texture._glFormat=gl.RGBA,texture._glInternalFormat=this.webgl2?gl.RGBA8:gl.RGBA,texture._glPixelType=gl.UNSIGNED_BYTE;break;case 8:ext=this.extCompressedTextureS3TC,texture._glFormat=gl.RGB,texture._glInternalFormat=ext.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case 9:ext=this.extCompressedTextureS3TC,texture._glFormat=gl.RGBA,texture._glInternalFormat=ext.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case 10:ext=this.extCompressedTextureS3TC,texture._glFormat=gl.RGBA,texture._glInternalFormat=ext.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case 21:ext=this.extCompressedTextureETC1,texture._glFormat=gl.RGB,texture._glInternalFormat=ext.COMPRESSED_RGB_ETC1_WEBGL;break;case 24:ext=this.extCompressedTexturePVRTC,texture._glFormat=gl.RGB,texture._glInternalFormat=ext.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case 25:ext=this.extCompressedTexturePVRTC,texture._glFormat=gl.RGBA,texture._glInternalFormat=ext.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case 26:ext=this.extCompressedTexturePVRTC,texture._glFormat=gl.RGB,texture._glInternalFormat=ext.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case 27:ext=this.extCompressedTexturePVRTC,texture._glFormat=gl.RGBA,texture._glInternalFormat=ext.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case 22:ext=this.extCompressedTextureETC,texture._glFormat=gl.RGB,texture._glInternalFormat=ext.COMPRESSED_RGB8_ETC2;break;case 23:ext=this.extCompressedTextureETC,texture._glFormat=gl.RGBA,texture._glInternalFormat=ext.COMPRESSED_RGBA8_ETC2_EAC;break;case 28:ext=this.extCompressedTextureASTC,texture._glFormat=gl.RGBA,texture._glInternalFormat=ext.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case 29:ext=this.extCompressedTextureATC,texture._glFormat=gl.RGB,texture._glInternalFormat=ext.COMPRESSED_RGB_ATC_WEBGL;break;case 30:ext=this.extCompressedTextureATC,texture._glFormat=gl.RGBA,texture._glInternalFormat=ext.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case 11:ext=this.extTextureHalfFloat,texture._glFormat=gl.RGB,this.webgl2?(texture._glInternalFormat=gl.RGB16F,texture._glPixelType=gl.HALF_FLOAT):(texture._glInternalFormat=gl.RGB,texture._glPixelType=ext.HALF_FLOAT_OES);break;case 12:ext=this.extTextureHalfFloat,texture._glFormat=gl.RGBA,this.webgl2?(texture._glInternalFormat=gl.RGBA16F,texture._glPixelType=gl.HALF_FLOAT):(texture._glInternalFormat=gl.RGBA,texture._glPixelType=ext.HALF_FLOAT_OES);break;case 13:texture._glFormat=gl.RGB,this.webgl2?texture._glInternalFormat=gl.RGB32F:texture._glInternalFormat=gl.RGB,texture._glPixelType=gl.FLOAT;break;case 14:texture._glFormat=gl.RGBA,this.webgl2?texture._glInternalFormat=gl.RGBA32F:texture._glInternalFormat=gl.RGBA,texture._glPixelType=gl.FLOAT;break;case 15:texture._glFormat=gl.RED,texture._glInternalFormat=gl.R32F,texture._glPixelType=gl.FLOAT;break;case 16:this.webgl2?(texture._glFormat=gl.DEPTH_COMPONENT,texture._glInternalFormat=gl.DEPTH_COMPONENT32F,texture._glPixelType=gl.FLOAT):(texture._glFormat=gl.DEPTH_COMPONENT,texture._glInternalFormat=gl.DEPTH_COMPONENT,texture._glPixelType=gl.UNSIGNED_SHORT);break;case 17:texture._glFormat=gl.DEPTH_STENCIL,texture._glInternalFormat=gl.DEPTH24_STENCIL8,texture._glPixelType=gl.UNSIGNED_INT_24_8;break;case 18:texture._glFormat=gl.RGB,texture._glInternalFormat=gl.R11F_G11F_B10F,texture._glPixelType=gl.UNSIGNED_INT_10F_11F_11F_REV;break;case 19:texture._glFormat=gl.RGB,texture._glInternalFormat=gl.SRGB8,texture._glPixelType=gl.UNSIGNED_BYTE;break;case 20:texture._glFormat=gl.RGBA,texture._glInternalFormat=gl.SRGB8_ALPHA8,texture._glPixelType=gl.UNSIGNED_BYTE}this.textures.push(texture)},_proto.destroyTexture=function destroyTexture(texture){if(texture._glTexture){var idx=this.textures.indexOf(texture),gl;-1!==idx&&this.textures.splice(idx,1),this.scope.removeValue(texture);for(var i=0;i<this.textureUnits.length;i++)for(var textureUnit=this.textureUnits[i],j=0;j<textureUnit.length;j++)textureUnit[j]===texture._glTexture&&(textureUnit[j]=null);this.gl.deleteTexture(texture._glTexture),delete texture._glTexture,delete texture._glTarget,delete texture._glFormat,delete texture._glInternalFormat,delete texture._glPixelType,this._vram.tex-=texture._gpuSize}},_proto.setUnpackFlipY=function setUnpackFlipY(flipY){if(this.unpackFlipY!==flipY){this.unpackFlipY=flipY;var gl=this.gl;gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,flipY)}},_proto.setUnpackPremultiplyAlpha=function setUnpackPremultiplyAlpha(premultiplyAlpha){if(this.unpackPremultiplyAlpha!==premultiplyAlpha){this.unpackPremultiplyAlpha=premultiplyAlpha;var gl=this.gl;gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,premultiplyAlpha)}},_proto._isBrowserInterface=function _isBrowserInterface(texture){return"undefined"!=typeof HTMLCanvasElement&&texture instanceof HTMLCanvasElement||"undefined"!=typeof HTMLImageElement&&texture instanceof HTMLImageElement||"undefined"!=typeof HTMLVideoElement&&texture instanceof HTMLVideoElement||"undefined"!=typeof ImageBitmap&&texture instanceof ImageBitmap},_proto.uploadTexture=function uploadTexture(texture){var gl=this.gl;if(texture._needsUpload||!(texture._needsMipmapsUpload&&texture._mipmapsUploaded||!texture.pot)){for(var mipLevel=0,mipObject,resMult,requiredMipLevels=Math.log2(Math.max(texture._width,texture._height))+1;texture._levels[mipLevel]||0===mipLevel;)if(texture._needsUpload||0!==mipLevel){if(mipLevel&&(!texture._needsMipmapsUpload||!texture._mipmaps))break;if(mipObject=texture._levels[mipLevel],1===mipLevel&&!texture._compressed&&texture._levels.length<requiredMipLevels&&(gl.generateMipmap(texture._glTarget),texture._mipmapsUploaded=!0),texture._cubemap){var face=void 0;if(this._isBrowserInterface(mipObject[0])){for(face=0;face<6;face++)if(texture._levelsUpdated[0][face]){var src=mipObject[face];src instanceof HTMLImageElement&&(src.width>this.maxCubeMapSize||src.height>this.maxCubeMapSize)&&(src=downsampleImage(src,this.maxCubeMapSize),0===mipLevel&&(texture._width=src.width,texture._height=src.height)),this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(texture._premultiplyAlpha),gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+face,mipLevel,texture._glInternalFormat,texture._glFormat,texture._glPixelType,src)}}else for(resMult=1/Math.pow(2,mipLevel),face=0;face<6;face++)if(texture._levelsUpdated[0][face]){var texData=mipObject[face];texture._compressed?gl.compressedTexImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+face,mipLevel,texture._glInternalFormat,Math.max(texture._width*resMult,1),Math.max(texture._height*resMult,1),0,texData):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(texture._premultiplyAlpha),gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+face,mipLevel,texture._glInternalFormat,Math.max(texture._width*resMult,1),Math.max(texture._height*resMult,1),0,texture._glFormat,texture._glPixelType,texData))}}else texture._volume?(resMult=1/Math.pow(2,mipLevel),texture._compressed?gl.compressedTexImage3D(gl.TEXTURE_3D,mipLevel,texture._glInternalFormat,Math.max(texture._width*resMult,1),Math.max(texture._height*resMult,1),Math.max(texture._depth*resMult,1),0,mipObject):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(texture._premultiplyAlpha),gl.texImage3D(gl.TEXTURE_3D,mipLevel,texture._glInternalFormat,Math.max(texture._width*resMult,1),Math.max(texture._height*resMult,1),Math.max(texture._depth*resMult,1),0,texture._glFormat,texture._glPixelType,mipObject))):(this._isBrowserInterface(mipObject)?(mipObject instanceof HTMLImageElement&&(mipObject.width>this.maxTextureSize||mipObject.height>this.maxTextureSize)&&(mipObject=downsampleImage(mipObject,this.maxTextureSize),0===mipLevel&&(texture._width=mipObject.width,texture._height=mipObject.height)),this.setUnpackFlipY(texture._flipY),this.setUnpackPremultiplyAlpha(texture._premultiplyAlpha),gl.texImage2D(gl.TEXTURE_2D,mipLevel,texture._glInternalFormat,texture._glFormat,texture._glPixelType,mipObject)):(resMult=1/Math.pow(2,mipLevel),texture._compressed?gl.compressedTexImage2D(gl.TEXTURE_2D,mipLevel,texture._glInternalFormat,Math.max(texture._width*resMult,1),Math.max(texture._height*resMult,1),0,mipObject):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(texture._premultiplyAlpha),gl.texImage2D(gl.TEXTURE_2D,mipLevel,texture._glInternalFormat,Math.max(texture._width*resMult,1),Math.max(texture._height*resMult,1),0,texture._glFormat,texture._glPixelType,mipObject))),texture._mipmapsUploaded=0!==mipLevel);mipLevel++}else mipLevel++;if(texture._needsUpload)if(texture._cubemap)for(var i=0;i<6;i++)texture._levelsUpdated[0][i]=!1;else texture._levelsUpdated[0]=!1;!texture._compressed&&texture._mipmaps&&texture._needsMipmapsUpload&&(texture.pot||this.webgl2)&&1===texture._levels.length&&(gl.generateMipmap(texture._glTarget),texture._mipmapsUploaded=!0),texture._gpuSize&&(this._vram.tex-=texture._gpuSize),texture._gpuSize=texture.gpuSize,this._vram.tex+=texture._gpuSize}},_proto.activeTexture=function activeTexture(textureUnit){this.textureUnit!==textureUnit&&(this.gl.activeTexture(this.gl.TEXTURE0+textureUnit),this.textureUnit=textureUnit)},_proto.bindTexture=function bindTexture(texture){var textureTarget=texture._glTarget,textureObject=texture._glTexture,textureUnit=this.textureUnit,slot=this.targetToSlot[textureTarget];this.textureUnits[textureUnit][slot]!==textureObject&&(this.gl.bindTexture(textureTarget,textureObject),this.textureUnits[textureUnit][slot]=textureObject)},_proto.bindTextureOnUnit=function bindTextureOnUnit(texture,textureUnit){var textureTarget=texture._glTarget,textureObject=texture._glTexture,slot=this.targetToSlot[textureTarget];this.textureUnits[textureUnit][slot]!==textureObject&&(this.activeTexture(textureUnit),this.gl.bindTexture(textureTarget,textureObject),this.textureUnits[textureUnit][slot]=textureObject)},_proto.setTextureParameters=function setTextureParameters(texture){var gl=this.gl,flags=texture._parameterFlags,target=texture._glTarget;if(1&flags){var filter=texture._minFilter;(!texture.pot&&!this.webgl2||!texture._mipmaps||texture._compressed&&1===texture._levels.length)&&(2===filter||3===filter?filter=0:4!==filter&&5!==filter||(filter=1)),gl.texParameteri(target,gl.TEXTURE_MIN_FILTER,this.glFilter[filter])}if(2&flags&&gl.texParameteri(target,gl.TEXTURE_MAG_FILTER,this.glFilter[texture._magFilter]),4&flags&&(this.webgl2?gl.texParameteri(target,gl.TEXTURE_WRAP_S,this.glAddress[texture._addressU]):gl.texParameteri(target,gl.TEXTURE_WRAP_S,this.glAddress[texture.pot?texture._addressU:1])),8&flags&&(this.webgl2?gl.texParameteri(target,gl.TEXTURE_WRAP_T,this.glAddress[texture._addressV]):gl.texParameteri(target,gl.TEXTURE_WRAP_T,this.glAddress[texture.pot?texture._addressV:1])),16&flags&&this.webgl2&&gl.texParameteri(target,gl.TEXTURE_WRAP_R,this.glAddress[texture._addressW]),32&flags&&this.webgl2&&gl.texParameteri(target,gl.TEXTURE_COMPARE_MODE,texture._compareOnRead?gl.COMPARE_REF_TO_TEXTURE:gl.NONE),64&flags&&this.webgl2&&gl.texParameteri(target,gl.TEXTURE_COMPARE_FUNC,this.glComparison[texture._compareFunc]),128&flags){var ext=this.extTextureFilterAnisotropic;ext&&gl.texParameterf(target,ext.TEXTURE_MAX_ANISOTROPY_EXT,Math.max(1,Math.min(Math.round(texture._anisotropy),this.maxAnisotropy)))}},_proto.setTexture=function setTexture(texture,textureUnit){var processed;(texture._glTexture||this.initializeTexture(texture),texture._parameterFlags>0||texture._needsUpload||texture._needsMipmapsUpload||texture===this.grabPassTexture)?(this.activeTexture(textureUnit),this.bindTexture(texture),texture._parameterFlags&&(this.setTextureParameters(texture),texture._parameterFlags=0),texture===this.grabPassTexture&&this.updateGrabPass()||!texture._needsUpload&&!texture._needsMipmapsUpload||(this.uploadTexture(texture),texture._needsUpload=!1,texture._needsMipmapsUpload=!1)):this.bindTextureOnUnit(texture,textureUnit)},_proto.createVertexArray=function createVertexArray(vertexBuffers){var key,vao,useCache=vertexBuffers.length>1;if(useCache){key="";for(var i=0;i<vertexBuffers.length;i++){var vertexBuffer=vertexBuffers[i];key+=vertexBuffer.id+vertexBuffer.format.renderingingHash}vao=this._vaoMap.get(key)}if(!vao){var gl=this.gl;vao=gl.createVertexArray(),gl.bindVertexArray(vao),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null);for(var _i2=0;_i2<vertexBuffers.length;_i2++){var _vertexBuffer=vertexBuffers[_i2];gl.bindBuffer(gl.ARRAY_BUFFER,_vertexBuffer.bufferId);for(var elements=_vertexBuffer.format.elements,j=0;j<elements.length;j++){var e=elements[j],loc=semanticToLocation[e.name];gl.vertexAttribPointer(loc,e.numComponents,this.glType[e.dataType],e.normalize,e.stride,e.offset),gl.enableVertexAttribArray(loc),_vertexBuffer.instancing&&gl.vertexAttribDivisor(loc,1)}}gl.bindVertexArray(null),gl.bindBuffer(gl.ARRAY_BUFFER,null),useCache&&this._vaoMap.set(key,vao)}return vao},_proto.setBuffers=function setBuffers(){var gl=this.gl,vao;if(1===this.vertexBuffers.length){var vertexBuffer=this.vertexBuffers[0];vertexBuffer._vao||(vertexBuffer._vao=this.createVertexArray(this.vertexBuffers)),vao=vertexBuffer._vao}else vao=this.createVertexArray(this.vertexBuffers);this.boundVao!==vao&&(this.boundVao=vao,gl.bindVertexArray(vao)),this.vertexBuffers.length=0;var bufferId=this.indexBuffer?this.indexBuffer.bufferId:null;gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,bufferId)},_proto.draw=function draw(primitive,numInstances,keepBuffers){var gl=this.gl,sampler,samplerValue,texture,numTextures,uniform,scopeId,uniformVersion,programVersion,shader=this.shader,samplers=shader.samplers,uniforms=shader.uniforms;keepBuffers||this.setBuffers();for(var textureUnit=0,i=0,len=samplers.length;i<len;i++)if(samplerValue=(sampler=samplers[i]).scopeId.value)if(samplerValue instanceof Texture)texture=samplerValue,this.setTexture(texture,textureUnit),sampler.slot!==textureUnit&&(gl.uniform1i(sampler.locationId,textureUnit),sampler.slot=textureUnit),textureUnit++;else{sampler.array.length=0,numTextures=samplerValue.length;for(var j=0;j<numTextures;j++)texture=samplerValue[j],this.setTexture(texture,textureUnit),sampler.array[j]=textureUnit,textureUnit++;gl.uniform1iv(sampler.locationId,sampler.array)}for(var _i3=0,_len=uniforms.length;_i3<_len;_i3++)scopeId=(uniform=uniforms[_i3]).scopeId,uniformVersion=uniform.version,programVersion=scopeId.versionObject.version,uniformVersion.globalId===programVersion.globalId&&uniformVersion.revision===programVersion.revision||(uniformVersion.globalId=programVersion.globalId,uniformVersion.revision=programVersion.revision,null!==scopeId.value&&this.commitFunction[uniform.dataType](uniform,scopeId.value));this.webgl2&&this.transformFeedbackBuffer&&(gl.bindBufferBase(gl.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.bufferId),gl.beginTransformFeedback(gl.POINTS));var mode=this.glPrimitive[primitive.type],count=primitive.count;if(primitive.indexed){var indexBuffer=this.indexBuffer,format=indexBuffer.glFormat,offset=primitive.base*indexBuffer.bytesPerIndex;numInstances>0?gl.drawElementsInstanced(mode,count,format,offset,numInstances):gl.drawElements(mode,count,format,offset)}else{var first=primitive.base;numInstances>0?gl.drawArraysInstanced(mode,first,count,numInstances):gl.drawArrays(mode,first,count)}this.webgl2&&this.transformFeedbackBuffer&&(gl.endTransformFeedback(),gl.bindBufferBase(gl.TRANSFORM_FEEDBACK_BUFFER,0,null)),this._drawCallsPerFrame++},_proto.clear=function clear(options){var defaultOptions=this.defaultClearOptions,flags=null==(options=options||defaultOptions).flags?defaultOptions.flags:options.flags;if(0!==flags){var gl=this.gl;if(1&flags){var color=null==options.color?defaultOptions.color:options.color;this.setClearColor(color[0],color[1],color[2],color[3])}if(2&flags){var depth=null==options.depth?defaultOptions.depth:options.depth;this.setClearDepth(depth),this.depthWrite||gl.depthMask(!0)}if(4&flags){var stencil=null==options.stencil?defaultOptions.stencil:options.stencil;this.setClearStencil(stencil)}gl.clear(this.glClearFlag[flags]),2&flags&&(this.depthWrite||gl.depthMask(!1))}},_proto.readPixels=function readPixels(x,y,w,h,pixels){var gl=this.gl;gl.readPixels(x,y,w,h,gl.RGBA,gl.UNSIGNED_BYTE,pixels)},_proto.setClearDepth=function setClearDepth(depth){depth!==this.clearDepth&&(this.gl.clearDepth(depth),this.clearDepth=depth)},_proto.setClearColor=function setClearColor(r,g,b,a){r===this.clearRed&&g===this.clearGreen&&b===this.clearBlue&&a===this.clearAlpha||(this.gl.clearColor(r,g,b,a),this.clearRed=r,this.clearGreen=g,this.clearBlue=b,this.clearAlpha=a)},_proto.setClearStencil=function setClearStencil(value){value!==this.clearStencil&&(this.gl.clearStencil(value),this.clearStencil=value)},_proto.setRenderTarget=function setRenderTarget(renderTarget){this.renderTarget=renderTarget},_proto.getRenderTarget=function getRenderTarget(){return this.renderTarget},_proto.getDepthTest=function getDepthTest(){return this.depthTest},_proto.setDepthTest=function setDepthTest(depthTest){if(this.depthTest!==depthTest){var gl=this.gl;depthTest?gl.enable(gl.DEPTH_TEST):gl.disable(gl.DEPTH_TEST),this.depthTest=depthTest}},_proto.setDepthFunc=function setDepthFunc(func){this.depthFunc!==func&&(this.gl.depthFunc(this.glComparison[func]),this.depthFunc=func)},_proto.getDepthWrite=function getDepthWrite(){return this.depthWrite},_proto.setDepthWrite=function setDepthWrite(writeDepth){this.depthWrite!==writeDepth&&(this.gl.depthMask(writeDepth),this.depthWrite=writeDepth)},_proto.setColorWrite=function setColorWrite(writeRed,writeGreen,writeBlue,writeAlpha){this.writeRed===writeRed&&this.writeGreen===writeGreen&&this.writeBlue===writeBlue&&this.writeAlpha===writeAlpha||(this.gl.colorMask(writeRed,writeGreen,writeBlue,writeAlpha),this.writeRed=writeRed,this.writeGreen=writeGreen,this.writeBlue=writeBlue,this.writeAlpha=writeAlpha)},_proto.setAlphaToCoverage=function setAlphaToCoverage(state){this.webgl2&&this.alphaToCoverage!==state&&(this.alphaToCoverage=state,state?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))},_proto.setTransformFeedbackBuffer=function setTransformFeedbackBuffer(tf){if(this.transformFeedbackBuffer!==tf&&(this.transformFeedbackBuffer=tf,this.webgl2)){var gl=this.gl;tf?(this.feedback||(this.feedback=gl.createTransformFeedback()),gl.bindTransformFeedback(gl.TRANSFORM_FEEDBACK,this.feedback)):gl.bindTransformFeedback(gl.TRANSFORM_FEEDBACK,null)}},_proto.setRaster=function setRaster(on){this.raster!==on&&(this.raster=on,this.webgl2&&(on?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD)))},_proto.setDepthBias=function setDepthBias(on){this.depthBiasEnabled!==on&&(this.depthBiasEnabled=on,on?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL))},_proto.setDepthBiasValues=function setDepthBiasValues(constBias,slopeBias){this.gl.polygonOffset(slopeBias,constBias)},_proto.getBlending=function getBlending(){return this.blending},_proto.setBlending=function setBlending(blending){if(this.blending!==blending){var gl=this.gl;blending?gl.enable(gl.BLEND):gl.disable(gl.BLEND),this.blending=blending}},_proto.setStencilTest=function setStencilTest(enable){if(this.stencil!==enable){var gl=this.gl;enable?gl.enable(gl.STENCIL_TEST):gl.disable(gl.STENCIL_TEST),this.stencil=enable}},_proto.setStencilFunc=function setStencilFunc(func,ref,mask){var gl;this.stencilFuncFront===func&&this.stencilRefFront===ref&&this.stencilMaskFront===mask&&this.stencilFuncBack===func&&this.stencilRefBack===ref&&this.stencilMaskBack===mask||(this.gl.stencilFunc(this.glComparison[func],ref,mask),this.stencilFuncFront=this.stencilFuncBack=func,this.stencilRefFront=this.stencilRefBack=ref,this.stencilMaskFront=this.stencilMaskBack=mask)},_proto.setStencilFuncFront=function setStencilFuncFront(func,ref,mask){if(this.stencilFuncFront!==func||this.stencilRefFront!==ref||this.stencilMaskFront!==mask){var gl=this.gl;gl.stencilFuncSeparate(gl.FRONT,this.glComparison[func],ref,mask),this.stencilFuncFront=func,this.stencilRefFront=ref,this.stencilMaskFront=mask}},_proto.setStencilFuncBack=function setStencilFuncBack(func,ref,mask){if(this.stencilFuncBack!==func||this.stencilRefBack!==ref||this.stencilMaskBack!==mask){var gl=this.gl;gl.stencilFuncSeparate(gl.BACK,this.glComparison[func],ref,mask),this.stencilFuncBack=func,this.stencilRefBack=ref,this.stencilMaskBack=mask}},_proto.setStencilOperation=function setStencilOperation(fail,zfail,zpass,writeMask){this.stencilFailFront===fail&&this.stencilZfailFront===zfail&&this.stencilZpassFront===zpass&&this.stencilFailBack===fail&&this.stencilZfailBack===zfail&&this.stencilZpassBack===zpass||(this.gl.stencilOp(this.glStencilOp[fail],this.glStencilOp[zfail],this.glStencilOp[zpass]),this.stencilFailFront=this.stencilFailBack=fail,this.stencilZfailFront=this.stencilZfailBack=zfail,this.stencilZpassFront=this.stencilZpassBack=zpass),this.stencilWriteMaskFront===writeMask&&this.stencilWriteMaskBack===writeMask||(this.gl.stencilMask(writeMask),this.stencilWriteMaskFront=writeMask,this.stencilWriteMaskBack=writeMask)},_proto.setStencilOperationFront=function setStencilOperationFront(fail,zfail,zpass,writeMask){this.stencilFailFront===fail&&this.stencilZfailFront===zfail&&this.stencilZpassFront===zpass||(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[fail],this.glStencilOp[zfail],this.glStencilOp[zpass]),this.stencilFailFront=fail,this.stencilZfailFront=zfail,this.stencilZpassFront=zpass),this.stencilWriteMaskFront!==writeMask&&(this.gl.stencilMaskSeparate(this.gl.FRONT,writeMask),this.stencilWriteMaskFront=writeMask)},_proto.setStencilOperationBack=function setStencilOperationBack(fail,zfail,zpass,writeMask){this.stencilFailBack===fail&&this.stencilZfailBack===zfail&&this.stencilZpassBack===zpass||(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[fail],this.glStencilOp[zfail],this.glStencilOp[zpass]),this.stencilFailBack=fail,this.stencilZfailBack=zfail,this.stencilZpassBack=zpass),this.stencilWriteMaskBack!==writeMask&&(this.gl.stencilMaskSeparate(this.gl.BACK,writeMask),this.stencilWriteMaskBack=writeMask)},_proto.setBlendFunction=function setBlendFunction(blendSrc,blendDst){(this.blendSrc!==blendSrc||this.blendDst!==blendDst||this.separateAlphaBlend)&&(this.gl.blendFunc(this.glBlendFunction[blendSrc],this.glBlendFunction[blendDst]),this.blendSrc=blendSrc,this.blendDst=blendDst,this.separateAlphaBlend=!1)},_proto.setBlendFunctionSeparate=function setBlendFunctionSeparate(blendSrc,blendDst,blendSrcAlpha,blendDstAlpha){this.blendSrc===blendSrc&&this.blendDst===blendDst&&this.blendSrcAlpha===blendSrcAlpha&&this.blendDstAlpha===blendDstAlpha&&this.separateAlphaBlend||(this.gl.blendFuncSeparate(this.glBlendFunction[blendSrc],this.glBlendFunction[blendDst],this.glBlendFunction[blendSrcAlpha],this.glBlendFunction[blendDstAlpha]),this.blendSrc=blendSrc,this.blendDst=blendDst,this.blendSrcAlpha=blendSrcAlpha,this.blendDstAlpha=blendDstAlpha,this.separateAlphaBlend=!0)},_proto.setBlendEquation=function setBlendEquation(blendEquation){(this.blendEquation!==blendEquation||this.separateAlphaEquation)&&(this.gl.blendEquation(this.glBlendEquation[blendEquation]),this.blendEquation=blendEquation,this.separateAlphaEquation=!1)},_proto.setBlendEquationSeparate=function setBlendEquationSeparate(blendEquation,blendAlphaEquation){this.blendEquation===blendEquation&&this.blendAlphaEquation===blendAlphaEquation&&this.separateAlphaEquation||(this.gl.blendEquationSeparate(this.glBlendEquation[blendEquation],this.glBlendEquation[blendAlphaEquation]),this.blendEquation=blendEquation,this.blendAlphaEquation=blendAlphaEquation,this.separateAlphaEquation=!0)},_proto.setCullMode=function setCullMode(cullMode){if(this.cullMode!==cullMode){if(0===cullMode)this.gl.disable(this.gl.CULL_FACE);else{0===this.cullMode&&this.gl.enable(this.gl.CULL_FACE);var mode=this.glCull[cullMode];this.cullFace!==mode&&(this.gl.cullFace(mode),this.cullFace=mode)}this.cullMode=cullMode}},_proto.getCullMode=function getCullMode(){return this.cullMode},_proto.setIndexBuffer=function setIndexBuffer(indexBuffer){this.indexBuffer=indexBuffer},_proto.setVertexBuffer=function setVertexBuffer(vertexBuffer){vertexBuffer&&this.vertexBuffers.push(vertexBuffer)},_proto.compileShaderSource=function compileShaderSource(src,isVertexShader){var gl=this.gl,glShader=isVertexShader?this.vertexShaderCache[src]:this.fragmentShaderCache[src];return glShader||(glShader=gl.createShader(isVertexShader?gl.VERTEX_SHADER:gl.FRAGMENT_SHADER),gl.shaderSource(glShader,src),gl.compileShader(glShader),isVertexShader?this.vertexShaderCache[src]=glShader:this.fragmentShaderCache[src]=glShader),glShader},_proto.compileAndLinkShader=function compileAndLinkShader(shader){var gl=this.gl,definition=shader.definition,attrs=definition.attributes,glVertexShader=this.compileShaderSource(definition.vshader,!0),glFragmentShader=this.compileShaderSource(definition.fshader,!1),glProgram=gl.createProgram();if(gl.attachShader(glProgram,glVertexShader),gl.attachShader(glProgram,glFragmentShader),this.webgl2&&definition.useTransformFeedback){var outNames=[];for(var attr in attrs)attrs.hasOwnProperty(attr)&&outNames.push("out_"+attr);gl.transformFeedbackVaryings(glProgram,outNames,gl.INTERLEAVED_ATTRIBS)}var locations={};for(var _attr in attrs)if(attrs.hasOwnProperty(_attr)){var semantic=attrs[_attr],loc=semanticToLocation[semantic];locations[loc]=_attr,gl.bindAttribLocation(glProgram,loc,_attr)}gl.linkProgram(glProgram),shader._glVertexShader=glVertexShader,shader._glFragmentShader=glFragmentShader,shader._glProgram=glProgram},_proto.createShader=function createShader(shader){this.compileAndLinkShader(shader),this.shaders.push(shader)},_proto.destroyShader=function destroyShader(shader){var idx=this.shaders.indexOf(shader);-1!==idx&&this.shaders.splice(idx,1),shader._glProgram&&(this.gl.deleteProgram(shader._glProgram),shader._glProgram=null,this.removeShaderFromCache(shader))},_proto._addLineNumbers=function _addLineNumbers(src){for(var lines=src.split("\n"),i=0,len=lines.length;i<len;i++)lines[i]=i+1+":\t"+lines[i];return lines.join("\n")},_proto.postLink=function postLink(shader){var gl=this.gl,glVertexShader=shader._glVertexShader,glFragmentShader=shader._glFragmentShader,glProgram=shader._glProgram,definition=shader.definition,i,info,location,shaderInput;if(!gl.getShaderParameter(glVertexShader,gl.COMPILE_STATUS))return console.error("Failed to compile vertex shader:\n\n"+this._addLineNumbers(definition.vshader)+"\n\n"+gl.getShaderInfoLog(glVertexShader)),!1;if(!gl.getShaderParameter(glFragmentShader,gl.COMPILE_STATUS))return console.error("Failed to compile fragment shader:\n\n"+this._addLineNumbers(definition.fshader)+"\n\n"+gl.getShaderInfoLog(glFragmentShader)),!1;if(!gl.getProgramParameter(glProgram,gl.LINK_STATUS))return console.error("Failed to link shader program. Error: "+gl.getProgramInfoLog(glProgram)),!1;i=0;for(var numAttributes=gl.getProgramParameter(glProgram,gl.ACTIVE_ATTRIBUTES);i<numAttributes;)info=gl.getActiveAttrib(glProgram,i++),location=gl.getAttribLocation(glProgram,info.name),void 0===definition.attributes[info.name]&&console.error('Vertex shader attribute "'+info.name+'" is not mapped to a semantic in shader definition.'),shaderInput=new ShaderInput(this,definition.attributes[info.name],this.pcUniformType[info.type],location),shader.attributes.push(shaderInput);i=0;for(var numUniforms=gl.getProgramParameter(glProgram,gl.ACTIVE_UNIFORMS);i<numUniforms;)info=gl.getActiveUniform(glProgram,i++),location=gl.getUniformLocation(glProgram,info.name),shaderInput=new ShaderInput(this,info.name,this.pcUniformType[info.type],location),info.type===gl.SAMPLER_2D||info.type===gl.SAMPLER_CUBE||this.webgl2&&(info.type===gl.SAMPLER_2D_SHADOW||info.type===gl.SAMPLER_CUBE_SHADOW||info.type===gl.SAMPLER_3D)?shader.samplers.push(shaderInput):shader.uniforms.push(shaderInput);return shader.ready=!0,!0},_proto.setShader=function setShader(shader){if(shader!==this.shader){if(!shader.ready&&!this.postLink(shader))return!1;this.shader=shader,this.gl.useProgram(shader._glProgram),this.attributesInvalidated=!0}return!0},_proto.getHdrFormat=function getHdrFormat(){return this.textureHalfFloatRenderable?12:this.textureFloatRenderable?14:7},_proto.getBoneLimit=function getBoneLimit(){return this.boneLimit},_proto.setBoneLimit=function setBoneLimit(maxBones){this.boneLimit=maxBones},_proto.resizeCanvas=function resizeCanvas(width,height){this._width=width,this._height=height;var ratio=Math.min(this._maxPixelRatio,window.devicePixelRatio);width=Math.floor(width*ratio),height=Math.floor(height*ratio),this.canvas.width===width&&this.canvas.height===height||(this.canvas.width=width,this.canvas.height=height,this.fire(EVENT_RESIZE,width,height))},_proto.setResolution=function setResolution(width,height){this._width=width,this._height=height,this.canvas.width=width,this.canvas.height=height,this.fire(EVENT_RESIZE,width,height)},_proto.clearShaderCache=function clearShaderCache(){var gl=this.gl;for(var shaderSrc in this.fragmentShaderCache)gl.deleteShader(this.fragmentShaderCache[shaderSrc]),delete this.fragmentShaderCache[shaderSrc];for(var _shaderSrc in this.vertexShaderCache)gl.deleteShader(this.vertexShaderCache[_shaderSrc]),delete this.vertexShaderCache[_shaderSrc];this.programLib.clearCache()},_proto.clearVertexArrayObjectCache=function clearVertexArrayObjectCache(){var gl=this.gl;this._vaoMap.forEach((function(item,key,mapObj){gl.deleteVertexArray(item)})),this._vaoMap.clear()},_proto.removeShaderFromCache=function removeShaderFromCache(shader){this.programLib.removeFromCache(shader)},_proto.destroy=function destroy(){var gl=this.gl;this.destroyGrabPass(),this.webgl2&&this.feedback&&gl.deleteTransformFeedback(this.feedback),this.clearShaderCache(),this.clearVertexArrayObjectCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this._contextLostHandler=null,this._contextRestoredHandler=null,this.canvas=null,this.gl=null},_createClass(GraphicsDevice,[{key:"width",get:function get(){return this.gl.drawingBufferWidth||this.canvas.width}},{key:"height",get:function get(){return this.gl.drawingBufferHeight||this.canvas.height}},{key:"fullscreen",get:function get(){return!!document.fullscreenElement},set:function set(fullscreen){var canvas;fullscreen?this.gl.canvas.requestFullscreen():document.exitFullscreen()}},{key:"enableAutoInstancing",get:function get(){return this._enableAutoInstancing},set:function set(value){this._enableAutoInstancing=value&&this.extInstancing}},{key:"maxPixelRatio",get:function get(){return this._maxPixelRatio},set:function set(ratio){this._maxPixelRatio=ratio,this.resizeCanvas(this._width,this._height)}},{key:"textureFloatHighPrecision",get:function get(){return void 0===this._textureFloatHighPrecision&&(this._textureFloatHighPrecision=testTextureFloatHighPrecision(this)),this._textureFloatHighPrecision}},{key:"textureHalfFloatUpdatable",get:function get(){return void 0===this._textureHalfFloatUpdatable&&(this.webgl2?this._textureHalfFloatUpdatable=!0:this._textureHalfFloatUpdatable=testTextureHalfFloatUpdatable(this.gl,this.extTextureHalfFloat.HALF_FLOAT_OES)),this._textureHalfFloatUpdatable}}]),GraphicsDevice}(EventHandler),defaultOptions={depth:!0,face:0},RenderTarget=function(){function RenderTarget(options){var _arg2=arguments[1],_arg3=arguments[2],_this$_colorBuffer,_this$_depthBuffer;if(options instanceof GraphicsDevice?(this._colorBuffer=_arg2,options=_arg3):this._colorBuffer=options.colorBuffer,this._colorBuffer&&(this._colorBuffer._isRenderTarget=!0),this._device=null,this._glFrameBuffer=null,this._glDepthBuffer=null,options=void 0!==options?options:defaultOptions,this._depthBuffer=options.depthBuffer,this._face=void 0!==options.face?options.face:0,this._depthBuffer){var format=this._depthBuffer._format;16===format?(this._depth=!0,this._stencil=!1):17===format?(this._depth=!0,this._stencil=!0):(this._depth=!1,this._stencil=!1)}else this._depth=void 0===options.depth||options.depth,this._stencil=void 0!==options.stencil&&options.stencil;(this._samples=void 0!==options.samples?options.samples:1,this.autoResolve=void 0===options.autoResolve||options.autoResolve,this._glResolveFrameBuffer=null,this._glMsaaColorBuffer=null,this._glMsaaDepthBuffer=null,this.name=options.name,this.name)||(this.name=null==(_this$_colorBuffer=this._colorBuffer)?void 0:_this$_colorBuffer.name);this.name||(this.name=null==(_this$_depthBuffer=this._depthBuffer)?void 0:_this$_depthBuffer.name);this.name||(this.name="Untitled")}var _proto=RenderTarget.prototype;return _proto.destroy=function destroy(){var device=this._device;if(device){var idx=device.targets.indexOf(this);-1!==idx&&device.targets.splice(idx,1),this.destroyFrameBuffers()}},_proto.destroyFrameBuffers=function destroyFrameBuffers(){var device=this._device;if(device){var gl=device.gl;this._glFrameBuffer&&(gl.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null),this._glDepthBuffer&&(gl.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null),this._glResolveFrameBuffer&&(gl.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null),this._glMsaaColorBuffer&&(gl.deleteRenderbuffer(this._glMsaaColorBuffer),this._glMsaaColorBuffer=null),this._glMsaaDepthBuffer&&(gl.deleteRenderbuffer(this._glMsaaDepthBuffer),this._glMsaaDepthBuffer=null)}},_proto.destroyTextureBuffers=function destroyTextureBuffers(){this._depthBuffer&&(this._depthBuffer.destroy(),this._depthBuffer=null),this._colorBuffer&&(this._colorBuffer.destroy(),this._colorBuffer=null)},_proto.loseContext=function loseContext(){this._glFrameBuffer=void 0,this._glDepthBuffer=void 0,this._glResolveFrameBuffer=void 0,this._glMsaaColorBuffer=void 0,this._glMsaaDepthBuffer=void 0},_proto.resolve=function resolve(color,depth){if(void 0===color&&(color=!0),void 0===depth&&(depth=!!this._depthBuffer),this._device&&this._device.webgl2){var gl=this._device.gl;gl.bindFramebuffer(gl.READ_FRAMEBUFFER,this._glFrameBuffer),gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,this._glResolveFrameBuffer),gl.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,(color?gl.COLOR_BUFFER_BIT:0)|(depth?gl.DEPTH_BUFFER_BIT:0),gl.NEAREST),gl.bindFramebuffer(gl.FRAMEBUFFER,this._glFrameBuffer)}},_proto.copy=function copy(source,color,depth){if(!this._device){if(!source._device)return!1;this._device=source._device}return this._device.copyRenderTarget(source,this,color,depth)},_createClass(RenderTarget,[{key:"colorBuffer",get:function get(){return this._colorBuffer}},{key:"depthBuffer",get:function get(){return this._depthBuffer}},{key:"face",get:function get(){return this._face}},{key:"width",get:function get(){return this._colorBuffer?this._colorBuffer.width:this._depthBuffer.width}},{key:"height",get:function get(){return this._colorBuffer?this._colorBuffer.height:this._depthBuffer.height}}]),RenderTarget}();function syncToCpu(device,targ,face){var tex=targ._colorBuffer;if(7===tex.format){var pixels=new Uint8Array(tex.width*tex.height*4),gl=device.gl;device.setFramebuffer(targ._glFrameBuffer),gl.readPixels(0,0,tex.width,tex.height,gl.RGBA,gl.UNSIGNED_BYTE,pixels),tex._levels||(tex._levels=[]),tex._levels[0]||(tex._levels[0]=[]),tex._levels[0][face]=pixels}}function prefilterCubemap(options){var device=options.device,sourceCubemap=options.sourceCubemap,method=options.method,samples=options.samples,cpuSync=options.cpuSync;if(!cpuSync||sourceCubemap._levels[0]){var sourceType=sourceCubemap.type,rgbmSource="rgbm"===sourceType,shader=createShaderFromCode(device,shaderChunks.fullscreenQuadVS,shaderChunks.rgbmPS+shaderChunks.prefilterCubemapPS.replace(/\$METHOD/g,0===method?"cos":"phong").replace(/\$NUMSAMPLES/g,samples).replace(/\$textureCube/g,rgbmSource?"textureCubeRGBM":"textureCube"),"prefilter"+method+samples+rgbmSource),shader2=createShaderFromCode(device,shaderChunks.fullscreenQuadVS,shaderChunks.outputCubemapPS,"outputCubemap"),constantTexSource=device.scope.resolve("source"),constantParams=device.scope.resolve("params"),params=new Float32Array(4),size=sourceCubemap.width,format=sourceCubemap.format,cmapsList=[[],options.filteredFixed,options.filteredRgbm,options.filteredFixedRgbm],gloss=0===method?[.9,.85,.7,.4,.25,.15,.1]:[512,128,32,8,2,1,1],mipSize=[64,32,16,8,4,2,1],numMips=7,targ,i,face,pass,rgbFormat=6===format,isImg=!1,nextCubemap,cubemap;if(cpuSync&&(isImg=sourceCubemap._levels[0][0]instanceof HTMLImageElement),(rgbFormat||isImg)&&cpuSync){for((nextCubemap=new Texture(device,{cubemap:!0,type:sourceType,format:format=7,width:size,height:size,mipmaps:!1})).name="prefiltered-cube",face=0;face<6;face++)targ=new RenderTarget({colorBuffer:nextCubemap,face:face,depth:!1}),params[0]=face,params[1]=0,constantTexSource.setValue(sourceCubemap),constantParams.setValue(params),drawQuadWithShader(device,targ,shader2),syncToCpu(device,targ,face);sourceCubemap=nextCubemap}if(size>128){var log128=Math.round(Math.log2(128)),logSize,steps=Math.round(Math.log2(size))-log128;for(i=0;i<steps;i++){size=.5*sourceCubemap.width;var sampleGloss=0===method?1:Math.pow(2,Math.round(Math.log2(gloss[0])+2*(steps-i)));for((nextCubemap=new Texture(device,{cubemap:!0,type:sourceType,format:format,width:size,height:size,mipmaps:!1})).name="prefiltered-cube",face=0;face<6;face++)targ=new RenderTarget({colorBuffer:nextCubemap,face:face,depth:!1}),params[0]=face,params[1]=sampleGloss,params[2]=size,params[3]=rgbmSource?3:0,constantTexSource.setValue(sourceCubemap),constantParams.setValue(params),drawQuadWithShader(device,targ,shader2),i===steps-1&&cpuSync&&syncToCpu(device,targ,face);sourceCubemap=nextCubemap}}options.sourceCubemap=sourceCubemap;var sourceCubemapRgbm=null;if(!rgbmSource&&options.filteredFixedRgbm){for((nextCubemap=new Texture(device,{cubemap:!0,type:"rgbm",format:7,width:size,height:size,mipmaps:!1})).name="prefiltered-cube",face=0;face<6;face++)targ=new RenderTarget({colorBuffer:nextCubemap,face:face,depth:!1}),params[0]=face,params[3]=2,constantTexSource.setValue(sourceCubemap),constantParams.setValue(params),drawQuadWithShader(device,targ,shader2),syncToCpu(device,targ,face);sourceCubemapRgbm=nextCubemap}var unblurredGloss=0===method?1:2048,startPass=0===method?0:-1,mips;for(cmapsList[startPass]=[],i=0;i<7;i++)for(pass=startPass;pass<cmapsList.length;pass++)null!=cmapsList[pass]&&(cmapsList[pass][i]=new Texture(device,{cubemap:!0,type:pass<2?sourceType:"rgbm",format:pass<2?format:7,fixCubemapSeams:1===pass||3===pass,width:mipSize[i],height:mipSize[i],mipmaps:!1}),cmapsList[pass][i].name="prefiltered-cube");for(pass=startPass;pass<cmapsList.length;pass++)if(null!=cmapsList[pass]){if(pass>1&&rgbmSource){cmapsList[pass]=cmapsList[pass-2];continue}for(i=0;i<7;i++)for(face=0;face<6;face++)targ=new RenderTarget({colorBuffer:cmapsList[pass][i],face:face,depth:!1}),params[0]=face,params[1]=pass<0?unblurredGloss:gloss[i],params[2]=mipSize[i],params[3]=rgbmSource?3:pass,constantTexSource.setValue(0===i?sourceCubemap:0===method?cmapsList[0][i-1]:cmapsList[-1][i-1]),constantParams.setValue(params),drawQuadWithShader(device,targ,shader),cpuSync&&syncToCpu(device,targ,face)}if(options.filtered=cmapsList[0],cpuSync&&options.singleFilteredFixed){for(mips=[sourceCubemap].concat(options.filteredFixed),(cubemap=new Texture(device,{cubemap:!0,type:sourceType,fixCubemapSeams:!0,format:format,width:128,height:128,addressU:1,addressV:1})).name="prefiltered-cube",i=0;i<mips.length;i++)cubemap._levels[i]=mips[i]._levels[0];cubemap.upload(),options.singleFilteredFixed=cubemap}if(cpuSync&&options.singleFilteredFixedRgbm&&options.filteredFixedRgbm){for(mips=[sourceCubemapRgbm].concat(options.filteredFixedRgbm),(cubemap=new Texture(device,{cubemap:!0,type:"rgbm",fixCubemapSeams:!0,format:7,width:128,height:128,addressU:1,addressV:1})).name="prefiltered-cube",i=0;i<mips.length;i++)cubemap._levels[i]=mips[i]._levels[0];cubemap.upload(),options.singleFilteredFixedRgbm=cubemap}}}function areaElement(x,y){return Math.atan2(x*y,Math.sqrt(x*x+y*y+1))}function texelCoordSolidAngle(u,v,size){var _u=2*(u+.5)/size-1,_v=2*(v+.5)/size-1,invResolution=1/size,x0=(_u*=1-1/size)-invResolution,y0=(_v*=1-1/size)-invResolution,x1=_u+invResolution,y1=_v+invResolution,solidAngle=areaElement(x0,y0)-areaElement(x0,y1)-areaElement(x1,y0)+areaElement(x1,y1);return 0===u&&0===v||u===size-1&&0===v||0===u&&v===size-1||u===size-1&&v===size-1?solidAngle/=3:0!==u&&0!==v&&u!==size-1&&v!==size-1||(solidAngle*=.5),solidAngle}function shFromCubemap(device,source,dontFlipX){var face,cubeSize=source.width,x,y;if(7===source.format&&source._levels[0]){if(!source._levels[0][0].length){if(!(source._levels[0][0]instanceof HTMLImageElement))return;var gl=device.gl,shader=createShaderFromCode(device,shaderChunks.fullscreenQuadVS,shaderChunks.fullscreenQuadPS,"fsQuadSimple"),constantTexSource=device.scope.resolve("source");for(face=0;face<6;face++){var img=source._levels[0][face],tex=new Texture(device,{cubemap:!1,type:"default",format:source.format,width:cubeSize,height:cubeSize,mipmaps:!1});tex.name="prefiltered-cube",tex._levels[0]=img,tex.upload();var tex2=new Texture(device,{cubemap:!1,type:"default",format:source.format,width:cubeSize,height:cubeSize,mipmaps:!1});tex2.name="prefiltered-cube";var targ=new RenderTarget({colorBuffer:tex2,depth:!1});constantTexSource.setValue(tex),drawQuadWithShader(device,targ,shader);var pixels=new Uint8Array(cubeSize*cubeSize*4);gl.bindFramebuffer(gl.FRAMEBUFFER,targ._glFrameBuffer),gl.readPixels(0,0,tex.width,tex.height,gl.RGBA,gl.UNSIGNED_BYTE,pixels),source._levels[0][face]=pixels}}var dirs=[];for(y=0;y<cubeSize;y++)for(x=0;x<cubeSize;x++){var u=x/(cubeSize-1)*2-1,v=y/(cubeSize-1)*2-1;dirs[y*cubeSize+x]=new Vec3(u,v,1).normalize()}var sh=new Float32Array(27),coef1=0,coef2=3,coef3=6,coef4=9,coef5=12,coef6=15,coef7=18,coef8=21,coef9=24,nx=0,px=1,ny=2,py=3,nz=4,pz=5,addr,c,a,value,weight,dir,dx,dy,dz,weight1,weight2,weight3,weight4,weight5,accum=0;for(face=0;face<6;face++)for(y=0;y<cubeSize;y++)for(x=0;x<cubeSize;x++)for(addr=y*cubeSize+x,weight1=4*(weight=texelCoordSolidAngle(x,y,cubeSize))/17,weight2=8*weight/17,weight3=15*weight/17,weight4=5*weight/68,weight5=15*weight/68,dir=dirs[addr],0==face?(dx=dir.z,dy=-dir.y,dz=-dir.x):1===face?(dx=-dir.z,dy=-dir.y,dz=dir.x):2===face?(dx=dir.x,dy=dir.z,dz=dir.y):3===face?(dx=dir.x,dy=-dir.z,dz=-dir.y):4===face?(dx=dir.x,dy=-dir.y,dz=dir.z):5===face&&(dx=-dir.x,dy=-dir.y,dz=-dir.z),dontFlipX||(dx=-dx),a=source._levels[0][face][4*addr+3]/255,c=0;c<3;c++)value=source._levels[0][face][4*addr+c]/255,"rgbm"===source.type?(value*=8*a,value*=value):value=Math.pow(value,2.2),sh[0+c]+=value*weight1,sh[3+c]+=value*weight2*dx,sh[6+c]+=value*weight2*dy,sh[9+c]+=value*weight2*dz,sh[12+c]+=value*weight3*dx*dz,sh[15+c]+=value*weight3*dz*dy,sh[18+c]+=value*weight3*dy*dx,sh[21+c]+=value*weight4*(3*dz*dz-1),sh[24+c]+=value*weight5*(dx*dx-dy*dy),accum+=weight;for(c=0;c<sh.length;c++)sh[c]*=4*Math.PI/accum;return sh}}function getCoding(texture){switch(texture.type){case"rgbm":return"RGBM";case"rgbe":return"RGBE";default:switch(texture.format){case 11:case 13:case 12:case 14:return"Linear";default:return"Gamma"}}}function getProjectionName(projection){switch("none"===projection&&(projection="equirect"),projection){case"cube":return"Cubemap";case"equirect":return"Equirect";case"octahedral":return"Octahedral"}}function reprojectTexture(source,target,options){void 0===options&&(options={}),source instanceof GraphicsDevice&&(source=arguments[1],target=arguments[2],options={specularPower:void 0===arguments[3]?1:arguments[3],numSamples:void 0===arguments[4]?1024:arguments[4]});var device=source.device,specularPower=options.hasOwnProperty("specularPower")?options.specularPower:1,numSamples=options.hasOwnProperty("numSamples")?options.numSamples:1024,face=options.hasOwnProperty("face")?options.face:null,processFunc=1===specularPower?"reproject":"prefilter",decodeFunc="decode"+getCoding(source),encodeFunc="encode"+getCoding(target),sourceFunc="sample"+getProjectionName(source.projection),targetFunc="getDirection"+getProjectionName(target.projection),shader=createShaderFromCode(device,shaderChunks.fullscreenQuadVS,"#define PROCESS_FUNC "+processFunc+"\n#define DECODE_FUNC "+decodeFunc+"\n#define ENCODE_FUNC "+encodeFunc+"\n#define SOURCE_FUNC "+sourceFunc+"\n#define TARGET_FUNC "+targetFunc+"\n#define NUM_SAMPLES "+numSamples+"\n#define NUM_SAMPLES_SQRT "+Math.round(Math.sqrt(numSamples)).toFixed(1)+"\n\n"+shaderChunks.reprojectPS,processFunc+decodeFunc+encodeFunc+sourceFunc+targetFunc,null,device.webgl2?"":"#extension GL_OES_standard_derivatives: enable\n"),constantSource=device.scope.resolve(source.cubemap?"sourceCube":"sourceTex");constantSource.setValue(source);for(var constantParams=device.scope.resolve("params"),params=[0,specularPower,1-(source.fixCubemapSeams?1/source.width:0),1-(target.fixCubemapSeams?1/target.width:0)],f=0;f<(target.cubemap?6:1);f++)if(null===face||f===face){var renderTarget=new RenderTarget({colorBuffer:target,face:f,depth:!1});params[0]=f,constantParams.setValue(params),drawQuadWithShader(device,renderTarget,shader),renderTarget.destroy()}}var IndexBuffer=function(){function IndexBuffer(graphicsDevice,format,numIndices,usage,initialData){void 0===usage&&(usage=0),this.device=graphicsDevice,this.format=format,this.numIndices=numIndices,this.usage=usage;var gl=this.device.gl,bytesPerIndex;0===format?(bytesPerIndex=1,this.glFormat=gl.UNSIGNED_BYTE):1===format?(bytesPerIndex=2,this.glFormat=gl.UNSIGNED_SHORT):2===format&&(bytesPerIndex=4,this.glFormat=gl.UNSIGNED_INT),this.bytesPerIndex=bytesPerIndex,this.numBytes=this.numIndices*bytesPerIndex,initialData?this.setData(initialData):this.storage=new ArrayBuffer(this.numBytes),graphicsDevice._vram.ib+=this.numBytes,this.device.buffers.push(this)}var _proto=IndexBuffer.prototype;return _proto.destroy=function destroy(){var device=this.device,idx=device.buffers.indexOf(this),gl;(-1!==idx&&device.buffers.splice(idx,1),this.bufferId)&&(this.device.gl.deleteBuffer(this.bufferId),this.device._vram.ib-=this.storage.byteLength,this.bufferId=null,this.device.indexBuffer===this&&(this.device.indexBuffer=null))},_proto.loseContext=function loseContext(){this.bufferId=void 0},_proto.getFormat=function getFormat(){return this.format},_proto.getNumIndices=function getNumIndices(){return this.numIndices},_proto.lock=function lock(){return this.storage},_proto.unlock=function unlock(){var gl=this.device.gl,glUsage;switch(this.bufferId||(this.bufferId=gl.createBuffer()),this.usage){case 0:glUsage=gl.STATIC_DRAW;break;case 1:glUsage=gl.DYNAMIC_DRAW;break;case 2:glUsage=gl.STREAM_DRAW;break;case 3:glUsage=this.device.webgl2?gl.DYNAMIC_COPY:gl.STATIC_DRAW}gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.bufferId),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,this.storage,glUsage)},_proto.setData=function setData(data){return data.byteLength===this.numBytes&&(this.storage=data,this.unlock(),!0)},_proto._lockTypedArray=function _lockTypedArray(){var lock=this.lock(),indices;return 2===this.format?new Uint32Array(lock):1===this.format?new Uint16Array(lock):new Uint8Array(lock)},_proto.writeData=function writeData(data,count){var indices=this._lockTypedArray(),i;if(data.length>count)if(ArrayBuffer.isView(data))data=data.subarray(0,count),indices.set(data);else for(i=0;i<count;i++)indices[i]=data[i];else indices.set(data);this.unlock()},_proto.readData=function readData(data){var indices=this._lockTypedArray(),count=this.numIndices,i;if(ArrayBuffer.isView(data))data.set(indices);else for(data.length=0,i=0;i<count;i++)data[i]=indices[i];return count},IndexBuffer}(),primitive={type:5,base:0,count:4,indexed:!1},PostEffect$1=function(){function PostEffect(graphicsDevice){this.device=graphicsDevice,this.shader=null,this.depthMap=null,this.vertexBuffer=createFullscreenQuad(graphicsDevice),this.needsDepthBuffer=!1}var _proto;return PostEffect.prototype.render=function render(inputTarget,outputTarget,rect){},PostEffect}();function createFullscreenQuad(device){var vertexFormat=new VertexFormat(device,[{semantic:"POSITION",components:2,type:6}]),vertexBuffer=new VertexBuffer(device,vertexFormat,4),iterator=new VertexIterator(vertexBuffer);return iterator.element.POSITION.set(-1,-1),iterator.next(),iterator.element.POSITION.set(1,-1),iterator.next(),iterator.element.POSITION.set(-1,1),iterator.next(),iterator.element.POSITION.set(1,1),iterator.end(),vertexBuffer}function drawFullscreenQuad(device,target,vertexBuffer,shader,rect){var oldRt=device.getRenderTarget();device.setRenderTarget(target),device.updateBegin();var w=target?target.width:device.width,h=target?target.height:device.height,x=0,y=0;rect&&(x=rect.x*w,y=rect.y*h,w*=rect.z,h*=rect.w);var oldVx=device.vx,oldVy=device.vy,oldVw=device.vw,oldVh=device.vh;device.setViewport(x,y,w,h);var oldSx=device.sx,oldSy=device.sy,oldSw=device.sw,oldSh=device.sh;device.setScissor(x,y,w,h);var oldBlending=device.getBlending(),oldDepthTest=device.getDepthTest(),oldDepthWrite=device.getDepthWrite(),oldCullMode=device.getCullMode(),oldWR=device.writeRed,oldWG=device.writeGreen,oldWB=device.writeBlue,oldWA=device.writeAlpha;device.setBlending(!1),device.setDepthTest(!1),device.setDepthWrite(!1),device.setCullMode(0),device.setColorWrite(!0,!0,!0,!0),device.setVertexBuffer(vertexBuffer,0),device.setShader(shader),device.draw(primitive),device.setBlending(oldBlending),device.setDepthTest(oldDepthTest),device.setDepthWrite(oldDepthWrite),device.setCullMode(oldCullMode),device.setColorWrite(oldWR,oldWG,oldWB,oldWA),device.updateEnd(),device.setRenderTarget(oldRt),device.updateBegin(),device.setViewport(oldVx,oldVy,oldVw,oldVh),device.setScissor(oldSx,oldSy,oldSw,oldSh)}var TransformFeedback=function(){function TransformFeedback(inputBuffer,usage){void 0===usage&&(usage=3),this.device=inputBuffer.device;var gl=this.device.gl;this._inputBuffer=inputBuffer,3===usage&&inputBuffer.usage!==usage&&(gl.bindBuffer(gl.ARRAY_BUFFER,inputBuffer.bufferId),gl.bufferData(gl.ARRAY_BUFFER,inputBuffer.storage,gl.DYNAMIC_COPY)),this._outputBuffer=new VertexBuffer(inputBuffer.device,inputBuffer.format,inputBuffer.numVertices,usage,inputBuffer.storage)}TransformFeedback.createShader=function createShader(graphicsDevice,vsCode,name){return createShaderFromCode(graphicsDevice,vsCode,null,name,!0)};var _proto=TransformFeedback.prototype;return _proto.destroy=function destroy(){this._outputBuffer.destroy()},_proto.process=function process(shader,swap){void 0===swap&&(swap=!0);var device=this.device,oldRt=device.getRenderTarget();if(device.setRenderTarget(null),device.updateBegin(),device.setVertexBuffer(this._inputBuffer,0),device.setRaster(!1),device.setTransformFeedbackBuffer(this._outputBuffer),device.setShader(shader),device.draw({type:0,base:0,count:this._inputBuffer.numVertices,indexed:!1}),device.setTransformFeedbackBuffer(null),device.setRaster(!0),device.updateEnd(),device.setRenderTarget(oldRt),swap){var tmp=this._inputBuffer.bufferId;this._inputBuffer.bufferId=this._outputBuffer.bufferId,this._outputBuffer.bufferId=tmp,tmp=this._inputBuffer._vao,this._inputBuffer._vao=this._outputBuffer._vao,this._outputBuffer._vao=tmp}},_createClass(TransformFeedback,[{key:"inputBuffer",get:function get(){return this._inputBuffer}},{key:"outputBuffer",get:function get(){return this._outputBuffer}}]),TransformFeedback}(),RefCountedObject=function(){function RefCountedObject(){this._refCount=0}var _proto=RefCountedObject.prototype;return _proto.incRefCount=function incRefCount(){this._refCount++},_proto.decRefCount=function decRefCount(){this._refCount--},_proto.getRefCount=function getRefCount(){return this._refCount},RefCountedObject}(),id=0,GeometryData=function(){function GeometryData(){this.initDefaults()}var _proto=GeometryData.prototype;return _proto.initDefaults=function initDefaults(){this.recreate=!1,this.verticesUsage=0,this.indicesUsage=0,this.maxVertices=0,this.maxIndices=0,this.vertexCount=0,this.indexCount=0,this.vertexStreamsUpdated=!1,this.indexStreamUpdated=!1,this.vertexStreamDictionary={},this.indices=null},_proto._validateVertexCount=function _validateVertexCount(count,semantic){},_proto._changeVertexCount=function _changeVertexCount(count,semantic){this.vertexCount?this._validateVertexCount(count,semantic):this.vertexCount=count},GeometryData}();GeometryData.DEFAULT_COMPONENTS_POSITION=3,GeometryData.DEFAULT_COMPONENTS_NORMAL=3,GeometryData.DEFAULT_COMPONENTS_UV=2,GeometryData.DEFAULT_COMPONENTS_COLORS=4;var GeometryVertexStream=function GeometryVertexStream(data,componentCount,dataType,dataTypeNormalize){this.data=data,this.componentCount=componentCount,this.dataType=dataType,this.dataTypeNormalize=dataTypeNormalize},Mesh=function(_RefCountedObject){function Mesh(graphicsDevice){var _this;return(_this=_RefCountedObject.call(this)||this).id=id++,_this.device=graphicsDevice||getApplication().graphicsDevice,_this.vertexBuffer=null,_this.indexBuffer=[null],_this.primitive=[{type:0,base:0,count:0}],_this.skin=null,_this.morph=null,_this._geometryData=null,_this._aabb=new BoundingBox,_this.boneAabb=null,_this}_inheritsLoose(Mesh,_RefCountedObject);var _proto2=Mesh.prototype;return _proto2.destroy=function destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);for(var j=0;j<this.indexBuffer.length;j++)this._destroyIndexBuffer(j);this.indexBuffer.length=0,this._geometryData=null},_proto2._destroyIndexBuffer=function _destroyIndexBuffer(index){this.indexBuffer[index]&&(this.indexBuffer[index].destroy(),this.indexBuffer[index]=null)},_proto2._initBoneAabbs=function _initBoneAabbs(morphTargets){this.boneAabb=[],this.boneUsed=[];var numVerts=this.vertexBuffer.numVertices,i,j,k,l,x,y,z,bMax,bMin,boneMin=[],boneMax=[],boneUsed=this.boneUsed,numBones=this.skin.boneNames.length,aabb,boneWeight,boneIndex,minMorphX,minMorphY,minMorphZ,maxMorphX,maxMorphY,maxMorphZ,dx,dy,dz,target;for(i=0;i<numBones;i++)boneMin[i]=new Vec3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),boneMax[i]=new Vec3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);var iterator=new VertexIterator(this.vertexBuffer),posElement=iterator.element.POSITION,weightsElement=iterator.element.BLENDWEIGHT,indicesElement=iterator.element.BLENDINDICES;for(j=0;j<numVerts;j++){for(k=0;k<4;k++)if((boneWeight=weightsElement.array[weightsElement.index+k])>0&&(boneUsed[boneIndex=indicesElement.array[indicesElement.index+k]]=!0,x=posElement.array[posElement.index],y=posElement.array[posElement.index+1],z=posElement.array[posElement.index+2],bMax=boneMax[boneIndex],(bMin=boneMin[boneIndex]).x>x&&(bMin.x=x),bMin.y>y&&(bMin.y=y),bMin.z>z&&(bMin.z=z),bMax.x<x&&(bMax.x=x),bMax.y<y&&(bMax.y=y),bMax.z<z&&(bMax.z=z),morphTargets)){for(minMorphX=maxMorphX=x,minMorphY=maxMorphY=y,minMorphZ=maxMorphZ=z,l=0;l<morphTargets.length;l++)(dx=(target=morphTargets[l]).deltaPositions[3*j])<0?minMorphX+=dx:maxMorphX+=dx,(dy=target.deltaPositions[3*j+1])<0?minMorphY+=dy:maxMorphY+=dy,(dz=target.deltaPositions[3*j+2])<0?minMorphZ+=dz:maxMorphZ+=dz;bMin.x>minMorphX&&(bMin.x=minMorphX),bMin.y>minMorphY&&(bMin.y=minMorphY),bMin.z>minMorphZ&&(bMin.z=minMorphZ),bMax.x<maxMorphX&&(bMax.x=maxMorphX),bMax.y<maxMorphY&&(bMax.y=maxMorphY),bMax.z<maxMorphZ&&(bMax.z=maxMorphZ)}iterator.next()}for(i=0;i<numBones;i++)(aabb=new BoundingBox).setMinMax(boneMin[i],boneMax[i]),this.boneAabb.push(aabb)},_proto2._initGeometryData=function _initGeometryData(){this._geometryData||(this._geometryData=new GeometryData,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=this.vertexBuffer.numVertices),this.indexBuffer.length>0&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices))},_proto2.clear=function clear(verticesDynamic,indicesDynamic,maxVertices,maxIndices){void 0===maxVertices&&(maxVertices=0),void 0===maxIndices&&(maxIndices=0),this._initGeometryData(),this._geometryData.initDefaults(),this._geometryData.recreate=!0,this._geometryData.maxVertices=maxVertices,this._geometryData.maxIndices=maxIndices,this._geometryData.verticesUsage=verticesDynamic?0:1,this._geometryData.indicesUsage=indicesDynamic?0:1},_proto2.setVertexStream=function setVertexStream(semantic,data,componentCount,numVertices,dataType,dataTypeNormalize){void 0===dataType&&(dataType=6),void 0===dataTypeNormalize&&(dataTypeNormalize=!1),this._initGeometryData();var vertexCount=numVertices||data.length/componentCount;this._geometryData._changeVertexCount(vertexCount,semantic),this._geometryData.vertexStreamsUpdated=!0,this._geometryData.vertexStreamDictionary[semantic]=new GeometryVertexStream(data,componentCount,dataType,dataTypeNormalize)},_proto2.getVertexStream=function getVertexStream(semantic,data){var count=0,done=!1,iterator;if(this._geometryData){var stream=this._geometryData.vertexStreamDictionary[semantic];stream&&(done=!0,count=this._geometryData.vertexCount,ArrayBuffer.isView(data)?data.set(stream.data):(data.length=0,data.push(stream.data)))}done||this.vertexBuffer&&(count=new VertexIterator(this.vertexBuffer).readData(semantic,data));return count},_proto2.setPositions=function setPositions(positions,componentCount,numVertices){void 0===componentCount&&(componentCount=GeometryData.DEFAULT_COMPONENTS_POSITION),this.setVertexStream("POSITION",positions,componentCount,numVertices,6,!1)},_proto2.setNormals=function setNormals(normals,componentCount,numVertices){void 0===componentCount&&(componentCount=GeometryData.DEFAULT_COMPONENTS_NORMAL),this.setVertexStream("NORMAL",normals,componentCount,numVertices,6,!1)},_proto2.setUvs=function setUvs(channel,uvs,componentCount,numVertices){void 0===componentCount&&(componentCount=GeometryData.DEFAULT_COMPONENTS_UV),this.setVertexStream("TEXCOORD"+channel,uvs,componentCount,numVertices,6,!1)},_proto2.setColors=function setColors(colors,componentCount,numVertices){void 0===componentCount&&(componentCount=GeometryData.DEFAULT_COMPONENTS_COLORS),this.setVertexStream("COLOR",colors,componentCount,numVertices,6,!1)},_proto2.setColors32=function setColors32(colors,numVertices){this.setVertexStream("COLOR",colors,GeometryData.DEFAULT_COMPONENTS_COLORS,numVertices,1,!0)},_proto2.setIndices=function setIndices(indices,numIndices){this._initGeometryData(),this._geometryData.indexStreamUpdated=!0,this._geometryData.indices=indices,this._geometryData.indexCount=numIndices||indices.length},_proto2.getPositions=function getPositions(positions){return this.getVertexStream("POSITION",positions)},_proto2.getNormals=function getNormals(normals){return this.getVertexStream("NORMAL",normals)},_proto2.getUvs=function getUvs(channel,uvs){return this.getVertexStream("TEXCOORD"+channel,uvs)},_proto2.getColors=function getColors(colors){return this.getVertexStream("COLOR",colors)},_proto2.getIndices=function getIndices(indices){var count=0;if(this._geometryData&&this._geometryData.indices){var streamIndices=this._geometryData.indices;count=this._geometryData.indexCount,ArrayBuffer.isView(indices)?indices.set(streamIndices):(indices.length=0,indices.push(streamIndices))}else{var indexBuffer;if(this.indexBuffer.length>0&&this.indexBuffer[0])count=this.indexBuffer[0].readData(indices)}return count},_proto2.update=function update(primitiveType,updateBoundingBox){if(void 0===primitiveType&&(primitiveType=4),void 0===updateBoundingBox&&(updateBoundingBox=!0),this._geometryData){if(updateBoundingBox){var stream=this._geometryData.vertexStreamDictionary.POSITION;stream&&3===stream.componentCount&&this._aabb.compute(stream.data,this._geometryData.vertexCount)}var destroyVB=this._geometryData.recreate;this._geometryData.vertexCount>this._geometryData.maxVertices&&(destroyVB=!0,this._geometryData.maxVertices=this._geometryData.vertexCount),destroyVB&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);var destroyIB=this._geometryData.recreate;this._geometryData.indexCount>this._geometryData.maxIndices&&(destroyIB=!0,this._geometryData.maxIndices=this._geometryData.indexCount),destroyIB&&this.indexBuffer.length>0&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&this._updateIndexBuffer(),this.primitive[0].type=primitiveType,this.indexBuffer.length>0&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=!0):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=!1),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=!1,this._geometryData.indexStreamUpdated=!1,this._geometryData.recreate=!1,this.updateRenderStates()}},_proto2._buildVertexFormat=function _buildVertexFormat(vertexCount){var vertexDesc=[];for(var semantic in this._geometryData.vertexStreamDictionary){var stream=this._geometryData.vertexStreamDictionary[semantic];vertexDesc.push({semantic:semantic,components:stream.componentCount,type:stream.dataType,normalize:stream.dataTypeNormalize})}return new VertexFormat(this.device,vertexDesc,vertexCount)},_proto2._updateVertexBuffer=function _updateVertexBuffer(){if(!this.vertexBuffer){var allocateVertexCount=this._geometryData.maxVertices,format=this._buildVertexFormat(allocateVertexCount);this.vertexBuffer=new VertexBuffer(this.device,format,allocateVertexCount,this._geometryData.verticesUsage)}var iterator=new VertexIterator(this.vertexBuffer),numVertices=this._geometryData.vertexCount;for(var semantic in this._geometryData.vertexStreamDictionary){var stream=this._geometryData.vertexStreamDictionary[semantic];iterator.writeData(semantic,stream.data,numVertices),delete this._geometryData.vertexStreamDictionary[semantic]}iterator.end()},_proto2._updateIndexBuffer=function _updateIndexBuffer(){if(this.indexBuffer.length<=0||!this.indexBuffer[0]){var createFormat=this._geometryData.maxVertices>65535?2:1;this.indexBuffer[0]=new IndexBuffer(this.device,createFormat,this._geometryData.maxIndices,this._geometryData.indicesUsage)}var srcIndices=this._geometryData.indices,indexBuffer;srcIndices&&(this.indexBuffer[0].writeData(srcIndices,this._geometryData.indexCount),this._geometryData.indices=null)},_proto2.prepareRenderState=function prepareRenderState(renderStyle){1===renderStyle?this.generateWireframe():2===renderStyle&&(this.primitive[2]={type:0,base:0,count:this.vertexBuffer?this.vertexBuffer.numVertices:0,indexed:!1})},_proto2.updateRenderStates=function updateRenderStates(){this.primitive[2]&&this.prepareRenderState(2),this.primitive[1]&&this.prepareRenderState(1)},_proto2.generateWireframe=function generateWireframe(){this._destroyIndexBuffer(1);var lines=[],format;if(this.indexBuffer.length>0&&this.indexBuffer[0]){for(var offsets=[[0,1],[1,2],[2,0]],base=this.primitive[0].base,count=this.primitive[0].count,indexBuffer=this.indexBuffer[0],srcIndices=new typedArrayIndexFormats[indexBuffer.format](indexBuffer.storage),uniqueLineIndices={},j=base;j<base+count;j+=3)for(var k=0;k<3;k++){var i1=srcIndices[j+offsets[k][0]],i2=srcIndices[j+offsets[k][1]],line=i1>i2?i2<<16|i1:i1<<16|i2;void 0===uniqueLineIndices[line]&&(uniqueLineIndices[line]=0,lines.push(i1,i2))}format=indexBuffer.format}else{for(var i=0;i<this.vertexBuffer.numVertices;i+=3)lines.push(i,i+1,i+1,i+2,i+2,i);format=lines.length>65535?2:1}var wireBuffer=new IndexBuffer(this.vertexBuffer.device,format,lines.length),dstIndices;new typedArrayIndexFormats[wireBuffer.format](wireBuffer.storage).set(lines),wireBuffer.unlock(),this.primitive[1]={type:1,base:0,count:lines.length,indexed:!0},this.indexBuffer[1]=wireBuffer},_createClass(Mesh,[{key:"aabb",get:function get(){return this._aabb},set:function set(aabb){this._aabb=aabb}}]),Mesh}(RefCountedObject),primitiveUv1Padding=4/64,primitiveUv1PaddingScale=.875,shapePrimitives=[];function calculateNormals(positions,indices){var triangleCount=indices.length/3,vertexCount=positions.length/3,i1,i2,i3,i,p1=new Vec3,p2=new Vec3,p3=new Vec3,p1p2=new Vec3,p1p3=new Vec3,faceNormal=new Vec3,normals=[];for(i=0;i<positions.length;i++)normals[i]=0;for(i=0;i<triangleCount;i++)i1=indices[3*i],i2=indices[3*i+1],i3=indices[3*i+2],p1.set(positions[3*i1],positions[3*i1+1],positions[3*i1+2]),p2.set(positions[3*i2],positions[3*i2+1],positions[3*i2+2]),p3.set(positions[3*i3],positions[3*i3+1],positions[3*i3+2]),p1p2.sub2(p2,p1),p1p3.sub2(p3,p1),faceNormal.cross(p1p2,p1p3).normalize(),normals[3*i1]+=faceNormal.x,normals[3*i1+1]+=faceNormal.y,normals[3*i1+2]+=faceNormal.z,normals[3*i2]+=faceNormal.x,normals[3*i2+1]+=faceNormal.y,normals[3*i2+2]+=faceNormal.z,normals[3*i3]+=faceNormal.x,normals[3*i3+1]+=faceNormal.y,normals[3*i3+2]+=faceNormal.z;for(i=0;i<vertexCount;i++){var nx=normals[3*i],ny=normals[3*i+1],nz=normals[3*i+2],invLen=1/Math.sqrt(nx*nx+ny*ny+nz*nz);normals[3*i]*=invLen,normals[3*i+1]*=invLen,normals[3*i+2]*=invLen}return normals}function calculateTangents(positions,normals,uvs,indices){var triangleCount=indices.length/3,vertexCount=positions.length/3,i1,i2,i3,x1,x2,y1,y2,z1,z2,s1,s2,t1,t2,r,sdir=new Vec3,tdir=new Vec3,v1=new Vec3,v2=new Vec3,v3=new Vec3,w1=new Vec2,w2=new Vec2,w3=new Vec2,i,tan1=new Float32Array(3*vertexCount),tan2=new Float32Array(3*vertexCount),tangents=[],area=0;for(i=0;i<triangleCount;i++)i1=indices[3*i],i2=indices[3*i+1],i3=indices[3*i+2],v1.set(positions[3*i1],positions[3*i1+1],positions[3*i1+2]),v2.set(positions[3*i2],positions[3*i2+1],positions[3*i2+2]),v3.set(positions[3*i3],positions[3*i3+1],positions[3*i3+2]),w1.set(uvs[2*i1],uvs[2*i1+1]),w2.set(uvs[2*i2],uvs[2*i2+1]),w3.set(uvs[2*i3],uvs[2*i3+1]),x1=v2.x-v1.x,x2=v3.x-v1.x,y1=v2.y-v1.y,y2=v3.y-v1.y,z1=v2.z-v1.z,z2=v3.z-v1.z,s1=w2.x-w1.x,s2=w3.x-w1.x,t1=w2.y-w1.y,0===(area=s1*(t2=w3.y-w1.y)-s2*t1)?(sdir.set(0,1,0),tdir.set(1,0,0)):(r=1/area,sdir.set((t2*x1-t1*x2)*r,(t2*y1-t1*y2)*r,(t2*z1-t1*z2)*r),tdir.set((s1*x2-s2*x1)*r,(s1*y2-s2*y1)*r,(s1*z2-s2*z1)*r)),tan1[3*i1+0]+=sdir.x,tan1[3*i1+1]+=sdir.y,tan1[3*i1+2]+=sdir.z,tan1[3*i2+0]+=sdir.x,tan1[3*i2+1]+=sdir.y,tan1[3*i2+2]+=sdir.z,tan1[3*i3+0]+=sdir.x,tan1[3*i3+1]+=sdir.y,tan1[3*i3+2]+=sdir.z,tan2[3*i1+0]+=tdir.x,tan2[3*i1+1]+=tdir.y,tan2[3*i1+2]+=tdir.z,tan2[3*i2+0]+=tdir.x,tan2[3*i2+1]+=tdir.y,tan2[3*i2+2]+=tdir.z,tan2[3*i3+0]+=tdir.x,tan2[3*i3+1]+=tdir.y,tan2[3*i3+2]+=tdir.z;t1=new Vec3,t2=new Vec3;var n=new Vec3,temp=new Vec3;for(i=0;i<vertexCount;i++){n.set(normals[3*i],normals[3*i+1],normals[3*i+2]),t1.set(tan1[3*i],tan1[3*i+1],tan1[3*i+2]),t2.set(tan2[3*i],tan2[3*i+1],tan2[3*i+2]);var ndott=n.dot(t1);temp.copy(n).mulScalar(ndott),temp.sub2(t1,temp).normalize(),tangents[4*i]=temp.x,tangents[4*i+1]=temp.y,tangents[4*i+2]=temp.z,temp.cross(n,t1),tangents[4*i+3]=temp.dot(t2)<0?-1:1}return tangents}function createMesh$1(device,positions,opts){var mesh=new Mesh(device);return mesh.setPositions(positions),opts&&(opts.normals&&mesh.setNormals(opts.normals),opts.tangents&&mesh.setVertexStream("TANGENT",opts.tangents,4),opts.colors&&mesh.setColors32(opts.colors),opts.uvs&&mesh.setUvs(0,opts.uvs),opts.uvs1&&mesh.setUvs(1,opts.uvs1),opts.blendIndices&&mesh.setVertexStream("BLENDINDICES",opts.blendIndices,4,1),opts.blendWeights&&mesh.setVertexStream("BLENDWEIGHT",opts.blendWeights,4),opts.indices&&mesh.setIndices(opts.indices)),mesh.update(),mesh}function createTorus(device,opts){var rc=opts&&void 0!==opts.tubeRadius?opts.tubeRadius:.2,rt=opts&&void 0!==opts.ringRadius?opts.ringRadius:.3,segments=opts&&void 0!==opts.segments?opts.segments:30,sides=opts&&void 0!==opts.sides?opts.sides:20,calculateTangents=!(!opts||void 0===opts.calculateTangents)&&opts.calculateTangents,i,j,x,y,z,nx,ny,nz,u,v,positions=[],normals=[],uvs=[],indices=[];for(i=0;i<=sides;i++)for(j=0;j<=segments;j++){var first,second,third,fourth;if(x=Math.cos(2*Math.PI*j/segments)*(rt+rc*Math.cos(2*Math.PI*i/sides)),y=Math.sin(2*Math.PI*i/sides)*rc,z=Math.sin(2*Math.PI*j/segments)*(rt+rc*Math.cos(2*Math.PI*i/sides)),nx=Math.cos(2*Math.PI*j/segments)*Math.cos(2*Math.PI*i/sides),ny=Math.sin(2*Math.PI*i/sides),nz=Math.sin(2*Math.PI*j/segments)*Math.cos(2*Math.PI*i/sides),u=i/sides,v=1-j/segments,positions.push(x,y,z),normals.push(nx,ny,nz),uvs.push(u,v),i<sides&&j<segments)first=i*(segments+1)+j,second=(i+1)*(segments+1)+j,third=i*(segments+1)+(j+1),fourth=(i+1)*(segments+1)+(j+1),indices.push(first,second,third),indices.push(second,fourth,third)}var options={normals:normals,uvs:uvs,indices:indices};return calculateTangents&&(options.tangents=calculateTangents(positions,normals,uvs,indices)),createMesh$1(device,positions,options)}function _createConeData(baseRadius,peakRadius,height,heightSegments,capSegments,roundedCaps){var i,j,x,y,z,u,v,pos=new Vec3,bottomToTop=new Vec3,norm=new Vec3,top,bottom,tangent,positions=[],normals=[],uvs=[],uvs1=[],indices=[],theta,cosTheta,sinTheta,phi,sinPhi,cosPhi,first,second,third,fourth,offset;if(height>0)for(i=0;i<=heightSegments;i++)for(j=0;j<=capSegments;j++){theta=j/capSegments*2*Math.PI-Math.PI,sinTheta=Math.sin(theta),cosTheta=Math.cos(theta),bottom=new Vec3(sinTheta*baseRadius,-height/2,cosTheta*baseRadius),top=new Vec3(sinTheta*peakRadius,height/2,cosTheta*peakRadius),pos.lerp(bottom,top,i/heightSegments),bottomToTop.sub2(top,bottom).normalize(),tangent=new Vec3(cosTheta,0,-sinTheta),norm.cross(tangent,bottomToTop).normalize(),positions.push(pos.x,pos.y,pos.z),normals.push(norm.x,norm.y,norm.z),u=j/capSegments,v=i/heightSegments,uvs.push(u,v);var _v=v;v=u,u=_v,u=.875*(u/=3)+4/64,v=.875*v+4/64,uvs1.push(u,v),i<heightSegments&&j<capSegments&&(first=i*(capSegments+1)+j,second=i*(capSegments+1)+(j+1),third=(i+1)*(capSegments+1)+j,fourth=(i+1)*(capSegments+1)+(j+1),indices.push(first,second,third),indices.push(second,fourth,third))}if(roundedCaps){var lat,lon,latitudeBands=Math.floor(capSegments/2),longitudeBands=capSegments,capOffset=height/2;for(lat=0;lat<=latitudeBands;lat++)for(theta=lat*Math.PI*.5/latitudeBands,sinTheta=Math.sin(theta),cosTheta=Math.cos(theta),lon=0;lon<=longitudeBands;lon++)phi=2*lon*Math.PI/longitudeBands-Math.PI/2,sinPhi=Math.sin(phi),x=(cosPhi=Math.cos(phi))*sinTheta,y=cosTheta,z=sinPhi*sinTheta,u=1-lon/longitudeBands,v=1-lat/latitudeBands,positions.push(x*peakRadius,y*peakRadius+capOffset,z*peakRadius),normals.push(x,y,z),uvs.push(u,v),u=.875*(u/=3)+4/64,v=.875*(v/=3)+4/64,u+=1/3,uvs1.push(u,v);for(offset=(heightSegments+1)*(capSegments+1),lat=0;lat<latitudeBands;++lat)for(lon=0;lon<longitudeBands;++lon)second=(first=lat*(longitudeBands+1)+lon)+longitudeBands+1,indices.push(offset+first+1,offset+second,offset+first),indices.push(offset+first+1,offset+second+1,offset+second);for(lat=0;lat<=latitudeBands;lat++)for(theta=.5*Math.PI+lat*Math.PI*.5/latitudeBands,sinTheta=Math.sin(theta),cosTheta=Math.cos(theta),lon=0;lon<=longitudeBands;lon++)phi=2*lon*Math.PI/longitudeBands-Math.PI/2,sinPhi=Math.sin(phi),x=(cosPhi=Math.cos(phi))*sinTheta,y=cosTheta,z=sinPhi*sinTheta,u=1-lon/longitudeBands,v=1-lat/latitudeBands,positions.push(x*peakRadius,y*peakRadius-capOffset,z*peakRadius),normals.push(x,y,z),uvs.push(u,v),u=.875*(u/=3)+4/64,v=.875*(v/=3)+4/64,u+=2/3,uvs1.push(u,v);for(offset=(heightSegments+1)*(capSegments+1)+(longitudeBands+1)*(latitudeBands+1),lat=0;lat<latitudeBands;++lat)for(lon=0;lon<longitudeBands;++lon)second=(first=lat*(longitudeBands+1)+lon)+longitudeBands+1,indices.push(offset+first+1,offset+second,offset+first),indices.push(offset+first+1,offset+second+1,offset+second)}else{if(offset=(heightSegments+1)*(capSegments+1),baseRadius>0)for(i=0;i<capSegments;i++)theta=i/capSegments*2*Math.PI,y=-height/2,u=1-((x=Math.sin(theta))+1)/2,v=((z=Math.cos(theta))+1)/2,positions.push(x*baseRadius,y,z*baseRadius),normals.push(0,-1,0),uvs.push(u,v),u=.875*(u/=3)+4/64,v=.875*(v/=3)+4/64,u+=1/3,uvs1.push(u,v),i>1&&indices.push(offset,offset+i,offset+i-1);if(offset+=capSegments,peakRadius>0)for(i=0;i<capSegments;i++)theta=i/capSegments*2*Math.PI,y=height/2,u=1-((x=Math.sin(theta))+1)/2,v=((z=Math.cos(theta))+1)/2,positions.push(x*peakRadius,y,z*peakRadius),normals.push(0,1,0),uvs.push(u,v),u=.875*(u/=3)+4/64,v=.875*(v/=3)+4/64,u+=2/3,uvs1.push(u,v),i>1&&indices.push(offset,offset+i-1,offset+i)}return{positions:positions,normals:normals,uvs:uvs,uvs1:uvs1,indices:indices}}function createCylinder(device,opts){var radius=opts&&(opts.radius||opts.baseRadius);radius=void 0!==radius?radius:.5;var height=opts&&void 0!==opts.height?opts.height:1,heightSegments=opts&&void 0!==opts.heightSegments?opts.heightSegments:5,capSegments=opts&&void 0!==opts.capSegments?opts.capSegments:20,calculateTangents=!(!opts||void 0===opts.calculateTangents)&&opts.calculateTangents,options=_createConeData(radius,radius,height,heightSegments,capSegments,!1);return calculateTangents&&(options.tangents=calculateTangents(options.positions,options.normals,options.uvs,options.indices)),createMesh$1(device,options.positions,options)}function createCapsule(device,opts){var radius=opts&&void 0!==opts.radius?opts.radius:.3,height=opts&&void 0!==opts.height?opts.height:1,heightSegments=opts&&void 0!==opts.heightSegments?opts.heightSegments:1,sides=opts&&void 0!==opts.sides?opts.sides:20,calculateTangents=!(!opts||void 0===opts.calculateTangents)&&opts.calculateTangents,options=_createConeData(radius,radius,height-2*radius,heightSegments,sides,!0);return calculateTangents&&(options.tangents=calculateTangents(options.positions,options.normals,options.uvs,options.indices)),createMesh$1(device,options.positions,options)}function createCone(device,opts){var baseRadius=opts&&void 0!==opts.baseRadius?opts.baseRadius:.5,peakRadius=opts&&void 0!==opts.peakRadius?opts.peakRadius:0,height=opts&&void 0!==opts.height?opts.height:1,heightSegments=opts&&void 0!==opts.heightSegments?opts.heightSegments:5,capSegments=opts&&void 0!==opts.capSegments?opts.capSegments:18,calculateTangents=!(!opts||void 0===opts.calculateTangents)&&opts.calculateTangents,options=_createConeData(baseRadius,peakRadius,height,heightSegments,capSegments,!1);return calculateTangents&&(options.tangents=calculateTangents(options.positions,options.normals,options.uvs,options.indices)),createMesh$1(device,options.positions,options)}function createSphere(device,opts){var radius=opts&&void 0!==opts.radius?opts.radius:.5,latitudeBands=opts&&void 0!==opts.latitudeBands?opts.latitudeBands:16,longitudeBands=opts&&void 0!==opts.longitudeBands?opts.longitudeBands:16,calculateTangents=!(!opts||void 0===opts.calculateTangents)&&opts.calculateTangents,lon,lat,theta,sinTheta,cosTheta,phi,sinPhi,cosPhi,first,second,x,y,z,u,v,positions=[],normals=[],uvs=[],indices=[];for(lat=0;lat<=latitudeBands;lat++)for(theta=lat*Math.PI/latitudeBands,sinTheta=Math.sin(theta),cosTheta=Math.cos(theta),lon=0;lon<=longitudeBands;lon++)phi=2*lon*Math.PI/longitudeBands-Math.PI/2,sinPhi=Math.sin(phi),x=(cosPhi=Math.cos(phi))*sinTheta,y=cosTheta,z=sinPhi*sinTheta,u=1-lon/longitudeBands,v=1-lat/latitudeBands,positions.push(x*radius,y*radius,z*radius),normals.push(x,y,z),uvs.push(u,v);for(lat=0;lat<latitudeBands;++lat)for(lon=0;lon<longitudeBands;++lon)second=(first=lat*(longitudeBands+1)+lon)+longitudeBands+1,indices.push(first+1,second,first),indices.push(first+1,second+1,second);var options={normals:normals,uvs:uvs,uvs1:uvs,indices:indices};return calculateTangents&&(options.tangents=calculateTangents(positions,normals,uvs,indices)),createMesh$1(device,positions,options)}function createPlane(device,opts){var he=opts&&void 0!==opts.halfExtents?opts.halfExtents:new Vec2(.5,.5),ws=opts&&void 0!==opts.widthSegments?opts.widthSegments:5,ls=opts&&void 0!==opts.lengthSegments?opts.lengthSegments:5,calculateTangents=!(!opts||void 0===opts.calculateTangents)&&opts.calculateTangents,i,j,x,y,z,u,v,positions=[],normals=[],uvs=[],indices=[],vcounter=0;for(i=0;i<=ws;i++)for(j=0;j<=ls;j++)x=-he.x+2*he.x*i/ws,y=0,z=-(-he.y+2*he.y*j/ls),u=i/ws,v=j/ls,positions.push(x,0,z),normals.push(0,1,0),uvs.push(u,v),i<ws&&j<ls&&(indices.push(vcounter+ls+1,vcounter+1,vcounter),indices.push(vcounter+ls+1,vcounter+ls+2,vcounter+1)),vcounter++;var options={normals:normals,uvs:uvs,uvs1:uvs,indices:indices};return calculateTangents&&(options.tangents=calculateTangents(positions,normals,uvs,indices)),createMesh$1(device,positions,options)}function createBox(device,opts){var he=opts&&void 0!==opts.halfExtents?opts.halfExtents:new Vec3(.5,.5,.5),ws=opts&&void 0!==opts.widthSegments?opts.widthSegments:1,ls=opts&&void 0!==opts.lengthSegments?opts.lengthSegments:1,hs=opts&&void 0!==opts.heightSegments?opts.heightSegments:1,calculateTangents=!(!opts||void 0===opts.calculateTangents)&&opts.calculateTangents,corners=[new Vec3(-he.x,-he.y,he.z),new Vec3(he.x,-he.y,he.z),new Vec3(he.x,he.y,he.z),new Vec3(-he.x,he.y,he.z),new Vec3(he.x,-he.y,-he.z),new Vec3(-he.x,-he.y,-he.z),new Vec3(-he.x,he.y,-he.z),new Vec3(he.x,he.y,-he.z)],faceAxes=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],faceNormals=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],sides_FRONT,sides_BACK=1,sides_TOP=2,sides_BOTTOM=3,sides_RIGHT=4,sides_LEFT=5,positions=[],normals=[],uvs=[],uvs1=[],indices=[],vcounter=0,generateFace=function generateFace(side,uSegments,vSegments){var u,v,i,j;for(i=0;i<=uSegments;i++)for(j=0;j<=vSegments;j++){var temp1=new Vec3,temp2=new Vec3,temp3=new Vec3,r=new Vec3;temp1.lerp(corners[faceAxes[side][0]],corners[faceAxes[side][1]],i/uSegments),temp2.lerp(corners[faceAxes[side][0]],corners[faceAxes[side][2]],j/vSegments),temp3.sub2(temp2,corners[faceAxes[side][0]]),r.add2(temp1,temp3),u=i/uSegments,v=j/vSegments,positions.push(r.x,r.y,r.z),normals.push(faceNormals[side][0],faceNormals[side][1],faceNormals[side][2]),uvs.push(u,v),u=.875*(u/=3)+4/64,v=.875*(v/=3)+4/64,u+=side%3/3,v+=Math.floor(side/3)/3,uvs1.push(u,v),i<uSegments&&j<vSegments&&(indices.push(vcounter+vSegments+1,vcounter+1,vcounter),indices.push(vcounter+vSegments+1,vcounter+vSegments+2,vcounter+1)),vcounter++}};generateFace(0,ws,hs),generateFace(sides_BACK,ws,hs),generateFace(sides_TOP,ws,ls),generateFace(sides_BOTTOM,ws,ls),generateFace(sides_RIGHT,ls,hs),generateFace(sides_LEFT,ls,hs);var options={normals:normals,uvs:uvs,uvs1:uvs1,indices:indices};return calculateTangents&&(options.tangents=calculateTangents(positions,normals,uvs,indices)),createMesh$1(device,positions,options)}function getShapePrimitive(device,type){for(var primData=null,i=0;i<shapePrimitives.length;i++)shapePrimitives[i].type===type&&shapePrimitives[i].device===device&&(primData=shapePrimitives[i].primData);if(!primData){var mesh,area;switch(type){case"box":mesh=createBox(device,{halfExtents:new Vec3(.5,.5,.5)}),area={x:2,y:2,z:2,uv:2/3};break;case"capsule":mesh=createCapsule(device,{radius:.5,height:2}),area={x:2*Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+1/3/3*2};break;case"cone":mesh=createCone(device,{baseRadius:.5,peakRadius:0,height:1}),area={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case"cylinder":mesh=createCylinder(device,{radius:.5,height:1}),area={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+1/3/3*2};break;case"plane":mesh=createPlane(device,{halfExtents:new Vec2(.5,.5),widthSegments:1,lengthSegments:1}),area={x:0,y:1,z:0,uv:1};break;case"sphere":mesh=createSphere(device,{radius:.5}),area={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;default:throw new Error("Invalid primitive type: "+type)}primData={mesh:mesh,area:area},shapePrimitives.push({type:type,device:device,primData:primData})}return primData}var BasicMaterial=function(_Material){function BasicMaterial(){var _this;return(_this=_Material.call(this)||this).color=new Color(1,1,1,1),_this.colorUniform=new Float32Array(4),_this.colorMap=null,_this.vertexColors=!1,_this}_inheritsLoose(BasicMaterial,_Material);var _proto=BasicMaterial.prototype;return _proto.clone=function clone(){var clone=new BasicMaterial;return Material.prototype._cloneInternal.call(this,clone),clone.color.copy(this.color),clone.colorMap=this.colorMap,clone.vertexColors=this.vertexColors,clone},_proto.updateUniforms=function updateUniforms(){this.clearParameters(),this.colorUniform[0]=this.color.r,this.colorUniform[1]=this.color.g,this.colorUniform[2]=this.color.b,this.colorUniform[3]=this.color.a,this.setParameter("uColor",this.colorUniform),this.colorMap&&this.setParameter("texture_diffuseMap",this.colorMap)},_proto.updateShader=function updateShader(device,scene,objDefs,staticLightList,pass,sortedLights){var options={skin:!!this.meshInstances[0].skinInstance,vertexColors:this.vertexColors,diffuseMap:!!this.colorMap,pass:pass},library=device.getProgramLibrary();this.shader=library.getProgram("basic",options)},BasicMaterial}(Material),Batch=function Batch(meshInstances,dynamic,batchGroupId){this.origMeshInstances=meshInstances,this._aabb=new BoundingBox,this.meshInstance=null,this.model=null,this.dynamic=dynamic,this.batchGroupId=batchGroupId},BatchGroup=function BatchGroup(id,name,dynamic,maxAabbSize,layers){void 0===layers&&(layers=[0]),this.dynamic=dynamic,this.maxAabbSize=maxAabbSize,this.id=id,this.name=name,this.layers=layers,this._ui=!1,this._sprite=!1,this._obj={model:[],element:[],sprite:[],render:[]}};BatchGroup.MODEL="model",BatchGroup.ELEMENT="element",BatchGroup.SPRITE="sprite",BatchGroup.RENDER="render";var _invMatrix=new Mat4,SkinInstance=function(){function SkinInstance(skin){this._dirty=!0,this._rootBone=null,this._skinUpdateIndex=-1,this._updateBeforeCull=!0,skin&&this.initSkin(skin)}var _proto=SkinInstance.prototype;return _proto.init=function init(device,numBones){if(device.supportsBoneTextures){var numPixels=3*numBones,width=Math.ceil(Math.sqrt(numPixels));width=math.roundUp(width,3);var height=Math.ceil(numPixels/width);this.boneTexture=new Texture(device,{width:width,height:height,format:14,mipmaps:!1,minFilter:0,magFilter:0}),this.boneTexture.name="skin",this.matrixPalette=this.boneTexture.lock()}else this.matrixPalette=new Float32Array(12*numBones)},_proto.destroy=function destroy(){this.boneTexture&&(this.boneTexture.destroy(),this.boneTexture=null)},_proto.initSkin=function initSkin(skin){this.skin=skin,this.bones=[];var numBones=skin.inverseBindPose.length;this.init(skin.device,numBones),this.matrices=[];for(var i=0;i<numBones;i++)this.matrices[i]=new Mat4},_proto.uploadBones=function uploadBones(device){device.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())},_proto._updateMatrices=function _updateMatrices(rootNode,skinUpdateIndex){if(this._skinUpdateIndex!==skinUpdateIndex){this._skinUpdateIndex=skinUpdateIndex,_invMatrix.copy(rootNode.getWorldTransform()).invert();for(var i=this.bones.length-1;i>=0;i--)this.matrices[i].mulAffine2(_invMatrix,this.bones[i].getWorldTransform()),this.matrices[i].mulAffine2(this.matrices[i],this.skin.inverseBindPose[i])}},_proto.updateMatrices=function updateMatrices(rootNode,skinUpdateIndex){this._updateBeforeCull&&this._updateMatrices(rootNode,skinUpdateIndex)},_proto.updateMatrixPalette=function updateMatrixPalette(rootNode,skinUpdateIndex){var pe;this._updateMatrices(rootNode,skinUpdateIndex);for(var mp=this.matrixPalette,base,count=this.bones.length,i=0;i<count;i++)pe=this.matrices[i].data,mp[base=12*i]=pe[0],mp[base+1]=pe[4],mp[base+2]=pe[8],mp[base+3]=pe[12],mp[base+4]=pe[1],mp[base+5]=pe[5],mp[base+6]=pe[9],mp[base+7]=pe[13],mp[base+8]=pe[2],mp[base+9]=pe[6],mp[base+10]=pe[10],mp[base+11]=pe[14];this.uploadBones(this.skin.device)},_createClass(SkinInstance,[{key:"rootBone",get:function get(){return this._rootBone},set:function set(rootBone){this._rootBone=rootBone}}]),SkinInstance}(),SkinBatchInstance=function(_SkinInstance){function SkinBatchInstance(device,nodes,rootNode){var _this;_this=_SkinInstance.call(this)||this;var numBones=nodes.length;return _this.init(device,numBones),_this.device=device,_this.rootNode=rootNode,_this.bones=nodes,_this}_inheritsLoose(SkinBatchInstance,_SkinInstance);var _proto=SkinBatchInstance.prototype;return _proto.updateMatrices=function updateMatrices(rootNode,skinUpdateIndex){},_proto.updateMatrixPalette=function updateMatrixPalette(rootNode,skinUpdateIndex){for(var pe,mp=this.matrixPalette,base,count=this.bones.length,i=0;i<count;i++)pe=this.bones[i].getWorldTransform().data,mp[base=12*i]=pe[0],mp[base+1]=pe[4],mp[base+2]=pe[8],mp[base+3]=pe[12],mp[base+4]=pe[1],mp[base+5]=pe[5],mp[base+6]=pe[9],mp[base+7]=pe[13],mp[base+8]=pe[2],mp[base+9]=pe[6],mp[base+10]=pe[10],mp[base+11]=pe[14];this.uploadBones(this.device)},SkinBatchInstance}(SkinInstance),RefCountedCache=function(){function RefCountedCache(){this.cache=new Map}var _proto=RefCountedCache.prototype;return _proto.incRef=function incRef(object){var refCount=(this.cache.get(object)||0)+1;this.cache.set(object,refCount)},_proto.decRef=function decRef(object){if(object){var refCount=this.cache.get(object);refCount&&(0===--refCount?(this.cache.delete(object),object.destroy()):this.cache.set(object,refCount))}},RefCountedCache}(),scaleCompensatePosTransform=new Mat4,scaleCompensatePos=new Vec3,scaleCompensateRot=new Quat,scaleCompensateRot2=new Quat,scaleCompensateScale=new Vec3,scaleCompensateScaleForParent=new Vec3,tmpMat4=new Mat4,tmpQuat=new Quat,position$1=new Vec3,invParentWtm$1=new Mat4,rotation=new Quat,invParentRot=new Quat,matrix=new Mat4,target=new Vec3,up=new Vec3,GraphNode=function(_EventHandler){function GraphNode(name){var _this;return(_this=_EventHandler.call(this)||this).name="string"==typeof name?name:"Untitled",_this.tags=new Tags(_assertThisInitialized(_this)),_this._labels={},_this.localPosition=new Vec3(0,0,0),_this.localRotation=new Quat(0,0,0,1),_this.localScale=new Vec3(1,1,1),_this.localEulerAngles=new Vec3(0,0,0),_this.position=new Vec3(0,0,0),_this.rotation=new Quat(0,0,0,1),_this.eulerAngles=new Vec3(0,0,0),_this._scale=null,_this.localTransform=new Mat4,_this._dirtyLocal=!1,_this._aabbVer=0,_this._frozen=!1,_this.worldTransform=new Mat4,_this._dirtyWorld=!1,_this.normalMatrix=new Mat3,_this._dirtyNormal=!0,_this._right=null,_this._up=null,_this._forward=null,_this._parent=null,_this._children=[],_this._graphDepth=0,_this._enabled=!0,_this._enabledInHierarchy=!1,_this.scaleCompensation=!1,_this}_inheritsLoose(GraphNode,_EventHandler);var _proto=GraphNode.prototype;return _proto._notifyHierarchyStateChanged=function _notifyHierarchyStateChanged(node,enabled){node._onHierarchyStateChanged(enabled);for(var c=node._children,i=0,len=c.length;i<len;i++)c[i]._enabled&&this._notifyHierarchyStateChanged(c[i],enabled)},_proto._onHierarchyStateChanged=function _onHierarchyStateChanged(enabled){this._enabledInHierarchy=enabled,enabled&&!this._frozen&&this._unfreezeParentToRoot()},_proto._cloneInternal=function _cloneInternal(clone){clone.name=this.name;var tags=this.tags._list;clone.tags.clear();for(var i=0;i<tags.length;i++)clone.tags.add(tags[i]);clone._labels=Object.assign({},this._labels),clone.localPosition.copy(this.localPosition),clone.localRotation.copy(this.localRotation),clone.localScale.copy(this.localScale),clone.localEulerAngles.copy(this.localEulerAngles),clone.position.copy(this.position),clone.rotation.copy(this.rotation),clone.eulerAngles.copy(this.eulerAngles),clone.localTransform.copy(this.localTransform),clone._dirtyLocal=this._dirtyLocal,clone.worldTransform.copy(this.worldTransform),clone._dirtyWorld=this._dirtyWorld,clone._dirtyNormal=this._dirtyNormal,clone._aabbVer=this._aabbVer+1,clone._enabled=this._enabled,clone.scaleCompensation=this.scaleCompensation,clone._enabledInHierarchy=!1},_proto.clone=function clone(){var clone=new GraphNode;return this._cloneInternal(clone),clone},_proto.copy=function copy(source){return source._cloneInternal(this),this},_proto.find=function find(attr,value){var result,results=[],len=this._children.length,i,descendants;if(attr instanceof Function){var fn=attr;for((result=fn(this))&&results.push(this),i=0;i<len;i++)(descendants=this._children[i].find(fn)).length&&(results=results.concat(descendants))}else{var testValue;for(this[attr]&&(testValue=this[attr]instanceof Function?this[attr]():this[attr])===value&&results.push(this),i=0;i<len;++i)(descendants=this._children[i].find(attr,value)).length&&(results=results.concat(descendants))}return results},_proto.findOne=function findOne(attr,value){var i,len=this._children.length,result=null;if(attr instanceof Function){var fn=attr;if(result=fn(this))return this;for(i=0;i<len;i++)if(result=this._children[i].findOne(fn))return result}else{var testValue;if(this[attr]&&(testValue=this[attr]instanceof Function?this[attr]():this[attr])===value)return this;for(i=0;i<len;i++)if(null!==(result=this._children[i].findOne(attr,value)))return result}return null},_proto.findByTag=function findByTag(){var tags=this.tags._processArguments(arguments);return this._findByTag(tags)},_proto._findByTag=function _findByTag(tags){var result=[],i,len=this._children.length,descendants;for(i=0;i<len;i++)this._children[i].tags._has(tags)&&result.push(this._children[i]),(descendants=this._children[i]._findByTag(tags)).length&&(result=result.concat(descendants));return result},_proto.findByName=function findByName(name){if(this.name===name)return this;for(var i=0;i<this._children.length;i++){var found=this._children[i].findByName(name);if(null!==found)return found}return null},_proto.findByPath=function findByPath(path){var parts;if(Array.isArray(path)){if(0===path.length)return null;parts=path}else parts=path.split("/");for(var currentParent=this,result=null,i=0,imax=parts.length;i<imax&&currentParent;i++){var part=parts[i];result=null;for(var children=currentParent._children,j=0,jmax=children.length;j<jmax;j++)if(children[j].name===part){result=children[j];break}currentParent=result}return result},_proto.forEach=function forEach(callback,thisArg){callback.call(thisArg,this);for(var children=this._children,i=0;i<children.length;i++)children[i].forEach(callback,thisArg)},_proto.isDescendantOf=function isDescendantOf(node){for(var parent=this._parent;parent;){if(parent===node)return!0;parent=parent._parent}return!1},_proto.isAncestorOf=function isAncestorOf(node){return node.isDescendantOf(this)},_proto.getEulerAngles=function getEulerAngles(){return this.getWorldTransform().getEulerAngles(this.eulerAngles),this.eulerAngles},_proto.getLocalEulerAngles=function getLocalEulerAngles(){return this.localRotation.getEulerAngles(this.localEulerAngles),this.localEulerAngles},_proto.getLocalPosition=function getLocalPosition(){return this.localPosition},_proto.getLocalRotation=function getLocalRotation(){return this.localRotation},_proto.getLocalScale=function getLocalScale(){return this.localScale},_proto.getLocalTransform=function getLocalTransform(){return this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this.localTransform},_proto.getPosition=function getPosition(){return this.getWorldTransform().getTranslation(this.position),this.position},_proto.getRotation=function getRotation(){return this.rotation.setFromMat4(this.getWorldTransform()),this.rotation},_proto.getScale=function getScale(){return this._scale||(this._scale=new Vec3),this.getWorldTransform().getScale(this._scale)},_proto.getWorldTransform=function getWorldTransform(){return this._dirtyLocal||this._dirtyWorld?(this._parent&&this._parent.getWorldTransform(),this._sync(),this.worldTransform):this.worldTransform},_proto.reparent=function reparent(parent,index){var current=this._parent;current&&current.removeChild(this),parent&&(index>=0?parent.insertChild(this,index):parent.addChild(this))},_proto.setLocalEulerAngles=function setLocalEulerAngles(x,y,z){x instanceof Vec3?this.localRotation.setFromEulerAngles(x.x,x.y,x.z):this.localRotation.setFromEulerAngles(x,y,z),this._dirtyLocal||this._dirtifyLocal()},_proto.setLocalPosition=function setLocalPosition(x,y,z){x instanceof Vec3?this.localPosition.copy(x):this.localPosition.set(x,y,z),this._dirtyLocal||this._dirtifyLocal()},_proto.setLocalRotation=function setLocalRotation(x,y,z,w){x instanceof Quat?this.localRotation.copy(x):this.localRotation.set(x,y,z,w),this._dirtyLocal||this._dirtifyLocal()},_proto.setLocalScale=function setLocalScale(x,y,z){x instanceof Vec3?this.localScale.copy(x):this.localScale.set(x,y,z),this._dirtyLocal||this._dirtifyLocal()},_proto._dirtifyLocal=function _dirtifyLocal(){this._dirtyLocal||(this._dirtyLocal=!0,this._dirtyWorld||this._dirtifyWorld())},_proto._unfreezeParentToRoot=function _unfreezeParentToRoot(){for(var p=this._parent;p;)p._frozen=!1,p=p._parent},_proto._dirtifyWorld=function _dirtifyWorld(){this._dirtyWorld||this._unfreezeParentToRoot(),this._dirtifyWorldInternal()},_proto._dirtifyWorldInternal=function _dirtifyWorldInternal(){if(!this._dirtyWorld){this._frozen=!1,this._dirtyWorld=!0;for(var i=0;i<this._children.length;i++)this._children[i]._dirtyWorld||this._children[i]._dirtifyWorldInternal()}this._dirtyNormal=!0,this._aabbVer++},_proto.setPosition=function setPosition(x,y,z){x instanceof Vec3?position$1.copy(x):position$1.set(x,y,z),null===this._parent?this.localPosition.copy(position$1):(invParentWtm$1.copy(this._parent.getWorldTransform()).invert(),invParentWtm$1.transformPoint(position$1,this.localPosition)),this._dirtyLocal||this._dirtifyLocal()},_proto.setRotation=function setRotation(x,y,z,w){if(x instanceof Quat?rotation.copy(x):rotation.set(x,y,z,w),null===this._parent)this.localRotation.copy(rotation);else{var parentRot=this._parent.getRotation();invParentRot.copy(parentRot).invert(),this.localRotation.copy(invParentRot).mul(rotation)}this._dirtyLocal||this._dirtifyLocal()},_proto.setEulerAngles=function setEulerAngles(x,y,z){if(x instanceof Vec3?this.localRotation.setFromEulerAngles(x.x,x.y,x.z):this.localRotation.setFromEulerAngles(x,y,z),null!==this._parent){var parentRot=this._parent.getRotation();invParentRot.copy(parentRot).invert(),this.localRotation.mul2(invParentRot,this.localRotation)}this._dirtyLocal||this._dirtifyLocal()},_proto.addChild=function addChild(node){if(null!==node._parent)throw new Error("GraphNode is already parented");this._children.push(node),this._onInsertChild(node)},_proto.addChildAndSaveTransform=function addChildAndSaveTransform(node){var wPos=node.getPosition(),wRot=node.getRotation(),current=node._parent;current&&current.removeChild(node),node.setPosition(tmpMat4.copy(this.worldTransform).invert().transformPoint(wPos)),node.setRotation(tmpQuat.copy(this.getRotation()).invert().mul(wRot)),this._children.push(node),this._onInsertChild(node)},_proto.insertChild=function insertChild(node,index){if(null!==node._parent)throw new Error("GraphNode is already parented");this._children.splice(index,0,node),this._onInsertChild(node)},_proto._onInsertChild=function _onInsertChild(node){node._parent=this;var enabledInHierarchy=node._enabled&&this.enabled;node._enabledInHierarchy!==enabledInHierarchy&&(node._enabledInHierarchy=enabledInHierarchy,node._notifyHierarchyStateChanged(node,enabledInHierarchy)),node._updateGraphDepth(),node._dirtifyWorld(),this._frozen&&node._unfreezeParentToRoot(),node.fire&&node.fire("insert",this),this.fire&&this.fire("childinsert",node)},_proto._updateGraphDepth=function _updateGraphDepth(){this._parent?this._graphDepth=this._parent._graphDepth+1:this._graphDepth=0;for(var i=0,len=this._children.length;i<len;i++)this._children[i]._updateGraphDepth()},_proto.removeChild=function removeChild(child){var i,length=this._children.length;for(i=0;i<length;++i)if(this._children[i]===child)return this._children.splice(i,1),child._parent=null,child.fire&&child.fire("remove",this),void(this.fire&&this.fire("childremove",child))},_proto._sync=function _sync(){if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){var parentWorldScale,parent=this._parent,scale=this.localScale,parentToUseScaleFrom=parent;if(parentToUseScaleFrom){for(;parentToUseScaleFrom&&parentToUseScaleFrom.scaleCompensation;)parentToUseScaleFrom=parentToUseScaleFrom._parent;parentToUseScaleFrom&&(parentToUseScaleFrom=parentToUseScaleFrom._parent)&&(parentWorldScale=parentToUseScaleFrom.worldTransform.getScale(),scaleCompensateScale.mul2(parentWorldScale,this.localScale),scale=scaleCompensateScale)}scaleCompensateRot2.setFromMat4(parent.worldTransform),scaleCompensateRot.mul2(scaleCompensateRot2,this.localRotation);var tmatrix=parent.worldTransform;parent.scaleCompensation&&(scaleCompensateScaleForParent.mul2(parentWorldScale,parent.getLocalScale()),scaleCompensatePosTransform.setTRS(parent.worldTransform.getTranslation(scaleCompensatePos),scaleCompensateRot2,scaleCompensateScaleForParent),tmatrix=scaleCompensatePosTransform),tmatrix.transformPoint(this.localPosition,scaleCompensatePos),this.worldTransform.setTRS(scaleCompensatePos,scaleCompensateRot,scale)}else this.worldTransform.mulAffine2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1}},_proto.syncHierarchy=function syncHierarchy(){if(this._enabled&&!this._frozen){this._frozen=!0,(this._dirtyLocal||this._dirtyWorld)&&this._sync();for(var children=this._children,i=0,len=children.length;i<len;i++)children[i].syncHierarchy()}},_proto.lookAt=function lookAt(x,y,z,ux,uy,uz){if(void 0===ux&&(ux=0),void 0===uy&&(uy=1),void 0===uz&&(uz=0),x instanceof Vec3)target.copy(x),y instanceof Vec3?up.copy(y):up.copy(Vec3.UP);else{if(void 0===z)return;target.set(x,y,z),up.set(ux,uy,uz)}matrix.setLookAt(this.getPosition(),target,up),rotation.setFromMat4(matrix),this.setRotation(rotation)},_proto.translate=function translate(x,y,z){x instanceof Vec3?position$1.copy(x):position$1.set(x,y,z),position$1.add(this.getPosition()),this.setPosition(position$1)},_proto.translateLocal=function translateLocal(x,y,z){x instanceof Vec3?position$1.copy(x):position$1.set(x,y,z),this.localRotation.transformVector(position$1,position$1),this.localPosition.add(position$1),this._dirtyLocal||this._dirtifyLocal()},_proto.rotate=function rotate(x,y,z){if(x instanceof Vec3?rotation.setFromEulerAngles(x.x,x.y,x.z):rotation.setFromEulerAngles(x,y,z),null===this._parent)this.localRotation.mul2(rotation,this.localRotation);else{var rot=this.getRotation(),parentRot=this._parent.getRotation();invParentRot.copy(parentRot).invert(),rotation.mul2(invParentRot,rotation),this.localRotation.mul2(rotation,rot)}this._dirtyLocal||this._dirtifyLocal()},_proto.rotateLocal=function rotateLocal(x,y,z){x instanceof Vec3?rotation.setFromEulerAngles(x.x,x.y,x.z):rotation.setFromEulerAngles(x,y,z),this.localRotation.mul(rotation),this._dirtyLocal||this._dirtifyLocal()},_createClass(GraphNode,[{key:"right",get:function get(){return this._right||(this._right=new Vec3),this.getWorldTransform().getX(this._right).normalize()}},{key:"up",get:function get(){return this._up||(this._up=new Vec3),this.getWorldTransform().getY(this._up).normalize()}},{key:"forward",get:function get(){return this._forward||(this._forward=new Vec3),this.getWorldTransform().getZ(this._forward).normalize().mulScalar(-1)}},{key:"enabled",get:function get(){return this._enabled&&this._enabledInHierarchy},set:function set(enabled){this._enabled!==enabled&&(this._enabled=enabled,this._parent&&!this._parent.enabled||this._notifyHierarchyStateChanged(this,enabled))}},{key:"parent",get:function get(){return this._parent}},{key:"path",get:function get(){var parent=this._parent;if(parent){for(var path=this.name;parent&&parent._parent;)path=parent.name+"/"+path,parent=parent._parent;return path}return""}},{key:"root",get:function get(){var parent=this._parent;if(!parent)return this;for(;parent._parent;)parent=parent._parent;return parent}},{key:"children",get:function get(){return this._children}},{key:"graphDepth",get:function get(){return this._graphDepth}}]),GraphNode}(EventHandler),_tmpAabb=new BoundingBox,_tempBoneAabb=new BoundingBox,_tempSphere=new BoundingSphere,_meshSet=new Set,InstancingData=function InstancingData(numObjects){this.count=numObjects,this.vertexBuffer=null},Command=function(){function Command(layer,blendType,command){this._key=[],this._key[0]=getKey(layer,blendType,!0,0),this.command=command}return _createClass(Command,[{key:"key",get:function get(){return this._key[0]},set:function set(val){this._key[0]=val}}]),Command}(),MeshInstance=function(){function MeshInstance(mesh,material,node){if(void 0===node&&(node=null),mesh instanceof GraphNode){var temp=mesh;mesh=material,material=node,node=temp}this._key=[0,0],this._shader=[null,null,null],this.isStatic=!1,this._staticLightList=null,this._staticSource=null,this.node=node,this._mesh=mesh,mesh.incRefCount(),this.material=material,this._shaderDefs=65536,this._shaderDefs|=mesh.vertexBuffer.format.hasUv0?4:0,this._shaderDefs|=mesh.vertexBuffer.format.hasUv1?8:0,this._shaderDefs|=mesh.vertexBuffer.format.hasColor?16:0,this._shaderDefs|=mesh.vertexBuffer.format.hasTangents?512:0,this._lightHash=0,this.visible=!0,this.layer=15,this._renderStyle=0,this.castShadow=!1,this._receiveShadow=!0,this._screenSpace=!1,this._noDepthDrawGl1=!1,this.cull=!0,this.pick=!0,this._updateAabb=!0,this._updateAabbFunc=null,this._calculateSortDistance=null,this.updateKey(),this._skinInstance=null,this._morphInstance=null,this.instancingData=null,this._customAabb=null,this.aabb=new BoundingBox,this._aabbVer=-1,this.drawOrder=0,this.visibleThisFrame=0,this.isVisibleFunc=null,this.parameters={},this.stencilFront=null,this.stencilBack=null,this.flipFaces=!1}MeshInstance.incRefLightmap=function incRefLightmap(texture){this._lightmapCache.incRef(texture)},MeshInstance.decRefLightmap=function decRefLightmap(texture){this._lightmapCache.decRef(texture)},MeshInstance._prepareRenderStyleForArray=function _prepareRenderStyleForArray(meshInstances,renderStyle){if(meshInstances){for(var i=0;i<meshInstances.length;i++){meshInstances[i]._renderStyle=renderStyle;var mesh=meshInstances[i].mesh;_meshSet.has(mesh)||(_meshSet.add(mesh),mesh.prepareRenderState(renderStyle))}_meshSet.clear()}};var _proto=MeshInstance.prototype;return _proto.destroy=function destroy(){var mesh=this.mesh;mesh&&(this.mesh=null,mesh.getRefCount()<1&&mesh.destroy()),this.setRealtimeLightmap(MeshInstance.lightmapParamNames[0],null),this.setRealtimeLightmap(MeshInstance.lightmapParamNames[1],null),this._skinInstance&&(this._skinInstance.destroy(),this._skinInstance=null),this.morphInstance&&(this.morphInstance.destroy(),this.morphInstance=null),this.material=null},_proto.syncAabb=function syncAabb(){},_proto._isVisible=function _isVisible(camera){if(this.visible){if(this.isVisibleFunc)return this.isVisibleFunc(camera);var pos=this.aabb.center;return this._aabb._radiusVer!==this._aabbVer&&(this._aabb._radius=this._aabb.halfExtents.length(),this._aabb._radiusVer=this._aabbVer),_tempSphere.radius=this._aabb._radius,_tempSphere.center=pos,camera.frustum.containsSphere(_tempSphere)}return!1},_proto.updateKey=function updateKey(){var material=this.material;this._key[0]=getKey(this.layer,material.alphaToCoverage||material.alphaTest?2:material.blendType,!1,material.id)},_proto.setInstancing=function setInstancing(vertexBuffer){vertexBuffer?(this.instancingData=new InstancingData(vertexBuffer.numVertices),this.instancingData.vertexBuffer=vertexBuffer,vertexBuffer.instancing=!0,this.cull=!1):(this.instancingData=null,this.cull=!0)},_proto.clearParameters=function clearParameters(){this.parameters={}},_proto.getParameters=function getParameters(){return this.parameters},_proto.getParameter=function getParameter(name){return this.parameters[name]},_proto.setParameter=function setParameter(name,data,passFlags){if(void 0===passFlags&&(passFlags=-262141),void 0===data&&"object"==typeof name){var uniformObject=name;if(uniformObject.length){for(var i=0;i<uniformObject.length;i++)this.setParameter(uniformObject[i]);return}name=uniformObject.name,data=uniformObject.value}var param=this.parameters[name];param?(param.data=data,param.passFlags=passFlags):this.parameters[name]={scopeId:null,data:data,passFlags:passFlags}},_proto.setRealtimeLightmap=function setRealtimeLightmap(name,texture){var old=this.getParameter(name);old!==texture&&(old&&MeshInstance.decRefLightmap(old.data),texture?(MeshInstance.incRefLightmap(texture),this.setParameter(name,texture)):this.deleteParameter(name))},_proto.deleteParameter=function deleteParameter(name){this.parameters[name]&&delete this.parameters[name]},_proto.setParameters=function setParameters(device,passFlag){var parameter,parameters=this.parameters;for(var paramName in parameters)(parameter=parameters[paramName]).passFlags&passFlag&&(parameter.scopeId||(parameter.scopeId=device.scope.resolve(paramName)),parameter.scopeId.setValue(parameter.data))},_proto.setLightmapped=function setLightmapped(value){value?this.mask=-6&(2|this.mask):(this.setRealtimeLightmap(MeshInstance.lightmapParamNames[0],null),this.setRealtimeLightmap(MeshInstance.lightmapParamNames[1],null),this._shaderDefs&=-193,this.mask=-7&(1|this.mask))},_proto.setCustomAabb=function setCustomAabb(aabb){aabb?this._customAabb?this._customAabb.copy(aabb):this._customAabb=aabb.clone():(this._customAabb=null,this._aabbVer=-1),this._setupSkinUpdate()},_proto._setupSkinUpdate=function _setupSkinUpdate(){this._skinInstance&&(this._skinInstance._updateBeforeCull=!this._customAabb)},_createClass(MeshInstance,[{key:"renderStyle",get:function get(){return this._renderStyle},set:function set(renderStyle){this._renderStyle=renderStyle,this.mesh.prepareRenderState(renderStyle)}},{key:"mesh",get:function get(){return this._mesh},set:function set(mesh){mesh!==this._mesh&&(this._mesh&&this._mesh.decRefCount(),this._mesh=mesh,mesh&&mesh.incRefCount())}},{key:"aabb",get:function get(){if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);var localAabb=this._customAabb,toWorldSpace=!!localAabb;if(!localAabb)if(localAabb=_tmpAabb,this.skinInstance){if(!this.mesh.boneAabb){var morphTargets=this._morphInstance?this._morphInstance.morph._targets:null;this.mesh._initBoneAabbs(morphTargets)}for(var boneUsed=this.mesh.boneUsed,first=!0,i=0;i<this.mesh.boneAabb.length;i++)boneUsed[i]&&(_tempBoneAabb.setFromTransformedAabb(this.mesh.boneAabb[i],this.skinInstance.matrices[i]),first?(first=!1,localAabb.center.copy(_tempBoneAabb.center),localAabb.halfExtents.copy(_tempBoneAabb.halfExtents)):localAabb.add(_tempBoneAabb));toWorldSpace=!0}else this.node._aabbVer!==this._aabbVer&&(this.mesh?(localAabb.center.copy(this.mesh.aabb.center),localAabb.halfExtents.copy(this.mesh.aabb.halfExtents)):(localAabb.center.set(0,0,0),localAabb.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph&&localAabb._expand(this.mesh.morph.aabb.getMin(),this.mesh.morph.aabb.getMax()),toWorldSpace=!0,this._aabbVer=this.node._aabbVer);return toWorldSpace&&this._aabb.setFromTransformedAabb(localAabb,this.node.getWorldTransform()),this._aabb},set:function set(aabb){this._aabb=aabb}},{key:"material",get:function get(){return this._material},set:function set(material){var i;for(i=0;i<this._shader.length;i++)this._shader[i]=null;if(this._material){var meshInstances=this._material.meshInstances;-1!==(i=meshInstances.indexOf(this))&&meshInstances.splice(i,1)}var prevMat=this._material,prevBlend,thisBlend;if((this._material=material,this._material)&&(this._material.meshInstances.push(this),this.updateKey(),(prevMat&&3!==prevMat.blendType)!==(3!==this._material.blendType))){var scene=this._material._scene;!scene&&prevMat&&prevMat._scene&&(scene=prevMat._scene),scene?scene.layers._dirtyBlend=!0:this._material._dirtyBlend=!0}}},{key:"layer",get:function get(){return this._layer},set:function set(layer){this._layer=layer,this.updateKey()}},{key:"calculateSortDistance",get:function get(){return this._calculateSortDistance},set:function set(calculateSortDistance){this._calculateSortDistance=calculateSortDistance}},{key:"receiveShadow",get:function get(){return this._receiveShadow},set:function set(val){this._receiveShadow=val,this._shaderDefs=val?-2&this._shaderDefs:1|this._shaderDefs,this._shader[0]=null,this._shader[1]=null}},{key:"skinInstance",get:function get(){return this._skinInstance},set:function set(val){this._skinInstance=val,this._shaderDefs=val?2|this._shaderDefs:-3&this._shaderDefs;for(var i=0;i<this._shader.length;i++)this._shader[i]=null;this._setupSkinUpdate()}},{key:"morphInstance",get:function get(){return this._morphInstance},set:function set(val){this._morphInstance=val,this._morphInstance&&(this._morphInstance.meshInstance=this),this._shaderDefs=val&&val.morph.useTextureMorph?4096|this._shaderDefs:-4097&this._shaderDefs,this._shaderDefs=val&&val.morph.morphPositions?1024|this._shaderDefs:-1025&this._shaderDefs,this._shaderDefs=val&&val.morph.morphNormals?2048|this._shaderDefs:-2049&this._shaderDefs;for(var i=0;i<this._shader.length;i++)this._shader[i]=null}},{key:"screenSpace",get:function get(){return this._screenSpace},set:function set(val){this._screenSpace=val,this._shaderDefs=val?256|this._shaderDefs:-257&this._shaderDefs,this._shader[0]=null}},{key:"key",get:function get(){return this._key[0]},set:function set(val){this._key[0]=val}},{key:"mask",get:function get(){return this._shaderDefs>>16},set:function set(val){var toggles=65535&this._shaderDefs;this._shaderDefs=toggles|val<<16,this._shader[0]=null,this._shader[1]=null}},{key:"instancingCount",get:function get(){return this.instancingData?this.instancingData.count:0},set:function set(value){this.instancingData&&(this.instancingData.count=value)}}]),MeshInstance}();function getKey(layer,blendType,isCommand,materialId){return(15&layer)<<27|(3===blendType?1:0)<<26|(isCommand?1:0)<<25|(33554431&materialId)<<0}MeshInstance.lightmapParamNames=["texture_lightMap","texture_dirLightMap"],MeshInstance._lightmapCache=new RefCountedCache;var Morph=function(_RefCountedObject){function Morph(targets,graphicsDevice){var _this;return(_this=_RefCountedObject.call(this)||this).device=graphicsDevice||getApplication().graphicsDevice,_this._targets=targets,_this.device.supportsMorphTargetTexturesCore&&(_this.device.extTextureHalfFloat&&_this.device.textureHalfFloatRenderable?_this._renderTextureFormat=Morph.FORMAT_HALF_FLOAT:_this.device.extTextureFloat&&_this.device.textureFloatRenderable&&(_this._renderTextureFormat=Morph.FORMAT_FLOAT),_this.device.extTextureHalfFloat&&_this.device.textureHalfFloatUpdatable?_this._textureFormat=Morph.FORMAT_HALF_FLOAT:_this.device.extTextureFloat&&(_this._textureFormat=Morph.FORMAT_FLOAT),void 0!==_this._renderTextureFormat&&void 0!==_this._textureFormat&&(_this._useTextureMorph=!0)),_this._init(),_this._updateMorphFlags(),_this._calculateAabb(),_this}_inheritsLoose(Morph,_RefCountedObject);var _proto=Morph.prototype;return _proto._init=function _init(){var i;if(this._useTextureMorph&&(this._useTextureMorph=this._initTextureBased()),!this._useTextureMorph)for(i=0;i<this._targets.length;i++)this._targets[i]._initVertexBuffers(this.device);for(i=0;i<this._targets.length;i++)this._targets[i]._postInit()},_proto._initTextureBased=function _initTextureBased(){var target,i,v,deltaArrays=[],deltaInfos=[];for(i=0;i<this._targets.length;i++)(target=this._targets[i]).options.deltaPositions&&(deltaArrays.push(target.options.deltaPositions),deltaInfos.push({target:target,name:"texturePositions"})),target.options.deltaNormals&&(deltaArrays.push(target.options.deltaNormals),deltaInfos.push({target:target,name:"textureNormals"}));var ids=[],usedDataIndices=[],vertexUsed,data,freeIndex=1,dataCount=deltaArrays[0].length;for(v=0;v<dataCount;v+=3){for(vertexUsed=!1,i=0;i<deltaArrays.length;i++)if(0!==(data=deltaArrays[i])[v]||0!==data[v+1]||0!==data[v+2]){vertexUsed=!0;break}vertexUsed?(ids.push(freeIndex),usedDataIndices.push(v/3),freeIndex++):ids.push(0)}var maxTextureSize=Math.min(this.device.maxTextureSize,4096),morphTextureWidth=Math.ceil(Math.sqrt(freeIndex));morphTextureWidth=Math.min(morphTextureWidth,maxTextureSize);var morphTextureHeight=Math.ceil(freeIndex/morphTextureWidth);if(morphTextureHeight>maxTextureSize)return!1;this.morphTextureWidth=morphTextureWidth,this.morphTextureHeight=morphTextureHeight;var halfFloat=!1,numComponents=3,float2Half=math.float2Half;this._textureFormat===Morph.FORMAT_HALF_FLOAT&&(halfFloat=!0,numComponents=4);var arraySize=this.morphTextureWidth*this.morphTextureHeight*numComponents,packedDeltas=halfFloat?new Uint16Array(arraySize):new Float32Array(arraySize);for(i=0;i<deltaArrays.length;i++){for(data=deltaArrays[i],v=0;v<usedDataIndices.length;v++){var index=usedDataIndices[v];halfFloat?(packedDeltas[v*numComponents+numComponents]=float2Half(data[3*index]),packedDeltas[v*numComponents+numComponents+1]=float2Half(data[3*index+1]),packedDeltas[v*numComponents+numComponents+2]=float2Half(data[3*index+2])):(packedDeltas[v*numComponents+numComponents]=data[3*index],packedDeltas[v*numComponents+numComponents+1]=data[3*index+1],packedDeltas[v*numComponents+numComponents+2]=data[3*index+2])}target=deltaInfos[i].target;var format=this._textureFormat===Morph.FORMAT_FLOAT?13:12;target._setTexture(deltaInfos[i].name,this._createTexture("MorphTarget",format,packedDeltas))}var formatDesc=[{semantic:"ATTR15",components:1,type:6}];return this.vertexBufferIds=new VertexBuffer(this.device,new VertexFormat(this.device,formatDesc),ids.length,0,new Float32Array(ids)),!0},_proto.destroy=function destroy(){this.vertexBufferIds&&(this.vertexBufferIds.destroy(),this.vertexBufferIds=null);for(var i=0;i<this._targets.length;i++)this._targets[i].destroy();this._targets.length=0},_proto.getTarget=function getTarget(index){return this._targets[index]},_proto._updateMorphFlags=function _updateMorphFlags(){var target;this._morphPositions=!1,this._morphNormals=!1;for(var i=0;i<this._targets.length;i++)(target=this._targets[i]).morphPositions&&(this._morphPositions=!0),target.morphNormals&&(this._morphNormals=!0)},_proto._calculateAabb=function _calculateAabb(){var target;this.aabb=new BoundingBox(new Vec3(0,0,0),new Vec3(0,0,0));for(var i=0;i<this._targets.length;i++)target=this._targets[i],this.aabb._expand(target.aabb.getMin(),target.aabb.getMax())},_proto._createTexture=function _createTexture(name,format,pixelData){var texture=new Texture(this.device,{width:this.morphTextureWidth,height:this.morphTextureHeight,format:format,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1}),pixels;(texture.name=name,pixelData)&&(texture.lock().set(pixelData),texture.unlock());return texture},_createClass(Morph,[{key:"morphPositions",get:function get(){return this._morphPositions}},{key:"morphNormals",get:function get(){return this._morphNormals}},{key:"maxActiveTargets",get:function get(){return this._useTextureMorph?this._targets.length:this._morphPositions&&this._morphNormals?4:8}},{key:"useTextureMorph",get:function get(){return this._useTextureMorph}}]),Morph}(RefCountedObject);Morph.FORMAT_FLOAT=0,Morph.FORMAT_HALF_FLOAT=1;var textureMorphVertexShader="attribute vec2 vertex_position;\nvarying vec2 uv0;\nvoid main(void) {\n\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\tuv0 = vertex_position.xy * 0.5 + 0.5;\n}\n",MorphInstance=function(){function MorphInstance(morph){this.morph=morph,morph.incRefCount(),this.device=morph.device,this.meshInstance=null,this._weights=[];for(var v=0;v<morph._targets.length;v++)this.setWeight(v,morph._targets[v].defaultWeight);if(this._activeTargets=[],morph.useTextureMorph){this.shaderCache={},this.maxSubmitCount=this.device.maxTextures,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount);var createRT=function(name,textureVar){var format=morph._renderTextureFormat===Morph.FORMAT_FLOAT?14:12;return this[textureVar]=morph._createTexture(name,format),new RenderTarget({colorBuffer:this[textureVar],depth:!1})}.bind(this);morph.morphPositions&&(this.rtPositions=createRT("MorphRTPos","texturePositions")),morph.morphNormals&&(this.rtNormals=createRT("MorphRTNrm","textureNormals")),this._textureParams=new Float32Array([morph.morphTextureWidth,morph.morphTextureHeight,1/morph.morphTextureWidth,1/morph.morphTextureHeight]);for(var i=0;i<this.maxSubmitCount;i++)this["morphBlendTex"+i]=this.device.scope.resolve("morphBlendTex"+i);this.morphFactor=this.device.scope.resolve("morphFactor[0]"),this.zeroTextures=!1}else this.maxSubmitCount=8,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount),this._shaderMorphWeightsA=new Float32Array(this._shaderMorphWeights.buffer,0,4),this._shaderMorphWeightsB=new Float32Array(this._shaderMorphWeights.buffer,16,4),this._activeVertexBuffers=new Array(this.maxSubmitCount)}var _proto=MorphInstance.prototype;return _proto.destroy=function destroy(){this.meshInstance=null,this.shader=null;var morph=this.morph;morph&&(this.morph=null,morph.decRefCount(),morph.getRefCount()<1&&morph.destroy()),this.rtPositions&&(this.rtPositions.destroy(),this.rtPositions=null),this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null),this.rtNormals&&(this.rtNormals.destroy(),this.rtNormals=null),this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)},_proto.clone=function clone(){var clone=new MorphInstance(this.morph);return clone},_proto.getWeight=function getWeight(index){return this._weights[index]},_proto.setWeight=function setWeight(index,weight){this._weights[index]=weight,this._dirty=!0},_proto._getFragmentShader=function _getFragmentShader(numTextures){var i,fragmentShader="";for(numTextures>0&&(fragmentShader+="varying vec2 uv0;\nuniform highp float morphFactor["+numTextures+"];\n"),i=0;i<numTextures;i++)fragmentShader+="uniform highp sampler2D morphBlendTex"+i+";\n";for(fragmentShader+="void main (void) {\n\t\thighp vec4 color = vec4(0, 0, 0, 1);\n",i=0;i<numTextures;i++)fragmentShader+="\t\tcolor.xyz += morphFactor["+i+"] * texture2D(morphBlendTex"+i+", uv0).xyz;\n";return fragmentShader+="\t\tgl_FragColor = color;\n}\n"},_proto._getShader=function _getShader(count){var shader=this.shaderCache[count];if(!shader){var fs=this._getFragmentShader(count);shader=createShaderFromCode(this.device,textureMorphVertexShader,fs,"textureMorph"+count),this.shaderCache[count]=shader}return shader},_proto._updateTextureRenderTarget=function _updateTextureRenderTarget(renderTarget,srcTextureName){for(var device=this.device,submitBatch=function(usedCount,blending){this.morphFactor.setValue(this._shaderMorphWeights),device.setBlending(blending),blending&&(device.setBlendFunction(1,1),device.setBlendEquation(0));var shader=this._getShader(usedCount);drawQuadWithShader(device,renderTarget,shader,void 0,void 0,blending)}.bind(this),usedCount=0,blending=!1,count=this._activeTargets.length,i=0;i<count;i++){var activeTarget=this._activeTargets[i],tex=activeTarget.target[srcTextureName];tex&&(this["morphBlendTex"+usedCount].setValue(tex),this._shaderMorphWeights[usedCount]=activeTarget.weight,++usedCount>=this.maxSubmitCount&&(submitBatch(usedCount,blending),usedCount=0,blending=!0))}(usedCount>0||0===count&&!this.zeroTextures)&&submitBatch(usedCount,blending)},_proto._updateTextureMorph=function _updateTextureMorph(){this.device,(this._activeTargets.length>0||!this.zeroTextures)&&(this._updateTextureRenderTarget(this.rtPositions,"texturePositions"),this._updateTextureRenderTarget(this.rtNormals,"textureNormals"),this.zeroTextures=0===this._activeTargets.length)},_proto._updateVertexMorph=function _updateVertexMorph(){var i,count=this.maxSubmitCount;for(i=0;i<count;i++)this._shaderMorphWeights[i]=0,this._activeVertexBuffers[i]=null;var posIndex=0,nrmIndex=this.morph.morphPositions?4:0,target;for(i=0;i<this._activeTargets.length;i++)(target=this._activeTargets[i].target)._vertexBufferPositions&&(this._activeVertexBuffers[posIndex]=target._vertexBufferPositions,this._shaderMorphWeights[posIndex]=this._activeTargets[i].weight,posIndex++),target._vertexBufferNormals&&(this._activeVertexBuffers[nrmIndex]=target._vertexBufferNormals,this._shaderMorphWeights[nrmIndex]=this._activeTargets[i].weight,nrmIndex++)},_proto.update=function update(){this._dirty=!1;var targets=this.morph._targets,activeCount=0,activeTarget,i,absWeight,epsilon=1e-5;for(i=0;i<targets.length;i++)(absWeight=Math.abs(this.getWeight(i)))>1e-5&&(this._activeTargets.length<=activeCount&&(this._activeTargets[activeCount]={}),(activeTarget=this._activeTargets[activeCount++]).absWeight=absWeight,activeTarget.weight=this.getWeight(i),activeTarget.target=targets[i]);this._activeTargets.length=activeCount;var maxActiveTargets=this.morph.maxActiveTargets;this._activeTargets.length>maxActiveTargets&&(this._activeTargets.sort((function(l,r){return l.absWeight<r.absWeight?1:r.absWeight<l.absWeight?-1:0})),this._activeTargets.length=maxActiveTargets),this.morph.useTextureMorph?this._updateTextureMorph():this._updateVertexMorph()},MorphInstance}(),Model=function(){function Model(){this.graph=null,this.meshInstances=[],this.skinInstances=[],this.morphInstances=[],this.cameras=[],this.lights=[],this._shadersVersion=0,this._immutable=!1}var _proto=Model.prototype;return _proto.getGraph=function getGraph(){return this.graph},_proto.setGraph=function setGraph(graph){this.graph=graph},_proto.getCameras=function getCameras(){return this.cameras},_proto.setCameras=function setCameras(cameras){this.cameras=cameras},_proto.getLights=function getLights(){return this.lights},_proto.setLights=function setLights(lights){this.lights=lights},_proto.getMaterials=function getMaterials(){var i,materials=[];for(i=0;i<this.meshInstances.length;i++){var meshInstance=this.meshInstances[i];-1===materials.indexOf(meshInstance.material)&&materials.push(meshInstance.material)}return materials},_proto.clone=function clone(){var i,j,srcNodes=[],cloneNodes=[],_duplicate,cloneGraph=function _duplicate(node){var newNode=node.clone();srcNodes.push(node),cloneNodes.push(newNode);for(var idx=0;idx<node._children.length;idx++)newNode.addChild(_duplicate(node._children[idx]));return newNode}(this.graph),cloneMeshInstances=[],cloneSkinInstances=[],cloneMorphInstances=[];for(i=0;i<this.skinInstances.length;i++){var skin=this.skinInstances[i].skin,cloneSkinInstance=new SkinInstance(skin),bones=[];for(j=0;j<skin.boneNames.length;j++){var boneName=skin.boneNames[j],bone=cloneGraph.findByName(boneName);bones.push(bone)}cloneSkinInstance.bones=bones,cloneSkinInstances.push(cloneSkinInstance)}for(i=0;i<this.morphInstances.length;i++){var morph=this.morphInstances[i].morph,cloneMorphInstance=new MorphInstance(morph);cloneMorphInstances.push(cloneMorphInstance)}for(i=0;i<this.meshInstances.length;i++){var meshInstance=this.meshInstances[i],nodeIndex=srcNodes.indexOf(meshInstance.node),cloneMeshInstance=new MeshInstance(meshInstance.mesh,meshInstance.material,cloneNodes[nodeIndex]);if(meshInstance.skinInstance){var skinInstanceIndex=this.skinInstances.indexOf(meshInstance.skinInstance);cloneMeshInstance.skinInstance=cloneSkinInstances[skinInstanceIndex]}if(meshInstance.morphInstance){var morphInstanceIndex=this.morphInstances.indexOf(meshInstance.morphInstance);cloneMeshInstance.morphInstance=cloneMorphInstances[morphInstanceIndex]}cloneMeshInstances.push(cloneMeshInstance)}var clone=new Model;return clone.graph=cloneGraph,clone.meshInstances=cloneMeshInstances,clone.skinInstances=cloneSkinInstances,clone.morphInstances=cloneMorphInstances,clone.getGraph().syncHierarchy(),clone},_proto.destroy=function destroy(){for(var meshInstances=this.meshInstances,i=0;i<meshInstances.length;i++)meshInstances[i].destroy();this.meshInstances.length=0},_proto.generateWireframe=function generateWireframe(){MeshInstance._prepareRenderStyleForArray(this.meshInstances,1)},Model}();function paramsIdentical(a,b){if(a&&!b)return!1;if(!a&&b)return!1;if((a=a.data)===(b=b.data))return!0;if(a instanceof Float32Array&&b instanceof Float32Array){if(a.length!==b.length)return!1;for(var i=0;i<a.length;i++)if(a[i]!==b[i])return!1;return!0}return!1}function equalParamSets(params1,params2){var param;for(param in params1)if(params1.hasOwnProperty(param)&&!paramsIdentical(params1[param],params2[param]))return!1;for(param in params2)if(params2.hasOwnProperty(param)&&!paramsIdentical(params2[param],params1[param]))return!1;return!0}function equalLightLists(lightList1,lightList2){var k;for(k=0;k<lightList1.length;k++)if(lightList2.indexOf(lightList1[k])<0)return!1;for(k=0;k<lightList2.length;k++)if(lightList1.indexOf(lightList2[k])<0)return!1;return!0}var mat3=new Mat3,worldMatX$1=new Vec3,worldMatY$1=new Vec3,worldMatZ$1=new Vec3;function getScaleSign(mi){var wt=mi.node.worldTransform;return wt.getX(worldMatX$1),wt.getY(worldMatY$1),wt.getZ(worldMatZ$1),worldMatX$1.cross(worldMatX$1,worldMatY$1),worldMatX$1.dot(worldMatZ$1)>=0?1:-1}var BatchManager=function(){function BatchManager(device,root,scene){this.device=device,this.rootNode=root,this.scene=scene,this._init=!1,this._batchGroups={},this._batchGroupCounter=0,this._batchList=[],this._dirtyGroups=[]}var _proto=BatchManager.prototype;return _proto.destroyManager=function destroyManager(){this.device=null,this.rootNode=null,this.scene=null,this._batchGroups={},this._batchList=[],this._dirtyGroups=[]},_proto.addGroup=function addGroup(name,dynamic,maxAabbSize,id,layers){var group;if(void 0===id&&(id=this._batchGroupCounter,this._batchGroupCounter++),!this._batchGroups[id])return this._batchGroups[id]=group=new BatchGroup(id,name,dynamic,maxAabbSize,layers),group},_proto.removeGroup=function removeGroup(id){if(this._batchGroups[id]){for(var newBatchList=[],i=0;i<this._batchList.length;i++)this._batchList[i].batchGroupId===id?this.destroy(this._batchList[i]):newBatchList.push(this._batchList[i]);this._batchList=newBatchList,this._removeModelsFromBatchGroup(this.rootNode,id),delete this._batchGroups[id]}},_proto.markGroupDirty=function markGroupDirty(id){this._dirtyGroups.indexOf(id)<0&&this._dirtyGroups.push(id)},_proto.getGroupByName=function getGroupByName(name){var groups=this._batchGroups;for(var group in groups)if(groups.hasOwnProperty(group)&&groups[group].name===name)return groups[group];return null},_proto.getBatches=function getBatches(batchGroupId){for(var results=[],len=this._batchList.length,i=0;i<len;i++){var batch=this._batchList[i];batch.batchGroupId===batchGroupId&&results.push(batch)}return results},_proto._removeModelsFromBatchGroup=function _removeModelsFromBatchGroup(node,id){if(node.enabled){node.model&&node.model.batchGroupId===id&&(node.model.batchGroupId=-1),node.render&&node.render.batchGroupId===id&&(node.render.batchGroupId=-1),node.element&&node.element.batchGroupId===id&&(node.element.batchGroupId=-1),node.sprite&&node.sprite.batchGroupId===id&&(node.sprite.batchGroupId=-1);for(var i=0;i<node._children.length;i++)this._removeModelsFromBatchGroup(node._children[i],id)}},_proto.insert=function insert(type,groupId,node){var group=this._batchGroups[groupId];group&&group._obj[type].indexOf(node)<0&&(group._obj[type].push(node),this.markGroupDirty(groupId))},_proto.remove=function remove(type,groupId,node){var group=this._batchGroups[groupId];if(group){var idx=group._obj[type].indexOf(node);idx>=0&&(group._obj[type].splice(idx,1),this.markGroupDirty(groupId))}},_proto._extractRender=function _extractRender(node,arr,group,groupMeshInstances){if(node.render){if(node.render.isStatic){var i,drawCalls=this.scene.drawCalls,nodeMeshInstances=node.render.meshInstances;for(i=0;i<drawCalls.length;i++)drawCalls[i]._staticSource&&(nodeMeshInstances.indexOf(drawCalls[i]._staticSource)<0||arr.push(drawCalls[i]));for(i=0;i<nodeMeshInstances.length;i++)drawCalls.indexOf(nodeMeshInstances[i])>=0&&arr.push(nodeMeshInstances[i])}else arr=groupMeshInstances[node.render.batchGroupId]=arr.concat(node.render.meshInstances);node.render.removeFromLayers()}return arr},_proto._extractModel=function _extractModel(node,arr,group,groupMeshInstances){if(node.model&&node.model.model){var i;if(node.model.isStatic){var drawCalls=this.scene.drawCalls,nodeMeshInstances=node.model.meshInstances;for(i=0;i<drawCalls.length;i++)drawCalls[i]._staticSource&&(nodeMeshInstances.indexOf(drawCalls[i]._staticSource)<0||arr.push(drawCalls[i]));for(i=0;i<nodeMeshInstances.length;i++)drawCalls.indexOf(nodeMeshInstances[i])>=0&&arr.push(nodeMeshInstances[i])}else arr=groupMeshInstances[node.model.batchGroupId]=arr.concat(node.model.meshInstances);node.model.removeModelFromLayers()}return arr},_proto._extractElement=function _extractElement(node,arr,group){if(node.element){var valid=!1;node.element._text&&node.element._text._model.meshInstances.length>0?(arr.push(node.element._text._model.meshInstances[0]),node.element.removeModelFromLayers(node.element._text._model),valid=!0):node.element._image&&(arr.push(node.element._image._renderable.meshInstance),node.element.removeModelFromLayers(node.element._image._renderable.model),node.element._image._renderable.unmaskMeshInstance&&(arr.push(node.element._image._renderable.unmaskMeshInstance),node.element._image._renderable.unmaskMeshInstance.stencilFront&&node.element._image._renderable.unmaskMeshInstance.stencilBack||(node.element._dirtifyMask(),node.element._onPrerender())),valid=!0),valid&&(group._ui=!0)}},_proto._collectAndRemoveMeshInstances=function _collectAndRemoveMeshInstances(groupMeshInstances,groupIds){for(var node,group,arr,id,g=0;g<groupIds.length;g++)if(id=groupIds[g],group=this._batchGroups[id]){(arr=groupMeshInstances[id])||(arr=groupMeshInstances[id]=[]);for(var m=0;m<group._obj.model.length;m++)arr=this._extractModel(group._obj.model[m],arr,group,groupMeshInstances);for(var r=0;r<group._obj.render.length;r++)arr=this._extractRender(group._obj.render[r],arr,group,groupMeshInstances);for(var e=0;e<group._obj.element.length;e++)this._extractElement(group._obj.element[e],arr,group);for(var s=0;s<group._obj.sprite.length;s++)(node=group._obj.sprite[s]).sprite&&node.sprite._meshInstance&&(group.dynamic||0===node.sprite.sprite._renderMode)&&(arr.push(node.sprite._meshInstance),node.sprite.removeModelFromLayers(),group._sprite=!0,node.sprite._batchGroup=group)}},_proto.generate=function generate(groupIds){var i,j,groupMeshInstances={};groupIds||(groupIds=Object.keys(this._batchGroups));var newBatchList=[],group,lists,groupData,batch;for(i=0;i<this._batchList.length;i++)groupIds.indexOf(this._batchList[i].batchGroupId)<0?newBatchList.push(this._batchList[i]):this.destroy(this._batchList[i]);if(this._batchList=newBatchList,this._collectAndRemoveMeshInstances(groupMeshInstances,groupIds),groupIds===this._dirtyGroups)this._dirtyGroups.length=0;else{var newDirtyGroups=[];for(i=0;i<this._dirtyGroups.length;i++)groupIds.indexOf(this._dirtyGroups[i])<0&&newDirtyGroups.push(this._dirtyGroups[i]);this._dirtyGroups=newDirtyGroups}for(var groupId in groupMeshInstances)if(groupMeshInstances.hasOwnProperty(groupId)&&(group=groupMeshInstances[groupId],groupData=this._batchGroups[groupId]))for(lists=this.prepare(group,groupData.dynamic,groupData.maxAabbSize,groupData._ui||groupData._sprite),i=0;i<lists.length;i++)if(batch=this.create(lists[i],groupData.dynamic,parseInt(groupId,10)))for(j=0;j<groupData.layers.length;j++){var layer=this.scene.layers.getLayerById(groupData.layers[j]);layer&&layer.addMeshInstances(batch.model.meshInstances)}},_proto.prepare=function prepare(meshInstances,dynamic,maxAabbSize,translucent){if(void 0===maxAabbSize&&(maxAabbSize=Number.POSITIVE_INFINITY),0===meshInstances.length)return[];var halfMaxAabbSize=.5*maxAabbSize,maxInstanceCount=this.device.supportsBoneTextures?1024:this.device.boneLimit,maxNumVertices=this.device.extUintElement?4294967295:65535,material,layer,vertCount,params,lightList,defs,stencil,staticLights,scaleSign,drawOrder,indexed,vertexFormatBatchingHash,aabb=new BoundingBox,testAabb=new BoundingBox,skipTranslucentAabb=null,mi,sf,lists=[],i,j=0;translucent&&meshInstances.sort((function(a,b){return a.drawOrder-b.drawOrder}));for(var meshInstancesLeftA=meshInstances,meshInstancesLeftB,skipMesh=translucent?function(mi){skipTranslucentAabb?skipTranslucentAabb.add(mi.aabb):skipTranslucentAabb=mi.aabb.clone(),meshInstancesLeftB.push(mi)}:function(mi){meshInstancesLeftB.push(mi)};meshInstancesLeftA.length>0;){for(lists[j]=[meshInstancesLeftA[0]],meshInstancesLeftB=[],material=meshInstancesLeftA[0].material,layer=meshInstancesLeftA[0].layer,defs=meshInstancesLeftA[0]._shaderDefs,params=meshInstancesLeftA[0].parameters,stencil=meshInstancesLeftA[0].stencilFront,lightList=meshInstancesLeftA[0]._staticLightList,vertCount=meshInstancesLeftA[0].mesh.vertexBuffer.getNumVertices(),drawOrder=meshInstancesLeftA[0].drawOrder,aabb.copy(meshInstancesLeftA[0].aabb),scaleSign=getScaleSign(meshInstancesLeftA[0]),vertexFormatBatchingHash=meshInstancesLeftA[0].mesh.vertexBuffer.format.batchingHash,indexed=meshInstancesLeftA[0].mesh.primitive[0].indexed,skipTranslucentAabb=null,i=1;i<meshInstancesLeftA.length;i++){if(mi=meshInstancesLeftA[i],dynamic&&lists[j].length>=maxInstanceCount){meshInstancesLeftB=meshInstancesLeftB.concat(meshInstancesLeftA.slice(i));break}if(material!==mi.material||layer!==mi.layer||vertexFormatBatchingHash!==mi.mesh.vertexBuffer.format.batchingHash||indexed!==mi.mesh.primitive[0].indexed||defs!==mi._shaderDefs||vertCount+mi.mesh.vertexBuffer.getNumVertices()>maxNumVertices)skipMesh(mi);else if(testAabb.copy(aabb),testAabb.add(mi.aabb),testAabb.halfExtents.x>halfMaxAabbSize||testAabb.halfExtents.y>halfMaxAabbSize||testAabb.halfExtents.z>halfMaxAabbSize)skipMesh(mi);else if(!stencil||(sf=mi.stencilFront)&&stencil.func===sf.func&&stencil.zpass===sf.zpass)if(scaleSign===getScaleSign(mi))if(equalParamSets(params,mi.parameters)){if(staticLights=mi._staticLightList,lightList&&staticLights){if(!equalLightLists(lightList,staticLights)){skipMesh(mi);continue}}else if(lightList||staticLights){skipMesh(mi);continue}translucent&&skipTranslucentAabb&&skipTranslucentAabb.intersects(mi.aabb)&&mi.drawOrder!==drawOrder?skipMesh(mi):(aabb.add(mi.aabb),vertCount+=mi.mesh.vertexBuffer.getNumVertices(),lists[j].push(mi))}else skipMesh(mi);else skipMesh(mi);else skipMesh(mi)}j++,meshInstancesLeftA=meshInstancesLeftB}return lists},_proto.create=function create(meshInstances,dynamic,batchGroupId){if(!this._init){var boneLimit="#define BONE_LIMIT "+this.device.getBoneLimit()+"\n";this.transformVS=boneLimit+"#define DYNAMICBATCH\n"+shaderChunks.transformVS,this.skinTexVS=shaderChunks.skinBatchTexVS,this.skinConstVS=shaderChunks.skinBatchConstVS,this.vertexFormats={},this._init=!0}var i,j,streams=null,stream,semantic,material=null,mesh,elems,numVerts,batchNumVerts=0,batchNumIndices=0,batch=null;for(i=0;i<meshInstances.length;i++)if(meshInstances[i].visible&&(batchNumVerts+=numVerts=(mesh=meshInstances[i].mesh).vertexBuffer.numVertices,batchNumIndices+=mesh.primitive[0].indexed?mesh.primitive[0].count:6===mesh.primitive[0].type&&4===mesh.primitive[0].count?6:0,!streams)){for(material=meshInstances[i].material,streams={},elems=mesh.vertexBuffer.format.elements,j=0;j<elems.length;j++)streams[semantic=elems[j].name]={numComponents:elems[j].numComponents,dataType:elems[j].dataType,normalize:elems[j].normalize,count:0};dynamic&&(streams.BLENDINDICES={numComponents:1,dataType:6,normalize:!1,count:0})}if(streams){var indexBase,numIndices,indexData;batch=new Batch(meshInstances,dynamic,batchGroupId),this._batchList.push(batch);var verticesOffset=0,indexOffset=0,transform,vec=new Vec3,indexArrayType,indices=new(batchNumVerts<=65535?Uint16Array:Uint32Array)(batchNumIndices);for(semantic in streams)(stream=streams[semantic]).typeArrayType=typedArrayTypes[stream.dataType],stream.elementByteSize=typedArrayTypesByteSize[stream.dataType],stream.buffer=new stream.typeArrayType(batchNumVerts*stream.numComponents);for(i=0;i<meshInstances.length;i++)if(meshInstances[i].visible){for(semantic in numVerts=(mesh=meshInstances[i].mesh).vertexBuffer.numVertices,dynamic||(transform=meshInstances[i].node.getWorldTransform()),streams)if("BLENDINDICES"!==semantic){var subarray=new(stream=streams[semantic]).typeArrayType(stream.buffer.buffer,stream.elementByteSize*stream.count),totalComponents=mesh.getVertexStream(semantic,subarray)*stream.numComponents;if(stream.count+=totalComponents,!dynamic&&stream.numComponents>=3)if("POSITION"===semantic)for(j=0;j<totalComponents;j+=stream.numComponents)vec.set(subarray[j],subarray[j+1],subarray[j+2]),transform.transformPoint(vec,vec),subarray[j]=vec.x,subarray[j+1]=vec.y,subarray[j+2]=vec.z;else if("NORMAL"===semantic||"TANGENT"===semantic)for(transform.invertTo3x3(mat3),mat3.transpose(),j=0;j<totalComponents;j+=stream.numComponents)vec.set(subarray[j],subarray[j+1],subarray[j+2]),mat3.transformVector(vec,vec),subarray[j]=vec.x,subarray[j+1]=vec.y,subarray[j+2]=vec.z}if(dynamic)for(stream=streams.BLENDINDICES,j=0;j<numVerts;j++)stream.buffer[stream.count++]=i;if(mesh.primitive[0].indexed){indexBase=mesh.primitive[0].base,numIndices=mesh.primitive[0].count;var srcFormat=mesh.indexBuffer[0].getFormat();indexData=new typedArrayIndexFormats[srcFormat](mesh.indexBuffer[0].storage)}else{if(6!==mesh.primitive[0].type||4!==mesh.primitive[0].count){numIndices=0;continue}indexBase=0,numIndices=6,indexData=[0,1,3,2,3,1]}for(j=0;j<numIndices;j++)indices[j+indexOffset]=indexData[indexBase+j]+verticesOffset;indexOffset+=numIndices,verticesOffset+=numVerts}for(semantic in mesh=new Mesh(this.device),streams)stream=streams[semantic],mesh.setVertexStream(semantic,stream.buffer,stream.numComponents,void 0,stream.dataType,stream.normalize);indices.length>0&&mesh.setIndices(indices),mesh.update(4,!1),dynamic&&((material=material.clone()).chunks.transformVS=this.transformVS,material.chunks.skinTexVS=this.skinTexVS,material.chunks.skinConstVS=this.skinConstVS,material.update());var meshInstance=new MeshInstance(mesh,material,this.rootNode);meshInstance.castShadow=batch.origMeshInstances[0].castShadow,meshInstance.parameters=batch.origMeshInstances[0].parameters,meshInstance.isStatic=batch.origMeshInstances[0].isStatic,meshInstance.layer=batch.origMeshInstances[0].layer,meshInstance._staticLightList=batch.origMeshInstances[0]._staticLightList,meshInstance._shaderDefs=batch.origMeshInstances[0]._shaderDefs,meshInstance.cull=batch.origMeshInstances[0].cull;var batchGroup=this._batchGroups[batchGroupId];if(batchGroup&&batchGroup._ui&&(meshInstance.cull=!1),dynamic){var nodes=[];for(i=0;i<batch.origMeshInstances.length;i++)nodes.push(batch.origMeshInstances[i].node);meshInstance.skinInstance=new SkinBatchInstance(this.device,nodes,this.rootNode)}meshInstance._updateAabb=!1,meshInstance.drawOrder=batch.origMeshInstances[0].drawOrder,meshInstance.stencilFront=batch.origMeshInstances[0].stencilFront,meshInstance.stencilBack=batch.origMeshInstances[0].stencilBack,meshInstance.flipFaces=getScaleSign(batch.origMeshInstances[0])<0,batch.meshInstance=meshInstance,this.update(batch);var newModel=new Model;newModel.meshInstances=[batch.meshInstance],newModel.castShadows=batch.origMeshInstances[0].castShadows,batch.model=newModel}return batch},_proto.update=function update(batch){batch._aabb.copy(batch.origMeshInstances[0].aabb);for(var i=1;i<batch.origMeshInstances.length;i++)batch._aabb.add(batch.origMeshInstances[i].aabb);batch.meshInstance.aabb=batch._aabb,batch._aabb._radiusVer=-1,batch.meshInstance._aabbVer=0},_proto.updateAll=function updateAll(){this._dirtyGroups.length>0&&this.generate(this._dirtyGroups);for(var i=0;i<this._batchList.length;i++)this._batchList[i].dynamic&&this.update(this._batchList[i])},_proto.clone=function clone(batch,clonedMeshInstances){var batch2=new Batch(clonedMeshInstances,batch.dynamic,batch.batchGroupId);this._batchList.push(batch2);for(var nodes=[],i=0;i<clonedMeshInstances.length;i++)nodes.push(clonedMeshInstances[i].node);batch2.meshInstance=new MeshInstance(batch.meshInstance.mesh,batch.meshInstance.material,batch.meshInstance.node),batch2.meshInstance._updateAabb=!1,batch2.meshInstance.parameters=clonedMeshInstances[0].parameters,batch2.meshInstance.isStatic=clonedMeshInstances[0].isStatic,batch2.meshInstance.cull=clonedMeshInstances[0].cull,batch2.meshInstance.layer=clonedMeshInstances[0].layer,batch2.meshInstance._staticLightList=clonedMeshInstances[0]._staticLightList,batch.dynamic&&(batch2.meshInstance.skinInstance=new SkinBatchInstance(this.device,nodes,this.rootNode)),batch2.meshInstance.castShadow=batch.meshInstance.castShadow,batch2.meshInstance._shader=batch.meshInstance._shader;var newModel=new Model;return newModel.meshInstances=[batch2.meshInstance],newModel.castShadows=batch.origMeshInstances[0].castShadows,batch2.model=newModel,batch2},_proto.destroy=function destroy(batch){if(batch.model){for(var layers=this._batchGroups[batch.batchGroupId].layers,i=0;i<layers.length;i++){var layer=this.scene.layers.getLayerById(layers[i]);layer&&layer.removeMeshInstances(batch.model.meshInstances)}batch.model.destroy()}},BatchManager}(),_deviceCoord=new Vec3,_halfSize=new Vec3,_point=new Vec3,_invViewProjMat=new Mat4,Camera=function(){function Camera(){this._aspectRatio=16/9,this._aspectRatioMode=0,this._calculateProjection=null,this._calculateTransform=null,this._clearColor=new Color(.75,.75,.75,1),this._clearColorBuffer=!0,this._clearDepth=1,this._clearDepthBuffer=!0,this._clearStencil=0,this._clearStencilBuffer=!0,this._cullingMask=4294967295,this._cullFaces=!0,this._farClip=1e3,this._flipFaces=!1,this._fov=45,this._frustumCulling=!0,this._horizontalFov=!1,this._layers=[0,1,2,4,3],this._nearClip=.1,this._node=null,this._orthoHeight=10,this._projection=0,this._rect=new Vec4(0,0,1,1),this._renderTarget=null,this._scissorRect=new Vec4(0,0,1,1),this._vrDisplay=null,this._projMat=new Mat4,this._projMatDirty=!0,this._projMatSkybox=new Mat4,this._viewMat=new Mat4,this._viewMatDirty=!0,this._viewProjMat=new Mat4,this._viewProjMatDirty=!0,this.frustum=new Frustum}var _proto=Camera.prototype;return _proto.clone=function clone(){return(new Camera).copy(this)},_proto.copy=function copy(other){return this.aspectRatio=other.aspectRatio,this.aspectRatioMode=other.aspectRatioMode,this.calculateProjection=other.calculateProjection,this.calculateTransform=other.calculateTransform,this.clearColor=other.clearColor,this.clearColorBuffer=other.clearColorBuffer,this.clearDepth=other.clearDepth,this.clearDepthBuffer=other.clearDepthBuffer,this.clearStencil=other.clearStencil,this.clearStencilBuffer=other.clearStencilBuffer,this.cullFaces=other.cullFaces,this.cullingMask=other.cullingMask,this.farClip=other.farClip,this.flipFaces=other.flipFaces,this.fov=other.fov,this.frustumCulling=other.frustumCulling,this.horizontalFov=other.horizontalFov,this.layers=other.layers,this.nearClip=other.nearClip,this.orthoHeight=other.orthoHeight,this.projection=other.projection,this.rect=other.rect,this.renderTarget=other.renderTarget,this.scissorRect=other.scissorRect,this.vrDisplay=other.vrDisplay,this},_proto._updateViewProjMat=function _updateViewProjMat(){if(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty){var projMat=this.projectionMatrix,viewMat=this.viewMatrix;this._viewProjMat.mul2(projMat,viewMat),this._viewProjMatDirty=!1}},_proto.worldToScreen=function worldToScreen(worldCoord,cw,ch,screenCoord){void 0===screenCoord&&(screenCoord=new Vec3),this._updateViewProjMat(),this._viewProjMat.transformPoint(worldCoord,screenCoord);var vpm=this._viewProjMat.data,w=worldCoord.x*vpm[3]+worldCoord.y*vpm[7]+worldCoord.z*vpm[11]+1*vpm[15];return screenCoord.x=.5*(screenCoord.x/w+1)*cw,screenCoord.y=.5*(1-screenCoord.y/w)*ch,screenCoord},_proto.screenToWorld=function screenToWorld(x,y,z,cw,ch,worldCoord){void 0===worldCoord&&(worldCoord=new Vec3);var range=this._farClip-this._nearClip;if(_deviceCoord.set(x/cw,(ch-y)/ch,z/range),_deviceCoord.mulScalar(2),_deviceCoord.sub(Vec3.ONE),0===this._projection){Mat4._getPerspectiveHalfSize(_halfSize,this._fov,this._aspectRatio,this._nearClip,this._horizontalFov),_halfSize.x*=_deviceCoord.x,_halfSize.y*=_deviceCoord.y;var invView=this._node.getWorldTransform();_halfSize.z=-this._nearClip,invView.transformPoint(_halfSize,_point);var cameraPos=this._node.getPosition();worldCoord.sub2(_point,cameraPos),worldCoord.normalize(),worldCoord.mulScalar(z),worldCoord.add(cameraPos)}else this._updateViewProjMat(),_invViewProjMat.copy(this._viewProjMat).invert(),_invViewProjMat.transformPoint(_deviceCoord,worldCoord);return worldCoord},_proto._evaluateProjectionMatrix=function _evaluateProjectionMatrix(){if(this._projMatDirty){if(0===this._projection)this._projMat.setPerspective(this._fov,this._aspectRatio,this._nearClip,this._farClip,this._horizontalFov),this._projMatSkybox.copy(this._projMat);else{var y=this._orthoHeight,x=y*this._aspectRatio;this._projMat.setOrtho(-x,x,-y,y,this._nearClip,this._farClip),this._projMatSkybox.setPerspective(this._fov,this._aspectRatio,this._nearClip,this._farClip)}this._projMatDirty=!1}},_proto.getProjectionMatrixSkybox=function getProjectionMatrixSkybox(){return this._evaluateProjectionMatrix(),this._projMatSkybox},_createClass(Camera,[{key:"aspectRatio",get:function get(){return this._aspectRatio},set:function set(newValue){this._aspectRatio!==newValue&&(this._aspectRatio=newValue,this._projMatDirty=!0)}},{key:"aspectRatioMode",get:function get(){return this._aspectRatioMode},set:function set(newValue){this._aspectRatioMode!==newValue&&(this._aspectRatioMode=newValue,this._projMatDirty=!0)}},{key:"calculateProjection",get:function get(){return this._calculateProjection},set:function set(newValue){this._calculateProjection=newValue,this._projMatDirty=!0}},{key:"calculateTransform",get:function get(){return this._calculateTransform},set:function set(newValue){this._calculateTransform=newValue}},{key:"clearColor",get:function get(){return this._clearColor},set:function set(newValue){this._clearColor.copy(newValue)}},{key:"clearColorBuffer",get:function get(){return this._clearColorBuffer},set:function set(newValue){this._clearColorBuffer=newValue}},{key:"clearDepth",get:function get(){return this._clearDepth},set:function set(newValue){this._clearDepth=newValue}},{key:"clearDepthBuffer",get:function get(){return this._clearDepthBuffer},set:function set(newValue){this._clearDepthBuffer=newValue}},{key:"clearStencil",get:function get(){return this._clearStencil},set:function set(newValue){this._clearStencil=newValue}},{key:"clearStencilBuffer",get:function get(){return this._clearStencilBuffer},set:function set(newValue){this._clearStencilBuffer=newValue}},{key:"cullingMask",get:function get(){return this._cullingMask},set:function set(newValue){this._cullingMask=newValue}},{key:"cullFaces",get:function get(){return this._cullFaces},set:function set(newValue){this._cullFaces=newValue}},{key:"farClip",get:function get(){return this._farClip},set:function set(newValue){this._farClip!==newValue&&(this._farClip=newValue,this._projMatDirty=!0)}},{key:"flipFaces",get:function get(){return this._flipFaces},set:function set(newValue){this._flipFaces=newValue}},{key:"fov",get:function get(){return this._fov},set:function set(newValue){this._fov!==newValue&&(this._fov=newValue,this._projMatDirty=!0)}},{key:"frustumCulling",get:function get(){return this._frustumCulling},set:function set(newValue){this._frustumCulling=newValue}},{key:"horizontalFov",get:function get(){return this._horizontalFov},set:function set(newValue){this._horizontalFov!==newValue&&(this._horizontalFov=newValue,this._projMatDirty=!0)}},{key:"layers",get:function get(){return this._layers},set:function set(newValue){this._layers=newValue.slice(0)}},{key:"nearClip",get:function get(){return this._nearClip},set:function set(newValue){this._nearClip!==newValue&&(this._nearClip=newValue,this._projMatDirty=!0)}},{key:"node",get:function get(){return this._node},set:function set(newValue){this._node=newValue}},{key:"orthoHeight",get:function get(){return this._orthoHeight},set:function set(newValue){this._orthoHeight!==newValue&&(this._orthoHeight=newValue,this._projMatDirty=!0)}},{key:"projection",get:function get(){return this._projection},set:function set(newValue){this._projection!==newValue&&(this._projection=newValue,this._projMatDirty=!0)}},{key:"projectionMatrix",get:function get(){return this._evaluateProjectionMatrix(),this._projMat}},{key:"rect",get:function get(){return this._rect},set:function set(newValue){this._rect.copy(newValue)}},{key:"renderTarget",get:function get(){return this._renderTarget},set:function set(newValue){this._renderTarget=newValue}},{key:"scissorRect",get:function get(){return this._scissorRect},set:function set(newValue){this._scissorRect.copy(newValue)}},{key:"viewMatrix",get:function get(){if(this._viewMatDirty){var wtm=this._node.getWorldTransform();this._viewMat.copy(wtm).invert(),this._viewMatDirty=!1}return this._viewMat}},{key:"vrDisplay",get:function get(){return this._vrDisplay},set:function set(newValue){this._vrDisplay=newValue,newValue&&(newValue._camera=this)}}]),Camera}(),DepthMaterial=function(_Material){function DepthMaterial(){return _Material.apply(this,arguments)||this}_inheritsLoose(DepthMaterial,_Material);var _proto=DepthMaterial.prototype;return _proto.clone=function clone(){var clone=new DepthMaterial;return Material.prototype._cloneInternal.call(this,clone),clone},_proto.updateShader=function updateShader(device){var options={skin:!!this.meshInstances[0].skinInstance},library=device.getProgramLibrary();this.shader=library.getProgram("depth",options)},DepthMaterial}(Material),ShadowMap=function(){function ShadowMap(texture,targets){this.texture=texture,this.cached=!1,this.renderTargets=targets}var _proto;return ShadowMap.prototype.destroy=function destroy(){this.texture&&(this.texture.destroy(),this.texture=null);for(var targets=this.renderTargets,i=0;i<targets.length;i++)targets[i].destroy();this.renderTargets.length=0},ShadowMap.getShadowFormat=function getShadowFormat(device,shadowType){return 3===shadowType?14:2===shadowType?12:4===shadowType?16:0===shadowType&&device.webgl2?16:7},ShadowMap.getShadowFiltering=function getShadowFiltering(device,shadowType){return 0!==shadowType||device.webgl2?3===shadowType?device.extTextureFloatLinear?1:0:2===shadowType?device.extTextureHalfFloatLinear?1:0:1:0},ShadowMap.create=function create(device,light){var shadowMap=null;return shadowMap=1===light._type?this.createCubemap(device,light._shadowResolution):this.create2dMap(device,light._shadowResolution,light._shadowType)},ShadowMap.create2dMap=function create2dMap(device,size,shadowType){var format=this.getShadowFormat(device,shadowType),filter=this.getShadowFiltering(device,shadowType),texture=new Texture(device,{format:format,width:size,height:size,mipmaps:!1,minFilter:filter,magFilter:filter,addressU:1,addressV:1});texture.name="ShadowMap2D";var target=null;return 4===shadowType||0===shadowType&&device.webgl2?(texture.compareOnRead=!0,texture.compareFunc=1,target=new RenderTarget({depthBuffer:texture})):target=new RenderTarget({colorBuffer:texture,depth:!0}),new ShadowMap(texture,[target])},ShadowMap.createCubemap=function createCubemap(device,size){var cubemap=new Texture(device,{format:7,width:size,height:size,cubemap:!0,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});cubemap.name="ShadowMapCube";for(var targets=[],i=0;i<6;i++){var target=new RenderTarget({colorBuffer:cubemap,face:i,depth:!0});targets.push(target)}return new ShadowMap(cubemap,targets)},ShadowMap}(),ShadowMapCache=function(){function ShadowMapCache(){this.shadowMapCache=new Map}var _proto=ShadowMapCache.prototype;return _proto.destroy=function destroy(){this.clear(),this.shadowMapCache=null},_proto.clear=function clear(){this.shadowMapCache.forEach((function(shadowMaps){shadowMaps.forEach((function(shadowMap){shadowMap.destroy()}))})),this.shadowMapCache.clear()},_proto.getKey=function getKey(light){var isCubeMap,shadowType,resolution;return(1===light._type)+"-"+light._shadowType+"-"+light._shadowResolution},_proto.get=function get(device,light){var key=this.getKey(light),shadowMaps=this.shadowMapCache.get(key);if(shadowMaps&&shadowMaps.length)return shadowMaps.pop();var shadowMap=ShadowMap.create(device,light);return shadowMap.cached=!0,shadowMap},_proto.add=function add(light,shadowMap){var key=this.getKey(light),shadowMaps=this.shadowMapCache.get(key);shadowMaps?shadowMaps.push(shadowMap):this.shadowMapCache.set(key,[shadowMap])},ShadowMapCache}(),pointLightRotations=[(new Quat).setFromEulerAngles(0,90,180),(new Quat).setFromEulerAngles(0,-90,180),(new Quat).setFromEulerAngles(90,0,0),(new Quat).setFromEulerAngles(-90,0,0),(new Quat).setFromEulerAngles(0,180,180),(new Quat).setFromEulerAngles(0,0,180)],aabbPoints=[new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3],_depthRange={min:0,max:0};function getDepthRange(cameraViewMatrix,aabbMin,aabbMax){aabbPoints[0].x=aabbPoints[1].x=aabbPoints[2].x=aabbPoints[3].x=aabbMin.x,aabbPoints[1].y=aabbPoints[3].y=aabbPoints[7].y=aabbPoints[5].y=aabbMin.y,aabbPoints[2].z=aabbPoints[3].z=aabbPoints[6].z=aabbPoints[7].z=aabbMin.z,aabbPoints[4].x=aabbPoints[5].x=aabbPoints[6].x=aabbPoints[7].x=aabbMax.x,aabbPoints[0].y=aabbPoints[2].y=aabbPoints[4].y=aabbPoints[6].y=aabbMax.y,aabbPoints[0].z=aabbPoints[1].z=aabbPoints[4].z=aabbPoints[5].z=aabbMax.z;for(var minz=9999999999,maxz=-9999999999,i=0;i<8;++i){cameraViewMatrix.transformPoint(aabbPoints[i],aabbPoints[i]);var z=aabbPoints[i].z;z<minz&&(minz=z),z>maxz&&(maxz=z)}return _depthRange.min=minz,_depthRange.max=maxz,_depthRange}function gauss(x,sigma){return Math.exp(-x*x/(2*sigma*sigma))}var maxBlurSize=25;function gaussWeights(kernelSize){kernelSize>25&&(kernelSize=25);for(var sigma=(kernelSize-1)/6,halfWidth=.5*(kernelSize-1),values=new Array(kernelSize),sum=0,i=0;i<kernelSize;++i)values[i]=gauss(i-halfWidth,sigma),sum+=values[i];for(var _i=0;_i<kernelSize;++_i)values[_i]/=sum;return values}var visibleSceneAabb=new BoundingBox,shadowCamView$1=new Mat4,shadowCamViewProj$1=new Mat4,pixelOffset=new Float32Array(2),blurScissorRect={x:1,y:1,z:0,w:0},opChanId={r:1,g:2,b:3,a:4},center=new Vec3,viewportMatrix=new Mat4;function getDepthKey(meshInstance){var material=meshInstance.material,x=meshInstance.skinInstance?10:0,y=0;if(material.opacityMap){var opChan=material.opacityMapChannel;opChan&&(y=opChanId[opChan])}return x+y}var ShadowRenderer=function(){function ShadowRenderer(forwardRenderer){this.device=forwardRenderer.device,this.forwardRenderer=forwardRenderer;var scope=this.device.scope;this.sourceId=scope.resolve("source"),this.pixelOffsetId=scope.resolve("pixelOffset"),this.weightId=scope.resolve("weight[0]"),this.blurVsmShaderCode=[shaderChunks.blurVSMPS,"#define GAUSS\n"+shaderChunks.blurVSMPS];var packed="#define PACKED\n";this.blurPackedVsmShaderCode=[packed+this.blurVsmShaderCode[0],packed+this.blurVsmShaderCode[1]],this.blurVsmShader=[{},{}],this.blurPackedVsmShader=[{},{}],this.blurVsmWeights={},this.shadowMapLightRadiusId=scope.resolve("light_radius"),this.shadowMapCache=new ShadowMapCache}var _proto=ShadowRenderer.prototype;return _proto.destroy=function destroy(){this.shadowMapCache.destroy(),this.shadowMapCache=null},ShadowRenderer.createShadowCamera=function createShadowCamera(device,shadowType,type,face){var shadowCam=new Camera;switch(shadowCam.node=new GraphNode("ShadowCamera"),shadowCam.aspectRatio=1,type){case 1:shadowCam.node.setRotation(pointLightRotations[face]),shadowCam.fov=90,shadowCam.projection=0;break;case 2:shadowCam.projection=0;break;case 0:shadowCam.projection=1}var hwPcf=4===shadowType||0===shadowType&&device.webgl2;return 1===type&&(hwPcf=!1),shadowCam.clearColor=shadowType>=1&&shadowType<=3?new Color(0,0,0,0):new Color(1,1,1,1),shadowCam.clearColorBuffer=!hwPcf,shadowCam.clearDepthBuffer=!0,shadowCam.clearStencilBuffer=!1,shadowCam},_proto.cullShadowCasters=function cullShadowCasters(meshInstances,visible,camera){for(var count=0,numInstances=meshInstances.length,i=0;i<numInstances;i++){var meshInstance=meshInstances[i];meshInstance.cull&&!meshInstance._isVisible(camera)||(meshInstance.visibleThisFrame=!0,visible[count]=meshInstance,count++)}visible.length=count,visible.sort(this.forwardRenderer.depthSortCompare)},_proto.cullLocal=function cullLocal(light,drawCalls){light.visibleThisFrame=!0,light._shadowMap||(light._shadowMap=ShadowMap.create(this.device,light));for(var type=light._type,faceCount=2===type?1:6,face=0;face<faceCount;face++){var lightRenderData=light.getRenderData(null,face),shadowCam=lightRenderData.shadowCamera;shadowCam.nearClip=light.attenuationEnd/1e3,shadowCam.farClip=light.attenuationEnd;var shadowCamNode=shadowCam._node,lightNode=light._node;shadowCamNode.setPosition(lightNode.getPosition()),2===type&&(shadowCam.fov=2*light._outerConeAngle,shadowCamNode.setRotation(lightNode.getRotation()),shadowCamNode.rotateLocal(-90,0,0)),shadowCam.renderTarget=light._shadowMap.renderTargets[face],this.forwardRenderer.updateCameraFrustum(shadowCam),this.cullShadowCasters(drawCalls,lightRenderData.visibleCasters,shadowCam)}},_proto.generateSplitDistances=function generateSplitDistances(light,nearDist,farDist){light._shadowCascadeDistances.fill(farDist);for(var i=1;i<light.numCascades;i++){var fraction=i/light.numCascades,linearDist=nearDist+(farDist-nearDist)*fraction,logDist=nearDist*Math.pow(farDist/nearDist,fraction),dist=math.lerp(linearDist,logDist,light.cascadeDistribution);light._shadowCascadeDistances[i-1]=dist}},_proto.cullDirectional=function cullDirectional(light,drawCalls,camera){light.visibleThisFrame=!0,light._shadowMap||(light._shadowMap=ShadowMap.create(this.device,light));var nearDist=camera._nearClip;this.generateSplitDistances(light,nearDist,light.shadowDistance);for(var cascade=0;cascade<light.numCascades;cascade++){var lightRenderData=light.getRenderData(camera,cascade),shadowCam=lightRenderData.shadowCamera;shadowCam.renderTarget=light._shadowMap.renderTargets[0];var shadowCamNode=shadowCam._node,lightNode=light._node;shadowCamNode.setPosition(lightNode.getPosition()),shadowCamNode.setRotation(lightNode.getRotation()),shadowCamNode.rotateLocal(-90,0,0);var frustumNearDist=0===cascade?nearDist:light._shadowCascadeDistances[cascade-1],frustumFarDist=light._shadowCascadeDistances[cascade],frustumPoints=Frustum.getPoints(camera,frustumNearDist,frustumFarDist);center.set(0,0,0);for(var cameraWorldMat=camera.node.getWorldTransform(),i=0;i<8;i++)cameraWorldMat.transformPoint(frustumPoints[i],frustumPoints[i]),center.add(frustumPoints[i]);center.mulScalar(1/8);for(var radius=0,_i2=0;_i2<8;_i2++){var dist=frustumPoints[_i2].sub(center).length();dist>radius&&(radius=dist)}var right=shadowCamNode.right,up=shadowCamNode.up,lightDir=shadowCamNode.forward,sizeRatio=.25*light._shadowResolution/radius,x=Math.ceil(center.dot(up)*sizeRatio)/sizeRatio,y=Math.ceil(center.dot(right)*sizeRatio)/sizeRatio,scaledUp=up.mulScalar(x),scaledRight=right.mulScalar(y),dot=center.dot(lightDir),scaledDir=lightDir.mulScalar(dot);center.add2(scaledUp,scaledRight).add(scaledDir),shadowCamNode.setPosition(center),shadowCamNode.translateLocal(0,0,1e6),shadowCam.nearClip=0,shadowCam.farClip=2e6,shadowCam.orthoHeight=radius,this.forwardRenderer.updateCameraFrustum(shadowCam),this.cullShadowCasters(drawCalls,lightRenderData.visibleCasters,shadowCam);for(var emptyAabb=!0,visibleCasters=lightRenderData.visibleCasters,_i3=0;_i3<visibleCasters.length;_i3++){var meshInstance=visibleCasters[_i3];emptyAabb?(emptyAabb=!1,visibleSceneAabb.copy(meshInstance.aabb)):visibleSceneAabb.add(meshInstance.aabb)}shadowCamView$1.copy(shadowCamNode.getWorldTransform()).invert();var depthRange=getDepthRange(shadowCamView$1,visibleSceneAabb.getMin(),visibleSceneAabb.getMax());shadowCamNode.translateLocal(0,0,depthRange.max+.1),shadowCam.farClip=depthRange.max-depthRange.min+.2}},_proto.setupRenderState=function setupRenderState(device,light){if(device.webgl2)1===light._type?device.setDepthBias(!1):(device.setDepthBias(!0),device.setDepthBiasValues(-1e3*light.shadowBias,-1e3*light.shadowBias));else if(device.extStandardDerivatives){var forwardRenderer=this.forwardRenderer;1===light._type?(forwardRenderer.polygonOffset[0]=0,forwardRenderer.polygonOffset[1]=0,forwardRenderer.polygonOffsetId.setValue(forwardRenderer.polygonOffset)):(forwardRenderer.polygonOffset[0]=-1e3*light.shadowBias,forwardRenderer.polygonOffset[1]=-1e3*light.shadowBias,forwardRenderer.polygonOffsetId.setValue(forwardRenderer.polygonOffset))}device.setBlending(!1),device.setDepthWrite(!0),device.setDepthTest(!0),light._isPcf&&device.webgl2&&1!==light._type?device.setColorWrite(!1,!1,!1,!1):device.setColorWrite(!0,!0,!0,!0)},_proto.dispatchUniforms=function dispatchUniforms(light,shadowCam,lightRenderData,face){var shadowCamNode=shadowCam._node;if(0!==light._type&&(this.forwardRenderer.dispatchViewPos(shadowCamNode.getPosition()),this.shadowMapLightRadiusId.setValue(light.attenuationEnd)),1!==light._type)if(shadowCamView$1.setTRS(shadowCamNode.getPosition(),shadowCamNode.getRotation(),Vec3.ONE).invert(),shadowCamViewProj$1.mul2(shadowCam.projectionMatrix,shadowCamView$1),0===light._type){var rect=light.cascades[face];shadowCam.rect=rect,shadowCam.scissorRect=rect,viewportMatrix.setViewport(rect.x,rect.y,rect.z,rect.w),lightRenderData.shadowMatrix.mul2(viewportMatrix,shadowCamViewProj$1),light._shadowMatrixPalette.set(lightRenderData.shadowMatrix.data,16*face)}else lightRenderData.shadowMatrix.mul2(ShadowRenderer.scaleShiftMatrix,shadowCamViewProj$1)},_proto.submitCasters=function submitCasters(visibleCasters,light){for(var device=this.device,forwardRenderer=this.forwardRenderer,shadowPass=8,shadowType,smode=light._shadowType+5*light._type,count=visibleCasters.length,i=0;i<count;i++){var meshInstance=visibleCasters[i],mesh=meshInstance.mesh,material=meshInstance.material;forwardRenderer.setBaseConstants(device,material),forwardRenderer.setSkinning(device,meshInstance,material),material.dirty&&(material.updateUniforms(),material.dirty=!1),material.chunks&&(forwardRenderer.setCullMode(!0,!1,meshInstance),material.setParameters(device),meshInstance.setParameters(device,8));var shadowShader=meshInstance._shader[3+smode];shadowShader||(forwardRenderer.updateShader(meshInstance,meshInstance._shaderDefs,null,3+smode),shadowShader=meshInstance._shader[3+smode],meshInstance._key[1]=getDepthKey(meshInstance)),device.setShader(shadowShader),forwardRenderer.setVertexBuffers(device,mesh),forwardRenderer.setMorphing(device,meshInstance.morphInstance);var style=meshInstance.renderStyle;device.setIndexBuffer(mesh.indexBuffer[style]),i+=forwardRenderer.drawInstance(device,meshInstance,mesh,style),forwardRenderer._shadowDrawCalls++}},_proto.render=function render(light,camera){if(light.enabled&&light.castShadows&&0!==light.shadowUpdateMode&&light.visibleThisFrame){var device=this.device;1===light.shadowUpdateMode&&(light.shadowUpdateMode=0);var faceCount=1,type=light._type;0===type?faceCount=light.numCascades:1===type&&(faceCount=6);var forwardRenderer=this.forwardRenderer;forwardRenderer._shadowMapUpdates+=faceCount,this.setupRenderState(device,light);for(var face=0;face<faceCount;face++){var lightRenderData=light.getRenderData(0===type?camera:null,face),shadowCam=lightRenderData.shadowCamera;this.dispatchUniforms(light,shadowCam,lightRenderData,face),forwardRenderer.setCamera(shadowCam,shadowCam.renderTarget,!0,1===faceCount),this.submitCasters(lightRenderData.visibleCasters,light)}light._isVsm&&light._vsmBlurSize>1&&this.applyVsmBlur(light,camera)}},_proto.getVsmBlurShader=function getVsmBlurShader(isVsm8,blurMode,filterSize){var blurShader=(isVsm8?this.blurPackedVsmShader:this.blurVsmShader)[blurMode][filterSize];if(!blurShader){this.blurVsmWeights[filterSize]=gaussWeights(filterSize);var blurVS=shaderChunks.fullscreenQuadVS,blurFS="#define SAMPLES "+filterSize+"\n";blurFS+=isVsm8?this.blurPackedVsmShaderCode[blurMode]:this.blurVsmShaderCode[blurMode];var blurShaderName="blurVsm"+blurMode+filterSize+isVsm8;blurShader=createShaderFromCode(this.device,blurVS,blurFS,blurShaderName),isVsm8?this.blurPackedVsmShader[blurMode][filterSize]=blurShader:this.blurVsmShader[blurMode][filterSize]=blurShader}return blurShader},_proto.applyVsmBlur=function applyVsmBlur(light,camera){var device=this.device,lightRenderData,shadowCam,origShadowMap=light.getRenderData(0===light._type?camera:null,0).shadowCamera.renderTarget,tempShadowMap=this.shadowMapCache.get(device,light),tempRt=tempShadowMap.renderTargets[0],isVsm8=1===light._shadowType,blurMode=light.vsmBlurMode,filterSize=light._vsmBlurSize,blurShader=this.getVsmBlurShader(isVsm8,blurMode,filterSize);blurScissorRect.z=light._shadowResolution-2,blurScissorRect.w=blurScissorRect.z,this.sourceId.setValue(origShadowMap.colorBuffer),pixelOffset[0]=1/light._shadowResolution,pixelOffset[1]=0,this.pixelOffsetId.setValue(pixelOffset),1===blurMode&&this.weightId.setValue(this.blurVsmWeights[filterSize]),drawQuadWithShader(device,tempRt,blurShader,null,blurScissorRect),this.sourceId.setValue(tempRt.colorBuffer),pixelOffset[1]=pixelOffset[0],pixelOffset[0]=0,this.pixelOffsetId.setValue(pixelOffset),drawQuadWithShader(device,origShadowMap,blurShader,null,blurScissorRect),this.shadowMapCache.add(light,tempShadowMap)},ShadowRenderer}();ShadowRenderer.scaleShiftMatrix=(new Mat4).setViewport(0,0,1,1);var shadowCamView=new Mat4,shadowCamViewProj=new Mat4,viewInvMat=new Mat4,viewMat=new Mat4,viewMat3=new Mat3,viewProjMat=new Mat4,projMat,viewInvL=new Mat4,viewInvR=new Mat4,viewL=new Mat4,viewR=new Mat4,viewPosL=new Vec3,viewPosR=new Vec3,projL,projR,viewMat3L=new Mat3,viewMat3R=new Mat3,viewProjMatL=new Mat4,viewProjMatR=new Mat4,worldMatX=new Vec3,worldMatY=new Vec3,worldMatZ=new Vec3,tempSphere$1=new BoundingSphere,boneTextureSize=[0,0,0,0],boneTexture,instancingData,modelMatrix,normalMatrix,keyA$1,keyB$1,_autoInstanceBuffer=null,_skinUpdateIndex=0,_tempMaterialSet=new Set,ForwardRenderer=function(){function ForwardRenderer(graphicsDevice){this.device=graphicsDevice;var device=this.device;this._shadowDrawCalls=0,this._forwardDrawCalls=0,this._skinDrawCalls=0,this._camerasRendered=0,this._materialSwitches=0,this._shadowMapUpdates=0,this._shadowMapTime=0,this._depthMapTime=0,this._forwardTime=0,this._cullTime=0,this._sortTime=0,this._skinTime=0,this._morphTime=0,this._instancingTime=0,this._layerCompositionUpdateTime=0,this._lightClustersTime=0,this._lightClusters=0;var library=device.getProgramLibrary();this.library=library,this._shadowRenderer=new ShadowRenderer(this);var scope=device.scope;this.projId=scope.resolve("matrix_projection"),this.projSkyboxId=scope.resolve("matrix_projectionSkybox"),this.viewId=scope.resolve("matrix_view"),this.viewId3=scope.resolve("matrix_view3"),this.viewInvId=scope.resolve("matrix_viewInverse"),this.viewProjId=scope.resolve("matrix_viewProjection"),this.viewPos=new Float32Array(3),this.viewPosId=scope.resolve("view_position"),this.nearClipId=scope.resolve("camera_near"),this.farClipId=scope.resolve("camera_far"),this.cameraParamsId=scope.resolve("camera_params"),this.fogColorId=scope.resolve("fog_color"),this.fogStartId=scope.resolve("fog_start"),this.fogEndId=scope.resolve("fog_end"),this.fogDensityId=scope.resolve("fog_density"),this.modelMatrixId=scope.resolve("matrix_model"),this.normalMatrixId=scope.resolve("matrix_normal"),this.poseMatrixId=scope.resolve("matrix_pose[0]"),this.boneTextureId=scope.resolve("texture_poseMap"),this.boneTextureSizeId=scope.resolve("texture_poseMapSize"),this.morphWeightsA=scope.resolve("morph_weights_a"),this.morphWeightsB=scope.resolve("morph_weights_b"),this.morphPositionTex=scope.resolve("morphPositionTex"),this.morphNormalTex=scope.resolve("morphNormalTex"),this.morphTexParams=scope.resolve("morph_tex_params"),this.alphaTestId=scope.resolve("alpha_ref"),this.opacityMapId=scope.resolve("texture_opacityMap"),this.ambientId=scope.resolve("light_globalAmbient"),this.exposureId=scope.resolve("exposure"),this.skyboxIntensityId=scope.resolve("skyboxIntensity"),this.lightColorId=[],this.lightDir=[],this.lightDirId=[],this.lightShadowMapId=[],this.lightShadowMatrixId=[],this.lightShadowParamsId=[],this.lightRadiusId=[],this.lightPos=[],this.lightPosId=[],this.lightWidth=[],this.lightWidthId=[],this.lightHeight=[],this.lightHeightId=[],this.lightInAngleId=[],this.lightOutAngleId=[],this.lightCookieId=[],this.lightCookieIntId=[],this.lightCookieMatrixId=[],this.lightCookieOffsetId=[],this.shadowMatrixPaletteId=[],this.shadowCascadeDistancesId=[],this.shadowCascadeCountId=[],this.depthMapId=scope.resolve("uDepthMap"),this.screenSizeId=scope.resolve("uScreenSize"),this._screenSize=new Float32Array(4),this.twoSidedLightingNegScaleFactorId=scope.resolve("twoSidedLightingNegScaleFactor"),this.polygonOffsetId=scope.resolve("polygonOffset"),this.polygonOffset=new Float32Array(2),this.fogColor=new Float32Array(3),this.ambientColor=new Float32Array(3),this.cameraParams=new Float32Array(4)}var _proto=ForwardRenderer.prototype;return _proto.destroy=function destroy(){this._shadowRenderer.destroy(),this._shadowRenderer=null},ForwardRenderer.getSpotCookieCamera=function getSpotCookieCamera(){return this.spotCookieCamera||(this.spotCookieCamera=new Camera,this.spotCookieCamera.projection=0,this.spotCookieCamera.aspectRatio=1,this.spotCookieCamera.node=new GraphNode),this.spotCookieCamera},_proto.sortCompare=function sortCompare(drawCallA,drawCallB){if(drawCallA.layer===drawCallB.layer){if(drawCallA.drawOrder&&drawCallB.drawOrder)return drawCallA.drawOrder-drawCallB.drawOrder;if(drawCallA.zdist&&drawCallB.zdist)return drawCallB.zdist-drawCallA.zdist;if(drawCallA.zdist2&&drawCallB.zdist2)return drawCallA.zdist2-drawCallB.zdist2}return drawCallB._key[0]-drawCallA._key[0]},_proto.sortCompareMesh=function sortCompareMesh(drawCallA,drawCallB){if(drawCallA.layer===drawCallB.layer){if(drawCallA.drawOrder&&drawCallB.drawOrder)return drawCallA.drawOrder-drawCallB.drawOrder;if(drawCallA.zdist&&drawCallB.zdist)return drawCallB.zdist-drawCallA.zdist}return keyA$1=drawCallA._key[0],keyB$1=drawCallB._key[0],keyA$1===keyB$1&&drawCallA.mesh&&drawCallB.mesh?drawCallB.mesh.id-drawCallA.mesh.id:keyB$1-keyA$1},_proto.depthSortCompare=function depthSortCompare(drawCallA,drawCallB){return keyA$1=drawCallA._key[1],keyB$1=drawCallB._key[1],keyA$1===keyB$1&&drawCallA.mesh&&drawCallB.mesh?drawCallB.mesh.id-drawCallA.mesh.id:keyB$1-keyA$1},_proto.lightCompare=function lightCompare(lightA,lightB){return lightA.key-lightB.key},_proto.updateCameraFrustum=function updateCameraFrustum(camera){if(camera.vrDisplay&&camera.vrDisplay.presenting){projMat=camera.vrDisplay.combinedProj;var parent=camera._node.parent;parent?viewMat.copy(parent.getWorldTransform()).mul(camera.vrDisplay.combinedViewInv).invert():viewMat.copy(camera.vrDisplay.combinedView),viewInvMat.copy(viewMat).invert(),this.viewInvId.setValue(viewInvMat.data),viewProjMat.mul2(projMat,viewMat),camera.frustum.setFromMat4(viewProjMat)}else if(camera.xr&&camera.xr.views.length){var view=camera.xr.views[0];return viewProjMat.mul2(view.projMat,view.viewOffMat),void camera.frustum.setFromMat4(viewProjMat)}if(projMat=camera.projectionMatrix,camera.calculateProjection&&camera.calculateProjection(projMat,0),camera.calculateTransform)camera.calculateTransform(viewInvMat,0);else{var pos=camera._node.getPosition(),rot=camera._node.getRotation();viewInvMat.setTRS(pos,rot,Vec3.ONE),this.viewInvId.setValue(viewInvMat.data)}viewMat.copy(viewInvMat).invert(),viewProjMat.mul2(projMat,viewMat),camera.frustum.setFromMat4(viewProjMat)},_proto.setCamera=function setCamera(camera,target,clear,cullBorder){var vrDisplay=camera.vrDisplay,parent,transform;if(vrDisplay&&vrDisplay.presenting)projL=vrDisplay.leftProj,projR=vrDisplay.rightProj,projMat=vrDisplay.combinedProj,camera.calculateProjection&&(camera.calculateProjection(projL,1),camera.calculateProjection(projR,2),camera.calculateProjection(projMat,0)),camera.calculateTransform?(camera.calculateTransform(viewInvL,1),camera.calculateTransform(viewInvR,2),camera.calculateTransform(viewInvMat,0),viewL.copy(viewInvL).invert(),viewR.copy(viewInvR).invert(),viewMat.copy(viewInvMat).invert()):(parent=camera._node.parent)?(transform=parent.getWorldTransform(),viewInvL.mul2(transform,vrDisplay.leftViewInv),viewInvR.mul2(transform,vrDisplay.rightViewInv),viewL.copy(viewInvL).invert(),viewR.copy(viewInvR).invert(),viewMat.copy(parent.getWorldTransform()).mul(vrDisplay.combinedViewInv).invert()):(viewInvL.copy(vrDisplay.leftViewInv),viewInvR.copy(vrDisplay.rightViewInv),viewL.copy(vrDisplay.leftView),viewR.copy(vrDisplay.rightView),viewMat.copy(vrDisplay.combinedView)),viewMat3L.setFromMat4(viewL),viewMat3R.setFromMat4(viewR),viewProjMatL.mul2(projL,viewL),viewProjMatR.mul2(projR,viewR),viewPosL.x=viewInvL.data[12],viewPosL.y=viewInvL.data[13],viewPosL.z=viewInvL.data[14],viewPosR.x=viewInvR.data[12],viewPosR.y=viewInvR.data[13],viewPosR.z=viewInvR.data[14],viewProjMat.mul2(projMat,viewMat),camera.frustum.setFromMat4(viewProjMat);else if(camera.xr&&camera.xr.session){(parent=camera._node.parent)&&(transform=parent.getWorldTransform());for(var views=camera.xr.views,v=0;v<views.length;v++){var view=views[v];parent?(view.viewInvOffMat.mul2(transform,view.viewInvMat),view.viewOffMat.copy(view.viewInvOffMat).invert()):(view.viewInvOffMat.copy(view.viewInvMat),view.viewOffMat.copy(view.viewMat)),view.viewMat3.setFromMat4(view.viewOffMat),view.projViewOffMat.mul2(view.projMat,view.viewOffMat),view.position[0]=view.viewInvOffMat.data[12],view.position[1]=view.viewInvOffMat.data[13],view.position[2]=view.viewInvOffMat.data[14],camera.frustum.setFromMat4(view.projViewOffMat)}}else{if(projMat=camera.projectionMatrix,camera.calculateProjection&&camera.calculateProjection(projMat,0),this.projId.setValue(projMat.data),this.projSkyboxId.setValue(camera.getProjectionMatrixSkybox().data),camera.calculateTransform)camera.calculateTransform(viewInvMat,0);else{var pos=camera._node.getPosition(),rot=camera._node.getRotation();viewInvMat.setTRS(pos,rot,Vec3.ONE)}this.viewInvId.setValue(viewInvMat.data),viewMat.copy(viewInvMat).invert(),this.viewId.setValue(viewMat.data),viewMat3.setFromMat4(viewMat),this.viewId3.setValue(viewMat3.data),viewProjMat.mul2(projMat,viewMat),this.viewProjId.setValue(viewProjMat.data),this.dispatchViewPos(camera._node.getPosition()),camera.frustum.setFromMat4(viewProjMat)}this.nearClipId.setValue(camera._nearClip),this.farClipId.setValue(camera._farClip);var n=camera._nearClip,f=camera._farClip;this.cameraParams[0]=1/f,this.cameraParams[1]=f,this.cameraParams[2]=.5*(1-f/n),this.cameraParams[3]=.5*(1+f/n),this.cameraParamsId.setValue(this.cameraParams),this.clearView(camera,target,clear,!1);var device=this.device,pixelWidth=target?target.width:device.width,pixelHeight=target?target.height:device.height,scissorRect=camera.scissorRect,x=Math.floor(scissorRect.x*pixelWidth),y=Math.floor(scissorRect.y*pixelHeight),w=Math.floor(scissorRect.z*pixelWidth),h=Math.floor(scissorRect.w*pixelHeight);device.setScissor(x,y,w,h),cullBorder&&device.setScissor(1,1,pixelWidth-2,pixelHeight-2)},_proto.clearView=function clearView(camera,target,clear,forceWrite,options){var device=this.device;device.setRenderTarget(target),device.updateBegin(),forceWrite&&(device.setColorWrite(!0,!0,!0,!0),device.setDepthWrite(!0));var rect=camera.rect,pixelWidth=target?target.width:device.width,pixelHeight=target?target.height:device.height,x=Math.floor(rect.x*pixelWidth),y=Math.floor(rect.y*pixelHeight),w=Math.floor(rect.z*pixelWidth),h=Math.floor(rect.w*pixelHeight);device.setViewport(x,y,w,h),device.setScissor(x,y,w,h),clear&&(options||(options=camera._clearOptions),device.clear(options||{color:[camera._clearColor.r,camera._clearColor.g,camera._clearColor.b,camera._clearColor.a],depth:camera._clearDepth,flags:(camera._clearColorBuffer?1:0)|(camera._clearDepthBuffer?2:0)|(camera._clearStencilBuffer?4:0),stencil:camera._clearStencil}))},_proto.dispatchGlobalLights=function dispatchGlobalLights(scene){if(this.ambientColor[0]=scene.ambientLight.r,this.ambientColor[1]=scene.ambientLight.g,this.ambientColor[2]=scene.ambientLight.b,scene.gammaCorrection)for(var i=0;i<3;i++)this.ambientColor[i]=Math.pow(this.ambientColor[i],2.2);this.ambientId.setValue(this.ambientColor),this.exposureId.setValue(scene.exposure),scene.skyboxModel&&this.skyboxIntensityId.setValue(scene.skyboxIntensity)},_proto._resolveLight=function _resolveLight(scope,i){var light="light"+i;this.lightColorId[i]=scope.resolve(light+"_color"),this.lightDir[i]=new Float32Array(3),this.lightDirId[i]=scope.resolve(light+"_direction"),this.lightShadowMapId[i]=scope.resolve(light+"_shadowMap"),this.lightShadowMatrixId[i]=scope.resolve(light+"_shadowMatrix"),this.lightShadowParamsId[i]=scope.resolve(light+"_shadowParams"),this.lightRadiusId[i]=scope.resolve(light+"_radius"),this.lightPos[i]=new Float32Array(3),this.lightPosId[i]=scope.resolve(light+"_position"),this.lightWidth[i]=new Float32Array(3),this.lightWidthId[i]=scope.resolve(light+"_halfWidth"),this.lightHeight[i]=new Float32Array(3),this.lightHeightId[i]=scope.resolve(light+"_halfHeight"),this.lightInAngleId[i]=scope.resolve(light+"_innerConeAngle"),this.lightOutAngleId[i]=scope.resolve(light+"_outerConeAngle"),this.lightCookieId[i]=scope.resolve(light+"_cookie"),this.lightCookieIntId[i]=scope.resolve(light+"_cookieIntensity"),this.lightCookieMatrixId[i]=scope.resolve(light+"_cookieMatrix"),this.lightCookieOffsetId[i]=scope.resolve(light+"_cookieOffset"),this.shadowMatrixPaletteId[i]=scope.resolve(light+"_shadowMatrixPalette[0]"),this.shadowCascadeDistancesId[i]=scope.resolve(light+"_shadowCascadeDistances[0]"),this.shadowCascadeCountId[i]=scope.resolve(light+"_shadowCascadeCount")},_proto.setLTCDirectionallLight=function setLTCDirectionallLight(wtm,cnt,dir,campos,far){this.lightPos[cnt][0]=campos.x-dir.x*far,this.lightPos[cnt][1]=campos.y-dir.y*far,this.lightPos[cnt][2]=campos.z-dir.z*far,this.lightPosId[cnt].setValue(this.lightPos[cnt]);var hWidth=wtm.transformVector(new Vec3(-.5,0,0));this.lightWidth[cnt][0]=hWidth.x*far,this.lightWidth[cnt][1]=hWidth.y*far,this.lightWidth[cnt][2]=hWidth.z*far,this.lightWidthId[cnt].setValue(this.lightWidth[cnt]);var hHeight=wtm.transformVector(new Vec3(0,0,.5));this.lightHeight[cnt][0]=hHeight.x*far,this.lightHeight[cnt][1]=hHeight.y*far,this.lightHeight[cnt][2]=hHeight.z*far,this.lightHeightId[cnt].setValue(this.lightHeight[cnt])},_proto.dispatchDirectLights=function dispatchDirectLights(dirs,scene,mask,camera){var numDirs=dirs.length,i,directional,wtm,cnt=0,scope=this.device.scope;for(i=0;i<numDirs;i++)if(dirs[i].mask&mask){if(wtm=(directional=dirs[i])._node.getWorldTransform(),this.lightColorId[cnt]||this._resolveLight(scope,cnt),this.lightColorId[cnt].setValue(scene.gammaCorrection?directional._linearFinalColor:directional._finalColor),wtm.getY(directional._direction).mulScalar(-1),directional._direction.normalize(),this.lightDir[cnt][0]=directional._direction.x,this.lightDir[cnt][1]=directional._direction.y,this.lightDir[cnt][2]=directional._direction.z,this.lightDirId[cnt].setValue(this.lightDir[cnt]),0!==directional.shape&&this.setLTCDirectionallLight(wtm,cnt,directional._direction,camera._node.getPosition(),camera.farClip),directional.castShadows){var lightRenderData=directional.getRenderData(camera,0),farClip=lightRenderData.shadowCamera._farClip,bias=void 0;directional._isVsm?bias=-2e-4:(bias=directional.shadowBias/farClip*100,!this.device.webgl2&&this.device.extStandardDerivatives&&(bias*=-100));var normalBias=directional._isVsm?directional.vsmBias/(farClip/7):directional._normalOffsetBias;this.lightShadowMapId[cnt].setValue(lightRenderData.shadowBuffer),this.lightShadowMatrixId[cnt].setValue(lightRenderData.shadowMatrix.data),this.shadowMatrixPaletteId[cnt].setValue(directional._shadowMatrixPalette),this.shadowCascadeDistancesId[cnt].setValue(directional._shadowCascadeDistances),this.shadowCascadeCountId[cnt].setValue(directional.numCascades);var params=directional._shadowRenderParams;params.length=3,params[0]=directional._shadowResolution,params[1]=normalBias,params[2]=bias,this.lightShadowParamsId[cnt].setValue(params)}cnt++}return cnt},_proto.setLTCPositionalLight=function setLTCPositionalLight(wtm,cnt){var hWidth=wtm.transformVector(new Vec3(-.5,0,0));this.lightWidth[cnt][0]=hWidth.x,this.lightWidth[cnt][1]=hWidth.y,this.lightWidth[cnt][2]=hWidth.z,this.lightWidthId[cnt].setValue(this.lightWidth[cnt]);var hHeight=wtm.transformVector(new Vec3(0,0,.5));this.lightHeight[cnt][0]=hHeight.x,this.lightHeight[cnt][1]=hHeight.y,this.lightHeight[cnt][2]=hHeight.z,this.lightHeightId[cnt].setValue(this.lightHeight[cnt])},_proto.dispatchOmniLight=function dispatchOmniLight(scene,scope,omni,cnt){var wtm=omni._node.getWorldTransform();if(this.lightColorId[cnt]||this._resolveLight(scope,cnt),this.lightRadiusId[cnt].setValue(omni.attenuationEnd),this.lightColorId[cnt].setValue(scene.gammaCorrection?omni._linearFinalColor:omni._finalColor),wtm.getTranslation(omni._position),this.lightPos[cnt][0]=omni._position.x,this.lightPos[cnt][1]=omni._position.y,this.lightPos[cnt][2]=omni._position.z,this.lightPosId[cnt].setValue(this.lightPos[cnt]),0!==omni.shape&&this.setLTCPositionalLight(wtm,cnt),omni.castShadows){var lightRenderData=omni.getRenderData(null,0);this.lightShadowMapId[cnt].setValue(lightRenderData.shadowBuffer);var params=omni._shadowRenderParams;params.length=4,params[0]=omni._shadowResolution,params[1]=omni._normalOffsetBias,params[2]=omni.shadowBias,params[3]=1/omni.attenuationEnd,this.lightShadowParamsId[cnt].setValue(params)}omni._cookie&&(this.lightCookieId[cnt].setValue(omni._cookie),this.lightShadowMatrixId[cnt].setValue(wtm.data),this.lightCookieIntId[cnt].setValue(omni.cookieIntensity))},_proto.dispatchSpotLight=function dispatchSpotLight(scene,scope,spot,cnt){var wtm=spot._node.getWorldTransform(),cookieMatrix;if(this.lightColorId[cnt]||this._resolveLight(scope,cnt),this.lightInAngleId[cnt].setValue(spot._innerConeAngleCos),this.lightOutAngleId[cnt].setValue(spot._outerConeAngleCos),this.lightRadiusId[cnt].setValue(spot.attenuationEnd),this.lightColorId[cnt].setValue(scene.gammaCorrection?spot._linearFinalColor:spot._finalColor),wtm.getTranslation(spot._position),this.lightPos[cnt][0]=spot._position.x,this.lightPos[cnt][1]=spot._position.y,this.lightPos[cnt][2]=spot._position.z,this.lightPosId[cnt].setValue(this.lightPos[cnt]),0!==spot.shape&&this.setLTCPositionalLight(wtm,cnt),wtm.getY(spot._direction).mulScalar(-1),spot._direction.normalize(),this.lightDir[cnt][0]=spot._direction.x,this.lightDir[cnt][1]=spot._direction.y,this.lightDir[cnt][2]=spot._direction.z,this.lightDirId[cnt].setValue(this.lightDir[cnt]),spot.castShadows){var bias;spot._isVsm?bias=-2e-4:(bias=20*spot.shadowBias,!this.device.webgl2&&this.device.extStandardDerivatives&&(bias*=-100));var normalBias=spot._isVsm?spot.vsmBias/(spot.attenuationEnd/7):spot._normalOffsetBias,lightRenderData=spot.getRenderData(null,0);this.lightShadowMapId[cnt].setValue(lightRenderData.shadowBuffer),this.lightShadowMatrixId[cnt].setValue(lightRenderData.shadowMatrix.data);var params=spot._shadowRenderParams;params.length=4,params[0]=spot._shadowResolution,params[1]=normalBias,params[2]=bias,params[3]=1/spot.attenuationEnd,this.lightShadowParamsId[cnt].setValue(params),cookieMatrix=lightRenderData.shadowMatrix}if(spot._cookie){if(this.lightCookieId[cnt].setValue(spot._cookie),!spot.castShadows){var cookieCam=ForwardRenderer.getSpotCookieCamera();cookieCam.fov=2*spot._outerConeAngle;var cookieNode=cookieCam._node;cookieNode.setPosition(spot._node.getPosition()),cookieNode.setRotation(spot._node.getRotation()),cookieNode.rotateLocal(-90,0,0),shadowCamView.setTRS(cookieNode.getPosition(),cookieNode.getRotation(),Vec3.ONE).invert(),shadowCamViewProj.mul2(cookieCam.projectionMatrix,shadowCamView),(cookieMatrix=spot.cookieMatrix).mul2(ShadowRenderer.scaleShiftMatrix,shadowCamViewProj)}this.lightShadowMatrixId[cnt].setValue(cookieMatrix.data),this.lightCookieIntId[cnt].setValue(spot.cookieIntensity),spot._cookieTransform&&(spot._cookieTransformUniform[0]=spot._cookieTransform.x,spot._cookieTransformUniform[1]=spot._cookieTransform.y,spot._cookieTransformUniform[2]=spot._cookieTransform.z,spot._cookieTransformUniform[3]=spot._cookieTransform.w,this.lightCookieMatrixId[cnt].setValue(spot._cookieTransformUniform),spot._cookieOffsetUniform[0]=spot._cookieOffset.x,spot._cookieOffsetUniform[1]=spot._cookieOffset.y,this.lightCookieOffsetId[cnt].setValue(spot._cookieOffsetUniform))}},_proto.dispatchLocalLights=function dispatchLocalLights(sortedLights,scene,mask,usedDirLights,staticLightList){var i,omni,spot,omnis=sortedLights[1],spts=sortedLights[2],numDirs=usedDirLights,numOmnis=omnis.length,numSpts=spts.length,cnt=numDirs,scope=this.device.scope;for(i=0;i<numOmnis;i++)(omni=omnis[i]).mask&mask&&(omni.isStatic||(this.dispatchOmniLight(scene,scope,omni,cnt),cnt++));var staticId=0;if(staticLightList)for(omni=staticLightList[staticId];omni&&1===omni._type;)this.dispatchOmniLight(scene,scope,omni,cnt),cnt++,omni=staticLightList[++staticId];for(i=0;i<numSpts;i++)(spot=spts[i]).mask&mask&&(spot.isStatic||(this.dispatchSpotLight(scene,scope,spot,cnt),cnt++));if(staticLightList)for(spot=staticLightList[staticId];spot&&2===spot._type;)this.dispatchSpotLight(scene,scope,spot,cnt),cnt++,spot=staticLightList[++staticId]},_proto.cull=function cull(camera,drawCalls,visibleList){var visibleLength=0,i,drawCall,visible,drawCallsCount=drawCalls.length,cullingMask=camera.cullingMask||4294967295;if(!camera.frustumCulling){for(i=0;i<drawCallsCount;i++)((drawCall=drawCalls[i]).visible||drawCall.command)&&(drawCall.mask&&0==(drawCall.mask&cullingMask)||(visibleList[visibleLength]=drawCall,visibleLength++,drawCall.visibleThisFrame=!0));return visibleLength}for(i=0;i<drawCallsCount;i++)if((drawCall=drawCalls[i]).command)visibleList[visibleLength]=drawCall,visibleLength++,drawCall.visibleThisFrame=!0;else{if(!drawCall.visible)continue;if(visible=!0,drawCall.mask&&0==(drawCall.mask&cullingMask))continue;drawCall.cull&&(visible=drawCall._isVisible(camera)),visible&&(visibleList[visibleLength]=drawCall,visibleLength++,drawCall.visibleThisFrame=!0)}return visibleLength},_proto.cullLights=function cullLights(camera,lights){for(var i=0;i<lights.length;i++){var light=lights[i];!light.visibleThisFrame&&light.enabled&&(0===light._type?light.visibleThisFrame=!0:(light.getBoundingSphere(tempSphere$1),camera.frustum.containsSphere(tempSphere$1)?light.visibleThisFrame=!0:light.castShadows&&!light.shadowMap&&(light.visibleThisFrame=!0)))}},_proto.updateCpuSkinMatrices=function updateCpuSkinMatrices(drawCalls){_skinUpdateIndex++;var drawCallsCount=drawCalls.length,i,si;if(0!==drawCallsCount)for(i=0;i<drawCallsCount;i++)(si=drawCalls[i].skinInstance)&&(si.updateMatrices(drawCalls[i].node,_skinUpdateIndex),si._dirty=!0)},_proto.updateGpuSkinMatrices=function updateGpuSkinMatrices(drawCalls){var i,skin,drawCallsCount=drawCalls.length;for(i=0;i<drawCallsCount;i++)drawCalls[i].visibleThisFrame&&(skin=drawCalls[i].skinInstance)&&skin._dirty&&(skin.updateMatrixPalette(drawCalls[i].node,_skinUpdateIndex),skin._dirty=!1)},_proto.updateMorphing=function updateMorphing(drawCalls){var i,morphInst,drawCallsCount=drawCalls.length;for(i=0;i<drawCallsCount;i++)(morphInst=drawCalls[i].morphInstance)&&morphInst._dirty&&drawCalls[i].visibleThisFrame&&morphInst.update()},_proto.setBaseConstants=function setBaseConstants(device,material){device.setCullMode(material.cull),material.opacityMap&&(this.opacityMapId.setValue(material.opacityMap),this.alphaTestId.setValue(material.alphaTest))},_proto.setSkinning=function setSkinning(device,meshInstance,material){meshInstance.skinInstance&&(this._skinDrawCalls++,device.supportsBoneTextures?(boneTexture=meshInstance.skinInstance.boneTexture,this.boneTextureId.setValue(boneTexture),boneTextureSize[0]=boneTexture.width,boneTextureSize[1]=boneTexture.height,boneTextureSize[2]=1/boneTexture.width,boneTextureSize[3]=1/boneTexture.height,this.boneTextureSizeId.setValue(boneTextureSize)):this.poseMatrixId.setValue(meshInstance.skinInstance.matrixPalette))},_proto.drawInstance=function drawInstance(device,meshInstance,mesh,style,normal){if(instancingData=meshInstance.instancingData){if(instancingData.count>0&&(this._instancedDrawCalls++,device.setVertexBuffer(instancingData.vertexBuffer),device.draw(mesh.primitive[style],instancingData.count),instancingData.vertexBuffer===_autoInstanceBuffer))return this._removedByInstancing+=instancingData.count,meshInstance.instancingData=null,instancingData.count-1}else modelMatrix=meshInstance.node.worldTransform,this.modelMatrixId.setValue(modelMatrix.data),normal&&(normalMatrix=meshInstance.node.normalMatrix,meshInstance.node._dirtyNormal&&(modelMatrix.invertTo3x3(normalMatrix),normalMatrix.transpose(),meshInstance.node._dirtyNormal=!1),this.normalMatrixId.setValue(normalMatrix.data)),device.draw(mesh.primitive[style]);return 0},_proto.drawInstance2=function drawInstance2(device,meshInstance,mesh,style){if(instancingData=meshInstance.instancingData){if(instancingData.count>0&&(this._instancedDrawCalls++,device.draw(mesh.primitive[style],instancingData.count,!0),instancingData.vertexBuffer===_autoInstanceBuffer))return this._removedByInstancing+=instancingData.count,meshInstance.instancingData=null,instancingData.count-1}else device.draw(mesh.primitive[style],void 0,!0);return 0},_proto.renderShadows=function renderShadows(lights,camera){var device=this.device;device.grabPassAvailable=!1;for(var i=0;i<lights.length;i++)this._shadowRenderer.render(lights[i],camera);device.webgl2?device.setDepthBias(!1):device.extStandardDerivatives&&(this.polygonOffset[0]=0,this.polygonOffset[1]=0,this.polygonOffsetId.setValue(this.polygonOffset)),device.grabPassAvailable=!0},_proto.updateShader=function updateShader(meshInstance,objDefs,staticLightList,pass,sortedLights){meshInstance.material._scene=this.scene,meshInstance.material._dirtyBlend&&(this.scene.layers._dirtyBlend=!0),meshInstance.material.updateShader(this.device,this.scene,objDefs,staticLightList,pass,sortedLights),meshInstance._shader[pass]=meshInstance.material.shader},_proto.setCullMode=function setCullMode(cullFaces,flip,drawCall){var material=drawCall.material,mode=0;if(cullFaces){var flipFaces=1;if(material.cull>0&&material.cull<3){drawCall.flipFaces&&(flipFaces*=-1),flip&&(flipFaces*=-1);var wt=drawCall.node.worldTransform;wt.getX(worldMatX),wt.getY(worldMatY),wt.getZ(worldMatZ),worldMatX.cross(worldMatX,worldMatY),worldMatX.dot(worldMatZ)<0&&(flipFaces*=-1)}mode=flipFaces<0?2===material.cull?1:2:material.cull}if(this.device.setCullMode(mode),0===mode&&0===material.cull){var wt2=drawCall.node.worldTransform;wt2.getX(worldMatX),wt2.getY(worldMatY),wt2.getZ(worldMatZ),worldMatX.cross(worldMatX,worldMatY),worldMatX.dot(worldMatZ)<0?this.twoSidedLightingNegScaleFactorId.setValue(-1):this.twoSidedLightingNegScaleFactorId.setValue(1)}},_proto.setVertexBuffers=function setVertexBuffers(device,mesh){device.setVertexBuffer(mesh.vertexBuffer)},_proto.setMorphing=function setMorphing(device,morphInstance){if(morphInstance)if(morphInstance.morph.useTextureMorph)device.setVertexBuffer(morphInstance.morph.vertexBufferIds),this.morphPositionTex.setValue(morphInstance.texturePositions),this.morphNormalTex.setValue(morphInstance.textureNormals),this.morphTexParams.setValue(morphInstance._textureParams);else{for(var vb,semantic,t=0;t<morphInstance._activeVertexBuffers.length;t++)(vb=morphInstance._activeVertexBuffers[t])&&(semantic="ATTR"+(t+8),vb.format.elements[0].name=semantic,vb.format.elements[0].scopeId=device.scope.resolve(semantic),vb.format.update(),device.setVertexBuffer(vb));this.morphWeightsA.setValue(morphInstance._shaderMorphWeightsA),this.morphWeightsB.setValue(morphInstance._shaderMorphWeightsB)}},_proto.dispatchViewPos=function dispatchViewPos(position){var vp=this.viewPos;vp[0]=position.x,vp[1]=position.y,vp[2]=position.z,this.viewPosId.setValue(vp)},_proto.renderForward=function renderForward(camera,drawCalls,drawCallsCount,sortedLights,pass,cullingMask,drawCallback,layer){var device=this.device,scene=this.scene,vrDisplay=camera.vrDisplay,lightHash=layer?layer._lightHash:0,passFlag=1<<pass,i,drawCall,mesh,material,objDefs,variantKey,lightMask,style,usedDirLights,prevMaterial=null,prevObjDefs,prevLightMask,prevStatic,stencilFront,stencilBack,halfWidth=.5*device.width;for(i=0;i<drawCallsCount;i++)if(drawCall=drawCalls[i],!cullingMask||!drawCall.mask||cullingMask&drawCall.mask)if(drawCall.command)drawCall.command();else{if(mesh=drawCall.mesh,material=drawCall.material,objDefs=drawCall._shaderDefs,lightMask=drawCall.mask,this.setSkinning(device,drawCall,material),material&&material===prevMaterial&&objDefs!==prevObjDefs&&(prevMaterial=null),(drawCall.isStatic||prevStatic)&&(prevMaterial=null),material!==prevMaterial&&(this._materialSwitches++,material.dirty&&(material.updateUniforms(),material.dirty=!1),drawCall._shader[pass]&&drawCall._shaderDefs===objDefs&&drawCall._lightHash===lightHash||(drawCall.isStatic?this.updateShader(drawCall,objDefs,drawCall._staticLightList,pass,sortedLights):(variantKey=pass+"_"+objDefs+"_"+lightHash,drawCall._shader[pass]=material.variants[variantKey],drawCall._shader[pass]||(this.updateShader(drawCall,objDefs,null,pass,sortedLights),material.variants[variantKey]=drawCall._shader[pass])),drawCall._shaderDefs=objDefs,drawCall._lightHash=lightHash),drawCall._shader[pass].failed||device.setShader(drawCall._shader[pass])||(drawCall._shader[pass].failed=!0),material.setParameters(device),prevMaterial&&lightMask===prevLightMask||(usedDirLights=this.dispatchDirectLights(sortedLights[0],scene,lightMask,camera),this.dispatchLocalLights(sortedLights,scene,lightMask,usedDirLights,drawCall._staticLightList)),this.alphaTestId.setValue(material.alphaTest),device.setBlending(material.blend),material.blend&&(material.separateAlphaBlend?(device.setBlendFunctionSeparate(material.blendSrc,material.blendDst,material.blendSrcAlpha,material.blendDstAlpha),device.setBlendEquationSeparate(material.blendEquation,material.blendAlphaEquation)):(device.setBlendFunction(material.blendSrc,material.blendDst),device.setBlendEquation(material.blendEquation))),device.setColorWrite(material.redWrite,material.greenWrite,material.blueWrite,material.alphaWrite),device.setDepthWrite(material.depthWrite),material.depthWrite&&!material.depthTest?(device.setDepthFunc(7),device.setDepthTest(!0)):(device.setDepthFunc(3),device.setDepthTest(material.depthTest)),device.setAlphaToCoverage(material.alphaToCoverage),material.depthBias||material.slopeDepthBias?(device.setDepthBias(!0),device.setDepthBiasValues(material.depthBias,material.slopeDepthBias)):device.setDepthBias(!1)),this.setCullMode(camera._cullFaces,camera._flipFaces,drawCall),stencilFront=drawCall.stencilFront||material.stencilFront,stencilBack=drawCall.stencilBack||material.stencilBack,stencilFront||stencilBack?(device.setStencilTest(!0),stencilFront===stencilBack?(device.setStencilFunc(stencilFront.func,stencilFront.ref,stencilFront.readMask),device.setStencilOperation(stencilFront.fail,stencilFront.zfail,stencilFront.zpass,stencilFront.writeMask)):(stencilFront?(device.setStencilFuncFront(stencilFront.func,stencilFront.ref,stencilFront.readMask),device.setStencilOperationFront(stencilFront.fail,stencilFront.zfail,stencilFront.zpass,stencilFront.writeMask)):(device.setStencilFuncFront(7,0,255),device.setStencilOperationFront(0,0,0,255)),stencilBack?(device.setStencilFuncBack(stencilBack.func,stencilBack.ref,stencilBack.readMask),device.setStencilOperationBack(stencilBack.fail,stencilBack.zfail,stencilBack.zpass,stencilBack.writeMask)):(device.setStencilFuncBack(7,0,255),device.setStencilOperationBack(0,0,0,255)))):device.setStencilTest(!1),drawCall.setParameters(device,passFlag),this.setVertexBuffers(device,mesh),this.setMorphing(device,drawCall.morphInstance),style=drawCall.renderStyle,device.setIndexBuffer(mesh.indexBuffer[style]),drawCallback&&drawCallback(drawCall,i),vrDisplay&&vrDisplay.presenting)device.setViewport(0,0,halfWidth,device.height),this.projId.setValue(projL.data),this.projSkyboxId.setValue(projL.data),this.viewInvId.setValue(viewInvL.data),this.viewId.setValue(viewL.data),this.viewId3.setValue(viewMat3L.data),this.viewProjId.setValue(viewProjMatL.data),this.dispatchViewPos(viewPosL),i+=this.drawInstance(device,drawCall,mesh,style,!0),this._forwardDrawCalls++,device.setViewport(halfWidth,0,halfWidth,device.height),this.projId.setValue(projR.data),this.projSkyboxId.setValue(projR.data),this.viewInvId.setValue(viewInvR.data),this.viewId.setValue(viewR.data),this.viewId3.setValue(viewMat3R.data),this.viewProjId.setValue(viewProjMatR.data),this.dispatchViewPos(viewPosR),i+=this.drawInstance2(device,drawCall,mesh,style),this._forwardDrawCalls++;else if(camera.xr&&camera.xr.session&&camera.xr.views.length)for(var views=camera.xr.views,v=0;v<views.length;v++){var view=views[v];device.setViewport(view.viewport.x,view.viewport.y,view.viewport.z,view.viewport.w),this.projId.setValue(view.projMat.data),this.projSkyboxId.setValue(view.projMat.data),this.viewId.setValue(view.viewOffMat.data),this.viewInvId.setValue(view.viewInvOffMat.data),this.viewId3.setValue(view.viewMat3.data),this.viewProjId.setValue(view.projViewOffMat.data),this.viewPosId.setValue(view.position),i+=0===v?this.drawInstance(device,drawCall,mesh,style,!0):this.drawInstance2(device,drawCall,mesh,style),this._forwardDrawCalls++}else i+=this.drawInstance(device,drawCall,mesh,style,!0),this._forwardDrawCalls++;i<drawCallsCount-1&&drawCalls[i+1].material===material&&material.setParameters(device,drawCall.parameters),prevMaterial=material,prevObjDefs=objDefs,prevLightMask=lightMask,prevStatic=drawCall.isStatic}device.updateEnd()},_proto.setupInstancing=function setupInstancing(device){device.enableAutoInstancing&&(_autoInstanceBuffer||(_autoInstanceBuffer=new VertexBuffer(device,VertexFormat.defaultInstancingFormat,device.autoInstancingMaxObjects,1)))},_proto.revertStaticMeshes=function revertStaticMeshes(meshInstances){var i,drawCalls=meshInstances,drawCallsCount=drawCalls.length,drawCall,newDrawCalls=[],prevStaticSource;for(i=0;i<drawCallsCount;i++)(drawCall=drawCalls[i])._staticSource?drawCall._staticSource!==prevStaticSource&&(newDrawCalls.push(drawCall._staticSource),prevStaticSource=drawCall._staticSource):newDrawCalls.push(drawCall);for(meshInstances.length=newDrawCalls.length,i=0;i<newDrawCalls.length;i++)meshInstances[i]=newDrawCalls[i]},_proto.prepareStaticMeshes=function prepareStaticMeshes(meshInstances,lights){var i,j,k,v,s,index,device=this.device;this.scene;var drawCalls=meshInstances,drawCallsCount=drawCalls.length,drawCall,light,newDrawCalls=[],mesh,indices,verts,numTris,elems,vertSize,offsetP,baseIndex,_x,_y,_z,minx,miny,minz,maxx,maxy,maxz,minv,maxv,minVec=new Vec3,maxVec=new Vec3,localLightBounds=new BoundingBox,invMatrix=new Mat4,triLightComb=[],triLightCombUsed,indexBuffer,vertexBuffer,combIndices,combIbName,combIb,lightTypePass,lightAabb=[],aabb,triBounds=[],staticLights=[],bit,lht;for(i=0;i<drawCallsCount;i++)if((drawCall=drawCalls[i]).isStatic){for(aabb=drawCall.aabb,staticLights.length=0,lightTypePass=1;lightTypePass<=2;lightTypePass++)for(j=0;j<lights.length;j++)if((light=lights[j])._type===lightTypePass&&light.enabled&&light.mask&drawCall.mask&&light.isStatic){if(lightAabb[j]||(lightAabb[j]=new BoundingBox,light._node.getWorldTransform(),light.getBoundingSphere(tempSphere$1),lightAabb[j].center.copy(tempSphere$1.center),lightAabb[j].halfExtents.x=tempSphere$1.radius,lightAabb[j].halfExtents.y=tempSphere$1.radius,lightAabb[j].halfExtents.z=tempSphere$1.radius),!lightAabb[j].intersects(aabb))continue;staticLights.push(j)}if(0===staticLights.length){newDrawCalls.push(drawCall);continue}for(vertexBuffer=(mesh=drawCall.mesh).vertexBuffer,indices=2===(indexBuffer=mesh.indexBuffer[drawCall.renderStyle]).bytesPerIndex?new Uint16Array(indexBuffer.lock()):new Uint32Array(indexBuffer.lock()),numTris=mesh.primitive[drawCall.renderStyle].count/3,baseIndex=mesh.primitive[drawCall.renderStyle].base,elems=vertexBuffer.format.elements,vertSize=vertexBuffer.format.size/4,verts=new Float32Array(vertexBuffer.storage),k=0;k<elems.length;k++)"POSITION"===elems[k].name&&(offsetP=elems[k].offset/4);for(triLightComb.length=numTris,k=0;k<numTris;k++)triLightComb[k]=0;for(triLightCombUsed=!1,triBounds.length=6*numTris,k=0;k<numTris;k++){for(minx=Number.MAX_VALUE,miny=Number.MAX_VALUE,minz=Number.MAX_VALUE,maxx=-Number.MAX_VALUE,maxy=-Number.MAX_VALUE,maxz=-Number.MAX_VALUE,v=0;v<3;v++)(_x=verts[index=(index=indices[3*k+v+baseIndex])*vertSize+offsetP])<minx&&(minx=_x),(_y=verts[index+1])<miny&&(miny=_y),(_z=verts[index+2])<minz&&(minz=_z),_x>maxx&&(maxx=_x),_y>maxy&&(maxy=_y),_z>maxz&&(maxz=_z);triBounds[index=6*k]=minx,triBounds[index+1]=miny,triBounds[index+2]=minz,triBounds[index+3]=maxx,triBounds[index+4]=maxy,triBounds[index+5]=maxz}for(s=0;s<staticLights.length;s++)for(light=lights[j=staticLights[s]],invMatrix.copy(drawCall.node.worldTransform).invert(),localLightBounds.setFromTransformedAabb(lightAabb[j],invMatrix),minv=localLightBounds.getMin(),maxv=localLightBounds.getMax(),bit=1<<s,k=0;k<numTris;k++)triBounds[index=6*k]<=maxv.x&&triBounds[index+3]>=minv.x&&triBounds[index+1]<=maxv.y&&triBounds[index+4]>=minv.y&&triBounds[index+2]<=maxv.z&&triBounds[index+5]>=minv.z&&(triLightComb[k]|=bit,triLightCombUsed=!0);if(triLightCombUsed){for(combIndices={},k=0;k<numTris;k++)j=3*k+baseIndex,combIndices[combIbName=triLightComb[k]]||(combIndices[combIbName]=[]),(combIb=combIndices[combIbName]).push(indices[j]),combIb.push(indices[j+1]),combIb.push(indices[j+2]);for(combIbName in combIndices){combIb=combIndices[combIbName];var ib=new IndexBuffer(device,indexBuffer.format,combIb.length,indexBuffer.usage),ib2;for((2===ib.bytesPerIndex?new Uint16Array(ib.lock()):new Uint32Array(ib.lock())).set(combIb),ib.unlock(),minx=Number.MAX_VALUE,miny=Number.MAX_VALUE,minz=Number.MAX_VALUE,maxx=-Number.MAX_VALUE,maxy=-Number.MAX_VALUE,maxz=-Number.MAX_VALUE,k=0;k<combIb.length;k++)(_x=verts[(index=combIb[k])*vertSize+offsetP])<minx&&(minx=_x),(_y=verts[index*vertSize+offsetP+1])<miny&&(miny=_y),(_z=verts[index*vertSize+offsetP+2])<minz&&(minz=_z),_x>maxx&&(maxx=_x),_y>maxy&&(maxy=_y),_z>maxz&&(maxz=_z);minVec.set(minx,miny,minz),maxVec.set(maxx,maxy,maxz);var chunkAabb=new BoundingBox;chunkAabb.setMinMax(minVec,maxVec);var mesh2=new Mesh(device);mesh2.vertexBuffer=vertexBuffer,mesh2.indexBuffer[0]=ib,mesh2.primitive[0].type=4,mesh2.primitive[0].base=0,mesh2.primitive[0].count=combIb.length,mesh2.primitive[0].indexed=!0,mesh2.aabb=chunkAabb;var instance=new MeshInstance(mesh2,drawCall.material,drawCall.node);for(instance.isStatic=drawCall.isStatic,instance.visible=drawCall.visible,instance.layer=drawCall.layer,instance.castShadow=drawCall.castShadow,instance._receiveShadow=drawCall._receiveShadow,instance.cull=drawCall.cull,instance.pick=drawCall.pick,instance.mask=drawCall.mask,instance.parameters=drawCall.parameters,instance._shaderDefs=drawCall._shaderDefs,instance._staticSource=drawCall,drawCall._staticLightList?instance._staticLightList=drawCall._staticLightList:instance._staticLightList=[],k=0;k<staticLights.length;k++)combIbName&(bit=1<<k)&&(lht=lights[staticLights[k]],instance._staticLightList.indexOf(lht)<0&&instance._staticLightList.push(lht));instance._staticLightList.sort(this.lightCompare),newDrawCalls.push(instance)}}else newDrawCalls.push(drawCall)}else newDrawCalls.push(drawCall);for(meshInstances.length=newDrawCalls.length,i=0;i<newDrawCalls.length;i++)meshInstances[i]=newDrawCalls[i]},_proto.updateShaders=function updateShaders(drawCalls){for(var mat,count=drawCalls.length,i=0;i<count;i++)(mat=drawCalls[i].material)&&(_tempMaterialSet.has(mat)||(_tempMaterialSet.add(mat),mat.updateShader!==Material.prototype.updateShader&&(mat.clearVariants(),mat.shader=null)));_tempMaterialSet.clear()},_proto.updateLitShaders=function updateLitShaders(drawCalls){for(var mat,count=drawCalls.length,i=0;i<count;i++)(mat=drawCalls[i].material)&&(_tempMaterialSet.has(mat)||(_tempMaterialSet.add(mat),mat.updateShader!==Material.prototype.updateShader&&(!mat.useLighting||mat.emitter&&!mat.emitter.lighting||(mat.clearVariants(),mat.shader=null))));_tempMaterialSet.clear()},_proto.beginFrame=function beginFrame(comp){var scene=this.scene,meshInstances=comp._meshInstances,lights=comp._lights,i;scene.updateShaders?(this.updateShaders(meshInstances),scene.updateShaders=!1,scene.updateLitShaders=!1,scene._shaderVersion++):scene.updateLitShaders&&(this.updateLitShaders(meshInstances),scene.updateLitShaders=!1,scene._shaderVersion++),this.updateCpuSkinMatrices(meshInstances);var len=meshInstances.length;for(i=0;i<len;i++)meshInstances[i].visibleThisFrame=!1;for(len=lights.length,i=0;i<len;i++)lights[i].visibleThisFrame=0===lights[i]._type},_proto.beginLayers=function beginLayers(comp){var scene=this.scene,len=comp.layerList.length,layer,i,j,shaderVersion=this.scene._shaderVersion,transparent;for(i=0;i<len;i++)comp.layerList[i]._postRenderCounter=0;for(i=0;i<len;i++){for((layer=comp.layerList[i])._shaderVersion=shaderVersion,layer._preRenderCalledForCameras=0,layer._postRenderCalledForCameras=0,transparent=comp.subLayerList[i],layer._postRenderCounter|=transparent?2:1,layer._postRenderCounterMax=layer._postRenderCounter,j=0;j<layer.cameras.length;j++)layer.instances.prepare(j);layer._needsStaticPrepare&&layer._staticLightHash&&(layer._staticPrepareDone&&(this.revertStaticMeshes(layer.opaqueMeshInstances),this.revertStaticMeshes(layer.transparentMeshInstances)),this.prepareStaticMeshes(layer.opaqueMeshInstances,layer._lights),this.prepareStaticMeshes(layer.transparentMeshInstances,layer._lights),comp._dirty=!0,scene.updateShaders=!0,layer._needsStaticPrepare=!1,layer._staticPrepareDone=!0)}},_proto.gpuUpdate=function gpuUpdate(drawCalls){this.updateGpuSkinMatrices(drawCalls),this.updateMorphing(drawCalls)},_proto.setSceneConstants=function setSceneConstants(){var i,device=this.device,scene=this.scene;if(this.dispatchGlobalLights(scene),"none"!==scene.fog){if(this.fogColor[0]=scene.fogColor.r,this.fogColor[1]=scene.fogColor.g,this.fogColor[2]=scene.fogColor.b,scene.gammaCorrection)for(i=0;i<3;i++)this.fogColor[i]=Math.pow(this.fogColor[i],2.2);this.fogColorId.setValue(this.fogColor),"linear"===scene.fog?(this.fogStartId.setValue(scene.fogStart),this.fogEndId.setValue(scene.fogEnd)):this.fogDensityId.setValue(scene.fogDensity)}this._screenSize[0]=device.width,this._screenSize[1]=device.height,this._screenSize[2]=1/device.width,this._screenSize[3]=1/device.height,this.screenSizeId.setValue(this._screenSize)},_proto.updateLightStats=function updateLightStats(comp,compUpdatedFlags){},_proto.cullShadowmaps=function cullShadowmaps(comp){for(var i=0;i<comp._lights.length;i++){var light=comp._lights[i];if(0!==light._type&&light.visibleThisFrame&&light.castShadows&&0!==light.shadowUpdateMode){var casters=comp._lightCompositionData[i].shadowCastersList;this._shadowRenderer.cullLocal(light,casters)}}for(var renderActions=comp._renderActions,_i=0;_i<renderActions.length;_i++)for(var renderAction=renderActions[_i],count=renderAction.directionalLightsIndices.length,j=0;j<count;j++){var lightIndex=renderAction.directionalLightsIndices[j],_light=comp._lights[lightIndex],_casters=comp._lightCompositionData[lightIndex].shadowCastersList;this._shadowRenderer.cullDirectional(_light,_casters,renderAction.camera.camera)}},_proto.cullComposition=function cullComposition(comp){for(var renderActions=comp._renderActions,i=0;i<renderActions.length;i++){var renderAction=renderActions[i],layerIndex=renderAction.layerIndex,layer=comp.layerList[layerIndex];if(layer.enabled&&comp.subLayerEnabled[layerIndex]){var transparent=comp.subLayerList[layerIndex],cameraPass=renderAction.cameraIndex,camera=layer.cameras[cameraPass];if(camera){camera.frameBegin(renderAction.renderTarget),renderAction.firstCameraUse&&(this.updateCameraFrustum(camera.camera),this._camerasRendered++),this.cullLights(camera.camera,layer._lights);var objects=layer.instances,visible=transparent?objects.visibleTransparent[cameraPass]:objects.visibleOpaque[cameraPass];if(!visible.done){layer.onPreCull&&layer.onPreCull(cameraPass);var drawCalls=transparent?layer.transparentMeshInstances:layer.opaqueMeshInstances;visible.length=this.cull(camera.camera,drawCalls,visible.list),visible.done=!0,layer.onPostCull&&layer.onPostCull(cameraPass)}camera.frameEnd()}}}this.cullShadowmaps(comp)},_proto.updateClusters=function updateClusters(comp){for(var i=0;i<comp._worldClusters.length;i++){var cluster;comp._worldClusters[i].update(comp._lights,this.scene.gammaCorrection)}},_proto.renderComposition=function renderComposition(comp){var device=this.device,camera,renderAction,renderActions=comp._renderActions,i,layer,layerIndex,transparent;this.scene.updateSkybox&&(this.scene._updateSkybox(device),this.scene.updateSkybox=!1),this.beginLayers(comp);var updated=comp._update();for(2&updated&&(this.scene.updateLitShaders=!0),this.updateLightStats(comp,updated),this.beginFrame(comp),this.setSceneConstants(),this.cullComposition(comp),this.updateClusters(comp),this.gpuUpdate(comp._meshInstances),LayerComposition.clusteredLightingEnabled||(this.renderShadows(comp._splitLights[2]),this.renderShadows(comp._splitLights[1])),i=0;i<renderActions.length;i++){layerIndex=(renderAction=renderActions[i]).layerIndex,layer=comp.layerList[layerIndex],transparent=comp.subLayerList[layerIndex];var cameraPass=renderAction.cameraIndex;if(camera=layer.cameras[cameraPass],renderAction.directionalLights.length>0&&this.renderShadows(renderAction.directionalLights,camera.camera),layer.enabled&&comp.subLayerEnabled[layerIndex]){if(camera&&camera.frameBegin(renderAction.renderTarget),!transparent&&layer.onPreRenderOpaque?layer.onPreRenderOpaque(cameraPass):transparent&&layer.onPreRenderTransparent&&layer.onPreRenderTransparent(cameraPass),layer._preRenderCalledForCameras&1<<cameraPass||(layer.onPreRender&&layer.onPreRender(cameraPass),layer._preRenderCalledForCameras|=1<<cameraPass),camera){if(renderAction.clearColor||renderAction.clearDepth||renderAction.clearStencil){var backupColor=camera.camera._clearColorBuffer,backupDepth=camera.camera._clearDepthBuffer,backupStencil=camera.camera._clearStencilBuffer;camera.camera._clearColorBuffer=renderAction.clearColor,camera.camera._clearDepthBuffer=renderAction.clearDepth,camera.camera._clearStencilBuffer=renderAction.clearStencil,this.clearView(camera.camera,renderAction.renderTarget,!0,!0),camera.camera._clearColorBuffer=backupColor,camera.camera._clearDepthBuffer=backupDepth,camera.camera._clearStencilBuffer=backupStencil}layer._sortVisible(transparent,camera.camera.node,cameraPass);var objects=layer.instances,visible=transparent?objects.visibleTransparent[cameraPass]:objects.visibleOpaque[cameraPass];this.scene._activeCamera=camera.camera,this.setCamera(camera.camera,renderAction.renderTarget),LayerComposition.clusteredLightingEnabled&&renderAction.lightClusters&&renderAction.lightClusters.activate();var draws=this._forwardDrawCalls;this.renderForward(camera.camera,visible.list,visible.length,layer._splitLights,layer.shaderPass,layer.cullingMask,layer.onDrawCall,layer),layer._forwardDrawCalls+=this._forwardDrawCalls-draws,device.setColorWrite(!0,!0,!0,!0),device.setStencilTest(!1),device.setAlphaToCoverage(!1),device.setDepthBias(!1),camera.frameEnd(),renderAction.triggerPostprocess&&camera.onPostprocessing&&camera.onPostprocessing(camera)}!transparent&&layer.onPostRenderOpaque?layer.onPostRenderOpaque(cameraPass):transparent&&layer.onPostRenderTransparent&&layer.onPostRenderTransparent(cameraPass),!layer.onPostRender||layer._postRenderCalledForCameras&1<<cameraPass||(layer._postRenderCounter&=~(transparent?2:1),0===layer._postRenderCounter&&(layer.onPostRender(cameraPass),layer._postRenderCalledForCameras|=1<<cameraPass,layer._postRenderCounter=layer._postRenderCounterMax))}}},ForwardRenderer}(),keyA,keyB,sortPos,sortDir;function sortManual(drawCallA,drawCallB){return drawCallA.drawOrder-drawCallB.drawOrder}function sortMaterialMesh(drawCallA,drawCallB){return keyA=drawCallA._key[0],keyB=drawCallB._key[0],keyA===keyB&&drawCallA.mesh&&drawCallB.mesh?drawCallB.mesh.id-drawCallA.mesh.id:keyB-keyA}function sortBackToFront(drawCallA,drawCallB){return drawCallB.zdist-drawCallA.zdist}function sortFrontToBack(drawCallA,drawCallB){return drawCallA.zdist-drawCallB.zdist}ForwardRenderer.spotCookieCamera=null;var sortCallbacks=[null,sortManual,sortMaterialMesh,sortBackToFront,sortFrontToBack];function sortLights(lightA,lightB){return lightB.key-lightA.key}var layerCounter=0,VisibleInstanceList=function VisibleInstanceList(){this.list=[],this.length=0,this.done=!1},InstanceList=function(){function InstanceList(){this.opaqueMeshInstances=[],this.transparentMeshInstances=[],this.shadowCasters=[],this.visibleOpaque=[],this.visibleTransparent=[]}var _proto=InstanceList.prototype;return _proto.prepare=function prepare(index){this.visibleOpaque[index]||(this.visibleOpaque[index]=new VisibleInstanceList),this.visibleTransparent[index]||(this.visibleTransparent[index]=new VisibleInstanceList),this.visibleOpaque[index].done=!1,this.visibleTransparent[index].done=!1},_proto.delete=function _delete(index){index<this.visibleOpaque.length&&this.visibleOpaque.splice(index,1),index<this.visibleTransparent.length&&this.visibleTransparent.splice(index,1)},InstanceList}(),Layer=function(){function Layer(options){void 0===options&&(options={}),void 0!==options.id?(this.id=options.id,layerCounter=Math.max(this.id+1,layerCounter)):this.id=layerCounter++,this.name=options.name,this._enabled=void 0===options.enabled||options.enabled,this._refCounter=this._enabled?1:0,this.opaqueSortMode=void 0===options.opaqueSortMode?2:options.opaqueSortMode,this.transparentSortMode=void 0===options.transparentSortMode?3:options.transparentSortMode,this.renderTarget=options.renderTarget,this.shaderPass=void 0===options.shaderPass?0:options.shaderPass,this.passThrough=void 0!==options.passThrough&&options.passThrough,this._clearColorBuffer=!!options.clearColorBuffer&&options.clearColorBuffer,this._clearDepthBuffer=!!options.clearDepthBuffer&&options.clearDepthBuffer,this._clearStencilBuffer=!!options.clearStencilBuffer&&options.clearStencilBuffer,this.onPreCull=options.onPreCull,this.onPreRender=options.onPreRender,this.onPreRenderOpaque=options.onPreRenderOpaque,this.onPreRenderTransparent=options.onPreRenderTransparent,this.onPostCull=options.onPostCull,this.onPostRender=options.onPostRender,this.onPostRenderOpaque=options.onPostRenderOpaque,this.onPostRenderTransparent=options.onPostRenderTransparent,this.onDrawCall=options.onDrawCall,this.onEnable=options.onEnable,this.onDisable=options.onDisable,this._enabled&&this.onEnable&&this.onEnable(),this.layerReference=options.layerReference,this.instances=options.layerReference?options.layerReference.instances:new InstanceList,this.cullingMask=options.cullingMask?options.cullingMask:4294967295,this.opaqueMeshInstances=this.instances.opaqueMeshInstances,this.transparentMeshInstances=this.instances.transparentMeshInstances,this.shadowCasters=this.instances.shadowCasters,this.customSortCallback=null,this.customCalculateSortValues=null,this._lights=[],this._lightsSet=new Set,this._clusteredLightsSet=new Set,this._splitLights=[[],[],[]],this.cameras=[],this._dirty=!1,this._dirtyLights=!1,this._dirtyCameras=!1,this._lightHash=0,this._staticLightHash=0,this._needsStaticPrepare=!0,this._staticPrepareDone=!1,this._shaderVersion=-1,this._lightCube=null}var _proto2=Layer.prototype;return _proto2.incrementCounter=function incrementCounter(){0===this._refCounter&&(this._enabled=!0,this.onEnable&&this.onEnable()),this._refCounter++},_proto2.decrementCounter=function decrementCounter(){if(1===this._refCounter)this._enabled=!1,this.onDisable&&this.onDisable();else if(0===this._refCounter)return;this._refCounter--},_proto2.addMeshInstances=function addMeshInstances(meshInstances,skipShadowCasters){for(var sceneShaderVer=this._shaderVersion,m,arr,mat,casters=this.shadowCasters,i=0;i<meshInstances.length;i++)arr=3===(mat=(m=meshInstances[i]).material).blendType?this.opaqueMeshInstances:this.transparentMeshInstances,this.opaqueMeshInstances.indexOf(m)<0&&this.transparentMeshInstances.indexOf(m)<0&&arr.push(m),!skipShadowCasters&&m.castShadow&&casters.indexOf(m)<0&&casters.push(m),!this.passThrough&&sceneShaderVer>=0&&mat._shaderVersion!==sceneShaderVer&&(mat.updateShader!==Material.prototype.updateShader&&(mat.clearVariants(),mat.shader=null),mat._shaderVersion=sceneShaderVer);this.passThrough||(this._dirty=!0)},_proto2.removeMeshInstanceFromArray=function removeMeshInstanceFromArray(m,arr){for(var drawCall,spliceOffset=-1,spliceCount=0,len=arr.length,j=0;j<len;j++){if((drawCall=arr[j])===m){spliceOffset=j,spliceCount=1;break}if(drawCall._staticSource===m)spliceOffset<0&&(spliceOffset=j),spliceCount++;else if(spliceOffset>=0)break}spliceOffset>=0&&arr.splice(spliceOffset,spliceCount)},_proto2.removeMeshInstances=function removeMeshInstances(meshInstances,skipShadowCasters){for(var j,m,opaque=this.opaqueMeshInstances,transparent=this.transparentMeshInstances,casters=this.shadowCasters,i=0;i<meshInstances.length;i++)m=meshInstances[i],this.removeMeshInstanceFromArray(m,opaque),this.removeMeshInstanceFromArray(m,transparent),skipShadowCasters||(j=casters.indexOf(m))>=0&&casters.splice(j,1);this._dirty=!0},_proto2.clearMeshInstances=function clearMeshInstances(skipShadowCasters){(0!==this.opaqueMeshInstances.length||0!==this.transparentMeshInstances.length||!skipShadowCasters&&0!==this.shadowCasters.length)&&(this.opaqueMeshInstances.length=0,this.transparentMeshInstances.length=0,skipShadowCasters||(this.shadowCasters.length=0),this.passThrough||(this._dirty=!0))},_proto2.addLight=function addLight(light){var l=light.light;this._lightsSet.has(l)||(this._lightsSet.add(l),0!==l.type&&this._clusteredLightsSet.add(l),this._lights.push(l),this._dirtyLights=!0,this._generateLightHash())},_proto2.removeLight=function removeLight(light){var l=light.light;this._lightsSet.has(l)&&(this._lightsSet.delete(l),0!==l.type&&this._clusteredLightsSet.delete(l),this._lights.splice(this._lights.indexOf(l),1),this._dirtyLights=!0,this._generateLightHash())},_proto2.clearLights=function clearLights(){this._lightsSet.clear(),this._clusteredLightsSet.clear(),this._lights.length=0,this._dirtyLights=!0},_proto2.addShadowCasters=function addShadowCasters(meshInstances){for(var m,arr=this.shadowCasters,i=0;i<meshInstances.length;i++)(m=meshInstances[i]).castShadow&&arr.indexOf(m)<0&&arr.push(m);this._dirtyLights=!0},_proto2.removeShadowCasters=function removeShadowCasters(meshInstances){for(var id,arr=this.shadowCasters,i=0;i<meshInstances.length;i++)(id=arr.indexOf(meshInstances[i]))>=0&&arr.splice(id,1);this._dirtyLights=!0},_proto2._generateLightHash=function _generateLightHash(){if(this._lights.length>0){this._lights.sort(sortLights);for(var str="",strStatic="",i=0;i<this._lights.length;i++)this._lights[i].isStatic?strStatic+=this._lights[i].key:str+=this._lights[i].key;0===str.length?this._lightHash=0:this._lightHash=hashCode(str),0===strStatic.length?this._staticLightHash=0:this._staticLightHash=hashCode(strStatic)}else this._lightHash=0,this._staticLightHash=0},_proto2.addCamera=function addCamera(camera){this.cameras.indexOf(camera)>=0||(this.cameras.push(camera),this._dirtyCameras=!0)},_proto2.removeCamera=function removeCamera(camera){var index=this.cameras.indexOf(camera);index>=0&&(this.cameras.splice(index,1),this._dirtyCameras=!0,this.instances.delete(index))},_proto2.clearCameras=function clearCameras(){this.cameras.length=0,this._dirtyCameras=!0},_proto2._calculateSortDistances=function _calculateSortDistances(drawCalls,drawCallsCount,camPos,camFwd){var i,drawCall,meshPos,tempx,tempy,tempz;for(i=0;i<drawCallsCount;i++)(drawCall=drawCalls[i]).command||drawCall.layer<=2||(drawCall.calculateSortDistance?drawCall.zdist=drawCall.calculateSortDistance(drawCall,camPos,camFwd):(tempx=(meshPos=drawCall.aabb.center).x-camPos.x,tempy=meshPos.y-camPos.y,tempz=meshPos.z-camPos.z,drawCall.zdist=tempx*camFwd.x+tempy*camFwd.y+tempz*camFwd.z))},_proto2._sortVisible=function _sortVisible(transparent,cameraNode,cameraPass){var objects=this.instances,sortMode=transparent?this.transparentSortMode:this.opaqueSortMode;if(0!==sortMode){var visible=transparent?objects.visibleTransparent[cameraPass]:objects.visibleOpaque[cameraPass];5===sortMode?(sortPos=cameraNode.getPosition(),sortDir=cameraNode.forward,this.customCalculateSortValues&&this.customCalculateSortValues(visible.list,visible.length,sortPos,sortDir),visible.list.length!==visible.length&&(visible.list.length=visible.length),this.customSortCallback&&visible.list.sort(this.customSortCallback)):(3!==sortMode&&4!==sortMode||(sortPos=cameraNode.getPosition(),sortDir=cameraNode.forward,this._calculateSortDistances(visible.list,visible.length,sortPos,sortDir)),visible.list.length!==visible.length&&(visible.list.length=visible.length),visible.list.sort(sortCallbacks[sortMode]))}},_createClass(Layer,[{key:"renderTarget",get:function get(){return this._renderTarget},set:function set(rt){this._renderTarget=rt,this._dirtyCameras=!0}},{key:"enabled",get:function get(){return this._enabled},set:function set(val){val!==this._enabled&&(this._enabled=val,val?(this.incrementCounter(),this.onEnable&&this.onEnable()):(this.decrementCounter(),this.onDisable&&this.onDisable()))}},{key:"clearColor",get:function get(){return this._clearColor},set:function set(val){this._clearColor.copy(val)}},{key:"clearColorBuffer",get:function get(){return this._clearColorBuffer},set:function set(val){this._clearColorBuffer=val,this._dirtyCameras=!0}},{key:"clearDepthBuffer",get:function get(){return this._clearDepthBuffer},set:function set(val){this._clearDepthBuffer=val,this._dirtyCameras=!0}},{key:"clearStencilBuffer",get:function get(){return this._clearStencilBuffer},set:function set(val){this._clearStencilBuffer=val,this._dirtyCameras=!0}},{key:"clusteredLightsSet",get:function get(){return this._clusteredLightsSet}}]),Layer}(),spotCenter=new Vec3,spotEndPoint=new Vec3,tmpVec=new Vec3,chanId={r:0,g:1,b:2,a:3},directionalCascades=[[new Vec4(0,0,1,1)],[new Vec4(0,0,.5,.5),new Vec4(0,.5,.5,.5)],[new Vec4(0,0,.5,.5),new Vec4(0,.5,.5,.5),new Vec4(.5,0,.5,.5)],[new Vec4(0,0,.5,.5),new Vec4(0,.5,.5,.5),new Vec4(.5,0,.5,.5),new Vec4(.5,.5,.5,.5)]],LightRenderData=function(){function LightRenderData(device,camera,face,light){this.light=light,this.camera=camera,this.shadowCamera=ShadowRenderer.createShadowCamera(device,light._shadowType,light._type,face),this.shadowMatrix=new Mat4,this.face=face,this.visibleCasters=[]}return _createClass(LightRenderData,[{key:"shadowBuffer",get:function get(){var rt=this.shadowCamera.renderTarget;if(rt){var light=this.light;return 1===light._type?rt.colorBuffer:light._isPcf&&light.device.webgl2?rt.depthBuffer:rt.colorBuffer}return null}}]),LightRenderData}(),Light=function(){function Light(graphicsDevice){this.device=graphicsDevice,this._type=0,this._color=new Color(.8,.8,.8),this._intensity=1,this._castShadows=!1,this._enabled=!1,this.mask=1,this.isStatic=!1,this.key=0,this.bakeDir=!0,this.attenuationStart=10,this.attenuationEnd=10,this._falloffMode=0,this._shadowType=0,this._vsmBlurSize=11,this.vsmBlurMode=1,this.vsmBias=.0025,this._cookie=null,this.cookieIntensity=1,this._cookieFalloff=!0,this._cookieChannel="rgb",this._cookieTransform=null,this._cookieTransformUniform=new Float32Array(4),this._cookieOffset=null,this._cookieOffsetUniform=new Float32Array(2),this._cookieTransformSet=!1,this._cookieOffsetSet=!1,this._innerConeAngle=40,this._outerConeAngle=45,this.cascades=null,this._shadowMatrixPalette=null,this._shadowCascadeDistances=null,this.numCascades=1,this.cascadeDistribution=.5,this._shape=0,this._finalColor=new Float32Array([.8,.8,.8]);var c=Math.pow(this._finalColor[0],2.2);this._linearFinalColor=new Float32Array([c,c,c]),this._position=new Vec3(0,0,0),this._direction=new Vec3(0,0,0),this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180),this._outerConeAngleCos=Math.cos(this._outerConeAngle*Math.PI/180),this._shadowMap=null,this._shadowRenderParams=[],this.shadowDistance=40,this._shadowResolution=1024,this.shadowBias=-5e-4,this._normalOffsetBias=0,this.shadowUpdateMode=2,this._isVsm=!1,this._isPcf=!0,this._cookieMatrix=null,this._scene=null,this._node=null,this._renderData=[],this.visibleThisFrame=!1}var _proto=Light.prototype;return _proto.destroy=function destroy(){this._destroyShadowMap(),this._renderData=null},_proto._destroyShadowMap=function _destroyShadowMap(){this._renderData&&(this._renderData.length=0),this._shadowMap&&(this._shadowMap.cached||this._shadowMap.destroy(),this._shadowMap=null),0===this.shadowUpdateMode&&(this.shadowUpdateMode=1)},_proto.getRenderData=function getRenderData(camera,face){for(var i=0;i<this._renderData.length;i++){var current=this._renderData[i];if(current.camera===camera&&current.face===face)return current}var rd=new LightRenderData(this.device,camera,face,this);return this._renderData.push(rd),rd},_proto.clone=function clone(){var clone=new Light(this.device);return clone.type=this._type,clone.setColor(this._color),clone.intensity=this._intensity,clone.castShadows=this.castShadows,clone._enabled=this._enabled,clone.attenuationStart=this.attenuationStart,clone.attenuationEnd=this.attenuationEnd,clone.falloffMode=this._falloffMode,clone.shadowType=this._shadowType,clone.vsmBlurSize=this._vsmBlurSize,clone.vsmBlurMode=this.vsmBlurMode,clone.vsmBias=this.vsmBias,clone.shadowUpdateMode=this.shadowUpdateMode,clone.mask=this.mask,clone.innerConeAngle=this._innerConeAngle,clone.outerConeAngle=this._outerConeAngle,clone.numCascades=this.numCascades,clone.cascadeDistribution=this.cascadeDistribution,clone.shape=this._shape,clone.shadowBias=this.shadowBias,clone.normalOffsetBias=this._normalOffsetBias,clone.shadowResolution=this._shadowResolution,clone.shadowDistance=this.shadowDistance,clone},_proto.getColor=function getColor(){return this._color},_proto.getBoundingSphere=function getBoundingSphere(sphere){if(2===this._type){var range=this.attenuationEnd,angle=this._outerConeAngle,f=Math.cos(angle*math.DEG_TO_RAD),node=this._node;spotCenter.copy(node.up),spotCenter.mulScalar(.5*-range*f),spotCenter.add(node.getPosition()),sphere.center=spotCenter,spotEndPoint.copy(node.up),spotEndPoint.mulScalar(-range),tmpVec.copy(node.right),tmpVec.mulScalar(Math.sin(angle*math.DEG_TO_RAD)*range),spotEndPoint.add(tmpVec),sphere.radius=.5*spotEndPoint.length()}else 1===this._type&&(sphere.center=this._node.getPosition(),sphere.radius=this.attenuationEnd)},_proto.getBoundingBox=function getBoundingBox(box){if(2===this._type){var range=this.attenuationEnd,angle=this._outerConeAngle,node=this._node,scl=Math.abs(Math.sin(angle*math.DEG_TO_RAD)*range);box.center.set(0,.5*-range,0),box.halfExtents.set(scl,.5*range,scl),box.setFromTransformedAabb(box,node.getWorldTransform())}else 1===this._type&&(box.center.copy(this._node.getPosition()),box.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd))},_proto._updateFinalColor=function _updateFinalColor(){var color=this._color,r=color.r,g=color.g,b=color.b,i=this._intensity,finalColor=this._finalColor,linearFinalColor=this._linearFinalColor;finalColor[0]=r*i,finalColor[1]=g*i,finalColor[2]=b*i,i>=1?(linearFinalColor[0]=Math.pow(r,2.2)*i,linearFinalColor[1]=Math.pow(g,2.2)*i,linearFinalColor[2]=Math.pow(b,2.2)*i):(linearFinalColor[0]=Math.pow(finalColor[0],2.2),linearFinalColor[1]=Math.pow(finalColor[1],2.2),linearFinalColor[2]=Math.pow(finalColor[2],2.2))},_proto.setColor=function setColor(){var r,g,b;1===arguments.length?(r=arguments[0].r,g=arguments[0].g,b=arguments[0].b):3===arguments.length&&(r=arguments[0],g=arguments[1],b=arguments[2]),this._color.set(r,g,b),this._updateFinalColor()},_proto.updateShadow=function updateShadow(){2!==this.shadowUpdateMode&&(this.shadowUpdateMode=1)},_proto.layersDirty=function layersDirty(){var _this$_scene;null!=(_this$_scene=this._scene)&&_this$_scene.layers&&(this._scene.layers._dirtyLights=!0)},_proto.updateKey=function updateKey(){var key=this._type<<29|(this._castShadows?1:0)<<28|this._shadowType<<25|this._falloffMode<<23|(0!==this._normalOffsetBias?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|chanId[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12|this._shape<<10|this.numCascades-1<<8;3===this._cookieChannel.length&&(key|=chanId[this._cookieChannel.charAt(1)]<<16,key|=chanId[this._cookieChannel.charAt(2)]<<14),key!==this.key&&null!==this._scene&&this.layersDirty(),this.key=key},_createClass(Light,[{key:"numCascades",get:function get(){return this.cascades.length},set:function set(value){this.cascades&&this.numCascades==value||(this.cascades=directionalCascades[value-1],this._shadowMatrixPalette=new Float32Array(64),this._shadowCascadeDistances=new Float32Array(4),this._destroyShadowMap(),this.updateKey())}},{key:"shadowMap",get:function get(){return this._shadowMap},set:function set(shadowMap){this._shadowMap!==shadowMap&&(this._destroyShadowMap(),this._shadowMap=shadowMap)}},{key:"type",get:function get(){return this._type},set:function set(value){if(this._type!==value){this._type=value,this._destroyShadowMap(),this.updateKey();var stype=this._shadowType;this._shadowType=null,this.shadowType=stype}}},{key:"shape",get:function get(){return this._shape},set:function set(value){if(this._shape!==value){this._shape=value,this._destroyShadowMap(),this.updateKey();var stype=this._shadowType;this._shadowType=null,this.shadowType=stype}}},{key:"shadowType",get:function get(){return this._shadowType},set:function set(value){if(this._shadowType!==value){var device=this.device;1===this._type&&(value=0),4!==value||device.webgl2||(value=0),3!==value||device.textureFloatRenderable||(value=2),2!==value||device.textureHalfFloatRenderable||(value=1),this._isVsm=value>=1&&value<=3,this._isPcf=4===value||0===value,this._shadowType=value,this._destroyShadowMap(),this.updateKey()}}},{key:"enabled",get:function get(){return this._enabled},set:function set(value){this._enabled!==value&&(this._enabled=value,this.layersDirty())}},{key:"castShadows",get:function get(){return this._castShadows&&4!==this.mask&&0!==this.mask},set:function set(value){this._castShadows!==value&&(this._castShadows=value,this._destroyShadowMap(),this.layersDirty(),this.updateKey())}},{key:"shadowResolution",get:function get(){return this._shadowResolution},set:function set(value){this._shadowResolution!==value&&(value=1===this._type?Math.min(value,this.device.maxCubeMapSize):Math.min(value,this.device.maxTextureSize),this._shadowResolution=value,this._destroyShadowMap())}},{key:"vsmBlurSize",get:function get(){return this._vsmBlurSize},set:function set(value){this._vsmBlurSize!==value&&(value%2==0&&value++,this._vsmBlurSize=value)}},{key:"normalOffsetBias",get:function get(){return this._normalOffsetBias},set:function set(value){this._normalOffsetBias!==value&&((!this._normalOffsetBias&&value||this._normalOffsetBias&&!value)&&this.updateKey(),this._normalOffsetBias=value)}},{key:"falloffMode",get:function get(){return this._falloffMode},set:function set(value){this._falloffMode!==value&&(this._falloffMode=value,this.updateKey())}},{key:"innerConeAngle",get:function get(){return this._innerConeAngle},set:function set(value){this._innerConeAngle!==value&&(this._innerConeAngle=value,this._innerConeAngleCos=Math.cos(value*Math.PI/180))}},{key:"outerConeAngle",get:function get(){return this._outerConeAngle},set:function set(value){this._outerConeAngle!==value&&(this._outerConeAngle=value,this._outerConeAngleCos=Math.cos(value*Math.PI/180))}},{key:"intensity",get:function get(){return this._intensity},set:function set(value){this._intensity!==value&&(this._intensity=value,this._updateFinalColor())}},{key:"cookieMatrix",get:function get(){return this._cookieMatrix||(this._cookieMatrix=new Mat4),this._cookieMatrix}},{key:"cookie",get:function get(){return this._cookie},set:function set(value){this._cookie!==value&&(this._cookie=value,this.updateKey())}},{key:"cookieFalloff",get:function get(){return this._cookieFalloff},set:function set(value){this._cookieFalloff!==value&&(this._cookieFalloff=value,this.updateKey())}},{key:"cookieChannel",get:function get(){return this._cookieChannel},set:function set(value){if(this._cookieChannel!==value){if(value.length<3)for(var chr=value.charAt(value.length-1),addLen=3-value.length,i=0;i<addLen;i++)value+=chr;this._cookieChannel=value,this.updateKey()}}},{key:"cookieTransform",get:function get(){return this._cookieTransform},set:function set(value){this._cookieTransform!==value&&(this._cookieTransform=value,this._cookieTransformSet=!!value,value&&!this._cookieOffset&&(this.cookieOffset=new Vec2,this._cookieOffsetSet=!1),this.updateKey())}},{key:"cookieOffset",get:function get(){return this._cookieOffset},set:function set(value){var xformNew;this._cookieOffset!==value&&(!(!this._cookieTransformSet&&!value)&&!value&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=value,this._cookieOffsetSet=!!value,value&&!this._cookieTransform&&(this.cookieTransform=new Vec4(1,1,0,0),this._cookieTransformSet=!1),this.updateKey())}}]),Light}(),MAX_LIGHTMAP_SIZE=2048,PASS_COLOR=0,PASS_DIR=1,tempVec$1=new Vec3,tempSphere=new BoundingSphere,MeshNode=function MeshNode(node,meshInstances){void 0===meshInstances&&(meshInstances=null),this.node=node,node.render?(this.component=node.render,meshInstances=meshInstances||node.render.meshInstances):(this.component=node.model,meshInstances=meshInstances||node.model.model.meshInstances),this.castShadows=this.component.castShadows,this.meshInstances=meshInstances,this.bounds=null,this.renderTargets=[]},LightInfo=function(){function LightInfo(light){this.light=light,this.store(),light.numCascades=1,0!==light.type&&(light._node.getWorldTransform(),light.getBoundingSphere(tempSphere),this.lightBounds=new BoundingBox,this.lightBounds.center.copy(tempSphere.center),this.lightBounds.halfExtents.set(tempSphere.radius,tempSphere.radius,tempSphere.radius))}var _proto=LightInfo.prototype;return _proto.store=function store(){this.mask=this.light.mask,this.shadowUpdateMode=this.light.shadowUpdateMode,this.enabled=this.light.enabled,this.numCascades=this.light.numCascades},_proto.restore=function restore(){this.light.mask=this.mask,this.light.shadowUpdateMode=this.shadowUpdateMode,this.light.enabled=this.enabled,this.light.numCascades=this.numCascades},LightInfo}(),Lightmapper=function(){function Lightmapper(device,root,scene,renderer,assets){this.device=device,this.root=root,this.scene=scene,this.renderer=renderer,this.assets=assets,this.shadowMapCache=renderer._shadowRenderer.shadowMapCache,this._tempSet=new Set,this._initCalled=!1,this.passMaterials=[],this.fog="",this.ambientLight=new Color,this.renderTargets=new Map,this.stats={renderPasses:0,lightmapCount:0,totalRenderTime:0,forwardTime:0,fboTime:0,shadowMapTime:0,compileTime:0,shadersLinked:0}}var _proto2=Lightmapper.prototype;return _proto2.destroy=function destroy(){MeshInstance.decRefLightmap(this.blackTex),this.blackTex=null,this.device=null,this.root=null,this.scene=null,this.renderer=null,this.assets=null},_proto2.initBake=function initBake(device){if(!this._initCalled){this._initCalled=!0,this.dilateShader=createShaderFromCode(device,shaderChunks.fullscreenQuadVS,shaderChunks.dilatePS,"lmDilate"),this.constantTexSource=device.scope.resolve("source"),this.constantPixelOffset=device.scope.resolve("pixelOffset"),this.constantBakeDir=device.scope.resolve("bakeDir"),this.pixelOffset=new Float32Array(2),this.materials=[],this.blackTex=new Texture(this.device,{width:4,height:4,format:7,type:"rgbm"}),this.blackTex.name="lightmapBlack",MeshInstance.incRefLightmap(this.blackTex);var camera=new Camera;camera.clearColor.set(0,0,0,0),camera.clearColorBuffer=!0,camera.clearDepthBuffer=!1,camera.clearStencilBuffer=!1,camera.frustumCulling=!1,camera.projection=1,camera.aspectRatio=1,camera.node=new GraphNode,this.camera=camera}},_proto2.finishBake=function finishBake(bakeNodes){function destroyRT(rt){MeshInstance.decRefLightmap(rt.colorBuffer),rt.destroy()}this.materials=[],this.renderTargets.forEach((function(rt){destroyRT(rt)})),this.renderTargets.clear(),bakeNodes.forEach((function(node){node.renderTargets.forEach((function(rt){destroyRT(rt)})),node.renderTargets.lenght=0}))},_proto2.createMaterials=function createMaterials(device,scene,passCount){for(var xformUv1="#define UV1LAYOUT\n"+shaderChunks.transformVS,bakeLmEnd=shaderChunks.bakeLmEndPS,pass=0;pass<passCount;pass++)if(!this.passMaterials[pass]){var lmMaterial=new StandardMaterial;lmMaterial.chunks.transformVS=xformUv1,0===pass?(lmMaterial.chunks.endPS=bakeLmEnd,lmMaterial.ambient=new Color(0,0,0),lmMaterial.ambientTint=!0,lmMaterial.lightMap=this.blackTex):(lmMaterial.chunks.basePS=shaderChunks.basePS+"\nuniform sampler2D texture_dirLightMap;\nuniform float bakeDir;\n",lmMaterial.chunks.endPS=shaderChunks.bakeDirLmEndPS),lmMaterial.chunks.outputAlphaPS="\n",lmMaterial.chunks.outputAlphaOpaquePS="\n",lmMaterial.chunks.outputAlphaPremulPS="\n",lmMaterial.cull=0,lmMaterial.forceUv1=!0,lmMaterial.update(),lmMaterial.updateShader(device,scene),lmMaterial.name="lmMaterial"+pass,this.passMaterials[pass]=lmMaterial}},_proto2.createTexture=function createTexture(size,type,name){var tex=new Texture(this.device,{width:size,height:size,format:7,mipmaps:!1,type:type,minFilter:0,magFilter:0});return tex.name=name,tex},_proto2.collectModels=function collectModels(node,bakeNodes,allNodes){var _node$model,_node$model2,_node$render;if(node.enabled){var meshInstances;if(null!=(_node$model=node.model)&&_node$model.model&&null!=(_node$model2=node.model)&&_node$model2.enabled&&(allNodes&&allNodes.push(new MeshNode(node)),node.model.lightmapped&&bakeNodes&&(meshInstances=node.model.model.meshInstances)),null!=(_node$render=node.render)&&_node$render.enabled&&(allNodes&&allNodes.push(new MeshNode(node)),node.render.lightmapped&&bakeNodes&&(meshInstances=node.render.meshInstances)),meshInstances){for(var hasUv1=!0,i=0;i<meshInstances.length;i++)if(!meshInstances[i].mesh.vertexBuffer.format.hasUv1){hasUv1=!1;break}if(hasUv1){for(var notInstancedMeshInstances=[],_i=0;_i<meshInstances.length;_i++){var mesh=meshInstances[_i].mesh;this._tempSet.has(mesh)?bakeNodes.push(new MeshNode(node,[meshInstances[_i]])):notInstancedMeshInstances.push(meshInstances[_i]),this._tempSet.add(mesh)}this._tempSet.clear(),notInstancedMeshInstances.length>0&&bakeNodes.push(new MeshNode(node,notInstancedMeshInstances))}}for(var _i2=0;_i2<node._children.length;_i2++)this.collectModels(node._children[_i2],bakeNodes,allNodes)}},_proto2.prepareShadowCasters=function prepareShadowCasters(nodes){for(var casters=[],n=0;n<nodes.length;n++){var component=nodes[n].component;if(component.castShadows=component.castShadowsLightmap,component.castShadowsLightmap)for(var meshes=nodes[n].meshInstances,i=0;i<meshes.length;i++)meshes[i].visibleThisFrame=!0,casters.push(meshes[i])}return casters},_proto2.updateTransforms=function updateTransforms(nodes){for(var i=0;i<nodes.length;i++)for(var meshInstances=nodes[i].meshInstances,j=0;j<meshInstances.length;j++)meshInstances[j].node.getWorldTransform()},_proto2.calculateLightmapSize=function calculateLightmapSize(node){var data,parent,sizeMult=this.scene.lightmapSizeMultiplier||16,scale=tempVec$1,srcArea,lightmapSizeMultiplier;node.model?(lightmapSizeMultiplier=node.model.lightmapSizeMultiplier,node.model.asset?(data=this.assets.get(node.model.asset).data).area&&(srcArea=data.area):node.model._area&&(data=node.model)._area&&(srcArea=data._area)):node.render&&(lightmapSizeMultiplier=node.render.lightmapSizeMultiplier,"asset"!==node.render.type&&node.render._area&&(data=node.render)._area&&(srcArea=data._area));var area={x:1,y:1,z:1,uv:1};srcArea&&(area.x=srcArea.x,area.y=srcArea.y,area.z=srcArea.z,area.uv=srcArea.uv);var areaMult=lightmapSizeMultiplier||1;for(area.x*=areaMult,area.y*=areaMult,area.z*=areaMult,scale.copy(node.localScale),parent=node._parent;parent;)scale.mul(parent.localScale),parent=parent._parent;scale.x=Math.abs(scale.x),scale.y=Math.abs(scale.y),scale.z=Math.abs(scale.z);var totalArea=area.x*scale.y*scale.z+area.y*scale.x*scale.z+area.z*scale.x*scale.y;return totalArea/=area.uv,totalArea=Math.sqrt(totalArea),Math.min(math.nextPowerOfTwo(totalArea*sizeMult),this.scene.lightmapMaxResolution||2048)},_proto2.setLightmaping=function setLightmaping(nodes,value,passCount,shaderDefs){for(var i=0;i<nodes.length;i++)for(var node=nodes[i],meshInstances=node.meshInstances,j=0;j<meshInstances.length;j++){var meshInstance=meshInstances[j];if(meshInstance.setLightmapped(value),value){shaderDefs&&(meshInstance._shaderDefs|=shaderDefs),meshInstance.mask=2;for(var pass=0;pass<passCount;pass++){var tex=node.renderTargets[pass].colorBuffer;tex.minFilter=1,tex.magFilter=1,meshInstance.setRealtimeLightmap(MeshInstance.lightmapParamNames[pass],tex)}}}},_proto2.bake=function bake(nodes,mode){void 0===mode&&(mode=1);var device=this.device,startTime=now();this.stats.renderPasses=0,this.stats.shadowMapTime=0,this.stats.forwardTime=0;var startShaders=device._shaderStats.linked,startFboTime=device._renderTargetCreationTime,startCompileTime=device._shaderStats.compileTime,bakeNodes=[],allNodes=[];if(nodes){for(var i=0;i<nodes.length;i++)this.collectModels(nodes[i],bakeNodes,null);this.collectModels(this.root,null,allNodes)}else this.collectModels(this.root,bakeNodes,allNodes);if(bakeNodes.length>0){var passCount=1===mode?2:1;this.setLightmaping(bakeNodes,!1,passCount),this.initBake(device),this.bakeInternal(passCount,bakeNodes,allNodes);var shaderDefs=1===mode?192:64;this.setLightmaping(bakeNodes,!0,passCount,shaderDefs),this.finishBake(bakeNodes)}var nowTime=now();this.stats.totalRenderTime=nowTime-startTime,this.stats.shadersLinked=device._shaderStats.linked-startShaders,this.stats.compileTime=device._shaderStats.compileTime-startCompileTime,this.stats.fboTime=device._renderTargetCreationTime-startFboTime,this.stats.lightmapCount=bakeNodes.length},_proto2.allocateTextures=function allocateTextures(bakeNodes,passCount){for(var i=0;i<bakeNodes.length;i++){for(var bakeNode=bakeNodes[i],size=this.calculateLightmapSize(bakeNode.node),pass=0;pass<passCount;pass++){var tex=this.createTexture(size,"default","lightmapper_lightmap_"+i);MeshInstance.incRefLightmap(tex),bakeNode.renderTargets[pass]=new RenderTarget({colorBuffer:tex,depth:!1})}if(!this.renderTargets.has(size)){var _tex=this.createTexture(size,"default","lightmapper_temp_lightmap_"+size);MeshInstance.incRefLightmap(_tex),this.renderTargets.set(size,new RenderTarget({colorBuffer:_tex,depth:!1}))}}},_proto2.prepareLightsToBake=function prepareLightsToBake(layerComposition,allLights,bakeLights){for(var sceneLights=layerComposition._lights,i=0;i<sceneLights.length;i++){var light=sceneLights[i],lightInfo=new LightInfo(light);allLights.push(lightInfo),light.enabled&&0!=(4&light.mask)&&(light.isStatic=!1,light.mask=4294967295,light.shadowUpdateMode=0===light.type?2:1,bakeLights.push(lightInfo))}bakeLights.sort()},_proto2.restoreLights=function restoreLights(allLights){for(var i=0;i<allLights.length;i++)allLights[i].restore()},_proto2.setupScene=function setupScene(){this.revertStatic=!1,this.scene._needsStaticPrepare&&(this.scene._needsStaticPrepare=!1,this.revertStatic=!0),this.fog=this.scene.fog,this.ambientLight.copy(this.scene.ambientLight),this.scene.fog="none",this.scene.ambientLight.set(0,0,0)},_proto2.restoreScene=function restoreScene(){this.scene.fog=this.fog,this.scene.ambientLight.copy(this.ambientLight),this.revertStatic&&(this.scene._needsStaticPrepare=!0)},_proto2.computeNodeBounds=function computeNodeBounds(nodes){for(var bounds=new BoundingBox,i=0;i<nodes.length;i++){var meshInstances=nodes[i].meshInstances;if(meshInstances.length>0){bounds.copy(meshInstances[0].aabb);for(var m=1;m<meshInstances.length;m++)bounds.add(meshInstances[m].aabb)}nodes[i].bounds=bounds.clone()}},_proto2.computeBounds=function computeBounds(meshInstances){for(var bounds=new BoundingBox,i=0;i<meshInstances.length;i++){bounds.copy(meshInstances[0].aabb);for(var m=1;m<meshInstances.length;m++)bounds.add(meshInstances[m].aabb)}return bounds},_proto2.backupMaterials=function backupMaterials(meshInstances){for(var i=0;i<meshInstances.length;i++)this.materials[i]=meshInstances[i].material},_proto2.restoreMaterials=function restoreMaterials(meshInstances){for(var i=0;i<meshInstances.length;i++)meshInstances[i].material=this.materials[i]},_proto2.lightCameraPrepare=function lightCameraPrepare(device,bakeLight){var light=bakeLight.light,shadowCam,lightRenderData;2===light.type&&((shadowCam=light.getRenderData(null,0).shadowCamera)._node.setPosition(light._node.getPosition()),shadowCam._node.setRotation(light._node.getRotation()),shadowCam._node.rotateLocal(-90,0,0),shadowCam.projection=0,shadowCam.nearClip=light.attenuationEnd/1e3,shadowCam.farClip=light.attenuationEnd,shadowCam.aspectRatio=1,shadowCam.fov=2*light._outerConeAngle,this.renderer.updateCameraFrustum(shadowCam));return shadowCam},_proto2.lightCameraPrepareAndCull=function lightCameraPrepareAndCull(bakeLight,bakeNode,shadowCam,casterBounds){var light=bakeLight.light,lightAffectsNode=!0;if(0===light.type){tempVec$1.copy(casterBounds.center),tempVec$1.y+=casterBounds.halfExtents.y,this.camera.node.setPosition(tempVec$1),this.camera.node.setEulerAngles(-90,0,0),this.camera.nearClip=0,this.camera.farClip=2*casterBounds.halfExtents.y;var frustumSize=Math.max(casterBounds.halfExtents.x,casterBounds.halfExtents.z);this.camera.orthoHeight=frustumSize}else bakeLight.lightBounds.intersects(bakeNode.bounds)||(lightAffectsNode=!1);if(2===light.type){for(var nodeVisible=!1,meshInstances=bakeNode.meshInstances,i=0;i<meshInstances.length;i++)if(meshInstances[i]._isVisible(shadowCam)){nodeVisible=!0;break}nodeVisible||(lightAffectsNode=!1)}return lightAffectsNode},_proto2.setupLightArray=function setupLightArray(lightArray,light){lightArray[0].length=0,lightArray[1].length=0,lightArray[2].length=0,lightArray[light.type][0]=light},_proto2.renderShadowMap=function renderShadowMap(shadowMapRendered,casters,lightArray,bakeLight){var light=bakeLight.light;return!shadowMapRendered&&light.castShadows&&(light.shadowMap=this.shadowMapCache.get(this.device,light),0===light.type?this.renderer._shadowRenderer.cullDirectional(light,casters,this.camera):this.renderer._shadowRenderer.cullLocal(light,casters),this.renderer.renderShadows(lightArray[light.type],this.camera)),!0},_proto2.dilateTextures=function dilateTextures(device,bakeNodes,passCount){for(var numDilates2x=4,pixelOffset=this.pixelOffset,dilateShader=this.dilateShader,constantTexSource=this.constantTexSource,constantPixelOffset=this.constantPixelOffset,node=0;node<bakeNodes.length;node++)for(var bakeNode=bakeNodes[node],pass=0;pass<passCount;pass++){var nodeRT=bakeNode.renderTargets[pass],lightmap=nodeRT.colorBuffer,tempRT=this.renderTargets.get(lightmap.width),tempTex=tempRT.colorBuffer;pixelOffset[0]=1/lightmap.width,pixelOffset[1]=1/lightmap.height,constantPixelOffset.setValue(pixelOffset);for(var i=0;i<4;i++)constantTexSource.setValue(lightmap),drawQuadWithShader(device,tempRT,dilateShader),constantTexSource.setValue(tempTex),drawQuadWithShader(device,nodeRT,dilateShader)}},_proto2.bakeInternal=function bakeInternal(passCount,bakeNodes,allNodes){var scene=this.scene,device=this.device;this.createMaterials(device,scene,passCount),this.setupScene(),scene.layers._update(),this.allocateTextures(bakeNodes,passCount);var allLights=[],bakeLights=[];this.prepareLightsToBake(scene.layers,allLights,bakeLights),this.updateTransforms(allNodes);var casters=this.prepareShadowCasters(allNodes);this.renderer.updateMorphing(casters),this.renderer.updateCpuSkinMatrices(casters),this.renderer.gpuUpdate(casters),this.computeNodeBounds(bakeNodes);var casterBounds=this.computeBounds(casters),i,j,rcv,m;for(i=0;i<bakeNodes.length;i++){var bakeNode;for(rcv=bakeNodes[i].meshInstances,j=0;j<rcv.length;j++)(m=rcv[j]).setLightmapped(!1),m.mask=4,m.setRealtimeLightmap(MeshInstance.lightmapParamNames[0],m.material.lightMap?m.material.lightMap:this.blackTex),m.setRealtimeLightmap(MeshInstance.lightmapParamNames[1],this.blackTex)}for(j=0;j<bakeLights.length;j++)bakeLights[j].light.enabled=!1;var lightArray=[[],[],[]],pass,node,shadersUpdatedOn1stPass=!1;for(i=0;i<bakeLights.length;i++){var _bakeLight$light$shad,bakeLight=bakeLights[i];bakeLight.light.enabled=!0;var shadowMapRendered=!1,shadowCam=this.lightCameraPrepare(device,bakeLight);for(node=0;node<bakeNodes.length;node++){var _bakeNode=bakeNodes[node],lightAffectsNode;if(rcv=_bakeNode.meshInstances,this.lightCameraPrepareAndCull(bakeLight,_bakeNode,shadowCam,casterBounds)){for(this.setupLightArray(lightArray,bakeLight.light),shadowMapRendered=this.renderShadowMap(shadowMapRendered,casters,lightArray,bakeLight),this.backupMaterials(rcv),pass=0;pass<passCount;pass++){var nodeRT=_bakeNode.renderTargets[pass],lightmapSize=_bakeNode.renderTargets[pass].colorBuffer.width,tempRT=this.renderTargets.get(lightmapSize),tempTex=tempRT.colorBuffer;for(0===pass?shadersUpdatedOn1stPass=scene.updateShaders:shadersUpdatedOn1stPass&&(scene.updateShaders=!0),j=0;j<rcv.length;j++)rcv[j].material=this.passMaterials[pass];for(this.renderer.updateShaders(rcv),this.renderer.setCamera(this.camera,tempRT,!0),1===pass&&this.constantBakeDir.setValue(bakeLight.light.bakeDir?1:0),this.renderer._forwardTime=0,this.renderer._shadowMapTime=0,this.renderer.renderForward(this.camera,rcv,rcv.length,lightArray,1),_bakeNode.renderTargets[pass]=tempRT,this.renderTargets.set(lightmapSize,nodeRT),j=0;j<rcv.length;j++)(m=rcv[j]).setRealtimeLightmap(MeshInstance.lightmapParamNames[pass],tempTex),m._shaderDefs|=64}this.restoreMaterials(rcv)}}bakeLight.light.enabled=!1,null!=(_bakeLight$light$shad=bakeLight.light.shadowMap)&&_bakeLight$light$shad.cached&&(this.shadowMapCache.add(bakeLight.light,bakeLight.light.shadowMap),bakeLight.light.shadowMap=null)}for(this.shadowMapCache.clear(),this.dilateTextures(device,bakeNodes,passCount),node=0;node<allNodes.length;node++)allNodes[node].component.castShadows=allNodes[node].castShadows;this.restoreLights(allLights),this.restoreScene()},Lightmapper}(),MorphTarget=function(){function MorphTarget(options){2===arguments.length&&(options=arguments[1]),this.options=options,this._name=options.name,this._defaultWeight=options.defaultWeight||0,this.aabb=options.aabb,this.aabb||(this.aabb=new BoundingBox,options.deltaPositions&&this.aabb.compute(options.deltaPositions)),this.deltaPositions=options.deltaPositions}var _proto=MorphTarget.prototype;return _proto._postInit=function _postInit(){this.options=null},_proto._initVertexBuffers=function _initVertexBuffers(graphicsDevice){var options=this.options;this._vertexBufferPositions=this._createVertexBuffer(graphicsDevice,options.deltaPositions,options.deltaPositionsType),this._vertexBufferNormals=this._createVertexBuffer(graphicsDevice,options.deltaNormals,options.deltaNormalsType),this._vertexBufferPositions&&(this.deltaPositions=this._vertexBufferPositions.lock())},_proto._createVertexBuffer=function _createVertexBuffer(device,data,dataType){var formatDesc;return void 0===dataType&&(dataType=6),data?new VertexBuffer(device,new VertexFormat(device,[{semantic:"ATTR0",components:3,type:dataType}]),data.length/3,0,data):null},_proto._setTexture=function _setTexture(name,texture){this[name]=texture},_proto.destroy=function destroy(){this._vertexBufferPositions&&(this._vertexBufferPositions.destroy(),this._vertexBufferPositions=null),this._vertexBufferNormals&&(this._vertexBufferNormals.destroy(),this._vertexBufferNormals=null),this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null),this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)},_createClass(MorphTarget,[{key:"name",get:function get(){return this._name}},{key:"defaultWeight",get:function get(){return this._defaultWeight}},{key:"morphPositions",get:function get(){return!!this._vertexBufferPositions||!!this.texturePositions}},{key:"morphNormals",get:function get(){return!!this._vertexBufferNormals||!!this.textureNormals}}]),MorphTarget}(),nonUniformScale,uniformScale=1,particleTexChannels$1=4,rotMat=new Mat4,rotMatInv=new Mat4,randomPosTformed=new Vec3,randomPos=new Vec3,rndFactor3Vec=new Vec3,particlePosPrev=new Vec3,velocityVec=new Vec3,localVelocityVec=new Vec3,velocityVec2=new Vec3,localVelocityVec2=new Vec3,radialVelocityVec=new Vec3,particlePos=new Vec3,particleFinalPos=new Vec3,moveDirVec=new Vec3,tmpVec3$1=new Vec3;function frac(f){return f-Math.floor(f)}function saturate$1(x){return Math.max(Math.min(x,1),0)}function glMod(x,y){return x-y*Math.floor(x/y)}function encodeFloatRGBA(v){var encX=frac(v),encY=frac(255*v),encZ=frac(65025*v),encW=frac(160581375*v);return[encX-=encY/255,encY-=encZ/255,encZ-=encW/255,encW-=encW/255]}function encodeFloatRG(v){var encX=frac(v),encY=frac(255*v);return[encX-=encY/255,encY-=encY/255]}var ParticleCPUUpdater=function(){function ParticleCPUUpdater(emitter){this._emitter=emitter}var _proto=ParticleCPUUpdater.prototype;return _proto.calcSpawnPosition=function calcSpawnPosition(particleTex,spawnMatrix,extentsInnerRatioUniform,emitterPos,i){var emitter=this._emitter,rX=Math.random(),rY=Math.random(),rZ=Math.random(),rW=Math.random(),particleRate,startSpawnTime;if(emitter.useCpu&&(particleTex[4*i+0+2*emitter.numParticlesPot*4]=rX,particleTex[4*i+1+2*emitter.numParticlesPot*4]=rY,particleTex[4*i+2+2*emitter.numParticlesPot*4]=rZ),randomPos.x=rX-.5,randomPos.y=rY-.5,randomPos.z=rZ-.5,0===emitter.emitterShape){var max=Math.max(Math.abs(randomPos.x),Math.max(Math.abs(randomPos.y),Math.abs(randomPos.z))),edgeX=max+(.5-max)*extentsInnerRatioUniform[0],edgeY=max+(.5-max)*extentsInnerRatioUniform[1],edgeZ=max+(.5-max)*extentsInnerRatioUniform[2];randomPos.x=edgeX*(max===Math.abs(randomPos.x)?Math.sign(randomPos.x):2*randomPos.x),randomPos.y=edgeY*(max===Math.abs(randomPos.y)?Math.sign(randomPos.y):2*randomPos.y),randomPos.z=edgeZ*(max===Math.abs(randomPos.z)?Math.sign(randomPos.z):2*randomPos.z),emitter.localSpace?randomPosTformed.copy(spawnMatrix.transformPoint(randomPos)):randomPosTformed.copy(emitterPos).add(spawnMatrix.transformPoint(randomPos))}else{randomPos.normalize();var spawnBoundsSphereInnerRatio=0===emitter.emitterRadius?0:emitter.emitterRadiusInner/emitter.emitterRadius,r=rW*(1-spawnBoundsSphereInnerRatio)+spawnBoundsSphereInnerRatio;emitter.localSpace?randomPosTformed.copy(randomPos.mulScalar(r*emitter.emitterRadius)):randomPosTformed.copy(emitterPos).add(randomPos.mulScalar(r*emitter.emitterRadius))}if(startSpawnTime=-(particleRate=math.lerp(emitter.rate,emitter.rate2,rX))*i,emitter.pack8){var packX=(randomPosTformed.x-emitter.worldBounds.center.x)/emitter.worldBoundsSize.x+.5,packY=(randomPosTformed.y-emitter.worldBounds.center.y)/emitter.worldBoundsSize.y+.5,packZ=(randomPosTformed.z-emitter.worldBounds.center.z)/emitter.worldBoundsSize.z+.5,packA=math.lerp(emitter.startAngle*math.DEG_TO_RAD,emitter.startAngle2*math.DEG_TO_RAD,rX);packA=packA%(2*Math.PI)/(2*Math.PI);var rg0=encodeFloatRG(packX);particleTex[4*i]=rg0[0],particleTex[4*i+1]=rg0[1];var ba0=encodeFloatRG(packY);particleTex[4*i+2]=ba0[0],particleTex[4*i+3]=ba0[1];var rg1=encodeFloatRG(packZ);particleTex[4*i+0+4*emitter.numParticlesPot]=rg1[0],particleTex[4*i+1+4*emitter.numParticlesPot]=rg1[1];var ba1=encodeFloatRG(packA);particleTex[4*i+2+4*emitter.numParticlesPot]=ba1[0],particleTex[4*i+3+4*emitter.numParticlesPot]=ba1[1];var a2=1;particleTex[4*i+3+4*emitter.numParticlesPot*2]=1;var maxNegLife=Math.max(emitter.lifetime,(emitter.numParticles-1)*Math.max(emitter.rate,emitter.rate2)),maxPosLife,rgba3=encodeFloatRGBA(startSpawnTime=(startSpawnTime+maxNegLife)/(maxNegLife+(emitter.lifetime+1)));particleTex[4*i+0+4*emitter.numParticlesPot*3]=rgba3[0],particleTex[4*i+1+4*emitter.numParticlesPot*3]=rgba3[1],particleTex[4*i+2+4*emitter.numParticlesPot*3]=rgba3[2],particleTex[4*i+3+4*emitter.numParticlesPot*3]=rgba3[3]}else particleTex[4*i]=randomPosTformed.x,particleTex[4*i+1]=randomPosTformed.y,particleTex[4*i+2]=randomPosTformed.z,particleTex[4*i+3]=math.lerp(emitter.startAngle*math.DEG_TO_RAD,emitter.startAngle2*math.DEG_TO_RAD,rX),particleTex[4*i+3+4*emitter.numParticlesPot]=startSpawnTime},_proto.update=function update(data,vbToSort,particleTex,spawnMatrix,extentsInnerRatioUniform,emitterPos,delta,isOnStop){var a,b,c,i,j,emitter=this._emitter;if(emitter.meshInstance.node){var fullMat=emitter.meshInstance.node.worldTransform;for(j=0;j<12;j++)rotMat.data[j]=fullMat.data[j];rotMatInv.copy(rotMat),rotMatInv.invert(),nonUniformScale=emitter.meshInstance.node.localScale,uniformScale=Math.max(Math.max(nonUniformScale.x,nonUniformScale.y),nonUniformScale.z)}emitterPos=null===emitter.meshInstance.node||emitter.localSpace?Vec3.ZERO:emitter.meshInstance.node.getPosition();var posCam=emitter.camera?emitter.camera._node.getPosition():Vec3.ZERO,vertSize=emitter.useMesh?17:15,cf,cc,rotSpeed,rotSpeed2,scale2,alpha,alpha2,radialSpeed,radialSpeed2,precision1=emitter.precision-1;for(i=0;i<emitter.numParticles;i++){var id=Math.floor(emitter.vbCPU[i*emitter.numParticleVerts*(emitter.useMesh?6:4)+3]),rndFactor=particleTex[4*id+0+2*emitter.numParticlesPot*4];rndFactor3Vec.x=rndFactor,rndFactor3Vec.y=particleTex[4*id+1+2*emitter.numParticlesPot*4],rndFactor3Vec.z=particleTex[4*id+2+2*emitter.numParticlesPot*4];var particleRate=emitter.rate+(emitter.rate2-emitter.rate)*rndFactor,particleLifetime=emitter.lifetime,life=particleTex[4*id+3+4*emitter.numParticlesPot]+delta,nlife=saturate$1(life/particleLifetime),scale=0,alphaDiv=0,angle=0,respawn;(life-delta<=0||life>=particleLifetime)&&this.calcSpawnPosition(particleTex,spawnMatrix,extentsInnerRatioUniform,emitterPos,id);var particleEnabled=life>0&&life<particleLifetime;particleEnabled&&(c=nlife*precision1,cf=Math.floor(c),cc=Math.ceil(c),c%=1,rotSpeed=(a=emitter.qRotSpeed[cf])+((b=emitter.qRotSpeed[cc])-a)*c,rotSpeed2=(a=emitter.qRotSpeed2[cf])+((b=emitter.qRotSpeed2[cc])-a)*c,scale=(a=emitter.qScale[cf])+((b=emitter.qScale[cc])-a)*c,scale2=(a=emitter.qScale2[cf])+((b=emitter.qScale2[cc])-a)*c,alpha=(a=emitter.qAlpha[cf])+((b=emitter.qAlpha[cc])-a)*c,alpha2=(a=emitter.qAlpha2[cf])+((b=emitter.qAlpha2[cc])-a)*c,radialSpeed=(a=emitter.qRadialSpeed[cf])+((b=emitter.qRadialSpeed[cc])-a)*c,radialSpeed+=100*rndFactor%1*((radialSpeed2=(a=emitter.qRadialSpeed2[cf])+((b=emitter.qRadialSpeed2[cc])-a)*c)-radialSpeed),particlePosPrev.x=particleTex[4*id],particlePosPrev.y=particleTex[4*id+1],particlePosPrev.z=particleTex[4*id+2],emitter.localSpace?radialVelocityVec.copy(particlePosPrev):radialVelocityVec.copy(particlePosPrev).sub(emitterPos),radialVelocityVec.normalize().mulScalar(radialSpeed),cf*=3,cc*=3,a=emitter.qLocalVelocity[cf],b=emitter.qLocalVelocity[cc],localVelocityVec.x=a+(b-a)*c,a=emitter.qLocalVelocity[cf+1],b=emitter.qLocalVelocity[cc+1],localVelocityVec.y=a+(b-a)*c,a=emitter.qLocalVelocity[cf+2],b=emitter.qLocalVelocity[cc+2],localVelocityVec.z=a+(b-a)*c,a=emitter.qLocalVelocity2[cf],b=emitter.qLocalVelocity2[cc],localVelocityVec2.x=a+(b-a)*c,a=emitter.qLocalVelocity2[cf+1],b=emitter.qLocalVelocity2[cc+1],localVelocityVec2.y=a+(b-a)*c,a=emitter.qLocalVelocity2[cf+2],b=emitter.qLocalVelocity2[cc+2],localVelocityVec2.z=a+(b-a)*c,a=emitter.qVelocity[cf],b=emitter.qVelocity[cc],velocityVec.x=a+(b-a)*c,a=emitter.qVelocity[cf+1],b=emitter.qVelocity[cc+1],velocityVec.y=a+(b-a)*c,a=emitter.qVelocity[cf+2],b=emitter.qVelocity[cc+2],velocityVec.z=a+(b-a)*c,a=emitter.qVelocity2[cf],b=emitter.qVelocity2[cc],velocityVec2.x=a+(b-a)*c,a=emitter.qVelocity2[cf+1],b=emitter.qVelocity2[cc+1],velocityVec2.y=a+(b-a)*c,a=emitter.qVelocity2[cf+2],b=emitter.qVelocity2[cc+2],velocityVec2.z=a+(b-a)*c,localVelocityVec.x+=(localVelocityVec2.x-localVelocityVec.x)*rndFactor3Vec.x,localVelocityVec.y+=(localVelocityVec2.y-localVelocityVec.y)*rndFactor3Vec.y,localVelocityVec.z+=(localVelocityVec2.z-localVelocityVec.z)*rndFactor3Vec.z,emitter.initialVelocity>0&&(1===emitter.emitterShape?(randomPos.copy(rndFactor3Vec).mulScalar(2).sub(Vec3.ONE).normalize(),localVelocityVec.add(randomPos.mulScalar(emitter.initialVelocity))):localVelocityVec.add(Vec3.FORWARD.mulScalar(emitter.initialVelocity))),velocityVec.x+=(velocityVec2.x-velocityVec.x)*rndFactor3Vec.x,velocityVec.y+=(velocityVec2.y-velocityVec.y)*rndFactor3Vec.y,velocityVec.z+=(velocityVec2.z-velocityVec.z)*rndFactor3Vec.z,rotSpeed+=(rotSpeed2-rotSpeed)*rndFactor3Vec.y,scale=(scale+1e4*rndFactor%1*(scale2-scale))*uniformScale,alphaDiv=1e3*rndFactor%1*(alpha2-alpha),emitter.meshInstance.node&&(emitter.localSpace?(localVelocityVec.x/=nonUniformScale.x,localVelocityVec.y/=nonUniformScale.y,localVelocityVec.z/=nonUniformScale.z):rotMat.transformPoint(localVelocityVec,localVelocityVec)),emitter.localSpace?(rotMatInv.transformPoint(velocityVec,velocityVec),localVelocityVec.add(velocityVec).add(radialVelocityVec)):(localVelocityVec.add(velocityVec.mul(nonUniformScale)),localVelocityVec.add(radialVelocityVec.mul(nonUniformScale))),moveDirVec.copy(localVelocityVec),particlePos.copy(particlePosPrev).add(localVelocityVec.mulScalar(delta)),particleFinalPos.copy(particlePos),particleTex[4*id]=particleFinalPos.x,particleTex[4*id+1]=particleFinalPos.y,particleTex[4*id+2]=particleFinalPos.z,particleTex[4*id+3]+=rotSpeed*delta,emitter.wrap&&emitter.wrapBounds&&(emitter.localSpace||particleFinalPos.sub(emitterPos),particleFinalPos.x=glMod(particleFinalPos.x,emitter.wrapBounds.x)-.5*emitter.wrapBounds.x,particleFinalPos.y=glMod(particleFinalPos.y,emitter.wrapBounds.y)-.5*emitter.wrapBounds.y,particleFinalPos.z=glMod(particleFinalPos.z,emitter.wrapBounds.z)-.5*emitter.wrapBounds.z,emitter.localSpace||particleFinalPos.add(emitterPos)),emitter.sort>0&&(1===emitter.sort?(tmpVec3$1.copy(particleFinalPos).sub(posCam),emitter.particleDistance[id]=-(tmpVec3$1.x*tmpVec3$1.x+tmpVec3$1.y*tmpVec3$1.y+tmpVec3$1.z*tmpVec3$1.z)):2===emitter.sort?emitter.particleDistance[id]=life:3===emitter.sort&&(emitter.particleDistance[id]=-life))),isOnStop?life<0&&(particleTex[4*id+3+2*emitter.numParticlesPot*4]=-1):(life>=particleLifetime&&(life-=Math.max(particleLifetime,(emitter.numParticles-1)*particleRate),particleTex[4*id+3+2*emitter.numParticlesPot*4]=emitter.loop?1:-1),life<0&&emitter.loop&&(particleTex[4*id+3+2*emitter.numParticlesPot*4]=1)),particleTex[4*id+3+2*emitter.numParticlesPot*4]<0&&(particleEnabled=!1),particleTex[4*id+3+4*emitter.numParticlesPot]=life;for(var v=0;v<emitter.numParticleVerts;v++){var vbOffset=(i*emitter.numParticleVerts+v)*(emitter.useMesh?6:4),quadX=emitter.vbCPU[vbOffset],quadY=emitter.vbCPU[vbOffset+1],quadZ=emitter.vbCPU[vbOffset+2];particleEnabled||(quadX=quadY=quadZ=0);var w=i*emitter.numParticleVerts*vertSize+v*vertSize;data[w]=particleFinalPos.x,data[w+1]=particleFinalPos.y,data[w+2]=particleFinalPos.z,data[w+3]=nlife,data[w+4]=emitter.alignToMotion?0:particleTex[4*id+3],data[w+5]=scale,data[w+6]=alphaDiv,data[w+7]=moveDirVec.x,data[w+8]=quadX,data[w+9]=quadY,data[w+10]=quadZ,data[w+11]=moveDirVec.y,data[w+12]=id,data[w+13]=moveDirVec.z,data[w+14]=emitter.vbCPU[vbOffset+3],emitter.useMesh&&(data[w+15]=emitter.vbCPU[vbOffset+4],data[w+16]=emitter.vbCPU[vbOffset+5])}}if(emitter.sort>0&&emitter.camera){var vbStride=emitter.useMesh?6:4,particleDistance=emitter.particleDistance;for(i=0;i<emitter.numParticles;i++)vbToSort[i][0]=i,vbToSort[i][1]=particleDistance[Math.floor(emitter.vbCPU[i*emitter.numParticleVerts*vbStride+3])];for(emitter.vbOld.set(emitter.vbCPU),vbToSort.sort((function(p1,p2){return p1[1]-p2[1]})),i=0;i<emitter.numParticles;i++){var src=vbToSort[i][0]*emitter.numParticleVerts*vbStride,dest=i*emitter.numParticleVerts*vbStride;for(j=0;j<emitter.numParticleVerts*vbStride;j++)emitter.vbCPU[dest+j]=emitter.vbOld[src+j]}}},ParticleCPUUpdater}(),spawnMatrix3=new Mat3,emitterMatrix3=new Mat3,emitterMatrix3Inv=new Mat3,ParticleGPUUpdater=function(){function ParticleGPUUpdater(emitter,gd){this._emitter=emitter,this.frameRandomUniform=new Float32Array(3),this.emitterPosUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),this.worldBoundsMulUniform=new Float32Array(3),this.worldBoundsAddUniform=new Float32Array(3),this.inBoundsSizeUniform=new Float32Array(3),this.inBoundsCenterUniform=new Float32Array(3),this.constantParticleTexIN=gd.scope.resolve("particleTexIN"),this.constantParticleTexOUT=gd.scope.resolve("particleTexOUT"),this.constantEmitterPos=gd.scope.resolve("emitterPos"),this.constantEmitterScale=gd.scope.resolve("emitterScale"),this.constantSpawnBounds=gd.scope.resolve("spawnBounds"),this.constantSpawnPosInnerRatio=gd.scope.resolve("spawnPosInnerRatio"),this.constantSpawnBoundsSphere=gd.scope.resolve("spawnBoundsSphere"),this.constantSpawnBoundsSphereInnerRatio=gd.scope.resolve("spawnBoundsSphereInnerRatio"),this.constantInitialVelocity=gd.scope.resolve("initialVelocity"),this.constantFrameRandom=gd.scope.resolve("frameRandom"),this.constantDelta=gd.scope.resolve("delta"),this.constantRate=gd.scope.resolve("rate"),this.constantRateDiv=gd.scope.resolve("rateDiv"),this.constantLifetime=gd.scope.resolve("lifetime"),this.constantGraphSampleSize=gd.scope.resolve("graphSampleSize"),this.constantGraphNumSamples=gd.scope.resolve("graphNumSamples"),this.constantInternalTex0=gd.scope.resolve("internalTex0"),this.constantInternalTex1=gd.scope.resolve("internalTex1"),this.constantInternalTex2=gd.scope.resolve("internalTex2"),this.constantInternalTex3=gd.scope.resolve("internalTex3"),this.constantEmitterMatrix=gd.scope.resolve("emitterMatrix"),this.constantEmitterMatrixInv=gd.scope.resolve("emitterMatrixInv"),this.constantNumParticles=gd.scope.resolve("numParticles"),this.constantNumParticlesPot=gd.scope.resolve("numParticlesPot"),this.constantLocalVelocityDivMult=gd.scope.resolve("localVelocityDivMult"),this.constantVelocityDivMult=gd.scope.resolve("velocityDivMult"),this.constantRotSpeedDivMult=gd.scope.resolve("rotSpeedDivMult"),this.constantSeed=gd.scope.resolve("seed"),this.constantStartAngle=gd.scope.resolve("startAngle"),this.constantStartAngle2=gd.scope.resolve("startAngle2"),this.constantOutBoundsMul=gd.scope.resolve("outBoundsMul"),this.constantOutBoundsAdd=gd.scope.resolve("outBoundsAdd"),this.constantInBoundsSize=gd.scope.resolve("inBoundsSize"),this.constantInBoundsCenter=gd.scope.resolve("inBoundsCenter"),this.constantMaxVel=gd.scope.resolve("maxVel"),this.constantFaceTangent=gd.scope.resolve("faceTangent"),this.constantFaceBinorm=gd.scope.resolve("faceBinorm")}var _proto=ParticleGPUUpdater.prototype;return _proto._setInputBounds=function _setInputBounds(){this.inBoundsSizeUniform[0]=this._emitter.prevWorldBoundsSize.x,this.inBoundsSizeUniform[1]=this._emitter.prevWorldBoundsSize.y,this.inBoundsSizeUniform[2]=this._emitter.prevWorldBoundsSize.z,this.constantInBoundsSize.setValue(this.inBoundsSizeUniform),this.inBoundsCenterUniform[0]=this._emitter.prevWorldBoundsCenter.x,this.inBoundsCenterUniform[1]=this._emitter.prevWorldBoundsCenter.y,this.inBoundsCenterUniform[2]=this._emitter.prevWorldBoundsCenter.z,this.constantInBoundsCenter.setValue(this.inBoundsCenterUniform)},_proto.randomize=function randomize(){this.frameRandomUniform[0]=Math.random(),this.frameRandomUniform[1]=Math.random(),this.frameRandomUniform[2]=Math.random()},_proto.update=function update(device,spawnMatrix,extentsInnerRatioUniform,delta,isOnStop){var emitter=this._emitter;device.setBlending(!1),device.setColorWrite(!0,!0,!0,!0),device.setCullMode(0),device.setDepthTest(!1),device.setDepthWrite(!1),this.randomize(),this.constantGraphSampleSize.setValue(1/emitter.precision),this.constantGraphNumSamples.setValue(emitter.precision),this.constantNumParticles.setValue(emitter.numParticles),this.constantNumParticlesPot.setValue(emitter.numParticlesPot),this.constantInternalTex0.setValue(emitter.internalTex0),this.constantInternalTex1.setValue(emitter.internalTex1),this.constantInternalTex2.setValue(emitter.internalTex2),this.constantInternalTex3.setValue(emitter.internalTex3);var node=emitter.meshInstance.node,emitterScale=null===node?Vec3.ONE:node.localScale;if(emitter.pack8){this.worldBoundsMulUniform[0]=emitter.worldBoundsMul.x,this.worldBoundsMulUniform[1]=emitter.worldBoundsMul.y,this.worldBoundsMulUniform[2]=emitter.worldBoundsMul.z,this.constantOutBoundsMul.setValue(this.worldBoundsMulUniform),this.worldBoundsAddUniform[0]=emitter.worldBoundsAdd.x,this.worldBoundsAddUniform[1]=emitter.worldBoundsAdd.y,this.worldBoundsAddUniform[2]=emitter.worldBoundsAdd.z,this.constantOutBoundsAdd.setValue(this.worldBoundsAddUniform),this._setInputBounds();var maxVel=emitter.maxVel*Math.max(Math.max(emitterScale.x,emitterScale.y),emitterScale.z);maxVel=Math.max(maxVel,1),this.constantMaxVel.setValue(maxVel)}var emitterPos=null===node||emitter.localSpace?Vec3.ZERO:node.getPosition(),emitterMatrix=null===node?Mat4.IDENTITY:node.getWorldTransform();0===emitter.emitterShape?(spawnMatrix3.setFromMat4(spawnMatrix),this.constantSpawnBounds.setValue(spawnMatrix3.data),this.constantSpawnPosInnerRatio.setValue(extentsInnerRatioUniform)):(this.constantSpawnBoundsSphere.setValue(emitter.emitterRadius),this.constantSpawnBoundsSphereInnerRatio.setValue(0===emitter.emitterRadius?0:emitter.emitterRadiusInner/emitter.emitterRadius)),this.constantInitialVelocity.setValue(emitter.initialVelocity),emitterMatrix3.setFromMat4(emitterMatrix),emitterMatrix.invertTo3x3(emitterMatrix3Inv),this.emitterPosUniform[0]=emitterPos.x,this.emitterPosUniform[1]=emitterPos.y,this.emitterPosUniform[2]=emitterPos.z,this.constantEmitterPos.setValue(this.emitterPosUniform),this.constantFrameRandom.setValue(this.frameRandomUniform),this.constantDelta.setValue(delta),this.constantRate.setValue(emitter.rate),this.constantRateDiv.setValue(emitter.rate2-emitter.rate),this.constantStartAngle.setValue(emitter.startAngle*math.DEG_TO_RAD),this.constantStartAngle2.setValue(emitter.startAngle2*math.DEG_TO_RAD),this.constantSeed.setValue(emitter.seed),this.constantLifetime.setValue(emitter.lifetime),this.emitterScaleUniform[0]=emitterScale.x,this.emitterScaleUniform[1]=emitterScale.y,this.emitterScaleUniform[2]=emitterScale.z,this.constantEmitterScale.setValue(this.emitterScaleUniform),this.constantEmitterMatrix.setValue(emitterMatrix3.data),this.constantEmitterMatrixInv.setValue(emitterMatrix3Inv.data),this.constantLocalVelocityDivMult.setValue(emitter.localVelocityUMax),this.constantVelocityDivMult.setValue(emitter.velocityUMax),this.constantRotSpeedDivMult.setValue(emitter.rotSpeedUMax[0]);var texIN=emitter.swapTex?emitter.particleTexOUT:emitter.particleTexIN;texIN=emitter.beenReset?emitter.particleTexStart:texIN;var texOUT=emitter.swapTex?emitter.particleTexIN:emitter.particleTexOUT;this.constantParticleTexIN.setValue(texIN),drawQuadWithShader(device,emitter.swapTex?emitter.rtParticleTexIN:emitter.rtParticleTexOUT,isOnStop?emitter.shaderParticleUpdateOnStop:emitter.loop?emitter.shaderParticleUpdateRespawn:emitter.shaderParticleUpdateNoRespawn),emitter.material.setParameter("particleTexOUT",texIN),emitter.material.setParameter("particleTexIN",texOUT),emitter.beenReset=!1,emitter.swapTex=!emitter.swapTex,device.setDepthTest(!0),device.setDepthWrite(!0),emitter.prevWorldBoundsSize.copy(emitter.worldBoundsSize),emitter.prevWorldBoundsCenter.copy(emitter.worldBounds.center),emitter.pack8&&this._setInputBounds()},ParticleGPUUpdater}(),particleVerts=[[-1,-1],[1,-1],[1,1],[-1,1]];function _createTexture(device,width,height,pixelData,format,mult8Bit,filter){void 0===format&&(format=14);var mipFilter=0;filter&&7===format&&(mipFilter=1);var texture=new Texture(device,{width:width,height:height,format:format,cubemap:!1,mipmaps:!1,minFilter:mipFilter,magFilter:mipFilter,addressU:1,addressV:1});texture.name="PSTexture";var pixels=texture.lock();if(7===format){for(var temp=new Uint8Array(pixelData.length),i=0;i<pixelData.length;i++)temp[i]=pixelData[i]*mult8Bit*255;pixelData=temp}return pixels.set(pixelData),texture.unlock(),texture}function saturate(x){return Math.max(Math.min(x,1),0)}var default0Curve=new Curve([0,0,1,0]),default1Curve=new Curve([0,1,1,1]),default0Curve3=new CurveSet([0,0,1,0],[0,0,1,0],[0,0,1,0]),default1Curve3=new CurveSet([0,1,1,1],[0,1,1,1],[0,1,1,1]),particleTexHeight=2,particleTexChannels=4,extentsInnerRatioUniform=new Float32Array(3),spawnMatrix=new Mat4,tmpVec3=new Vec3,bMin=new Vec3,bMax=new Vec3,setPropertyTarget,setPropertyOptions;function setProperty(pName,defaultVal){void 0!==setPropertyOptions[pName]&&null!==setPropertyOptions[pName]?setPropertyTarget[pName]=setPropertyOptions[pName]:setPropertyTarget[pName]=defaultVal}function pack3NFloats(a,b,c){var packed;return(255*a<<16|255*b<<8|255*c)/(1<<24)}function packTextureXYZ_NXYZ(qXYZ,qXYZ2){for(var num=qXYZ.length/3,colors=new Array(4*num),i=0;i<num;i++)colors[4*i]=qXYZ[3*i],colors[4*i+1]=qXYZ[3*i+1],colors[4*i+2]=qXYZ[3*i+2],colors[4*i+3]=pack3NFloats(qXYZ2[3*i],qXYZ2[3*i+1],qXYZ2[3*i+2]);return colors}function packTextureRGBA(qRGB,qA){for(var colors=new Array(4*qA.length),i=0;i<qA.length;i++)colors[4*i]=qRGB[3*i],colors[4*i+1]=qRGB[3*i+1],colors[4*i+2]=qRGB[3*i+2],colors[4*i+3]=qA[i];return colors}function packTexture5Floats(qA,qB,qC,qD,qE){for(var colors=new Array(4*qA.length),i=0;i<qA.length;i++)colors[4*i]=qA[i],colors[4*i+1]=qB[i],colors[4*i+2]=0,colors[4*i+3]=pack3NFloats(qC[i],qD[i],qE[i]);return colors}function packTexture2Floats(qA,qB){for(var colors=new Array(4*qA.length),i=0;i<qA.length;i++)colors[4*i]=qA[i],colors[4*i+1]=qB[i],colors[4*i+2]=0,colors[4*i+3]=0;return colors}function calcEndTime(emitter){var interval=Math.max(emitter.rate,emitter.rate2)*emitter.numParticles+emitter.lifetime;return Date.now()+1e3*interval}function subGraph(A,B){for(var r=new Float32Array(A.length),i=0;i<A.length;i++)r[i]=A[i]-B[i];return r}function maxUnsignedGraphValue(A,outUMax){var i,j,chans=outUMax.length,values=A.length/chans;for(i=0;i<values;i++)for(j=0;j<chans;j++){var a=Math.abs(A[i*chans+j]);outUMax[j]=Math.max(outUMax[j],a)}}function normalizeGraph(A,uMax){var chans=uMax.length,i,j,values=A.length/chans;for(i=0;i<values;i++)for(j=0;j<chans;j++)A[i*chans+j]/=0===uMax[j]?1:uMax[j],A[i*chans+j]*=.5,A[i*chans+j]+=.5}function divGraphFrom2Curves(curve1,curve2,outUMax){var sub=subGraph(curve2,curve1);return maxUnsignedGraphValue(sub,outUMax),normalizeGraph(sub,outUMax),sub}var ParticleEmitter=function(){function ParticleEmitter(graphicsDevice,options){this.graphicsDevice=graphicsDevice;var gd=graphicsDevice,precision=32;if(this.precision=32,this._addTimeTime=0,!ParticleEmitter.DEFAULT_PARAM_TEXTURE){var resolution=16,centerPoint=8.5,dtex=new Float32Array(1024),x,y,xgrad,ygrad,p,c;for(y=0;y<16;y++)for(x=0;x<16;x++)xgrad=x+1-8.5,ygrad=y+1-8.5,c=saturate(1-saturate(Math.sqrt(xgrad*xgrad+ygrad*ygrad)/16)-.5),dtex[4*(p=16*y+x)]=1,dtex[4*p+1]=1,dtex[4*p+2]=1,dtex[4*p+3]=c;ParticleEmitter.DEFAULT_PARAM_TEXTURE=_createTexture(gd,16,16,dtex,7,1,!0),ParticleEmitter.DEFAULT_PARAM_TEXTURE.minFilter=1,ParticleEmitter.DEFAULT_PARAM_TEXTURE.magFilter=1}setPropertyTarget=this,setPropertyOptions=options,setProperty("numParticles",1),this.numParticles>graphicsDevice.maxTextureSize&&(console.warn("WARNING: can't create more than "+graphicsDevice.maxTextureSize+" particles on this device."),this.numParticles=graphicsDevice.maxTextureSize),setProperty("rate",1),setProperty("rate2",this.rate),setProperty("lifetime",50),setProperty("emitterExtents",new Vec3(0,0,0)),setProperty("emitterExtentsInner",new Vec3(0,0,0)),setProperty("emitterRadius",0),setProperty("emitterRadiusInner",0),setProperty("emitterShape",0),setProperty("initialVelocity",1),setProperty("wrap",!1),setProperty("localSpace",!1),setProperty("screenSpace",!1),setProperty("wrapBounds",null),setProperty("colorMap",ParticleEmitter.DEFAULT_PARAM_TEXTURE),setProperty("normalMap",null),setProperty("loop",!0),setProperty("preWarm",!1),setProperty("sort",0),setProperty("mode",0),setProperty("scene",null),setProperty("lighting",!1),setProperty("halfLambert",!1),setProperty("intensity",1),setProperty("stretch",0),setProperty("alignToMotion",!1),setProperty("depthSoftening",0),setProperty("mesh",null),setProperty("particleNormal",new Vec3(0,1,0)),setProperty("orientation",0),setProperty("depthWrite",!1),setProperty("noFog",!1),setProperty("blendType",2),setProperty("node",null),setProperty("startAngle",0),setProperty("startAngle2",this.startAngle),setProperty("animTilesX",1),setProperty("animTilesY",1),setProperty("animStartFrame",0),setProperty("animNumFrames",1),setProperty("animNumAnimations",1),setProperty("animIndex",0),setProperty("randomizeAnimIndex",!1),setProperty("animSpeed",1),setProperty("animLoop",!0),this._gpuUpdater=new ParticleGPUUpdater(this,gd),this._cpuUpdater=new ParticleCPUUpdater(this),this.constantLightCube=gd.scope.resolve("lightCube[0]"),this.emitterPosUniform=new Float32Array(3),this.wrapBoundsUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),setProperty("colorGraph",default1Curve3),setProperty("colorGraph2",this.colorGraph),setProperty("scaleGraph",default1Curve),setProperty("scaleGraph2",this.scaleGraph),setProperty("alphaGraph",default1Curve),setProperty("alphaGraph2",this.alphaGraph),setProperty("localVelocityGraph",default0Curve3),setProperty("localVelocityGraph2",this.localVelocityGraph),setProperty("velocityGraph",default0Curve3),setProperty("velocityGraph2",this.velocityGraph),setProperty("rotationSpeedGraph",default0Curve),setProperty("rotationSpeedGraph2",this.rotationSpeedGraph),setProperty("radialSpeedGraph",default0Curve),setProperty("radialSpeedGraph2",this.radialSpeedGraph),this.lightCube=new Float32Array(18),this.lightCubeDir=new Array(6),this.lightCubeDir[0]=new Vec3(-1,0,0),this.lightCubeDir[1]=new Vec3(1,0,0),this.lightCubeDir[2]=new Vec3(0,-1,0),this.lightCubeDir[3]=new Vec3(0,1,0),this.lightCubeDir[4]=new Vec3(0,0,-1),this.lightCubeDir[5]=new Vec3(0,0,1),this.animTilesParams=new Float32Array(2),this.animParams=new Float32Array(4),this.animIndexParams=new Float32Array(2),this.internalTex0=null,this.internalTex1=null,this.internalTex2=null,this.colorParam=null,this.vbToSort=null,this.vbOld=null,this.particleDistance=null,this.camera=null,this.swapTex=!1,this.useMesh=!0,this.useCpu=!1,this.pack8=!0,this.localBounds=new BoundingBox,this.worldBoundsNoTrail=new BoundingBox,this.worldBoundsTrail=[new BoundingBox,new BoundingBox],this.worldBounds=new BoundingBox,this.worldBoundsSize=new Vec3,this.prevWorldBoundsSize=new Vec3,this.prevWorldBoundsCenter=new Vec3,this.prevEmitterExtents=this.emitterExtents,this.prevEmitterRadius=this.emitterRadius,this.worldBoundsMul=new Vec3,this.worldBoundsAdd=new Vec3,this.timeToSwitchBounds=0,this.shaderParticleUpdateRespawn=null,this.shaderParticleUpdateNoRespawn=null,this.shaderParticleUpdateOnStop=null,this.numParticleVerts=0,this.numParticleIndices=0,this.material=null,this.meshInstance=null,this.drawOrder=0,this.seed=Math.random(),this.fixedTimeStep=1/60,this.maxSubSteps=10,this.simTime=0,this.simTimeTotal=0,this.beenReset=!1,this._layer=null,this.rebuild()}var _proto=ParticleEmitter.prototype;return _proto.onChangeCamera=function onChangeCamera(){this.regenShader(),this.resetMaterial()},_proto.calculateBoundsMad=function calculateBoundsMad(){this.worldBoundsMul.x=1/this.worldBoundsSize.x,this.worldBoundsMul.y=1/this.worldBoundsSize.y,this.worldBoundsMul.z=1/this.worldBoundsSize.z,this.worldBoundsAdd.copy(this.worldBounds.center).mul(this.worldBoundsMul).mulScalar(-1),this.worldBoundsAdd.x+=.5,this.worldBoundsAdd.y+=.5,this.worldBoundsAdd.z+=.5},_proto.calculateWorldBounds=function calculateWorldBounds(){if(this.node){if(this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),!this.useCpu){var recalculateLocalBounds=!1;(recalculateLocalBounds=0===this.emitterShape?!this.emitterExtents.equals(this.prevEmitterExtents):!(this.emitterRadius===this.prevEmitterRadius))&&this.calculateLocalBounds()}var nodeWT=this.node.getWorldTransform();this.localSpace?this.worldBoundsNoTrail.copy(this.localBounds):this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,nodeWT),this.worldBoundsTrail[0].add(this.worldBoundsNoTrail),this.worldBoundsTrail[1].add(this.worldBoundsNoTrail);var now=this.simTimeTotal;now>=this.timeToSwitchBounds&&(this.worldBoundsTrail[0].copy(this.worldBoundsTrail[1]),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.timeToSwitchBounds=now+this.lifetime),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.localSpace?(this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,nodeWT),this.meshInstance.mesh.aabb.setFromTransformedAabb(this.worldBounds,nodeWT)):(this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance.mesh.aabb.copy(this.worldBounds)),this.meshInstance._aabbVer=1-this.meshInstance._aabbVer,this.pack8&&this.calculateBoundsMad()}},_proto.resetWorldBounds=function resetWorldBounds(){this.node&&(this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,this.localSpace?Mat4.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBoundsNoTrail),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.simTimeTotal=0,this.timeToSwitchBounds=0)},_proto.calculateLocalBounds=function calculateLocalBounds(){var minx=Number.MAX_VALUE,miny=Number.MAX_VALUE,minz=Number.MAX_VALUE,maxx=-Number.MAX_VALUE,maxy=-Number.MAX_VALUE,maxz=-Number.MAX_VALUE,maxR=0,maxScale=0,stepWeight=this.lifetime/this.precision,wVels=[this.qVelocity,this.qVelocity2],lVels=[this.qLocalVelocity,this.qLocalVelocity2],accumX=[0,0],accumY=[0,0],accumZ=[0,0],accumR=[0,0],accumW=[0,0],i,j,index,x,y,z;for(i=0;i<this.precision+1;i++){for(index=Math.min(i,this.precision-1),j=0;j<2;j++)x=lVels[j][3*index+0]*stepWeight+accumX[j],y=lVels[j][3*index+1]*stepWeight+accumY[j],z=lVels[j][3*index+2]*stepWeight+accumZ[j],minx=Math.min(x,minx),miny=Math.min(y,miny),minz=Math.min(z,minz),maxx=Math.max(x,maxx),maxy=Math.max(y,maxy),maxz=Math.max(z,maxz),accumX[j]=x,accumY[j]=y,accumZ[j]=z;for(j=0;j<2;j++)accumW[j]+=stepWeight*Math.sqrt(wVels[j][3*index+0]*wVels[j][3*index+0]+wVels[j][3*index+1]*wVels[j][3*index+1]+wVels[j][3*index+2]*wVels[j][3*index+2]);accumR[0]+=this.qRadialSpeed[index]*stepWeight,accumR[1]+=this.qRadialSpeed2[index]*stepWeight,maxR=Math.max(maxR,Math.max(Math.abs(accumR[0]),Math.abs(accumR[1]))),maxScale=Math.max(maxScale,this.qScale[index])}0===this.emitterShape?(x=.5*this.emitterExtents.x,y=.5*this.emitterExtents.y,z=.5*this.emitterExtents.z):(x=this.emitterRadius,y=this.emitterRadius,z=this.emitterRadius);var w=Math.max(accumW[0],accumW[1]);bMin.x=minx-maxScale-x-maxR-w,bMin.y=miny-maxScale-y-maxR-w,bMin.z=minz-maxScale-z-maxR-w,bMax.x=maxx+maxScale+x+maxR+w,bMax.y=maxy+maxScale+y+maxR+w,bMax.z=maxz+maxScale+z+maxR+w,this.localBounds.setMinMax(bMin,bMax)},_proto.rebuild=function rebuild(){var i,gd=this.graphicsDevice,totalVertCount;(null===this.colorMap&&(this.colorMap=ParticleEmitter.DEFAULT_PARAM_TEXTURE),this.spawnBounds=0===this.emitterShape?this.emitterExtents:this.emitterRadius,this.useCpu=this.useCpu||this.sort>0||gd.maxVertexTextures<=1||gd.fragmentUniformsCount<64||gd.forceCpuParticles||!gd.extTextureFloat,this._destroyResources(),this.pack8=(this.pack8||!gd.textureFloatRenderable)&&!this.useCpu,particleTexHeight=this.useCpu||this.pack8?4:2,this.useMesh=!1,this.mesh)&&(this.numParticles*this.mesh.vertexBuffer.numVertices>65535?console.warn("WARNING: particle system can't render mesh particles because numParticles * numVertices is more than 65k. Reverting to quad particles."):this.useMesh=!0);this.numParticlesPot=math.nextPowerOfTwo(this.numParticles),this.rebuildGraphs(),this.calculateLocalBounds(),this.resetWorldBounds(),this.node&&(this.worldBounds.setFromTransformedAabb(this.localBounds,this.localSpace?Mat4.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBounds),this.worldBoundsTrail[1].copy(this.worldBounds),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.pack8&&this.calculateBoundsMad()),this.vbToSort=new Array(this.numParticles);for(var iSort=0;iSort<this.numParticles;iSort++)this.vbToSort[iSort]=[0,0];this.particleDistance=new Float32Array(this.numParticles),this._gpuUpdater.randomize(),this.particleTex=new Float32Array(this.numParticlesPot*particleTexHeight*4);var emitterPos=null===this.node||this.localSpace?Vec3.ZERO:this.node.getPosition();for(0===this.emitterShape&&(null===this.node||this.localSpace?spawnMatrix.setTRS(Vec3.ZERO,Quat.IDENTITY,this.spawnBounds):spawnMatrix.setTRS(Vec3.ZERO,this.node.getRotation(),tmpVec3.copy(this.spawnBounds).mul(this.node.localScale)),extentsInnerRatioUniform[0]=0!==this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,extentsInnerRatioUniform[1]=0!==this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,extentsInnerRatioUniform[2]=0!==this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0),i=0;i<this.numParticles;i++)this._cpuUpdater.calcSpawnPosition(this.particleTex,spawnMatrix,extentsInnerRatioUniform,emitterPos,i),this.useCpu&&(this.particleTex[4*i+3+2*this.numParticlesPot*4]=1);for(this.particleTexStart=new Float32Array(this.numParticlesPot*particleTexHeight*4),i=0;i<this.particleTexStart.length;i++)this.particleTexStart[i]=this.particleTex[i];this.useCpu||(this.pack8?(this.particleTexIN=_createTexture(gd,this.numParticlesPot,particleTexHeight,this.particleTex,7,1,!1),this.particleTexOUT=_createTexture(gd,this.numParticlesPot,particleTexHeight,this.particleTex,7,1,!1),this.particleTexStart=_createTexture(gd,this.numParticlesPot,particleTexHeight,this.particleTexStart,7,1,!1)):(this.particleTexIN=_createTexture(gd,this.numParticlesPot,particleTexHeight,this.particleTex),this.particleTexOUT=_createTexture(gd,this.numParticlesPot,particleTexHeight,this.particleTex),this.particleTexStart=_createTexture(gd,this.numParticlesPot,particleTexHeight,this.particleTexStart)),this.rtParticleTexIN=new RenderTarget({colorBuffer:this.particleTexIN,depth:!1}),this.rtParticleTexOUT=new RenderTarget({colorBuffer:this.particleTexOUT,depth:!1}),this.swapTex=!1);var shaderCodeStart=(this.localSpace?"#define LOCAL_SPACE\n":"")+shaderChunks.particleUpdaterInitPS+(this.pack8?shaderChunks.particleInputRgba8PS+shaderChunks.particleOutputRgba8PS:shaderChunks.particleInputFloatPS+shaderChunks.particleOutputFloatPS)+(0===this.emitterShape?shaderChunks.particleUpdaterAABBPS:shaderChunks.particleUpdaterSpherePS)+shaderChunks.particleUpdaterStartPS,shaderCodeRespawn=shaderCodeStart+shaderChunks.particleUpdaterRespawnPS+shaderChunks.particleUpdaterEndPS,shaderCodeNoRespawn=shaderCodeStart+shaderChunks.particleUpdaterNoRespawnPS+shaderChunks.particleUpdaterEndPS,shaderCodeOnStop=shaderCodeStart+shaderChunks.particleUpdaterOnStopPS+shaderChunks.particleUpdaterEndPS,params=this.emitterShape+""+this.pack8+this.localSpace;this.shaderParticleUpdateRespawn=createShaderFromCode(gd,shaderChunks.fullscreenQuadVS,shaderCodeRespawn,"fsQuad0"+params),this.shaderParticleUpdateNoRespawn=createShaderFromCode(gd,shaderChunks.fullscreenQuadVS,shaderCodeNoRespawn,"fsQuad1"+params),this.shaderParticleUpdateOnStop=createShaderFromCode(gd,shaderChunks.fullscreenQuadVS,shaderCodeOnStop,"fsQuad2"+params),this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4,this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6,this._allocate(this.numParticles);var mesh=new Mesh(gd);mesh.vertexBuffer=this.vertexBuffer,mesh.indexBuffer[0]=this.indexBuffer,mesh.primitive[0].type=4,mesh.primitive[0].base=0,mesh.primitive[0].count=this.numParticles*this.numParticleIndices,mesh.primitive[0].indexed=!0,this.material=new Material,this.material.name=this.node.name,this.material.cull=0,this.material.alphaWrite=!1,this.material.blend=!0,this.material.blendType=this.blendType,this.material.depthWrite=this.depthWrite,this.material.emitter=this,this.regenShader(),this.resetMaterial();var wasVisible=!this.meshInstance||this.meshInstance.visible;this.meshInstance=new MeshInstance(mesh,this.material,this.node),this.meshInstance.pick=!1,this.meshInstance.updateKey(),this.meshInstance.cull=!0,this.meshInstance._noDepthDrawGl1=!0,this.localSpace?this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,this.node.getWorldTransform()):this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance._updateAabb=!1,this.meshInstance.visible=wasVisible,this._initializeTextures(),this.resetTime(),this.addTime(0,!1),this.preWarm&&this.prewarm(this.lifetime)},_proto._isAnimated=function _isAnimated(){return this.animNumFrames>=1&&(this.animTilesX>1||this.animTilesY>1)&&(this.colorMap&&this.colorMap!==ParticleEmitter.DEFAULT_PARAM_TEXTURE||this.normalMap)},_proto.rebuildGraphs=function rebuildGraphs(){var precision=this.precision,gd=this.graphicsDevice,i;for(this.qLocalVelocity=this.localVelocityGraph.quantize(precision),this.qVelocity=this.velocityGraph.quantize(precision),this.qColor=this.colorGraph.quantizeClamped(precision,0,1),this.qRotSpeed=this.rotationSpeedGraph.quantize(precision),this.qScale=this.scaleGraph.quantize(precision),this.qAlpha=this.alphaGraph.quantize(precision),this.qRadialSpeed=this.radialSpeedGraph.quantize(precision),this.qLocalVelocity2=this.localVelocityGraph2.quantize(precision),this.qVelocity2=this.velocityGraph2.quantize(precision),this.qColor2=this.colorGraph2.quantizeClamped(precision,0,1),this.qRotSpeed2=this.rotationSpeedGraph2.quantize(precision),this.qScale2=this.scaleGraph2.quantize(precision),this.qAlpha2=this.alphaGraph2.quantize(precision),this.qRadialSpeed2=this.radialSpeedGraph2.quantize(precision),i=0;i<precision;i++)this.qRotSpeed[i]*=math.DEG_TO_RAD,this.qRotSpeed2[i]*=math.DEG_TO_RAD;if(this.localVelocityUMax=new Float32Array(3),this.velocityUMax=new Float32Array(3),this.colorUMax=new Float32Array(3),this.rotSpeedUMax=[0],this.scaleUMax=[0],this.alphaUMax=[0],this.radialSpeedUMax=[0],this.qLocalVelocityDiv=divGraphFrom2Curves(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax),this.qVelocityDiv=divGraphFrom2Curves(this.qVelocity,this.qVelocity2,this.velocityUMax),this.qColorDiv=divGraphFrom2Curves(this.qColor,this.qColor2,this.colorUMax),this.qRotSpeedDiv=divGraphFrom2Curves(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax),this.qScaleDiv=divGraphFrom2Curves(this.qScale,this.qScale2,this.scaleUMax),this.qAlphaDiv=divGraphFrom2Curves(this.qAlpha,this.qAlpha2,this.alphaUMax),this.qRadialSpeedDiv=divGraphFrom2Curves(this.qRadialSpeed,this.qRadialSpeed2,this.radialSpeedUMax),this.pack8){var umax=[0,0,0];maxUnsignedGraphValue(this.qVelocity,umax);var umax2=[0,0,0];maxUnsignedGraphValue(this.qVelocity2,umax2);var lumax=[0,0,0];maxUnsignedGraphValue(this.qLocalVelocity,lumax);var lumax2=[0,0,0];maxUnsignedGraphValue(this.qLocalVelocity2,lumax2);var rumax=[0];maxUnsignedGraphValue(this.qRadialSpeed,rumax);var rumax2=[0];maxUnsignedGraphValue(this.qRadialSpeed2,rumax2);var maxVel=Math.max(umax[0],umax2[0]);maxVel=Math.max(maxVel,umax[1]),maxVel=Math.max(maxVel,umax2[1]),maxVel=Math.max(maxVel,umax[2]),maxVel=Math.max(maxVel,umax2[2]);var lmaxVel=Math.max(lumax[0],lumax2[0]);lmaxVel=Math.max(lmaxVel,lumax[1]),lmaxVel=Math.max(lmaxVel,lumax2[1]),lmaxVel=Math.max(lmaxVel,lumax[2]),lmaxVel=Math.max(lmaxVel,lumax2[2]);var maxRad=Math.max(rumax[0],rumax2[0]);this.maxVel=maxVel+lmaxVel+maxRad}this.useCpu||(this.internalTex0=_createTexture(gd,precision,1,packTextureXYZ_NXYZ(this.qLocalVelocity,this.qLocalVelocityDiv)),this.internalTex1=_createTexture(gd,precision,1,packTextureXYZ_NXYZ(this.qVelocity,this.qVelocityDiv)),this.internalTex2=_createTexture(gd,precision,1,packTexture5Floats(this.qRotSpeed,this.qScale,this.qScaleDiv,this.qRotSpeedDiv,this.qAlphaDiv)),this.internalTex3=_createTexture(gd,precision,1,packTexture2Floats(this.qRadialSpeed,this.qRadialSpeedDiv))),this.colorParam=_createTexture(gd,precision,1,packTextureRGBA(this.qColor,this.qAlpha),7,1,!0)},_proto._initializeTextures=function _initializeTextures(){this.colorMap&&(this.material.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&this.material.setParameter("normalMap",this.normalMap))},_proto.regenShader=function regenShader(){var programLib=this.graphicsDevice.getProgramLibrary(),hasNormal=null!==this.normalMap;this.normalOption=0,this.lighting&&(this.normalOption=hasNormal?2:1),this.material.updateShader=function(){this.emitter.scene&&this.emitter.camera!==this.emitter.scene._activeCamera&&(this.emitter.camera=this.emitter.scene._activeCamera,this.emitter.onChangeCamera());var inTools=this.emitter.inTools,shader=programLib.getProgram("particle",{useCpu:this.emitter.useCpu,normal:this.emitter.normalOption,halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening,mesh:this.emitter.useMesh,gamma:this.emitter.scene?this.emitter.scene.gammaCorrection:0,toneMap:this.emitter.scene?this.emitter.scene.toneMapping:0,fog:this.emitter.scene&&!this.emitter.noFog?this.emitter.scene.fog:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,localSpace:this.emitter.localSpace,screenSpace:!inTools&&this.emitter.screenSpace,blend:this.blendType,animTex:this.emitter._isAnimated(),animTexLoop:this.emitter.animLoop,pack8:this.emitter.pack8,customFace:0!==this.emitter.orientation});this.shader=shader},this.material.updateShader()},_proto.resetMaterial=function resetMaterial(){var material=this.material;material.setParameter("stretch",this.stretch),this._isAnimated()&&(material.setParameter("animTexTilesParams",this.animTilesParams),material.setParameter("animTexParams",this.animParams),material.setParameter("animTexIndexParams",this.animIndexParams)),material.setParameter("colorMult",this.intensity),this.useCpu||(material.setParameter("internalTex0",this.internalTex0),material.setParameter("internalTex1",this.internalTex1),material.setParameter("internalTex2",this.internalTex2),material.setParameter("internalTex3",this.internalTex3)),material.setParameter("colorParam",this.colorParam),material.setParameter("numParticles",this.numParticles),material.setParameter("numParticlesPot",this.numParticlesPot),material.setParameter("lifetime",this.lifetime),material.setParameter("rate",this.rate),material.setParameter("rateDiv",this.rate2-this.rate),material.setParameter("seed",this.seed),material.setParameter("scaleDivMult",this.scaleUMax[0]),material.setParameter("alphaDivMult",this.alphaUMax[0]),material.setParameter("radialSpeedDivMult",this.radialSpeedUMax[0]),material.setParameter("graphNumSamples",this.precision),material.setParameter("graphSampleSize",1/this.precision),material.setParameter("emitterScale",new Float32Array([1,1,1])),this.pack8&&(this._gpuUpdater._setInputBounds(),material.setParameter("inBoundsSize",this._gpuUpdater.inBoundsSizeUniform),material.setParameter("inBoundsCenter",this._gpuUpdater.inBoundsCenterUniform),material.setParameter("maxVel",this.maxVel)),this.wrap&&this.wrapBounds&&(this.wrapBoundsUniform[0]=this.wrapBounds.x,this.wrapBoundsUniform[1]=this.wrapBounds.y,this.wrapBoundsUniform[2]=this.wrapBounds.z,material.setParameter("wrapBounds",this.wrapBoundsUniform)),this.colorMap&&material.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&material.setParameter("normalMap",this.normalMap),this.depthSoftening>0&&material.setParameter("softening",1/(this.depthSoftening*this.depthSoftening*100)),this.stretch>0&&(material.cull=0),this._compParticleFaceParams()},_proto._compParticleFaceParams=function _compParticleFaceParams(){var tangent,binormal;if(0===this.orientation)tangent=new Float32Array([1,0,0]),binormal=new Float32Array([0,0,1]);else{var n,emitterMat;if(1===this.orientation)n=this.particleNormal.normalize();else n=(null===this.node?Mat4.IDENTITY:this.node.getWorldTransform()).transformVector(this.particleNormal).normalize();var t=new Vec3(1,0,0);1===Math.abs(t.dot(n))&&t.set(0,0,1);var b=(new Vec3).cross(n,t).normalize();t.cross(b,n).normalize(),tangent=new Float32Array([t.x,t.y,t.z]),binormal=new Float32Array([b.x,b.y,b.z])}this.material.setParameter("faceTangent",tangent),this.material.setParameter("faceBinorm",binormal)},_proto._allocate=function _allocate(numParticles){var psysVertCount=numParticles*this.numParticleVerts,psysIndexCount=numParticles*this.numParticleIndices,elements,particleFormat,i;if(void 0===this.vertexBuffer||this.vertexBuffer.getNumVertices()!==psysVertCount){this.useCpu?(elements=[{semantic:"ATTR0",components:4,type:6},{semantic:"ATTR1",components:4,type:6},{semantic:"ATTR2",components:4,type:6},{semantic:"ATTR3",components:1,type:6},{semantic:"ATTR4",components:this.useMesh?4:2,type:6}],particleFormat=new VertexFormat(this.graphicsDevice,elements),this.vertexBuffer=new VertexBuffer(this.graphicsDevice,particleFormat,psysVertCount,1),this.indexBuffer=new IndexBuffer(this.graphicsDevice,1,psysIndexCount)):(elements=[{semantic:"ATTR0",components:4,type:6}],this.useMesh&&elements.push({semantic:"ATTR1",components:2,type:6}),particleFormat=new VertexFormat(this.graphicsDevice,elements),this.vertexBuffer=new VertexBuffer(this.graphicsDevice,particleFormat,psysVertCount,1),this.indexBuffer=new IndexBuffer(this.graphicsDevice,1,psysIndexCount));var data=new Float32Array(this.vertexBuffer.lock()),meshData,stride,texCoordOffset,id;if(this.useMesh){stride=(meshData=new Float32Array(this.mesh.vertexBuffer.lock())).length/this.mesh.vertexBuffer.numVertices;for(var elem=0;elem<this.mesh.vertexBuffer.format.elements.length;elem++)if("TEXCOORD0"===this.mesh.vertexBuffer.format.elements[elem].name){texCoordOffset=this.mesh.vertexBuffer.format.elements[elem].offset/4;break}}for(i=0;i<psysVertCount;i++)if(id=Math.floor(i/this.numParticleVerts),this.useMesh){var vert=i%this.numParticleVerts;data[6*i]=meshData[vert*stride],data[6*i+1]=meshData[vert*stride+1],data[6*i+2]=meshData[vert*stride+2],data[6*i+3]=id,data[6*i+4]=meshData[vert*stride+texCoordOffset+0],data[6*i+5]=meshData[vert*stride+texCoordOffset+1]}else{var vertID=i%4;data[4*i]=particleVerts[vertID][0],data[4*i+1]=particleVerts[vertID][1],data[4*i+2]=0,data[4*i+3]=id}this.useCpu&&(this.vbCPU=new Float32Array(data),this.vbOld=new Float32Array(this.vbCPU.length)),this.vertexBuffer.unlock(),this.useMesh&&this.mesh.vertexBuffer.unlock();var dst=0,indices=new Uint16Array(this.indexBuffer.lock());for(this.useMesh&&(meshData=new Uint16Array(this.mesh.indexBuffer[0].lock())),i=0;i<numParticles;i++)if(this.useMesh)for(var j=0;j<this.numParticleIndices;j++)indices[i*this.numParticleIndices+j]=meshData[j]+i*this.numParticleVerts;else{var baseIndex=4*i;indices[dst++]=baseIndex,indices[dst++]=baseIndex+1,indices[dst++]=baseIndex+2,indices[dst++]=baseIndex,indices[dst++]=baseIndex+2,indices[dst++]=baseIndex+3}this.indexBuffer.unlock(),this.useMesh&&this.mesh.indexBuffer[0].unlock()}},_proto.reset=function reset(){if(this.beenReset=!0,this.seed=Math.random(),this.material.setParameter("seed",this.seed),this.useCpu)for(var i=0;i<this.particleTexStart.length;i++)this.particleTex[i]=this.particleTexStart[i];else this._initializeTextures();this.resetWorldBounds(),this.resetTime();var origLoop=this.loop;this.loop=!0,this.addTime(0,!1),this.loop=origLoop,this.preWarm&&this.prewarm(this.lifetime)},_proto.prewarm=function prewarm(time){for(var lifetimeFraction=time/this.lifetime,iterations=Math.min(Math.floor(lifetimeFraction*this.precision),this.precision),stepDelta=time/iterations,i=0;i<iterations;i++)this.addTime(stepDelta,!1)},_proto.resetTime=function resetTime(){this.endTime=calcEndTime(this)},_proto.finishFrame=function finishFrame(){this.useCpu&&this.vertexBuffer.unlock()},_proto.addTime=function addTime(delta,isOnStop){var device=this.graphicsDevice,emitterPos;if(this.simTimeTotal+=delta,this.calculateWorldBounds(),this._isAnimated()){var tilesParams=this.animTilesParams;tilesParams[0]=1/this.animTilesX,tilesParams[1]=1/this.animTilesY;var params=this.animParams;params[0]=this.animStartFrame,params[1]=this.animNumFrames*this.animSpeed,params[2]=this.animNumFrames-1,params[3]=this.animNumAnimations-1;var animIndexParams=this.animIndexParams;animIndexParams[0]=this.animIndex,animIndexParams[1]=this.randomizeAnimIndex}this.scene&&this.camera!==this.scene._activeCamera&&(this.camera=this.scene._activeCamera,this.onChangeCamera()),0===this.emitterShape&&(extentsInnerRatioUniform[0]=0!==this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,extentsInnerRatioUniform[1]=0!==this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,extentsInnerRatioUniform[2]=0!==this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0,null===this.meshInstance.node?spawnMatrix.setTRS(Vec3.ZERO,Quat.IDENTITY,this.emitterExtents):spawnMatrix.setTRS(Vec3.ZERO,this.meshInstance.node.getRotation(),tmpVec3.copy(this.emitterExtents).mul(this.meshInstance.node.localScale)));var emitterScale=null===this.meshInstance.node?Vec3.ONE:this.meshInstance.node.localScale;if(this.emitterScaleUniform[0]=emitterScale.x,this.emitterScaleUniform[1]=emitterScale.y,this.emitterScaleUniform[2]=emitterScale.z,this.material.setParameter("emitterScale",this.emitterScaleUniform),this.localSpace&&this.meshInstance.node&&(emitterPos=this.meshInstance.node.getPosition(),this.emitterPosUniform[0]=emitterPos.x,this.emitterPosUniform[1]=emitterPos.y,this.emitterPosUniform[2]=emitterPos.z,this.material.setParameter("emitterPos",this.emitterPosUniform)),this._compParticleFaceParams(),this.useCpu){var data=new Float32Array(this.vertexBuffer.lock());this._cpuUpdater.update(data,this.vbToSort,this.particleTex,spawnMatrix,extentsInnerRatioUniform,emitterPos,delta,isOnStop)}else this._gpuUpdater.update(device,spawnMatrix,extentsInnerRatioUniform,delta,isOnStop);this.loop||Date.now()>this.endTime&&(this.onFinished&&this.onFinished(),this.meshInstance.visible=!1),this.meshInstance&&(this.meshInstance.drawOrder=this.drawOrder)},_proto._destroyResources=function _destroyResources(){this.particleTexIN&&(this.particleTexIN.destroy(),this.particleTexIN=null),this.particleTexOUT&&(this.particleTexOUT.destroy(),this.particleTexOUT=null),this.particleTexStart&&this.particleTexStart.destroy&&(this.particleTexStart.destroy(),this.particleTexStart=null),this.rtParticleTexIN&&(this.rtParticleTexIN.destroy(),this.rtParticleTexIN=null),this.rtParticleTexOUT&&(this.rtParticleTexOUT.destroy(),this.rtParticleTexOUT=null),this.internalTex0&&(this.internalTex0.destroy(),this.internalTex0=null),this.internalTex1&&(this.internalTex1.destroy(),this.internalTex1=null),this.internalTex2&&(this.internalTex2.destroy(),this.internalTex2=null),this.internalTex3&&(this.internalTex3.destroy(),this.internalTex3=null),this.colorParam&&(this.colorParam.destroy(),this.colorParam=null),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=void 0),this.indexBuffer&&(this.indexBuffer.destroy(),this.indexBuffer=void 0),this.material&&(this.material.destroy(),this.material=null)},_proto.destroy=function destroy(){this.camera=null,this._destroyResources()},ParticleEmitter}(),AreaLightLuts=function(){function AreaLightLuts(){}return AreaLightLuts.createTexture=function createTexture(device,format,size){var tex=new Texture(device,{width:size,height:size,format:format,addressU:1,addressV:1,type:"default",magFilter:1,minFilter:0,anisotropy:1});return tex.name="AreaLightLUT",tex},AreaLightLuts.setUniforms=function setUniforms(device,texture1,texture2){device.scope.resolve("areaLightsLutTex1").setValue(texture1),device.scope.resolve("areaLightsLutTex2").setValue(texture2)},AreaLightLuts.createPlaceholder=function createPlaceholder(device){var texture=AreaLightLuts.createTexture(device,7,2),pixels;texture.lock().fill(0),texture.unlock(),AreaLightLuts.setUniforms(device,texture,texture)},AreaLightLuts.set=function set(device,resource){function buildTexture(device,data,format){var texture=AreaLightLuts.createTexture(device,format,64);return texture.lock().set(data),texture.unlock(),texture.upload(),texture}function offsetScale(data,offset,scale){for(var count=data.length,ret=new Float32Array(count),i=0;i<count;i++){var n=i%4;ret[i]=(data[i]+offset[n])*scale[n]}return ret}function convertToHalfFloat(data){for(var count=data.length,ret=new Uint16Array(count),float2Half=math.float2Half,i=0;i<count;i++)ret[i]=float2Half(data[i]);return ret}function convertToUint(data){for(var count=data.length,ret=new Uint8ClampedArray(count),i=0;i<count;i++)ret[i]=255*data[i];return ret}var versions=new Int16Array(resource,0,2),majorVersion=versions[0],minorVersion=versions[1];if(0!==majorVersion||1!==minorVersion)console.warn("areaLightLuts asset version: "+majorVersion+"."+minorVersion+" is not supported in current engine version!");else{var srcData1=new Float32Array(resource,4,16384),srcData2=new Float32Array(resource,65540,16384),data1,data2,format=device.areaLightLutFormat;if(14===format)data1=srcData1,data2=srcData2;else if(12===format)data1=convertToHalfFloat(srcData1),data2=convertToHalfFloat(srcData2);else{var o1,s1,o2=[-.306897,0,0,0],s2=[1.442787,1,1,1];data1=convertToUint(offsetScale(srcData1,[0,.2976,.01381,0],[.999,3.08737,1.6546,.603249])),data2=convertToUint(offsetScale(srcData2,o2,s2))}var tex1=buildTexture(device,data1,format),tex2=buildTexture(device,data2,format);AreaLightLuts.setUniforms(device,tex1,tex2)}},AreaLightLuts}(),identityGraphNode=new GraphNode,LineBatch=function(){function LineBatch(){this.numLinesAllocated=128,this.vb=null,this.vbRam=null,this.mesh=null,this.linesUsed=0,this.material=null,this.meshInstance=null,this.meshInstanceArray=[],this.layer=null}var _proto=LineBatch.prototype;return _proto.init=function init(device,vertexFormat,layer,linesToAdd){for(this.mesh||(this.mesh=new Mesh(device),this.mesh.primitive[0].type=1,this.mesh.primitive[0].base=0,this.mesh.primitive[0].indexed=!1,this.material=new BasicMaterial,this.material.vertexColors=!0,this.material.blend=!0,this.material.blendType=2,this.material.update()),this.layer=layer;this.linesUsed+linesToAdd>this.numLinesAllocated;)this.vb&&(this.vb.destroy(),this.vb=null),this.numLinesAllocated*=2;this.vertexFormat=vertexFormat,this.vb||(this.vb=new VertexBuffer(device,vertexFormat,2*this.numLinesAllocated,1),this.mesh.vertexBuffer=this.vb,this.vbRam=new DataView(this.vb.lock()),this.meshInstance||(identityGraphNode.worldTransform=Mat4.IDENTITY,identityGraphNode._dirtyWorld=identityGraphNode._dirtyNormal=!1,this.meshInstance=new MeshInstance(this.mesh,this.material,identityGraphNode),this.meshInstance.cull=!1))},_proto.addLines=function addLines(position,color){for(var multiColor=!!color.length,offset=2*this.linesUsed*this.vertexFormat.size,clr,i=0;i<position.length;i++)this.vbRam.setFloat32(offset,position[i].x,!0),offset+=4,this.vbRam.setFloat32(offset,position[i].y,!0),offset+=4,this.vbRam.setFloat32(offset,position[i].z,!0),offset+=4,clr=multiColor?color[i]:color,this.vbRam.setUint8(offset,255*clr.r),offset+=1,this.vbRam.setUint8(offset,255*clr.g),offset+=1,this.vbRam.setUint8(offset,255*clr.b),offset+=1,this.vbRam.setUint8(offset,255*clr.a),offset+=1;this.linesUsed+=position.length/2},_proto.finalize=function finalize(meshInstanceArray){this.linesUsed>0&&(this.vb.setData(this.vbRam.buffer),this.mesh.primitive[0].count=2*this.linesUsed,meshInstanceArray[0]=this.meshInstance,this.layer.addMeshInstances(meshInstanceArray,!0),this.linesUsed=0)},LineBatch}(),ImmediateData=function(){function ImmediateData(device){this.lineVertexFormat=new VertexFormat(device,[{semantic:"POSITION",components:3,type:6},{semantic:"COLOR",components:4,type:1,normalize:!0}]),this.device=device,this.lineBatches=[],this.layers=[],this.layerToBatch={},this.quadMesh=null,this.textureShader=null,this.depthTextureShader=null,this.cubeLocalPos=null,this.cubeWorldPos=null,this.meshInstanceArray=[],this.usedGraphNodes=[],this.freeGraphNodes=[]}ImmediateData.getTextureVS=function getTextureVS(){return"\n\t\t\t\t\t\tattribute vec2 aPosition;\n\t\t\t\t\t\tuniform mat4 matrix_model;\n\t\t\t\t\t\tvarying vec2 uv0;\n\t\t\t\t\t\tvoid main(void) {\n\t\t\t\t\t\t\t\tgl_Position = matrix_model * vec4(aPosition, 0, 1);\n\t\t\t\t\t\t\t\tuv0 = aPosition.xy + 0.5;\n\t\t\t\t\t\t}\n\t\t\t\t"};var _proto2=ImmediateData.prototype;return _proto2.getTextureShader=function getTextureShader(){if(!this.textureShader){var shaderDefinition={attributes:{aPosition:"POSITION"},vshader:ImmediateData.getTextureVS(),fshader:"\n\t\t\t\t\t\t\t\t\t\tprecision lowp float;\n\t\t\t\t\t\t\t\t\t\tvarying vec2 uv0;\n\t\t\t\t\t\t\t\t\t\tuniform sampler2D colorMap;\n\t\t\t\t\t\t\t\t\t\tvoid main (void) {\n\t\t\t\t\t\t\t\t\t\t\t\tgl_FragColor = vec4(texture2D(colorMap, uv0).xyz, 1);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t"};this.textureShader=new Shader(this.device,shaderDefinition)}return this.textureShader},_proto2.getDepthTextureShader=function getDepthTextureShader(){if(!this.depthTextureShader){var gl2=this.device.webgl2?"#define GL2":"",shaderDefinition={attributes:{aPosition:"POSITION"},vshader:ImmediateData.getTextureVS(),fshader:"\n\t\t\t\t\t\t\t\t\t\tprecision "+this.device.precision+" float;\n\t\t\t\t\t\t\t\t\t\t"+gl2+"\n\t\t\t\t\t\t\t\t\t\t"+shaderChunks.screenDepthPS+"\n\t\t\t\t\t\t\t\t\t\tvarying vec2 uv0;\n\t\t\t\t\t\t\t\t\t\tvoid main() {\n\t\t\t\t\t\t\t\t\t\t\t\tfloat depth = getLinearScreenDepth(uv0) * camera_params.x;\n\t\t\t\t\t\t\t\t\t\t\t\tgl_FragColor = vec4(vec3(depth), 1.0);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t"};this.depthTextureShader=new Shader(this.device,shaderDefinition)}return this.depthTextureShader},_proto2.getQuadMesh=function getQuadMesh(){if(!this.quadMesh){var format=new VertexFormat(this.device,[{semantic:"POSITION",components:3,type:6}]),quadVb=new VertexBuffer(this.device,format,4),iterator=new VertexIterator(quadVb);iterator.element.POSITION.set(-.5,-.5,0),iterator.next(),iterator.element.POSITION.set(.5,-.5,0),iterator.next(),iterator.element.POSITION.set(-.5,.5,0),iterator.next(),iterator.element.POSITION.set(.5,.5,0),iterator.end(),this.quadMesh=new Mesh(this.device),this.quadMesh.vertexBuffer=quadVb,this.quadMesh.primitive[0].type=5,this.quadMesh.primitive[0].base=0,this.quadMesh.primitive[0].count=4,this.quadMesh.primitive[0].indexed=!1}return this.quadMesh},_proto2.renderMesh=function renderMesh(material,matrix,mesh,meshInstance,options){if(!meshInstance){var graphNode=this.getGraphNode(matrix);(meshInstance=new MeshInstance(mesh,material,graphNode)).cull=!1}this.addLayer(options.layer),options.mask&&(meshInstance.mask=options.mask),this.meshInstanceArray[0]=meshInstance,options.layer.addMeshInstances(this.meshInstanceArray,!0)},_proto2.renderWireCube=function renderWireCube(matrix,color,options){if(!this.cubeLocalPos){var x=.5;this.cubeLocalPos=[new Vec3(-x,-x,-x),new Vec3(-x,x,-x),new Vec3(x,x,-x),new Vec3(x,-x,-x),new Vec3(-x,-x,x),new Vec3(-x,x,x),new Vec3(x,x,x),new Vec3(x,-x,x)],this.cubeWorldPos=[new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3];var _cubeWorldPos=this.cubeWorldPos;this.cubePositions=[_cubeWorldPos[0],_cubeWorldPos[1],_cubeWorldPos[1],_cubeWorldPos[2],_cubeWorldPos[2],_cubeWorldPos[3],_cubeWorldPos[3],_cubeWorldPos[0],_cubeWorldPos[4],_cubeWorldPos[5],_cubeWorldPos[5],_cubeWorldPos[6],_cubeWorldPos[6],_cubeWorldPos[7],_cubeWorldPos[7],_cubeWorldPos[4],_cubeWorldPos[0],_cubeWorldPos[4],_cubeWorldPos[1],_cubeWorldPos[5],_cubeWorldPos[2],_cubeWorldPos[6],_cubeWorldPos[3],_cubeWorldPos[7]]}for(var cubeLocalPos=this.cubeLocalPos,cubeWorldPos=this.cubeWorldPos,i=0;i<8;i++)matrix.transformPoint(cubeLocalPos[i],cubeWorldPos[i]);var lineBatch;this.prepareLineBatch(options.layer,options.depthTest,void 0,this.cubePositions.length).addLines(this.cubePositions,color)},_proto2.renderWireSphere=function renderWireSphere(center,radius,color,options){var numSegments=20,lineBatch;if(!this.spherePoints){this.spherePoints=[];for(var i=0;i<120;i++)this.spherePoints.push(new Vec3)}for(var points=this.spherePoints,step=2*Math.PI/20,angle=0,_i=0;_i<20;_i++){var sin0=Math.sin(angle),cos0=Math.cos(angle);angle+=step;var sin1=Math.sin(angle),cos1=Math.cos(angle);points[6*_i].set(center.x+radius*sin0,center.y,center.z+radius*cos0),points[6*_i+1].set(center.x+radius*sin1,center.y,center.z+radius*cos1),points[6*_i+2].set(center.x+radius*sin0,center.y+radius*cos0,center.z),points[6*_i+3].set(center.x+radius*sin1,center.y+radius*cos1,center.z),points[6*_i+4].set(center.x,center.y+radius*sin0,center.z+radius*cos0),points[6*_i+5].set(center.x,center.y+radius*sin1,center.z+radius*cos1)}this.prepareLineBatch(options.layer,options.depthTest,void 0,points.length).addLines(points,color)},_proto2.getGraphNode=function getGraphNode(matrix){var graphNode=null;return graphNode=this.freeGraphNodes.length>0?this.freeGraphNodes.pop():new GraphNode,this.usedGraphNodes.push(graphNode),graphNode.worldTransform=matrix,graphNode._dirtyWorld=graphNode._dirtyNormal=!1,graphNode},_proto2.addLayer=function addLayer(layer){this.layers.indexOf(layer)<0&&this.layers.push(layer)},_proto2.getLayerIdx=function getLayerIdx(layer){return this.layerToBatch[layer.id]},_proto2.addLayerIdx=function addLayerIdx(idx,layer){this.layerToBatch[layer.id]=idx},_proto2.finalize=function finalize(){for(var i=0;i<this.lineBatches.length;i++)this.lineBatches[i]&&this.lineBatches[i].finalize(this.meshInstanceArray)},_proto2.clear=function clear(){for(var i=0;i<this.layers.length;i++)this.layers[i].clearMeshInstances(!0);var temp=this.freeGraphNodes;this.freeGraphNodes=this.usedGraphNodes,this.usedGraphNodes=temp,this.layers.length=0},_proto2.prepareLineBatch=function prepareLineBatch(layer,depthTest,mask,numLines){this.addLayer(layer);var idx=this.getLayerIdx(layer);if(void 0===idx){var batch=new LineBatch;batch.init(this.device,this.lineVertexFormat,layer,numLines),batch.material.depthTest=depthTest,mask&&(batch.meshInstance.mask=mask),idx=this.lineBatches.push(batch)-1,this.addLayerIdx(idx,layer)}else this.lineBatches[idx].init(this.device,this.lineVertexFormat,layer,numLines),this.lineBatches[idx].material.depthTest=depthTest,mask&&(this.lineBatches[idx].meshInstance.mask=mask);return this.lineBatches[idx]},ImmediateData}(),Scene=function(_EventHandler){function Scene(){var _this;return(_this=_EventHandler.call(this)||this).root=null,_this._gravity=new Vec3(0,-9.8,0),_this._layers=null,_this._fog="none",_this.fogColor=new Color(0,0,0),_this.fogStart=1,_this.fogEnd=1e3,_this.fogDensity=0,_this.ambientLight=new Color(0,0,0),_this._gammaCorrection=0,_this._toneMapping=0,_this.exposure=1,_this._skyboxPrefiltered=[null,null,null,null,null,null],_this._skyboxCubeMap=null,_this.skyboxModel=null,_this._skyboxIntensity=1,_this._skyboxMip=0,_this._skyboxRotation=new Quat,_this._skyboxRotationMat3=null,_this._skyboxRotationMat4=null,_this._skyboxIsRenderTarget=!1,_this.lightmapSizeMultiplier=1,_this.lightmapMaxResolution=2048,_this.lightmapMode=1,_this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,lastStaticPrepareFullTime:0,lastStaticPrepareSearchTime:0,lastStaticPrepareWriteTime:0,lastStaticPrepareTriAabbTime:0,lastStaticPrepareCombineTime:0,updateShadersTime:0},_this.updateShaders=!0,_this.updateSkybox=!0,_this._shaderVersion=0,_this._statsUpdated=!1,_this._models=[],_this.defaultMaterial=new StandardMaterial,_this.defaultMaterial.name="Default Material",_this.defaultMaterial.shadingModel=1,_this}_inheritsLoose(Scene,_EventHandler);var _proto=Scene.prototype;return _proto.destroy=function destroy(){this._resetSkyboxModel(),this.root=null,this.defaultMaterial.destroy(),this.defaultMaterial=null,this.off()},_proto.applySettings=function applySettings(settings){this._gravity.set(settings.physics.gravity[0],settings.physics.gravity[1],settings.physics.gravity[2]),this.ambientLight.set(settings.render.global_ambient[0],settings.render.global_ambient[1],settings.render.global_ambient[2]),this._fog=settings.render.fog,this.fogColor.set(settings.render.fog_color[0],settings.render.fog_color[1],settings.render.fog_color[2]),this.fogStart=settings.render.fog_start,this.fogEnd=settings.render.fog_end,this.fogDensity=settings.render.fog_density,this._gammaCorrection=settings.render.gamma_correction,this._toneMapping=settings.render.tonemapping,this.lightmapSizeMultiplier=settings.render.lightmapSizeMultiplier,this.lightmapMaxResolution=settings.render.lightmapMaxResolution,this.lightmapMode=settings.render.lightmapMode,this.exposure=settings.render.exposure,this._skyboxIntensity=void 0===settings.render.skyboxIntensity?1:settings.render.skyboxIntensity,this._skyboxMip=void 0===settings.render.skyboxMip?0:settings.render.skyboxMip,settings.render.skyboxRotation&&this._skyboxRotation.setFromEulerAngles(settings.render.skyboxRotation[0],settings.render.skyboxRotation[1],settings.render.skyboxRotation[2]),this._resetSkyboxModel(),this.updateShaders=!0},_proto._updateSkybox=function _updateSkybox(device){if(!this.skyboxModel){var skyboxMapping=[0,1,3,4,5,6],usedTex=this._skyboxMip?this._skyboxPrefiltered[skyboxMapping[this._skyboxMip]]||this._skyboxPrefiltered[0]||this._skyboxCubeMap:this._skyboxCubeMap||this._skyboxPrefiltered[0];if(!usedTex)return;usedTex._isRenderTarget?this._skyboxIsRenderTarget=!0:this._skyboxIsRenderTarget=!1;var material=new Material,scene=this;material.updateShader=function(dev,sc,defs,staticLightList,pass){var library,shader=device.getProgramLibrary().getProgram("skybox",{rgbm:"rgbm"===usedTex.type,hdr:"rgbm"===usedTex.type||14===usedTex.format,useIntensity:1!==scene.skyboxIntensity,useCubeMapRotation:!scene.skyboxRotation.equals(Quat.IDENTITY),useRightHandedCubeMap:scene._skyboxIsRenderTarget,mip:usedTex.fixCubemapSeams?scene.skyboxMip:0,fixSeams:usedTex.fixCubemapSeams,gamma:1===pass?scene.gammaCorrection?3:0:scene.gammaCorrection,toneMapping:1===pass?0:scene.toneMapping});this.shader=shader},material.updateShader(),material.setParameter("texture_cubeMap",usedTex),this.skyboxRotation.equals(Quat.IDENTITY)||(this._skyboxRotationMat4||(this._skyboxRotationMat4=new Mat4),this._skyboxRotationMat3||(this._skyboxRotationMat3=new Mat3),this._skyboxRotationMat4.setTRS(Vec3.ZERO,this._skyboxRotation,Vec3.ONE),this._skyboxRotationMat4.invertTo3x3(this._skyboxRotationMat3),material.setParameter("cubeMapRotationMatrix",this._skyboxRotationMat3.data)),material.cull=2,material.depthWrite=!1;var skyLayer=this.layers.getLayerById(2);if(skyLayer){var node=new GraphNode,mesh=createBox(device),meshInstance=new MeshInstance(mesh,material,node);meshInstance.cull=!1,meshInstance._noDepthDrawGl1=!0;var model=new Model;model.graph=node,model.meshInstances=[meshInstance],this.skyboxModel=model,skyLayer.addMeshInstances(model.meshInstances),this.skyLayer=skyLayer,this.fire("set:skybox",usedTex)}}},_proto._resetSkyboxModel=function _resetSkyboxModel(){this.skyboxModel&&(this.skyLayer.removeMeshInstances(this.skyboxModel.meshInstances),this.skyboxModel.destroy()),this.skyboxModel=null,this.updateSkybox=!0},_proto.setSkybox=function setSkybox(cubemaps){var i;cubemaps||(cubemaps=[null,null,null,null,null,null,null]);var different=!1;if(this._skyboxCubeMap!==cubemaps[0]&&(different=!0),!different)for(i=0;i<6&&!different;i++)this._skyboxPrefiltered[i]!==cubemaps[i+1]&&(different=!0);if(different){for(i=0;i<6;i++)this._skyboxPrefiltered[i]=cubemaps[i+1];this.skybox=cubemaps[0]}},_proto.addModel=function addModel(model){if(!this.containsModel(model)){var layer=this.layers.getLayerById(0);layer&&(layer.addMeshInstances(model.meshInstances),this._models.push(model))}},_proto.addShadowCaster=function addShadowCaster(model){var layer=this.layers.getLayerById(0);layer&&layer.addShadowCasters(model.meshInstances)},_proto.removeModel=function removeModel(model){var index=this._models.indexOf(model);if(-1!==index){var layer=this.layers.getLayerById(0);if(!layer)return;layer.removeMeshInstances(model.meshInstances),this._models.splice(index,1)}},_proto.removeShadowCasters=function removeShadowCasters(model){var layer=this.layers.getLayerById(0);layer&&layer.removeShadowCasters(model.meshInstances)},_proto.containsModel=function containsModel(model){return this._models.indexOf(model)>=0},_proto.getModels=function getModels(model){return this._models},_createClass(Scene,[{key:"fog",get:function get(){return this._fog},set:function set(type){type!==this._fog&&(this._fog=type,this.updateShaders=!0)}},{key:"gammaCorrection",get:function get(){return this._gammaCorrection},set:function set(value){value!==this._gammaCorrection&&(this._gammaCorrection=value,this.updateShaders=!0)}},{key:"toneMapping",get:function get(){return this._toneMapping},set:function set(value){value!==this._toneMapping&&(this._toneMapping=value,this.updateShaders=!0)}},{key:"skybox",get:function get(){return this._skyboxCubeMap},set:function set(value){this._skyboxCubeMap=value,this._resetSkyboxModel(),this.updateShaders=!0}},{key:"skyboxIntensity",get:function get(){return this._skyboxIntensity},set:function set(value){this._skyboxIntensity=value,this._resetSkyboxModel(),this.updateShaders=!0}},{key:"skyboxRotation",get:function get(){return this._skyboxRotation},set:function set(value){this._skyboxRotation.equals(value)||(this._skyboxRotation.copy(value),this._resetSkyboxModel(),this.updateShaders=!0)}},{key:"skyboxMip",get:function get(){return this._skyboxMip},set:function set(value){this._skyboxMip=value,this._resetSkyboxModel(),this.updateShaders=!0}},{key:"skyboxPrefiltered128",get:function get(){return this._skyboxPrefiltered[0]},set:function set(value){this._skyboxPrefiltered[0]!==value&&(this._skyboxPrefiltered[0]=value,this.updateShaders=!0)}},{key:"skyboxPrefiltered64",get:function get(){return this._skyboxPrefiltered[1]},set:function set(value){this._skyboxPrefiltered[1]!==value&&(this._skyboxPrefiltered[1]=value,this.updateShaders=!0)}},{key:"skyboxPrefiltered32",get:function get(){return this._skyboxPrefiltered[2]},set:function set(value){this._skyboxPrefiltered[2]!==value&&(this._skyboxPrefiltered[2]=value,this.updateShaders=!0)}},{key:"skyboxPrefiltered16",get:function get(){return this._skyboxPrefiltered[3]},set:function set(value){this._skyboxPrefiltered[3]!==value&&(this._skyboxPrefiltered[3]=value,this.updateShaders=!0)}},{key:"skyboxPrefiltered8",get:function get(){return this._skyboxPrefiltered[4]},set:function set(value){this._skyboxPrefiltered[4]!==value&&(this._skyboxPrefiltered[4]=value,this.updateShaders=!0)}},{key:"skyboxPrefiltered4",get:function get(){return this._skyboxPrefiltered[5]},set:function set(value){this._skyboxPrefiltered[5]!==value&&(this._skyboxPrefiltered[5]=value,this.updateShaders=!0)}},{key:"drawCalls",get:function get(){var drawCalls=this.layers._meshInstances;return drawCalls.length||(this.layers._update(),drawCalls=this.layers._meshInstances),drawCalls},set:function set(value){}},{key:"layers",get:function get(){return this._layers},set:function set(layers){var prev=this._layers;this._layers=layers,this.fire("set:layers",prev,layers)}},{key:"defaultMaterial",get:function get(){return Material.defaultMaterial},set:function set(value){Material.defaultMaterial=value}}]),Scene}(EventHandler);function hasAudioContext(){return!("undefined"==typeof AudioContext&&"undefined"==typeof webkitAudioContext)}var Channel=function(){function Channel(manager,sound,options){if(void 0===options&&(options={}),this.volume=void 0===options.volume?1:options.volume,this.loop=void 0!==options.loop&&options.loop,this.pitch=void 0===options.pitch?1:options.pitch,this.sound=sound,this.paused=!1,this.suspended=!1,this.manager=manager,this.source=null,hasAudioContext()){this.startTime=0,this.startOffset=0;var context=manager.context;this.gain=context.createGain()}else sound.audio&&(this.source=sound.audio.cloneNode(!1),this.source.pause())}var _proto=Channel.prototype;return _proto.getVolume=function getVolume(){return this.volume},_proto.getLoop=function getLoop(){return this.loop},_proto.setLoop=function setLoop(loop){this.loop=loop,this.source&&(this.source.loop=loop)},_proto.getPitch=function getPitch(){return this.pitch},_proto.onManagerVolumeChange=function onManagerVolumeChange(){this.setVolume(this.getVolume())},_proto.onManagerSuspend=function onManagerSuspend(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())},_proto.onManagerResume=function onManagerResume(){this.suspended&&(this.suspended=!1,this.unpause())},Channel}();hasAudioContext()?Object.assign(Channel.prototype,{play:function play(){if(this.source)throw new Error("Call stop() before calling play()");this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend())},pause:function pause(){this.source&&(this.paused=!0,this.startOffset+=this.manager.context.currentTime-this.startTime,this.source.stop(0),this.source=null)},unpause:function unpause(){!this.source&&this.paused?(this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.paused=!1)):console.warn("Call pause() before unpausing.")},stop:function stop(){this.source&&(this.source.stop(0),this.source=null),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)},setVolume:function setVolume(volume){volume=math.clamp(volume,0,1),this.volume=volume,this.gain&&(this.gain.gain.value=volume*this.manager.volume)},setPitch:function setPitch(pitch){this.pitch=pitch,this.source&&(this.source.playbackRate.value=pitch)},isPlaying:function isPlaying(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE},getDuration:function getDuration(){return this.source?this.source.buffer.duration:0},_createSource:function _createSource(){var context=this.manager.context;this.sound.buffer&&(this.source=context.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),this.gain.connect(context.destination),this.loop||(this.source.onended=this.pause.bind(this)))}}):Object.assign(Channel.prototype,{play:function play(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.source.play()),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend()},pause:function pause(){this.source&&(this.paused=!0,this.source.pause())},unpause:function unpause(){this.source&&(this.paused=!1,this.source.play())},stop:function stop(){this.source&&this.source.pause(),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)},setVolume:function setVolume(volume){volume=math.clamp(volume,0,1),this.volume=volume,this.source&&(this.source.volume=volume*this.manager.volume)},setPitch:function setPitch(pitch){this.pitch=pitch,this.source&&(this.source.playbackRate=pitch)},getDuration:function getDuration(){return this.source&&!isNaN(this.source.duration)?this.source.duration:0},isPlaying:function isPlaying(){return!this.source.paused}});var DISTANCE_LINEAR="linear",DISTANCE_INVERSE="inverse",DISTANCE_EXPONENTIAL="exponential",MAX_DISTANCE$1=1e4,Channel3d=function(_Channel){function Channel3d(manager,sound,options){var _this;return(_this=_Channel.call(this,manager,sound,options)||this).position=new Vec3,_this.velocity=new Vec3,hasAudioContext()?_this.panner=manager.context.createPanner():(_this.maxDistance=1e4,_this.minDistance=1,_this.rollOffFactor=1,_this.distanceModel="inverse"),_this}_inheritsLoose(Channel3d,_Channel);var _proto=Channel3d.prototype;return _proto.getPosition=function getPosition(){return this.position},_proto.getVelocity=function getVelocity(){return this.velocity},Channel3d}(Channel);if(hasAudioContext())Object.assign(Channel3d.prototype,{setPosition:function setPosition(position){this.position.copy(position),this.panner.setPosition(position.x,position.y,position.z)},setVelocity:function setVelocity(velocity){this.velocity.copy(velocity),this.panner.setVelocity(velocity.x,velocity.y,velocity.z)},getMaxDistance:function getMaxDistance(){return this.panner.maxDistance},setMaxDistance:function setMaxDistance(max){this.panner.maxDistance=max},getMinDistance:function getMinDistance(){return this.panner.refDistance},setMinDistance:function setMinDistance(min){this.panner.refDistance=min},getRollOffFactor:function getRollOffFactor(){return this.panner.rolloffFactor},setRollOffFactor:function setRollOffFactor(factor){this.panner.rolloffFactor=factor},getDistanceModel:function getDistanceModel(){return this.pannel.distanceModel},setDistanceModel:function setDistanceModel(distanceModel){this.panner.distanceModel=distanceModel},_createSource:function _createSource(){var context=this.manager.context;this.source=context.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.panner),this.panner.connect(this.gain),this.gain.connect(context.destination),this.loop||(this.source.onended=this.pause.bind(this))}});else{var offset$1=new Vec3,fallOff$1=function fallOff(posOne,posTwo,refDistance,maxDistance,rolloffFactor,distanceModel){var distance=(offset$1=offset$1.sub2(posOne,posTwo)).length();if(distance<refDistance)return 1;if(distance>maxDistance)return 0;var result=0;return"linear"===distanceModel?result=1-rolloffFactor*(distance-refDistance)/(maxDistance-refDistance):"inverse"===distanceModel?result=refDistance/(refDistance+rolloffFactor*(distance-refDistance)):"exponential"===distanceModel&&(result=Math.pow(distance/refDistance,-rolloffFactor)),math.clamp(result,0,1)};Object.assign(Channel3d.prototype,{setPosition:function setPosition(position){if(this.position.copy(position),this.source){var listener,lpos=this.manager.listener.getPosition(),factor=fallOff$1(lpos,this.position,this.minDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),v=this.getVolume();this.source.volume=v*factor}},setVelocity:function setVelocity(velocity){this.velocity.copy(velocity)},getMaxDistance:function getMaxDistance(){return this.maxDistance},setMaxDistance:function setMaxDistance(max){this.maxDistance=max},getMinDistance:function getMinDistance(){return this.minDistance},setMinDistance:function setMinDistance(min){this.minDistance=min},getRollOffFactor:function getRollOffFactor(){return this.rollOffFactor},setRollOffFactor:function setRollOffFactor(factor){this.rollOffFactor=factor},getDistanceModel:function getDistanceModel(){return this.distanceModel},setDistanceModel:function setDistanceModel(distanceModel){this.distanceModel=distanceModel}})}var Listener=function(){function Listener(manager){this._manager=manager,this.position=new Vec3,this.velocity=new Vec3,this.orientation=new Mat4}var _proto=Listener.prototype;return _proto.getPosition=function getPosition(){return this.position},_proto.setPosition=function setPosition(position){this.position.copy(position);var listener=this.listener;listener&&listener.setPosition(position.x,position.y,position.z)},_proto.getVelocity=function getVelocity(){return this.velocity},_proto.setVelocity=function setVelocity(velocity){this.velocity.copy(velocity);var listener=this.listener;listener&&listener.setPosition(velocity.x,velocity.y,velocity.z)},_proto.setOrientation=function setOrientation(orientation){this.orientation.copy(orientation);var listener=this.listener;listener&&listener.setOrientation(-orientation.data[8],-orientation.data[9],-orientation.data[10],orientation.data[4],orientation.data[5],orientation.data[6])},_proto.getOrientation=function getOrientation(){return this.orientation},_createClass(Listener,[{key:"listener",get:function get(){var context=this._manager.context;return context?context.listener:null}}]),Listener}(),SoundManager=function(_EventHandler){function SoundManager(options){var _this;return(_this=_EventHandler.call(this)||this)._context=null,_this._forceWebAudioApi=options.forceWebAudioApi,_this._resumeContext=null,_this._unlock=null,hasAudioContext()||_this._forceWebAudioApi?(_this._resumeContext=function(){window.removeEventListener("mousedown",_this._resumeContext),window.removeEventListener("touchend",_this._resumeContext),_this.context&&_this.context.resume()},window.addEventListener("mousedown",_this._resumeContext),window.addEventListener("touchend",_this._resumeContext),platform.ios&&(_this._unlock=function(){window.removeEventListener("touchend",_this._unlock);var context=_this.context;if(context){var buffer=context.createBuffer(1,1,44100),source=context.createBufferSource();source.buffer=buffer,source.connect(context.destination),source.start(0),source.disconnect()}},window.addEventListener("touchend",_this._unlock))):console.warn("No support for 3D audio found"),_this.listener=new Listener(_assertThisInitialized(_this)),_this._volume=1,_this.suspended=!1,_this}_inheritsLoose(SoundManager,_EventHandler);var _proto=SoundManager.prototype;return _proto.suspend=function suspend(){this.suspended=!0,this.fire("suspend")},_proto.resume=function resume(){this.suspended=!1,this.fire("resume")},_proto.destroy=function destroy(){this._resumeContext&&(window.removeEventListener("mousedown",this._resumeContext),window.removeEventListener("touchend",this._resumeContext)),this._unlock&&window.removeEventListener("touchend",this._unlock),this.fire("destroy"),this._context&&this._context.close&&(this._context.close(),this._context=null)},_proto.playSound=function playSound(sound,options){options=options||{};var channel=null;return Channel&&(channel=new Channel(this,sound,options)).play(),channel},_proto.playSound3d=function playSound3d(sound,position,options){options=options||{};var channel=null;return Channel3d&&((channel=new Channel3d(this,sound,options)).setPosition(position),options.volume&&channel.setVolume(options.volume),options.loop&&channel.setLoop(options.loop),options.maxDistance&&channel.setMaxDistance(options.maxDistance),options.minDistance&&channel.setMinDistance(options.minDistance),options.rollOffFactor&&channel.setRollOffFactor(options.rollOffFactor),options.distanceModel&&channel.setDistanceModel(options.distanceModel),channel.play()),channel},_createClass(SoundManager,[{key:"volume",get:function get(){return this._volume},set:function set(volume){volume=math.clamp(volume,0,1),this._volume=volume,this.fire("volumechange",volume)}},{key:"context",get:function get(){return this._context||(hasAudioContext()||this._forceWebAudioApi)&&("undefined"!=typeof AudioContext?this._context=new AudioContext:"undefined"!=typeof webkitAudioContext&&(this._context=new webkitAudioContext)),this._context}}]),SoundManager}(EventHandler),Key=function Key(time,position,rotation,scale){this.time=time,this.position=position,this.rotation=rotation,this.scale=scale},Node=function Node(){this._name="",this._keys=[]},Animation=function(){function Animation(){this.name="",this.duration=0,this._nodes=[],this._nodeDict={}}var _proto=Animation.prototype;return _proto.getNode=function getNode(name){return this._nodeDict[name]},_proto.addNode=function addNode(node){this._nodes.push(node),this._nodeDict[node._name]=node},_createClass(Animation,[{key:"nodes",get:function get(){return this._nodes}}]),Animation}(),Skin=function Skin(graphicsDevice,ibp,boneNames){this.device=graphicsDevice,this.inverseBindPose=ibp,this.boneNames=boneNames},Render=function(_EventHandler){function Render(){var _this;return(_this=_EventHandler.call(this)||this)._meshes=null,_this}return _inheritsLoose(Render,_EventHandler),_createClass(Render,[{key:"meshes",get:function get(){return this._meshes},set:function set(value){this._meshes=value,this.fire("set:meshes",value)}}]),Render}(EventHandler),AnimCurve=function(){function AnimCurve(paths,input,output,interpolation){this._paths=paths,this._input=input,this._output=output,this._interpolation=interpolation}return _createClass(AnimCurve,[{key:"paths",get:function get(){return this._paths}},{key:"input",get:function get(){return this._input}},{key:"output",get:function get(){return this._output}},{key:"interpolation",get:function get(){return this._interpolation}}]),AnimCurve}(),AnimData=function(){function AnimData(components,data){this._components=components,this._data=data}return _createClass(AnimData,[{key:"components",get:function get(){return this._components}},{key:"data",get:function get(){return this._data}}]),AnimData}(),AnimEvents=function(){function AnimEvents(events){this._events=[].concat(events),this._events.sort((function(a,b){return a.time-b.time}))}return _createClass(AnimEvents,[{key:"events",get:function get(){return this._events}}]),AnimEvents}(),AnimTrack=function(){function AnimTrack(name,duration,inputs,outputs,curves,animEvents){void 0===animEvents&&(animEvents=new AnimEvents([])),this._name=name,this._duration=duration,this._inputs=inputs,this._outputs=outputs,this._curves=curves,this._animEvents=animEvents}var _proto;return AnimTrack.prototype.eval=function _eval(time,snapshot){snapshot._time=time;var inputs=this._inputs,outputs=this._outputs,curves=this._curves,cache=snapshot._cache,results=snapshot._results,i;for(i=0;i<inputs.length;++i)cache[i].update(time,inputs[i]._data);for(i=0;i<curves.length;++i){var curve=curves[i],output=outputs[curve._output],result=results[i];cache[curve._input].eval(result,curve._interpolation,output)}},_createClass(AnimTrack,[{key:"name",get:function get(){return this._name}},{key:"duration",get:function get(){return this._duration}},{key:"inputs",get:function get(){return this._inputs}},{key:"outputs",get:function get(){return this._outputs}},{key:"curves",get:function get(){return this._curves}},{key:"events",get:function get(){return this._animEvents.events},set:function set(animEvents){this._animEvents=animEvents}}]),AnimTrack}(),AnimBinder=function(){function AnimBinder(){}AnimBinder.joinPath=function joinPath(pathSegments,character){character=character||".";var escape=function escape(string){return string.replace(/\\/g,"\\\\").replace(new RegExp("\\"+character,"g"),"\\"+character)};return pathSegments.map(escape).join(character)},AnimBinder.splitPath=function splitPath(path,character){character=character||".";for(var result=[],curr="",i=0;i<path.length;){var c=path[i++];"\\"===c&&i<path.length?curr+="\\"===(c=path[i++])||c===character?c:"\\"+c:c===character?(result.push(curr),curr=""):curr+=c}return curr.length>0&&result.push(curr),result},AnimBinder.encode=function encode(entityPath,component,propertyPath){return(Array.isArray(entityPath)?entityPath.join("/"):entityPath)+"/"+component+"/"+(Array.isArray(propertyPath)?propertyPath.join("/"):propertyPath)};var _proto=AnimBinder.prototype;return _proto.resolve=function resolve(path){return null},_proto.unresolve=function unresolve(path){},_proto.update=function update(deltaTime){},AnimBinder}(),INTERPOLATION_STEP=0,INTERPOLATION_LINEAR=1,INTERPOLATION_CUBIC=2,DEFAULT_LOCALE="en-US",DEFAULT_LOCALE_FALLBACKS={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK","zh-MO":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"},PLURALS={};function definePluralFn(locales,fn){for(var i=0,len=locales.length;i<len;i++)PLURALS[locales[i]]=fn}function getLang(locale){var idx=locale.indexOf("-");return-1!==idx?locale.substring(0,idx):locale}function replaceLang(locale,desiredLang){var idx=locale.indexOf("-");return-1!==idx?desiredLang+locale.substring(idx):desiredLang}function findAvailableLocale(desiredLocale,availableLocales){if(availableLocales[desiredLocale])return desiredLocale;var fallback=DEFAULT_LOCALE_FALLBACKS[desiredLocale];if(fallback&&availableLocales[fallback])return fallback;var lang=getLang(desiredLocale);return availableLocales[fallback=DEFAULT_LOCALE_FALLBACKS[lang]]?fallback:availableLocales[lang]?lang:"en-US"}definePluralFn(["ja","ko","th","vi","zh","id"],(function(n){return 0})),definePluralFn(["fa","hi"],(function(n){return n>=0&&n<=1?0:1})),definePluralFn(["fr","pt"],(function(n){return n>=0&&n<2?0:1})),definePluralFn(["da"],(function(n){return 1===n||!Number.isInteger(n)&&n>=0&&n<=1?0:1})),definePluralFn(["de","en","it","el","es","tr","fi","sv","nb","no","ur"],(function(n){return 1===n?0:1})),definePluralFn(["ru","uk"],(function(n){if(Number.isInteger(n)){var mod10=n%10,mod100=n%100;if(1===mod10&&11!==mod100)return 0;if(mod10>=2&&mod10<=4&&(mod100<12||mod100>14))return 1;if(0===mod10||mod10>=5&&mod10<=9||mod100>=11&&mod100<=14)return 2}return 3})),definePluralFn(["pl"],(function(n){if(Number.isInteger(n)){if(1===n)return 0;var mod10=n%10,mod100=n%100;if(mod10>=2&&mod10<=4&&(mod100<12||mod100>14))return 1;if(mod10>=0&&mod10<=1||mod10>=5&&mod10<=9||mod100>=12&&mod100<=14)return 2}return 3})),definePluralFn(["ar"],(function(n){if(0===n)return 0;if(1===n)return 1;if(2===n)return 2;if(Number.isInteger(n)){var mod100=n%100;if(mod100>=3&&mod100<=10)return 3;if(mod100>=11&&mod100<=99)return 4}return 5}));var DEFAULT_PLURAL_FN=PLURALS[getLang("en-US")];function getPluralFn(lang){return PLURALS[lang]||DEFAULT_PLURAL_FN}var ABSOLUTE_URL=new RegExp("^\\s*(?:(?:[a-z]+[a-z0-9\\-\\+\\.]*:)?//|data:|blob:)","i"),ASSET_ANIMATION="animation",ASSET_AUDIO="audio",ASSET_IMAGE="image",ASSET_JSON="json",ASSET_MODEL="model",ASSET_MATERIAL="material",ASSET_TEXT="text",ASSET_TEXTURE="texture",ASSET_CUBEMAP="cubemap",ASSET_SHADER="shader",ASSET_CSS="css",ASSET_HTML="html",ASSET_SCRIPT="script",ASSET_CONTAINER="container",properties$2=[],AssetVariants=function(){function AssetVariants(asset){this.asset=asset}var _proto;return AssetVariants.prototype.clear=function clear(){for(var i=0;i<properties$2.length;i++)this[properties$2[i]]=null},AssetVariants}();function defineVariantProperty(name){var field="_"+name;properties$2.push(field),Object.defineProperty(AssetVariants.prototype,name,{get:function get(){return this[field]||null},set:function set(value){var fieldAsBool,valueAsBool;(!!this[field]!==!!value||this[field]&&value&&this[field].hash!==value.hash)&&(this[field]=value?{url:value.url,filename:value.filename,size:value.size,hash:value.hash,opt:value.opt||0}:null,this.asset.file&&(this.asset.fire("change",this.asset,"file",this.asset._file,this.asset._file),this.asset.reload()))}})}defineVariantProperty("dxt"),defineVariantProperty("pvr"),defineVariantProperty("etc1"),defineVariantProperty("etc2"),defineVariantProperty("basis");var assetIdCounter=-1,VARIANT_SUPPORT={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},VARIANT_DEFAULT_PRIORITY=["pvr","dxt","etc2","etc1","basis"],Asset=function(_EventHandler){function Asset(name,type,file,data,options){var _this;return(_this=_EventHandler.call(this)||this)._id=assetIdCounter--,_this.name=name||"",_this.type=type,_this.tags=new Tags(_assertThisInitialized(_this)),_this._preload=!1,_this.variants=new AssetVariants(_assertThisInitialized(_this)),_this._file=null,_this._data=data||{},_this.options=options||{},_this._resources=[],_this._i18n={},_this.loaded=!1,_this.loading=!1,_this.registry=null,file&&(_this.file=file),_this}_inheritsLoose(Asset,_EventHandler);var _proto=Asset.prototype;return _proto.getFileUrl=function getFileUrl(){var file=this.getPreferredFile();if(!file||!file.url)return null;var url=file.url;if(this.registry&&this.registry.prefix&&!ABSOLUTE_URL.test(url)&&(url=this.registry.prefix+url),"script"!==this.type&&file.hash){var separator=-1!==url.indexOf("?")?"&":"?";url+=separator+"t="+file.hash}return url},_proto.getPreferredFile=function getPreferredFile(){if(!this.file)return null;if("texture"===this.type||"textureatlas"===this.type||"bundle"===this.type){var _this$registry,_this$registry$_loade,app=(null==(_this$registry=this.registry)?void 0:null==(_this$registry$_loade=_this$registry._loader)?void 0:_this$registry$_loade._app)||getApplication(),device=null==app?void 0:app.graphicsDevice;if(device)for(var i=0,len=VARIANT_DEFAULT_PRIORITY.length;i<len;i++){var variant=VARIANT_DEFAULT_PRIORITY[i];if(device[VARIANT_SUPPORT[variant]]){if(this.file.variants[variant])return this.file.variants[variant];if(app.enableBundles){var bundles=app.bundles.listBundlesForAsset(this);if(!bundles)continue;for(var j=0,len2=bundles.length;j<len2;j++)if(bundles[j].file&&bundles[j].file.variants&&bundles[j].file.variants[variant])return this.file}}}}return this.file},_proto.getAbsoluteUrl=function getAbsoluteUrl(relativePath){if(relativePath.startsWith("blob:")||relativePath.startsWith("data:"))return relativePath;var base=path.getDirectory(this.file.url);return path.join(base,relativePath)},_proto.getLocalizedAssetId=function getLocalizedAssetId(locale){return locale=findAvailableLocale(locale,this._i18n),this._i18n[locale]||null},_proto.addLocalizedAssetId=function addLocalizedAssetId(locale,assetId){this._i18n[locale]=assetId,this.fire("add:localized",locale,assetId)},_proto.removeLocalizedAssetId=function removeLocalizedAssetId(locale){var assetId=this._i18n[locale];assetId&&(delete this._i18n[locale],this.fire("remove:localized",locale,assetId))},_proto.ready=function ready(callback,scope){scope=scope||this,this.resource?callback.call(scope,this):this.once("load",(function(asset){callback.call(scope,asset)}))},_proto.reload=function reload(){this.loaded&&(this.loaded=!1,this.registry.load(this))},_proto.unload=function unload(){if(this.loaded||0!==this._resources.length){this.fire("unload",this),this.registry.fire("unload:"+this.id,this);var old=this._resources;this.resources=[],this.loaded=!1,this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type);for(var i=0;i<old.length;++i){var resource=old[i];resource&&resource.destroy&&resource.destroy()}}},_createClass(Asset,[{key:"id",get:function get(){return this._id},set:function set(value){this._id=value}},{key:"file",get:function get(){return this._file},set:function set(value){var key,valueAsBool,fileAsBool;if(!!value!==!!this._file||value&&this._file&&value.hash!==this._file)if(value){if(this._file||(this._file={}),this._file.url=value.url,this._file.filename=value.filename,this._file.hash=value.hash,this._file.size=value.size,this._file.variants=this.variants,this._file.contents=value.contents,value.hasOwnProperty("variants")&&(this.variants.clear(),value.variants))for(key in value.variants)value.variants[key]&&(this.variants[key]=value.variants[key]);this.fire("change",this,"file",this._file,this._file),this.reload()}else this._file=null,this.variants.clear();else if(value&&this._file&&value.hasOwnProperty("variants")&&(this.variants.clear(),value.variants))for(key in value.variants)value.variants[key]&&(this.variants[key]=value.variants[key])}},{key:"data",get:function get(){return this._data},set:function set(value){var old=this._data;this._data=value,value!==old&&(this.fire("change",this,"data",value,old),this.loaded&&this.registry._loader.patch(this,this.registry))}},{key:"resource",get:function get(){return this._resources[0]},set:function set(value){var _old=this._resources[0];this._resources[0]=value,this.fire("change",this,"resource",value,_old)}},{key:"resources",get:function get(){return this._resources},set:function set(value){var _old=this._resources;this._resources=value,this.fire("change",this,"resources",value,_old)}},{key:"preload",get:function get(){return this._preload},set:function set(value){value=!!value,this._preload!==value&&(this._preload=value,this._preload&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this))}},{key:"loadFaces",get:function get(){return this._loadFaces},set:function set(value){value=!!value,this.hasOwnProperty("_loadFaces")&&value===this._loadFaces||(this._loadFaces=value,this.loaded&&this.registry._loader.patch(this,this.registry))}}]),Asset}(EventHandler),isDataURI=function isDataURI(uri){return/^data:.*,.*$/i.test(uri)},getDataURIMimeType=function getDataURIMimeType(uri){return uri.substring(uri.indexOf(":")+1,uri.indexOf(";"))},getNumComponents=function getNumComponents(accessorType){switch(accessorType){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 3}},getComponentType=function getComponentType(componentType){switch(componentType){case 5120:return 0;case 5121:return 1;case 5122:return 2;case 5123:return 3;case 5124:return 4;case 5125:return 5;case 5126:return 6;default:return 0}},getComponentSizeInBytes=function getComponentSizeInBytes(componentType){switch(componentType){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:return 0}},getComponentDataType=function getComponentDataType(componentType){switch(componentType){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:return null}},gltfToEngineSemanticMap={POSITION:"POSITION",NORMAL:"NORMAL",TANGENT:"TANGENT",COLOR_0:"COLOR",JOINTS_0:"BLENDINDICES",WEIGHTS_0:"BLENDWEIGHT",TEXCOORD_0:"TEXCOORD0",TEXCOORD_1:"TEXCOORD1"},getAccessorData=function getAccessorData(gltfAccessor,bufferViews){var numComponents=getNumComponents(gltfAccessor.type),dataType=getComponentDataType(gltfAccessor.componentType),result;if(!dataType)return null;if(gltfAccessor.sparse){var sparse=gltfAccessor.sparse,indicesAccessor={count:sparse.count,type:"SCALAR"},indices=getAccessorData(Object.assign(indicesAccessor,sparse.indices),bufferViews),valuesAccessor={count:sparse.count,type:gltfAccessor.scalar,componentType:gltfAccessor.componentType},values=getAccessorData(Object.assign(valuesAccessor,sparse.values),bufferViews),baseAccessor;if(gltfAccessor.hasOwnProperty("bufferView"))result=getAccessorData({bufferView:gltfAccessor.bufferView,byteOffset:gltfAccessor.byteOffset,componentType:gltfAccessor.componentType,count:gltfAccessor.count,type:gltfAccessor.type},bufferViews).slice();else result=new dataType(gltfAccessor.count*numComponents);for(var i=0;i<sparse.count;++i)for(var targetIndex=indices[i],j=0;j<numComponents;++j)result[targetIndex*numComponents+j]=values[i*numComponents+j]}else{var bufferView=bufferViews[gltfAccessor.bufferView];result=new dataType(bufferView.buffer,bufferView.byteOffset+(gltfAccessor.hasOwnProperty("byteOffset")?gltfAccessor.byteOffset:0),gltfAccessor.count*numComponents)}return result},getPrimitiveType=function getPrimitiveType(primitive){if(!primitive.hasOwnProperty("mode"))return 4;switch(primitive.mode){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;case 4:return 4;case 5:return 5;case 6:return 6;default:return 4}},generateIndices=function generateIndices(numVertices){for(var dummyIndices=new Uint16Array(numVertices),i=0;i<numVertices;i++)dummyIndices[i]=i;return dummyIndices},generateNormals=function generateNormals(sourceDesc,indices){var p=sourceDesc.POSITION;if(p&&3===p.components){var positions;if(p.size!==p.stride){var srcStride=p.stride/typedArrayTypesByteSize[p.type],src=new typedArrayTypes[p.type](p.buffer,p.offset,p.count*srcStride);positions=new typedArrayTypes[p.type](3*p.count);for(var i=0;i<p.count;++i)positions[3*i+0]=src[i*srcStride+0],positions[3*i+1]=src[i*srcStride+1],positions[3*i+2]=src[i*srcStride+2]}else positions=new typedArrayTypes[p.type](p.buffer,p.offset,3*p.count);var numVertices=p.count;indices||(indices=generateIndices(numVertices));var normalsTemp=calculateNormals(positions,indices),normals=new Float32Array(normalsTemp.length);normals.set(normalsTemp),sourceDesc.NORMAL={buffer:normals.buffer,size:12,offset:0,stride:12,count:numVertices,components:3,type:6}}},flipTexCoordVs=function flipTexCoordVs(vertexBuffer){var i,j,floatOffsets=[],shortOffsets=[],byteOffsets=[];for(i=0;i<vertexBuffer.format.elements.length;++i){var element=vertexBuffer.format.elements[i];if("TEXCOORD0"===element.name||"TEXCOORD1"===element.name)switch(element.dataType){case 6:floatOffsets.push({offset:element.offset/4+1,stride:element.stride/4});break;case 3:shortOffsets.push({offset:element.offset/2+1,stride:element.stride/2});break;case 1:byteOffsets.push({offset:element.offset+1,stride:element.stride})}}var flip=function flip(offsets,type,one){var typedArray=new type(vertexBuffer.storage);for(i=0;i<offsets.length;++i){var index=offsets[i].offset,stride=offsets[i].stride;for(j=0;j<vertexBuffer.numVertices;++j)typedArray[index]=one-typedArray[index],index+=stride}};floatOffsets.length>0&&flip(floatOffsets,Float32Array,1),shortOffsets.length>0&&flip(shortOffsets,Uint16Array,65535),byteOffsets.length>0&&flip(byteOffsets,Uint8Array,255)},cloneTexture=function cloneTexture(texture){var shallowCopyLevels=function shallowCopyLevels(texture){for(var result=[],mip=0;mip<texture._levels.length;++mip){var level=[];if(texture.cubemap)for(var face=0;face<6;++face)level.push(texture._levels[mip][face]);else level=texture._levels[mip];result.push(level)}return result},result=new Texture(texture.device,texture);return result._levels=shallowCopyLevels(texture),result},cloneTextureAsset=function cloneTextureAsset(src){var result=new Asset(src.name+"_clone",src.type,src.file,src.data,src.options);return result.loaded=!0,result.resource=cloneTexture(src.resource),src.registry.add(result),result},createVertexBufferInternal=function createVertexBufferInternal(device,sourceDesc,disableFlipV){var positionDesc=sourceDesc.POSITION;if(!positionDesc)return null;var numVertices=positionDesc.count,vertexDesc=[];for(var semantic in sourceDesc)sourceDesc.hasOwnProperty(semantic)&&vertexDesc.push({semantic:semantic,components:sourceDesc[semantic].components,type:sourceDesc[semantic].type,normalize:!!sourceDesc[semantic].normalize});var elementOrder=["POSITION","NORMAL","TANGENT","COLOR","BLENDINDICES","BLENDWEIGHT","TEXCOORD0","TEXCOORD1"],i,j,k,source,target,sourceOffset;vertexDesc.sort((function(lhs,rhs){var lhsOrder=elementOrder.indexOf(lhs.semantic),rhsOrder=elementOrder.indexOf(rhs.semantic);return lhsOrder<rhsOrder?-1:rhsOrder<lhsOrder?1:0}));var vertexFormat=new VertexFormat(device,vertexDesc),isCorrectlyInterleaved=!0;for(i=0;i<vertexFormat.elements.length;++i)if(sourceOffset=(source=sourceDesc[(target=vertexFormat.elements[i]).name]).offset-positionDesc.offset,source.buffer!==positionDesc.buffer||source.stride!==target.stride||source.size!==target.size||sourceOffset!==target.offset){isCorrectlyInterleaved=!1;break}var vertexBuffer=new VertexBuffer(device,vertexFormat,numVertices,0),vertexData=vertexBuffer.lock(),targetArray=new Uint32Array(vertexData),sourceArray,targetStride,sourceStride;if(isCorrectlyInterleaved)sourceArray=new Uint32Array(positionDesc.buffer,positionDesc.offset,numVertices*vertexBuffer.format.size/4),targetArray.set(sourceArray);else for(i=0;i<vertexBuffer.format.elements.length;++i){targetStride=(target=vertexBuffer.format.elements[i]).stride/4,source=sourceDesc[target.name],sourceArray=new Uint32Array(source.buffer,source.offset,source.count*source.stride/4),sourceStride=source.stride/4;var src=0,dst=target.offset/4,kend=Math.floor((source.size+3)/4);for(j=0;j<numVertices;++j){for(k=0;k<kend;++k)targetArray[dst+k]=sourceArray[src+k];src+=sourceStride,dst+=targetStride}}return disableFlipV||flipTexCoordVs(vertexBuffer),vertexBuffer.unlock(),vertexBuffer},createVertexBuffer=function createVertexBuffer(device,attributes,indices,accessors,bufferViews,disableFlipV,vertexBufferDict){var useAttributes={},attribIds=[];for(var attrib in attributes)attributes.hasOwnProperty(attrib)&&gltfToEngineSemanticMap.hasOwnProperty(attrib)&&(useAttributes[attrib]=attributes[attrib],attribIds.push(attrib+":"+attributes[attrib]));attribIds.sort();var vbKey=attribIds.join(),vb=vertexBufferDict[vbKey];if(!vb){var sourceDesc={};for(var _attrib in useAttributes){var accessor=accessors[attributes[_attrib]],accessorData=getAccessorData(accessor,bufferViews),bufferView=bufferViews[accessor.bufferView],semantic=gltfToEngineSemanticMap[_attrib],size=getNumComponents(accessor.type)*getComponentSizeInBytes(accessor.componentType),stride=bufferView.hasOwnProperty("byteStride")?bufferView.byteStride:size;sourceDesc[semantic]={buffer:accessorData.buffer,size:size,offset:accessorData.byteOffset,stride:stride,count:accessor.count,components:getNumComponents(accessor.type),type:getComponentType(accessor.componentType),normalize:accessor.normalized}}sourceDesc.hasOwnProperty("NORMAL")||generateNormals(sourceDesc,indices),vb=createVertexBufferInternal(device,sourceDesc,disableFlipV),vertexBufferDict[vbKey]=vb}return vb},createVertexBufferDraco=function createVertexBufferDraco(device,outputGeometry,extDraco,decoder,decoderModule,indices,disableFlipV){var numPoints=outputGeometry.num_points(),extractDracoAttributeInfo=function extractDracoAttributeInfo(uniqueId){var attribute=decoder.GetAttributeByUniqueId(outputGeometry,uniqueId),numValues=numPoints*attribute.num_components(),dracoFormat,ptr,values,componentSizeInBytes,storageType;switch(attribute.data_type()){case decoderModule.DT_UINT8:storageType=1,componentSizeInBytes=1,ptr=decoderModule._malloc(numValues*componentSizeInBytes),decoder.GetAttributeDataArrayForAllPoints(outputGeometry,attribute,decoderModule.DT_UINT8,numValues*componentSizeInBytes,ptr),values=new Uint8Array(decoderModule.HEAPU8.buffer,ptr,numValues).slice();break;case decoderModule.DT_UINT16:storageType=3,componentSizeInBytes=2,ptr=decoderModule._malloc(numValues*componentSizeInBytes),decoder.GetAttributeDataArrayForAllPoints(outputGeometry,attribute,decoderModule.DT_UINT16,numValues*componentSizeInBytes,ptr),values=new Uint16Array(decoderModule.HEAPU16.buffer,ptr,numValues).slice();break;case decoderModule.DT_FLOAT32:default:storageType=6,componentSizeInBytes=4,ptr=decoderModule._malloc(numValues*componentSizeInBytes),decoder.GetAttributeDataArrayForAllPoints(outputGeometry,attribute,decoderModule.DT_FLOAT32,numValues*componentSizeInBytes,ptr),values=new Float32Array(decoderModule.HEAPF32.buffer,ptr,numValues).slice()}return decoderModule._free(ptr),{values:values,numComponents:attribute.num_components(),componentSizeInBytes:componentSizeInBytes,storageType:storageType,normalized:attribute.normalized()}},sourceDesc={},attributes=extDraco.attributes;for(var attrib in attributes)if(attributes.hasOwnProperty(attrib)&&gltfToEngineSemanticMap.hasOwnProperty(attrib)){var semantic=gltfToEngineSemanticMap[attrib],attributeInfo=extractDracoAttributeInfo(attributes[attrib]),size=attributeInfo.numComponents*attributeInfo.componentSizeInBytes;sourceDesc[semantic]={values:attributeInfo.values,buffer:attributeInfo.values.buffer,size:size,offset:0,stride:size,count:numPoints,components:attributeInfo.numComponents,type:attributeInfo.storageType,normalize:attributeInfo.normalized}}return sourceDesc.hasOwnProperty("NORMAL")||generateNormals(sourceDesc,indices),createVertexBufferInternal(device,sourceDesc,disableFlipV)},createSkin=function createSkin(device,gltfSkin,accessors,bufferViews,nodes,glbSkins){var i,j,bindMatrix,joints=gltfSkin.joints,numJoints=joints.length,ibp=[];if(gltfSkin.hasOwnProperty("inverseBindMatrices")){var inverseBindMatrices=gltfSkin.inverseBindMatrices,ibmData=getAccessorData(accessors[inverseBindMatrices],bufferViews),ibmValues=[];for(i=0;i<numJoints;i++){for(j=0;j<16;j++)ibmValues[j]=ibmData[16*i+j];(bindMatrix=new Mat4).set(ibmValues),ibp.push(bindMatrix)}}else for(i=0;i<numJoints;i++)bindMatrix=new Mat4,ibp.push(bindMatrix);var boneNames=[];for(i=0;i<numJoints;i++)boneNames[i]=nodes[joints[i]].name;var key=boneNames.join("#"),skin=glbSkins.get(key);return skin||(skin=new Skin(device,ibp,boneNames),glbSkins.set(key,skin)),skin},tempMat=new Mat4,tempVec=new Vec3,createMesh=function createMesh(device,gltfMesh,accessors,bufferViews,callback,disableFlipV,vertexBufferDict){var meshes=[];return gltfMesh.primitives.forEach((function(primitive){var primitiveType,vertexBuffer,numIndices,indices=null,canUseMorph=!0;if(primitive.hasOwnProperty("extensions")){var extensions=primitive.extensions;if(extensions.hasOwnProperty("KHR_draco_mesh_compression")){var decoderModule=window.DracoDecoderModule;if(decoderModule){var extDraco=extensions.KHR_draco_mesh_compression;if(extDraco.hasOwnProperty("attributes")){var uint8Buffer=bufferViews[extDraco.bufferView],buffer=new decoderModule.DecoderBuffer;buffer.Init(uint8Buffer,uint8Buffer.length);var decoder=new decoderModule.Decoder,geometryType=decoder.GetEncodedGeometryType(buffer),outputGeometry,status;switch(geometryType){case decoderModule.POINT_CLOUD:primitiveType=0,outputGeometry=new decoderModule.PointCloud,status=decoder.DecodeBufferToPointCloud(buffer,outputGeometry);break;case decoderModule.TRIANGULAR_MESH:primitiveType=4,outputGeometry=new decoderModule.Mesh,status=decoder.DecodeBufferToMesh(buffer,outputGeometry);break;case decoderModule.INVALID_GEOMETRY_TYPE:}if(!status||!status.ok()||0==outputGeometry.ptr)return void callback("Failed to decode draco compressed asset: "+(status?status.error_msg():"Mesh asset - invalid draco compressed geometry type: "+geometryType));var numFaces=outputGeometry.num_faces();if(geometryType===decoderModule.TRIANGULAR_MESH){var bit32=outputGeometry.num_points()>65535,dataSize=(numIndices=3*numFaces)*(bit32?4:2),ptr=decoderModule._malloc(dataSize);bit32?(decoder.GetTrianglesUInt32Array(outputGeometry,dataSize,ptr),indices=new Uint32Array(decoderModule.HEAPU32.buffer,ptr,numIndices).slice()):(decoder.GetTrianglesUInt16Array(outputGeometry,dataSize,ptr),indices=new Uint16Array(decoderModule.HEAPU16.buffer,ptr,numIndices).slice()),decoderModule._free(ptr)}vertexBuffer=createVertexBufferDraco(device,outputGeometry,extDraco,decoder,decoderModule,indices,disableFlipV),decoderModule.destroy(outputGeometry),decoderModule.destroy(decoder),decoderModule.destroy(buffer),canUseMorph=!1}}}}vertexBuffer||(indices=primitive.hasOwnProperty("indices")?getAccessorData(accessors[primitive.indices],bufferViews):null,vertexBuffer=createVertexBuffer(device,primitive.attributes,indices,accessors,bufferViews,disableFlipV,vertexBufferDict),primitiveType=getPrimitiveType(primitive));var mesh=null;if(vertexBuffer){if((mesh=new Mesh(device)).vertexBuffer=vertexBuffer,mesh.primitive[0].type=primitiveType,mesh.primitive[0].base=0,mesh.primitive[0].indexed=null!==indices,null!==indices){var indexFormat;2!==(indexFormat=indices instanceof Uint8Array?0:indices instanceof Uint16Array?1:2)||device.extUintElement||(indexFormat=1,indices=new Uint16Array(indices));var indexBuffer=new IndexBuffer(device,indexFormat,indices.length,0,indices);mesh.indexBuffer[0]=indexBuffer,mesh.primitive[0].count=indices.length}else mesh.primitive[0].count=vertexBuffer.numVertices;mesh.materialIndex=primitive.material;var accessor=accessors[primitive.attributes.POSITION],min=accessor.min,max=accessor.max,aabb=new BoundingBox(new Vec3((max[0]+min[0])/2,(max[1]+min[1])/2,(max[2]+min[2])/2),new Vec3((max[0]-min[0])/2,(max[1]-min[1])/2,(max[2]-min[2])/2));if(mesh.aabb=aabb,canUseMorph&&primitive.hasOwnProperty("targets")){var targets=[];primitive.targets.forEach((function(target,index){var options={};target.hasOwnProperty("POSITION")&&(accessor=accessors[target.POSITION],options.deltaPositions=getAccessorData(accessor,bufferViews),options.deltaPositionsType=getComponentType(accessor.componentType),accessor.hasOwnProperty("min")&&accessor.hasOwnProperty("max")&&(options.aabb=new BoundingBox,options.aabb.setMinMax(new Vec3(accessor.min),new Vec3(accessor.max)))),target.hasOwnProperty("NORMAL")&&(accessor=accessors[target.NORMAL],options.deltaNormals=getAccessorData(accessor,bufferViews),options.deltaNormalsType=getComponentType(accessor.componentType)),gltfMesh.hasOwnProperty("extras")&&gltfMesh.extras.hasOwnProperty("targetNames")?options.name=gltfMesh.extras.targetNames[index]:options.name=index.toString(10),gltfMesh.hasOwnProperty("weights")&&(options.defaultWeight=gltfMesh.weights[index]),targets.push(new MorphTarget(options))})),mesh.morph=new Morph(targets,device)}}meshes.push(mesh)})),meshes},createMaterial=function createMaterial(gltfMaterial,textures,disableFlipV){var glossChunk=["#ifdef MAPFLOAT","uniform float material_shininess;","#endif","","#ifdef MAPTEXTURE","uniform sampler2D texture_glossMap;","#endif","","void getGlossiness() {","\t\tdGlossiness = 1.0;","","#ifdef MAPFLOAT","\t\tdGlossiness *= material_shininess;","#endif","","#ifdef MAPTEXTURE","\t\tdGlossiness *= texture2D(texture_glossMap, $UV).$CH;","#endif","","#ifdef MAPVERTEX","\t\tdGlossiness *= saturate(vVertexColor.$VC);","#endif","","\t\tdGlossiness = 1.0 - dGlossiness;","","\t\tdGlossiness += 0.0000001;","}"].join("\n"),specularChunk=["#ifdef MAPCOLOR","uniform vec3 material_specular;","#endif","","#ifdef MAPTEXTURE","uniform sampler2D texture_specularMap;","#endif","","void getSpecularity() {","\t\tdSpecularity = vec3(1.0);","","\t\t#ifdef MAPCOLOR","\t\t\t\tdSpecularity *= material_specular;","\t\t#endif","","\t\t#ifdef MAPTEXTURE","\t\t\t\tvec3 srgb = texture2D(texture_specularMap, $UV).$CH;","\t\t\t\tdSpecularity *= vec3(pow(srgb.r, 2.2), pow(srgb.g, 2.2), pow(srgb.b, 2.2));","\t\t#endif","","\t\t#ifdef MAPVERTEX","\t\t\t\tdSpecularity *= saturate(vVertexColor.$VC);","\t\t#endif","}"].join("\n"),clearCoatGlossChunk=["#ifdef MAPFLOAT","uniform float material_clearCoatGlossiness;","#endif","","#ifdef MAPTEXTURE","uniform sampler2D texture_clearCoatGlossMap;","#endif","","void getClearCoatGlossiness() {","\t\tccGlossiness = 1.0;","","#ifdef MAPFLOAT","\t\tccGlossiness *= material_clearCoatGlossiness;","#endif","","#ifdef MAPTEXTURE","\t\tccGlossiness *= texture2D(texture_clearCoatGlossMap, $UV).$CH;","#endif","","#ifdef MAPVERTEX","\t\tccGlossiness *= saturate(vVertexColor.$VC);","#endif","","\t\tccGlossiness = 1.0 - ccGlossiness;","","\t\tccGlossiness += 0.0000001;","}"].join("\n"),uvONE=[1,1],uvZERO=[0,0],extractTextureTransform=function extractTextureTransform(source,material,maps){var map,texCoord=source.texCoord;if(texCoord)for(map=0;map<maps.length;++map)material[maps[map]+"MapUv"]=texCoord;var scale=uvONE,offset=uvZERO,extensions=source.extensions;if(extensions){var textureTransformData=extensions.KHR_texture_transform;textureTransformData&&(textureTransformData.scale&&(scale=textureTransformData.scale),textureTransformData.offset&&(offset=textureTransformData.offset))}for(map=0;map<maps.length;++map)material[maps[map]+"MapTiling"]=new Vec2(scale[0],scale[1]),material[maps[map]+"MapOffset"]=new Vec2(offset[0],disableFlipV?offset[1]:1-scale[1]-offset[1])},material=new StandardMaterial,color,texture;if(material.occludeSpecular=!0,material.diffuseTint=!0,material.diffuseVertexColor=!0,material.specularTint=!0,material.specularVertexColor=!0,gltfMaterial.hasOwnProperty("name")&&(material.name=gltfMaterial.name),gltfMaterial.hasOwnProperty("extensions")&&gltfMaterial.extensions.hasOwnProperty("KHR_materials_pbrSpecularGlossiness")){var specData=gltfMaterial.extensions.KHR_materials_pbrSpecularGlossiness;if(specData.hasOwnProperty("diffuseFactor")?(color=specData.diffuseFactor,material.diffuse.set(Math.pow(color[0],1/2.2),Math.pow(color[1],1/2.2),Math.pow(color[2],1/2.2)),material.opacity=color[3]):(material.diffuse.set(1,1,1),material.opacity=1),specData.hasOwnProperty("diffuseTexture")){var diffuseTexture=specData.diffuseTexture;texture=textures[diffuseTexture.index],material.diffuseMap=texture,material.diffuseMapChannel="rgb",material.opacityMap=texture,material.opacityMapChannel="a",extractTextureTransform(diffuseTexture,material,["diffuse","opacity"])}if(material.useMetalness=!1,specData.hasOwnProperty("specularFactor")?(color=specData.specularFactor,material.specular.set(Math.pow(color[0],1/2.2),Math.pow(color[1],1/2.2),Math.pow(color[2],1/2.2))):material.specular.set(1,1,1),specData.hasOwnProperty("glossinessFactor")?material.shininess=100*specData.glossinessFactor:material.shininess=100,specData.hasOwnProperty("specularGlossinessTexture")){var specularGlossinessTexture=specData.specularGlossinessTexture;material.specularMap=material.glossMap=textures[specularGlossinessTexture.index],material.specularMapChannel="rgb",material.glossMapChannel="a",extractTextureTransform(specularGlossinessTexture,material,["gloss","metalness"])}material.chunks.specularPS=specularChunk}else if(gltfMaterial.hasOwnProperty("pbrMetallicRoughness")){var pbrData=gltfMaterial.pbrMetallicRoughness;if(pbrData.hasOwnProperty("baseColorFactor")?(color=pbrData.baseColorFactor,material.diffuse.set(Math.pow(color[0],1/2.2),Math.pow(color[1],1/2.2),Math.pow(color[2],1/2.2)),material.opacity=color[3]):(material.diffuse.set(1,1,1),material.opacity=1),pbrData.hasOwnProperty("baseColorTexture")){var baseColorTexture=pbrData.baseColorTexture;texture=textures[baseColorTexture.index],material.diffuseMap=texture,material.diffuseMapChannel="rgb",material.opacityMap=texture,material.opacityMapChannel="a",extractTextureTransform(baseColorTexture,material,["diffuse","opacity"])}if(material.useMetalness=!0,pbrData.hasOwnProperty("metallicFactor")?material.metalness=pbrData.metallicFactor:material.metalness=1,pbrData.hasOwnProperty("roughnessFactor")?material.shininess=100*pbrData.roughnessFactor:material.shininess=100,pbrData.hasOwnProperty("metallicRoughnessTexture")){var metallicRoughnessTexture=pbrData.metallicRoughnessTexture;material.metalnessMap=material.glossMap=textures[metallicRoughnessTexture.index],material.metalnessMapChannel="b",material.glossMapChannel="g",extractTextureTransform(metallicRoughnessTexture,material,["gloss","metalness"])}material.chunks.glossPS=glossChunk}if(gltfMaterial.hasOwnProperty("normalTexture")){var normalTexture=gltfMaterial.normalTexture;material.normalMap=textures[normalTexture.index],extractTextureTransform(normalTexture,material,["normal"]),normalTexture.hasOwnProperty("scale")&&(material.bumpiness=normalTexture.scale)}if(gltfMaterial.hasOwnProperty("occlusionTexture")){var occlusionTexture=gltfMaterial.occlusionTexture;material.aoMap=textures[occlusionTexture.index],material.aoMapChannel="r",extractTextureTransform(occlusionTexture,material,["ao"])}if(gltfMaterial.hasOwnProperty("emissiveFactor")?(color=gltfMaterial.emissiveFactor,material.emissive.set(Math.pow(color[0],1/2.2),Math.pow(color[1],1/2.2),Math.pow(color[2],1/2.2)),material.emissiveTint=!0):(material.emissive.set(0,0,0),material.emissiveTint=!1),gltfMaterial.hasOwnProperty("emissiveTexture")){var emissiveTexture=gltfMaterial.emissiveTexture;material.emissiveMap=textures[emissiveTexture.index],extractTextureTransform(emissiveTexture,material,["emissive"])}if(gltfMaterial.hasOwnProperty("alphaMode"))switch(gltfMaterial.alphaMode){case"MASK":material.blendType=3,gltfMaterial.hasOwnProperty("alphaCutoff")?material.alphaTest=gltfMaterial.alphaCutoff:material.alphaTest=.5;break;case"BLEND":material.blendType=2;break;default:case"OPAQUE":material.blendType=3}else material.blendType=3;if(gltfMaterial.hasOwnProperty("doubleSided")?(material.twoSidedLighting=gltfMaterial.doubleSided,material.cull=gltfMaterial.doubleSided?0:1):(material.twoSidedLighting=!1,material.cull=1),gltfMaterial.hasOwnProperty("extensions")&&gltfMaterial.extensions.hasOwnProperty("KHR_materials_clearcoat")){var ccData=gltfMaterial.extensions.KHR_materials_clearcoat;if(ccData.hasOwnProperty("clearcoatFactor")?material.clearCoat=.25*ccData.clearcoatFactor:material.clearCoat=0,ccData.hasOwnProperty("clearcoatTexture")){var clearcoatTexture=ccData.clearcoatTexture;material.clearCoatMap=textures[clearcoatTexture.index],material.clearCoatMapChannel="r",extractTextureTransform(clearcoatTexture,material,["clearCoat"])}if(ccData.hasOwnProperty("clearcoatRoughnessFactor")?material.clearCoatGlossiness=ccData.clearcoatRoughnessFactor:material.clearCoatGlossiness=0,ccData.hasOwnProperty("clearcoatRoughnessTexture")){var clearcoatRoughnessTexture=ccData.clearcoatRoughnessTexture;material.clearCoatGlossMap=textures[clearcoatRoughnessTexture.index],material.clearCoatGlossMapChannel="g",extractTextureTransform(clearcoatRoughnessTexture,material,["clearCoatGloss"])}if(ccData.hasOwnProperty("clearcoatNormalTexture")){var clearcoatNormalTexture=ccData.clearcoatNormalTexture;material.clearCoatNormalMap=textures[clearcoatNormalTexture.index],extractTextureTransform(clearcoatNormalTexture,material,["clearCoatNormal"]),clearcoatNormalTexture.hasOwnProperty("scale")&&(material.clearCoatBumpiness=clearcoatNormalTexture.scale)}material.chunks.clearCoatGlossPS=clearCoatGlossChunk}return gltfMaterial.hasOwnProperty("extensions")&&gltfMaterial.extensions.hasOwnProperty("KHR_materials_unlit")&&(material.useLighting=!1,material.emissive.copy(material.diffuse),material.emissiveTint=material.diffuseTint,material.emissiveMap=material.diffuseMap,material.emissiveMapUv=material.diffuseMapUv,material.emissiveMapTiling.copy(material.diffuseMapTiling),material.emissiveMapOffset.copy(material.diffuseMapOffset),material.emissiveMapChannel=material.diffuseMapChannel,material.emissiveVertexColor=material.diffuseVertexColor,material.emissiveVertexColorChannel=material.diffuseVertexColorChannel,material.diffuse.set(0,0,0),material.diffuseTint=!1,material.diffuseMap=null,material.diffuseVertexColor=!1),material.update(),material},createAnimation=function createAnimation(gltfAnimation,animationIndex,gltfAccessors,bufferViews,nodes){var createAnimData=function createAnimData(gltfAccessor){var data=getAccessorData(gltfAccessor,bufferViews);return new AnimData(getNumComponents(gltfAccessor.type),new data.constructor(data))},interpMap={STEP:0,LINEAR:1,CUBICSPLINE:2},inputMap={},inputs=[],outputMap={},outputs=[],curves=[],i;for(i=0;i<gltfAnimation.samplers.length;++i){var sampler=gltfAnimation.samplers[i];inputMap.hasOwnProperty(sampler.input)||(inputMap[sampler.input]=inputs.length,inputs.push(createAnimData(gltfAccessors[sampler.input]))),outputMap.hasOwnProperty(sampler.output)||(outputMap[sampler.output]=outputs.length,outputs.push(createAnimData(gltfAccessors[sampler.output])));var interpolation=sampler.hasOwnProperty("interpolation")&&interpMap.hasOwnProperty(sampler.interpolation)?interpMap[sampler.interpolation]:1;curves.push(new AnimCurve([],inputMap[sampler.input],outputMap[sampler.output],interpolation))}var quatArrays=[],transformSchema={translation:"localPosition",rotation:"localRotation",scale:"localScale",weights:"weights"};for(i=0;i<gltfAnimation.channels.length;++i){var channel=gltfAnimation.channels[i],target=channel.target,curve=curves[channel.sampler],node=nodes[target.node],entityPath=[nodes[0].name].concat(AnimBinder.splitPath(node.path,"/"));curve._paths.push({entityPath:entityPath,component:"graph",propertyPath:[transformSchema[target.path]]}),target.path.startsWith("rotation")&&2!==curve.interpolation?quatArrays.push(curve.output):target.path.startsWith("weights")&&(outputs[curve.output]._components=outputs[curve.output].data.length/inputs[curve.input].data.length)}quatArrays.sort();var prevIndex=null,data;for(i=0;i<quatArrays.length;++i){var index=quatArrays[i];if(0===i||index!==prevIndex){if(4===(data=outputs[index]).components)for(var d=data.data,len=d.length-4,j=0;j<len;j+=4){var dp;d[j+0]*d[j+4]+d[j+1]*d[j+5]+d[j+2]*d[j+6]+d[j+3]*d[j+7]<0&&(d[j+4]*=-1,d[j+5]*=-1,d[j+6]*=-1,d[j+7]*=-1)}prevIndex=index}}var duration=0;for(i=0;i<inputs.length;i++)data=inputs[i]._data,duration=Math.max(duration,0===data.length?0:data[data.length-1]);return new AnimTrack(gltfAnimation.hasOwnProperty("name")?gltfAnimation.name:"animation_"+animationIndex,duration,inputs,outputs,curves)},createNode=function createNode(gltfNode,nodeIndex){var entity=new GraphNode;if(gltfNode.hasOwnProperty("name")&&gltfNode.name.length>0?entity.name=gltfNode.name:entity.name="node_"+nodeIndex,gltfNode.hasOwnProperty("matrix")&&(tempMat.data.set(gltfNode.matrix),tempMat.getTranslation(tempVec),entity.setLocalPosition(tempVec),tempMat.getEulerAngles(tempVec),entity.setLocalEulerAngles(tempVec),tempMat.getScale(tempVec),entity.setLocalScale(tempVec)),gltfNode.hasOwnProperty("rotation")){var r=gltfNode.rotation;entity.setLocalRotation(r[0],r[1],r[2],r[3])}if(gltfNode.hasOwnProperty("translation")){var t=gltfNode.translation;entity.setLocalPosition(t[0],t[1],t[2])}if(gltfNode.hasOwnProperty("scale")){var s=gltfNode.scale;entity.setLocalScale(s[0],s[1],s[2])}return entity},createSkins=function createSkins(device,gltf,nodes,bufferViews){if(!gltf.hasOwnProperty("skins")||0===gltf.skins.length)return[];var glbSkins=new Map;return gltf.skins.map((function(gltfSkin){return createSkin(device,gltfSkin,gltf.accessors,bufferViews,nodes,glbSkins)}))},createMeshes=function createMeshes(device,gltf,bufferViews,callback,disableFlipV){if(!gltf.hasOwnProperty("meshes")||0===gltf.meshes.length||!gltf.hasOwnProperty("accessors")||0===gltf.accessors.length||!gltf.hasOwnProperty("bufferViews")||0===gltf.bufferViews.length)return[];var vertexBufferDict={};return gltf.meshes.map((function(gltfMesh){return createMesh(device,gltfMesh,gltf.accessors,bufferViews,callback,disableFlipV,vertexBufferDict)}))},createMaterials=function createMaterials(gltf,textures,options,disableFlipV){if(!gltf.hasOwnProperty("materials")||0===gltf.materials.length)return[];var preprocess=options&&options.material&&options.material.preprocess,process=options&&options.material&&options.material.process||createMaterial,postprocess=options&&options.material&&options.material.postprocess;return gltf.materials.map((function(gltfMaterial){preprocess&&preprocess(gltfMaterial);var material=process(gltfMaterial,textures,disableFlipV);return postprocess&&postprocess(gltfMaterial,material),material}))},createAnimations=function createAnimations(gltf,nodes,bufferViews,options){if(!gltf.hasOwnProperty("animations")||0===gltf.animations.length)return[];var preprocess=options&&options.animation&&options.animation.preprocess,postprocess=options&&options.animation&&options.animation.postprocess;return gltf.animations.map((function(gltfAnimation,index){preprocess&&preprocess(gltfAnimation);var animation=createAnimation(gltfAnimation,index,gltf.accessors,bufferViews,nodes);return postprocess&&postprocess(gltfAnimation,animation),animation}))},createNodes=function createNodes(gltf,options){if(!gltf.hasOwnProperty("nodes")||0===gltf.nodes.length)return[];for(var preprocess=options&&options.node&&options.node.preprocess,process=options&&options.node&&options.node.process||createNode,postprocess=options&&options.node&&options.node.postprocess,nodes=gltf.nodes.map((function(gltfNode,index){preprocess&&preprocess(gltfNode);var node=process(gltfNode,index);return postprocess&&postprocess(gltfNode,node),node})),i=0;i<gltf.nodes.length;++i){var gltfNode=gltf.nodes[i];if(gltfNode.hasOwnProperty("children"))for(var j=0;j<gltfNode.children.length;++j){var parent=nodes[i],child=nodes[gltfNode.children[j]];child.parent||parent.addChild(child)}}return nodes},createScenes=function createScenes(gltf,nodes){var scenes=[],count=gltf.scenes.length;if(1===count&&1===gltf.scenes[0].nodes.length){var nodeIndex=gltf.scenes[0].nodes[0];scenes.push(nodes[nodeIndex])}else for(var i=0;i<count;i++){for(var scene=gltf.scenes[i],sceneRoot=new GraphNode(scene.name),n=0;n<scene.nodes.length;n++){var childNode=nodes[scene.nodes[n]];sceneRoot.addChild(childNode)}scenes.push(sceneRoot)}return scenes},createResources=function createResources(device,gltf,bufferViews,textureAssets,options,callback){var preprocess=options&&options.global&&options.global.preprocess,postprocess=options&&options.global&&options.global.postprocess;preprocess&&preprocess(gltf);for(var disableFlipV=gltf.asset&&"PlayCanvas"===gltf.asset.generator,nodes=createNodes(gltf,options),scenes=createScenes(gltf,nodes),animations=createAnimations(gltf,nodes,bufferViews,options),materials=createMaterials(gltf,textureAssets.map((function(textureAsset){return textureAsset.resource})),options,disableFlipV),meshes=createMeshes(device,gltf,bufferViews,callback,disableFlipV),skins=createSkins(device,gltf,nodes,bufferViews),renders=[],i=0;i<meshes.length;i++)renders[i]=new Render,renders[i].meshes=meshes[i];var result={gltf:gltf,nodes:nodes,scenes:scenes,animations:animations,textures:textureAssets,materials:materials,renders:renders,skins:skins};postprocess&&postprocess(gltf,result),callback(null,result)},applySampler=function applySampler(texture,gltfSampler){var getFilter=function getFilter(filter,defaultValue){switch(filter){case 9728:return 0;case 9729:return 1;case 9984:return 2;case 9985:return 4;case 9986:return 3;case 9987:return 5;default:return defaultValue}},getWrap=function getWrap(wrap,defaultValue){switch(wrap){case 33071:return 1;case 33648:return 2;case 10497:return 0;default:return defaultValue}};texture&&(gltfSampler=gltfSampler||{},texture.minFilter=getFilter(gltfSampler.minFilter,5),texture.magFilter=getFilter(gltfSampler.magFilter,1),texture.addressU=getWrap(gltfSampler.wrapS,0),texture.addressV=getWrap(gltfSampler.wrapT,0))},loadImageAsync=function loadImageAsync(gltfImage,index,bufferViews,urlBase,registry,options,callback){var preprocess=options&&options.image&&options.image.preprocess,processAsync=options&&options.image&&options.image.processAsync||function(gltfImage,callback){callback(null,null)},postprocess=options&&options.image&&options.image.postprocess,onLoad=function onLoad(textureAsset){postprocess&&postprocess(gltfImage,textureAsset),callback(null,textureAsset)},loadTexture=function loadTexture(url,mimeType,crossOrigin,isBlobUrl){var mimeTypeFileExtensions,file={url:url};if(mimeType){var extension={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/vnd-ms.dds":"dds"}[mimeType];extension&&(file.filename="glb-texture-"+index+"."+extension)}var asset=new Asset("texture_"+index,"texture",file,null,{crossOrigin:crossOrigin});asset.on("load",(function(){isBlobUrl&&URL.revokeObjectURL(url),onLoad(asset)})),asset.on("error",(function(err,asset){callback(err)})),registry.add(asset),registry.load(asset)};preprocess&&preprocess(gltfImage),processAsync(gltfImage,(function(err,textureAsset){if(err)callback(err);else if(textureAsset)onLoad(textureAsset);else if(gltfImage.hasOwnProperty("uri"))isDataURI(gltfImage.uri)?loadTexture(gltfImage.uri,getDataURIMimeType(gltfImage.uri)):loadTexture(path.join(urlBase,gltfImage.uri),null,"anonymous");else if(gltfImage.hasOwnProperty("bufferView")&&gltfImage.hasOwnProperty("mimeType")){var blob=new Blob([bufferViews[gltfImage.bufferView]],{type:gltfImage.mimeType});loadTexture(URL.createObjectURL(blob),gltfImage.mimeType,null,!0)}else callback("Invalid image found in gltf (neither uri or bufferView found). index="+index)}))},loadTexturesAsync=function loadTexturesAsync(gltf,bufferViews,urlBase,registry,options,callback){if(gltf.hasOwnProperty("images")&&0!==gltf.images.length&&gltf.hasOwnProperty("textures")&&0!==gltf.textures.length)for(var preprocess=options&&options.texture&&options.texture.preprocess,processAsync=options&&options.texture&&options.texture.processAsync||function(gltfTexture,gltfImages,callback){callback(null,null)},postprocess=options&&options.texture&&options.texture.postprocess,assets=[],textures=[],remaining=gltf.textures.length,onLoad=function onLoad(textureIndex,imageIndex){if(textures[imageIndex]||(textures[imageIndex]=[]),textures[imageIndex].push(textureIndex),0==--remaining){var result=[];textures.forEach((function(textureList,imageIndex){textureList.forEach((function(textureIndex,index){var textureAsset=0===index?assets[imageIndex]:cloneTextureAsset(assets[imageIndex]);applySampler(textureAsset.resource,(gltf.samplers||[])[gltf.textures[textureIndex].sampler]),result[textureIndex]=textureAsset,postprocess&&postprocess(gltf.textures[index],textureAsset)}))})),callback(null,result)}},i=0;i<gltf.textures.length;++i){var gltfTexture=gltf.textures[i];preprocess&&preprocess(gltfTexture),processAsync(gltfTexture,gltf.images,function(i,gltfTexture,err,gltfImageIndex){if(err)callback(err);else if(null==gltfImageIndex&&(gltfImageIndex=gltfTexture.source),assets[gltfImageIndex])onLoad(i,gltfImageIndex);else{var gltfImage=gltf.images[gltfImageIndex];loadImageAsync(gltfImage,i,bufferViews,urlBase,registry,options,(function(err,textureAsset){err?callback(err):(assets[gltfImageIndex]=textureAsset,onLoad(i,gltfImageIndex))}))}}.bind(null,i,gltfTexture))}else callback(null,[])},loadBuffersAsync=function loadBuffersAsync(gltf,binaryChunk,urlBase,options,callback){var result=[];if(gltf.buffers&&0!==gltf.buffers.length)for(var preprocess=options&&options.buffer&&options.buffer.preprocess,processAsync=options&&options.buffer&&options.buffer.processAsync||function(gltfBuffer,callback){callback(null,null)},postprocess=options&&options.buffer&&options.buffer.postprocess,remaining=gltf.buffers.length,onLoad=function onLoad(index,buffer){result[index]=buffer,postprocess&&postprocess(gltf.buffers[index],buffer),0==--remaining&&callback(null,result)},i=0;i<gltf.buffers.length;++i){var gltfBuffer=gltf.buffers[i];preprocess&&preprocess(gltfBuffer),processAsync(gltfBuffer,function(i,gltfBuffer,err,arrayBuffer){if(err)callback(err);else if(arrayBuffer)onLoad(i,new Uint8Array(arrayBuffer));else if(gltfBuffer.hasOwnProperty("uri"))if(isDataURI(gltfBuffer.uri)){for(var byteString=atob(gltfBuffer.uri.split(",")[1]),binaryArray=new Uint8Array(byteString.length),j=0;j<byteString.length;j++)binaryArray[j]=byteString.charCodeAt(j);onLoad(i,binaryArray)}else http.get(path.join(urlBase,gltfBuffer.uri),{cache:!0,responseType:"arraybuffer",retry:!1},function(i,err,result){err?callback(err):onLoad(i,new Uint8Array(result))}.bind(null,i));else onLoad(i,binaryChunk)}.bind(null,i,gltfBuffer))}else callback(null,result)},parseGltf=function parseGltf(gltfChunk,callback){var decodeBinaryUtf8=function decodeBinaryUtf8(array){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(array);for(var str="",i=0;i<array.length;i++)str+=String.fromCharCode(array[i]);return decodeURIComponent(escape(str))},gltf=JSON.parse(decodeBinaryUtf8(gltfChunk));gltf.asset&&gltf.asset.version&&parseFloat(gltf.asset.version)<2?callback("Invalid gltf version. Expected version 2.0 or above but found version '"+gltf.asset.version+"'."):callback(null,gltf)},parseGlb=function parseGlb(glbData,callback){var data=new DataView(glbData),magic=data.getUint32(0,!0),version=data.getUint32(4,!0),length=data.getUint32(8,!0);if(1179937895===magic)if(2===version)if(length<=0||length>glbData.byteLength)callback("Invalid length found in glb header. Found "+length);else{for(var chunks=[],offset=12;offset<length;){var chunkLength=data.getUint32(offset,!0);if(offset+chunkLength+8>glbData.byteLength)throw new Error("Invalid chunk length found in glb. Found "+chunkLength);var chunkType=data.getUint32(offset+4,!0),chunkData=new Uint8Array(glbData,offset+8,chunkLength);chunks.push({length:chunkLength,type:chunkType,data:chunkData}),offset+=chunkLength+8}1===chunks.length||2===chunks.length?1313821514===chunks[0].type?chunks.length>1&&5130562!==chunks[1].type?callback("Invalid chunk type found in glb file. Expected 0x004E4942, found 0x"+chunks[1].type.toString(16)):callback(null,{gltfChunk:chunks[0].data,binaryChunk:2===chunks.length?chunks[1].data:null}):callback("Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x"+chunks[0].type.toString(16)):callback("Invalid number of chunks found in glb file.")}else callback("Invalid version number found in glb header. Expected 2, found "+version);else callback("Invalid magic number found in glb header. Expected 0x46546C67, found 0x"+magic.toString(16))},parseChunk=function parseChunk(filename,data,callback){filename&&filename.toLowerCase().endsWith(".glb")?parseGlb(data,callback):callback(null,{gltfChunk:data,binaryChunk:null})},parseBufferViewsAsync=function parseBufferViewsAsync(gltf,buffers,options,callback){var result=[],preprocess=options&&options.bufferView&&options.bufferView.preprocess,processAsync=options&&options.bufferView&&options.bufferView.processAsync||function(gltfBufferView,buffers,callback){callback(null,null)},postprocess=options&&options.bufferView&&options.bufferView.postprocess,remaining=gltf.bufferViews?gltf.bufferViews.length:0;if(remaining)for(var onLoad=function onLoad(index,bufferView){var gltfBufferView=gltf.bufferViews[index];gltfBufferView.hasOwnProperty("byteStride")&&(bufferView.byteStride=gltfBufferView.byteStride),result[index]=bufferView,postprocess&&postprocess(gltfBufferView,bufferView),0==--remaining&&callback(null,result)},i=0;i<gltf.bufferViews.length;++i){var gltfBufferView=gltf.bufferViews[i];preprocess&&preprocess(gltfBufferView),processAsync(gltfBufferView,buffers,function(i,gltfBufferView,err,result){if(err)callback(err);else if(result)onLoad(i,result);else{var buffer=buffers[gltfBufferView.buffer],typedArray=new Uint8Array(buffer.buffer,buffer.byteOffset+(gltfBufferView.hasOwnProperty("byteOffset")?gltfBufferView.byteOffset:0),gltfBufferView.byteLength);onLoad(i,typedArray)}}.bind(null,i,gltfBufferView))}else callback(null,null)},GlbParser=function(){function GlbParser(){}return GlbParser.parseAsync=function parseAsync(filename,urlBase,data,device,registry,options,callback){parseChunk(filename,data,(function(err,chunks){err?callback(err):parseGltf(chunks.gltfChunk,(function(err,gltf){err?callback(err):loadBuffersAsync(gltf,chunks.binaryChunk,urlBase,options,(function(err,buffers){err?callback(err):parseBufferViewsAsync(gltf,buffers,options,(function(err,bufferViews){err?callback(err):loadTexturesAsync(gltf,bufferViews,urlBase,registry,options,(function(err,textureAssets){err?callback(err):createResources(device,gltf,bufferViews,textureAssets,options,callback)}))}))}))}))}))},GlbParser.parse=function parse(filename,data,device,options){var result=null;return options=options||{},parseChunk(filename,data,(function(err,chunks){err?console.error(err):parseGltf(chunks.gltfChunk,(function(err,gltf){err?console.error(err):parseBufferViewsAsync(gltf,[chunks.binaryChunk],options,(function(err,bufferViews){err?console.error(err):createResources(device,gltf,bufferViews,[],options,(function(err,result_){err?console.error(err):result=result_}))}))}))})),result},GlbParser.createModel=function createModel(glb,defaultMaterial){for(var createMeshInstance=function createMeshInstance(model,mesh,skins,skinInstances,materials,node,gltfNode){var material=void 0===mesh.materialIndex?defaultMaterial:materials[mesh.materialIndex],meshInstance=new MeshInstance(mesh,material,node);if(mesh.morph){var morphInstance=new MorphInstance(mesh.morph);if(mesh.weights)for(var wi=0;wi<mesh.weights.length;wi++)morphInstance.setWeight(wi,mesh.weights[wi]);meshInstance.morphInstance=morphInstance,model.morphInstances.push(morphInstance)}if(gltfNode.hasOwnProperty("skin")){var skinIndex=gltfNode.skin,skin=skins[skinIndex];mesh.skin=skin;var skinInstance=skinInstances[skinIndex];meshInstance.skinInstance=skinInstance,model.skinInstances.push(skinInstance)}model.meshInstances.push(meshInstance)},model=new Model,skinInstances=[],_iterator=_createForOfIteratorHelperLoose(glb.skins),_step;!(_step=_iterator()).done;){var skin=_step.value,skinInstance=new SkinInstance(skin);skinInstance.bones=skin.bones,skinInstances.push(skinInstance)}if(1===glb.scenes.length)model.graph=glb.scenes[0];else{model.graph=new GraphNode("SceneGroup");for(var _iterator2=_createForOfIteratorHelperLoose(glb.scenes),_step2;!(_step2=_iterator2()).done;){var scene=_step2.value;model.graph.addChild(scene)}}for(var i=0;i<glb.nodes.length;i++){var node=glb.nodes[i];if(node.root===model.graph){var gltfNode=glb.gltf.nodes[i];if(gltfNode.hasOwnProperty("mesh"))for(var meshGroup=glb.renders[gltfNode.mesh].meshes,mi=0;mi<meshGroup.length;mi++){var mesh=meshGroup[mi];mesh&&createMeshInstance(model,mesh,glb.skins,skinInstances,glb.materials,node,gltfNode)}}}return model},GlbParser}(),AnimationHandler=function(){function AnimationHandler(){this.maxRetries=0}var _proto=AnimationHandler.prototype;return _proto.load=function load(url,callback){"string"==typeof url&&(url={load:url,original:url});var options={retry:this.maxRetries>0,maxRetries:this.maxRetries};(url.load.startsWith("blob:")||url.load.startsWith("data:"))&&(".glb"===path.getExtension(url.original).toLowerCase()?options.responseType=Http.ResponseType.ARRAY_BUFFER:options.responseType=Http.ResponseType.JSON),http.get(url.load,options,(function(err,response){err?callback("Error loading animation resource: "+url.original+" ["+err+"]"):callback(null,response)}))},_proto.open=function open(url,data){if(".glb"===path.getExtension(url).toLowerCase()){var glb=GlbParser.parse("filename.glb",data,null);return glb?glb.animations:null}return this["_parseAnimationV"+data.animation.version](data)},_proto._parseAnimationV3=function _parseAnimationV3(data){var animData=data.animation,anim=new Animation;anim.name=animData.name,anim.duration=animData.duration;for(var i=0;i<animData.nodes.length;i++){var node=new Node,n=animData.nodes[i];node._name=n.name;for(var j=0;j<n.keys.length;j++){var k=n.keys[j],t=k.time,p=k.pos,r=k.rot,s=k.scale,pos=new Vec3(p[0],p[1],p[2]),rot=(new Quat).setFromEulerAngles(r[0],r[1],r[2]),scl=new Vec3(s[0],s[1],s[2]),key=new Key(t,pos,rot,scl);node._keys.push(key)}anim.addNode(node)}return anim},_proto._parseAnimationV4=function _parseAnimationV4(data){var animData=data.animation,anim=new Animation;anim.name=animData.name,anim.duration=animData.duration;for(var i=0;i<animData.nodes.length;i++){var node=new Node,n=animData.nodes[i];node._name=n.name;for(var defPos=n.defaults.p,defRot=n.defaults.r,defScl=n.defaults.s,j=0;j<n.keys.length;j++){var k=n.keys[j],t=k.t,p=defPos||k.p,r=defRot||k.r,s=defScl||k.s,pos=new Vec3(p[0],p[1],p[2]),rot=(new Quat).setFromEulerAngles(r[0],r[1],r[2]),scl=new Vec3(s[0],s[1],s[2]),key=new Key(t,pos,rot,scl);node._keys.push(key)}anim.addNode(node)}return anim},AnimationHandler}(),AnimClipHandler=function(){function AnimClipHandler(){this.maxRetries=0}var _proto=AnimClipHandler.prototype;return _proto.load=function load(url,callback){"string"==typeof url&&(url={load:url,original:url});var options={retry:this.maxRetries>0,maxRetries:this.maxRetries};url.load.startsWith("blob:")&&(options.responseType=Http.ResponseType.JSON),http.get(url.load,options,(function(err,response){err?callback("Error loading animation clip resource: "+url.original+" ["+err+"]"):callback(null,response)}))},_proto.open=function open(url,data){var name=data.name,duration=data.duration,inputs=data.inputs.map((function(input){return new AnimData(1,input)})),outputs=data.outputs.map((function(output){return new AnimData(output.components,output.data)})),curves=data.curves.map((function(curve){return new AnimCurve([curve.path],curve.inputIndex,curve.outputIndex,curve.interpolation)}));return new AnimTrack(name,duration,inputs,outputs,curves)},AnimClipHandler}(),AnimStateGraph=function(){function AnimStateGraph(data){var i;if(this._layers=[],this._parameters={},Array.isArray(data.layers))this._layers=data.layers;else for(var layerId in data.layers){var dataLayer=data.layers[layerId],layer={name:dataLayer.name,states:[],transitions:[]};for(i=0;i<dataLayer.states.length;i++)layer.states.push(data.states[dataLayer.states[i]]);for(i=0;i<dataLayer.transitions.length;i++){var dataLayerTransition=data.transitions[dataLayer.transitions[i]];if(dataLayerTransition.conditions&&!Array.isArray(dataLayerTransition.conditions)){for(var conditionKeys=Object.keys(dataLayerTransition.conditions),conditions=[],j=0;j<conditionKeys.length;j++){var condition=dataLayerTransition.conditions[conditionKeys[j]];condition.parameterName&&conditions.push(condition)}dataLayerTransition.conditions=conditions}Number.isInteger(dataLayerTransition.from)&&(dataLayerTransition.from=data.states[dataLayerTransition.from].name),Number.isInteger(dataLayerTransition.to)&&(dataLayerTransition.to=data.states[dataLayerTransition.to].name),layer.transitions.push(dataLayerTransition)}this._layers.push(layer)}for(var paramId in data.parameters){var param=data.parameters[paramId];this._parameters[param.name]={type:param.type,value:param.value}}}return _createClass(AnimStateGraph,[{key:"parameters",get:function get(){return Object.assign({},this._parameters)}},{key:"layers",get:function get(){return this._layers}}]),AnimStateGraph}(),AnimStateGraphHandler=function(){function AnimStateGraphHandler(){this.maxRetries=0}var _proto=AnimStateGraphHandler.prototype;return _proto.load=function load(url,callback){"string"==typeof url&&(url={load:url,original:url});var options={retry:this.maxRetries>0,maxRetries:this.maxRetries};url.load.startsWith("blob:")&&(options.responseType=Http.ResponseType.JSON),http.get(url.load,options,(function(err,response){err?callback("Error loading animation state graph resource: "+url.original+" ["+err+"]"):callback(null,response)}))},_proto.open=function open(url,data){return new AnimStateGraph(data)},AnimStateGraphHandler}(),Sound=function(){function Sound(resource){resource instanceof Audio?this.audio=resource:this.buffer=resource}return _createClass(Sound,[{key:"duration",get:function get(){var duration=0;return this.buffer?duration=this.buffer.duration:this.audio&&(duration=this.audio.duration),duration||0}}]),Sound}(),ie=function(){if("undefined"==typeof window)return!1;var ua=window.navigator.userAgent,msie=ua.indexOf("MSIE "),trident;if(msie>0)return parseInt(ua.substring(msie+5,ua.indexOf(".",msie)),10);if(ua.indexOf("Trident/")>0){var rv=ua.indexOf("rv:");return parseInt(ua.substring(rv+3,ua.indexOf(".",rv)),10)}return!1}(),toMIME={".ogg":"audio/ogg",".mp3":"audio/mpeg",".wav":"audio/x-wav",".mp4a":"audio/mp4",".m4a":"audio/mp4",".mp4":"audio/mp4",".aac":"audio/aac"},AudioHandler=function(){function AudioHandler(manager){this.manager=manager,this.maxRetries=0}var _proto=AudioHandler.prototype;return _proto._isSupported=function _isSupported(url){var ext=path.getExtension(url);return!!toMIME[ext]},_proto.load=function load(url,callback){"string"==typeof url&&(url={load:url,original:url});var success=function success(resource){callback(null,new Sound(resource))},error=function error(err){var msg="Error loading audio url: "+url.original;err&&(msg+=": "+(err.message||err)),console.warn(msg),callback(msg)};if(this._createSound){if(!this._isSupported(url.original))return void error("Audio format for "+url.original+" not supported");this._createSound(url.load,success,error)}else error(null)},_proto.open=function open(url,data){return data},_proto._createSound=function _createSound(url,success,error){if(hasAudioContext()){var manager=this.manager;if(!manager.context)return void error("Audio manager has no audio context");var options={retry:this.maxRetries>0,maxRetries:this.maxRetries};(url.startsWith("blob:")||url.startsWith("data:"))&&(options.responseType=Http.ResponseType.ARRAY_BUFFER),http.get(url,options,(function(err,response){err?error(err):manager.context.decodeAudioData(response,success,error)}))}else{var audio=null;try{audio=new Audio}catch(e){return void error("No support for Audio element")}ie&&document.body.appendChild(audio);var onReady=function onReady(){audio.removeEventListener("canplaythrough",onReady),ie&&document.body.removeChild(audio),success(audio)};audio.onerror=function(){audio.onerror=null,ie&&document.body.removeChild(audio),error()},audio.addEventListener("canplaythrough",onReady),audio.src=url}},AudioHandler}(),BinaryHandler=function(){function BinaryHandler(){this.maxRetries=0}var _proto=BinaryHandler.prototype;return _proto.load=function load(url,callback){"string"==typeof url&&(url={load:url,original:url}),http.get(url.load,{responseType:Http.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(err,response){err?callback("Error loading binary resource: "+url.original+" ["+err+"]"):callback(null,response)}))},_proto.open=function open(url,data){return data},_proto.patch=function patch(asset,assets){},BinaryHandler}(),Bundle=function(){function Bundle(files){this._blobUrls={};for(var i=0,len=files.length;i<len;i++)files[i].url&&(this._blobUrls[files[i].name]=files[i].url)}var _proto=Bundle.prototype;return _proto.hasBlobUrl=function hasBlobUrl(url){return!!this._blobUrls[url]},_proto.getBlobUrl=function getBlobUrl(url){return this._blobUrls[url]},_proto.destroy=function destroy(){for(var key in this._blobUrls)URL.revokeObjectURL(this._blobUrls[key]);this._blobUrls=null},Bundle}(),Untar;function UntarScope(isWorker){var utfDecoder,asciiDecoder;function PaxHeader(fields){this._fields=fields}function UntarInternal(arrayBuffer){this._arrayBuffer=arrayBuffer||new ArrayBuffer(0),this._bufferView=new DataView(this._arrayBuffer),this._globalPaxHeader=null,this._paxHeader=null,this._bytesRead=0}"undefined"!=typeof TextDecoder?(utfDecoder=new TextDecoder("utf-8"),asciiDecoder=new TextDecoder("windows-1252")):console.warn("TextDecoder not supported - pc.Untar module will not work"),PaxHeader.parse=function(buffer,start,length){for(var paxArray=new Uint8Array(buffer,start,length),bytesRead=0,fields=[];bytesRead<length;){var spaceIndex=void 0;for(spaceIndex=bytesRead;spaceIndex<length&&32!==paxArray[spaceIndex];spaceIndex++);if(spaceIndex>=length)throw new Error("Invalid PAX header data format.");var fieldLength=parseInt(utfDecoder.decode(new Uint8Array(buffer,start+bytesRead,spaceIndex-bytesRead)),10),fieldText,field=utfDecoder.decode(new Uint8Array(buffer,start+spaceIndex+1,fieldLength-(spaceIndex-bytesRead)-2)).split("=");if(2!==field.length)throw new Error("Invalid PAX header data format.");0===field[1].length&&(field[1]=null),fields.push({name:field[0],value:field[1]}),bytesRead+=fieldLength}return new PaxHeader(fields)},PaxHeader.prototype.applyHeader=function(file){for(var i=0;i<this._fields.length;i++){var fieldName=this._fields[i].name,fieldValue=this._fields[i].value;"path"===fieldName&&(fieldName="name"),null===fieldValue?delete file[fieldName]:file[fieldName]=fieldValue}},isWorker||(Untar=UntarInternal),UntarInternal.prototype._hasNext=function(){return this._bytesRead+4<this._arrayBuffer.byteLength&&0!==this._bufferView.getUint32(this._bytesRead)},UntarInternal.prototype._readNextFile=function(){var headersDataView=new DataView(this._arrayBuffer,this._bytesRead,512),headers=asciiDecoder.decode(headersDataView);this._bytesRead+=512;var name=headers.substr(0,100).replace(/\0/g,""),ustarFormat=headers.substr(257,6),size=parseInt(headers.substr(124,12),8),type=headers.substr(156,1),start=this._bytesRead,url=null,normalFile=!1;switch(type){case"0":case"":if(normalFile=!0,!isWorker){var blob=new Blob([this._arrayBuffer.slice(this._bytesRead,this._bytesRead+size)]);url=URL.createObjectURL(blob)}break;case"g":this._globalPaxHeader=PaxHeader.parse(this._arrayBuffer,this._bytesRead,size);break;case"x":this._paxHeader=PaxHeader.parse(this._arrayBuffer,this._bytesRead,size)}this._bytesRead+=size;var remainder=size%512;if(0!==remainder&&(this._bytesRead+=512-remainder),!normalFile)return null;if(-1!==ustarFormat.indexOf("ustar")){var namePrefix=headers.substr(345,155).replace(/\0/g,"");namePrefix.length>0&&(name=namePrefix.trim()+name.trim())}var file={name:name,start:start,size:size,url:url};return this._globalPaxHeader&&this._globalPaxHeader.applyHeader(file),this._paxHeader&&(this._paxHeader.applyHeader(file),this._paxHeader=null),file},UntarInternal.prototype.untar=function(filenamePrefix){if(!utfDecoder)return console.error("Cannot untar because TextDecoder interface is not available for this platform."),[];for(var files=[];this._hasNext();){var file=this._readNextFile();file&&(filenamePrefix&&file.name&&(file.name=filenamePrefix+file.name),files.push(file))}return files},isWorker&&(self.onmessage=function(e){var id=e.data.id;try{var archive,files=new UntarInternal(e.data.arrayBuffer).untar(e.data.prefix);postMessage({id:id,files:files,arrayBuffer:e.data.arrayBuffer},[e.data.arrayBuffer])}catch(err){postMessage({id:id,error:err.toString()})}})}var workerUrl=null;function getWorkerUrl(){if(!workerUrl){var code="("+UntarScope.toString()+")(true)\n\n",blob=new Blob([code],{type:"application/javascript"});workerUrl=URL.createObjectURL(blob)}return workerUrl}var UntarWorker=function(){function UntarWorker(filenamePrefix){this._requestId=0,this._pendingRequests={},this._filenamePrefix=filenamePrefix,this._worker=new Worker(getWorkerUrl()),this._worker.addEventListener("message",this._onMessage.bind(this))}var _proto=UntarWorker.prototype;return _proto._onMessage=function _onMessage(e){var id=e.data.id;if(this._pendingRequests[id]){var callback=this._pendingRequests[id];if(delete this._pendingRequests[id],e.data.error)callback(e.data.error);else{for(var arrayBuffer=e.data.arrayBuffer,i=0,len=e.data.files.length;i<len;i++){var file=e.data.files[i],blob=new Blob([arrayBuffer.slice(file.start,file.start+file.size)]);file.url=URL.createObjectURL(blob)}callback(null,e.data.files)}}},_proto.untar=function untar(arrayBuffer,callback){var id=this._requestId++;this._pendingRequests[id]=callback,this._worker.postMessage({id:id,prefix:this._filenamePrefix,arrayBuffer:arrayBuffer},[arrayBuffer])},_proto.hasPendingRequests=function hasPendingRequests(){for(var key in this._pendingRequests)return!0;return!1},_proto.destroy=function destroy(){this._worker&&(this._worker.terminate(),this._worker=null,this._pendingRequests=null)},UntarWorker}();UntarScope();var BundleHandler=function(){function BundleHandler(assets){this._assets=assets,this._worker=null,this.maxRetries=0}var _proto=BundleHandler.prototype;return _proto.load=function load(url,callback){"string"==typeof url&&(url={load:url,original:url});var self=this;http.get(url.load,{responseType:Http.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(err,response){if(err)callback("Error loading bundle resource "+url.original+": "+err);else try{self._untar(response,callback)}catch(ex){callback("Error loading bundle resource "+url.original+": "+ex)}}))},_proto._untar=function _untar(response,callback){var self=this;if(platform.workers)self._worker||(self._worker=new UntarWorker(self._assets.prefix)),self._worker.untar(response,(function(err,files){callback(err,files),self._worker.hasPendingRequests()||(self._worker.destroy(),self._worker=null)}));else{var archive,files=new Untar(response).untar(self._assets.prefix);callback(null,files)}},_proto.open=function open(url,data){return new Bundle(data)},_proto.patch=function patch(asset,assets){},BundleHandler}(),ContainerResource=function(){function ContainerResource(data){this.data=data,this.model=null,this.renders=[],this.materials=[],this.textures=[],this.animations=[],this.registry=null}var _proto=ContainerResource.prototype;return _proto.instantiateModelEntity=function instantiateModelEntity(options){var entity=new Entity;return entity.addComponent("model",Object.assign({type:"asset",asset:this.model},options)),entity},_proto.instantiateRenderEntity=function instantiateRenderEntity(options){for(var cloneToEntity=function cloneToEntity(skinInstances,model,node){if(node){var _entity=new Entity;node._cloneInternal(_entity);for(var attachedMi=null,m=0;m<model.meshInstances.length;m++){var mi=model.meshInstances[m];if(mi.node===node){var cloneMi=new MeshInstance(mi.mesh,mi.material,_entity);mi.morphInstance&&(cloneMi.morphInstance=mi.morphInstance.clone()),mi.skinInstance&&skinInstances.push({src:mi.skinInstance,dst:cloneMi}),attachedMi||(attachedMi=[]),attachedMi.push(cloneMi)}}attachedMi&&(_entity.addComponent("render",Object.assign({type:"asset"},options)),_entity.render.meshInstances=attachedMi);for(var children=node.children,i=0;i<children.length;i++){var childClone=cloneToEntity(skinInstances,model,children[i]);_entity.addChild(childClone)}return _entity}return null},skinInstances=[],entity=cloneToEntity(skinInstances,this.model.resource,this.model.resource.graph),i=0;i<skinInstances.length;i++){for(var srcSkinInstance=skinInstances[i].src,dstMeshInstance=skinInstances[i].dst,skin=srcSkinInstance.skin,cloneSkinInstance=new SkinInstance(skin),bones=[],j=0;j<skin.boneNames.length;j++){var boneName=skin.boneNames[j],bone=entity.findByName(boneName);bones.push(bone)}cloneSkinInstance.bones=bones,dstMeshInstance.skinInstance=cloneSkinInstance}return entity},_proto.destroy=function destroy(){var registry=this.registry,destroyAsset=function destroyAsset(asset){registry.remove(asset),asset.unload()},destroyAssets=function destroyAssets(assets){assets.forEach((function(asset){destroyAsset(asset)}))};this.animations&&(destroyAssets(this.animations),this.animations=null),this.textures&&(destroyAssets(this.textures),this.textures=null),this.materials&&(destroyAssets(this.materials),this.materials=null),this.renders&&(destroyAssets(this.renders),this.renders=null),this.model&&(destroyAsset(this.model),this.model=null),this.data=null,this.assets=null},ContainerResource}(),ContainerHandler=function(){function ContainerHandler(device,defaultMaterial){this._device=device,this._defaultMaterial=defaultMaterial,this.maxRetries=0}var _proto2=ContainerHandler.prototype;return _proto2._getUrlWithoutParams=function _getUrlWithoutParams(url){return url.indexOf("?")>=0?url.split("?")[0]:url},_proto2.load=function load(url,callback,asset){"string"==typeof url&&(url={load:url,original:url});var options={responseType:Http.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries},self=this,parseData=function parseData(arrayBuffer){GlbParser.parseAsync(self._getUrlWithoutParams(url.original),path.extractPath(url.load),arrayBuffer,self._device,asset.registry,asset.options,(function(err,result){err?callback(err):callback(null,new ContainerResource(result))}))};asset&&asset.file&&asset.file.contents?parseData(asset.file.contents):http.get(url.load,options,(function(err,response){callback&&(err?callback("Error loading model: "+url.original+" ["+err+"]"):parseData(response))}))},_proto2.open=function open(url,data,asset){return data},_proto2.patch=function patch(asset,assets){var container=asset.resource,data=container&&container.data;if(data){var createAsset=function createAsset(type,resource,index){var subAsset=new Asset(asset.name+"/"+type+"/"+index,type,{url:""});return subAsset.resource=resource,subAsset.loaded=!0,assets.add(subAsset),subAsset},i,model=createAsset("model",GlbParser.createModel(data,this._defaultMaterial),0),renders=[];for(i=0;i<data.renders.length;++i)renders.push(createAsset("render",data.renders[i],i));var materials=[];for(i=0;i<data.materials.length;++i)materials.push(createAsset("material",data.materials[i],i));var animations=[];for(i=0;i<data.animations.length;++i)animations.push(createAsset("animation",data.animations[i],i));container.data=null,container.model=model,container.renders=renders,container.materials=materials,container.textures=data.textures,container.animations=animations,container.registry=assets}},ContainerHandler}(),CssHandler=function(){function CssHandler(){this.maxRetries=0}var _proto=CssHandler.prototype;return _proto.load=function load(url,callback){"string"==typeof url&&(url={load:url,original:url}),http.get(url.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(err,response){err?callback("Error loading css resource: "+url.original+" ["+err+"]"):callback(null,response)}))},_proto.open=function open(url,data){return data},_proto.patch=function patch(asset,assets){},CssHandler}();function createStyle(cssString){var result=document.createElement("style");return result.type="text/css",result.styleSheet?result.styleSheet.cssText=cssString:result.appendChild(document.createTextNode(cssString)),result}var CubemapHandler=function(){function CubemapHandler(device,assets,loader){this._device=device,this._registry=assets,this._loader=loader}var _proto=CubemapHandler.prototype;return _proto.load=function load(url,callback,asset){this.loadAssets(asset,callback)},_proto.open=function open(url,data,asset){return asset?asset.resource:null},_proto.patch=function patch(asset,registry){this.loadAssets(asset,(function(err,result){err&&(registry.fire("error",asset),registry.fire("error:"+asset.id,err,asset),asset.fire("error",asset))}))},_proto.getAssetIds=function getAssetIds(cubemapAsset){var result=[];if(result[0]=cubemapAsset.file,(cubemapAsset.loadFaces||!cubemapAsset.file)&&cubemapAsset.data&&cubemapAsset.data.textures)for(var i=0;i<6;++i)result[i+1]=cubemapAsset.data.textures[i];else result[1]=result[2]=result[3]=result[4]=result[5]=result[6]=null;return result},_proto.compareAssetIds=function compareAssetIds(assetIdA,assetIdB){return assetIdA&&assetIdB?parseInt(assetIdA,10)===assetIdA||"string"==typeof assetIdA?assetIdA===assetIdB:assetIdA.url===assetIdB.url:null!==assetIdA==(null!==assetIdB)},_proto.update=function update(cubemapAsset,assetIds,assets){var assetData=cubemapAsset.data||{},oldAssets=cubemapAsset._handlerState.assets,oldResources=cubemapAsset._resources,tex,mip,i,resources=[null,null,null,null,null,null,null],getType=function getType(){return assetData.hasOwnProperty("type")?assetData.type:assetData.hasOwnProperty("rgbm")?assetData.rgbm?"rgbm":"default":null};if(cubemapAsset.loaded&&assets[0]===oldAssets[0])resources[1]=oldResources[1]||null,resources[2]=oldResources[2]||null,resources[3]=oldResources[3]||null,resources[4]=oldResources[4]||null,resources[5]=oldResources[5]||null,resources[6]=oldResources[6]||null;else if(assets[0])for(tex=assets[0].resource,i=0;i<6;++i){var prelitLevels=[tex._levels[i]];if(0===i&&this._device.useTexCubeLod)for(mip=1;mip<tex._levels.length;++mip)prelitLevels[mip]=tex._levels[mip];var prelit=new Texture(this._device,{name:cubemapAsset.name+"_prelitCubemap"+(tex.width>>i),cubemap:!0,type:getType()||tex.type,width:tex.width>>i,height:tex.height>>i,format:tex.format,levels:prelitLevels,fixCubemapSeams:!0,addressU:1,addressV:1});resources[i+1]=prelit}var faceAssets=assets.slice(1);if(cubemapAsset.loaded&&this.cmpArrays(faceAssets,oldAssets.slice(1)))resources[0]=oldResources[0]||null;else if(-1===faceAssets.indexOf(null)){var faceTextures=faceAssets.map((function(asset){return asset.resource})),faceLevels=[];for(mip=0;mip<faceTextures[0]._levels.length;++mip)faceLevels.push(faceTextures.map((function(faceTexture){return faceTexture._levels[mip]})));var faces=new Texture(this._device,{name:cubemapAsset.name+"_faces",cubemap:!0,type:getType()||faceTextures[0].type,width:faceTextures[0].width,height:faceTextures[0].height,format:faceTextures[0].format,levels:faceLevels,minFilter:assetData.hasOwnProperty("minFilter")?assetData.minFilter:faceTextures[0].minFilter,magFilter:assetData.hasOwnProperty("magFilter")?assetData.magFilter:faceTextures[0].magFilter,anisotropy:assetData.hasOwnProperty("anisotropy")?assetData.anisotropy:1,addressU:1,addressV:1,fixCubemapSeams:!!assets[0]});resources[0]=faces}if(!this.cmpArrays(resources,oldResources))for(cubemapAsset.resources=resources,cubemapAsset._handlerState.assetIds=assetIds,cubemapAsset._handlerState.assets=assets,i=0;i<oldResources.length;++i)null!==oldResources[i]&&-1===resources.indexOf(oldResources[i])&&oldResources[i].destroy();for(i=0;i<oldAssets.length;++i)null!==oldAssets[i]&&-1===assets.indexOf(oldAssets[i])&&oldAssets[i].unload()},_proto.cmpArrays=function cmpArrays(arr1,arr2){if(arr1.length!==arr2.length)return!1;for(var i=0;i<arr1.length;++i)if(arr1[i]!==arr2[i])return!1;return!0},_proto.resolveId=function resolveId(value){var valueInt=parseInt(value,10);return valueInt===value||valueInt.toString()===value?valueInt:value},_proto.loadAssets=function loadAssets(cubemapAsset,callback){cubemapAsset.hasOwnProperty("_handlerState")||(cubemapAsset._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]});for(var self=this,assetIds=self.getAssetIds(cubemapAsset),assets=[null,null,null,null,null,null,null],loadedAssetIds=cubemapAsset._handlerState.assetIds,loadedAssets=cubemapAsset._handlerState.assets,registry=self._registry,awaiting=7,onReady=function onReady(index,asset){assets[index]=asset,0===--awaiting&&(self.update(cubemapAsset,assetIds,assets),callback(null,cubemapAsset.resources))},onLoad=function onLoad(index,asset){var level0=asset&&asset.resource&&asset.resource._levels[0];level0&&"undefined"!=typeof ImageBitmap&&level0 instanceof ImageBitmap?createImageBitmap(level0,{premultiplyAlpha:"none",imageOrientation:"flipY"}).then((function(imageBitmap){asset.resource._levels[0]=imageBitmap,onReady(index,asset)})).catch((function(e){callback(e)})):onReady(index,asset)},onError=function onError(index,err,asset){callback(err)},processTexAsset=function processTexAsset(index,texAsset){texAsset.loaded?onLoad(index,texAsset):(registry.once("load:"+texAsset.id,onLoad.bind(self,index)),registry.once("error:"+texAsset.id,onError.bind(self,index)),texAsset.loading||registry.load(texAsset))},texAsset,i=0;i<7;++i){var assetId=this.resolveId(assetIds[i]);if(assetId)if(self.compareAssetIds(assetId,loadedAssetIds[i]))onReady(i,loadedAssets[i]);else if(parseInt(assetId,10)===assetId)(texAsset=registry.get(assetId))?processTexAsset(i,texAsset):setTimeout(function(index,assetId_){var texAsset=registry.get(assetId_);texAsset?processTexAsset(index,texAsset):onError(index,"failed to find dependent cubemap asset="+assetId_)}.bind(null,i,assetId));else{var file="string"==typeof assetId?{url:assetId,filename:assetId}:assetId;texAsset=new Asset(cubemapAsset.name+"_part_"+i,"texture",file),registry.add(texAsset),registry.once("load:"+texAsset.id,onLoad.bind(self,i)),registry.once("error:"+texAsset.id,onError.bind(self,i)),registry.load(texAsset)}else onReady(i,null)}},CubemapHandler}(),FolderHandler=function(){function FolderHandler(){}var _proto=FolderHandler.prototype;return _proto.load=function load(url,callback){callback(null,null)},_proto.open=function open(url,data){return data},FolderHandler}(),FONT_MSDF="msdf",FONT_BITMAP="bitmap",Font=function(){function Font(textures,data){this.type=data&&data.type||"msdf",this.em=1,this.textures=textures,this.intensity=0,this._data=null,this.data=data}return _createClass(Font,[{key:"data",get:function get(){return this._data},set:function set(value){if(this._data=value,value&&(void 0!==this._data.intensity&&(this.intensity=this._data.intensity),this._data.info||(this._data.info={}),(!this._data.version||this._data.version<2)&&(this._data.info.maps=[{width:this._data.info.width,height:this._data.info.height}],this._data.chars)))for(var key in this._data.chars)this._data.chars[key].map=0}}]),Font}();function upgradeDataSchema(data){return data.version<3&&(data.version<2&&(data.info.maps=data.info.maps||[{width:data.info.width,height:data.info.height}]),data.chars=Object.keys(data.chars||{}).reduce((function(newChars,key){var existing=data.chars[key],newKey=void 0!==existing.letter?existing.letter:string.fromCodePoint(key);return data.version<2&&(existing.map=existing.map||0),newChars[newKey]=existing,newChars}),{}),data.version=3),data}var FontHandler=function(){function FontHandler(loader){this._loader=loader,this.maxRetries=0}var _proto=FontHandler.prototype;return _proto.load=function load(url,callback,asset){"string"==typeof url&&(url={load:url,original:url});var self=this;".json"===path.getExtension(url.original)?http.get(url.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(err,response){if(err)callback("Error loading font resource: "+url.original+" ["+err+"]");else{var data=upgradeDataSchema(response);self._loadTextures(url.load.replace(".json",".png"),data,(function(err,textures){if(err)return callback(err);callback(null,{data:data,textures:textures})}))}})):(asset&&asset.data&&(asset.data=upgradeDataSchema(asset.data)),this._loadTextures(url.load,asset&&asset.data,callback))},_proto._loadTextures=function _loadTextures(url,data,callback){for(var numTextures=data.info.maps.length,numLoaded=0,error=null,textures=new Array(numTextures),loader=this._loader,loadTexture=function loadTexture(index){var onLoaded=function onLoaded(err,texture){if(!error){if(err)return error=err,callback(err);texture.upload(),textures[index]=texture,++numLoaded===numTextures&&callback(null,textures)}};0===index?loader.load(url,"texture",onLoaded):loader.load(url.replace(".png",index+".png"),"texture",onLoaded)},i=0;i<numTextures;i++)loadTexture(i)},_proto.open=function open(url,data,asset){var font;return font=data.textures?new Font(data.textures,data.data):new Font(data,null)},_proto.patch=function patch(asset,assets){var font=asset.resource;!font.data&&asset.data?font.data=asset.data:!asset.data&&font.data&&(asset.data=font.data),asset.data&&(asset.data=upgradeDataSchema(asset.data))},FontHandler}(),CompressUtils_setCompressedPRS=function setCompressedPRS(entity,data,compressed){var a=compressed.singleVecs,b,i,v=data.___1;v||(b=compressed.tripleVecs,i=data.___2);var n=v?v[0]:b[i];entity.setLocalPosition(a[n],a[n+1],a[n+2]),n=v?v[1]:b[i+1],entity.setLocalEulerAngles(a[n],a[n+1],a[n+2]),n=v?v[2]:b[i+2],entity.setLocalScale(a[n],a[n+1],a[n+2])},CompressUtils_oneCharToKey=function oneCharToKey(s,data){var i=s.charCodeAt(0)-data.fieldFirstCode;return data.fieldArray[i]},CompressUtils_multCharToKey=function multCharToKey(s,data){for(var ind=0,i=0;i<s.length;i++)ind=ind*data.fieldCodeBase+s.charCodeAt(i)-data.fieldFirstCode;return data.fieldArray[ind]},Decompress=function(){function Decompress(node,data){this._node=node,this._data=data}var _proto=Decompress.prototype;return _proto.run=function run(){var type=Object.prototype.toString.call(this._node);return"[object Object]"===type?this._handleMap():"[object Array]"===type?this._handleArray():this._result=this._node,this._result},_proto._handleMap=function _handleMap(){var a;this._result={},Object.keys(this._node).forEach(this._handleKey,this)},_proto._handleKey=function _handleKey(origKey){var newKey=origKey,len=origKey.length;1===len?newKey=CompressUtils_oneCharToKey(origKey,this._data):2===len&&(newKey=CompressUtils_multCharToKey(origKey,this._data)),this._result[newKey]=new Decompress(this._node[origKey],this._data).run()},_proto._handleArray=function _handleArray(){this._result=[],this._node.forEach(this._handleArElt,this)},_proto._handleArElt=function _handleArElt(elt){var v=new Decompress(elt,this._data).run();this._result.push(v)},Decompress}(),SceneParser=function(){function SceneParser(app,isTemplate){this._app=app,this._isTemplate=isTemplate}var _proto=SceneParser.prototype;return _proto.parse=function parse(data){var entities={},parent=null,compressed=data.compressedFormat;for(var id in compressed&&!data.entDecompressed&&(data.entDecompressed=!0,data.entities=new Decompress(data.entities,compressed).run()),data.entities){var curData=data.entities[id],curEnt=this._createEntity(curData,compressed);entities[id]=curEnt,null===curData.parent&&(parent=curEnt)}for(var _id in data.entities)for(var _curEnt=entities[_id],children=data.entities[_id].children,len=children.length,i=0;i<len;i++){var childEnt=entities[children[i]];childEnt&&_curEnt.addChild(childEnt)}return this._openComponentData(parent,data.entities),parent},_proto._createEntity=function _createEntity(data,compressed){var entity=new Entity;if(entity.name=data.name,entity.setGuid(data.resource_id),this._setPosRotScale(entity,data,compressed),entity._enabled=void 0===data.enabled||data.enabled,this._isTemplate?entity._template=!0:entity._enabledInHierarchy=entity._enabled,entity.template=data.template,data.tags)for(var i=0;i<data.tags.length;i++)entity.tags.add(data.tags[i]);return data.labels&&data.labels.forEach((function(label){entity.addLabel(label)})),entity},_proto._setPosRotScale=function _setPosRotScale(entity,data,compressed){if(compressed)CompressUtils_setCompressedPRS(entity,data,compressed);else{var p=data.position,r=data.rotation,s=data.scale;entity.setLocalPosition(p[0],p[1],p[2]),entity.setLocalEulerAngles(r[0],r[1],r[2]),entity.setLocalScale(s[0],s[1],s[2])}},_proto._openComponentData=function _openComponentData(entity,entities){for(var systemsList=this._app.systems.list,len=systemsList.length,entityData=entities[entity.getGuid()],i=0;i<len;i++){var system=systemsList[i],componentData=entityData.components[system.id];componentData&&system.addComponent(entity,componentData)}len=entityData.children.length;for(var children=entity._children,_i=0;_i<len;_i++)children[_i]=this._openComponentData(children[_i],entities);return entity},SceneParser}(),SceneUtils={load:function load(url,callback){"string"==typeof url&&(url={load:url,original:url}),http.get(url.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(err,response){if(err){var errMsg="Error while loading scene JSON "+url.original;err.message?(errMsg+=": "+err.message,err.stack&&(errMsg+="\n"+err.stack)):errMsg+=": "+err,callback(errMsg)}else callback(err,response)}))}},HierarchyHandler=function(){function HierarchyHandler(app){this._app=app,this.maxRetries=0}var _proto=HierarchyHandler.prototype;return _proto.load=function load(url,callback){SceneUtils.load(url,callback)},_proto.open=function open(url,data){this._app.systems.script.preloading=!0;var parser,parent=new SceneParser(this._app,!1).parse(data);return this._app.systems.script.preloading=!1,parent},HierarchyHandler}(),HtmlHandler=function(){function HtmlHandler(){this.maxRetries=0}var _proto=HtmlHandler.prototype;return _proto.load=function load(url,callback){"string"==typeof url&&(url={load:url,original:url}),http.get(url.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(err,response){err?callback("Error loading html resource: "+url.original+" ["+err+"]"):callback(null,response)}))},_proto.open=function open(url,data){return data},_proto.patch=function patch(asset,assets){},HtmlHandler}(),JsonHandler=function(){function JsonHandler(){this.maxRetries=0}var _proto=JsonHandler.prototype;return _proto.load=function load(url,callback){"string"==typeof url&&(url={load:url,original:url});var options={retry:this.maxRetries>0,maxRetries:this.maxRetries};url.load.startsWith("blob:")&&(options.responseType=Http.ResponseType.JSON),http.get(url.load,options,(function(err,response){err?callback("Error loading JSON resource: "+url.original+" ["+err+"]"):callback(null,response)}))},_proto.open=function open(url,data){return data},_proto.patch=function patch(asset,assets){},JsonHandler}(),AssetReference=function(){function AssetReference(propertyName,parent,registry,callbacks,scope){this.propertyName=propertyName,this.parent=parent,this._scope=scope,this._registry=registry,this.id=null,this.url=null,this.asset=null,this._onAssetLoad=callbacks.load,this._onAssetAdd=callbacks.add,this._onAssetRemove=callbacks.remove,this._onAssetUnload=callbacks.unload}var _proto=AssetReference.prototype;return _proto._bind=function _bind(){this.id&&(this._onAssetLoad&&this._registry.on("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:"+this.id,this._onRemove,this),this._onAssetUnload&&this._registry.on("unload:"+this.id,this._onUnload,this)),this.url&&(this._onAssetLoad&&this._registry.on("load:url:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:url:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:url:"+this.url,this._onRemove,this))},_proto._unbind=function _unbind(){this.id&&(this._onAssetLoad&&this._registry.off("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.id,this._onRemove,this),this._onAssetUnload&&this._registry.off("unload:"+this.id,this._onUnload,this)),this.url&&(this._onAssetLoad&&this._registry.off("load:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.url,this._onRemove,this))},_proto._onLoad=function _onLoad(asset){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,asset)},_proto._onAdd=function _onAdd(asset){this.asset=asset,this._onAssetAdd.call(this._scope,this.propertyName,this.parent,asset)},_proto._onRemove=function _onRemove(asset){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,asset),this.asset=null},_proto._onUnload=function _onUnload(asset){this._onAssetUnload.call(this._scope,this.propertyName,this.parent,asset)},_createClass(AssetReference,[{key:"id",get:function get(){return this._id},set:function set(value){if(this.url)throw Error("Can't set id and url");this._unbind(),this._id=value,this.asset=this._registry.get(this._id),this._bind()}},{key:"url",get:function get(){return this._url},set:function set(value){if(this.id)throw Error("Can't set id and url");this._unbind(),this._url=value,this.asset=this._registry.getByUrl(this._url),this._bind()}}]),AssetReference}();function StandardMaterialValidator(){this.removeInvalid=!0,this.valid=!0,this.enumValidators={occludeSpecular:this._createEnumValidator([0,1,2]),cull:this._createEnumValidator([0,1,2,3]),blendType:this._createEnumValidator([0,1,2,3,4,5,6,7,8,9,10]),shadingModel:this._createEnumValidator([0,1])}}StandardMaterialValidator.prototype.setInvalid=function(key,data){this.valid=!1,this.removeInvalid&&delete data[key]},StandardMaterialValidator.prototype.validate=function(data){var TYPES=standardMaterialParameterTypes,type,i,pathMapping="path"===data.mappingFormat;for(var key in data)if(type=TYPES[key])if(type.startsWith("enum")){var enumType=type.split(":")[1];this.enumValidators[enumType]&&(this.enumValidators[enumType](data[key])||this.setInvalid(key,data))}else if("number"===type)"number"!=typeof data[key]&&this.setInvalid(key,data);else if("boolean"===type)"boolean"!=typeof data[key]&&this.setInvalid(key,data);else if("string"===type)"string"!=typeof data[key]&&this.setInvalid(key,data);else if("vec2"===type)data[key]instanceof Array&&2===data[key].length||this.setInvalid(key,data);else if("rgb"===type)data[key]instanceof Array&&3===data[key].length||this.setInvalid(key,data);else if("texture"===type)pathMapping?"string"==typeof data[key]||data[null===key]||data[key]instanceof Texture||this.setInvalid(key,data):"number"!=typeof data[key]&&null!==data[key]&&(data[key]instanceof Texture||this.setInvalid(key,data));else if("boundingbox"===type)data[key].center&&data[key].center instanceof Array&&3===data[key].center.length||this.setInvalid(key,data),data[key].halfExtents&&data[key].halfExtents instanceof Array&&3===data[key].halfExtents.length||this.setInvalid(key,data);else if("cubemap"===type)"number"!=typeof data[key]&&null!==data[key]&&void 0!==data[key]&&(data[key]instanceof Texture&&data[key].cubemap||this.setInvalid(key,data));else if("chunks"===type){var chunkNames=Object.keys(data[key]);for(i=0;i<chunkNames.length;i++)"string"!=typeof data[key][chunkNames[i]]&&this.setInvalid(chunkNames[i],data[key])}else console.error("Unknown material type: "+type);else this.valid=!1;return data.validated=!0,this.valid},StandardMaterialValidator.prototype._createEnumValidator=function(values){return function(value){return values.indexOf(value)>=0}};var JsonStandardMaterialParser=function(){function JsonStandardMaterialParser(){this._validator=null}var _proto=JsonStandardMaterialParser.prototype;return _proto.parse=function parse(input){var migrated=this.migrate(input),validated=this._validate(migrated),material=new StandardMaterial;return this.initialize(material,validated),material},_proto.initialize=function initialize(material,data){for(var key in data.validated||(data=this._validate(data)),data.chunks&&material.chunks.copy(data.chunks),data){var type=standardMaterialParameterTypes[key],value=data[key];if("vec2"===type)material[key]=new Vec2(value[0],value[1]);else if("rgb"===type)material[key]=new Color(value[0],value[1],value[2]);else if("texture"===type)value instanceof Texture?material[key]=value:material[key]instanceof Texture&&"number"==typeof value&&value>0||(material[key]=null);else if("cubemap"===type)value instanceof Texture?material[key]=value:material[key]instanceof Texture&&"number"==typeof value&&value>0||(material[key]=null);else if("boundingbox"===type){var center=new Vec3(value.center[0],value.center[1],value.center[2]),halfExtents=new Vec3(value.halfExtents[0],value.halfExtents[1],value.halfExtents[2]);material[key]=new BoundingBox(center,halfExtents)}else material[key]=data[key]}material.update()},_proto.migrate=function migrate(data){var i;void 0===data.shadingModel&&("blinn"===data.shader?data.shadingModel=1:data.shadingModel=0),data.shader&&delete data.shader,data.mapping_format&&(data.mappingFormat=data.mapping_format,delete data.mapping_format);var RENAMED_PROPERTIES=[["bumpMapFactor","bumpiness"],["aoUvSet","aoMapUv"],["aoMapVertexColor","aoVertexColor"],["diffuseMapVertexColor","diffuseVertexColor"],["emissiveMapVertexColor","emissiveVertexColor"],["specularMapVertexColor","specularVertexColor"],["metalnessMapVertexColor","metalnessVertexColor"],["opacityMapVertexColor","opacityVertexColor"],["glossMapVertexColor","glossVertexColor"],["lightMapVertexColor","lightVertexColor"],["diffuseMapTint","diffuseTint"],["specularMapTint","specularTint"],["emissiveMapTint","emissiveTint"],["metalnessMapTint","metalnessTint"]];for(i=0;i<RENAMED_PROPERTIES.length;i++){var _old=RENAMED_PROPERTIES[i][0],_new=RENAMED_PROPERTIES[i][1];void 0!==data[_old]&&void 0===data[_new]&&(data[_new]=data[_old],delete data[_old])}var DEPRECATED_PROPERTIES=["fresnelFactor","shadowSampleType"];for(i=0;i<DEPRECATED_PROPERTIES.length;i++){var name=DEPRECATED_PROPERTIES[i];data.hasOwnProperty(name)&&delete data[name]}return data},_proto._validate=function _validate(data){return data.validated||(this._validator||(this._validator=new StandardMaterialValidator),this._validator.validate(data)),data},JsonStandardMaterialParser}(),PLACEHOLDER_MAP={aoMap:"white",diffuseMap:"gray",specularMap:"gray",metalnessMap:"black",glossMap:"gray",emissiveMap:"gray",normalMap:"normal",heightMap:"gray",opacityMap:"gray",sphereMap:"gray",lightMap:"white"},MaterialHandler=function(){function MaterialHandler(app){this._assets=app.assets,this._device=app.graphicsDevice,this._placeholderTextures=null,this._parser=new JsonStandardMaterialParser,this.maxRetries=0}var _proto=MaterialHandler.prototype;return _proto.load=function load(url,callback){"string"==typeof url&&(url={load:url,original:url}),http.get(url.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(err,response){err?callback&&callback("Error loading material: "+url.original+" ["+err+"]"):callback&&(response._engine=!0,callback(null,response))}))},_proto.open=function open(url,data){var material=this._parser.parse(data);return data._engine&&(material._data=data,delete data._engine),material},_proto._createPlaceholders=function _createPlaceholders(){this._placeholderTextures={};var textures={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255]};for(var key in textures)if(textures.hasOwnProperty(key)){this._placeholderTextures[key]=new Texture(this._device,{width:2,height:2,format:7}),this._placeholderTextures[key].name="placeholder";for(var pixels=this._placeholderTextures[key].lock(),i=0;i<4;i++)for(var c=0;c<4;c++)pixels[4*i+c]=textures[key][c];this._placeholderTextures[key].unlock()}},_proto.patch=function patch(asset,assets){asset.resource._data&&(asset._data=asset.resource._data,delete asset.resource._data),asset.data.name=asset.name,asset.resource.name=asset.name,this._bindAndAssignAssets(asset,assets),asset.off("unload",this._onAssetUnload,this),asset.on("unload",this._onAssetUnload,this)},_proto._onAssetUnload=function _onAssetUnload(asset){delete asset.data.parameters,delete asset.data.chunks,delete asset.data.name},_proto._assignTexture=function _assignTexture(parameterName,materialAsset,texture){materialAsset.resource[parameterName]=texture},_proto._getPlaceholderTexture=function _getPlaceholderTexture(parameterName){this._placeholderTextures||this._createPlaceholders();var placeholder=PLACEHOLDER_MAP[parameterName],texture;return this._placeholderTextures[placeholder]},_proto._assignPlaceholderTexture=function _assignPlaceholderTexture(parameterName,materialAsset){materialAsset.resource[parameterName]=this._getPlaceholderTexture(parameterName,materialAsset)},_proto._onTextureLoad=function _onTextureLoad(parameterName,materialAsset,textureAsset){this._assignTexture(parameterName,materialAsset,textureAsset.resource),materialAsset.resource.update()},_proto._onTextureAdd=function _onTextureAdd(parameterName,materialAsset,textureAsset){this._assets.load(textureAsset)},_proto._onTextureRemoveOrUnload=function _onTextureRemoveOrUnload(parameterName,materialAsset,textureAsset){var material=materialAsset.resource;material&&materialAsset.resource[parameterName]===textureAsset.resource&&(this._assignPlaceholderTexture(parameterName,materialAsset),material.update())},_proto._assignCubemap=function _assignCubemap(parameterName,materialAsset,textures){materialAsset.resource[parameterName]=textures[0],7===textures.length&&(materialAsset.resource.prefilteredCubeMap128=textures[1],materialAsset.resource.prefilteredCubeMap64=textures[2],materialAsset.resource.prefilteredCubeMap32=textures[3],materialAsset.resource.prefilteredCubeMap16=textures[4],materialAsset.resource.prefilteredCubeMap8=textures[5],materialAsset.resource.prefilteredCubeMap4=textures[6])},_proto._onCubemapLoad=function _onCubemapLoad(parameterName,materialAsset,cubemapAsset){this._assignCubemap(parameterName,materialAsset,cubemapAsset.resources),this._parser.initialize(materialAsset.resource,materialAsset.data)},_proto._onCubemapAdd=function _onCubemapAdd(parameterName,materialAsset,cubemapAsset){0===materialAsset.data.shadingModel&&(materialAsset.loadFaces=!0),this._assets.load(cubemapAsset)},_proto._onCubemapRemoveOrUnload=function _onCubemapRemoveOrUnload(parameterName,materialAsset,cubemapAsset){var material=materialAsset.resource;materialAsset.data.prefilteredCubeMap128===cubemapAsset.resources[1]&&(this._assignCubemap(parameterName,materialAsset,[null,null,null,null,null,null,null]),material.update())},_proto._bindAndAssignAssets=function _bindAndAssignAssets(materialAsset,assets){var data=this._parser.migrate(materialAsset.data),material=materialAsset.resource,pathMapping="path"===data.mappingFormat,TEXTURES=standardMaterialTextureParameters,i,name,assetReference;for(i=0;i<TEXTURES.length;i++)name=TEXTURES[i],assetReference=material._assetReferences[name],!data[name]||materialAsset.resource[name]&&materialAsset.resource[name]!==this._getPlaceholderTexture(name,materialAsset)?assetReference&&(pathMapping?assetReference.url=null:assetReference.id=null):(assetReference||(assetReference=new AssetReference(name,materialAsset,assets,{load:this._onTextureLoad,add:this._onTextureAdd,remove:this._onTextureRemoveOrUnload,unload:this._onTextureRemoveOrUnload},this),material._assetReferences[name]=assetReference),pathMapping?assetReference.url=materialAsset.getAbsoluteUrl(data[name]):assetReference.id=data[name],assetReference.asset&&(assetReference.asset.resource?this._assignTexture(name,materialAsset,assetReference.asset.resource):this._assignPlaceholderTexture(name,materialAsset),assets.load(assetReference.asset)));var CUBEMAPS=standardMaterialCubemapParameters;for(i=0;i<CUBEMAPS.length;i++)name=CUBEMAPS[i],assetReference=material._assetReferences[name],data[name]&&!materialAsset.data.prefilteredCubeMap128&&(assetReference||(assetReference=new AssetReference(name,materialAsset,assets,{load:this._onCubemapLoad,add:this._onCubemapAdd,remove:this._onCubemapRemoveOrUnload,unload:this._onCubemapRemoveOrUnload},this),material._assetReferences[name]=assetReference),pathMapping?assetReference.url=data[name]:assetReference.id=data[name],assetReference.asset&&(assetReference.asset.loaded&&this._assignCubemap(name,materialAsset,assetReference.asset.resources),assets.load(assetReference.asset)));this._parser.initialize(material,data)},MaterialHandler}(),GlbModelParser=function(){function GlbModelParser(device){this._device=device}var _proto;return GlbModelParser.prototype.parse=function parse(data){var glb=GlbParser.parse("filename.glb",data,this._device);return glb?GlbParser.createModel(glb,Material.defaultMaterial):null},GlbModelParser}(),PartitionedVertex=function PartitionedVertex(){this.index=0,this.boneIndices=[0,0,0,0]},SkinPartition=function(){function SkinPartition(){this.partition=0,this.vertexStart=0,this.vertexCount=0,this.indexStart=0,this.indexCount=0,this.boneIndices=[],this.vertices=[],this.indices=[],this.indexMap={},this.originalMesh=null}var _proto=SkinPartition.prototype;return _proto.addVertex=function addVertex(vertex,idx,vertexArray){var remappedIndex=-1;if(void 0!==this.indexMap[idx])remappedIndex=this.indexMap[idx],this.indices.push(remappedIndex);else{for(var influence=0;influence<4;influence++)if(0!==vertexArray.blendWeight.data[4*idx+influence]){var originalBoneIndex=vertexArray.blendIndices.data[4*vertex.index+influence];vertex.boneIndices[influence]=this.getBoneRemap(originalBoneIndex)}remappedIndex=this.vertices.length,this.indices.push(remappedIndex),this.vertices.push(vertex),this.indexMap[idx]=remappedIndex}},_proto.addPrimitive=function addPrimitive(vertices,vertexIndices,vertexArray,boneLimit){var i,j,bonesToAdd=[],bonesToAddCount=0,vertexCount=vertices.length;for(i=0;i<vertexCount;i++)for(var vertex,idx=vertices[i].index,influence=0;influence<4;influence++)if(vertexArray.blendWeight.data[4*idx+influence]>0){var boneIndex=vertexArray.blendIndices.data[4*idx+influence],needToAdd=!0,boneRemap;for(j=0;j<bonesToAddCount;j++)if(bonesToAdd[j]===boneIndex){needToAdd=!1;break}if(needToAdd)bonesToAdd[bonesToAddCount]=boneIndex,bonesToAddCount+=-1===this.getBoneRemap(boneIndex)?1:0}if(this.boneIndices.length+bonesToAddCount>boneLimit)return!1;for(i=0;i<bonesToAddCount;i++)this.boneIndices.push(bonesToAdd[i]);for(i=0;i<vertexCount;i++)this.addVertex(vertices[i],vertexIndices[i],vertexArray);return!0},_proto.getBoneRemap=function getBoneRemap(boneIndex){for(var i=0;i<this.boneIndices.length;i++)if(this.boneIndices[i]===boneIndex)return i;return-1},SkinPartition}();function indicesToReferences(model){var i,vertices=model.vertices,skins=model.skins,meshes=model.meshes,meshInstances=model.meshInstances;for(i=0;i<meshes.length;i++)meshes[i].vertices=vertices[meshes[i].vertices],void 0!==meshes[i].skin&&(meshes[i].skin=skins[meshes[i].skin]);for(i=0;i<meshInstances.length;i++)meshInstances[i].mesh=meshes[meshInstances[i].mesh]}function referencesToIndices(model){var i,vertices=model.vertices,skins=model.skins,meshes=model.meshes,meshInstances=model.meshInstances;for(i=0;i<meshes.length;i++)meshes[i].vertices=vertices.indexOf(meshes[i].vertices),void 0!==meshes[i].skin&&(meshes[i].skin=skins.indexOf(meshes[i].skin));for(i=0;i<meshInstances.length;i++)meshInstances[i].mesh=meshes.indexOf(meshInstances[i].mesh)}function partitionSkin(model,materialMappings,boneLimit){var i,j,k,index;indicesToReferences(model);var vertexArrays=model.vertices,skins=model.skins,mesh,meshes=model.meshes,meshInstances=model.meshInstances,getVertex=function getVertex(idx){var vert=new PartitionedVertex;return vert.index=idx,vert};for(i=skins.length-1;i>=0;i--)if(skins[i].boneNames.length>boneLimit){var skin=skins.splice(i,1)[0],meshesToSplit=[];for(j=0;j<meshes.length;j++)meshes[j].skin===skin&&meshesToSplit.push(meshes[j]);for(j=0;j<meshesToSplit.length;j++)-1!==(index=meshes.indexOf(meshesToSplit[j]))&&meshes.splice(index,1);if(0===meshesToSplit.length)throw new Error("partitionSkin: There should be at least one mesh that references a skin");var vertexArray=meshesToSplit[0].vertices,partition;for(j=1;j<meshesToSplit.length;j++)if(meshesToSplit[j].vertices!==vertexArray)throw new Error("partitionSkin: All meshes that share a skin should also share the same vertex buffer");var partitions=[],primitiveVertices=[],primitiveIndices=[],basePartition=0;for(j=0;j<meshesToSplit.length;j++){for(var indices=(mesh=meshesToSplit[j]).indices,iIndex=mesh.base;iIndex<mesh.base+mesh.count;){index=indices[iIndex++],primitiveVertices[0]=getVertex(index),primitiveIndices[0]=index,index=indices[iIndex++],primitiveVertices[1]=getVertex(index),primitiveIndices[1]=index,index=indices[iIndex++],primitiveVertices[2]=getVertex(index),primitiveIndices[2]=index;for(var added=!1,iBonePartition=basePartition;iBonePartition<partitions.length;iBonePartition++)if((partition=partitions[iBonePartition]).addPrimitive(primitiveVertices,primitiveIndices,vertexArray,boneLimit)){added=!0;break}added||((partition=new SkinPartition).originalMesh=mesh,partition.addPrimitive(primitiveVertices,primitiveIndices,vertexArray,boneLimit),partitions.push(partition))}basePartition=partitions.length}var partitionedVertices=[],partitionedIndices=[];for(j=0;j<partitions.length;j++)if((partition=partitions[j]).vertices.length&&partition.indices.length){var vertexStart=partitionedVertices.length,vertexCount=partition.vertices.length,indexStart=partitionedIndices.length,indexCount=partition.indices.length,iSour,iDest;for(partition.partition=j,partition.vertexStart=vertexStart,partition.vertexCount=vertexCount,partition.indexStart=indexStart,partition.indexCount=indexCount,iSour=0,iDest=vertexStart;iSour<vertexCount;)partitionedVertices[iDest++]=partition.vertices[iSour++];for(iSour=0,iDest=indexStart;iSour<indexCount;)partitionedIndices[iDest++]=partition.indices[iSour++]+vertexStart}var splitSkins=[],attrib,attribName,data,components;for(j=0;j<partitions.length;j++){partition=partitions[j];var ibp=[],boneNames=[];for(k=0;k<partition.boneIndices.length;k++)ibp.push(skin.inverseBindMatrices[partition.boneIndices[k]]),boneNames.push(skin.boneNames[partition.boneIndices[k]]);var splitSkin={inverseBindMatrices:ibp,boneNames:boneNames};splitSkins.push(splitSkin),skins.push(splitSkin)}var splitVertexArray={};for(attribName in vertexArray)splitVertexArray[attribName]={components:vertexArray[attribName].components,data:[],type:vertexArray[attribName].type};for(attribName in vertexArray)if("blendIndices"===attribName){var dstBoneIndices=splitVertexArray[attribName].data;for(j=0;j<partitionedVertices.length;j++){var srcBoneIndices=partitionedVertices[j].boneIndices;dstBoneIndices.push(srcBoneIndices[0],srcBoneIndices[1],srcBoneIndices[2],srcBoneIndices[3])}}else for(data=(attrib=vertexArray[attribName]).data,components=attrib.components,j=0;j<partitionedVertices.length;j++)for(index=partitionedVertices[j].index,k=0;k<components;k++)splitVertexArray[attribName].data.push(data[index*components+k]);for(vertexArrays[vertexArrays.indexOf(vertexArray)]=splitVertexArray,j=0;j<partitions.length;j++)for(partition=partitions[j],mesh={aabb:{min:[0,0,0],max:[0,0,0]},vertices:splitVertexArray,skin:splitSkins[j],indices:partitionedIndices.splice(0,partition.indexCount),type:"triangles",base:0,count:partition.indexCount},meshes.push(mesh),k=meshInstances.length-1;k>=0;k--)meshInstances[k].mesh===partition.originalMesh&&(meshInstances.push({mesh:mesh,node:meshInstances[k].node}),materialMappings&&materialMappings.push({material:materialMappings[k].material,path:materialMappings[k].path}));for(j=0;j<partitions.length;j++)for(partition=partitions[j],k=meshInstances.length-1;k>=0;k--)meshInstances[k].mesh===partition.originalMesh&&(meshInstances.splice(k,1),materialMappings&&materialMappings.splice(k,1))}referencesToIndices(model)}var JSON_PRIMITIVE_TYPE={points:0,lines:1,lineloop:2,linestrip:3,triangles:4,trianglestrip:5,trianglefan:6},JSON_VERTEX_ELEMENT_TYPE={int8:0,uint8:1,int16:2,uint16:3,int32:4,uint32:5,float32:6},JsonModelParser=function(){function JsonModelParser(device){this._device=device}var _proto=JsonModelParser.prototype;return _proto.parse=function parse(data){var modelData=data.model;if(!modelData)return null;if(modelData.version<=1)return null;var nodes=this._parseNodes(data),skins=this._parseSkins(data,nodes),vertexBuffers=this._parseVertexBuffers(data),indices=this._parseIndexBuffers(data,vertexBuffers),morphs=this._parseMorphs(data,nodes,vertexBuffers),meshes=this._parseMeshes(data,skins.skins,morphs.morphs,vertexBuffers,indices.buffer,indices.data),meshInstances=this._parseMeshInstances(data,nodes,meshes,skins.skins,skins.instances,morphs.morphs,morphs.instances),model=new Model;return model.graph=nodes[0],model.meshInstances=meshInstances,model.skinInstances=skins.instances,model.morphInstances=morphs.instances,model.getGraph().syncHierarchy(),model},_proto._parseNodes=function _parseNodes(data){var modelData=data.model,nodes=[],i;for(i=0;i<modelData.nodes.length;i++){var nodeData=modelData.nodes[i],node=new GraphNode(nodeData.name);node.setLocalPosition(nodeData.position[0],nodeData.position[1],nodeData.position[2]),node.setLocalEulerAngles(nodeData.rotation[0],nodeData.rotation[1],nodeData.rotation[2]),node.setLocalScale(nodeData.scale[0],nodeData.scale[1],nodeData.scale[2]),node.scaleCompensation=!!nodeData.scaleCompensation,nodes.push(node)}for(i=1;i<modelData.parents.length;i++)nodes[modelData.parents[i]].addChild(nodes[i]);return nodes},_proto._parseSkins=function _parseSkins(data,nodes){var modelData=data.model,skins=[],skinInstances=[],i,j,boneLimit;!this._device.supportsBoneTextures&&modelData.skins.length>0&&partitionSkin(modelData,null,this._device.getBoneLimit());for(i=0;i<modelData.skins.length;i++){var skinData=modelData.skins[i],inverseBindMatrices=[];for(j=0;j<skinData.inverseBindMatrices.length;j++){var ibm=skinData.inverseBindMatrices[j];inverseBindMatrices[j]=(new Mat4).set(ibm)}var skin=new Skin(this._device,inverseBindMatrices,skinData.boneNames);skins.push(skin);var skinInstance=new SkinInstance(skin),bones=[];for(j=0;j<skin.boneNames.length;j++){var boneName=skin.boneNames[j],bone=nodes[0].findByName(boneName);bones.push(bone)}skinInstance.bones=bones,skinInstances.push(skinInstance)}return{skins:skins,instances:skinInstances}},_proto._getMorphVertexCount=function _getMorphVertexCount(modelData,morphIndex,vertexBuffers){for(var i=0;i<modelData.meshes.length;i++){var meshData=modelData.meshes[i],vertexBuffer;if(meshData.morph===morphIndex)return vertexBuffers[meshData.vertices].numVertices}},_proto._parseMorphs=function _parseMorphs(data,nodes,vertexBuffers){var modelData=data.model,morphs=[],morphInstances=[],i,j,vertexCount,targets,morphTarget,morphTargetArray;if(modelData.morphs){var sparseToFull=function sparseToFull(data,indices,totalCount){for(var full=new Float32Array(3*totalCount),s=0;s<indices.length;s++){var dstIndex=3*indices[s];full[dstIndex]=data[3*s],full[dstIndex+1]=data[3*s+1],full[dstIndex+2]=data[3*s+2]}return full};for(i=0;i<modelData.morphs.length;i++){for(targets=modelData.morphs[i].targets,morphTargetArray=[],vertexCount=this._getMorphVertexCount(modelData,i,vertexBuffers),j=0;j<targets.length;j++){var targetAabb=targets[j].aabb,min=targetAabb.min,max=targetAabb.max,aabb=new BoundingBox(new Vec3(.5*(max[0]+min[0]),.5*(max[1]+min[1]),.5*(max[2]+min[2])),new Vec3(.5*(max[0]-min[0]),.5*(max[1]-min[1]),.5*(max[2]-min[2]))),indices=targets[j].indices,deltaPositions=targets[j].deltaPositions,deltaNormals=targets[j].deltaNormals;indices&&(deltaPositions=sparseToFull(deltaPositions,indices,vertexCount),deltaNormals=sparseToFull(deltaNormals,indices,vertexCount)),morphTarget=new MorphTarget({deltaPositions:deltaPositions,deltaNormals:deltaNormals,name:targets[j].name,aabb:aabb}),morphTargetArray.push(morphTarget)}var morph=new Morph(morphTargetArray,this._device);morphs.push(morph);var morphInstance=new MorphInstance(morph);morphInstances.push(morphInstance)}}return{morphs:morphs,instances:morphInstances}},_proto._parseVertexBuffers=function _parseVertexBuffers(data){for(var modelData=data.model,vertexBuffers=[],attributeMap={position:"POSITION",normal:"NORMAL",tangent:"TANGENT",blendWeight:"BLENDWEIGHT",blendIndices:"BLENDINDICES",color:"COLOR",texCoord0:"TEXCOORD0",texCoord1:"TEXCOORD1",texCoord2:"TEXCOORD2",texCoord3:"TEXCOORD3",texCoord4:"TEXCOORD4",texCoord5:"TEXCOORD5",texCoord6:"TEXCOORD6",texCoord7:"TEXCOORD7"},i=0;i<modelData.vertices.length;i++){var vertexData=modelData.vertices[i],formatDesc=[];for(var attributeName in vertexData){var attribute=vertexData[attributeName];formatDesc.push({semantic:attributeMap[attributeName],components:attribute.components,type:JSON_VERTEX_ELEMENT_TYPE[attribute.type],normalize:"COLOR"===attributeMap[attributeName]})}for(var vertexFormat=new VertexFormat(this._device,formatDesc),numVertices=vertexData.position.data.length/vertexData.position.components,vertexBuffer=new VertexBuffer(this._device,vertexFormat,numVertices),iterator=new VertexIterator(vertexBuffer),j=0;j<numVertices;j++){for(var _attributeName in vertexData){var _attribute=vertexData[_attributeName];switch(_attribute.components){case 1:iterator.element[attributeMap[_attributeName]].set(_attribute.data[j]);break;case 2:iterator.element[attributeMap[_attributeName]].set(_attribute.data[2*j],_attribute.data[2*j+1]);break;case 3:iterator.element[attributeMap[_attributeName]].set(_attribute.data[3*j],_attribute.data[3*j+1],_attribute.data[3*j+2]);break;case 4:iterator.element[attributeMap[_attributeName]].set(_attribute.data[4*j],_attribute.data[4*j+1],_attribute.data[4*j+2],_attribute.data[4*j+3])}}iterator.next()}iterator.end(),vertexBuffers.push(vertexBuffer)}return vertexBuffers},_proto._parseIndexBuffers=function _parseIndexBuffers(data,vertexBuffers){var modelData=data.model,indexBuffer=null,indexData=null,i,numIndices=0;for(i=0;i<modelData.meshes.length;i++){var meshData=modelData.meshes[i];void 0!==meshData.indices&&(numIndices+=meshData.indices.length)}var maxVerts=0;for(i=0;i<vertexBuffers.length;i++)maxVerts=Math.max(maxVerts,vertexBuffers[i].numVertices);return numIndices>0&&(maxVerts>65535&&this._device.extUintElement?(indexBuffer=new IndexBuffer(this._device,2,numIndices),indexData=new Uint32Array(indexBuffer.lock())):(indexBuffer=new IndexBuffer(this._device,1,numIndices),indexData=new Uint16Array(indexBuffer.lock()))),{buffer:indexBuffer,data:indexData}},_proto._parseMeshes=function _parseMeshes(data,skins,morphs,vertexBuffers,indexBuffer,indexData){for(var modelData=data.model,meshes=[],indexBase=0,i=0;i<modelData.meshes.length;i++){var meshData=modelData.meshes[i],meshAabb=meshData.aabb,min=meshAabb.min,max=meshAabb.max,aabb=new BoundingBox(new Vec3(.5*(max[0]+min[0]),.5*(max[1]+min[1]),.5*(max[2]+min[2])),new Vec3(.5*(max[0]-min[0]),.5*(max[1]-min[1]),.5*(max[2]-min[2]))),indexed=void 0!==meshData.indices,mesh=new Mesh(this._device);mesh.vertexBuffer=vertexBuffers[meshData.vertices],mesh.indexBuffer[0]=indexed?indexBuffer:null,mesh.primitive[0].type=JSON_PRIMITIVE_TYPE[meshData.type],mesh.primitive[0].base=indexed?meshData.base+indexBase:meshData.base,mesh.primitive[0].count=meshData.count,mesh.primitive[0].indexed=indexed,mesh.skin=void 0!==meshData.skin?skins[meshData.skin]:null,mesh.morph=void 0!==meshData.morph?morphs[meshData.morph]:null,mesh.aabb=aabb,indexed&&(indexData.set(meshData.indices,indexBase),indexBase+=meshData.indices.length),meshes.push(mesh)}return null!==indexBuffer&&indexBuffer.unlock(),meshes},_proto._parseMeshInstances=function _parseMeshInstances(data,nodes,meshes,skins,skinInstances,morphs,morphInstances){var modelData=data.model,meshInstances=[],i;for(i=0;i<modelData.meshInstances.length;i++){var meshInstanceData=modelData.meshInstances[i],node=nodes[meshInstanceData.node],mesh=meshes[meshInstanceData.mesh],meshInstance=new MeshInstance(mesh,Material.defaultMaterial,node);if(mesh.skin){var skinIndex=skins.indexOf(mesh.skin);meshInstance.skinInstance=skinInstances[skinIndex]}if(mesh.morph){var morphIndex=morphs.indexOf(mesh.morph);meshInstance.morphInstance=morphInstances[morphIndex]}meshInstances.push(meshInstance)}return meshInstances},JsonModelParser}(),ModelHandler=function(){function ModelHandler(device,defaultMaterial){this._device=device,this._parsers=[],this._defaultMaterial=defaultMaterial,this.maxRetries=0,this.addParser(new JsonModelParser(this._device),(function(url,data){return".json"===path.getExtension(url)})),this.addParser(new GlbModelParser(this._device),(function(url,data){return".glb"===path.getExtension(url)}))}var _proto=ModelHandler.prototype;return _proto.load=function load(url,callback){"string"==typeof url&&(url={load:url,original:url});var options={retry:this.maxRetries>0,maxRetries:this.maxRetries};(url.load.startsWith("blob:")||url.load.startsWith("data:"))&&(".glb"===path.getExtension(url.original).toLowerCase()?options.responseType=Http.ResponseType.ARRAY_BUFFER:options.responseType=Http.ResponseType.JSON),http.get(url.load,options,(function(err,response){callback&&(err?callback("Error loading model: "+url.original+" ["+err+"]"):callback(null,response))}))},_proto.open=function open(url,data){for(var i=0;i<this._parsers.length;i++){var p=this._parsers[i];if(p.decider(url,data))return p.parser.parse(data)}return null},_proto.patch=function patch(asset,assets){if(asset.resource){var data=asset.data,self=this;asset.resource.meshInstances.forEach((function(meshInstance,i){if(data.mapping){var handleMaterial=function handleMaterial(asset){asset.resource?meshInstance.material=asset.resource:(asset.once("load",handleMaterial),assets.load(asset)),asset.once("remove",(function(asset){meshInstance.material===asset.resource&&(meshInstance.material=self._defaultMaterial)}))};if(!data.mapping[i])return void(meshInstance.material=self._defaultMaterial);var id=data.mapping[i].material,url=data.mapping[i].path,material;if(void 0!==id)id?(material=assets.get(id))?handleMaterial(material):assets.once("add:"+id,handleMaterial):meshInstance.material=self._defaultMaterial;else if(url){var _path=asset.getAbsoluteUrl(data.mapping[i].path);(material=assets.getByUrl(_path))?handleMaterial(material):assets.once("add:url:"+_path,handleMaterial)}}}))}},_proto.addParser=function addParser(parser,decider){this._parsers.push({parser:parser,decider:decider})},ModelHandler}();function onContainerAssetLoaded(containerAsset){var renderAsset=this;if(this.resource){var containerResource=containerAsset.resource,render=containerResource.renders&&containerResource.renders[this.data.renderIndex];render&&(this.resource.meshes=render.resource.meshes)}}function onContainerAssetAdded(containerAsset){var renderAsset=this;this.registry.off("load:"+containerAsset.id,onContainerAssetLoaded,this),this.registry.on("load:"+containerAsset.id,onContainerAssetLoaded,this),this.registry.off("remove:"+containerAsset.id,onContainerAssetRemoved,this),this.registry.once("remove:"+containerAsset.id,onContainerAssetRemoved,this),containerAsset.resource?onContainerAssetLoaded.call(this,containerAsset):this.registry.load(containerAsset)}function onContainerAssetRemoved(containerAsset){var renderAsset=this;this.registry.off("load:"+containerAsset.id,onContainerAssetLoaded,this),this.resource&&(this.resource.meshes=null)}var RenderHandler=function(){function RenderHandler(assets){this._registry=assets}var _proto=RenderHandler.prototype;return _proto.load=function load(url,callback,asset){},_proto.open=function open(url,data){return new Render},_proto.patch=function patch(asset,registry){if(asset.data.containerAsset){var containerAsset=registry.get(asset.data.containerAsset);containerAsset?onContainerAssetAdded.call(asset,containerAsset):registry.once("add:"+asset.data.containerAsset,onContainerAssetAdded,asset)}},RenderHandler}(),ResourceLoader=function(){function ResourceLoader(app){this._handlers={},this._requests={},this._cache={},this._app=app}var _proto=ResourceLoader.prototype;return _proto.addHandler=function addHandler(type,handler){this._handlers[type]=handler,handler._loader=this},_proto.removeHandler=function removeHandler(type){delete this._handlers[type]},_proto.getHandler=function getHandler(type){return this._handlers[type]},_proto.load=function load(url,type,callback,asset){var handler=this._handlers[type],err;if(handler)if(url){var key=url+type;if(void 0!==this._cache[key])callback(null,this._cache[key]);else if(this._requests[key])this._requests[key].push(callback);else{this._requests[key]=[callback];var self=this,handleLoad=function handleLoad(err,urlObj){err?self._onFailure(key,err):handler.load(urlObj,(function(err,data,extra){if(self._requests[key])if(err)self._onFailure(key,err);else try{self._onSuccess(key,handler.open(urlObj.original,data,asset),extra)}catch(e){self._onFailure(key,e)}}),asset)},normalizedUrl=url.split("?")[0];if(this._app.enableBundles&&this._app.bundles.hasUrl(normalizedUrl)){if(!this._app.bundles.canLoadUrl(normalizedUrl))return void handleLoad("Bundle for "+url+" not loaded yet");this._app.bundles.loadUrl(normalizedUrl,(function(err,fileUrlFromBundle){handleLoad(err,{load:fileUrlFromBundle,original:normalizedUrl})}))}else handleLoad(null,{load:url,original:asset&&asset.getPreferredFile().filename||url})}}else this._loadNull(handler,callback,asset);else callback("No handler for asset type: "+type)},_proto._loadNull=function _loadNull(handler,callback,asset){var onLoad=function onLoad(err,data,extra){if(err)callback(err);else try{callback(null,handler.open(null,data,asset),extra)}catch(e){callback(e)}};handler.load(null,onLoad,asset)},_proto._onSuccess=function _onSuccess(key,result,extra){this._cache[key]=result;for(var i=0;i<this._requests[key].length;i++)this._requests[key][i](null,result,extra);delete this._requests[key]},_proto._onFailure=function _onFailure(key,err){if(console.error(err),this._requests[key]){for(var i=0;i<this._requests[key].length;i++)this._requests[key][i](err);delete this._requests[key]}},_proto.open=function open(type,data){var handler=this._handlers[type];return handler?handler.open(null,data):(console.warn("No resource handler found for: "+type),data)},_proto.patch=function patch(asset,assets){var handler=this._handlers[asset.type];handler?handler.patch&&handler.patch(asset,assets):console.warn("No resource handler found for: "+asset.type)},_proto.clearCache=function clearCache(url,type){delete this._cache[url+type]},_proto.getFromCache=function getFromCache(url,type){if(this._cache[url+type])return this._cache[url+type]},_proto.enableRetry=function enableRetry(maxRetries){for(var key in void 0===maxRetries&&(maxRetries=5),maxRetries=Math.max(0,maxRetries)||0,this._handlers)this._handlers[key].maxRetries=maxRetries},_proto.disableRetry=function disableRetry(){for(var key in this._handlers)this._handlers[key].maxRetries=0},_proto.destroy=function destroy(){this._handlers={},this._requests={},this._cache={}},ResourceLoader}(),SceneHandler=function(){function SceneHandler(app){this._app=app,this.maxRetries=0}var _proto=SceneHandler.prototype;return _proto.load=function load(url,callback){SceneUtils.load(url,callback)},_proto.open=function open(url,data){this._app.systems.script.preloading=!0;var parser,parent=new SceneParser(this._app,!1).parse(data),scene=this._app.scene;return scene.root=parent,this._app.applySceneSettings(data.settings),this._app.systems.script.preloading=!1,scene},_proto.patch=function patch(asset,assets){},SceneHandler}(),_legacy=!1,_createdLoadingScreen=!1,script={app:null,create:function create(name,callback){if(_legacy){var ScriptType=callback(script.app);ScriptType._pcScriptName=name,ScriptHandler._push(ScriptType),this.fire("created",name,callback)}},attribute:function attribute(name,type,defaultValue,options){},createLoadingScreen:function createLoadingScreen(callback){var app;_createdLoadingScreen||(_createdLoadingScreen=!0,callback(getApplication()))}};Object.defineProperty(script,"legacy",{get:function get(){return _legacy},set:function set(value){_legacy=value}}),events.attach(script);var ScriptHandler=function(){function ScriptHandler(app){this._app=app,this._scripts={},this._cache={}}ScriptHandler._push=function _push(Type){script.legacy&&ScriptHandler._types.length>0?console.assert("Script Ordering Error. Contact support@playcanvas.com"):ScriptHandler._types.push(Type)};var _proto=ScriptHandler.prototype;return _proto.load=function load(url,callback){"string"==typeof url&&(url={load:url,original:url});var self=this;script.app=this._app,this._loadScript(url.load,function(err,url,extra){if(err)callback(err);else if(script.legacy){var Type=null;ScriptHandler._types.length&&(Type=ScriptHandler._types.pop()),Type?this._scripts[url]=Type:Type=null,callback(null,Type,extra)}else{for(var obj={},i=0;i<ScriptHandler._types.length;i++)obj[ScriptHandler._types[i].name]=ScriptHandler._types[i];ScriptHandler._types.length=0,callback(null,obj,extra),delete self._loader._cache[url+"script"]}}.bind(this))},_proto.open=function open(url,data){return data},_proto.patch=function patch(asset,assets){},_proto._loadScript=function _loadScript(url,callback){var head=document.head,element=document.createElement("script");this._cache[url]=element,element.async=!1,element.addEventListener("error",(function(e){callback("Script: "+e.target.src+" failed to load")}),!1);var done=!1;element.onload=element.onreadystatechange=function(){done||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(done=!0,callback(null,url,element))},element.src=url,head.appendChild(element)},ScriptHandler}();ScriptHandler._types=[];var ShaderHandler=function(){function ShaderHandler(){this.maxRetries=0}var _proto=ShaderHandler.prototype;return _proto.load=function load(url,callback){"string"==typeof url&&(url={load:url,original:url}),http.get(url.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(err,response){err?callback("Error loading shader resource: "+url.original+" ["+err+"]"):callback(null,response)}))},_proto.open=function open(url,data){return data},_proto.patch=function patch(asset,assets){},ShaderHandler}(),spriteNormals=[0,0,1,0,0,1,0,0,1,0,0,1],spriteIndices=[0,1,3,2,3,1],Sprite=function(_EventHandler){function Sprite(device,options){var _this;return(_this=_EventHandler.call(this)||this)._device=device,_this._pixelsPerUnit=options&&void 0!==options.pixelsPerUnit?options.pixelsPerUnit:1,_this._renderMode=options&&void 0!==options.renderMode?options.renderMode:0,_this._atlas=options&&void 0!==options.atlas?options.atlas:null,_this._frameKeys=options&&void 0!==options.frameKeys?options.frameKeys:null,_this._meshes=[],_this._updatingProperties=!1,_this._meshesDirty=!1,_this._atlas&&_this._frameKeys&&_this._createMeshes(),_this}_inheritsLoose(Sprite,_EventHandler);var _proto=Sprite.prototype;return _proto._createMeshes=function _createMeshes(){var i,len;for(i=0,len=this._meshes.length;i<len;i++){var mesh=this._meshes[i];mesh&&mesh.destroy()}var count=this._frameKeys.length;this._meshes=new Array(count);var createMeshFunc=1===this.renderMode||2===this._renderMode?this._create9SliceMesh:this._createSimpleMesh;for(i=0;i<count;i++){var frame=this._atlas.frames[this._frameKeys[i]];this._meshes[i]=frame?createMeshFunc.call(this,frame):null}this.fire("set:meshes")},_proto._createSimpleMesh=function _createSimpleMesh(frame){var rect=frame.rect,texWidth=this._atlas.texture.width,texHeight=this._atlas.texture.height,w=rect.z/this._pixelsPerUnit,h=rect.w/this._pixelsPerUnit,hp=frame.pivot.x,vp=frame.pivot.y,positions=[-hp*w,-vp*h,0,(1-hp)*w,-vp*h,0,(1-hp)*w,(1-vp)*h,0,-hp*w,(1-vp)*h,0],lu=rect.x/texWidth,bv=rect.y/texHeight,ru=(rect.x+rect.z)/texWidth,tv=(rect.y+rect.w)/texHeight,uvs=[lu,bv,ru,bv,ru,tv,lu,tv],mesh;return createMesh$1(this._device,positions,{uvs:uvs,normals:spriteNormals,indices:spriteIndices})},_proto._create9SliceMesh=function _create9SliceMesh(){var he=Vec2.ONE,ws=3,ls=3,i,j,x,y,z,u,v,positions=[],normals=[],uvs=[],indices=[],vcounter=0;for(i=0;i<=3;i++)for(u=0===i||3===i?0:1,j=0;j<=3;j++)x=-he.x+2*he.x*(i<=1?0:3)/3,y=0,z=-(-he.y+2*he.y*(j<=1?0:3)/3),v=0===j||3===j?0:1,positions.push(-x,0,z),normals.push(0,1,0),uvs.push(u,v),i<3&&j<3&&(indices.push(vcounter+3+1,vcounter+1,vcounter),indices.push(vcounter+3+1,vcounter+3+2,vcounter+1)),vcounter++;var options={normals:normals,uvs:uvs,indices:indices};return createMesh$1(this._device,positions,options)},_proto._onSetFrames=function _onSetFrames(frames){this._updatingProperties?this._meshesDirty=!0:this._createMeshes()},_proto._onFrameChanged=function _onFrameChanged(frameKey,frame){var idx=this._frameKeys.indexOf(frameKey);idx<0||(frame?0===this.renderMode&&(this._meshes[idx]=this._createSimpleMesh(frame)):this._meshes[idx]=null,this.fire("set:meshes"))},_proto._onFrameRemoved=function _onFrameRemoved(frameKey){var idx=this._frameKeys.indexOf(frameKey);idx<0||(this._meshes[idx]=null,this.fire("set:meshes"))},_proto.startUpdate=function startUpdate(){this._updatingProperties=!0,this._meshesDirty=!1},_proto.endUpdate=function endUpdate(){this._updatingProperties=!1,this._meshesDirty&&this._atlas&&this._frameKeys&&this._createMeshes(),this._meshesDirty=!1},_proto.destroy=function destroy(){for(var _iterator=_createForOfIteratorHelperLoose(this._meshes),_step;!(_step=_iterator()).done;){var mesh=_step.value;mesh&&mesh.destroy()}this._meshes.length=0},_createClass(Sprite,[{key:"frameKeys",get:function get(){return this._frameKeys},set:function set(value){this._frameKeys=value,this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:frameKeys",value)}},{key:"atlas",get:function get(){return this._atlas},set:function set(value){value!==this._atlas&&(this._atlas&&(this._atlas.off("set:frames",this._onSetFrames,this),this._atlas.off("set:frame",this._onFrameChanged,this),this._atlas.off("remove:frame",this._onFrameRemoved,this)),this._atlas=value,this._atlas&&this._frameKeys&&(this._atlas.on("set:frames",this._onSetFrames,this),this._atlas.on("set:frame",this._onFrameChanged,this),this._atlas.on("remove:frame",this._onFrameRemoved,this),this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:atlas",value))}},{key:"pixelsPerUnit",get:function get(){return this._pixelsPerUnit},set:function set(value){this._pixelsPerUnit!==value&&(this._pixelsPerUnit=value,this.fire("set:pixelsPerUnit",value),this._atlas&&this._frameKeys&&0===this.renderMode&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()))}},{key:"renderMode",get:function get(){return this._renderMode},set:function set(value){if(this._renderMode!==value){var prev=this._renderMode;this._renderMode=value,this.fire("set:renderMode",value),0!==prev&&0!==value||this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes())}}},{key:"meshes",get:function get(){return this._meshes}}]),Sprite}(EventHandler);function onTextureAtlasLoaded(atlasAsset){var spriteAsset=this;this.resource&&(this.resource.atlas=atlasAsset.resource)}function onTextureAtlasAdded(atlasAsset){var spriteAsset=this;this.registry.load(atlasAsset)}var SpriteHandler=function(){function SpriteHandler(assets,device){this._assets=assets,this._device=device,this.maxRetries=0}var _proto=SpriteHandler.prototype;return _proto.load=function load(url,callback){"string"==typeof url&&(url={load:url,original:url}),".json"===path.getExtension(url.original)&&http.get(url.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(err,response){err?callback(err):callback(null,response)}))},_proto.open=function open(url,data){var sprite=new Sprite(this._device);return url&&(sprite.__data=data),sprite},_proto.patch=function patch(asset,assets){var sprite=asset.resource;if(sprite.__data&&(asset.data.pixelsPerUnit=sprite.__data.pixelsPerUnit,asset.data.renderMode=sprite.__data.renderMode,asset.data.frameKeys=sprite.__data.frameKeys,sprite.__data.textureAtlasAsset)){var atlas=assets.getByUrl(sprite.__data.textureAtlasAsset);atlas?asset.data.textureAtlasAsset=atlas.id:console.warn("Could not find textureatlas with url: "+sprite.__data.textureAtlasAsset)}sprite.startUpdate(),sprite.renderMode=asset.data.renderMode,sprite.pixelsPerUnit=asset.data.pixelsPerUnit,sprite.frameKeys=asset.data.frameKeys,this._updateAtlas(asset),sprite.endUpdate(),asset.off("change",this._onAssetChange,this),asset.on("change",this._onAssetChange,this)},_proto._updateAtlas=function _updateAtlas(asset){var sprite=asset.resource;if(asset.data.textureAtlasAsset){this._assets.off("load:"+asset.data.textureAtlasAsset,onTextureAtlasLoaded,asset),this._assets.on("load:"+asset.data.textureAtlasAsset,onTextureAtlasLoaded,asset);var atlasAsset=this._assets.get(asset.data.textureAtlasAsset);atlasAsset&&atlasAsset.resource?sprite.atlas=atlasAsset.resource:atlasAsset?this._assets.load(atlasAsset):(this._assets.off("add:"+asset.data.textureAtlasAsset,onTextureAtlasAdded,asset),this._assets.on("add:"+asset.data.textureAtlasAsset,onTextureAtlasAdded,asset))}else sprite.atlas=null},_proto._onAssetChange=function _onAssetChange(asset,attribute,value,oldValue){"data"===attribute&&value&&value.textureAtlasAsset&&oldValue&&value.textureAtlasAsset!==oldValue.textureAtlasAsset&&(this._assets.off("load:"+oldValue.textureAtlasAsset,onTextureAtlasLoaded,asset),this._assets.off("add:"+oldValue.textureAtlasAsset,onTextureAtlasAdded,asset))},SpriteHandler}(),Template=function(){function Template(app,data){this._app=app,this._data=data,this._templateRoot=null}var _proto=Template.prototype;return _proto.instantiate=function instantiate(){return this._templateRoot||this._parseTemplate(),this._templateRoot.clone()},_proto._parseTemplate=function _parseTemplate(){var parser=new SceneParser(this._app,!0);this._templateRoot=parser.parse(this._data)},Template}(),TemplateHandler=function(){function TemplateHandler(app){this._app=app}var _proto=TemplateHandler.prototype;return _proto.load=function load(url,callback){"string"==typeof url&&(url={load:url,original:url}),http.get(url.load,{},(function(err,response){err?callback("Error requesting template: "+url.original):callback(err,response)}))},_proto.open=function open(url,data){return new Template(this._app,data)},TemplateHandler}(),TextHandler=function(){function TextHandler(){this.maxRetries=0}var _proto=TextHandler.prototype;return _proto.load=function load(url,callback){"string"==typeof url&&(url={load:url,original:url}),http.get(url.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(err,response){err?callback("Error loading text resource: "+url.original+" ["+err+"]"):callback(null,response)}))},_proto.open=function open(url,data){return data},_proto.patch=function patch(asset,assets){},TextHandler}(),TextureAtlas=function(_EventHandler){function TextureAtlas(){var _this;return(_this=_EventHandler.call(this)||this)._texture=null,_this._frames=null,_this}_inheritsLoose(TextureAtlas,_EventHandler);var _proto=TextureAtlas.prototype;return _proto.setFrame=function setFrame(key,data){var frame=this._frames[key];frame?(frame.rect.copy(data.rect),frame.pivot.copy(data.pivot),frame.border.copy(data.border)):(frame={rect:data.rect.clone(),pivot:data.pivot.clone(),border:data.border.clone()},this._frames[key]=frame),this.fire("set:frame",key.toString(),frame)},_proto.removeFrame=function removeFrame(key){var frame=this._frames[key];frame&&(delete this._frames[key],this.fire("remove:frame",key.toString(),frame))},_proto.destroy=function destroy(){this._texture&&this._texture.destroy()},_createClass(TextureAtlas,[{key:"texture",get:function get(){return this._texture},set:function set(value){this._texture=value,this.fire("set:texture",value)}},{key:"frames",get:function get(){return this._frames},set:function set(value){this._frames=value,this.fire("set:frames",value)}}]),TextureAtlas}(EventHandler),JSON_ADDRESS_MODE$1={repeat:0,clamp:1,mirror:2},JSON_FILTER_MODE$1={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},regexFrame=/^data\.frames\.(\d+)$/,TextureAtlasHandler=function(){function TextureAtlasHandler(loader){this._loader=loader,this.maxRetries=0}var _proto=TextureAtlasHandler.prototype;return _proto.load=function load(url,callback){"string"==typeof url&&(url={load:url,original:url});var self=this,handler=this._loader.getHandler("texture");if(".json"!==path.getExtension(url.original))return handler.load(url,callback);http.get(url.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(err,response){if(err)callback(err);else{var textureUrl=url.original.replace(".json",".png");self._loader.load(textureUrl,"texture",(function(err,texture){err?callback(err):callback(null,{data:response,texture:texture})}))}}))},_proto.open=function open(url,data){var resource=new TextureAtlas;if(data.texture&&data.data)resource.texture=data.texture,resource.__data=data.data;else{var handler,texture=this._loader.getHandler("texture").open(url,data);if(!texture)return null;resource.texture=texture}return resource},_proto.patch=function patch(asset,assets){asset.resource.__data&&(void 0!==asset.resource.__data.minfilter&&(asset.data.minfilter=asset.resource.__data.minfilter),void 0!==asset.resource.__data.magfilter&&(asset.data.magfilter=asset.resource.__data.magfilter),void 0!==asset.resource.__data.addressu&&(asset.data.addressu=asset.resource.__data.addressu),void 0!==asset.resource.__data.addressv&&(asset.data.addressv=asset.resource.__data.addressv),void 0!==asset.resource.__data.mipmaps&&(asset.data.mipmaps=asset.resource.__data.mipmaps),void 0!==asset.resource.__data.anisotropy&&(asset.data.anisotropy=asset.resource.__data.anisotropy),void 0!==asset.resource.__data.rgbm&&(asset.data.rgbm=!!asset.resource.__data.rgbm),asset.data.frames=asset.resource.__data.frames,delete asset.resource.__data);var texture=asset.resource.texture;if(texture&&(texture.name=asset.name,asset.data.hasOwnProperty("minfilter")&&texture.minFilter!==JSON_FILTER_MODE$1[asset.data.minfilter]&&(texture.minFilter=JSON_FILTER_MODE$1[asset.data.minfilter]),asset.data.hasOwnProperty("magfilter")&&texture.magFilter!==JSON_FILTER_MODE$1[asset.data.magfilter]&&(texture.magFilter=JSON_FILTER_MODE$1[asset.data.magfilter]),asset.data.hasOwnProperty("addressu")&&texture.addressU!==JSON_ADDRESS_MODE$1[asset.data.addressu]&&(texture.addressU=JSON_ADDRESS_MODE$1[asset.data.addressu]),asset.data.hasOwnProperty("addressv")&&texture.addressV!==JSON_ADDRESS_MODE$1[asset.data.addressv]&&(texture.addressV=JSON_ADDRESS_MODE$1[asset.data.addressv]),asset.data.hasOwnProperty("mipmaps")&&texture.mipmaps!==asset.data.mipmaps&&(texture.mipmaps=asset.data.mipmaps),asset.data.hasOwnProperty("anisotropy")&&texture.anisotropy!==asset.data.anisotropy&&(texture.anisotropy=asset.data.anisotropy),asset.data.hasOwnProperty("rgbm"))){var type=asset.data.rgbm?"rgbm":"default";texture.type!==type&&(texture.type=type)}asset.resource.texture=texture;var frames={};for(var key in asset.data.frames){var frame=asset.data.frames[key];frames[key]={rect:new Vec4(frame.rect),pivot:new Vec2(frame.pivot),border:new Vec4(frame.border)}}asset.resource.frames=frames,asset.off("change",this._onAssetChange,this),asset.on("change",this._onAssetChange,this)},_proto._onAssetChange=function _onAssetChange(asset,attribute,value){var frame;if("data"===attribute||"data.frames"===attribute){var frames={};for(var key in value.frames)frame=value.frames[key],frames[key]={rect:new Vec4(frame.rect),pivot:new Vec2(frame.pivot),border:new Vec4(frame.border)};asset.resource.frames=frames}else{var match=attribute.match(regexFrame);if(match){var frameKey=match[1];value?(asset.resource.frames[frameKey]?((frame=asset.resource.frames[frameKey]).rect.set(value.rect[0],value.rect[1],value.rect[2],value.rect[3]),frame.pivot.set(value.pivot[0],value.pivot[1]),frame.border.set(value.border[0],value.border[1],value.border[2],value.border[3])):asset.resource.frames[frameKey]={rect:new Vec4(value.rect),pivot:new Vec2(value.pivot),border:new Vec4(value.border)},asset.resource.fire("set:frame",frameKey,asset.resource.frames[frameKey])):asset.resource.frames[frameKey]&&(delete asset.resource.frames[frameKey],asset.resource.fire("remove:frame",frameKey))}}},TextureAtlasHandler}();function BasisWorker(){var BASIS_FORMAT_cTFETC1=0,BASIS_FORMAT_cTFETC2=1,BASIS_FORMAT_cTFBC1=2,BASIS_FORMAT_cTFBC3=3,BASIS_FORMAT_cTFPVRTC1_4_RGB=8,BASIS_FORMAT_cTFPVRTC1_4_RGBA=9,BASIS_FORMAT_cTFASTC_4x4=10,BASIS_FORMAT_cTFATC_RGB=11,BASIS_FORMAT_cTFATC_RGBA_INTERPOLATED_ALPHA=12,BASIS_FORMAT_cTFRGBA32=13,BASIS_FORMAT_cTFRGB565=14,BASIS_FORMAT_cTFRGBA4444=16,opaqueMapping={astc:BASIS_FORMAT_cTFASTC_4x4,dxt:BASIS_FORMAT_cTFBC1,etc2:BASIS_FORMAT_cTFETC1,etc1:BASIS_FORMAT_cTFETC1,pvr:BASIS_FORMAT_cTFPVRTC1_4_RGB,atc:BASIS_FORMAT_cTFATC_RGB,none:BASIS_FORMAT_cTFRGB565},alphaMapping={astc:BASIS_FORMAT_cTFASTC_4x4,dxt:BASIS_FORMAT_cTFBC3,etc2:BASIS_FORMAT_cTFETC2,etc1:BASIS_FORMAT_cTFRGBA4444,pvr:BASIS_FORMAT_cTFPVRTC1_4_RGBA,atc:BASIS_FORMAT_cTFATC_RGBA_INTERPOLATED_ALPHA,none:BASIS_FORMAT_cTFRGBA4444},basisToEngineMapping={};basisToEngineMapping[BASIS_FORMAT_cTFETC1]=21,basisToEngineMapping[BASIS_FORMAT_cTFETC2]=23,basisToEngineMapping[BASIS_FORMAT_cTFBC1]=8,basisToEngineMapping[BASIS_FORMAT_cTFBC3]=10,basisToEngineMapping[BASIS_FORMAT_cTFPVRTC1_4_RGB]=26,basisToEngineMapping[BASIS_FORMAT_cTFPVRTC1_4_RGBA]=27,basisToEngineMapping[BASIS_FORMAT_cTFASTC_4x4]=28,basisToEngineMapping[BASIS_FORMAT_cTFATC_RGB]=29,basisToEngineMapping[BASIS_FORMAT_cTFATC_RGBA_INTERPOLATED_ALPHA]=30,basisToEngineMapping[BASIS_FORMAT_cTFRGBA32]=7,basisToEngineMapping[BASIS_FORMAT_cTFRGB565]=3,basisToEngineMapping[BASIS_FORMAT_cTFRGBA4444]=5;var hasPerformance="undefined"!=typeof performance,unswizzleGGGR=function unswizzleGGGR(data){for(var genB=function genB(R,G){var r=R*(2/255)-1,g=G*(2/255)-1,b=Math.sqrt(1-Math.min(1,r*r+g*g));return Math.max(0,Math.min(255,Math.floor(.5*(b+1)*255)))},offset=0;offset<data.length;offset+=4){var R=data[offset+3],G=data[offset+1];data[offset+0]=R,data[offset+2]=genB(R,G),data[offset+3]=255}return data},pack565=function pack565(data){for(var result=new Uint16Array(data.length/4),offset=0;offset<data.length;offset+=4){var R=data[offset+0],G=data[offset+1],B=data[offset+2];result[offset/4]=(248&R)<<8|(252&G)<<3|B>>3}return result},transcode=function transcode(basis,url,format,data,options){var funcStart=hasPerformance?performance.now():0,basisFile=new basis.BasisFile(new Uint8Array(data)),width=basisFile.getImageWidth(0,0),height=basisFile.getImageHeight(0,0),images=basisFile.getNumImages(),levels=basisFile.getNumLevels(0),hasAlpha=!!basisFile.getHasAlpha();if(!(width&&height&&images&&levels))throw basisFile.close(),basisFile.delete(),new Error("Invalid image dimensions url="+url+" width="+width+" height="+height+" images="+images+" levels="+levels);var basisFormat=hasAlpha?alphaMapping[format]:opaqueMapping[format],i;if(basisFormat!==BASIS_FORMAT_cTFPVRTC1_4_RGB&&basisFormat!==BASIS_FORMAT_cTFPVRTC1_4_RGBA||0==(width&width-1)&&width===height||(basisFormat=basisFormat===BASIS_FORMAT_cTFPVRTC1_4_RGB?BASIS_FORMAT_cTFRGB565:BASIS_FORMAT_cTFRGBA32),options&&options.unswizzleGGGR&&(basisFormat=BASIS_FORMAT_cTFRGBA32),!basisFile.startTranscoding())throw basisFile.close(),basisFile.delete(),new Error("Failed to start transcoding url="+url);for(var levelData=[],mip=0;mip<levels;++mip){var dstSize=basisFile.getImageTranscodedSizeInBytes(0,mip,basisFormat),dst=new Uint8Array(dstSize);if(!basisFile.transcodeImage(dst,0,mip,basisFormat,1,0))throw basisFile.close(),basisFile.delete(),new Error("Failed to transcode image url="+url);if(basisFormat===BASIS_FORMAT_cTFRGB565||basisFormat===BASIS_FORMAT_cTFRGBA4444){var dst16=new Uint16Array(dstSize/2);for(i=0;i<dstSize/2;++i)dst16[i]=dst[2*i]+256*dst[2*i+1];dst=dst16}levelData.push(dst)}if(basisFile.close(),basisFile.delete(),options&&options.unswizzleGGGR)for(basisFormat=BASIS_FORMAT_cTFRGB565,i=0;i<levelData.length;++i)levelData[i]=pack565(unswizzleGGGR(levelData[i]));return{format:basisToEngineMapping[basisFormat],width:width+3&-4,height:height+3&-4,levels:levelData,cubemap:!1,mipmaps:!0,transcodeTime:hasPerformance?performance.now()-funcStart:0,url:url}},basis=null,queue=[],workerTranscode=function workerTranscode(url,format,data,options){try{var result=transcode(basis,url,format,data,options);result.levels=result.levels.map((function(v){return v.buffer})),self.postMessage({url:url,data:result},result.levels)}catch(err){self.postMessage({url:url.toString(),err:err.toString()})}},workerInit=function workerInit(basisModule){var instantiateWasmFunc=function instantiateWasmFunc(imports,successCallback){return WebAssembly.instantiate(basisModule,imports).then((function(result){successCallback(result)})),{}};self.BASIS(basisModule?{instantiateWasm:instantiateWasmFunc}:null).then((function(instance){(basis=instance).initializeBasis();for(var i=0;i<queue.length;++i)workerTranscode(queue[i].url,queue[i].format,queue[i].data,queue[i].options);queue=[]}))};self.onmessage=function(message){var data=message.data;switch(data.type){case"init":workerInit(data.module);break;case"transcode":basis?workerTranscode(data.url,data.format,data.data,data.options):queue.push(data)}}}var wasmSupported=function(){try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){var module=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(module instanceof WebAssembly.Module)return new WebAssembly.Instance(module)instanceof WebAssembly.Instance}}catch(e){}return!1}();function chooseTargetFormat(device){return device.extCompressedTextureASTC?"astc":device.extCompressedTextureS3TC?"dxt":device.extCompressedTextureETC?"etc2":device.extCompressedTextureETC1?"etc1":device.extCompressedTexturePVRTC?"pvr":device.extCompressedTextureATC?"atc":"none"}var downloadInitiated=!1,downloadConfig=null,worker=null,format=null,callbacks={},transcodeQueue=[];function basisTargetFormat(){return format||(format=chooseTargetFormat(getApplication().graphicsDevice)),format}function handleWorkerResponse(message){var url=message.data.url,err=message.data.err,data=message.data.data,callback=callbacks[url],i;if(callback)if(err)for(i=0;i<callback.length;++i)callback[i](err);else{for(3===data.format||5===data.format?data.levels=data.levels.map((function(v){return new Uint16Array(v)})):data.levels=data.levels.map((function(v){return new Uint8Array(v)})),i=0;i<callback.length;++i)callback[i](null,data);delete callbacks[url]}else console.error("internal logical error encountered in basis transcoder")}function transcode(url,data,callback,options){callbacks.hasOwnProperty(url)?callbacks[url].push(callback):(callbacks[url]=[callback],worker.postMessage({type:"transcode",url:url,format:basisTargetFormat(),data:data,options:options},[data]))}function basisInitialize(basisCode,basisModule,callback){var code=["/* basis.js */",basisCode,"","/* worker */","("+BasisWorker.toString()+")()\n\n"].join("\n"),blob=new Blob([code],{type:"application/javascript"}),url=URL.createObjectURL(blob);(worker=new Worker(url)).addEventListener("message",handleWorkerResponse),worker.postMessage({type:"init",module:basisModule}),callback&&callback();for(var i=0;i<transcodeQueue.length;++i){var entry=transcodeQueue[i];transcode(entry.url,entry.data,entry.callback,entry.options)}}function basisDownload(glueUrl,wasmUrl,fallbackUrl,callback){if(downloadInitiated&&console.warn("basis module is being downloaded more than once"),downloadInitiated=!0,wasmSupported){var glueCode=null,compiledModule=null,downloadCompleted=function downloadCompleted(){glueCode&&compiledModule&&basisInitialize(glueCode,compiledModule,callback)},performHttpDownload=function performHttpDownload(){http.get(wasmUrl,{cache:!0,responseType:"arraybuffer",retry:!1},(function(err,result){result&&WebAssembly.compile(result).then((function(result){compiledModule=result,downloadCompleted()}))}))};WebAssembly.compileStreaming?WebAssembly.compileStreaming(fetch(wasmUrl)).then((function(result){compiledModule=result,downloadCompleted()})).catch((function(reason){console.error(reason),console.warn("compileStreaming() failed for "+wasmUrl+", falling back to arraybuffer download..."),performHttpDownload()})):performHttpDownload(),http.get(glueUrl,{cache:!0,responseType:"text",retry:!1},(function(err,result){glueCode=result,downloadCompleted()}))}else http.get(fallbackUrl,{cache:!0,responseType:"text",retry:!1},(function(err,result){result&&basisInitialize(result,null,callback)}))}function basisSetDownloadConfig(glueUrl,wasmUrl,fallbackUrl){downloadConfig={glueUrl:glueUrl,wasmUrl:wasmUrl,fallbackUrl:fallbackUrl}}function basisDownloadFromConfig(callback){if(downloadConfig)basisDownload(downloadConfig.glueUrl,downloadConfig.wasmUrl,downloadConfig.fallbackUrl,callback);else{var modules,wasmModule=((window.config?window.config.wasmModules:window.PRELOAD_MODULES)||[]).find((function(m){return"BASIS"===m.moduleName}));if(!wasmModule)return!1;var urlBase=window.ASSET_PREFIX?window.ASSET_PREFIX:"";basisDownload(urlBase+wasmModule.glueUrl,urlBase+wasmModule.wasmUrl,urlBase+wasmModule.fallbackUrl,callback)}return!0}function basisTranscode(url,data,callback,options){if(worker)transcode(url,data,callback,options);else if(transcodeQueue.push({url:url,data:data,callback:callback,options:options}),!downloadInitiated)return basisDownloadFromConfig();return!0}var BasisParser=function(){function BasisParser(registry){this.maxRetries=0}var _proto=BasisParser.prototype;return _proto.load=function load(url,callback,asset){var options={cache:!0,responseType:"arraybuffer",retry:this.maxRetries>0,maxRetries:this.maxRetries};http.get(url.load,options,(function(err,result){if(err)callback(err,result);else{var unswizzleGGGR="pvr"===basisTargetFormat()&&asset&&asset.file&&asset.file.variants&&asset.file.variants.basis&&0!=(8&asset.file.variants.basis.opt),basisModuleFound;unswizzleGGGR&&(asset.file.variants.basis.opt&=-9),basisTranscode(url.load,result,callback,{unswizzleGGGR:unswizzleGGGR})||callback('Basis module not found. Asset "'+asset.name+'" basis texture variant will not be loaded.')}}))},_proto.open=function open(url,data,device){var texture=new Texture(device,{name:url,addressU:data.cubemap?1:0,addressV:data.cubemap?1:0,width:data.width,height:data.height,format:data.format,cubemap:data.cubemap,levels:data.levels});return texture.upload(),texture},BasisParser}(),ImgParser=function(){function ImgParser(registry){this.crossOrigin=registry.prefix?"anonymous":null,this.maxRetries=0,this.useImageBitmap=!1}var _proto=ImgParser.prototype;return _proto.load=function load(url,callback,asset){var crossOrigin;asset&&asset.options&&asset.options.hasOwnProperty("crossOrigin")?crossOrigin=asset.options.crossOrigin:ABSOLUTE_URL.test(url.load)&&(crossOrigin=this.crossOrigin),this.useImageBitmap?this._loadImageBitmap(url.load,url.original,crossOrigin,callback):this._loadImage(url.load,url.original,crossOrigin,callback)},_proto.open=function open(url,data,device){var ext=path.getExtension(url).toLowerCase(),format=".jpg"===ext||".jpeg"===ext?6:7,texture=new Texture(device,{name:url,width:data.width,height:data.height,format:format});return texture.setSource(data),texture},_proto._loadImage=function _loadImage(url,originalUrl,crossOrigin,callback){var image=new Image;crossOrigin&&(image.crossOrigin=crossOrigin);var retries=0,maxRetries=this.maxRetries,retryTimeout;image.onload=function(){callback(null,image)},image.onerror=function(){if(!retryTimeout)if(maxRetries>0&&++retries<=maxRetries){var retryDelay=100*Math.pow(2,retries);console.log("Error loading Texture from: '"+originalUrl+"' - Retrying in "+retryDelay+"ms...");var idx,separator=url.indexOf("?")>=0?"&":"?";retryTimeout=setTimeout((function(){image.src=url+separator+"retry="+Date.now(),retryTimeout=null}),retryDelay)}else callback("Error loading Texture from: '"+originalUrl+"'")},image.src=url},_proto._loadImageBitmap=function _loadImageBitmap(url,originalUrl,crossOrigin,callback){var options={cache:!0,responseType:"blob",retry:this.maxRetries>0,maxRetries:this.maxRetries};http.get(url,options,(function(err,blob){err?callback(err):createImageBitmap(blob,{premultiplyAlpha:"none",imageOrientation:"flipY"}).then((function(imageBitmap){callback(null,imageBitmap)})).catch((function(e){callback(e)}))}))},ImgParser}(),IDENTIFIER=[1481919403,3140563232,169478669],KNOWN_FORMATS={33776:8,33778:9,33779:10,36196:21,37492:22,37496:23,35840:26,35841:24,35842:27,35843:25,32849:6,32856:7,35905:19,35907:20,35898:18,34843:11,34842:12};function createContainer(pixelFormat,buffer,byteOffset,byteSize){return 18===pixelFormat?new Uint32Array(buffer,byteOffset,byteSize/4):new Uint8Array(buffer,byteOffset,byteSize)}var KtxParser=function(){function KtxParser(registry){this.maxRetries=0}var _proto=KtxParser.prototype;return _proto.load=function load(url,callback,asset){var options={cache:!0,responseType:"arraybuffer",retry:this.maxRetries>0,maxRetries:this.maxRetries};http.get(url.load,options,callback)},_proto.open=function open(url,data,device){var textureData=this.parse(data);if(!textureData)return null;var texture=new Texture(device,{name:url,addressU:textureData.cubemap?1:0,addressV:textureData.cubemap?1:0,width:textureData.width,height:textureData.height,format:textureData.format,cubemap:textureData.cubemap,levels:textureData.levels});return texture.upload(),texture},_proto.parse=function parse(data){var dataU32=new Uint32Array(data);if(IDENTIFIER[0]!==dataU32[0]||IDENTIFIER[1]!==dataU32[1]||IDENTIFIER[2]!==dataU32[2])return null;var header={endianness:dataU32[3],glType:dataU32[4],glTypeSize:dataU32[5],glFormat:dataU32[6],glInternalFormat:dataU32[7],glBaseInternalFormat:dataU32[8],pixelWidth:dataU32[9],pixelHeight:dataU32[10],pixelDepth:dataU32[11],numberOfArrayElements:dataU32[12],numberOfFaces:dataU32[13],numberOfMipmapLevels:dataU32[14],bytesOfKeyValueData:dataU32[15]};if(header.pixelDepth>1)return null;if(0!==header.numberOfArrayElements)return null;var format=KNOWN_FORMATS[header.glInternalFormat];if(void 0===format)return null;for(var offset=16+header.bytesOfKeyValueData/4,isCubemap=header.numberOfFaces>1,levels=[],mipmapLevel=0;mipmapLevel<(header.numberOfMipmapLevels||1);mipmapLevel++){var imageSizeInBytes=dataU32[offset++];isCubemap&&levels.push([]);for(var target=isCubemap?levels[mipmapLevel]:levels,face=0;face<(isCubemap?6:1);++face)target.push(createContainer(format,data,4*offset,imageSizeInBytes)),offset+=imageSizeInBytes+3>>2}return{format:format,width:header.pixelWidth,height:header.pixelHeight,levels:levels,cubemap:isCubemap}},KtxParser}(),LegacyDdsParser=function(){function LegacyDdsParser(registry){this.maxRetries=0}var _proto=LegacyDdsParser.prototype;return _proto.load=function load(url,callback,asset){var options={cache:!0,responseType:"arraybuffer",retry:this.maxRetries>0,maxRetries:this.maxRetries};http.get(url.load,options,callback)},_proto.open=function open(url,data,device){var header=new Uint32Array(data,0,32),width=header[4],height=header[3],mips=Math.max(header[7],1),isFourCc=4===header[20],fcc=header[21],bpp=header[22],isCubemap=65024===header[28],FCC_DXT1=827611204,FCC_DXT5,FCC_FP32=116,FCC_ETC1,FCC_PVRTC_2BPP_RGB_1=825438800,FCC_PVRTC_2BPP_RGBA_1=825504336,FCC_PVRTC_4BPP_RGB_1=825439312,FCC_PVRTC_4BPP_RGBA_1=825504848,compressed=!1,floating=!1,etc1=!1,pvrtc2=!1,pvrtc4=!1,format=null,texture;if(isFourCc?fcc===FCC_DXT1?(format=8,compressed=!0):fcc===894720068?(format=10,compressed=!0):116===fcc?(format=14,floating=!0):fcc===826496069?(format=21,compressed=!0,etc1=!0):825438800===fcc||825504336===fcc?(format=825438800===fcc?24:25,compressed=!0,pvrtc2=!0):825439312!==fcc&&825504848!==fcc||(format=825439312===fcc?26:27,compressed=!0,pvrtc4=!0):32===bpp&&(format=7),!format)return(texture=new Texture(device,{width:4,height:4,format:6})).name="dds-legacy-empty",texture;texture=new Texture(device,{name:url,addressU:isCubemap?1:0,addressV:isCubemap?1:0,width:width,height:height,format:format,cubemap:isCubemap});for(var offset=128,faces=isCubemap?6:1,mipSize,DXT_BLOCK_WIDTH=4,DXT_BLOCK_HEIGHT=4,blockSize=fcc===FCC_DXT1?8:16,numBlocksAcross,numBlocksDown,numBlocks,face=0;face<faces;face++)for(var mipWidth=width,mipHeight=height,i=0;i<mips;i++){mipSize=compressed?etc1?Math.floor((mipWidth+3)/4)*Math.floor((mipHeight+3)/4)*8:pvrtc2?Math.max(mipWidth,16)*Math.max(mipHeight,8)/4:pvrtc4?Math.max(mipWidth,8)*Math.max(mipHeight,8)/2:(numBlocks=(numBlocksAcross=Math.floor((mipWidth+4-1)/4))*(numBlocksDown=Math.floor((mipHeight+4-1)/4)))*blockSize:mipWidth*mipHeight*4;var mipBuff=floating?new Float32Array(data,offset,mipSize):new Uint8Array(data,offset,mipSize);isCubemap?(texture._levels[i]||(texture._levels[i]=[]),texture._levels[i][face]=mipBuff):texture._levels[i]=mipBuff,offset+=floating?4*mipSize:mipSize,mipWidth=Math.max(.5*mipWidth,1),mipHeight=Math.max(.5*mipHeight,1)}return texture.upload(),texture},LegacyDdsParser}(),Reader=function(){function Reader(data){this.view=new DataView(data),this.offset=0}var _proto=Reader.prototype;return _proto.readLine=function readLine(){for(var view=this.view,result="";!(this.offset>=view.byteLength);){var c=String.fromCharCode(this.readUint8());if("\n"===c)break;result+=c}return result},_proto.readUint8=function readUint8(){return this.view.getUint8(this.offset++)},_proto.readUint8s=function readUint8s(result){for(var view=this.view,i=0;i<result.length;++i)result[i]=view.getUint8(this.offset++)},_proto.peekUint8s=function peekUint8s(result){for(var view=this.view,i=0;i<result.length;++i)result[i]=view.getUint8(this.offset+i)},Reader}(),HdrParser=function(){function HdrParser(registry){this.maxRetries=0}var _proto2=HdrParser.prototype;return _proto2.load=function load(url,callback,asset){var options={cache:!0,responseType:"arraybuffer",retry:this.maxRetries>0,maxRetries:this.maxRetries};http.get(url.load,options,callback)},_proto2.open=function open(url,data,device){var textureData=this.parse(data);if(!textureData)return null;var texture=new Texture(device,{name:url,addressU:0,addressV:1,minFilter:2,magFilter:0,width:textureData.width,height:textureData.height,levels:textureData.levels,format:7,type:"rgbe",mipmaps:!1});return texture.upload(),texture},_proto2.parse=function parse(data){var reader=new Reader(data),magic;if(!reader.readLine().startsWith("#?RADIANCE"))return this._error("radiance header has invalid magic"),null;for(var variables={};;){var line=reader.readLine();if(0===line.length)break;var parts=line.split("=");2===parts.length&&(variables[parts[0]]=parts[1])}if(!variables.hasOwnProperty("FORMAT"))return this._error("radiance header missing FORMAT variable"),null;var resolution=reader.readLine().split(" ");if(4!==resolution.length)return this._error("radiance header has invalid resolution"),null;var height=parseInt(resolution[1],10),width=parseInt(resolution[3],10),pixels=this._readPixels(reader,width,height,"-Y"===resolution[0]);return pixels?{width:width,height:height,levels:[pixels]}:null},_proto2._readPixels=function _readPixels(reader,width,height,flipY){if(width<8||width>32767)return this._readPixelsFlat(reader,width,height);var rgbe=[0,0,0,0];if(reader.peekUint8s(rgbe),2!==rgbe[0]||2!==rgbe[1]||0!=(128&rgbe[2]))return this._readPixelsFlat(reader,width,height);var buffer=new ArrayBuffer(width*height*4),view=new Uint8Array(buffer),scanstart=flipY?4*width*(height-1):0,x,y,i,channel,count,value;for(y=0;y<height;++y){if(reader.readUint8s(rgbe),(rgbe[2]<<8)+rgbe[3]!==width)return this._error("radiance has invalid scanline width"),null;for(channel=0;channel<4;++channel)for(x=0;x<width;)if((count=reader.readUint8())>128){if(x+(count-=128)>width)return this._error("radiance has invalid scanline data"),null;for(value=reader.readUint8(),i=0;i<count;++i)view[scanstart+channel+4*x++]=value}else{if(0===count||x+count>width)return this._error("radiance has invalid scanline data"),null;for(i=0;i<count;++i)view[scanstart+channel+4*x++]=reader.readUint8()}scanstart+=4*width*(flipY?-1:1)}return view},_proto2._readPixelsFlat=function _readPixelsFlat(reader,width,height){var filePixelBytes;return reader.view.buffer.byteLength-reader.offset===width*height*4?new Uint8Array(reader.view.buffer,reader.offset):null},_proto2._error=function _error(message){},HdrParser}(),JSON_ADDRESS_MODE={repeat:0,clamp:1,mirror:2},JSON_FILTER_MODE={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},JSON_TEXTURE_TYPE={default:"default",rgbm:"rgbm",rgbe:"rgbe",swizzleGGGR:"swizzleGGGR"},TextureParser=function(){function TextureParser(){}var _proto=TextureParser.prototype;return _proto.load=function load(url,callback,asset){throw new Error("not implemented")},_proto.open=function open(url,data,device){throw new Error("not implemented")},TextureParser}(),_completePartialMipmapChain=function _completePartialMipmapChain(texture){var requiredMipLevels=Math.log2(Math.max(texture._width,texture._height))+1,isHtmlElement=function isHtmlElement(object){return object instanceof HTMLCanvasElement||object instanceof HTMLImageElement||object instanceof HTMLVideoElement};if(!(7!==texture._format&&14!==texture._format||texture._volume||texture._compressed||1===texture._levels.length||texture._levels.length===requiredMipLevels||isHtmlElement(texture._cubemap?texture._levels[0][0]:texture._levels[0]))){for(var downsample=function downsample(width,height,data){for(var sampledWidth=Math.max(1,width>>1),sampledHeight=Math.max(1,height>>1),sampledData=new data.constructor(sampledWidth*sampledHeight*4),xs=Math.floor(width/sampledWidth),ys=Math.floor(height/sampledHeight),xsys=xs*ys,y=0;y<sampledHeight;++y)for(var x=0;x<sampledWidth;++x)for(var e=0;e<4;++e){for(var sum=0,sy=0;sy<ys;++sy)for(var sx=0;sx<xs;++sx)sum+=data[4*(x*xs+sx+(y*ys+sy)*width)+e];sampledData[4*(x+y*sampledWidth)+e]=sum/xsys}return sampledData},level=texture._levels.length;level<requiredMipLevels;++level){var width=Math.max(1,texture._width>>level-1),height=Math.max(1,texture._height>>level-1);if(texture._cubemap){for(var mips=[],face=0;face<6;++face)mips.push(downsample(width,height,texture._levels[level-1][face]));texture._levels.push(mips)}else texture._levels.push(downsample(width,height,texture._levels[level-1]))}texture._levelsUpdated=texture._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0]}},TextureHandler=function(){function TextureHandler(device,assets,loader){this._device=device,this._assets=assets,this._loader=loader,this.imgParser=new ImgParser(assets),this.parsers={dds:new LegacyDdsParser(assets),ktx:new KtxParser(assets),basis:new BasisParser(assets),hdr:new HdrParser(assets)}}var _proto2=TextureHandler.prototype;return _proto2._getUrlWithoutParams=function _getUrlWithoutParams(url){return url.indexOf("?")>=0?url.split("?")[0]:url},_proto2._getParser=function _getParser(url){var ext=path.getExtension(this._getUrlWithoutParams(url)).toLowerCase().replace(".","");return this.parsers[ext]||this.imgParser},_proto2.load=function load(url,callback,asset){"string"==typeof url&&(url={load:url,original:url}),this._getParser(url.original).load(url,callback,asset)},_proto2.open=function open(url,data,asset){if(url){var texture=this._getParser(url).open(url,data,this._device);return null===texture?texture=new Texture(this._device,{width:4,height:4,format:6}):_completePartialMipmapChain(texture),texture}},_proto2.patch=function patch(asset,assets){var texture=asset.resource;if(texture){asset.name&&asset.name.length>0&&(texture.name=asset.name);var assetData=asset.data;if(assetData.hasOwnProperty("minfilter")&&(texture.minFilter=JSON_FILTER_MODE[assetData.minfilter]),assetData.hasOwnProperty("magfilter")&&(texture.magFilter=JSON_FILTER_MODE[assetData.magfilter]),texture.cubemap||(assetData.hasOwnProperty("addressu")&&(texture.addressU=JSON_ADDRESS_MODE[assetData.addressu]),assetData.hasOwnProperty("addressv")&&(texture.addressV=JSON_ADDRESS_MODE[assetData.addressv])),assetData.hasOwnProperty("mipmaps")&&(texture.mipmaps=assetData.mipmaps),assetData.hasOwnProperty("anisotropy")&&(texture.anisotropy=assetData.anisotropy),assetData.hasOwnProperty("flipY")&&(texture.flipY=!!assetData.flipY),assetData.hasOwnProperty("type"))texture.type=JSON_TEXTURE_TYPE[assetData.type];else if(assetData.hasOwnProperty("rgbm")&&assetData.rgbm)texture.type="rgbm";else if(asset.file&&asset.getPreferredFile){var preferredFile=asset.getPreferredFile();preferredFile&&preferredFile.opt&&0!=(8&preferredFile.opt)&&(texture.type="swizzleGGGR")}}},_createClass(TextureHandler,[{key:"crossOrigin",get:function get(){return this.imgParser.crossOrigin},set:function set(value){this.imgParser.crossOrigin=value}},{key:"maxRetries",get:function get(){return this.imgParser.maxRetries},set:function set(value){for(var parser in this.imgParser.maxRetries=value,this.parsers)this.parsers.hasOwnProperty(parser)&&(this.parsers[parser].maxRetries=value)}}]),TextureHandler}(),TagsCache=function(){function TagsCache(key){void 0===key&&(key=null),this._index={},this._key=key}var _proto=TagsCache.prototype;return _proto.addItem=function addItem(item){for(var tags,_iterator=_createForOfIteratorHelperLoose(item.tags._list),_step;!(_step=_iterator()).done;){var tag=_step.value;this.add(tag,item)}},_proto.removeItem=function removeItem(item){for(var tags,_iterator2=_createForOfIteratorHelperLoose(item.tags._list),_step2;!(_step2=_iterator2()).done;){var tag=_step2.value;this.remove(tag,item)}},_proto.add=function add(tag,item){this._index[tag]&&-1!==this._index[tag].list.indexOf(item)||(this._index[tag]||(this._index[tag]={list:[]},this._key&&(this._index[tag].keys={})),this._index[tag].list.push(item),this._key&&(this._index[tag].keys[item[this._key]]=item))},_proto.remove=function remove(tag,item){if(this._index[tag]&&(!this._key||this._index[tag].keys[item[this._key]])){var ind=this._index[tag].list.indexOf(item);-1!==ind&&(this._index[tag].list.splice(ind,1),this._key&&delete this._index[tag].keys[item[this._key]],0===this._index[tag].list.length&&delete this._index[tag])}},_proto.find=function find(args){for(var _this=this,index={},items=[],item,tag,tags,tagsRest,missingIndex,sort=function sort(a,b){return _this._index[a].list.length-_this._index[b].list.length},i=0;i<args.length;i++){if((tag=args[i])instanceof Array){if(0===tag.length)continue;if(1!==tag.length){missingIndex=!1;for(var t=0;t<tag.length;t++)if(!this._index[tag[t]]){missingIndex=!0;break}if(missingIndex)continue;1===(tagsRest=(tags=tag.slice(0).sort(sort)).slice(1)).length&&(tagsRest=tagsRest[0]);for(var n=0;n<this._index[tags[0]].list.length;n++)item=this._index[tags[0]].list[n],(this._key?!index[item[this._key]]:-1===items.indexOf(item))&&item.tags.has(tagsRest)&&(this._key&&(index[item[this._key]]=!0),items.push(item));continue}tag=tag[0]}if(tag&&"string"==typeof tag&&this._index[tag])for(var _n=0;_n<this._index[tag].list.length;_n++)item=this._index[tag].list[_n],this._key?index[item[this._key]]||(index[item[this._key]]=!0,items.push(item)):-1===items.indexOf(item)&&items.push(item)}return items},TagsCache}(),AssetRegistry=function(_EventHandler){function AssetRegistry(loader){var _this;return(_this=_EventHandler.call(this)||this)._loader=loader,_this._assets=[],_this._cache={},_this._names={},_this._tags=new TagsCache("_id"),_this._urls={},_this.prefix=null,_this}_inheritsLoose(AssetRegistry,_EventHandler);var _proto=AssetRegistry.prototype;return _proto.list=function list(filters){return filters=filters||{},this._assets.filter((function(asset){var include=!0;return void 0!==filters.preload&&(include=asset.preload===filters.preload),include}))},_proto.add=function add(asset){var index=this._assets.push(asset)-1,url;this._cache[asset.id]=index,this._names[asset.name]||(this._names[asset.name]=[]),this._names[asset.name].push(index),asset.file&&(url=asset.file.url,this._urls[url]=index),asset.registry=this,this._tags.addItem(asset),asset.tags.on("add",this._onTagAdd,this),asset.tags.on("remove",this._onTagRemove,this),this.fire("add",asset),this.fire("add:"+asset.id,asset),url&&this.fire("add:url:"+url,asset),asset.preload&&this.load(asset)},_proto.remove=function remove(asset){var idx=this._cache[asset.id],url=asset.file?asset.file.url:null;if(void 0!==idx){this._assets.splice(idx,1),delete this._cache[asset.id],this._names={},this._urls=[];for(var i=0,l=this._assets.length;i<l;i++){var a=this._assets[i];this._cache[a.id]=i,this._names[a.name]||(this._names[a.name]=[]),this._names[a.name].push(i),a.file&&(this._urls[a.file.url]=i)}return this._tags.removeItem(asset),asset.tags.off("add",this._onTagAdd,this),asset.tags.off("remove",this._onTagRemove,this),asset.fire("remove",asset),this.fire("remove",asset),this.fire("remove:"+asset.id,asset),url&&this.fire("remove:url:"+url,asset),!0}return!1},_proto.get=function get(id){var idx=this._cache[id];return this._assets[idx]},_proto.getByUrl=function getByUrl(url){var idx=this._urls[url];return this._assets[idx]},_proto.load=function load(asset){if(!asset.loading&&!asset.loaded){var self=this,file=asset.getPreferredFile(),_opened=function _opened(resource){resource instanceof Array?asset.resources=resource:asset.resource=resource,self._loader.patch(asset,self),self.fire("load",asset),self.fire("load:"+asset.id,asset),file&&file.url&&self.fire("load:url:"+file.url,asset),asset.fire("load",asset)},_loaded=function _loaded(err,resource,extra){if(asset.loaded=!0,asset.loading=!1,err)self.fire("error",err,asset),self.fire("error:"+asset.id,err,asset),asset.fire("error",err,asset);else{if(!script.legacy&&"script"===asset.type){var handler=self._loader.getHandler("script");handler._cache[asset.id]&&handler._cache[asset.id].parentNode===document.head&&document.head.removeChild(handler._cache[asset.id]),handler._cache[asset.id]=extra}_opened(resource)}};if(file||"cubemap"===asset.type)this.fire("load:start",asset),this.fire("load:"+asset.id+":start",asset),asset.loading=!0,self._loader.load(asset.getFileUrl(),asset.type,_loaded,asset);else{var resource=self._loader.open(asset.type,asset.data);asset.loaded=!0,_opened(resource)}}},_proto.loadFromUrl=function loadFromUrl(url,type,callback){this.loadFromUrlAndFilename(url,null,type,callback)},_proto.loadFromUrlAndFilename=function loadFromUrlAndFilename(url,filename,type,callback){var self=this,name=path.getBasename(filename||url),file={filename:filename||name,url:url},asset=self.getByUrl(url);if(asset){if(asset.loaded)return void callback(asset.loadFromUrlError||null,asset)}else asset=new Asset(name,type,file),self.add(asset);var startLoad=function startLoad(asset){asset.once("load",(function(loadedAsset){"material"===type?self._loadTextures(loadedAsset,(function(err,textures){callback(err,loadedAsset)})):callback(null,loadedAsset)})),asset.once("error",(function(err){err&&(this.loadFromUrlError=err),callback(err,asset)})),self.load(asset)};asset.resource?callback(null,asset):"model"===type?self._loadModel(asset,startLoad):startLoad(asset)},_proto._loadModel=function _loadModel(modelAsset,continuation){var self=this,url=modelAsset.getFileUrl(),ext=path.getExtension(url);if(".json"===ext||".glb"===ext){var dir=path.getDirectory(url),basename=path.getBasename(url),mappingUrl=path.join(dir,basename.replace(ext,".mapping.json"));this._loader.load(mappingUrl,"json",(function(err,data){err?(modelAsset.data={mapping:[]},continuation(modelAsset)):self._loadMaterials(modelAsset,data,(function(e,materials){modelAsset.data=data,continuation(modelAsset)}))}))}else continuation(modelAsset)},_proto._loadMaterials=function _loadMaterials(modelAsset,mapping,callback){for(var self=this,materials=[],count=0,onMaterialLoaded=function onMaterialLoaded(err,materialAsset){self._loadTextures(materialAsset,(function(err,textures){materials.push(materialAsset),materials.length===count&&callback(null,materials)}))},i=0;i<mapping.mapping.length;i++){var path=mapping.mapping[i].path;path&&(count++,self.loadFromUrl(modelAsset.getAbsoluteUrl(path),"material",onMaterialLoaded))}0===count&&callback(null,materials)},_proto._loadTextures=function _loadTextures(materialAsset,callback){var self=this,textures=[],count=0,data=materialAsset.data;if("path"===data.mappingFormat){for(var onTextureLoaded=function onTextureLoaded(err,texture){err&&console.error(err),textures.push(texture),textures.length===count&&callback(null,textures)},texParams=standardMaterialTextureParameters,i=0;i<texParams.length;i++){var path=data[texParams[i]];path&&"string"==typeof path&&(count++,this.loadFromUrl(materialAsset.getAbsoluteUrl(path),"texture",onTextureLoaded))}0===count&&callback(null,textures)}else callback(null,textures)},_proto.findAll=function findAll(name,type){var self=this,idxs=this._names[name];if(idxs){var assets=idxs.map((function(idx){return self._assets[idx]}));return type?assets.filter((function(asset){return asset.type===type})):assets}return[]},_proto._onTagAdd=function _onTagAdd(tag,asset){this._tags.add(tag,asset)},_proto._onTagRemove=function _onTagRemove(tag,asset){this._tags.remove(tag,asset)},_proto.findByTag=function findByTag(){return this._tags.find(arguments)},_proto.filter=function filter(callback){for(var items=[],i=0,len=this._assets.length;i<len;i++)callback(this._assets[i])&&items.push(this._assets[i]);return items},_proto.find=function find(name,type){var asset=this.findAll(name,type);return asset.length>0?asset[0]:null},AssetRegistry}(EventHandler),BundleRegistry=function(){function BundleRegistry(assets){this._assets=assets,this._bundleAssets={},this._assetsInBundles={},this._urlsInBundles={},this._fileRequests={},this._assets.on("add",this._onAssetAdded,this),this._assets.on("remove",this._onAssetRemoved,this)}var _proto=BundleRegistry.prototype;return _proto._onAssetAdded=function _onAssetAdded(asset){if("bundle"===asset.type){this._bundleAssets[asset.id]=asset,this._registerBundleEventListeners(asset.id);for(var i=0,len=asset.data.assets.length;i<len;i++)this._indexAssetInBundle(asset.data.assets[i],asset)}else this._assetsInBundles[asset.id]&&this._indexAssetFileUrls(asset)},_proto._registerBundleEventListeners=function _registerBundleEventListeners(bundleAssetId){this._assets.on("load:"+bundleAssetId,this._onBundleLoaded,this),this._assets.on("error:"+bundleAssetId,this._onBundleError,this)},_proto._unregisterBundleEventListeners=function _unregisterBundleEventListeners(bundleAssetId){this._assets.off("load:"+bundleAssetId,this._onBundleLoaded,this),this._assets.off("error:"+bundleAssetId,this._onBundleError,this)},_proto._indexAssetInBundle=function _indexAssetInBundle(assetId,bundleAsset){if(this._assetsInBundles[assetId]){var bundles=this._assetsInBundles[assetId],idx;-1===bundles.indexOf(bundleAsset)&&bundles.push(bundleAsset)}else this._assetsInBundles[assetId]=[bundleAsset];var asset=this._assets.get(assetId);asset&&this._indexAssetFileUrls(asset)},_proto._indexAssetFileUrls=function _indexAssetFileUrls(asset){var urls=this._getAssetFileUrls(asset);if(urls)for(var i=0,len=urls.length;i<len;i++){var url=urls[i];this._urlsInBundles[url]=this._assetsInBundles[asset.id]}},_proto._getAssetFileUrls=function _getAssetFileUrls(asset){var url=asset.getFileUrl();if(!url)return null;var urls=[url=this._normalizeUrl(url)];if("font"===asset.type)for(var numFiles=asset.data.info.maps.length,i=1;i<numFiles;i++)urls.push(url.replace(".png",i+".png"));return urls},_proto._normalizeUrl=function _normalizeUrl(url){return url&&url.split("?")[0]},_proto._onAssetRemoved=function _onAssetRemoved(asset){if("bundle"===asset.type){var idx,id;for(id in delete this._bundleAssets[asset.id],this._unregisterBundleEventListeners(asset.id),this._assetsInBundles){var array=this._assetsInBundles[id];if(-1!==(idx=array.indexOf(asset))&&(array.splice(idx,1),!array.length))for(var url in delete this._assetsInBundles[id],this._urlsInBundles)this._urlsInBundles[url]===array&&delete this._urlsInBundles[url]}this._onBundleError("Bundle "+asset.id+" was removed",asset)}else if(this._assetsInBundles[asset.id]){delete this._assetsInBundles[asset.id];for(var urls=this._getAssetFileUrls(asset),i=0,len=urls.length;i<len;i++)delete this._urlsInBundles[urls[i]]}},_proto._onBundleLoaded=function _onBundleLoaded(bundleAsset){bundleAsset.resource?requestAnimationFrame(function(){if(this._fileRequests)for(var url in this._fileRequests){var bundles=this._urlsInBundles[url];if(bundles&&-1!==bundles.indexOf(bundleAsset)){var decodedUrl=decodeURIComponent(url),err=null;bundleAsset.resource.hasBlobUrl(decodedUrl)||(err="Bundle "+bundleAsset.id+" does not contain URL "+url);for(var requests=this._fileRequests[url],i=0,len=requests.length;i<len;i++)err?requests[i](err):requests[i](null,bundleAsset.resource.getBlobUrl(decodedUrl));delete this._fileRequests[url]}}}.bind(this)):this._onBundleError("Bundle "+bundleAsset.id+" failed to load",bundleAsset)},_proto._onBundleError=function _onBundleError(err,bundleAsset){for(var url in this._fileRequests){var bundle;if(!this._findLoadedOrLoadingBundleForUrl(url)){for(var requests=this._fileRequests[url],i=0,len=requests.length;i<len;i++)requests[i](err);delete this._fileRequests[url]}}},_proto._findLoadedOrLoadingBundleForUrl=function _findLoadedOrLoadingBundleForUrl(url){var bundles=this._urlsInBundles[url];if(!bundles)return null;var len=bundles.length,i;for(i=0;i<len;i++)if(bundles[i].loaded&&bundles[i].resource)return bundles[i];for(i=0;i<len;i++)if(bundles[i].loading)return bundles[i];return null},_proto.listBundlesForAsset=function listBundlesForAsset(asset){return this._assetsInBundles[asset.id]||null},_proto.list=function list(){var result=[];for(var id in this._bundleAssets)result.push(this._bundleAssets[id]);return result},_proto.hasUrl=function hasUrl(url){return!!this._urlsInBundles[url]},_proto.canLoadUrl=function canLoadUrl(url){return!!this._findLoadedOrLoadingBundleForUrl(url)},_proto.loadUrl=function loadUrl(url,callback){var bundle=this._findLoadedOrLoadingBundleForUrl(url);if(bundle)if(bundle.loaded){var decodedUrl=decodeURIComponent(url);if(!bundle.resource.hasBlobUrl(decodedUrl))return void callback("Bundle "+bundle.id+" does not contain URL "+url);callback(null,bundle.resource.getBlobUrl(decodedUrl))}else this._fileRequests.hasOwnProperty(url)?this._fileRequests[url].push(callback):this._fileRequests[url]=[callback];else callback("URL "+url+" not found in any bundles")},_proto.destroy=function destroy(){for(var id in this._assets.off("add",this._onAssetAdded,this),this._assets.off("remove",this._onAssetRemoved,this),this._bundleAssets)this._unregisterBundleEventListeners(id);this._assets=null,this._bundleAssets=null,this._assetsInBundles=null,this._urlsInBundles=null,this._fileRequests=null},BundleRegistry}(),ScriptRegistry=function(_EventHandler){function ScriptRegistry(app){var _this;return(_this=_EventHandler.call(this)||this).app=app,_this._scripts={},_this._list=[],_this}_inheritsLoose(ScriptRegistry,_EventHandler);var _proto=ScriptRegistry.prototype;return _proto.destroy=function destroy(){this.app=null,this.off()},_proto.add=function add(script){var self=this,scriptName=script.__name;return this._scripts.hasOwnProperty(scriptName)?(setTimeout((function(){if(script.prototype.swap){var old=self._scripts[scriptName],ind=self._list.indexOf(old);self._list[ind]=script,self._scripts[scriptName]=script,self.fire("swap",scriptName,script),self.fire("swap:"+scriptName,script)}else console.warn("script registry already has '"+scriptName+"' script, define 'swap' method for new script type to enable code hot swapping")})),!1):(this._scripts[scriptName]=script,this._list.push(script),this.fire("add",scriptName,script),this.fire("add:"+scriptName,script),setTimeout((function(){if(self._scripts.hasOwnProperty(scriptName)&&self.app&&self.app.systems&&self.app.systems.script){var components=self.app.systems.script._components,i,scriptInstance,attributes,scriptInstances=[],scriptInstancesInitialized=[];for(components.loopIndex=0;components.loopIndex<components.length;components.loopIndex++){var component=components.items[components.loopIndex];component._scriptsIndex[scriptName]&&component._scriptsIndex[scriptName].awaiting&&(component._scriptsData&&component._scriptsData[scriptName]&&(attributes=component._scriptsData[scriptName].attributes),(scriptInstance=component.create(scriptName,{preloading:!0,ind:component._scriptsIndex[scriptName].ind,attributes:attributes}))&&scriptInstances.push(scriptInstance))}for(i=0;i<scriptInstances.length;i++)scriptInstances[i].__initializeAttributes();for(i=0;i<scriptInstances.length;i++)scriptInstances[i].enabled&&(scriptInstances[i]._initialized=!0,scriptInstancesInitialized.push(scriptInstances[i]),scriptInstances[i].initialize&&scriptInstances[i].initialize());for(i=0;i<scriptInstancesInitialized.length;i++)scriptInstancesInitialized[i].enabled&&!scriptInstancesInitialized[i]._postInitialized&&(scriptInstancesInitialized[i]._postInitialized=!0,scriptInstancesInitialized[i].postInitialize&&scriptInstancesInitialized[i].postInitialize())}})),!0)},_proto.remove=function remove(nameOrType){var scriptType=nameOrType,scriptName=nameOrType;if("string"!=typeof scriptName?scriptName=scriptType.__name:scriptType=this.get(scriptName),this.get(scriptName)!==scriptType)return!1;delete this._scripts[scriptName];var ind=this._list.indexOf(scriptType);return this._list.splice(ind,1),this.fire("remove",scriptName,scriptType),this.fire("remove:"+scriptName,scriptType),!0},_proto.get=function get(name){return this._scripts[name]||null},_proto.has=function has(nameOrType){if("string"==typeof nameOrType)return this._scripts.hasOwnProperty(nameOrType);if(!nameOrType)return!1;var scriptName=nameOrType.__name;return this._scripts[scriptName]===nameOrType},_proto.list=function list(){return this._list},ScriptRegistry}(EventHandler),I18nParser=function(){function I18nParser(){}var _proto=I18nParser.prototype;return _proto._validate=function _validate(data){if(!data.header)throw new Error('pc.I18n#addData: Missing "header" field');if(!data.header.version)throw new Error('pc.I18n#addData: Missing "header.version" field');if(1!==data.header.version)throw new Error('pc.I18n#addData: Invalid "header.version" field');if(!data.data)throw new Error('pc.I18n#addData: Missing "data" field');if(!Array.isArray(data.data))throw new Error('pc.I18n#addData: "data" field must be an array');for(var i=0,len=data.data.length;i<len;i++){var entry=data.data[i];if(!entry.info)throw new Error('pc.I18n#addData: missing "data['+i+'].info" field');if(!entry.info.locale)throw new Error('pc.I18n#addData: missing "data['+i+'].info.locale" field');if("string"!=typeof entry.info.locale)throw new Error('pc.I18n#addData: "data['+i+'].info.locale" must be a string');if(!entry.messages)throw new Error('pc.I18n#addData: missing "data['+i+'].messages" field')}},_proto.parse=function parse(data){return data.data},I18nParser}(),I18n=function(_EventHandler){function I18n(app){var _this;return(_this=_EventHandler.call(this)||this).locale="en-US",_this._translations={},_this._availableLangs={},_this._app=app,_this._assets=[],_this._parser=new I18nParser,_this}_inheritsLoose(I18n,_EventHandler),I18n.findAvailableLocale=function findAvailableLocale$1(desiredLocale,availableLocales){return findAvailableLocale(desiredLocale,availableLocales)};var _proto=I18n.prototype;return _proto.getText=function getText(key,locale){var result=key,lang;locale||(locale=this._locale,lang=this._lang);var translations=this._translations[locale];return translations||(lang||(lang=getLang(locale)),locale=this._findFallbackLocale(locale,lang),translations=this._translations[locale]),translations&&translations.hasOwnProperty(key)&&(result=translations[key],Array.isArray(result)&&(result=result[0]),null==result&&(result=key)),result},_proto.getPluralText=function getPluralText(key,n,locale){var result=key,pluralFn,lang;locale?pluralFn=getPluralFn(lang=getLang(locale)):(locale=this._locale,lang=this._lang,pluralFn=this._pluralFn);var translations=this._translations[locale];if(translations||(pluralFn=getPluralFn(lang=getLang(locale=this._findFallbackLocale(locale,lang))),translations=this._translations[locale]),translations&&translations[key]&&pluralFn){var index=pluralFn(n);null==(result=translations[key][index])&&(result=key)}return result},_proto.addData=function addData(data){var parsed;try{parsed=this._parser.parse(data)}catch(err){return void console.error(err)}for(var i=0,len=parsed.length;i<len;i++){var entry=parsed[i],locale=entry.info.locale,messages=entry.messages;if(!this._translations[locale]){this._translations[locale]={};var lang=getLang(locale);this._availableLangs[lang]||(this._availableLangs[lang]=locale)}Object.assign(this._translations[locale],messages),this.fire("data:add",locale,messages)}},_proto.removeData=function removeData(data){var parsed,key;try{parsed=this._parser.parse(data)}catch(err){return void console.error(err)}for(var i=0,len=parsed.length;i<len;i++){var entry=parsed[i],locale=entry.info.locale,translations=this._translations[locale];if(translations){var messages=entry.messages;for(key in messages)delete translations[key];var hasAny=!1;for(key in translations){hasAny=!0;break}hasAny||(delete this._translations[locale],delete this._availableLangs[getLang(locale)]),this.fire("data:remove",locale,messages)}}},_proto.destroy=function destroy(){this._translations=null,this._availableLangs=null,this._assets=null,this._parser=null,this.off()},_proto._findFallbackLocale=function _findFallbackLocale(locale,lang){var result=DEFAULT_LOCALE_FALLBACKS[locale];return result&&this._translations[result]?result:(result=DEFAULT_LOCALE_FALLBACKS[lang])&&this._translations[result]?result:(result=this._availableLangs[lang])&&this._translations[result]?result:"en-US"},_proto._onAssetAdd=function _onAssetAdd(asset){asset.on("load",this._onAssetLoad,this),asset.on("change",this._onAssetChange,this),asset.on("remove",this._onAssetRemove,this),asset.on("unload",this._onAssetUnload,this),asset.resource&&this._onAssetLoad(asset)},_proto._onAssetLoad=function _onAssetLoad(asset){this.addData(asset.resource)},_proto._onAssetChange=function _onAssetChange(asset){asset.resource&&this.addData(asset.resource)},_proto._onAssetRemove=function _onAssetRemove(asset){asset.off("load",this._onAssetLoad,this),asset.off("change",this._onAssetChange,this),asset.off("remove",this._onAssetRemove,this),asset.off("unload",this._onAssetUnload,this),asset.resource&&this.removeData(asset.resource),this._app.assets.once("add:"+asset.id,this._onAssetAdd,this)},_proto._onAssetUnload=function _onAssetUnload(asset){asset.resource&&this.removeData(asset.resource)},_createClass(I18n,[{key:"locale",get:function get(){return this._locale},set:function set(value){if(this._locale!==value){var lang=getLang(value);if("in"!==lang||(value=replaceLang(value,lang="id"),this._locale!==value)){var old=this._locale;this._locale=value,this._lang=lang,this._pluralFn=getPluralFn(this._lang),this.fire("set:locale",value,old)}}}},{key:"assets",get:function get(){return this._assets},set:function set(value){var i,len,id,asset,index={};for(i=0,len=value.length;i<len;i++)index[id=value[i]instanceof Asset?value[i].id:value[i]]=!0;for(i=this._assets.length;i--;)index[id=this._assets[i]]||(this._app.assets.off("add:"+id,this._onAssetAdd,this),(asset=this._app.assets.get(id))&&this._onAssetRemove(asset),this._assets.splice(i,1));for(id in index)id=parseInt(id,10),-1===this._assets.indexOf(id)&&(this._assets.push(id),(asset=this._app.assets.get(id))?this._onAssetAdd(asset):this._app.assets.once("add:"+id,this._onAssetAdd,this))}}]),I18n}(EventHandler),FILLMODE_NONE="NONE",FILLMODE_FILL_WINDOW="FILL_WINDOW",FILLMODE_KEEP_ASPECT="KEEP_ASPECT",RESOLUTION_AUTO="AUTO",RESOLUTION_FIXED="FIXED",VrDisplay=function(_EventHandler){function VrDisplay(app,display){var _this,self=_assertThisInitialized(_this=_EventHandler.call(this)||this);return _this._app=app,_this._device=app.graphicsDevice,_this.id=display.displayId,_this._frameData=null,window.VRFrameData&&(_this._frameData=new window.VRFrameData),_this.display=display,_this._camera=null,_this.sitToStandInv=new Mat4,_this.leftView=new Mat4,_this.leftProj=new Mat4,_this.leftViewInv=new Mat4,_this.leftPos=new Vec3,_this.rightView=new Mat4,_this.rightProj=new Mat4,_this.rightViewInv=new Mat4,_this.rightPos=new Vec3,_this.combinedPos=new Vec3,_this.combinedView=new Mat4,_this.combinedProj=new Mat4,_this.combinedViewInv=new Mat4,_this.combinedFov=0,_this.combinedAspect=0,_this.presenting=!1,self._presentChange=function(event){var display;if((display=event.display?event.display:event.detail&&event.detail.display?event.detail.display:event.detail&&event.detail.vrdisplay?event.detail.vrdisplay:self.display)===self.display){if(self.presenting=self.display&&self.display.isPresenting,self.presenting){var leftEye=self.display.getEyeParameters("left"),rightEye=self.display.getEyeParameters("right"),w=2*Math.max(leftEye.renderWidth,rightEye.renderWidth),h=Math.max(leftEye.renderHeight,rightEye.renderHeight);self._app.graphicsDevice.setResolution(w,h),self._app._allowResize=!1}else self._app.setCanvasResolution("AUTO"),self._app._allowResize=!0;self.fire("beforepresentchange",self),self.fire("presentchange",self)}},window.addEventListener("vrdisplaypresentchange",self._presentChange,!1),_this}_inheritsLoose(VrDisplay,_EventHandler);var _proto=VrDisplay.prototype;return _proto.destroy=function destroy(){window.removeEventListener("vrdisplaypresentchange",self._presentChange),this._camera&&(this._camera.vrDisplay=null),this._camera=null},_proto.poll=function poll(){if(this.display){this.display.getFrameData(this._frameData),this.leftProj.data=this._frameData.leftProjectionMatrix,this.rightProj.data=this._frameData.rightProjectionMatrix;var stage=this.display.stageParameters;stage?(this.sitToStandInv.set(stage.sittingToStandingTransform).invert(),this.combinedView.set(this._frameData.leftViewMatrix),this.leftView.mul2(this.combinedView,this.sitToStandInv),this.combinedView.set(this._frameData.rightViewMatrix),this.rightView.mul2(this.combinedView,this.sitToStandInv)):(this.leftView.set(this._frameData.leftViewMatrix),this.rightView.set(this._frameData.rightViewMatrix));var nx=this.leftProj.data[3]+this.leftProj.data[0],nz=this.leftProj.data[11]+this.leftProj.data[8],l=1/Math.sqrt(nx*nx+nz*nz);nx*=l,nz*=l;var maxFov=-Math.atan2(nz,nx);nx=this.rightProj.data[3]+this.rightProj.data[0],nz=this.rightProj.data[11]+this.rightProj.data[8],nx*=l=1/Math.sqrt(nx*nx+nz*nz),nz*=l,maxFov=Math.max(maxFov,-Math.atan2(nz,nx)),maxFov*=2,this.combinedFov=maxFov;var aspect=this.rightProj.data[5]/this.rightProj.data[0];this.combinedAspect=aspect;var view=this.combinedView;view.copy(this.leftView),view.invert(),this.leftViewInv.copy(view);var pos=this.combinedPos;pos.x=this.leftPos.x=view.data[12],pos.y=this.leftPos.y=view.data[13],pos.z=this.leftPos.z=view.data[14],view.copy(this.rightView),view.invert(),this.rightViewInv.copy(view);var deltaX=pos.x-view.data[12],deltaY=pos.y-view.data[13],deltaZ=pos.z-view.data[14],dist=Math.sqrt(deltaX*deltaX+deltaY*deltaY+deltaZ*deltaZ);this.rightPos.x=view.data[12],this.rightPos.y=view.data[13],this.rightPos.z=view.data[14],pos.x+=view.data[12],pos.y+=view.data[13],pos.z+=view.data[14],pos.x*=.5,pos.y*=.5,pos.z*=.5;var b=.5*Math.PI,c=.5*maxFov,a=Math.PI-(b+c),offset=.5*dist*Math.sin(a),fwdX=view.data[8],fwdY=view.data[9],fwdZ=view.data[10];view.data[12]=pos.x+fwdX*offset,view.data[13]=pos.y+fwdY*offset,view.data[14]=pos.z+fwdZ*offset,this.combinedViewInv.copy(view),view.invert(),this.combinedProj.setPerspective(maxFov*math.RAD_TO_DEG,aspect,this.display.depthNear+offset,this.display.depthFar+offset,!0)}},_proto.requestPresent=function requestPresent(callback){this.display?this.presenting?callback&&callback(new Error("VrDisplay already presenting")):this.display.requestPresent([{source:this._device.canvas}]).then((function(){callback&&callback()}),(function(err){callback&&callback(err)})):callback&&callback(new Error("No VrDisplay to requestPresent"))},_proto.exitPresent=function exitPresent(callback){this.display||callback&&callback(new Error("No VrDisplay to exitPresent")),this.presenting?this.display.exitPresent().then((function(){callback&&callback()}),(function(){callback&&callback(new Error("exitPresent failed"))})):callback&&callback(new Error("VrDisplay not presenting"))},_proto.requestAnimationFrame=function requestAnimationFrame(fn){this.display&&this.display.requestAnimationFrame(fn)},_proto.submitFrame=function submitFrame(){this.display&&this.display.submitFrame()},_proto.reset=function reset(){this.display&&this.display.resetPose()},_proto.setClipPlanes=function setClipPlanes(n,f){this.display&&(this.display.depthNear=n,this.display.depthFar=f)},_proto.getFrameData=function getFrameData(){if(this.display)return this._frameData},_createClass(VrDisplay,[{key:"capabilities",get:function get(){return this.display?this.display.capabilities:{}}}]),VrDisplay}(EventHandler),VrManager=function(_EventHandler){function VrManager(app){var _this,self=_assertThisInitialized(_this=_EventHandler.call(this)||this);return _this.isSupported=VrManager.isSupported,_this._index={},_this.displays=[],_this.display=null,_this._app=app,_this._onDisplayConnect=_this._onDisplayConnect.bind(_assertThisInitialized(_this)),_this._onDisplayDisconnect=_this._onDisplayDisconnect.bind(_assertThisInitialized(_this)),self._attach(),_this._getDisplays((function(err,displays){if(err)self.fire("error",err);else{for(var i=0;i<displays.length;i++)self._addDisplay(displays[i]);self.fire("ready",self.displays)}})),_this}_inheritsLoose(VrManager,_EventHandler);var _proto=VrManager.prototype;return _proto._attach=function _attach(){window.addEventListener("vrdisplayconnect",this._onDisplayConnect),window.addEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)},_proto._detach=function _detach(){window.removeEventListener("vrdisplayconnect",this._onDisplayConnect),window.removeEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)},_proto.destroy=function destroy(){this._detach()},_proto.poll=function poll(){var l=this.displays.length;if(l)for(var i=0;i<l;i++)this.displays[i]._camera&&this.displays[i].poll()},_proto._getDisplays=function _getDisplays(callback){navigator.getVRDisplays?navigator.getVRDisplays().then((function(displays){callback&&callback(null,displays)})):callback&&callback(new Error("WebVR not supported"))},_proto._addDisplay=function _addDisplay(vrDisplay){if(!this._index[vrDisplay.displayId]){var display=new VrDisplay(this._app,vrDisplay);this._index[display.id]=display,this.displays.push(display),this.display||(this.display=display),this.fire("displayconnect",display)}},_proto._onDisplayConnect=function _onDisplayConnect(e){e.detail&&e.detail.display?this._addDisplay(e.detail.display):this._addDisplay(e.display)},_proto._onDisplayDisconnect=function _onDisplayDisconnect(e){var id;id=e.detail&&e.detail.display?e.detail.display.displayId:e.display.displayId;var display=this._index[id];if(display){display.destroy(),delete this._index[display.id];var ind=this.displays.indexOf(display);this.displays.splice(ind,1),this.display===display&&(this.displays.length?this.display=this.displays[0]:this.display=null),this.fire("displaydisconnect",display)}},VrManager}(EventHandler);VrManager.isSupported="undefined"!=typeof navigator&&!!navigator.getVRDisplays;for(var XRTYPE_INLINE="inline",XRTYPE_VR="immersive-vr",XRTYPE_AR="immersive-ar",XRSPACE_VIEWER="viewer",XRSPACE_LOCAL="local",XRSPACE_LOCALFLOOR="local-floor",XRSPACE_BOUNDEDFLOOR="bounded-floor",XRSPACE_UNBOUNDED="unbounded",XRTARGETRAY_GAZE="gaze",XRTARGETRAY_SCREEN="screen",XRTARGETRAY_POINTER="tracked-pointer",XRHAND_NONE="none",XRHAND_LEFT="left",XRHAND_RIGHT="right",XRTRACKABLE_POINT="point",XRTRACKABLE_PLANE="plane",XRTRACKABLE_MESH="mesh",XRDEPTHSENSINGUSAGE_CPU="cpu-optimized",XRDEPTHSENSINGUSAGE_GPU="gpu-optimized",XRDEPTHSENSINGFORMAT_L8A8="luminance-alpha",XRDEPTHSENSINGFORMAT_F32="float32",poolVec3=[],poolQuat=[],XrHitTestSource=function(_EventHandler){function XrHitTestSource(manager,xrHitTestSource,transient){var _this;return(_this=_EventHandler.call(this)||this).manager=manager,_this._xrHitTestSource=xrHitTestSource,_this._transient=transient,_this}_inheritsLoose(XrHitTestSource,_EventHandler);var _proto=XrHitTestSource.prototype;return _proto.remove=function remove(){if(this._xrHitTestSource){var sources=this.manager.hitTest.sources,ind=sources.indexOf(this);-1!==ind&&sources.splice(ind,1),this.onStop()}},_proto.onStop=function onStop(){this._xrHitTestSource.cancel(),this._xrHitTestSource=null,this.fire("remove"),this.manager.hitTest.fire("remove",this)},_proto.update=function update(frame){if(this._transient)for(var transientResults=frame.getHitTestResultsForTransientInput(this._xrHitTestSource),i=0;i<transientResults.length;i++){var transientResult=transientResults[i],inputSource=void 0;transientResult.inputSource&&(inputSource=this.manager.input._getByInputSource(transientResult.inputSource)),this.updateHitResults(transientResult.results,inputSource)}else this.updateHitResults(frame.getHitTestResults(this._xrHitTestSource))},_proto.updateHitResults=function updateHitResults(results,inputSource){for(var i=0;i<results.length;i++){var pose=results[i].getPose(this.manager._referenceSpace),position=poolVec3.pop();position||(position=new Vec3),position.copy(pose.transform.position);var rotation=poolQuat.pop();rotation||(rotation=new Quat),rotation.copy(pose.transform.orientation),this.fire("result",position,rotation,inputSource),this.manager.hitTest.fire("result",this,position,rotation,inputSource),poolVec3.push(position),poolQuat.push(rotation)}},XrHitTestSource}(EventHandler),XrHitTest=function(_EventHandler){function XrHitTest(manager){var _this;return(_this=_EventHandler.call(this)||this).manager=manager,_this._supported=!(!window.XRSession||!window.XRSession.prototype.requestHitTestSource),_this._session=null,_this.sources=[],_this._supported&&(_this.manager.on("start",_this._onSessionStart,_assertThisInitialized(_this)),_this.manager.on("end",_this._onSessionEnd,_assertThisInitialized(_this))),_this}_inheritsLoose(XrHitTest,_EventHandler);var _proto=XrHitTest.prototype;return _proto._onSessionStart=function _onSessionStart(){this.manager.type===XRTYPE_AR&&(this._session=this.manager.session)},_proto._onSessionEnd=function _onSessionEnd(){if(this._session){this._session=null;for(var i=0;i<this.sources.length;i++)this.sources[i].onStop();this.sources=[]}},_proto.isAvailable=function isAvailable(callback,fireError){var err;return this._supported||(err=new Error("XR HitTest is not supported")),this._session||(err=new Error("XR Session is not started (1)")),this.manager.type!==XRTYPE_AR&&(err=new Error("XR HitTest is available only for AR")),!err||(callback&&callback(err),fireError&&fireError.fire("error",err),!1)},_proto.start=function start(options){var _this2=this;if(options=options||{},this.isAvailable(options.callback,this)){var xrRay;options.profile||options.spaceType||(options.spaceType="viewer");var offsetRay=options.offsetRay;offsetRay&&(xrRay=new XRRay(new DOMPoint(offsetRay.origin.x,offsetRay.origin.y,offsetRay.origin.z),new DOMPoint(offsetRay.direction.x,offsetRay.direction.y,offsetRay.direction.z)));var callback=options.callback;options.spaceType?this._session.requestReferenceSpace(options.spaceType).then((function(referenceSpace){if(!_this2._session){var err=new Error("XR Session is not started (2)");return callback&&callback(err),void _this2.fire("error",err)}_this2._session.requestHitTestSource({space:referenceSpace,entityTypes:options.entityTypes||void 0,offsetRay:xrRay}).then((function(xrHitTestSource){_this2._onHitTestSource(xrHitTestSource,!1,callback)})).catch((function(ex){callback&&callback(ex),_this2.fire("error",ex)}))})).catch((function(ex){callback&&callback(ex),_this2.fire("error",ex)})):this._session.requestHitTestSourceForTransientInput({profile:options.profile,entityTypes:options.entityTypes||void 0,offsetRay:xrRay}).then((function(xrHitTestSource){_this2._onHitTestSource(xrHitTestSource,!0,callback)})).catch((function(ex){callback&&callback(ex),_this2.fire("error",ex)}))}},_proto._onHitTestSource=function _onHitTestSource(xrHitTestSource,transient,callback){if(!this._session){xrHitTestSource.cancel();var err=new Error("XR Session is not started (3)");return callback&&callback(err),void this.fire("error",err)}var hitTestSource=new XrHitTestSource(this.manager,xrHitTestSource,transient);this.sources.push(hitTestSource),callback&&callback(null,hitTestSource),this.fire("add",hitTestSource)},_proto.update=function update(frame){for(var i=0;i<this.sources.length;i++)this.sources[i].update(frame)},_createClass(XrHitTest,[{key:"supported",get:function get(){return this._supported}}]),XrHitTest}(EventHandler),XrFinger=function(){function XrFinger(index,hand){this._index=index,this._hand=hand,this._hand._fingers.push(this),this._joints=[],this._tip=null}return _createClass(XrFinger,[{key:"index",get:function get(){return this._index}},{key:"hand",get:function get(){return this._hand}},{key:"joints",get:function get(){return this._joints}},{key:"tip",get:function get(){return this._tip}}]),XrFinger}(),tipJointIds=window.XRHand?["thumb-tip","index-finger-tip","middle-finger-tip","ring-finger-tip","pinky-finger-tip"]:[],tipJointIdsIndex={},i=0;i<tipJointIds.length;i++)tipJointIdsIndex[tipJointIds[i]]=!0;var XrJoint=function(){function XrJoint(index,id,hand,finger){void 0===finger&&(finger=null),this._index=index,this._id=id,this._hand=hand,this._finger=finger,this._wrist="wrist"===id,this._tip=this._finger&&!!tipJointIdsIndex[id],this._radius=null,this._localTransform=new Mat4,this._worldTransform=new Mat4,this._localPosition=new Vec3,this._localRotation=new Quat,this._position=new Vec3,this._rotation=new Quat,this._dirtyLocal=!0}var _proto=XrJoint.prototype;return _proto.update=function update(pose){this._dirtyLocal=!0,this._radius=pose.radius,this._localPosition.copy(pose.transform.position),this._localRotation.copy(pose.transform.orientation)},_proto._updateTransforms=function _updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,Vec3.ONE));var manager,parent=this._hand._manager.camera.parent;parent?this._worldTransform.mul2(parent.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)},_proto.getPosition=function getPosition(){return this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position},_proto.getRotation=function getRotation(){return this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation},_createClass(XrJoint,[{key:"index",get:function get(){return this._index}},{key:"hand",get:function get(){return this._hand}},{key:"finger",get:function get(){return this._finger}},{key:"wrist",get:function get(){return this._wrist}},{key:"tip",get:function get(){return this._tip}},{key:"radius",get:function get(){return this._radius||.005}}]),XrJoint}(),fingerJointIds=[],vecA$2=new Vec3,vecB$2=new Vec3,vecC=new Vec3;window.XRHand&&(fingerJointIds=[["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]]);var XrHand=function(_EventHandler){function XrHand(inputSource){var _this;_this=_EventHandler.call(this)||this;var xrHand=inputSource._xrInputSource.hand;if(_this._manager=inputSource._manager,_this._inputSource=inputSource,_this._tracking=!1,_this._fingers=[],_this._joints=[],_this._jointsById={},_this._tips=[],_this._wrist=null,xrHand.get("wrist")){var joint=new XrJoint(0,"wrist",_assertThisInitialized(_this),null);_this._wrist=joint,_this._joints.push(joint),_this._jointsById.wrist=joint}for(var f=0;f<fingerJointIds.length;f++)for(var finger=new XrFinger(f,_assertThisInitialized(_this)),j=0;j<fingerJointIds[f].length;j++){var jointId=fingerJointIds[f][j];if(xrHand.get(jointId)){var _joint=new XrJoint(j,jointId,_assertThisInitialized(_this),finger);_this._joints.push(_joint),_this._jointsById[jointId]=_joint,_joint.tip&&(_this._tips.push(_joint),finger._tip=_joint),finger._joints.push(_joint)}}return _this}_inheritsLoose(XrHand,_EventHandler);var _proto=XrHand.prototype;return _proto.update=function update(frame){for(var xrInputSource=this._inputSource._xrInputSource,j=0;j<this._joints.length;j++){var joint=this._joints[j],jointSpace=xrInputSource.hand.get(joint._id);if(jointSpace){var pose=void 0;if("hidden"!==frame.session.visibilityState&&(pose=frame.getJointPose(jointSpace,this._manager._referenceSpace)),pose)joint.update(pose),joint.wrist&&!this._tracking&&(this._tracking=!0,this.fire("tracking"));else if(joint.wrist){this._tracking&&(this._tracking=!1,this.fire("trackinglost"));break}}}var j1=this._jointsById["thumb-metacarpal"],j4=this._jointsById["thumb-tip"],j6=this._jointsById["index-finger-phalanx-proximal"],j9=this._jointsById["index-finger-tip"],j16=this._jointsById["ring-finger-phalanx-proximal"],j21=this._jointsById["pinky-finger-phalanx-proximal"],squeezing;if(j1&&j4&&j6&&j9&&j16&&j21){this._inputSource._dirtyRay=!0,this._inputSource._rayLocal.origin.lerp(j4._localPosition,j9._localPosition,.5);var jointL=j1,jointR=j21;if("left"===this._inputSource.handedness){var t=jointL;jointL=jointR,jointR=t}vecA$2.sub2(jointL._localPosition,this._wrist._localPosition),vecB$2.sub2(jointR._localPosition,this._wrist._localPosition),vecC.cross(vecA$2,vecB$2).normalize(),vecA$2.lerp(j6._localPosition,j16._localPosition,.5),vecA$2.sub(this._wrist._localPosition).normalize(),this._inputSource._rayLocal.direction.lerp(vecC,vecA$2,.5).normalize()}this._fingerIsClosed(1)&&this._fingerIsClosed(2)&&this._fingerIsClosed(3)&&this._fingerIsClosed(4)?this._inputSource._squeezing||(this._inputSource._squeezing=!0,this._inputSource.fire("squeezestart"),this._manager.input.fire("squeezestart",this._inputSource)):this._inputSource._squeezing&&(this._inputSource._squeezing=!1,this._inputSource.fire("squeeze"),this._manager.input.fire("squeeze",this._inputSource),this._inputSource.fire("squeezeend"),this._manager.input.fire("squeezeend",this._inputSource))},_proto._fingerIsClosed=function _fingerIsClosed(index){var finger=this._fingers[index];return vecA$2.sub2(finger.joints[0]._localPosition,finger.joints[1]._localPosition).normalize(),vecB$2.sub2(finger.joints[2]._localPosition,finger.joints[3]._localPosition).normalize(),vecA$2.dot(vecB$2)<-.8},_proto.getJointById=function getJointById(id){return this._jointsById[id]||null},_createClass(XrHand,[{key:"fingers",get:function get(){return this._fingers}},{key:"joints",get:function get(){return this._joints}},{key:"tips",get:function get(){return this._tips}},{key:"wrist",get:function get(){return this._wrist}},{key:"tracking",get:function get(){return this._tracking}}]),XrHand}(EventHandler),quat$1=new Quat,ids$1=0,XrInputSource=function(_EventHandler){function XrInputSource(manager,xrInputSource){var _this;return(_this=_EventHandler.call(this)||this)._id=++ids$1,_this._manager=manager,_this._xrInputSource=xrInputSource,_this._ray=new Ray,_this._rayLocal=new Ray,_this._grip=!1,_this._hand=null,xrInputSource.hand&&(_this._hand=new XrHand(_assertThisInitialized(_this))),_this._localTransform=null,_this._worldTransform=null,_this._position=new Vec3,_this._rotation=new Quat,_this._localPosition=null,_this._localRotation=null,_this._dirtyLocal=!0,_this._selecting=!1,_this._squeezing=!1,_this._elementInput=!0,_this._elementEntity=null,_this._hitTestSources=[],_this}_inheritsLoose(XrInputSource,_EventHandler);var _proto=XrInputSource.prototype;return _proto.update=function update(frame){if(this._hand)this._hand.update(frame);else{if(this._xrInputSource.gripSpace){var gripPose=frame.getPose(this._xrInputSource.gripSpace,this._manager._referenceSpace);gripPose&&(this._grip||(this._grip=!0,this._localTransform=new Mat4,this._worldTransform=new Mat4,this._localPosition=new Vec3,this._localRotation=new Quat),this._dirtyLocal=!0,this._localPosition.copy(gripPose.transform.position),this._localRotation.copy(gripPose.transform.orientation))}var targetRayPose=frame.getPose(this._xrInputSource.targetRaySpace,this._manager._referenceSpace);targetRayPose&&(this._dirtyRay=!0,this._rayLocal.origin.copy(targetRayPose.transform.position),this._rayLocal.direction.set(0,0,-1),quat$1.copy(targetRayPose.transform.orientation),quat$1.transformVector(this._rayLocal.direction,this._rayLocal.direction))}},_proto._updateTransforms=function _updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,Vec3.ONE));var parent=this._manager.camera.parent;parent?this._worldTransform.mul2(parent.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)},_proto._updateRayTransforms=function _updateRayTransforms(){var dirty=this._dirtyRay,parent;if(this._dirtyRay=!1,this._manager.camera.parent){var parentTransform=this._manager.camera.parent.getWorldTransform();parentTransform.getTranslation(this._position),this._rotation.setFromMat4(parentTransform),this._rotation.transformVector(this._rayLocal.origin,this._ray.origin),this._ray.origin.add(this._position),this._rotation.transformVector(this._rayLocal.direction,this._ray.direction)}else dirty&&(this._ray.origin.copy(this._rayLocal.origin),this._ray.direction.copy(this._rayLocal.direction))},_proto.getPosition=function getPosition(){return this._position?(this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position):null},_proto.getLocalPosition=function getLocalPosition(){return this._localPosition},_proto.getRotation=function getRotation(){return this._rotation?(this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation):null},_proto.getLocalRotation=function getLocalRotation(){return this._localRotation},_proto.getOrigin=function getOrigin(){return this._updateRayTransforms(),this._ray.origin},_proto.getDirection=function getDirection(){return this._updateRayTransforms(),this._ray.direction},_proto.hitTestStart=function hitTestStart(options){var _this2=this;void 0===options&&(options={}),options.profile=this._xrInputSource.profiles[0];var callback=options.callback;options.callback=function(err,hitTestSource){hitTestSource&&_this2.onHitTestSourceAdd(hitTestSource),callback&&callback(err,hitTestSource)},this._manager.hitTest.start(options)},_proto.onHitTestSourceAdd=function onHitTestSourceAdd(hitTestSource){this._hitTestSources.push(hitTestSource),this.fire("hittest:add",hitTestSource),hitTestSource.on("result",(function(position,rotation,inputSource){inputSource===this&&this.fire("hittest:result",hitTestSource,position,rotation)}),this),hitTestSource.once("remove",(function(){this.onHitTestSourceRemove(hitTestSource),this.fire("hittest:remove",hitTestSource)}),this)},_proto.onHitTestSourceRemove=function onHitTestSourceRemove(hitTestSource){var ind=this._hitTestSources.indexOf(hitTestSource);-1!==ind&&this._hitTestSources.splice(ind,1)},_createClass(XrInputSource,[{key:"id",get:function get(){return this._id}},{key:"inputSource",get:function get(){return this._xrInputSource}},{key:"targetRayMode",get:function get(){return this._xrInputSource.targetRayMode}},{key:"handedness",get:function get(){return this._xrInputSource.handedness}},{key:"profiles",get:function get(){return this._xrInputSource.profiles}},{key:"grip",get:function get(){return this._grip}},{key:"hand",get:function get(){return this._hand}},{key:"gamepad",get:function get(){return this._xrInputSource.gamepad||null}},{key:"selecting",get:function get(){return this._selecting}},{key:"squeezing",get:function get(){return this._squeezing}},{key:"elementInput",get:function get(){return this._elementInput},set:function set(value){this._elementInput!==value&&(this._elementInput=value,this._elementInput||(this._elementEntity=null))}},{key:"elementEntity",get:function get(){return this._elementEntity}},{key:"hitTestSources",get:function get(){return this._hitTestSources}}]),XrInputSource}(EventHandler),XrInput=function(_EventHandler){function XrInput(manager){var _this;return(_this=_EventHandler.call(this)||this).manager=manager,_this._session=null,_this._inputSources=[],_this._onInputSourcesChangeEvt=function(evt){_this._onInputSourcesChange(evt)},_this.manager.on("start",_this._onSessionStart,_assertThisInitialized(_this)),_this.manager.on("end",_this._onSessionEnd,_assertThisInitialized(_this)),_this}_inheritsLoose(XrInput,_EventHandler);var _proto=XrInput.prototype;return _proto._onSessionStart=function _onSessionStart(){var _this2=this;this._session=this.manager.session,this._session.addEventListener("inputsourceschange",this._onInputSourcesChangeEvt),this._session.addEventListener("select",(function(evt){var inputSource=_this2._getByInputSource(evt.inputSource);inputSource.update(evt.frame),inputSource.fire("select",evt),_this2.fire("select",inputSource,evt)})),this._session.addEventListener("selectstart",(function(evt){var inputSource=_this2._getByInputSource(evt.inputSource);inputSource.update(evt.frame),inputSource._selecting=!0,inputSource.fire("selectstart",evt),_this2.fire("selectstart",inputSource,evt)})),this._session.addEventListener("selectend",(function(evt){var inputSource=_this2._getByInputSource(evt.inputSource);inputSource.update(evt.frame),inputSource._selecting=!1,inputSource.fire("selectend",evt),_this2.fire("selectend",inputSource,evt)})),this._session.addEventListener("squeeze",(function(evt){var inputSource=_this2._getByInputSource(evt.inputSource);inputSource.update(evt.frame),inputSource.fire("squeeze",evt),_this2.fire("squeeze",inputSource,evt)})),this._session.addEventListener("squeezestart",(function(evt){var inputSource=_this2._getByInputSource(evt.inputSource);inputSource.update(evt.frame),inputSource._squeezing=!0,inputSource.fire("squeezestart",evt),_this2.fire("squeezestart",inputSource,evt)})),this._session.addEventListener("squeezeend",(function(evt){var inputSource=_this2._getByInputSource(evt.inputSource);inputSource.update(evt.frame),inputSource._squeezing=!1,inputSource.fire("squeezeend",evt),_this2.fire("squeezeend",inputSource,evt)}));for(var inputSources=this._session.inputSources,i=0;i<inputSources.length;i++)this._addInputSource(inputSources[i])},_proto._onSessionEnd=function _onSessionEnd(){for(var i=this._inputSources.length;i--;){var inputSource=this._inputSources[i];this._inputSources.splice(i,1),inputSource.fire("remove"),this.fire("remove",inputSource)}this._session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt),this._session=null},_proto._onInputSourcesChange=function _onInputSourcesChange(evt){for(var i=0;i<evt.removed.length;i++)this._removeInputSource(evt.removed[i]);for(var _i=0;_i<evt.added.length;_i++)this._addInputSource(evt.added[_i])},_proto._getByInputSource=function _getByInputSource(xrInputSource){for(var i=0;i<this._inputSources.length;i++)if(this._inputSources[i].inputSource===xrInputSource)return this._inputSources[i];return null},_proto._addInputSource=function _addInputSource(xrInputSource){if(!this._getByInputSource(xrInputSource)){var inputSource=new XrInputSource(this.manager,xrInputSource);this._inputSources.push(inputSource),this.fire("add",inputSource)}},_proto._removeInputSource=function _removeInputSource(xrInputSource){for(var i=0;i<this._inputSources.length;i++)if(this._inputSources[i].inputSource===xrInputSource){var inputSource=this._inputSources[i];this._inputSources.splice(i,1);for(var h=inputSource.hitTestSources.length;h--;)inputSource.hitTestSources[h].remove();return inputSource.fire("remove"),void this.fire("remove",inputSource)}},_proto.update=function update(frame){for(var i=0;i<this._inputSources.length;i++)this._inputSources[i].update(frame)},_createClass(XrInput,[{key:"inputSources",get:function get(){return this._inputSources}}]),XrInput}(EventHandler),vec3A=new Vec3,vec3B=new Vec3,mat4A=new Mat4,mat4B=new Mat4,XrLightEstimation=function(_EventHandler){function XrLightEstimation(manager){var _this;return(_this=_EventHandler.call(this)||this)._manager=manager,_this._supported=!1,_this._available=!1,_this._lightProbeRequested=!1,_this._lightProbe=null,_this._intensity=0,_this._rotation=new Quat,_this._color=new Color,_this._sphericalHarmonics=new Float32Array(27),_this._manager.on("start",_this._onSessionStart,_assertThisInitialized(_this)),_this._manager.on("end",_this._onSessionEnd,_assertThisInitialized(_this)),_this}_inheritsLoose(XrLightEstimation,_EventHandler);var _proto=XrLightEstimation.prototype;return _proto._onSessionStart=function _onSessionStart(){var supported;!!this._manager.session.requestLightProbe&&(this._supported=!0)},_proto._onSessionEnd=function _onSessionEnd(){this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null},_proto.start=function start(){var _this2=this,err;this._manager.session||(err=new Error("XR session is not running")),err||this._manager.type===XRTYPE_AR||(err=new Error("XR session type is not AR")),err||this._supported||(err=new Error("light-estimation is not supported")),(!err&&this._lightProbe||this._lightProbeRequested)&&(err=new Error("light estimation is already requested")),err?this.fire("error",err):(this._lightProbeRequested=!0,this._manager.session.requestLightProbe().then((function(lightProbe){var wasRequested=_this2._lightProbeRequested;_this2._lightProbeRequested=!1,_this2._manager.active?wasRequested&&(_this2._lightProbe=lightProbe):_this2.fire("error",new Error("XR session is not active"))})).catch((function(ex){_this2._lightProbeRequested=!1,_this2.fire("error",ex)})))},_proto.end=function end(){this._lightProbeRequested=!1,this._lightProbe=null,this._available=!1},_proto.update=function update(frame){if(this._lightProbe){var lightEstimate=frame.getLightEstimate(this._lightProbe);if(lightEstimate){this._available||(this._available=!0,this.fire("available"));var pli=lightEstimate.primaryLightIntensity;this._intensity=Math.max(1,Math.max(pli.x,Math.max(pli.y,pli.z))),vec3A.copy(pli).mulScalar(1/this._intensity),this._color.set(vec3A.x,vec3A.y,vec3A.z),vec3A.set(0,0,0),vec3B.copy(lightEstimate.primaryLightDirection),mat4A.setLookAt(vec3B,vec3A,Vec3.UP),mat4B.setFromAxisAngle(Vec3.RIGHT,90),mat4A.mul(mat4B),this._rotation.setFromMat4(mat4A),this._sphericalHarmonics.set(lightEstimate.sphericalHarmonicsCoefficients)}}},_createClass(XrLightEstimation,[{key:"supported",get:function get(){return this._supported}},{key:"available",get:function get(){return this._available}},{key:"intensity",get:function get(){return this._available?this._intensity:null}},{key:"color",get:function get(){return this._available?this._color:null}},{key:"rotation",get:function get(){return this._available?this._rotation:null}},{key:"sphericalHarmonics",get:function get(){return this._available?this._sphericalHarmonics:null}}]),XrLightEstimation}(EventHandler),XrTrackedImage=function(_EventHandler){function XrTrackedImage(image,width){var _this;return(_this=_EventHandler.call(this)||this)._image=image,_this._bitmap=null,_this._width=width,_this._measuredWidth=0,_this._trackable=!1,_this._tracking=!1,_this._emulated=!1,_this._pose=null,_this._position=new Vec3,_this._rotation=new Quat,_this}_inheritsLoose(XrTrackedImage,_EventHandler);var _proto=XrTrackedImage.prototype;return _proto.prepare=function prepare(){var _this2=this;return this._bitmap?{image:this._bitmap,widthInMeters:this._width}:createImageBitmap(this._image).then((function(bitmap){return _this2._bitmap=bitmap,{image:_this2._bitmap,widthInMeters:_this2._width}}))},_proto.destroy=function destroy(){this._image=null,this._pose=null,this._bitmap&&(this._bitmap.close(),this._bitmap=null)},_proto.getPosition=function getPosition(){return this._pose&&this._position.copy(this._pose.transform.position),this._position},_proto.getRotation=function getRotation(){return this._pose&&this._rotation.copy(this._pose.transform.orientation),this._rotation},_createClass(XrTrackedImage,[{key:"image",get:function get(){return this._image}},{key:"width",get:function get(){return this._width},set:function set(value){this._width=value}},{key:"trackable",get:function get(){return this._trackable}},{key:"tracking",get:function get(){return this._tracking}},{key:"emulated",get:function get(){return this._emulated}}]),XrTrackedImage}(EventHandler),XrImageTracking=function(_EventHandler){function XrImageTracking(manager){var _this;return(_this=_EventHandler.call(this)||this)._manager=manager,_this._supported=!!window.XRImageTrackingResult,_this._available=!1,_this._images=[],_this._supported&&(_this._manager.on("start",_this._onSessionStart,_assertThisInitialized(_this)),_this._manager.on("end",_this._onSessionEnd,_assertThisInitialized(_this))),_this}_inheritsLoose(XrImageTracking,_EventHandler);var _proto=XrImageTracking.prototype;return _proto.add=function add(image,width){if(!this._supported||this._manager.active)return null;var trackedImage=new XrTrackedImage(image,width);return this._images.push(trackedImage),trackedImage},_proto.remove=function remove(trackedImage){if(!this._manager.active){var ind=this._images.indexOf(trackedImage);-1!==ind&&(trackedImage.destroy(),this._images.splice(ind,1))}},_proto._onSessionStart=function _onSessionStart(){var _this2=this;this._manager.session.getTrackedImageScores().then((function(images){_this2._available=!0;for(var i=0;i<images.length;i++)_this2._images[i]._trackable="trackable"===images[i]})).catch((function(err){_this2._available=!1,_this2.fire("error",err)}))},_proto._onSessionEnd=function _onSessionEnd(){this._available=!1;for(var i=0;i<this._images.length;i++)this._images[i]._pose=null,this._images[i]._measuredWidth=0,this._images[i]._tracking&&(this._images[i]._tracking=!1,this._images[i].fire("untracked"))},_proto.prepareImages=function prepareImages(callback){this._images.length?Promise.all(this._images.map((function(trackedImage){return trackedImage.prepare()}))).then((function(bitmaps){callback(null,bitmaps)})).catch((function(err){callback(err,null)})):callback(null,null)},_proto.update=function update(frame){if(this._available){for(var results=frame.getImageTrackingResults(),index={},i=0;i<results.length;i++){index[results[i].index]=results[i];var trackedImage=this._images[results[i].index];trackedImage._emulated="emulated"===results[i].trackingState,trackedImage._measuredWidth=results[i].measuredWidthInMeters,trackedImage._dirtyTransform=!0,trackedImage._pose=frame.getPose(results[i].imageSpace,this._manager._referenceSpace)}for(var _i=0;_i<this._images.length;_i++)this._images[_i]._tracking&&!index[_i]?(this._images[_i]._tracking=!1,this._images[_i].fire("untracked")):!this._images[_i]._tracking&&index[_i]&&(this._images[_i]._tracking=!0,this._images[_i].fire("tracked"))}},_createClass(XrImageTracking,[{key:"supported",get:function get(){return this._supported}},{key:"available",get:function get(){return this._available}},{key:"images",get:function get(){return this._images}}]),XrImageTracking}(EventHandler),XrDomOverlay=function(){function XrDomOverlay(manager){this._manager=manager,this._supported=!!window.XRDOMOverlayState,this._root=null}return _createClass(XrDomOverlay,[{key:"supported",get:function get(){return this._supported}},{key:"available",get:function get(){return this._supported&&this._manager.active&&null!==this._manager._session.domOverlayState}},{key:"state",get:function get(){return this._supported&&this._manager.active&&this._manager._session.domOverlayState?this._manager._session.domOverlayState.type:null}},{key:"root",get:function get(){return this._root},set:function set(value){this._supported&&!this._manager.active&&(this._root=value)}}]),XrDomOverlay}(),XrDepthSensing=function(_EventHandler){function XrDepthSensing(manager){var _this;return(_this=_EventHandler.call(this)||this)._manager=manager,_this._available=!1,_this._depthInfoCpu=null,_this._depthInfoGpu=null,_this._usage=null,_this._dataFormat=null,_this._matrixDirty=!1,_this._matrix=new Mat4,_this._emptyBuffer=new Uint8Array(32),_this._depthBuffer=null,_this._texture=new Texture(_this._manager.app.graphicsDevice,{format:2,mipmaps:!1,addressU:1,addressV:1,minFilter:1,magFilter:1}),_this.supported&&(_this._manager.on("start",_this._onSessionStart,_assertThisInitialized(_this)),_this._manager.on("end",_this._onSessionEnd,_assertThisInitialized(_this))),_this}_inheritsLoose(XrDepthSensing,_EventHandler);var _proto=XrDepthSensing.prototype;return _proto._onSessionStart=function _onSessionStart(){var session=this._manager.session;try{this._usage=session.depthUsage,this._dataFormat=session.depthDataFormat}catch(ex){this._usage=null,this._dataFormat=null,this._available=!1,this.fire("error",ex)}},_proto._onSessionEnd=function _onSessionEnd(){this._depthInfoCpu=null,this._depthInfoGpu=null,this._usage=null,this._dataFormat=null,this._available&&(this._available=!1,this.fire("unavailable")),this._depthBuffer=null,this._texture._width=4,this._texture._height=4,this._texture._levels[0]=this._emptyBuffer,this._texture.upload()},_proto._updateTexture=function _updateTexture(){var depthInfo=this._depthInfoCpu||this._depthInfoGpu;if(depthInfo){var resized=!1;if(depthInfo.width===this._texture.width&&depthInfo.height===this._texture.height||(this._texture._width=depthInfo.width,this._texture._height=depthInfo.height,this._matrixDirty=!0,resized=!0),this._depthInfoCpu){var dataBuffer=this._depthInfoCpu.data;this._depthBuffer=new Uint8Array(dataBuffer),this._texture._levels[0]=this._depthBuffer,this._texture.upload()}else this._depthInfoGpu&&(this._texture._levels[0]=this._depthInfoGpu.texture,this._texture.upload());resized&&this.fire("resize",depthInfo.width,depthInfo.height)}else this._depthBuffer&&(this._depthBuffer=null,this._texture._width=4,this._texture._height=4,this._texture._levels[0]=this._emptyBuffer,this._texture.upload())},_proto.update=function update(frame,view){if(this._usage){var depthInfoCpu=null,depthInfoGpu=null;if("cpu-optimized"===this._usage&&view?depthInfoCpu=frame.getDepthInformation(view):"gpu-optimized"===this._usage&&view&&(depthInfoGpu=frame.getDepthInformation(view)),(this._depthInfoCpu&&!depthInfoCpu||!this._depthInfoCpu&&depthInfoCpu||this.depthInfoGpu&&!depthInfoGpu||!this._depthInfoGpu&&depthInfoGpu)&&(this._matrixDirty=!0),this._depthInfoCpu=depthInfoCpu,this._depthInfoGpu=depthInfoGpu,this._updateTexture(),this._matrixDirty){this._matrixDirty=!1;var depthInfo=this._depthInfoCpu||this._depthInfoGpu;depthInfo?this._matrix.data.set(depthInfo.normDepthBufferFromNormView.matrix):this._matrix.setIdentity()}!this._depthInfoCpu&&!this._depthInfoGpu||this._available?this._depthInfoCpu||this._depthInfoGpu||!this._available||(this._available=!1,this.fire("unavailable")):(this._available=!0,this.fire("available"))}},_proto.getDepth=function getDepth(u,v){return this._depthInfoCpu?this._depthInfoCpu.getDepthInMeters(u,v):null},_createClass(XrDepthSensing,[{key:"supported",get:function get(){return!!window.XRDepthInformation}},{key:"available",get:function get(){return this._available}},{key:"usage",get:function get(){return this._usage}},{key:"dataFormat",get:function get(){return this._dataFormat}},{key:"width",get:function get(){var depthInfo=this._depthInfoCpu||this._depthInfoGpu;return depthInfo&&depthInfo.width||0}},{key:"height",get:function get(){var depthInfo=this._depthInfoCpu||this._depthInfoGpu;return depthInfo&&depthInfo.height||0}},{key:"texture",get:function get(){return this._texture}},{key:"uvMatrix",get:function get(){return this._matrix}},{key:"rawValueToMeters",get:function get(){var depthInfo=this._depthInfoCpu||this._depthInfoGpu;return depthInfo&&depthInfo.rawValueToMeters||0}}]),XrDepthSensing}(EventHandler),ids=0,XrPlane=function(_EventHandler){function XrPlane(planeDetection,xrPlane){var _this;return(_this=_EventHandler.call(this)||this)._id=++ids,_this._planeDetection=planeDetection,_this._manager=_this._planeDetection._manager,_this._xrPlane=xrPlane,_this._lastChangedTime=_this._xrPlane.lastChangedTime,_this._orientation=_this._xrPlane.orientation,_this._position=new Vec3,_this._rotation=new Quat,_this}_inheritsLoose(XrPlane,_EventHandler);var _proto=XrPlane.prototype;return _proto.destroy=function destroy(){this.fire("remove")},_proto.update=function update(frame){var pose=frame.getPose(this._xrPlane.planeSpace,this._manager._referenceSpace);pose&&(this._position.copy(pose.transform.position),this._rotation.copy(pose.transform.orientation)),this._lastChangedTime!==this._xrPlane.lastChangedTime&&(this._lastChangedTime=this._xrPlane.lastChangedTime,this.fire("change"))},_proto.getPosition=function getPosition(){return this._position},_proto.getRotation=function getRotation(){return this._rotation},_createClass(XrPlane,[{key:"id",get:function get(){return this.id}},{key:"orientation",get:function get(){return this._orientation}},{key:"points",get:function get(){return this._xrPlane.polygon}}]),XrPlane}(EventHandler),XrPlaneDetection=function(_EventHandler){function XrPlaneDetection(manager){var _this;return(_this=_EventHandler.call(this)||this)._manager=manager,_this._supported=!!window.XRPlane,_this._available=!1,_this._planesIndex=new Map,_this._planes=null,_this._supported&&_this._manager.on("end",_this._onSessionEnd,_assertThisInitialized(_this)),_this}_inheritsLoose(XrPlaneDetection,_EventHandler);var _proto=XrPlaneDetection.prototype;return _proto._onSessionEnd=function _onSessionEnd(){for(var i=0;i<this._planes.length;i++)this._planes[i].destroy();this._planesIndex.clear(),this._planes=null,this._available&&(this._available=!1,this.fire("unavailable"))},_proto.update=function update(frame){var detectedPlanes;if(this._available)detectedPlanes=frame.detectedPlanes;else try{detectedPlanes=frame.detectedPlanes,this._planes=[],this._available=!0,this.fire("available")}catch(ex){return}for(var _iterator=_createForOfIteratorHelperLoose(this._planesIndex),_step;!(_step=_iterator()).done;){var _step$value=_step.value,xrPlane=_step$value[0],plane=_step$value[1];detectedPlanes.has(xrPlane)||(this._planesIndex.delete(xrPlane),this._planes.splice(this._planes.indexOf(plane),1),plane.destroy(),this.fire("remove",plane))}for(var _iterator2=_createForOfIteratorHelperLoose(detectedPlanes),_step2;!(_step2=_iterator2()).done;){var _xrPlane=_step2.value,_plane=this._planesIndex.get(_xrPlane);_plane?_plane.update(frame):(_plane=new XrPlane(this,_xrPlane),this._planesIndex.set(_xrPlane,_plane),this._planes.push(_plane),_plane.update(frame),this.fire("add",_plane))}},_createClass(XrPlaneDetection,[{key:"supported",get:function get(){return this._supported}},{key:"available",get:function get(){return this._available}},{key:"planes",get:function get(){return this._planes}}]),XrPlaneDetection}(EventHandler),XrManager=function(_EventHandler){function XrManager(app){var _this;return(_this=_EventHandler.call(this)||this).app=app,_this._supported=!!navigator.xr,_this._available={},_this._available.inline=!1,_this._available[XRTYPE_VR]=!1,_this._available[XRTYPE_AR]=!1,_this._type=null,_this._spaceType=null,_this._session=null,_this._baseLayer=null,_this._referenceSpace=null,_this.depthSensing=new XrDepthSensing(_assertThisInitialized(_this)),_this.domOverlay=new XrDomOverlay(_assertThisInitialized(_this)),_this.hitTest=new XrHitTest(_assertThisInitialized(_this)),_this.imageTracking=new XrImageTracking(_assertThisInitialized(_this)),_this.planeDetection=new XrPlaneDetection(_assertThisInitialized(_this)),_this.input=new XrInput(_assertThisInitialized(_this)),_this.lightEstimation=new XrLightEstimation(_assertThisInitialized(_this)),_this._camera=null,_this.views=[],_this.viewsPool=[],_this._localPosition=new Vec3,_this._localRotation=new Quat,_this._depthNear=.1,_this._depthFar=1e3,_this._width=0,_this._height=0,_this._supported&&(navigator.xr.addEventListener("devicechange",(function(){_this._deviceAvailabilityCheck()})),_this._deviceAvailabilityCheck()),_this}_inheritsLoose(XrManager,_EventHandler);var _proto=XrManager.prototype;return _proto.start=function start(camera,type,spaceType,options){var _this2=this,callback=options;if("object"==typeof options&&(callback=options.callback),this._available[type])if(this._session)callback&&callback(new Error("XR session is already started"));else{this._camera=camera,this._camera.camera.xr=this,this._type=type,this._spaceType=spaceType,this._setClipPlanes(camera.nearClip,camera.farClip);var opts={requiredFeatures:[spaceType],optionalFeatures:[]};if(type===XRTYPE_AR){if(opts.optionalFeatures.push("light-estimation"),opts.optionalFeatures.push("hit-test"),options&&(options.imageTracking&&this.imageTracking.supported&&opts.optionalFeatures.push("image-tracking"),options.planeDetection&&opts.optionalFeatures.push("plane-detection")),this.domOverlay.supported&&this.domOverlay.root&&(opts.optionalFeatures.push("dom-overlay"),opts.domOverlay={root:this.domOverlay.root}),options&&options.depthSensing&&this.depthSensing.supported){opts.optionalFeatures.push("depth-sensing");var usagePreference=["cpu-optimized"],dataFormatPreference=["luminance-alpha"];if(options.depthSensing.usagePreference){var ind=usagePreference.indexOf(options.depthSensing.usagePreference);-1!==ind&&usagePreference.splice(ind,1),usagePreference.unshift(options.depthSensing.usagePreference)}if(options.depthSensing.dataFormatPreference){var _ind=dataFormatPreference.indexOf(options.depthSensing.dataFormatPreference);-1!==_ind&&dataFormatPreference.splice(_ind,1),dataFormatPreference.unshift(options.depthSensing.dataFormatPreference)}opts.depthSensing={usagePreference:usagePreference,dataFormatPreference:dataFormatPreference}}}else type===XRTYPE_VR&&opts.optionalFeatures.push("hand-tracking");options&&options.optionalFeatures&&(opts.optionalFeatures=opts.optionalFeatures.concat(options.optionalFeatures)),this.imageTracking.supported&&this.imageTracking.images.length?this.imageTracking.prepareImages((function(err,trackedImages){if(err)return callback&&callback(err),void _this2.fire("error",err);null!==trackedImages&&(opts.trackedImages=trackedImages),_this2._onStartOptionsReady(type,spaceType,opts,callback)})):this._onStartOptionsReady(type,spaceType,opts,callback)}else callback&&callback(new Error("XR is not available"))},_proto._onStartOptionsReady=function _onStartOptionsReady(type,spaceType,options,callback){var _this3=this;navigator.xr.requestSession(type,options).then((function(session){_this3._onSessionStart(session,spaceType,callback)})).catch((function(ex){_this3._camera.camera.xr=null,_this3._camera=null,_this3._type=null,_this3._spaceType=null,callback&&callback(ex),_this3.fire("error",ex)}))},_proto.end=function end(callback){this._session?(callback&&this.once("end",callback),this._session.end()):callback&&callback(new Error("XR Session is not initialized"))},_proto.isAvailable=function isAvailable(type){return this._available[type]},_proto._deviceAvailabilityCheck=function _deviceAvailabilityCheck(){for(var key in this._available)this._sessionSupportCheck(key)},_proto._sessionSupportCheck=function _sessionSupportCheck(type){var _this4=this;navigator.xr.isSessionSupported(type).then((function(available){_this4._available[type]!==available&&(_this4._available[type]=available,_this4.fire("available",type,available),_this4.fire("available:"+type,available))})).catch((function(ex){_this4.fire("error",ex)}))},_proto._onSessionStart=function _onSessionStart(session,spaceType,callback){var _this5=this,failed=!1;this._session=session;var onVisibilityChange=function onVisibilityChange(){_this5.fire("visibility:change",session.visibilityState)},onClipPlanesChange=function onClipPlanesChange(){_this5._setClipPlanes(_this5._camera.nearClip,_this5._camera.farClip)},onEnd=function onEnd(){_this5._session=null,_this5._referenceSpace=null,_this5.views=[],_this5._width=0,_this5._height=0,_this5._type=null,_this5._spaceType=null,_this5._camera&&(_this5._camera.off("set_nearClip",onClipPlanesChange),_this5._camera.off("set_farClip",onClipPlanesChange),_this5._camera.camera.xr=null,_this5._camera=null),session.removeEventListener("end",onEnd),session.removeEventListener("visibilitychange",onVisibilityChange),failed||_this5.fire("end"),_this5.app.tick()};session.addEventListener("end",onEnd),session.addEventListener("visibilitychange",onVisibilityChange),this._camera.on("set_nearClip",onClipPlanesChange),this._camera.on("set_farClip",onClipPlanesChange),this._baseLayer=new XRWebGLLayer(session,this.app.graphicsDevice.gl),session.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar}),session.requestReferenceSpace(spaceType).then((function(referenceSpace){_this5._referenceSpace=referenceSpace,_this5.app.tick(),callback&&callback(null),_this5.fire("start")})).catch((function(ex){failed=!0,session.end(),callback&&callback(ex),_this5.fire("error",ex)}))},_proto._setClipPlanes=function _setClipPlanes(near,far){this._depthNear===near&&this._depthFar===far||(this._depthNear=near,this._depthFar=far,this._session&&this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar}))},_proto.update=function update(frame){if(this._session){var width=frame.session.renderState.baseLayer.framebufferWidth,height=frame.session.renderState.baseLayer.framebufferHeight;this._width===width&&this._height===height||(this._width=width,this._height=height,this.app.graphicsDevice.setResolution(width,height));var pose=frame.getViewerPose(this._referenceSpace),lengthNew=pose?pose.views.length:0;if(lengthNew>this.views.length)for(var i=0;i<=lengthNew-this.views.length;i++){var view=this.viewsPool.pop();view||(view={viewport:new Vec4,projMat:new Mat4,viewMat:new Mat4,viewOffMat:new Mat4,viewInvMat:new Mat4,viewInvOffMat:new Mat4,projViewOffMat:new Mat4,viewMat3:new Mat3,position:new Float32Array(3),rotation:new Quat}),this.views.push(view)}else if(lengthNew<=this.views.length)for(var _i=0;_i<this.views.length-lengthNew;_i++)this.viewsPool.push(this.views.pop());if(pose){var posePosition=pose.transform.position,poseOrientation=pose.transform.orientation;this._localPosition.set(posePosition.x,posePosition.y,posePosition.z),this._localRotation.set(poseOrientation.x,poseOrientation.y,poseOrientation.z,poseOrientation.w);for(var layer=frame.session.renderState.baseLayer,_i2=0;_i2<pose.views.length;_i2++){var viewRaw=pose.views[_i2],_view=this.views[_i2],viewport=layer.getViewport(viewRaw);_view.viewport.x=viewport.x,_view.viewport.y=viewport.y,_view.viewport.z=viewport.width,_view.viewport.w=viewport.height,_view.projMat.set(viewRaw.projectionMatrix),_view.viewMat.set(viewRaw.transform.inverse.matrix),_view.viewInvMat.set(viewRaw.transform.matrix)}}this._camera.camera._node.setLocalPosition(this._localPosition),this._camera.camera._node.setLocalRotation(this._localRotation),this.input.update(frame),this._type===XRTYPE_AR&&(this.hitTest.supported&&this.hitTest.update(frame),this.lightEstimation.supported&&this.lightEstimation.update(frame),this.depthSensing.supported&&this.depthSensing.update(frame,pose&&pose.views[0]),this.imageTracking.supported&&this.imageTracking.update(frame),this.planeDetection.supported&&this.planeDetection.update(frame)),this.fire("update",frame)}},_createClass(XrManager,[{key:"supported",get:function get(){return this._supported}},{key:"active",get:function get(){return!!this._session}},{key:"type",get:function get(){return this._type}},{key:"spaceType",get:function get(){return this._spaceType}},{key:"session",get:function get(){return this._session}},{key:"visibilityState",get:function get(){return this._session?this._session.visibilityState:null}},{key:"camera",get:function get(){return this._camera?this._camera.entity:null}}]),XrManager}(EventHandler),Component=function(_EventHandler){function Component(system,entity){var _this;return(_this=_EventHandler.call(this)||this).system=system,_this.entity=entity,_this.system.schema&&!_this._accessorsBuilt&&_this.buildAccessors(_this.system.schema),_this.on("set",(function(name,oldValue,newValue){this.fire("set_"+name,name,oldValue,newValue)})),_this.on("set_enabled",_this.onSetEnabled,_assertThisInitialized(_this)),_this}_inheritsLoose(Component,_EventHandler),Component._buildAccessors=function _buildAccessors(obj,schema){schema.forEach((function(descriptor){var name="object"==typeof descriptor?descriptor.name:descriptor;Object.defineProperty(obj,name,{get:function get(){return this.data[name]},set:function set(value){var data=this.data,oldValue=data[name];data[name]=value,this.fire("set",name,oldValue,value)},configurable:!0})})),obj._accessorsBuilt=!0};var _proto=Component.prototype;return _proto.buildAccessors=function buildAccessors(schema){Component._buildAccessors(this,schema)},_proto.onSetEnabled=function onSetEnabled(name,oldValue,newValue){oldValue!==newValue&&this.entity.enabled&&(newValue?this.onEnable():this.onDisable())},_proto.onEnable=function onEnable(){},_proto.onDisable=function onDisable(){},_proto.onPostStateChange=function onPostStateChange(){},_createClass(Component,[{key:"data",get:function get(){var record=this.system.store[this.entity.getGuid()];return record?record.data:null}}]),Component}(EventHandler),ComponentSystem=function(_EventHandler){function ComponentSystem(app){var _this;return(_this=_EventHandler.call(this)||this).app=app,_this.store={},_this.schema=[],_this}_inheritsLoose(ComponentSystem,_EventHandler),ComponentSystem._helper=function _helper(a,p){for(var i=0,l=a.length;i<l;i++)a[i].f.call(a[i].s,p)},ComponentSystem.initialize=function initialize(root){this._helper(this._init,root)},ComponentSystem.postInitialize=function postInitialize(root){this._helper(this._postInit,root),this.fire("postinitialize",root)},ComponentSystem.update=function update(dt,inTools){this._helper(inTools?this._toolsUpdate:this._update,dt)},ComponentSystem.animationUpdate=function animationUpdate(dt,inTools){this._helper(this._animationUpdate,dt)},ComponentSystem.fixedUpdate=function fixedUpdate(dt,inTools){this._helper(this._fixedUpdate,dt)},ComponentSystem.postUpdate=function postUpdate(dt,inTools){this._helper(this._postUpdate,dt)},ComponentSystem.bind=function bind(event,func,scope){switch(event){case"initialize":this._init.push({f:func,s:scope});break;case"postInitialize":this._postInit.push({f:func,s:scope});break;case"update":this._update.push({f:func,s:scope});break;case"animationUpdate":this._animationUpdate.push({f:func,s:scope});break;case"postUpdate":this._postUpdate.push({f:func,s:scope});break;case"fixedUpdate":this._fixedUpdate.push({f:func,s:scope});break;case"toolsUpdate":this._toolsUpdate.push({f:func,s:scope});break;default:console.error("Component System does not support event",event)}},ComponentSystem._erase=function _erase(a,f,s){for(var i=0;i<a.length;i++)a[i].f===f&&a[i].s===s&&a.splice(i--,1)},ComponentSystem.unbind=function unbind(event,func,scope){switch(event){case"initialize":this._erase(this._init,func,scope);break;case"postInitialize":this._erase(this._postInit,func,scope);break;case"update":this._erase(this._update,func,scope);break;case"animationUpdate":this._erase(this._animationUpdate,func,scope);break;case"postUpdate":this._erase(this._postUpdate,func,scope);break;case"fixedUpdate":this._erase(this._fixedUpdate,func,scope);break;case"toolsUpdate":this._erase(this._toolsUpdate,func,scope);break;default:console.error("Component System does not support event",event)}};var _proto=ComponentSystem.prototype;return _proto.addComponent=function addComponent(entity,data){var component=new this.ComponentType(this,entity),componentData=new this.DataType;return data=data||{},this.store[entity.getGuid()]={entity:entity,data:componentData},entity[this.id]=component,entity.c[this.id]=component,this.initializeComponentData(component,data,[]),this.fire("add",entity,component),component},_proto.removeComponent=function removeComponent(entity){var record=this.store[entity.getGuid()],component=entity.c[this.id];this.fire("beforeremove",entity,component),delete this.store[entity.getGuid()],delete entity[this.id],delete entity.c[this.id],this.fire("remove",entity,record.data)},_proto.cloneComponent=function cloneComponent(entity,clone){var src=this.store[entity.getGuid()];return this.addComponent(clone,src.data)},_proto.initializeComponentData=function initializeComponentData(component,data,properties){var descriptor,name,type,value;void 0===data&&(data={});for(var i=0,len=properties.length;i<len;i++)"object"==typeof(descriptor=properties[i])?(name=descriptor.name,type=descriptor.type):(name=descriptor,type=void 0),void 0!==(value=data[name])?(void 0!==type&&(value=convertValue(value,type)),component[name]=value):component[name]=component.data[name];component.enabled&&component.entity.enabled&&component.onEnable()},_proto.getPropertiesOfType=function getPropertiesOfType(type){var matchingProperties=[],schema;return(this.schema||[]).forEach((function(descriptor){descriptor&&"object"==typeof descriptor&&descriptor.type===type&&matchingProperties.push(descriptor)})),matchingProperties},_proto.destroy=function destroy(){this.off()},ComponentSystem}(EventHandler);function convertValue(value,type){if(!value)return value;switch(type){case"rgb":return value instanceof Color?value.clone():new Color(value[0],value[1],value[2]);case"rgba":return value instanceof Color?value.clone():new Color(value[0],value[1],value[2],value[3]);case"vec2":return value instanceof Vec2?value.clone():new Vec2(value[0],value[1]);case"vec3":return value instanceof Vec3?value.clone():new Vec3(value[0],value[1],value[2]);case"vec4":return value instanceof Vec4?value.clone():new Vec4(value[0],value[1],value[2],value[3]);case"boolean":case"number":case"string":case"entity":return value;default:throw new Error("Could not convert unhandled type: "+type)}}ComponentSystem._init=[],ComponentSystem._postInit=[],ComponentSystem._toolsUpdate=[],ComponentSystem._update=[],ComponentSystem._animationUpdate=[],ComponentSystem._fixedUpdate=[],ComponentSystem._postUpdate=[],events.attach(ComponentSystem),ComponentSystem.destroy=function(){ComponentSystem.off("initialize"),ComponentSystem.off("postInitialize"),ComponentSystem.off("toolsUpdate"),ComponentSystem.off("update"),ComponentSystem.off("animationUpdate"),ComponentSystem.off("fixedUpdate"),ComponentSystem.off("postUpdate"),ComponentSystem._init=[],ComponentSystem._postInit=[],ComponentSystem._toolsUpdate=[],ComponentSystem._update=[],ComponentSystem._animationUpdate=[],ComponentSystem._fixedUpdate=[],ComponentSystem._postUpdate=[]};var AnimCache=function(){function AnimCache(){this._left=1/0,this._right=-1/0,this._len=0,this._recip=0,this._p0=0,this._p1=0,this._t=0,this._hermite={valid:!1,p0:0,m0:0,p1:0,m1:0}}var _proto=AnimCache.prototype;return _proto.update=function update(time,input){if(time<this._left||time>=this._right){var len=input.length;if(len)if(time<input[0])this._left=-1/0,this._right=input[0],this._len=0,this._recip=0,this._p0=this._p1=0;else if(time>=input[len-1])this._left=input[len-1],this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=len-1;else{var index=this._findKey(time,input);this._left=input[index],this._right=input[index+1],this._len=this._right-this._left;var diff=1/this._len;this._recip=isFinite(diff)?diff:0,this._p0=index,this._p1=index+1}else this._left=-1/0,this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=0}this._t=0===this._recip?0:(time-this._left)*this._recip,this._hermite.valid=!1},_proto._findKey=function _findKey(time,input){for(var index=0;time>=input[index+1];)index++;return index},_proto.eval=function _eval(result,interpolation,output){var data=output._data,comp=output._components,idx0=this._p0*comp,i;if(0===interpolation)for(i=0;i<comp;++i)result[i]=data[idx0+i];else{var t=this._t,idx1=this._p1*comp;switch(interpolation){case 1:for(i=0;i<comp;++i)result[i]=math.lerp(data[idx0+i],data[idx1+i],t);break;case 2:var hermite=this._hermite;if(!hermite.valid){var t2=t*t,twot=t+t,omt=1-t,omt2=omt*omt;hermite.valid=!0,hermite.p0=(1+twot)*omt2,hermite.m0=t*omt2,hermite.p1=t2*(3-twot),hermite.m1=t2*(t-1)}var p0=(3*this._p0+1)*comp,m0=(3*this._p0+2)*comp,p1=(3*this._p1+1)*comp,m1=(3*this._p1+0)*comp;for(i=0;i<comp;++i)result[i]=hermite.p0*data[p0+i]+hermite.m0*data[m0+i]*this._len+hermite.p1*data[p1+i]+hermite.m1*data[m1+i]*this._len}}},AnimCache}(),AnimSnapshot=function AnimSnapshot(animTrack){var i;for(this._name=animTrack.name+"Snapshot",this._time=-1,this._cache=[],this._results=[],i=0;i<animTrack._inputs.length;++i)this._cache[i]=new AnimCache;var curves=animTrack._curves,outputs=animTrack._outputs;for(i=0;i<curves.length;++i){for(var curve,output=outputs[curves[i]._output],storage=[],j=0;j<output._components;++j)storage[j]=0;this._results[i]=storage}},AnimClip=function(){function AnimClip(track,time,speed,playing,loop,eventHandler){for(this._name=track.name,this._track=track,this._snapshot=new AnimSnapshot(track),this._playing=playing,this._time=time,this._speed=speed,this._loop=loop,this._blendWeight=1,this._blendOrder=0,this._eventHandler=eventHandler,this._eventCursor=0;this._track.events[this._eventCursor]&&this._track.events[this._eventCursor].time<this.time;)this._eventCursor++}var _proto=AnimClip.prototype;return _proto.activeEventsForFrame=function activeEventsForFrame(frameStartTime,frameEndTime){var clippedFrameDuration;for(0===frameStartTime&&(this.eventCursor=0),frameEndTime>this.track.duration&&(clippedFrameDuration=frameEndTime-this.track.duration,frameEndTime=this.track.duration);this.track.events[this.eventCursor]&&this.track.events[this.eventCursor].time>=frameStartTime&&(frameEndTime===this.track.duration?this.track.events[this.eventCursor].time<=frameEndTime:this.track.events[this.eventCursor].time<frameEndTime);){var event=this.track.events[this.eventCursor];this._eventHandler.fire(event.name,_extends({track:this.track},event)),this.eventCursor++}Number.isFinite(clippedFrameDuration)&&this.activeEventsForFrame(0,clippedFrameDuration)},_proto._update=function _update(deltaTime){if(this._playing){var time=this._time,duration=this._track.duration,speed=this._speed,loop=this._loop;this._track.events.length>0&&duration>0&&this.activeEventsForFrame(time,time+speed*deltaTime),time+=speed*deltaTime,speed>=0?time>duration&&(loop?time=time%duration||0:(time=this._track.duration,this.pause())):time<0&&(loop?time=duration+(time%duration||0):(time=0,this.pause())),this._time=time}this._time!==this._snapshot._time&&this._track.eval(this._time,this._snapshot)},_proto.play=function play(){this._playing=!0,this._time=0},_proto.stop=function stop(){this._playing=!1,this._time=0},_proto.pause=function pause(){this._playing=!1},_proto.resume=function resume(){this._playing=!0},_proto.reset=function reset(){this._time=0},_createClass(AnimClip,[{key:"name",get:function get(){return this._name},set:function set(name){this._name=name}},{key:"track",get:function get(){return this._track}},{key:"snapshot",get:function get(){return this._snapshot}},{key:"time",get:function get(){return this._time},set:function set(time){this._time=time}},{key:"speed",get:function get(){return this._speed},set:function set(speed){this._speed=speed}},{key:"loop",get:function get(){return this._loop},set:function set(loop){this._loop=loop}},{key:"blendWeight",get:function get(){return this._blendWeight},set:function set(blendWeight){this._blendWeight=blendWeight}},{key:"blendOrder",get:function get(){return this._blendOrder},set:function set(blendOrder){this._blendOrder=blendOrder}},{key:"eventCursor",get:function get(){return this._eventCursor},set:function set(value){this._eventCursor=value}}]),AnimClip}(),AnimEvaluator=function(){function AnimEvaluator(binder){this._binder=binder,this._clips=[],this._inputs=[],this._outputs=[],this._targets={}}AnimEvaluator._dot=function _dot(a,b){for(var len=a.length,result=0,i=0;i<len;++i)result+=a[i]*b[i];return result},AnimEvaluator._normalize=function _normalize(a){var l=AnimEvaluator._dot(a,a);if(l>0){l=1/Math.sqrt(l);for(var len=a.length,i=0;i<len;++i)a[i]*=l}},AnimEvaluator._set=function _set(a,b,type){var len=a.length,i;if("quaternion"===type){var l=AnimEvaluator._dot(b,b);for(l>0&&(l=1/Math.sqrt(l)),i=0;i<len;++i)a[i]=b[i]*l}else for(i=0;i<len;++i)a[i]=b[i]},AnimEvaluator._blendVec=function _blendVec(a,b,t){for(var it=1-t,len=a.length,i=0;i<len;++i)a[i]=a[i]*it+b[i]*t},AnimEvaluator._blendQuat=function _blendQuat(a,b,t){var len=a.length,it=1-t;AnimEvaluator._dot(a,b)<0&&(t=-t);for(var i=0;i<len;++i)a[i]=a[i]*it+b[i]*t;AnimEvaluator._normalize(a)},AnimEvaluator._blend=function _blend(a,b,t,type){"quaternion"===type?AnimEvaluator._blendQuat(a,b,t):AnimEvaluator._blendVec(a,b,t)},AnimEvaluator._stableSort=function _stableSort(a,lessFunc){for(var len=a.length,i=0;i<len-1;++i)for(var j=i+1;j<len;++j)if(lessFunc(a[j],a[i])){var tmp=a[i];a[i]=a[j],a[j]=tmp}};var _proto=AnimEvaluator.prototype;return _proto.addClip=function addClip(clip){for(var targets=this._targets,curves=clip.track.curves,snapshot=clip.snapshot,inputs=[],outputs=[],i=0;i<curves.length;++i)for(var curve,paths=curves[i].paths,j=0;j<paths.length;++j){var path=paths[j],resolved=this._binder.resolve(path),target=targets[resolved&&resolved.targetPath||null];if(!target&&resolved){target={target:resolved,value:[],curves:0,blendCounter:0};for(var k=0;k<target.target.components;++k)target.value.push(0);targets[resolved.targetPath]=target}target&&(target.curves++,inputs.push(snapshot._results[i]),outputs.push(target))}this._clips.push(clip),this._inputs.push(inputs),this._outputs.push(outputs)},_proto.removeClip=function removeClip(index){for(var targets=this._targets,clips=this._clips,clip,curves=clips[index].track.curves,i=0;i<curves.length;++i)for(var curve,paths=curves[i].paths,j=0;j<paths.length;++j){var path=paths[j],target=this._binder.resolve(path);target&&(target.curves--,0===target.curves&&(this._binder.unresolve(path),delete targets[target.targetPath]))}clips.splice(index,1),this._inputs.splice(index,1),this._outputs.splice(index,1)},_proto.removeClips=function removeClips(){for(;this._clips.length>0;)this.removeClip(0)},_proto.findClip=function findClip(name){for(var clips=this._clips,i=0;i<clips.length;++i){var clip=clips[i];if(clip.name===name)return clip}return null},_proto.rebind=function rebind(){var _this=this;this._binder.rebind(),this._targets={};var clips=[].concat(this.clips);this.removeClips(),clips.forEach((function(clip){_this.addClip(clip)}))},_proto.update=function update(deltaTime){var clips=this._clips,order=clips.map((function(c,i){return i})),i,j;for(AnimEvaluator._stableSort(order,(function(a,b){return clips[a].blendOrder<clips[b].blendOrder})),i=0;i<clips.length;++i){var index=order[i],clip=clips[index],inputs=this._inputs[index],outputs=this._outputs[index],blendWeight=clip.blendWeight,input,output,value;if(blendWeight>0&&clip._update(deltaTime),blendWeight>=1)for(j=0;j<inputs.length;++j)input=inputs[j],value=(output=outputs[j]).value,AnimEvaluator._set(value,input,output.target.type),output.blendCounter++;else if(blendWeight>0)for(j=0;j<inputs.length;++j)input=inputs[j],value=(output=outputs[j]).value,0===output.blendCounter?AnimEvaluator._set(value,input,output.target.type):AnimEvaluator._blend(value,input,blendWeight,output.target.type),output.blendCounter++}var targets=this._targets;for(var path in targets)if(targets.hasOwnProperty(path)){var target=targets[path];target.target.func(target.value),target.blendCounter=0}this._binder.update(deltaTime)},_createClass(AnimEvaluator,[{key:"clips",get:function get(){return this._clips}}]),AnimEvaluator}(),AnimTarget=function(){function AnimTarget(func,type,components,targetPath){this._func=func,this._type=type,this._components=components,this._targetPath=targetPath}return _createClass(AnimTarget,[{key:"func",get:function get(){return this._func}},{key:"type",get:function get(){return this._type}},{key:"components",get:function get(){return this._components}},{key:"targetPath",get:function get(){return this._targetPath}}]),AnimTarget}(),DefaultAnimBinder=function(){function DefaultAnimBinder(graph){if(this.graph=graph,graph){var nodes={},flatten;(function flatten(node){nodes[node.name]=node;for(var i=0;i<node.children.length;++i)flatten(node.children[i])})(graph),this.nodes=nodes,this.targetCache={};var findMeshInstances=function findMeshInstances(node){for(var object=node,meshInstances;object&&!(object instanceof Entity);)object=object.parent;return object&&(object.render?meshInstances=object.render.meshInstances:object.model&&(meshInstances=object.model.meshInstances)),meshInstances};this.nodeCounts={},this.activeNodes=[],this.handlers={localPosition:function localPosition(node){var object=node.localPosition,func=function func(value){object.set.apply(object,value)};return DefaultAnimBinder.createAnimTarget(func,"vector",3,node,"localPosition")},localRotation:function localRotation(node){var object=node.localRotation,func=function func(value){object.set.apply(object,value)};return DefaultAnimBinder.createAnimTarget(func,"quaternion",4,node,"localRotation")},localScale:function localScale(node){var object=node.localScale,func=function func(value){object.set.apply(object,value)};return DefaultAnimBinder.createAnimTarget(func,"vector",3,node,"localScale")},weights:function weights(node){var meshInstances=findMeshInstances(node);if(meshInstances){for(var morphInstances=[],i=0;i<meshInstances.length;++i)meshInstances[i].node.name===node.name&&meshInstances[i].morphInstance&&morphInstances.push(meshInstances[i].morphInstance);if(morphInstances.length>0){var func=function func(value){for(var i=0;i<value.length;++i)for(var j=0;j<morphInstances.length;j++)morphInstances[j].setWeight(i,value[i])};return DefaultAnimBinder.createAnimTarget(func,"vector",morphInstances[0].morph._targets.length,node,"weights")}}return null},materialTexture:function(node,textureName){var meshInstances=findMeshInstances(node);if(meshInstances){for(var meshInstance,i=0;i<meshInstances.length;++i)if(meshInstances[i].node.name===node.name){meshInstance=meshInstances[i];break}if(meshInstance){var func=function(value){var textureAsset=this.animComponent.system.app.assets.get(value[0]);textureAsset&&textureAsset.resource&&"texture"===textureAsset.type&&(meshInstance.material[textureName]=textureAsset.resource,meshInstance.material.update())}.bind(this);return DefaultAnimBinder.createAnimTarget(func,"vector",1,node,"materialTexture","material")}}return null}.bind(this)}}}var _proto=DefaultAnimBinder.prototype;return _proto.findNode=function findNode(path){var node;return this.graph&&(node=this.graph.findByPath(path.entityPath)),node||(node=this.nodes[path.entityPath[path.entityPath.length-1]||""]),node},DefaultAnimBinder.createAnimTarget=function createAnimTarget(func,type,valueCount,node,propertyPath,componentType){var targetPath=AnimBinder.encode(node.path,componentType||"entity",propertyPath);return new AnimTarget(func,type,valueCount,targetPath)},_proto.resolve=function resolve(path){var encodedPath=AnimBinder.encode(path.entityPath,path.component,path.propertyPath),target=this.targetCache[encodedPath];if(target)return target;var node=this.findNode(path);if(!node)return null;var handler=this.handlers[path.propertyPath];return handler&&(target=handler(node))?(this.targetCache[encodedPath]=target,this.nodeCounts[node.path]?this.nodeCounts[node.path]++:(this.activeNodes.push(node),this.nodeCounts[node.path]=1),target):null},_proto.unresolve=function unresolve(path){if("graph"===path.component){var node=this.nodes[path.entityPath[path.entityPath.length-1]||""];if(this.nodeCounts[node.path]--,0===this.nodeCounts[node.path]){var activeNodes=this.activeNodes,i=activeNodes.indexOf(node.node),len=activeNodes.length;i<len-1&&(activeNodes[i]=activeNodes[len-1]),activeNodes.pop()}}},_proto.update=function update(deltaTime){for(var activeNodes=this.activeNodes,i=0;i<activeNodes.length;++i)activeNodes[i]._dirtifyLocal()},DefaultAnimBinder}(),InterpolatedKey=function(){function InterpolatedKey(){this._written=!1,this._name="",this._keyFrames=[],this._quat=new Quat,this._pos=new Vec3,this._scale=new Vec3,this._targetNode=null}var _proto=InterpolatedKey.prototype;return _proto.getTarget=function getTarget(){return this._targetNode},_proto.setTarget=function setTarget(node){this._targetNode=node},InterpolatedKey}(),Skeleton=function(){function Skeleton(graph){this._animation=null,this._time=0,this.looping=!0,this._interpolatedKeys=[],this._interpolatedKeyDict={},this._currKeyIndices={},this.graph=null;var self=this;function addInterpolatedKeys(node){var interpKey=new InterpolatedKey;interpKey._name=node.name,self._interpolatedKeys.push(interpKey),self._interpolatedKeyDict[node.name]=interpKey,self._currKeyIndices[node.name]=0;for(var i=0;i<node._children.length;i++)addInterpolatedKeys(node._children[i])}addInterpolatedKeys(graph)}var _proto2=Skeleton.prototype;return _proto2.addTime=function addTime(delta){if(null!==this._animation){var i,node,nodeName,keys,interpKey,k1,k2,alpha,nodes=this._animation._nodes,duration=this._animation.duration;if(this._time===duration&&!this.looping)return;if(this._time+=delta,this._time>duration)for(this._time=this.looping?0:duration,i=0;i<nodes.length;i++)nodeName=(node=nodes[i])._name,this._currKeyIndices[nodeName]=0;else if(this._time<0)for(this._time=this.looping?duration:0,i=0;i<nodes.length;i++)nodeName=(node=nodes[i])._name,this._currKeyIndices[nodeName]=node._keys.length-2;var offset=delta>=0?1:-1,foundKey;for(i=0;i<nodes.length;i++)if(nodeName=(node=nodes[i])._name,keys=node._keys,void 0!==(interpKey=this._interpolatedKeyDict[nodeName])){if(foundKey=!1,1!==keys.length)for(var currKeyIndex=this._currKeyIndices[nodeName];currKeyIndex<keys.length-1&&currKeyIndex>=0;currKeyIndex+=offset)if(k1=keys[currKeyIndex],k2=keys[currKeyIndex+1],k1.time<=this._time&&k2.time>=this._time){alpha=(this._time-k1.time)/(k2.time-k1.time),interpKey._pos.lerp(k1.position,k2.position,alpha),interpKey._quat.slerp(k1.rotation,k2.rotation,alpha),interpKey._scale.lerp(k1.scale,k2.scale,alpha),interpKey._written=!0,this._currKeyIndices[nodeName]=currKeyIndex,foundKey=!0;break}(1===keys.length||!foundKey&&0===this._time&&this.looping)&&(interpKey._pos.copy(keys[0].position),interpKey._quat.copy(keys[0].rotation),interpKey._scale.copy(keys[0].scale),interpKey._written=!0)}}},_proto2.blend=function blend(skel1,skel2,alpha){for(var numNodes=this._interpolatedKeys.length,i=0;i<numNodes;i++){var key1=skel1._interpolatedKeys[i],key2=skel2._interpolatedKeys[i],dstKey=this._interpolatedKeys[i];key1._written&&key2._written?(dstKey._quat.slerp(key1._quat,skel2._interpolatedKeys[i]._quat,alpha),dstKey._pos.lerp(key1._pos,skel2._interpolatedKeys[i]._pos,alpha),dstKey._scale.lerp(key1._scale,key2._scale,alpha),dstKey._written=!0):key1._written?(dstKey._quat.copy(key1._quat),dstKey._pos.copy(key1._pos),dstKey._scale.copy(key1._scale),dstKey._written=!0):key2._written&&(dstKey._quat.copy(key2._quat),dstKey._pos.copy(key2._pos),dstKey._scale.copy(key2._scale),dstKey._written=!0)}},_proto2.setGraph=function setGraph(graph){var i;if(this.graph=graph,graph)for(i=0;i<this._interpolatedKeys.length;i++){var interpKey=this._interpolatedKeys[i],graphNode=graph.findByName(interpKey._name);this._interpolatedKeys[i].setTarget(graphNode)}else for(i=0;i<this._interpolatedKeys.length;i++)this._interpolatedKeys[i].setTarget(null)},_proto2.updateGraph=function updateGraph(){if(this.graph)for(var i=0;i<this._interpolatedKeys.length;i++){var interpKey=this._interpolatedKeys[i];if(interpKey._written){var transform=interpKey.getTarget();transform.localPosition.copy(interpKey._pos),transform.localRotation.copy(interpKey._quat),transform.localScale.copy(interpKey._scale),transform._dirtyLocal||transform._dirtifyLocal(),interpKey._written=!1}}},_createClass(Skeleton,[{key:"animation",get:function get(){return this._animation},set:function set(value){this._animation=value,this.currentTime=0}},{key:"currentTime",get:function get(){return this._time},set:function set(value){this._time=value;for(var numNodes=this._interpolatedKeys.length,i=0;i<numNodes;i++){var node,nodeName=this._interpolatedKeys[i]._name;this._currKeyIndices[nodeName]=0}this.addTime(0),this.updateGraph()}},{key:"numNodes",get:function get(){return this._interpolatedKeys.length}}]),Skeleton}(),AnimationComponent=function(_Component){function AnimationComponent(system,entity){var _this;return(_this=_Component.call(this,system,entity)||this).animationsIndex={},_this.on("set_animations",_this.onSetAnimations,_assertThisInitialized(_this)),_this.on("set_assets",_this.onSetAssets,_assertThisInitialized(_this)),_this.on("set_loop",_this.onSetLoop,_assertThisInitialized(_this)),_this}_inheritsLoose(AnimationComponent,_Component);var _proto=AnimationComponent.prototype;return _proto.play=function play(name,blendTime){if(this.enabled&&this.entity.enabled){var data=this.data;if(data.animations[name]){if(blendTime=blendTime||0,data.prevAnim=data.currAnim,data.currAnim=name,data.model){data.skeleton||data.animEvaluator||this._createAnimationController();var prevAnim=data.animations[data.prevAnim],currAnim=data.animations[data.currAnim];if(data.blending=blendTime>0&&data.prevAnim,data.blending&&(data.blend=0,data.blendSpeed=1/blendTime),data.skeleton&&(data.blending?(data.fromSkel.animation=prevAnim,data.fromSkel.addTime(data.skeleton._time),data.toSkel.animation=currAnim):data.skeleton.animation=currAnim),data.animEvaluator){var animEvaluator=data.animEvaluator;if(data.blending)for(;animEvaluator.clips.length>1;)animEvaluator.removeClip(0);else data.animEvaluator.removeClips();var clip=new AnimClip(data.animations[data.currAnim],0,1,!0,data.loop);clip.name=data.currAnim,clip.blendWeight=data.blending?0:1,clip.reset(),data.animEvaluator.addClip(clip)}}data.playing=!0}}},_proto.getAnimation=function getAnimation(name){return this.data.animations[name]},_proto.setModel=function setModel(model){var data=this.data;model!==data.model&&(this._resetAnimationController(),data.model=model,data.animations&&data.currAnim&&data.animations[data.currAnim]&&this.play(data.currAnim))},_proto._resetAnimationController=function _resetAnimationController(){var data=this.data;data.skeleton=null,data.fromSkel=null,data.toSkel=null,data.animEvaluator=null},_proto._createAnimationController=function _createAnimationController(){var data=this.data,model=data.model,animations=data.animations,hasJson=!1,hasGlb=!1;for(var animation in animations){var anim;if(animations.hasOwnProperty(animation))animations[animation].constructor===AnimTrack?hasGlb=!0:hasJson=!0}var graph=model.getGraph();hasJson?(data.fromSkel=new Skeleton(graph),data.toSkel=new Skeleton(graph),data.skeleton=new Skeleton(graph),data.skeleton.looping=data.loop,data.skeleton.setGraph(graph)):hasGlb&&(data.animEvaluator=new AnimEvaluator(new DefaultAnimBinder(this.entity)))},_proto.loadAnimationAssets=function loadAnimationAssets(ids){if(ids&&ids.length){var self=this,assets=this.system.app.assets,i,l=ids.length,onAssetReady=function onAssetReady(asset){if(asset.resources.length>1)for(var i=0;i<asset.resources.length;i++)self.animations[asset.resources[i].name]=asset.resources[i],self.animationsIndex[asset.id]=asset.resources[i].name;else self.animations[asset.name]=asset.resource,self.animationsIndex[asset.id]=asset.name;self.animations=self.animations},onAssetAdd=function onAssetAdd(asset){asset.off("change",self.onAssetChanged,self),asset.on("change",self.onAssetChanged,self),asset.off("remove",self.onAssetRemoved,self),asset.on("remove",self.onAssetRemoved,self),asset.resource?onAssetReady(asset):(asset.once("load",onAssetReady,self),self.enabled&&self.entity.enabled&&assets.load(asset))};for(i=0;i<l;i++){var asset=assets.get(ids[i]);asset?onAssetAdd(asset):assets.on("add:"+ids[i],onAssetAdd)}}},_proto.onAssetChanged=function onAssetChanged(asset,attribute,newValue,oldValue){var i;if("resource"===attribute||"resources"===attribute)if("resources"===attribute&&newValue&&0===newValue.length&&(newValue=null),newValue){var restarted=!1;if(newValue.length>1){if(oldValue&&oldValue.length>1)for(i=0;i<oldValue.length;i++)delete this.animations[oldValue[i].name];else delete this.animations[asset.name];for(restarted=!1,i=0;i<newValue.length;i++)this.animations[newValue[i].name]=newValue[i],restarted||this.data.currAnim!==newValue[i].name||this.data.playing&&this.data.enabled&&this.entity.enabled&&(restarted=!0,this.play(newValue[i].name,0));restarted||(this._stopCurrentAnimation(),this.onSetAnimations())}else{if(oldValue&&oldValue.length>1)for(i=0;i<oldValue.length;i++)delete this.animations[oldValue[i].name];this.animations[asset.name]=newValue[0]||newValue,restarted=!1,this.data.currAnim===asset.name&&this.data.playing&&this.data.enabled&&this.entity.enabled&&(restarted=!0,this.play(asset.name,0)),restarted||(this._stopCurrentAnimation(),this.onSetAnimations())}this.animationsIndex[asset.id]=asset.name}else{if(oldValue.length>1)for(i=0;i<oldValue.length;i++)delete this.animations[oldValue[i].name],this.data.currAnim===oldValue[i].name&&this._stopCurrentAnimation();else delete this.animations[asset.name],this.data.currAnim===asset.name&&this._stopCurrentAnimation();delete this.animationsIndex[asset.id]}},_proto.onAssetRemoved=function onAssetRemoved(asset){if(asset.off("remove",this.onAssetRemoved,this),this.animations){if(asset.resources.length>1)for(var i=0;i<asset.resources.length;i++)delete this.animations[asset.resources[i].name],this.data.currAnim===asset.resources[i].name&&this._stopCurrentAnimation();else delete this.animations[asset.name],this.data.currAnim===asset.name&&this._stopCurrentAnimation();delete this.animationsIndex[asset.id]}},_proto._stopCurrentAnimation=function _stopCurrentAnimation(){var data=this.data;if(data.currAnim=null,data.playing=!1,data.skeleton&&(data.skeleton.currentTime=0,data.skeleton.animation=null),data.animEvaluator){for(var i=0;i<data.animEvaluator.clips.length;++i)data.animEvaluator.clips[i].stop();data.animEvaluator.update(0),data.animEvaluator.removeClips()}},_proto.onSetAnimations=function onSetAnimations(name,oldValue,newValue){var data=this.data,modelComponent=this.entity.model;if(modelComponent){var m=modelComponent.model;m&&m!==data.model&&this.setModel(m)}if(!data.currAnim&&data.activate&&data.enabled&&this.entity.enabled)for(var animName in data.animations){this.play(animName,0);break}},_proto.onSetAssets=function onSetAssets(name,oldValue,newValue){if(oldValue&&oldValue.length)for(var i=0;i<oldValue.length;i++)if(oldValue[i]){var asset=this.system.app.assets.get(oldValue[i]);if(asset){asset.off("change",this.onAssetChanged,this),asset.off("remove",this.onAssetRemoved,this);var animName=this.animationsIndex[asset.id];this.data.currAnim===animName&&this._stopCurrentAnimation(),delete this.animations[animName],delete this.animationsIndex[asset.id]}}var ids=newValue.map((function(value){return value instanceof Asset?value.id:value}));this.loadAnimationAssets(ids)},_proto.onSetLoop=function onSetLoop(name,oldValue,newValue){var data=this.data;if(data.skeleton&&(data.skeleton.looping=data.loop),data.animEvaluator)for(var i=0;i<data.animEvaluator.clips.length;++i)data.animEvaluator.clips[i].loop=data.loop},_proto.onSetCurrentTime=function onSetCurrentTime(name,oldValue,newValue){var data=this.data;if(data.skeleton){var skeleton=data.skeleton;skeleton.currentTime=newValue,skeleton.addTime(0),skeleton.updateGraph()}if(data.animEvaluator)for(var animEvaluator=data.animEvaluator,i=0;i<animEvaluator.clips.length;++i)animEvaluator.clips[i].time=newValue},_proto.onEnable=function onEnable(){_Component.prototype.onEnable.call(this);var data=this.data,assets=data.assets,registry=this.system.app.assets;if(assets)for(var i=0,len=assets.length;i<len;i++){var asset=assets[i];asset instanceof Asset||(asset=registry.get(asset)),asset&&!asset.resource&&registry.load(asset)}if(data.activate&&!data.currAnim)for(var animName in data.animations){this.play(animName,0);break}},_proto.onBeforeRemove=function onBeforeRemove(){for(var i=0;i<this.assets.length;i++){var asset=this.assets[i];"number"==typeof asset&&(asset=this.system.app.assets.get(asset)),asset&&(asset.off("change",this.onAssetChanged,this),asset.off("remove",this.onAssetRemoved,this))}var data=this.data;delete data.animation,delete data.skeleton,delete data.fromSkel,delete data.toSkel,delete data.animEvaluator},_createClass(AnimationComponent,[{key:"currentTime",get:function get(){var data=this.data;if(data.skeleton)return this.data.skeleton._time;if(data.animEvaluator){var clips=data.animEvaluator.clips;if(clips.length>0)return clips[clips.length-1].time}return 0},set:function set(currentTime){var data=this.data;if(data.skeleton){var skeleton=data.skeleton;skeleton.currentTime=currentTime,skeleton.addTime(0),skeleton.updateGraph()}if(data.animEvaluator)for(var animEvaluator=data.animEvaluator,i=0;i<animEvaluator.clips.length;++i)animEvaluator.clips[i].time=currentTime}},{key:"duration",get:function get(){return this.data.animations[this.data.currAnim].duration}}]),AnimationComponent}(Component),AnimationComponentData=function AnimationComponentData(){this.assets=[],this.speed=1,this.loop=!0,this.activate=!0,this.enabled=!0,this.animations={},this.model=null,this.prevAnim=null,this.currAnim=null,this.blending=!1,this.blend=0,this.blendSpeed=0,this.playing=!1,this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animEvaluator=null},_schema$l=["enabled","assets","speed","loop","activate","animations","skeleton","model","prevAnim","currAnim","fromSkel","toSkel","blending","blendTimeRemaining","playing"],AnimationComponentSystem=function(_ComponentSystem){function AnimationComponentSystem(app){var _this;return(_this=_ComponentSystem.call(this,app)||this).id="animation",_this.ComponentType=AnimationComponent,_this.DataType=AnimationComponentData,_this.schema=_schema$l,_this.on("beforeremove",_this.onBeforeRemove,_assertThisInitialized(_this)),_this.on("update",_this.onUpdate,_assertThisInitialized(_this)),ComponentSystem.bind("update",_this.onUpdate,_assertThisInitialized(_this)),_this}_inheritsLoose(AnimationComponentSystem,_ComponentSystem);var _proto=AnimationComponentSystem.prototype;return _proto.initializeComponentData=function initializeComponentData(component,data,properties){properties=["activate","enabled","loop","speed","assets"],_ComponentSystem.prototype.initializeComponentData.call(this,component,data,properties)},_proto.cloneComponent=function cloneComponent(entity,clone){var key;this.addComponent(clone,{}),clone.animation.assets=entity.animation.assets.slice(),clone.animation.data.speed=entity.animation.speed,clone.animation.data.loop=entity.animation.loop,clone.animation.data.activate=entity.animation.activate,clone.animation.data.enabled=entity.animation.enabled;var clonedAnimations={},animations=entity.animation.animations;for(key in animations)animations.hasOwnProperty(key)&&(clonedAnimations[key]=animations[key]);clone.animation.animations=clonedAnimations;var clonedAnimationsIndex={},animationsIndex=entity.animation.animationsIndex;for(key in animationsIndex)animationsIndex.hasOwnProperty(key)&&(clonedAnimationsIndex[key]=animationsIndex[key]);clone.animation.animationsIndex=clonedAnimationsIndex},_proto.onBeforeRemove=function onBeforeRemove(entity,component){component.onBeforeRemove()},_proto.onUpdate=function onUpdate(dt){var components=this.store;for(var id in components)if(components.hasOwnProperty(id)){var component=components[id],componentData=component.data;if(componentData.enabled&&component.entity.enabled){if(componentData.blending&&(componentData.blend+=dt*componentData.blendSpeed,componentData.blend>=1&&(componentData.blend=1)),componentData.playing){var skeleton=componentData.skeleton;if(null!==skeleton&&null!==componentData.model){if(componentData.blending)skeleton.blend(componentData.fromSkel,componentData.toSkel,componentData.blend);else{var delta=dt*componentData.speed;skeleton.addTime(delta),componentData.speed>0&&skeleton._time===skeleton._animation.duration&&!componentData.loop?componentData.playing=!1:componentData.speed<0&&0===skeleton._time&&!componentData.loop&&(componentData.playing=!1)}componentData.blending&&1===componentData.blend&&(skeleton.animation=componentData.toSkel._animation),skeleton.updateGraph()}}var animEvaluator=componentData.animEvaluator;if(animEvaluator){for(var i=0;i<animEvaluator.clips.length;++i){var clip=animEvaluator.clips[i];clip.speed=componentData.speed,componentData.playing?clip.resume():clip.pause()}componentData.blending&&(animEvaluator.clips[1].blendWeight=componentData.blend),animEvaluator.update(dt)}componentData.blending&&1===componentData.blend&&(componentData.blending=!1)}}},AnimationComponentSystem}(ComponentSystem);Component._buildAccessors(AnimationComponent.prototype,_schema$l);var AnimNode=function(){function AnimNode(state,parent,name,point,speed){void 0===speed&&(speed=1),this._state=state,this._parent=parent,this._name=name,Array.isArray(point)?(this._point=new Vec2(point[0],point[1]),this._pointLength=this._point.length()):(this._point=point,this._pointLength=point),this._speed=speed,this._weightedSpeed=1,this._weight=1,this._animTrack=null}return _createClass(AnimNode,[{key:"parent",get:function get(){return this._parent}},{key:"name",get:function get(){return this._name}},{key:"path",get:function get(){return this._parent?this._parent.path+"."+this._name:this._name}},{key:"point",get:function get(){return this._point}},{key:"pointLength",get:function get(){return this._pointLength}},{key:"weight",get:function get(){return this._parent?this._parent.weight*this._weight:this._weight},set:function set(value){this._weight=value}},{key:"normalizedWeight",get:function get(){var totalWeight=this._state.totalWeight;return 0===totalWeight?0:this.weight/totalWeight}},{key:"speed",get:function get(){return this._weightedSpeed*this._speed}},{key:"absoluteSpeed",get:function get(){return Math.abs(this._speed)}},{key:"weightedSpeed",get:function get(){return this._weightedSpeed},set:function set(weightedSpeed){this._weightedSpeed=weightedSpeed}},{key:"animTrack",get:function get(){return this._animTrack},set:function set(value){this._animTrack=value}}]),AnimNode}(),AnimBlendTree=function(_AnimNode){function AnimBlendTree(state,parent,name,point,parameters,children,syncAnimations,createTree,findParameter){var _this;(_this=_AnimNode.call(this,state,parent,name,point)||this)._parameters=parameters,_this._parameterValues=new Array(parameters.length),_this._children=[],_this._findParameter=findParameter,_this._syncAnimations=!1!==syncAnimations,_this._pointCache={};for(var i=0;i<children.length;i++){var child=children[i];child.children?_this._children.push(createTree(child.type,_assertThisInitialized(_this),null,name,1,child.parameter?[child.parameter]:child.parameters,child.children,createTree,findParameter)):_this._children.push(new AnimNode(state,_assertThisInitialized(_this),child.name,child.point,child.speed))}return _this}_inheritsLoose(AnimBlendTree,_AnimNode);var _proto=AnimBlendTree.prototype;return _proto.getChild=function getChild(name){for(var i=0;i<this._children.length;i++)if(this._children[i].name===name)return this._children[i];return null},_proto.updateParameterValues=function updateParameterValues(){for(var paramsEqual=!0,i=0;i<this._parameterValues.length;i++){var updatedParameter=this._findParameter(this._parameters[i]).value;this._parameterValues[i]!==updatedParameter&&(this._parameterValues[i]=updatedParameter,paramsEqual=!1)}return paramsEqual},_proto.getNodeWeightedDuration=function getNodeWeightedDuration(i){return this._children[i].animTrack.duration/this._children[i].speedMultiplier*this._children[i].weight},_proto.getNodeCount=function getNodeCount(){for(var count=0,i=0;i<this._children.length;i++){var child;this._children[i].constructor===AnimBlendTree?count+=this._children[i].getNodeCount():count++}return count},_createClass(AnimBlendTree,[{key:"weight",get:function get(){return this.calculateWeights(),this._parent?this._parent.weight*this._weight:this._weight}},{key:"syncAnimations",get:function get(){return this._syncAnimations}}]),AnimBlendTree}(AnimNode),AnimBlendTree1D=function(_AnimBlendTree){function AnimBlendTree1D(state,parent,name,point,parameters,children,syncAnimations,createTree,findParameter){return children.sort((function(a,b){return a.point-b.point})),_AnimBlendTree.call(this,state,parent,name,point,parameters,children,syncAnimations,createTree,findParameter)||this}var _proto;return _inheritsLoose(AnimBlendTree1D,_AnimBlendTree),AnimBlendTree1D.prototype.calculateWeights=function calculateWeights(){if(!this.updateParameterValues()){var i,weightedDurationSum=0;for(this._children[0].weight=0,i=0;i<this._children.length;i++){var c1=this._children[i];if(i!==this._children.length-1){var c2=this._children[i+1];if(c1.point===c2.point)c1.weight=.5,c2.weight=.5;else if(math.between(this._parameterValues[0],c1.point,c2.point,!0)){var child2Distance=Math.abs(c1.point-c2.point),parameterDistance,weight=(child2Distance-Math.abs(c1.point-this._parameterValues[0]))/child2Distance;c1.weight=weight,c2.weight=1-weight}else c2.weight=0}this._syncAnimations&&(weightedDurationSum+=c1.animTrack.duration/c1.absoluteSpeed*c1.weight)}if(this._syncAnimations)for(i=0;i<this._children.length;i++){var child=this._children[i];child.weightedSpeed=child.animTrack.duration/child.absoluteSpeed/weightedDurationSum}}},AnimBlendTree1D}(AnimBlendTree),AnimBlendTreeCartesian2D=function(_AnimBlendTree){function AnimBlendTreeCartesian2D(){return _AnimBlendTree.apply(this,arguments)||this}_inheritsLoose(AnimBlendTreeCartesian2D,_AnimBlendTree);var _proto=AnimBlendTreeCartesian2D.prototype;return _proto.pointDistanceCache=function pointDistanceCache(i,j){var pointKey=""+i+j;return this._pointCache[pointKey]||(this._pointCache[pointKey]=this._children[j].point.clone().sub(this._children[i].point)),this._pointCache[pointKey]},_proto.calculateWeights=function calculateWeights(){var _AnimBlendTreeCartesi;if(!this.updateParameterValues()){var i,j,pi,pipj,minj,result,weightSum,weightedDurationSum;for((_AnimBlendTreeCartesi=AnimBlendTreeCartesian2D._p).set.apply(_AnimBlendTreeCartesi,this._parameterValues),weightSum=0,weightedDurationSum=0,i=0;i<this._children.length;i++){var _AnimBlendTreeCartesi2,child=this._children[i];for(pi=child.point,(_AnimBlendTreeCartesi2=AnimBlendTreeCartesian2D._pip).set.apply(_AnimBlendTreeCartesi2,AnimBlendTreeCartesian2D._p.data).sub(pi),minj=Number.MAX_VALUE,j=0;j<this._children.length;j++)i!==j&&(pipj=this.pointDistanceCache(i,j),(result=math.clamp(1-AnimBlendTreeCartesian2D._pip.dot(pipj)/pipj.lengthSq(),0,1))<minj&&(minj=result));child.weight=minj,weightSum+=minj,this._syncAnimations&&(weightedDurationSum+=child.animTrack.duration/child.absoluteSpeed*child.weight)}for(i=0;i<this._children.length;i++){var _child=this._children[i];_child.weight=_child._weight/weightSum,this._syncAnimations&&(_child.weightedSpeed=_child.animTrack.duration/_child.absoluteSpeed/weightedDurationSum)}}},AnimBlendTreeCartesian2D}(AnimBlendTree);AnimBlendTreeCartesian2D._p=new Vec2,AnimBlendTreeCartesian2D._pip=new Vec2;var AnimBlendTreeDirectional2D=function(_AnimBlendTree){function AnimBlendTreeDirectional2D(){return _AnimBlendTree.apply(this,arguments)||this}_inheritsLoose(AnimBlendTreeDirectional2D,_AnimBlendTree);var _proto=AnimBlendTreeDirectional2D.prototype;return _proto.pointCache=function pointCache(i,j){var pointKey=""+i+j;return this._pointCache[pointKey]||(this._pointCache[pointKey]=new Vec2((this._children[j].pointLength-this._children[i].pointLength)/((this._children[j].pointLength+this._children[i].pointLength)/2),2*Vec2.angleRad(this._children[i].point,this._children[j].point))),this._pointCache[pointKey]},_proto.calculateWeights=function calculateWeights(){var _AnimBlendTreeDirecti;if(!this.updateParameterValues()){var i,j,pi,pipj,minj,result,weightSum,weightedDurationSum;(_AnimBlendTreeDirecti=AnimBlendTreeDirectional2D._p).set.apply(_AnimBlendTreeDirecti,this._parameterValues);var pLength=AnimBlendTreeDirectional2D._p.length();for(weightSum=0,weightedDurationSum=0,i=0;i<this._children.length;i++){var child=this._children[i];pi=child.point;var piLength=child.pointLength;for(minj=Number.MAX_VALUE,j=0;j<this._children.length;j++)if(i!==j){var pjLength=this._children[j].pointLength;pipj=this.pointCache(i,j),AnimBlendTreeDirectional2D._pip.set((pLength-piLength)/((pjLength+piLength)/2),2*Vec2.angleRad(pi,AnimBlendTreeDirectional2D._p)),(result=math.clamp(1-Math.abs(AnimBlendTreeDirectional2D._pip.dot(pipj)/pipj.lengthSq()),0,1))<minj&&(minj=result)}child.weight=minj,weightSum+=minj,this._syncAnimations&&(weightedDurationSum+=child.animTrack.duration/child.absoluteSpeed*child.weight)}for(i=0;i<this._children.length;i++){var _child=this._children[i];if(_child.weight=_child._weight/weightSum,this._syncAnimations){var weightedChildDuration=_child.animTrack.duration/weightedDurationSum*weightSum;_child.weightedSpeed=_child.absoluteSpeed*weightedChildDuration}}}},AnimBlendTreeDirectional2D}(AnimBlendTree);AnimBlendTreeDirectional2D._p=new Vec2,AnimBlendTreeDirectional2D._pip=new Vec2;var AnimBlendTreeDirect=function(_AnimBlendTree){function AnimBlendTreeDirect(){return _AnimBlendTree.apply(this,arguments)||this}var _proto;return _inheritsLoose(AnimBlendTreeDirect,_AnimBlendTree),AnimBlendTreeDirect.prototype.calculateWeights=function calculateWeights(){if(!this.updateParameterValues()){var i,weightSum=0,weightedDurationSum=0;for(i=0;i<this._children.length;i++)if(weightSum+=Math.max(this._parameterValues[i],0),this._syncAnimations){var child=this._children[i];weightedDurationSum+=child.animTrack.duration/child.absoluteSpeed*child.weight}for(i=0;i<this._children.length;i++){var _child=this._children[i];_child.weight=Math.max(this._parameterValues[i],0)/weightSum,this._syncAnimations&&(_child.weightedSpeed=_child.animTrack.duration/_child.absoluteSpeed/weightedDurationSum)}}},AnimBlendTreeDirect}(AnimBlendTree),ANIM_INTERRUPTION_NONE="NONE",ANIM_INTERRUPTION_PREV="PREV_STATE",ANIM_INTERRUPTION_NEXT="NEXT_STATE",ANIM_INTERRUPTION_PREV_NEXT="PREV_STATE_NEXT_STATE",ANIM_INTERRUPTION_NEXT_PREV="NEXT_STATE_PREV_STATE",ANIM_GREATER_THAN="GREATER_THAN",ANIM_LESS_THAN="LESS_THAN",ANIM_GREATER_THAN_EQUAL_TO="GREATER_THAN_EQUAL_TO",ANIM_LESS_THAN_EQUAL_TO="LESS_THAN_EQUAL_TO",ANIM_EQUAL_TO="EQUAL_TO",ANIM_NOT_EQUAL_TO="NOT_EQUAL_TO",ANIM_PARAMETER_INTEGER="INTEGER",ANIM_PARAMETER_FLOAT="FLOAT",ANIM_PARAMETER_BOOLEAN="BOOLEAN",ANIM_PARAMETER_TRIGGER="TRIGGER",ANIM_BLEND_1D="1D",ANIM_BLEND_2D_DIRECTIONAL="2D_DIRECTIONAL",ANIM_BLEND_2D_CARTESIAN="2D_CARTESIAN",ANIM_BLEND_DIRECT="DIRECT",ANIM_STATE_START="START",ANIM_STATE_END="END",ANIM_STATE_ANY="ANY",ANIM_CONTROL_STATES=["START","END","ANY"],AnimState=function(){function AnimState(controller,name,speed,loop,blendTree){this._controller=controller,this._name=name,this._animations={},this._animationList=[],this._speed=speed||1,this._loop=void 0===loop||loop;var findParameter=this._controller.findParameter.bind(this._controller);this._blendTree=blendTree?this._createTree(blendTree.type,this,null,name,1,blendTree.parameter?[blendTree.parameter]:blendTree.parameters,blendTree.children,blendTree.syncAnimations,this._createTree,findParameter):new AnimNode(this,null,name,1,speed)}var _proto=AnimState.prototype;return _proto._createTree=function _createTree(type,state,parent,name,point,parameters,children,syncAnimations,createTree,findParameter){switch(type){case"1D":return new AnimBlendTree1D(state,parent,name,point,parameters,children,syncAnimations,createTree,findParameter);case"2D_CARTESIAN":return new AnimBlendTreeCartesian2D(state,parent,name,point,parameters,children,syncAnimations,createTree,findParameter);case"2D_DIRECTIONAL":return new AnimBlendTreeDirectional2D(state,parent,name,point,parameters,children,syncAnimations,createTree,findParameter);case"DIRECT":return new AnimBlendTreeDirect(state,parent,name,point,parameters,children,syncAnimations,createTree,findParameter)}},_proto._getNodeFromPath=function _getNodeFromPath(path){for(var currNode=this._blendTree,i=1;i<path.length;i++)currNode=currNode.getChild(path[i]);return currNode},_proto.addAnimation=function addAnimation(path,animTrack){var pathString=path.join("."),indexOfAnimation=this._animationList.findIndex((function(animation){return animation.path===pathString}));if(indexOfAnimation>=0)this._animationList[indexOfAnimation].animTrack=animTrack;else{var node=this._getNodeFromPath(path);node.animTrack=animTrack,this._animationList.push(node)}},_createClass(AnimState,[{key:"name",get:function get(){return this._name}},{key:"animations",get:function get(){return this._animationList},set:function set(value){this._animationList=value}},{key:"speed",get:function get(){return this._speed}},{key:"loop",get:function get(){return this._loop}},{key:"nodeCount",get:function get(){return this._blendTree&&this._blendTree.constructor!==AnimNode?this._blendTree.getNodeCount():1}},{key:"playable",get:function get(){return-1!==ANIM_CONTROL_STATES.indexOf(this.name)||this.animations.length===this.nodeCount}},{key:"looping",get:function get(){if(this.animations.length>0){var trackClipName=this.name+"."+this.animations[0].animTrack.name,trackClip=this._controller.animEvaluator.findClip(trackClipName);if(trackClip)return trackClip.loop}return!1}},{key:"totalWeight",get:function get(){var sum=0,i;for(i=0;i<this.animations.length;i++)sum+=this.animations[i].weight;return sum}},{key:"timelineDuration",get:function get(){var duration=0,i;for(i=0;i<this.animations.length;i++){var animation=this.animations[i];animation.animTrack.duration>duration&&(duration=animation.animTrack.duration)}return duration}}]),AnimState}(),AnimTransition=function(){function AnimTransition(controller,from,to,time,priority,conditions,exitTime,transitionOffset,interruptionSource){void 0===interruptionSource&&(interruptionSource="NONE"),this._controller=controller,this._from=from,this._to=to,this._time=time,this._priority=priority,this._conditions=conditions||[],this._exitTime=exitTime||null,this._transitionOffset=transitionOffset||null,this._interruptionSource=interruptionSource}return _createClass(AnimTransition,[{key:"from",get:function get(){return this._from}},{key:"to",get:function get(){return this._to},set:function set(value){this._to=value}},{key:"time",get:function get(){return this._time}},{key:"priority",get:function get(){return this._priority}},{key:"conditions",get:function get(){return this._conditions}},{key:"exitTime",get:function get(){return this._exitTime}},{key:"transitionOffset",get:function get(){return this._transitionOffset}},{key:"interruptionSource",get:function get(){return this._interruptionSource}},{key:"hasExitTime",get:function get(){return!!this.exitTime}},{key:"hasConditionsMet",get:function get(){var conditionsMet=!0,i;for(i=0;i<this.conditions.length;i++){var condition=this.conditions[i],parameter=this._controller.findParameter(condition.parameterName);switch(condition.predicate){case"GREATER_THAN":conditionsMet=conditionsMet&&parameter.value>condition.value;break;case"LESS_THAN":conditionsMet=conditionsMet&&parameter.value<condition.value;break;case"GREATER_THAN_EQUAL_TO":conditionsMet=conditionsMet&&parameter.value>=condition.value;break;case"LESS_THAN_EQUAL_TO":conditionsMet=conditionsMet&&parameter.value<=condition.value;break;case"EQUAL_TO":conditionsMet=conditionsMet&&parameter.value===condition.value;break;case"NOT_EQUAL_TO":conditionsMet=conditionsMet&&parameter.value!==condition.value}if(!conditionsMet)return conditionsMet}return conditionsMet}}]),AnimTransition}(),AnimController=function(){function AnimController(animEvaluator,states,transitions,parameters,activate,eventHandler){var i;for(this._animEvaluator=animEvaluator,this._states={},this._stateNames=[],this._eventHandler=eventHandler,i=0;i<states.length;i++)this._states[states[i].name]=new AnimState(this,states[i].name,states[i].speed,states[i].loop,states[i].blendTree),this._stateNames.push(states[i].name);this._transitions=transitions.map(function(transition){return new AnimTransition(this,transition.from,transition.to,transition.time,transition.priority,transition.conditions,transition.exitTime,transition.transitionOffset,transition.interruptionSource)}.bind(this)),this._findTransitionsFromStateCache={},this._findTransitionsBetweenStatesCache={},this._parameters=parameters,this._previousStateName=null,this._activeStateName="START",this._playing=!1,this._activate=activate,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._transitionInterruptionSource="NONE",this._transitionPreviousStates=[],this._timeInState=0,this._timeInStateBefore=0}var _proto=AnimController.prototype;return _proto._findState=function _findState(stateName){return this._states[stateName]},_proto._getActiveStateProgressForTime=function _getActiveStateProgressForTime(time){if("START"===this.activeStateName||"END"===this.activeStateName||"ANY"===this.activeStateName)return 1;var activeClip=this._animEvaluator.findClip(this.activeStateAnimations[0].name);return activeClip?time/activeClip.track.duration:null},_proto._findTransitionsFromState=function _findTransitionsFromState(stateName){var transitions=this._findTransitionsFromStateCache[stateName];return transitions||((transitions=this._transitions.filter((function(transition){return transition.from===stateName}))).sort((function(a,b){return a.priority<b.priority})),this._findTransitionsFromStateCache[stateName]=transitions),transitions},_proto._findTransitionsBetweenStates=function _findTransitionsBetweenStates(sourceStateName,destinationStateName){var transitions=this._findTransitionsBetweenStatesCache[sourceStateName+"->"+destinationStateName];return transitions||((transitions=this._transitions.filter((function(transition){return transition.from===sourceStateName&&transition.to===destinationStateName}))).sort((function(a,b){return a.priority<b.priority})),this._findTransitionsBetweenStatesCache[sourceStateName+"->"+destinationStateName]=transitions),transitions},_proto._findTransition=function _findTransition(from,to){var transitions=[];if(from&&to)transitions.concat(this._findTransitionsBetweenStates(from,to));else if(this._isTransitioning)switch(this._transitionInterruptionSource){case"PREV_STATE":transitions=(transitions=transitions.concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState("ANY"));break;case"NEXT_STATE":transitions=(transitions=transitions.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState("ANY"));break;case"PREV_STATE_NEXT_STATE":transitions=(transitions=(transitions=transitions.concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState("ANY"));break;case"NEXT_STATE_PREV_STATE":transitions=(transitions=(transitions=transitions.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState("ANY"))}else transitions=(transitions=transitions.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState("ANY"));if((transitions=transitions.filter(function(transition){if(transition.to===this.activeStateName)return!1;if(transition.hasExitTime){var progressBefore=this._getActiveStateProgressForTime(this._timeInStateBefore),progress=this._getActiveStateProgressForTime(this._timeInState);if(transition.exitTime<1&&this.activeState.loop&&(progressBefore-=Math.floor(progressBefore),progress-=Math.floor(progress)),!(transition.exitTime>progressBefore&&transition.exitTime<=progress))return null}return transition.hasConditionsMet}.bind(this))).length>0){var transition=transitions[0];if("END"===transition.to){var startTransition=this._findTransitionsFromState("START")[0];transition.to=startTransition.to}return transition}return null},_proto._updateStateFromTransition=function _updateStateFromTransition(transition){var i,j,state,animation,clip;for(this.previousState=transition.from,this.activeState=transition.to,i=0;i<transition.conditions.length;i++){var condition=transition.conditions[i],parameter=this.findParameter(condition.parameterName);"TRIGGER"===parameter.type&&(parameter.value=!1)}if(this.previousState){this._isTransitioning||(this._transitionPreviousStates=[]),this._transitionPreviousStates.push({name:this._previousStateName,weight:1});var interpolatedTime=Math.min(this._currTransitionTime/this._totalTransitionTime,1);for(i=0;i<this._transitionPreviousStates.length;i++)for(this._isTransitioning?i!==this._transitionPreviousStates.length-1?this._transitionPreviousStates[i].weight*=1-interpolatedTime:this._transitionPreviousStates[i].weight=interpolatedTime:this._transitionPreviousStates[i].weight=1,state=this._findState(this._transitionPreviousStates[i].name),j=0;j<state.animations.length;j++)animation=state.animations[j],(clip=this._animEvaluator.findClip(animation.name+".previous."+i))||((clip=this._animEvaluator.findClip(animation.name)).name=animation.name+".previous."+i),i!==this._transitionPreviousStates.length-1&&clip.pause()}this._isTransitioning=!0,this._totalTransitionTime=transition.time,this._currTransitionTime=0,this._transitionInterruptionSource=transition.interruptionSource;var activeState=this.activeState,hasTransitionOffset=transition.transitionOffset&&transition.transitionOffset>0&&transition.transitionOffset<1,timeInState=0,timeInStateBefore=0;if(hasTransitionOffset){var offsetTime=activeState.timelineDuration*transition.transitionOffset;timeInState=offsetTime,timeInStateBefore=offsetTime}for(this._timeInState=timeInState,this._timeInStateBefore=timeInStateBefore,i=0;i<activeState.animations.length;i++){if(clip=this._animEvaluator.findClip(activeState.animations[i].name))clip.reset();else{var speed=Number.isFinite(activeState.animations[i].speed)?activeState.animations[i].speed:activeState.speed;(clip=new AnimClip(activeState.animations[i].animTrack,this._timeInState,speed,!0,activeState.loop,this._eventHandler)).name=activeState.animations[i].name,this._animEvaluator.addClip(clip)}if(transition.time>0?clip.blendWeight=0:clip.blendWeight=activeState.animations[i].normalizedWeight,clip.play(),hasTransitionOffset)clip.time=activeState.timelineDuration*transition.transitionOffset;else{var startTime=activeState.speed>=0?0:this.activeStateDuration;clip.time=startTime}}},_proto._transitionToState=function _transitionToState(newStateName){if(this._findState(newStateName)){var transition=this._findTransition(this._activeStateName,newStateName);transition||(this._animEvaluator.removeClips(),transition=new AnimTransition(this,null,newStateName,0,0)),this._updateStateFromTransition(transition)}},_proto.assignAnimation=function assignAnimation(pathString,animTrack){var path=pathString.split("."),state=this._findState(path[0]);state&&(state.addAnimation(path,animTrack),!this._playing&&this._activate&&this.playable&&this.play())},_proto.removeNodeAnimations=function removeNodeAnimations(nodeName){if(-1===ANIM_CONTROL_STATES.indexOf(nodeName)){var state=this._findState(nodeName);if(state)return state.animations=[],!0}},_proto.play=function play(stateName){stateName&&this._transitionToState(stateName),this._playing=!0},_proto.pause=function pause(){this._playing=!1},_proto.reset=function reset(){this._previousStateName=null,this._activeStateName="START",this._playing=!1,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._timeInState=0,this._timeInStateBefore=0,this._animEvaluator.removeClips()},_proto.rebind=function rebind(){this._animEvaluator.rebind()},_proto.update=function update(dt){if(this._playing){var i,j,state,animation,clip;this._timeInStateBefore=this._timeInState,this._timeInState+=dt;var transition=this._findTransition(this._activeStateName);if(transition&&this._updateStateFromTransition(transition),this._isTransitioning)if(this._currTransitionTime+=dt,this._currTransitionTime<=this._totalTransitionTime){var interpolatedTime=this._currTransitionTime/this._totalTransitionTime;for(i=0;i<this._transitionPreviousStates.length;i++){state=this._findState(this._transitionPreviousStates[i].name);var stateWeight=this._transitionPreviousStates[i].weight;for(j=0;j<state.animations.length;j++)animation=state.animations[j],(clip=this._animEvaluator.findClip(animation.name+".previous."+i))&&(clip.blendWeight=(1-interpolatedTime)*animation.normalizedWeight*stateWeight)}for(state=this.activeState,i=0;i<state.animations.length;i++)animation=state.animations[i],this._animEvaluator.findClip(animation.name).blendWeight=interpolatedTime*animation.normalizedWeight}else{this._isTransitioning=!1;var activeClips=this.activeStateAnimations.length,totalClips=this._animEvaluator.clips.length;for(i=0;i<totalClips-activeClips;i++)this._animEvaluator.removeClip(0);for(this._transitionPreviousStates=[],state=this.activeState,i=0;i<state.animations.length;i++)animation=state.animations[i],(clip=this._animEvaluator.findClip(animation.name))&&(clip.blendWeight=animation.normalizedWeight)}else if(this.activeState._blendTree.constructor!==AnimNode)for(state=this.activeState,i=0;i<state.animations.length;i++)animation=state.animations[i],(clip=this._animEvaluator.findClip(animation.name))&&(clip.blendWeight=animation.normalizedWeight,animation.parent.syncAnimations&&(clip.speed=animation.speed));this._animEvaluator.update(dt)}},_proto.findParameter=function findParameter(name){return this._parameters[name]},_createClass(AnimController,[{key:"animEvaluator",get:function get(){return this._animEvaluator}},{key:"activeState",get:function get(){return this._findState(this._activeStateName)},set:function set(stateName){this._activeStateName=stateName}},{key:"activeStateName",get:function get(){return this._activeStateName}},{key:"activeStateAnimations",get:function get(){return this.activeState.animations}},{key:"previousState",get:function get(){return this._findState(this._previousStateName)},set:function set(stateName){this._previousStateName=stateName}},{key:"previousStateName",get:function get(){return this._previousStateName}},{key:"playable",get:function get(){var playable=!0,i;for(i=0;i<this._stateNames.length;i++)this._states[this._stateNames[i]].playable||(playable=!1);return playable}},{key:"playing",get:function get(){return this._playing},set:function set(value){this._playing=value}},{key:"activeStateProgress",get:function get(){return this._getActiveStateProgressForTime(this._timeInState)}},{key:"activeStateDuration",get:function get(){if("START"===this.activeStateName||"END"===this.activeStateName)return 0;for(var maxDuration=0,i=0;i<this.activeStateAnimations.length;i++){var activeClip=this._animEvaluator.findClip(this.activeStateAnimations[i].name);activeClip&&(maxDuration=Math.max(maxDuration,activeClip.track.duration))}return maxDuration}},{key:"activeStateCurrentTime",get:function get(){return this._timeInState},set:function set(time){this._timeInStateBefore=time,this._timeInState=time;for(var i=0;i<this.activeStateAnimations.length;i++){var clip=this.animEvaluator.findClip(this.activeStateAnimations[i].name);clip&&(clip.time=time)}}},{key:"transitioning",get:function get(){return this._isTransitioning}},{key:"transitionProgress",get:function get(){return this._currTransitionTime/this._totalTransitionTime}},{key:"states",get:function get(){return this._stateNames}}]),AnimController}(),v2=new Vec2,v3=new Vec3,v4=new Vec4,c=new Color,q=new Quat,AnimComponentBinder=function(_DefaultAnimBinder){function AnimComponentBinder(animComponent,graph){var _this;return(_this=_DefaultAnimBinder.call(this,graph)||this).animComponent=animComponent,_this}_inheritsLoose(AnimComponentBinder,_DefaultAnimBinder),AnimComponentBinder._packFloat=function _packFloat(values){return values[0]},AnimComponentBinder._packBoolean=function _packBoolean(values){return!!values[0]},AnimComponentBinder._packVec2=function _packVec2(values){return v2.x=values[0],v2.y=values[1],v2},AnimComponentBinder._packVec3=function _packVec3(values){return v3.x=values[0],v3.y=values[1],v3.z=values[2],v3},AnimComponentBinder._packVec4=function _packVec4(values){return v4.x=values[0],v4.y=values[1],v4.z=values[2],v4.w=values[3],v4},AnimComponentBinder._packColor=function _packColor(values){return c.r=values[0],c.g=values[1],c.b=values[2],c.a=values[3],c},AnimComponentBinder._packQuat=function _packQuat(values){return q.x=values[0],q.y=values[1],q.z=values[2],q.w=values[3],q};var _proto=AnimComponentBinder.prototype;return _proto.resolve=function resolve(path){var encodedPath=AnimBinder.encode(path.entityPath,path.component,path.propertyPath),target=this.targetCache[encodedPath],entity,propertyComponent,targetPath;if(target)return target;switch(path.component){case"entity":entity=this._getEntityFromHierarchy(path.entityPath),targetPath=AnimBinder.encode(entity.path,"entity",path.propertyPath),propertyComponent=entity;break;case"graph":if(!(propertyComponent=this.findNode(path)))return null;targetPath=AnimBinder.encode(propertyComponent.path,"graph",path.propertyPath);break;default:if(!(propertyComponent=(entity=this._getEntityFromHierarchy(path.entityPath)).findComponent(path.component)))return null;targetPath=AnimBinder.encode(entity.path,path.component,path.propertyPath)}return target=this._createAnimTargetForProperty(propertyComponent,path.propertyPath,targetPath),this.targetCache[encodedPath]=target,target},_proto.update=function update(deltaTime){var activeNodes=this.activeNodes;if(activeNodes)for(var i=0;i<activeNodes.length;i++)activeNodes[i]._dirtifyLocal()},_proto._getEntityFromHierarchy=function _getEntityFromHierarchy(entityHierarchy){if(!this.animComponent.entity.name===entityHierarchy[0])return null;var currEntity=this.animComponent.entity;return 1===entityHierarchy.length?currEntity:currEntity._parent.findByPath(entityHierarchy)},_proto._resolvePath=function _resolvePath(object,path,resolveLeaf){for(var steps=path.length-(resolveLeaf?0:1),i=0;i<steps;i++)object=object[path[i]];return object},_proto._setter=function _setter(object,path,packFunc){var obj=this._resolvePath(object,path),key=path[path.length-1],setterFunc="set"+key.substring(0,1).toUpperCase()+key.substring(1);if(obj[setterFunc]){var func=obj[setterFunc].bind(obj);return function(values){func(packFunc(values))}}var prop=obj[key];if("object"==typeof prop&&prop.hasOwnProperty("copy"))return function(values){prop.copy(packFunc(values))};if(-1!==[Vec2,Vec3,Vec4,Color,Quat].indexOf(obj.constructor)&&path.length>1){var parent=path.length>2?this._resolvePath(object,path.slice(0,-1)):object,objKey=path[path.length-2];return function(values){obj[key]=packFunc(values),parent[objKey]=obj}}return function(values){obj[key]=packFunc(values)}},_proto._createAnimTargetForProperty=function _createAnimTargetForProperty(propertyComponent,propertyHierarchy,targetPath){if(this.handlers&&"weights"===propertyHierarchy[0])return this.handlers.weights(propertyComponent);if(this.handlers&&"material"===propertyHierarchy[0]&&2===propertyHierarchy.length){var materialPropertyName=propertyHierarchy[1];if(materialPropertyName.indexOf("Map")===materialPropertyName.length-3)return this.handlers.materialTexture(propertyComponent,materialPropertyName)}var property=this._resolvePath(propertyComponent,propertyHierarchy,!0),setter,animDataType,animDataComponents;if(void 0===property)return null;if("number"==typeof property)setter=this._setter(propertyComponent,propertyHierarchy,AnimComponentBinder._packFloat),animDataType="vector",animDataComponents=1;else if("boolean"==typeof property)setter=this._setter(propertyComponent,propertyHierarchy,AnimComponentBinder._packBoolean),animDataType="vector",animDataComponents=1;else if("object"==typeof property)switch(property.constructor){case Vec2:setter=this._setter(propertyComponent,propertyHierarchy,AnimComponentBinder._packVec2),animDataType="vector",animDataComponents=2;break;case Vec3:setter=this._setter(propertyComponent,propertyHierarchy,AnimComponentBinder._packVec3),animDataType="vector",animDataComponents=3;break;case Vec4:setter=this._setter(propertyComponent,propertyHierarchy,AnimComponentBinder._packVec4),animDataType="vector",animDataComponents=4;break;case Color:setter=this._setter(propertyComponent,propertyHierarchy,AnimComponentBinder._packColor),animDataType="vector",animDataComponents=4;break;case Quat:setter=this._setter(propertyComponent,propertyHierarchy,AnimComponentBinder._packQuat),animDataType="quaternion",animDataComponents=4;break;default:return null}return-1!==propertyHierarchy.indexOf("material")?new AnimTarget((function(values){setter(values),propertyComponent.material.update()}),animDataType,animDataComponents,targetPath):new AnimTarget(setter,animDataType,animDataComponents,targetPath)},_proto.rebind=function rebind(){this.targetCache={},this.animComponent.rootBone?this.graph=this.animComponent.rootBone:this.graph=this.animComponent.entity;var nodes={},flatten;(function flatten(node){nodes[node.name]=node;for(var i=0;i<node.children.length;++i)flatten(node.children[i])})(this.graph),this.nodes=nodes},AnimComponentBinder}(DefaultAnimBinder),AnimComponentLayer=function(){function AnimComponentLayer(name,controller,component){this._name=name,this._controller=controller,this._component=component}var _proto=AnimComponentLayer.prototype;return _proto.play=function play(name){this._controller.play(name)},_proto.pause=function pause(){this._controller.pause()},_proto.reset=function reset(){this._controller.reset()},_proto.rebind=function rebind(){this._controller.rebind()},_proto.update=function update(dt){this._controller.update(dt)},_proto.assignAnimation=function assignAnimation(nodeName,animTrack){animTrack.constructor===AnimTrack&&(this._controller.assignAnimation(nodeName,animTrack),this._component.activate&&this._component.playable&&(this._component.playing=!0))},_proto.removeNodeAnimations=function removeNodeAnimations(nodeName){this._controller.removeNodeAnimations(nodeName)&&(this._component.playing=!1)},_createClass(AnimComponentLayer,[{key:"name",get:function get(){return this._name}},{key:"playing",get:function get(){return this._controller.playing},set:function set(value){this._controller.playing=value}},{key:"playable",get:function get(){return this._controller.playable}},{key:"activeState",get:function get(){return this._controller.activeStateName}},{key:"previousState",get:function get(){return this._controller.previousStateName}},{key:"activeStateProgress",get:function get(){return this._controller.activeStateProgress}},{key:"activeStateDuration",get:function get(){return this._controller.activeStateDuration}},{key:"activeStateCurrentTime",get:function get(){return this._controller.activeStateCurrentTime},set:function set(time){this._controller.activeStateCurrentTime=time}},{key:"transitioning",get:function get(){return this._controller.transitioning}},{key:"transitionProgress",get:function get(){return this.transitioning?this._controller.transitionProgress:null}},{key:"states",get:function get(){return this._controller.states}}]),AnimComponentLayer}(),AnimComponent=function(_Component){function AnimComponent(){return _Component.apply(this,arguments)||this}_inheritsLoose(AnimComponent,_Component);var _proto=AnimComponent.prototype;return _proto.loadStateGraph=function loadStateGraph(stateGraph){var i,data=this.data;data.stateGraph=stateGraph,data.parameters={};var paramKeys=Object.keys(stateGraph.parameters),graph;for(i=0;i<paramKeys.length;i++){var paramKey=paramKeys[i];data.parameters[paramKey]={type:stateGraph.parameters[paramKey].type,value:stateGraph.parameters[paramKey].value}}function addLayer(name,states,transitions,order){var animBinder=new AnimComponentBinder(this,graph),animEvaluator=new AnimEvaluator(animBinder),controller=new AnimController(animEvaluator,states,transitions,data.parameters,data.activate,this);data.layers.push(new AnimComponentLayer(name,controller,this)),data.layerIndices[name]=order}for(data.layers=[],graph=this.rootBone?this.rootBone:this.entity,i=0;i<stateGraph.layers.length;i++){var layer=stateGraph.layers[i];addLayer.bind(this)(layer.name,layer.states,layer.transitions,i)}this.setupAnimationAssets()},_proto.setupAnimationAssets=function setupAnimationAssets(){for(var i=0;i<this.data.layers.length;i++)for(var layer=this.data.layers[i],layerName=layer.name,j=0;j<layer.states.length;j++){var stateName=layer.states[j];if(-1===ANIM_CONTROL_STATES.indexOf(stateName)){var stateKey=layerName+":"+stateName;this.data.animationAssets[stateKey]||(this.data.animationAssets[stateKey]={asset:null})}}this.loadAnimationAssets()},_proto.loadAnimationAssets=function loadAnimationAssets(){for(var i=0;i<this.data.layers.length;i++)for(var layer=this.data.layers[i],j=0;j<layer.states.length;j++){var stateName=layer.states[j];if(-1===ANIM_CONTROL_STATES.indexOf(stateName)){var animationAsset=this.data.animationAssets[layer.name+":"+stateName];if(animationAsset&&animationAsset.asset){var assetId=animationAsset.asset,asset=this.system.app.assets.get(assetId);if(asset)if(asset.resource){var animTrack=asset.resource;asset.data.events&&(animTrack.events=new AnimEvents(Object.values(asset.data.events))),this.assignAnimation(stateName,animTrack,layer.name)}else asset.once("load",function(layerName,stateName){return function(asset){this.assignAnimation(stateName,asset.resource,layerName)}.bind(this)}.bind(this)(layer.name,stateName)),this.system.app.assets.load(asset)}else this.removeNodeAnimations(stateName,layer.name)}}},_proto.removeStateGraph=function removeStateGraph(){this.data.stateGraph=null,this.data.stateGraphAsset=null,this.data.animationAssets={},this.data.layers=[],this.data.layerIndices={},this.data.parameters={},this.data.playing=!1},_proto.resetStateGraph=function resetStateGraph(){if(this.stateGraphAsset){var stateGraph=this.system.app.assets.get(this.stateGraphAsset).resource;this.loadStateGraph(stateGraph)}else this.removeStateGraph()},_proto.reset=function reset(){this.data.parameters=Object.assign({},this.data.stateGraph.parameters);for(var i=0;i<this.data.layers.length;i++){var layerPlaying=this.data.layers[i].playing;this.data.layers[i].reset(),this.data.layers[i].playing=layerPlaying}},_proto.rebind=function rebind(){for(var i=0;i<this.data.layers.length;i++)this.data.layers[i].rebind()},_proto.findAnimationLayer=function findAnimationLayer(layerName){var layerIndex=this.data.layerIndices[layerName];return this.data.layers[layerIndex]||null},_proto.assignAnimation=function assignAnimation(nodeName,animTrack,layerName){if(this.data.stateGraph){var layer=layerName?this.findAnimationLayer(layerName):this.baseLayer;layer&&layer.assignAnimation(nodeName,animTrack)}},_proto.removeNodeAnimations=function removeNodeAnimations(nodeName,layerName){var layer=layerName?this.findAnimationLayer(layerName):this.baseLayer;layer&&layer.removeNodeAnimations(nodeName)},_proto.getParameterValue=function getParameterValue(name,type){var param=this.data.parameters[name];if(param&&param.type===type)return param.value},_proto.setParameterValue=function setParameterValue(name,type,value){var param=this.data.parameters[name];param&&param.type===type&&(param.value=value)},_proto.getFloat=function getFloat(name){return this.getParameterValue(name,"FLOAT")},_proto.setFloat=function setFloat(name,value){this.setParameterValue(name,"FLOAT",value)},_proto.getInteger=function getInteger(name){return this.getParameterValue(name,"INTEGER")},_proto.setInteger=function setInteger(name,value){"number"==typeof value&&value%1==0&&this.setParameterValue(name,"INTEGER",value)},_proto.getBoolean=function getBoolean(name){return this.getParameterValue(name,"BOOLEAN")},_proto.setBoolean=function setBoolean(name,value){this.setParameterValue(name,"BOOLEAN",!!value)},_proto.getTrigger=function getTrigger(name){return this.getParameterValue(name,"TRIGGER")},_proto.setTrigger=function setTrigger(name){this.setParameterValue(name,"TRIGGER",!0)},_proto.resetTrigger=function resetTrigger(name){this.setParameterValue(name,"TRIGGER",!1)},_createClass(AnimComponent,[{key:"rootBone",get:function get(){return this.data.rootBone},set:function set(value){if("string"==typeof value){var entity=this.entity.root.findByGuid(value);this.data.rootBone=entity}else"Entity"===(null==value?void 0:value.constructor.name)?this.data.rootBone=value:this.data.rootBone=null;this.rebind()}},{key:"stateGraphAsset",get:function get(){return this.data.stateGraphAsset},set:function set(value){var _id,_asset;null!==value?(value instanceof Asset?(_id=value.id,(_asset=this.system.app.assets.get(_id))||(this.system.app.assets.add(value),_asset=this.system.app.assets.get(_id))):(_id=value,_asset=this.system.app.assets.get(_id)),_asset&&this.data.stateGraphAsset!==_id&&(_asset.resource?(this.data.stateGraph=_asset.resource,this.loadStateGraph(this.data.stateGraph),_asset.on("change",function(asset){this.data.stateGraph=new AnimStateGraph(asset._data),this.loadStateGraph(this.data.stateGraph)}.bind(this))):(_asset.once("load",function(asset){this.data.stateGraph=asset.resource,this.loadStateGraph(this.data.stateGraph)}.bind(this)),_asset.on("change",function(asset){this.data.stateGraph=new AnimStateGraph(asset._data),this.loadStateGraph(this.data.stateGraph)}.bind(this)),this.system.app.assets.load(_asset)),this.data.stateGraphAsset=_id)):this.removeStateGraph()}},{key:"animationAssets",get:function get(){return this.data.animationAssets},set:function set(value){this.data.animationAssets=value,this.loadAnimationAssets()}},{key:"playable",get:function get(){for(var i=0;i<this.data.layers.length;i++)if(!this.data.layers[i].playable)return!1;return!0}},{key:"baseLayer",get:function get(){return this.data.layers.length>0?this.data.layers[0]:null}}]),AnimComponent}(Component),AnimComponentData=function AnimComponentData(){this.stateGraphAsset=null,this.animationAssets={},this.speed=1,this.activate=!0,this.enabled=!0,this.playing=!1,this.rootBone=null,this.stateGraph=null,this.layers=[],this.layerIndices={},this.parameters={}},_schema$k=["enabled","speed","activate","playing"],AnimComponentSystem=function(_ComponentSystem){function AnimComponentSystem(app){var _this;return(_this=_ComponentSystem.call(this,app)||this).id="anim",_this.ComponentType=AnimComponent,_this.DataType=AnimComponentData,_this.schema=_schema$k,_this.on("beforeremove",_this.onBeforeRemove,_assertThisInitialized(_this)),ComponentSystem.bind("animationUpdate",_this.onAnimationUpdate,_assertThisInitialized(_this)),_this}_inheritsLoose(AnimComponentSystem,_ComponentSystem);var _proto=AnimComponentSystem.prototype;return _proto.initializeComponentData=function initializeComponentData(component,data,properties){properties=["activate","enabled","speed","playing"],_ComponentSystem.prototype.initializeComponentData.call(this,component,data,properties),data.stateGraphAsset&&(component.stateGraphAsset=data.stateGraphAsset),data.animationAssets&&(component.animationAssets=Object.assign(component.data.animationAssets,data.animationAssets)),data.rootBone&&(component.rootBone=data.rootBone)},_proto.onAnimationUpdate=function onAnimationUpdate(dt){var components=this.store;for(var id in components)if(components.hasOwnProperty(id)){var component=components[id],componentData=component.data;if(componentData.enabled&&component.entity.enabled&&componentData.playing)for(var i=0;i<componentData.layers.length;i++)componentData.layers[i].update(dt*componentData.speed)}},AnimComponentSystem}(ComponentSystem);Component._buildAccessors(AnimComponent.prototype,_schema$k);var AudioListenerComponent=function(_Component){function AudioListenerComponent(){return _Component.apply(this,arguments)||this}_inheritsLoose(AudioListenerComponent,_Component);var _proto=AudioListenerComponent.prototype;return _proto.setCurrentListener=function setCurrentListener(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;var position=this.system.current.getPosition();this.system.manager.listener.setPosition(position)}},_proto.onEnable=function onEnable(){this.setCurrentListener()},_proto.onDisable=function onDisable(){this.system.current===this.entity&&(this.system.current=null)},AudioListenerComponent}(Component),AudioListenerComponentData=function AudioListenerComponentData(){this.enabled=!0},_schema$j=["enabled"],AudioListenerComponentSystem=function(_ComponentSystem){function AudioListenerComponentSystem(app,manager){var _this;return(_this=_ComponentSystem.call(this,app)||this).id="audiolistener",_this.ComponentType=AudioListenerComponent,_this.DataType=AudioListenerComponentData,_this.schema=_schema$j,_this.manager=manager,_this.current=null,ComponentSystem.bind("update",_this.onUpdate,_assertThisInitialized(_this)),_this}_inheritsLoose(AudioListenerComponentSystem,_ComponentSystem);var _proto=AudioListenerComponentSystem.prototype;return _proto.initializeComponentData=function initializeComponentData(component,data,properties){properties=["enabled"],_ComponentSystem.prototype.initializeComponentData.call(this,component,data,properties)},_proto.onUpdate=function onUpdate(dt){if(this.current){var position=this.current.getPosition();this.manager.listener.setPosition(position);var wtm=this.current.getWorldTransform();this.manager.listener.setOrientation(wtm)}},AudioListenerComponentSystem}(ComponentSystem);Component._buildAccessors(AudioListenerComponent.prototype,_schema$j);var AudioSourceComponent=function(_Component){function AudioSourceComponent(system,entity){var _this;return(_this=_Component.call(this,system,entity)||this).on("set_assets",_this.onSetAssets,_assertThisInitialized(_this)),_this.on("set_loop",_this.onSetLoop,_assertThisInitialized(_this)),_this.on("set_volume",_this.onSetVolume,_assertThisInitialized(_this)),_this.on("set_pitch",_this.onSetPitch,_assertThisInitialized(_this)),_this.on("set_minDistance",_this.onSetMinDistance,_assertThisInitialized(_this)),_this.on("set_maxDistance",_this.onSetMaxDistance,_assertThisInitialized(_this)),_this.on("set_rollOffFactor",_this.onSetRollOffFactor,_assertThisInitialized(_this)),_this.on("set_distanceModel",_this.onSetDistanceModel,_assertThisInitialized(_this)),_this.on("set_3d",_this.onSet3d,_assertThisInitialized(_this)),_this}_inheritsLoose(AudioSourceComponent,_Component);var _proto=AudioSourceComponent.prototype;return _proto.play=function play(name){if(this.enabled&&this.entity.enabled){var channel;this.channel&&this.stop();var componentData=this.data;if(componentData.sources[name])if(componentData["3d"]){var pos=this.entity.getPosition();channel=this.system.manager.playSound3d(componentData.sources[name],pos,componentData),componentData.currentSource=name,componentData.channel=channel}else channel=this.system.manager.playSound(componentData.sources[name],componentData),componentData.currentSource=name,componentData.channel=channel}},_proto.pause=function pause(){this.channel&&this.channel.pause()},_proto.unpause=function unpause(){this.channel&&this.channel.paused&&this.channel.unpause()},_proto.stop=function stop(){this.channel&&(this.channel.stop(),this.channel=null)},_proto.onSetAssets=function onSetAssets(name,oldValue,newValue){var newAssets=[],i,len=newValue.length;if(oldValue&&oldValue.length)for(i=0;i<oldValue.length;i++)if(oldValue[i]){var asset=this.system.app.assets.get(oldValue[i]);asset&&(asset.off("change",this.onAssetChanged,this),asset.off("remove",this.onAssetRemoved,this),this.currentSource===asset.name&&this.stop())}if(len)for(i=0;i<len;i++)oldValue.indexOf(newValue[i])<0&&(newValue[i]instanceof Asset?newAssets.push(newValue[i].id):newAssets.push(newValue[i]));!this.system._inTools&&newAssets.length&&this.loadAudioSourceAssets(newAssets)},_proto.onAssetChanged=function onAssetChanged(asset,attribute,newValue,oldValue){var sources;"resource"===attribute&&(this.data.sources&&(this.data.sources[asset.name]=newValue,this.data.currentSource===asset.name&&this.channel&&(this.channel.paused?(this.play(asset.name),this.pause()):this.play(asset.name))))},_proto.onAssetRemoved=function onAssetRemoved(asset){asset.off("remove",this.onAssetRemoved,this),this.data.sources[asset.name]&&(delete this.data.sources[asset.name],this.data.currentSource===asset.name&&(this.stop(),this.data.currentSource=null))},_proto.onSetLoop=function onSetLoop(name,oldValue,newValue){oldValue!==newValue&&this.channel&&this.channel.setLoop(newValue)},_proto.onSetVolume=function onSetVolume(name,oldValue,newValue){oldValue!==newValue&&this.channel&&this.channel.setVolume(newValue)},_proto.onSetPitch=function onSetPitch(name,oldValue,newValue){oldValue!==newValue&&this.channel&&this.channel.setPitch(newValue)},_proto.onSetMaxDistance=function onSetMaxDistance(name,oldValue,newValue){oldValue!==newValue&&this.channel instanceof Channel3d&&this.channel.setMaxDistance(newValue)},_proto.onSetMinDistance=function onSetMinDistance(name,oldValue,newValue){oldValue!==newValue&&this.channel instanceof Channel3d&&this.channel.setMinDistance(newValue)},_proto.onSetRollOffFactor=function onSetRollOffFactor(name,oldValue,newValue){oldValue!==newValue&&this.channel instanceof Channel3d&&this.channel.setRollOffFactor(newValue)},_proto.onSetDistanceModel=function onSetDistanceModel(name,oldValue,newValue){oldValue!==newValue&&this.channel instanceof Channel3d&&this.channel.setDistanceModel(newValue)},_proto.onSet3d=function onSet3d(name,oldValue,newValue){if(oldValue!==newValue&&this.system.initialized&&this.currentSource){var paused=!1,suspended=!1;this.channel&&(paused=this.channel.paused,suspended=this.channel.suspended),this.play(this.currentSource),this.channel&&(this.channel.paused=paused,this.channel.suspended=suspended)}},_proto.onEnable=function onEnable(){var assets=this.data.assets;if(assets)for(var registry=this.system.app.assets,i=0,len=assets.length;i<len;i++){var asset=assets[i];asset instanceof Asset||(asset=registry.get(asset)),asset&&!asset.resource&&registry.load(asset)}this.system.initialized&&(this.data.activate&&!this.channel?this.play(this.currentSource):this.unpause())},_proto.onDisable=function onDisable(){this.pause()},_proto.loadAudioSourceAssets=function loadAudioSourceAssets(ids){var self=this,assets=ids.map((function(id){return this.system.app.assets.get(id)}),this),sources={},currentSource=null,count=assets.length,_error=function _error(e){count--},_done=function(){this.data.sources=sources,this.data.currentSource=currentSource,this.enabled&&this.activate&&currentSource&&this.onEnable()}.bind(this);assets.forEach((function(asset,index){asset?(currentSource=currentSource||asset.name,asset.off("change",this.onAssetChanged,this),asset.on("change",this.onAssetChanged,this),asset.off("remove",this.onAssetRemoved,this),asset.on("remove",this.onAssetRemoved,this),asset.off("error",_error,this),asset.on("error",_error,this),asset.ready((function(asset){sources[asset.name]=asset.resource,0===--count&&_done()})),!asset.resource&&self.enabled&&self.entity.enabled&&this.system.app.assets.load(asset)):(0===--count&&_done(),this.system.app.assets.on("add:"+ids[index],(function(asset){asset.ready((function(asset){self.data.sources[asset.name]=asset.resource})),asset.resource||self.system.app.assets.load(asset)})))}),this)},AudioSourceComponent}(Component),AudioSourceComponentData=function AudioSourceComponentData(){this.enabled=!0,this.assets=[],this.activate=!0,this.volume=1,this.pitch=1,this.loop=!1,this["3d"]=!0,this.minDistance=1,this.maxDistance=1e4,this.rollOffFactor=1,this.distanceModel="inverse",this.paused=!0,this.sources={},this.currentSource=null,this.channel=null},_schema$i=["enabled","assets","volume","pitch","loop","activate","3d","minDistance","maxDistance","rollOffFactor","distanceModel","sources","currentSource","channel"],AudioSourceComponentSystem=function(_ComponentSystem){function AudioSourceComponentSystem(app,manager){var _this;return(_this=_ComponentSystem.call(this,app)||this).id="audiosource",_this.ComponentType=AudioSourceComponent,_this.DataType=AudioSourceComponentData,_this.schema=_schema$i,_this.manager=manager,_this.initialized=!1,ComponentSystem.bind("initialize",_this.onInitialize,_assertThisInitialized(_this)),ComponentSystem.bind("update",_this.onUpdate,_assertThisInitialized(_this)),_this.on("remove",_this.onRemove,_assertThisInitialized(_this)),_this}_inheritsLoose(AudioSourceComponentSystem,_ComponentSystem);var _proto=AudioSourceComponentSystem.prototype;return _proto.initializeComponentData=function initializeComponentData(component,data,properties){properties=["activate","volume","pitch","loop","3d","minDistance","maxDistance","rollOffFactor","distanceModel","enabled","assets"],_ComponentSystem.prototype.initializeComponentData.call(this,component,data,properties),component.paused=!(component.enabled&&component.activate)},_proto.onInitialize=function onInitialize(root){root.audiosource&&root.enabled&&root.audiosource.enabled&&root.audiosource.activate&&root.audiosource.play(root.audiosource.currentSource);var children=root._children,i,len=children.length;for(i=0;i<len;i++)children[i]instanceof Entity&&this.onInitialize(children[i]);this.initialized=!0},_proto.onUpdate=function onUpdate(dt){var components=this.store;for(var id in components)if(components.hasOwnProperty(id)){var component=components[id],entity=component.entity,componentData=component.data;if(componentData.enabled&&entity.enabled&&componentData.channel instanceof Channel3d){var pos=entity.getPosition();componentData.channel.setPosition(pos)}}},_proto.onRemove=function onRemove(entity,data){data.channel&&(data.channel.stop(),data.channel=null)},_proto.setVolume=function setVolume(volume){this.manager.setVolume(volume)},AudioSourceComponentSystem}(ComponentSystem);Component._buildAccessors(AudioSourceComponent.prototype,_schema$i);var EntityReference=function(_EventHandler){function EntityReference(parentComponent,entityPropertyName,eventConfig){var _this;if(_this=_EventHandler.call(this)||this,!(parentComponent&&parentComponent instanceof Component))throw new Error("The parentComponent argument is required and must be a Component");if(!entityPropertyName||"string"!=typeof entityPropertyName)throw new Error("The propertyName argument is required and must be a string");if(eventConfig&&"object"!=typeof eventConfig)throw new Error("If provided, the eventConfig argument must be an object");return _this._parentComponent=parentComponent,_this._entityPropertyName=entityPropertyName,_this._entity=null,_this._app=parentComponent.system.app,_this._configureEventListeners(eventConfig||{},{"entity#destroy":_this._onEntityDestroy}),_this._toggleLifecycleListeners("on"),_this}_inheritsLoose(EntityReference,_EventHandler);var _proto=EntityReference.prototype;return _proto._configureEventListeners=function _configureEventListeners(externalEventConfig,internalEventConfig){var externalEventListenerConfigs=this._parseEventListenerConfig(externalEventConfig,"external",this._parentComponent),internalEventListenerConfigs=this._parseEventListenerConfig(internalEventConfig,"internal",this);this._eventListenerConfigs=externalEventListenerConfigs.concat(internalEventListenerConfigs),this._listenerStatusFlags={},this._gainListeners={},this._loseListeners={}},_proto._parseEventListenerConfig=function _parseEventListenerConfig(eventConfig,prefix,scope){return Object.keys(eventConfig).map((function(listenerDescription,index){var listenerDescriptionParts=listenerDescription.split("#"),sourceName=listenerDescriptionParts[0],eventName=listenerDescriptionParts[1],callback=eventConfig[listenerDescription];if(2!==listenerDescriptionParts.length||"string"!=typeof sourceName||0===sourceName.length||"string"!=typeof eventName||0===eventName.length)throw new Error("Invalid event listener description: `"+listenerDescription+"`");if("function"!=typeof callback)throw new Error("Invalid or missing callback for event listener `"+listenerDescription+"`");return{id:prefix+"_"+index+"_"+listenerDescription,sourceName:sourceName,eventName:eventName,callback:callback,scope:scope}}),this)},_proto._toggleLifecycleListeners=function _toggleLifecycleListeners(onOrOff){this._parentComponent[onOrOff]("set_"+this._entityPropertyName,this._onSetEntity,this),this._parentComponent.system[onOrOff]("beforeremove",this._onParentComponentRemove,this),ComponentSystem[onOrOff]("postinitialize",this._onPostInitialize,this),this._app[onOrOff]("tools:sceneloaded",this._onSceneLoaded,this);for(var allComponentSystems=[],i=0;i<this._eventListenerConfigs.length;++i){var config=this._eventListenerConfigs[i],componentSystem=this._app.systems[config.sourceName];componentSystem&&(-1===allComponentSystems.indexOf(componentSystem)&&allComponentSystems.push(componentSystem),componentSystem&&"gain"===config.eventName&&(this._gainListeners[config.sourceName]=config),componentSystem&&"lose"===config.eventName&&(this._loseListeners[config.sourceName]=config))}for(var j=0;j<allComponentSystems.length;++j)allComponentSystems[j][onOrOff]("add",this._onComponentAdd,this),allComponentSystems[j][onOrOff]("beforeremove",this._onComponentRemove,this)},_proto._onSetEntity=function _onSetEntity(name,oldValue,newValue){if(newValue instanceof Entity)this._updateEntityReference();else{if(null!=newValue&&"string"!=typeof newValue)return void console.warn("Entity field `"+this._entityPropertyName+"` was set to unexpected type '"+typeof newValue+"'");oldValue!==newValue&&this._updateEntityReference()}},_proto._onPostInitialize=function _onPostInitialize(){this._updateEntityReference()},_proto.onParentComponentEnable=function onParentComponentEnable(){this._entity||this._updateEntityReference()},_proto._onSceneLoaded=function _onSceneLoaded(){this._updateEntityReference()},_proto._updateEntityReference=function _updateEntityReference(){var nextEntityGuid=this._parentComponent.data[this._entityPropertyName],nextEntity,hasChanged;if(nextEntityGuid instanceof Entity)nextEntityGuid=(nextEntity=nextEntityGuid).getGuid(),this._parentComponent.data[this._entityPropertyName]=nextEntityGuid;else{var root=this._parentComponent.system.app.root,isOnSceneGraph;nextEntity=this._parentComponent.entity.isDescendantOf(root)&&nextEntityGuid?root.findByGuid(nextEntityGuid):null}this._entity!==nextEntity&&(this._entity&&this._onBeforeEntityChange(),this._entity=nextEntity,this._entity&&this._onAfterEntityChange(),this.fire("set:entity",this._entity))},_proto._onBeforeEntityChange=function _onBeforeEntityChange(){this._toggleEntityListeners("off"),this._callAllGainOrLoseListeners(this._loseListeners)},_proto._onAfterEntityChange=function _onAfterEntityChange(){this._toggleEntityListeners("on"),this._callAllGainOrLoseListeners(this._gainListeners)},_proto._onComponentAdd=function _onComponentAdd(entity,component){var componentName=component.system.id;entity===this._entity&&(this._callGainOrLoseListener(componentName,this._gainListeners),this._toggleComponentListeners("on",componentName))},_proto._onComponentRemove=function _onComponentRemove(entity,component){var componentName=component.system.id;entity===this._entity&&(this._callGainOrLoseListener(componentName,this._loseListeners),this._toggleComponentListeners("off",componentName,!0))},_proto._callAllGainOrLoseListeners=function _callAllGainOrLoseListeners(listenerMap){for(var componentName in this._entity.c)this._callGainOrLoseListener(componentName,listenerMap)},_proto._callGainOrLoseListener=function _callGainOrLoseListener(componentName,listenerMap){if(this._entity.c.hasOwnProperty(componentName)&&listenerMap[componentName]){var config=listenerMap[componentName];config.callback.call(config.scope)}},_proto._toggleEntityListeners=function _toggleEntityListeners(onOrOff,isDestroying){if(this._entity)for(var i=0;i<this._eventListenerConfigs.length;++i)this._safeToggleListener(onOrOff,this._eventListenerConfigs[i],isDestroying)},_proto._toggleComponentListeners=function _toggleComponentListeners(onOrOff,componentName,isDestroying){for(var i=0;i<this._eventListenerConfigs.length;++i){var config=this._eventListenerConfigs[i];config.sourceName===componentName&&this._safeToggleListener(onOrOff,config,isDestroying)}},_proto._safeToggleListener=function _safeToggleListener(onOrOff,config,isDestroying){var isAdding="on"===onOrOff;if(!isAdding||!this._listenerStatusFlags[config.id]){var source=this._getEventSource(config.sourceName,isDestroying);source&&(source[onOrOff](config.eventName,config.callback,config.scope),this._listenerStatusFlags[config.id]=isAdding)}},_proto._getEventSource=function _getEventSource(sourceName,isDestroying){if("entity"===sourceName)return this._entity;var component=this._entity[sourceName];return component||(isDestroying||console.warn("Entity has no component with name "+sourceName),null)},_proto._onEntityDestroy=function _onEntityDestroy(entity){this._entity===entity&&(this._toggleEntityListeners("off",!0),this._entity=null)},_proto._onParentComponentRemove=function _onParentComponentRemove(entity,component){component===this._parentComponent&&(this._toggleLifecycleListeners("off"),this._toggleEntityListeners("off",!0))},_proto.hasComponent=function hasComponent(componentName){return!(!this._entity||!this._entity.c)&&!!this._entity.c[componentName]},_createClass(EntityReference,[{key:"entity",get:function get(){return this._entity}}]),EntityReference}(EventHandler),BUTTON_TRANSITION_MODE_TINT=0,BUTTON_TRANSITION_MODE_SPRITE_CHANGE=1,VisualState_DEFAULT="DEFAULT",VisualState_HOVER="HOVER",VisualState_PRESSED="PRESSED",VisualState_INACTIVE="INACTIVE",STATES_TO_TINT_NAMES={};STATES_TO_TINT_NAMES[VisualState_DEFAULT]="_defaultTint",STATES_TO_TINT_NAMES[VisualState_HOVER]="hoverTint",STATES_TO_TINT_NAMES[VisualState_PRESSED]="pressedTint",STATES_TO_TINT_NAMES[VisualState_INACTIVE]="inactiveTint";var STATES_TO_SPRITE_ASSET_NAMES={};STATES_TO_SPRITE_ASSET_NAMES[VisualState_DEFAULT]="_defaultSpriteAsset",STATES_TO_SPRITE_ASSET_NAMES[VisualState_HOVER]="hoverSpriteAsset",STATES_TO_SPRITE_ASSET_NAMES[VisualState_PRESSED]="pressedSpriteAsset",STATES_TO_SPRITE_ASSET_NAMES[VisualState_INACTIVE]="inactiveSpriteAsset";var STATES_TO_SPRITE_FRAME_NAMES={};STATES_TO_SPRITE_FRAME_NAMES[VisualState_DEFAULT]="_defaultSpriteFrame",STATES_TO_SPRITE_FRAME_NAMES[VisualState_HOVER]="hoverSpriteFrame",STATES_TO_SPRITE_FRAME_NAMES[VisualState_PRESSED]="pressedSpriteFrame",STATES_TO_SPRITE_FRAME_NAMES[VisualState_INACTIVE]="inactiveSpriteFrame";var ButtonComponent=function(_Component){function ButtonComponent(system,entity){var _this;return(_this=_Component.call(this,system,entity)||this)._visualState=VisualState_DEFAULT,_this._isHovering=!1,_this._hoveringCounter=0,_this._isPressed=!1,_this._defaultTint=new Color(1,1,1,1),_this._defaultSpriteAsset=null,_this._defaultSpriteFrame=0,_this._imageReference=new EntityReference(_assertThisInitialized(_this),"imageEntity",{"element#gain":_this._onImageElementGain,"element#lose":_this._onImageElementLose,"element#set:color":_this._onSetColor,"element#set:opacity":_this._onSetOpacity,"element#set:spriteAsset":_this._onSetSpriteAsset,"element#set:spriteFrame":_this._onSetSpriteFrame}),_this._toggleLifecycleListeners("on",system),_this}_inheritsLoose(ButtonComponent,_Component);var _proto=ButtonComponent.prototype;return _proto._toggleLifecycleListeners=function _toggleLifecycleListeners(onOrOff,system){this[onOrOff]("set_active",this._onSetActive,this),this[onOrOff]("set_transitionMode",this._onSetTransitionMode,this),this[onOrOff]("set_hoverTint",this._onSetTransitionValue,this),this[onOrOff]("set_pressedTint",this._onSetTransitionValue,this),this[onOrOff]("set_inactiveTint",this._onSetTransitionValue,this),this[onOrOff]("set_hoverSpriteAsset",this._onSetTransitionValue,this),this[onOrOff]("set_hoverSpriteFrame",this._onSetTransitionValue,this),this[onOrOff]("set_pressedSpriteAsset",this._onSetTransitionValue,this),this[onOrOff]("set_pressedSpriteFrame",this._onSetTransitionValue,this),this[onOrOff]("set_inactiveSpriteAsset",this._onSetTransitionValue,this),this[onOrOff]("set_inactiveSpriteFrame",this._onSetTransitionValue,this),system.app.systems.element[onOrOff]("add",this._onElementComponentAdd,this),system.app.systems.element[onOrOff]("beforeremove",this._onElementComponentRemove,this)},_proto._onSetActive=function _onSetActive(name,oldValue,newValue){oldValue!==newValue&&this._updateVisualState()},_proto._onSetTransitionMode=function _onSetTransitionMode(name,oldValue,newValue){oldValue!==newValue&&(this._cancelTween(),this._resetToDefaultVisualState(oldValue),this._forceReapplyVisualState())},_proto._onSetTransitionValue=function _onSetTransitionValue(name,oldValue,newValue){oldValue!==newValue&&this._forceReapplyVisualState()},_proto._onElementComponentRemove=function _onElementComponentRemove(entity){this.entity===entity&&this._toggleHitElementListeners("off")},_proto._onElementComponentAdd=function _onElementComponentAdd(entity){this.entity===entity&&this._toggleHitElementListeners("on")},_proto._onImageElementLose=function _onImageElementLose(){this._cancelTween(),this._resetToDefaultVisualState(this.transitionMode)},_proto._onImageElementGain=function _onImageElementGain(){this._storeDefaultVisualState(),this._forceReapplyVisualState()},_proto._toggleHitElementListeners=function _toggleHitElementListeners(onOrOff){if(this.entity.element){var isAdding="on"===onOrOff;if(isAdding&&this._hasHitElementListeners)return;this.entity.element[onOrOff]("mouseenter",this._onMouseEnter,this),this.entity.element[onOrOff]("mouseleave",this._onMouseLeave,this),this.entity.element[onOrOff]("mousedown",this._onMouseDown,this),this.entity.element[onOrOff]("mouseup",this._onMouseUp,this),this.entity.element[onOrOff]("touchstart",this._onTouchStart,this),this.entity.element[onOrOff]("touchend",this._onTouchEnd,this),this.entity.element[onOrOff]("touchleave",this._onTouchLeave,this),this.entity.element[onOrOff]("touchcancel",this._onTouchCancel,this),this.entity.element[onOrOff]("selectstart",this._onSelectStart,this),this.entity.element[onOrOff]("selectend",this._onSelectEnd,this),this.entity.element[onOrOff]("selectenter",this._onSelectEnter,this),this.entity.element[onOrOff]("selectleave",this._onSelectLeave,this),this.entity.element[onOrOff]("click",this._onClick,this),this._hasHitElementListeners=isAdding}},_proto._storeDefaultVisualState=function _storeDefaultVisualState(){this._imageReference.hasComponent("element")&&(this._storeDefaultColor(this._imageReference.entity.element.color),this._storeDefaultOpacity(this._imageReference.entity.element.opacity),this._storeDefaultSpriteAsset(this._imageReference.entity.element.spriteAsset),this._storeDefaultSpriteFrame(this._imageReference.entity.element.spriteFrame))},_proto._storeDefaultColor=function _storeDefaultColor(color){this._defaultTint.r=color.r,this._defaultTint.g=color.g,this._defaultTint.b=color.b},_proto._storeDefaultOpacity=function _storeDefaultOpacity(opacity){this._defaultTint.a=opacity},_proto._storeDefaultSpriteAsset=function _storeDefaultSpriteAsset(spriteAsset){this._defaultSpriteAsset=spriteAsset},_proto._storeDefaultSpriteFrame=function _storeDefaultSpriteFrame(spriteFrame){this._defaultSpriteFrame=spriteFrame},_proto._onSetColor=function _onSetColor(color){this._isApplyingTint||(this._storeDefaultColor(color),this._forceReapplyVisualState())},_proto._onSetOpacity=function _onSetOpacity(opacity){this._isApplyingTint||(this._storeDefaultOpacity(opacity),this._forceReapplyVisualState())},_proto._onSetSpriteAsset=function _onSetSpriteAsset(spriteAsset){this._isApplyingSprite||(this._storeDefaultSpriteAsset(spriteAsset),this._forceReapplyVisualState())},_proto._onSetSpriteFrame=function _onSetSpriteFrame(spriteFrame){this._isApplyingSprite||(this._storeDefaultSpriteFrame(spriteFrame),this._forceReapplyVisualState())},_proto._onMouseEnter=function _onMouseEnter(event){this._isHovering=!0,this._updateVisualState(),this._fireIfActive("mouseenter",event)},_proto._onMouseLeave=function _onMouseLeave(event){this._isHovering=!1,this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseleave",event)},_proto._onMouseDown=function _onMouseDown(event){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("mousedown",event)},_proto._onMouseUp=function _onMouseUp(event){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseup",event)},_proto._onTouchStart=function _onTouchStart(event){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("touchstart",event)},_proto._onTouchEnd=function _onTouchEnd(event){event.event.preventDefault(),this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchend",event)},_proto._onTouchLeave=function _onTouchLeave(event){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchleave",event)},_proto._onTouchCancel=function _onTouchCancel(event){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchcancel",event)},_proto._onSelectStart=function _onSelectStart(event){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("selectstart",event)},_proto._onSelectEnd=function _onSelectEnd(event){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("selectend",event)},_proto._onSelectEnter=function _onSelectEnter(event){this._hoveringCounter++,1===this._hoveringCounter&&(this._isHovering=!0,this._updateVisualState()),this._fireIfActive("selectenter",event)},_proto._onSelectLeave=function _onSelectLeave(event){this._hoveringCounter--,0===this._hoveringCounter&&(this._isHovering=!1,this._isPressed=!1,this._updateVisualState()),this._fireIfActive("selectleave",event)},_proto._onClick=function _onClick(event){this._fireIfActive("click",event)},_proto._fireIfActive=function _fireIfActive(name,event){this.data.active&&this.fire(name,event)},_proto._updateVisualState=function _updateVisualState(force){var oldVisualState=this._visualState,newVisualState=this._determineVisualState();if((oldVisualState!==newVisualState||force)&&this.enabled)switch(this._visualState=newVisualState,oldVisualState===VisualState_HOVER&&this._fireIfActive("hoverend"),oldVisualState===VisualState_PRESSED&&this._fireIfActive("pressedend"),newVisualState===VisualState_HOVER&&this._fireIfActive("hoverstart"),newVisualState===VisualState_PRESSED&&this._fireIfActive("pressedstart"),this.transitionMode){case 0:var tintName,tintColor=this[STATES_TO_TINT_NAMES[this._visualState]];this._applyTint(tintColor);break;case 1:var spriteAssetName=STATES_TO_SPRITE_ASSET_NAMES[this._visualState],spriteFrameName=STATES_TO_SPRITE_FRAME_NAMES[this._visualState],spriteAsset=this[spriteAssetName],spriteFrame=this[spriteFrameName];this._applySprite(spriteAsset,spriteFrame)}},_proto._forceReapplyVisualState=function _forceReapplyVisualState(){this._updateVisualState(!0)},_proto._resetToDefaultVisualState=function _resetToDefaultVisualState(transitionMode){if(this._imageReference.hasComponent("element"))switch(transitionMode){case 0:this._cancelTween(),this._applyTintImmediately(this._defaultTint);break;case 1:this._applySprite(this._defaultSpriteAsset,this._defaultSpriteFrame)}},_proto._determineVisualState=function _determineVisualState(){return this.active?this._isPressed?VisualState_PRESSED:this._isHovering?VisualState_HOVER:VisualState_DEFAULT:VisualState_INACTIVE},_proto._applySprite=function _applySprite(spriteAsset,spriteFrame){spriteFrame=spriteFrame||0,this._imageReference.hasComponent("element")&&(this._isApplyingSprite=!0,this._imageReference.entity.element.spriteAsset=spriteAsset,this._imageReference.entity.element.spriteFrame=spriteFrame,this._isApplyingSprite=!1)},_proto._applyTint=function _applyTint(tintColor){this._cancelTween(),0===this.fadeDuration?this._applyTintImmediately(tintColor):this._applyTintWithTween(tintColor)},_proto._applyTintImmediately=function _applyTintImmediately(tintColor){this._imageReference.hasComponent("element")&&tintColor&&(this._isApplyingTint=!0,this._imageReference.entity.element.color=toColor3(tintColor),this._imageReference.entity.element.opacity=tintColor.a,this._isApplyingTint=!1)},_proto._applyTintWithTween=function _applyTintWithTween(tintColor){if(this._imageReference.hasComponent("element")&&tintColor){var color=this._imageReference.entity.element.color,opacity=this._imageReference.entity.element.opacity;this._tweenInfo={startTime:now(),from:new Color(color.r,color.g,color.b,opacity),to:tintColor.clone(),lerpColor:new Color}}},_proto._updateTintTween=function _updateTintTween(){var elapsedTime=now()-this._tweenInfo.startTime,elapsedProportion=0===this.fadeDuration?1:elapsedTime/this.fadeDuration;if(elapsedProportion=math.clamp(elapsedProportion,0,1),Math.abs(elapsedProportion-1)>1e-5){var lerpColor=this._tweenInfo.lerpColor;lerpColor.lerp(this._tweenInfo.from,this._tweenInfo.to,elapsedProportion),this._applyTintImmediately(new Color(lerpColor.r,lerpColor.g,lerpColor.b,lerpColor.a))}else this._applyTintImmediately(this._tweenInfo.to),this._cancelTween()},_proto._cancelTween=function _cancelTween(){delete this._tweenInfo},_proto.onUpdate=function onUpdate(){this._tweenInfo&&this._updateTintTween()},_proto.onEnable=function onEnable(){this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._imageReference.onParentComponentEnable(),this._toggleHitElementListeners("on"),this._forceReapplyVisualState()},_proto.onDisable=function onDisable(){this._toggleHitElementListeners("off"),this._resetToDefaultVisualState(this.transitionMode)},_proto.onRemove=function onRemove(){this._toggleLifecycleListeners("off",this.system),this.onDisable()},ButtonComponent}(Component);function toColor3(color4){return new Color(color4.r,color4.g,color4.b)}var ButtonComponentData=function ButtonComponentData(){this.enabled=!0,this.active=!0,this.imageEntity=null,this.hitPadding=new Vec4,this.transitionMode=0,this.hoverTint=new Color(.75,.75,.75),this.pressedTint=new Color(.5,.5,.5),this.inactiveTint=new Color(.25,.25,.25),this.fadeDuration=0,this.hoverSpriteAsset=null,this.hoverSpriteFrame=0,this.pressedSpriteAsset=null,this.pressedSpriteFrame=0,this.inactiveSpriteAsset=null,this.inactiveSpriteFrame=0},_schema$h=["enabled","active",{name:"imageEntity",type:"entity"},{name:"hitPadding",type:"vec4"},"transitionMode",{name:"hoverTint",type:"rgba"},{name:"pressedTint",type:"rgba"},{name:"inactiveTint",type:"rgba"},"fadeDuration","hoverSpriteAsset","hoverSpriteFrame","pressedSpriteAsset","pressedSpriteFrame","inactiveSpriteAsset","inactiveSpriteFrame"],ButtonComponentSystem=function(_ComponentSystem){function ButtonComponentSystem(app){var _this;return(_this=_ComponentSystem.call(this,app)||this).id="button",_this.ComponentType=ButtonComponent,_this.DataType=ButtonComponentData,_this.schema=_schema$h,_this.on("beforeremove",_this._onRemoveComponent,_assertThisInitialized(_this)),ComponentSystem.bind("update",_this.onUpdate,_assertThisInitialized(_this)),_this}_inheritsLoose(ButtonComponentSystem,_ComponentSystem);var _proto=ButtonComponentSystem.prototype;return _proto.initializeComponentData=function initializeComponentData(component,data,properties){_ComponentSystem.prototype.initializeComponentData.call(this,component,data,_schema$h)},_proto.onUpdate=function onUpdate(dt){var components=this.store;for(var id in components){var entity=components[id].entity,component=entity.button;component.enabled&&entity.enabled&&component.onUpdate()}},_proto._onRemoveComponent=function _onRemoveComponent(entity,component){component.onRemove()},ButtonComponentSystem}(ComponentSystem),depthLayer$1;Component._buildAccessors(ButtonComponent.prototype,_schema$h);var PostEffect=function PostEffect(effect,inputTarget){this.effect=effect,this.inputTarget=inputTarget,this.outputTarget=null,this.name=effect.constructor.name},PostEffectQueue=function(){function PostEffectQueue(app,camera){var self=this;this.app=app,this.camera=camera,this.destinationRenderTarget=null,this.effects=[],this.enabled=!1,this.depthTarget=null,this.renderTargetScale=1,this.resizeTimeout=null,this.resizeLast=0,this._resizeTimeoutCallback=function(){self.resizeRenderTargets()},camera.on("set:rect",this.onCameraRectChanged,this)}var _proto=PostEffectQueue.prototype;return _proto._allocateColorBuffer=function _allocateColorBuffer(format,name){var rect=this.camera.rect,width=Math.floor(rect.z*this.app.graphicsDevice.width*this.renderTargetScale),height=Math.floor(rect.w*this.app.graphicsDevice.height*this.renderTargetScale),colorBuffer=new Texture(this.app.graphicsDevice,{format:format,width:width,height:height,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});return colorBuffer.name=name,colorBuffer},_proto._createOffscreenTarget=function _createOffscreenTarget(useDepth,hdr){var device=this.app.graphicsDevice,format=hdr?device.getHdrFormat():7,name=this.camera.entity.name+"-posteffect-"+this.effects.length,colorBuffer=this._allocateColorBuffer(format,name),useStencil=this.app.graphicsDevice.supportsStencil,samples=useDepth?device.samples:1;return new RenderTarget({colorBuffer:colorBuffer,depth:useDepth,stencil:useStencil,samples:samples})},_proto._resizeOffscreenTarget=function _resizeOffscreenTarget(rt){var format=rt.colorBuffer.format,name=rt.colorBuffer.name;rt.destroyFrameBuffers(),rt.destroyTextureBuffers(),rt._colorBuffer=this._allocateColorBuffer(format,name)},_proto._destroyOffscreenTarget=function _destroyOffscreenTarget(rt){rt.destroyTextureBuffers(),rt.destroy()},_proto.setRenderTargetScale=function setRenderTargetScale(scale){this.renderTargetScale=scale,this.resizeRenderTargets()},_proto.addEffect=function addEffect(effect){var effects=this.effects,isFirstEffect=0===effects.length,inputTarget=this._createOffscreenTarget(isFirstEffect,effect.hdr),newEntry=new PostEffect(effect,inputTarget);effects.push(newEntry),this._sourceTarget=newEntry.inputTarget,effects.length>1&&(effects[effects.length-2].outputTarget=newEntry.inputTarget),this._newPostEffect=effect,effect.needsDepthBuffer&&this._requestDepthMap(),this.enable(),this._newPostEffect=void 0},_proto.removeEffect=function removeEffect(effect){var i,len,index=-1;for(i=0,len=this.effects.length;i<len;i++)if(this.effects[i].effect===effect){index=i;break}index>=0&&(index>0?this.effects[index-1].outputTarget=index+1<this.effects.length?this.effects[index+1].inputTarget:null:this.effects.length>1&&(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),this.camera.renderTarget=this.effects[1].inputTarget),this._destroyOffscreenTarget(this.effects[index].inputTarget),this.effects.splice(index,1)),this.enabled&&effect.needsDepthBuffer&&this._releaseDepthMap(),0===this.effects.length&&this.disable()},_proto._requestDepthMaps=function _requestDepthMaps(){for(var i=0,len=this.effects.length;i<len;i++){var effect=this.effects[i].effect;this._newPostEffect!==effect&&(effect.needsDepthBuffer&&this._requestDepthMap())}},_proto._releaseDepthMaps=function _releaseDepthMaps(){for(var i=0,len=this.effects.length;i<len;i++){var effect;this.effects[i].effect.needsDepthBuffer&&this._releaseDepthMap()}},_proto._requestDepthMap=function _requestDepthMap(){depthLayer$1||(depthLayer$1=this.app.scene.layers.getLayerById(1)),depthLayer$1&&depthLayer$1.incrementCounter()},_proto._releaseDepthMap=function _releaseDepthMap(){depthLayer$1&&depthLayer$1.decrementCounter()},_proto.destroy=function destroy(){for(var i=0,len=this.effects.length;i<len;i++)this.effects[i].inputTarget.destroy();this.effects.length=0,this.disable()},_proto.enable=function enable(){if(!this.enabled&&this.effects.length){this.enabled=!0;var self=this;this._requestDepthMaps(),this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this),this.destinationRenderTarget=this.camera.renderTarget,this.camera.renderTarget=this.effects[0].inputTarget,this.camera.onPostprocessing=function(camera){if(self.enabled){var rect=null,len=self.effects.length;if(len)for(var i=0;i<len;i++){var fx=self.effects[i],destTarget=fx.outputTarget;i===len-1&&(rect=self.camera.rect,self.destinationRenderTarget&&(destTarget=self.destinationRenderTarget)),fx.effect.render(fx.inputTarget,destTarget,rect)}}}}},_proto.disable=function disable(){this.enabled&&(this.enabled=!1,this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this),this._releaseDepthMaps(),this._destroyOffscreenTarget(this._sourceTarget),this.camera.renderTarget=null,this.camera.onPostprocessing=null)},_proto._onCanvasResized=function _onCanvasResized(width,height){var rect=this.camera.rect,device=this.app.graphicsDevice;this.camera.camera.aspectRatio=device.width*rect.z/(device.height*rect.w),this.resizeTimeout||(now()-this.resizeLast>100?this.resizeRenderTargets():this.resizeTimeout=setTimeout(this._resizeTimeoutCallback,100))},_proto.resizeRenderTargets=function resizeRenderTargets(){this.resizeTimeout&&(clearTimeout(this.resizeTimeout),this.resizeTimeout=null),this.resizeLast=now();for(var rect=this.camera.rect,desiredWidth=Math.floor(rect.z*this.app.graphicsDevice.width*this.renderTargetScale),desiredHeight=Math.floor(rect.w*this.app.graphicsDevice.height*this.renderTargetScale),effects=this.effects,i=0,len=effects.length;i<len;i++){var fx=effects[i];fx.inputTarget.width===desiredWidth&&fx.inputTarget.height===desiredHeight||this._resizeOffscreenTarget(fx.inputTarget)}},_proto.onCameraRectChanged=function onCameraRectChanged(name,oldValue,newValue){this.enabled&&this.resizeRenderTargets()},PostEffectQueue}(),properties$1=[{name:"aspectRatio",readonly:!1},{name:"aspectRatioMode",readonly:!1},{name:"calculateProjection",readonly:!1},{name:"calculateTransform",readonly:!1},{name:"clearColor",readonly:!1},{name:"cullFaces",readonly:!1},{name:"farClip",readonly:!1},{name:"flipFaces",readonly:!1},{name:"fov",readonly:!1},{name:"frustum",readonly:!0},{name:"frustumCulling",readonly:!1},{name:"horizontalFov",readonly:!1},{name:"nearClip",readonly:!1},{name:"orthoHeight",readonly:!1},{name:"projection",readonly:!1},{name:"projectionMatrix",readonly:!0},{name:"scissorRect",readonly:!1},{name:"viewMatrix",readonly:!0},{name:"vrDisplay",readonly:!1}],CameraComponent=function(_Component){function CameraComponent(system,entity){var _this;return(_this=_Component.call(this,system,entity)||this)._camera=new Camera,_this._camera.node=entity,_this._priority=0,_this.onPostprocessing=null,_this._disablePostEffectsLayer=4,_this._postEffects=new PostEffectQueue(system.app,_assertThisInitialized(_this)),_this}_inheritsLoose(CameraComponent,_Component);var _proto=CameraComponent.prototype;return _proto.dirtyLayerCompositionCameras=function dirtyLayerCompositionCameras(){var layerComp;this.system.app.scene.layers._dirtyCameras=!0},_proto.screenToWorld=function screenToWorld(screenx,screeny,cameraz,worldCoord){var device=this.system.app.graphicsDevice,w=device.clientRect.width,h=device.clientRect.height;return this._camera.screenToWorld(screenx,screeny,cameraz,w,h,worldCoord)},_proto.worldToScreen=function worldToScreen(worldCoord,screenCoord){var device=this.system.app.graphicsDevice,w=device.clientRect.width,h=device.clientRect.height;return this._camera.worldToScreen(worldCoord,w,h,screenCoord)},_proto.onAppPrerender=function onAppPrerender(){this._camera._viewMatDirty=!0,this._camera._viewProjMatDirty=!0},_proto.addCameraToLayers=function addCameraToLayers(){for(var layers=this.layers,i=0;i<layers.length;i++){var layer=this.system.app.scene.layers.getLayerById(layers[i]);layer&&layer.addCamera(this)}},_proto.removeCameraFromLayers=function removeCameraFromLayers(){for(var layers=this.layers,i=0;i<layers.length;i++){var layer=this.system.app.scene.layers.getLayerById(layers[i]);layer&&layer.removeCamera(this)}},_proto.onLayersChanged=function onLayersChanged(oldComp,newComp){this.addCameraToLayers(),oldComp.off("add",this.onLayerAdded,this),oldComp.off("remove",this.onLayerRemoved,this),newComp.on("add",this.onLayerAdded,this),newComp.on("remove",this.onLayerRemoved,this)},_proto.onLayerAdded=function onLayerAdded(layer){var index;this.layers.indexOf(layer.id)<0||layer.addCamera(this)},_proto.onLayerRemoved=function onLayerRemoved(layer){var index;this.layers.indexOf(layer.id)<0||layer.removeCamera(this)},_proto.onEnable=function onEnable(){var system=this.system,scene=system.app.scene,layers=scene.layers;system.addCamera(this),scene.on("set:layers",this.onLayersChanged,this),layers&&(layers.on("add",this.onLayerAdded,this),layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addCameraToLayers(),this.postEffects.enable()},_proto.onDisable=function onDisable(){var system=this.system,scene=system.app.scene,layers=scene.layers;this.postEffects.disable(),this.removeCameraFromLayers(),scene.off("set:layers",this.onLayersChanged,this),layers&&(layers.off("add",this.onLayerAdded,this),layers.off("remove",this.onLayerRemoved,this)),system.removeCamera(this)},_proto.onRemove=function onRemove(){this.onDisable(),this.off()},_proto.calculateAspectRatio=function calculateAspectRatio(rt){var src=rt||this.system.app.graphicsDevice,rect=this.rect;return src.width*rect.z/(src.height*rect.w)},_proto.frameBegin=function frameBegin(rt){0===this.aspectRatioMode&&(this.aspectRatio=this.calculateAspectRatio(rt))},_proto.frameEnd=function frameEnd(){},_proto.enterVr=function enterVr(display,callback){if(display instanceof Function&&!callback&&(callback=display,display=null),this.system.app.vr)if(display||(display=this.system.app.vr.display),display){var self=this;display.capabilities.canPresent?display.requestPresent((function(err){err||(self.vrDisplay=display,self.vrDisplay.once("beforepresentchange",(function(display){display.presenting||(self.vrDisplay=null)}))),callback(err)})):(self.vrDisplay=display,callback())}else callback("No pc.VrDisplay to present");else callback("VrManager not created. Enable VR in project settings.")},_proto.exitVr=function exitVr(callback){if(this.vrDisplay)if(this.vrDisplay.capabilities.canPresent){var display=this.vrDisplay;this.vrDisplay=null,display.exitPresent(callback)}else this.vrDisplay=null,callback();else callback("Not presenting VR")},_proto.startXr=function startXr(type,spaceType,options){this.system.app.xr.start(this,type,spaceType,options)},_proto.endXr=function endXr(callback){this._camera.xr?this._camera.xr.end(callback):callback&&callback(new Error("Camera is not in XR"))},_proto.copy=function copy(source){var _this2=this;properties$1.forEach((function(property){if(!property.readonly){var name=property.name;_this2[name]=source[name]}})),this.clearColorBuffer=source.clearColorBuffer,this.clearDepthBuffer=source.clearDepthBuffer,this.clearStencilBuffer=source.clearStencilBuffer,this.disablePostEffectsLayer=source.disablePostEffectsLayer,this.layers=source.layers,this.priority=source.priority,this.renderTarget=source.renderTarget,this.rect=source.rect},_createClass(CameraComponent,[{key:"camera",get:function get(){return this._camera}},{key:"disablePostEffectsLayer",get:function get(){return this._disablePostEffectsLayer},set:function set(layer){this._disablePostEffectsLayer=layer,this.dirtyLayerCompositionCameras()}},{key:"postEffectsEnabled",get:function get(){return this._postEffects.enabled}},{key:"layers",get:function get(){return this._camera.layers},set:function set(newValue){var i,layer,layers=this._camera.layers;for(i=0;i<layers.length;i++)(layer=this.system.app.scene.layers.getLayerById(layers[i]))&&layer.removeCamera(this);if(this._camera.layers=newValue,this.enabled&&this.entity.enabled)for(i=0;i<newValue.length;i++)(layer=this.system.app.scene.layers.getLayerById(newValue[i]))&&layer.addCamera(this)}},{key:"postEffects",get:function get(){return this._postEffects}},{key:"priority",get:function get(){return this._priority},set:function set(newValue){this._priority=newValue,this.dirtyLayerCompositionCameras()}},{key:"rect",get:function get(){return this._camera.rect},set:function set(value){this._camera.rect=value,this.fire("set:rect",this._camera.rect)}},{key:"clearColorBuffer",get:function get(){return this._camera.clearColorBuffer},set:function set(value){this._camera.clearColorBuffer=value,this.dirtyLayerCompositionCameras()}},{key:"clearDepthBuffer",get:function get(){return this._camera.clearDepthBuffer},set:function set(value){this._camera.clearDepthBuffer=value,this.dirtyLayerCompositionCameras()}},{key:"clearStencilBuffer",get:function get(){return this._camera.clearStencilBuffer},set:function set(value){this._camera.clearStencilBuffer=value,this.dirtyLayerCompositionCameras()}},{key:"renderTarget",get:function get(){return this._camera.renderTarget},set:function set(value){this._camera.renderTarget=value,this.dirtyLayerCompositionCameras()}}]),CameraComponent}(Component);properties$1.forEach((function(property){var name=property.name,options={get:function(){return this._camera[name]}};property.readonly||(options.set=function(newValue){this._camera[name]=newValue}),Object.defineProperty(CameraComponent.prototype,name,options)}));var CameraComponentData=function CameraComponentData(){this.enabled=!0},_schema$g=["enabled"],CameraComponentSystem=function(_ComponentSystem){function CameraComponentSystem(app){var _this;return(_this=_ComponentSystem.call(this,app)||this).id="camera",_this.ComponentType=CameraComponent,_this.DataType=CameraComponentData,_this.schema=_schema$g,_this.cameras=[],_this.on("beforeremove",_this.onBeforeRemove,_assertThisInitialized(_this)),_this.app.on("prerender",_this.onAppPrerender,_assertThisInitialized(_this)),ComponentSystem.bind("update",_this.onUpdate,_assertThisInitialized(_this)),_this}_inheritsLoose(CameraComponentSystem,_ComponentSystem);var _proto=CameraComponentSystem.prototype;return _proto.initializeComponentData=function initializeComponentData(component,data,properties){properties=["aspectRatio","aspectRatioMode","calculateProjection","calculateTransform","clearColor","clearColorBuffer","clearDepthBuffer","clearStencilBuffer","cullFaces","farClip","flipFaces","fov","frustumCulling","horizontalFov","layers","renderTarget","nearClip","orthoHeight","projection","priority","rect","scissorRect"];for(var i=0;i<properties.length;i++){var property=properties[i];if(data.hasOwnProperty(property)){var value=data[property];switch(property){case"rect":case"scissorRect":Array.isArray(value)?component[property]=new Vec4(value[0],value[1],value[2],value[3]):component[property]=value;break;case"clearColor":Array.isArray(value)?component[property]=new Color(value[0],value[1],value[2],value[3]):component[property]=value;break;default:component[property]=value}}}_ComponentSystem.prototype.initializeComponentData.call(this,component,data,["enabled"])},_proto.cloneComponent=function cloneComponent(entity,clone){var c=entity.camera;this.addComponent(clone,{aspectRatio:c.aspectRatio,aspectRatioMode:c.aspectRatioMode,calculateProjection:c.calculateProjection,calculateTransform:c.calculateTransform,clearColor:c.clearColor,clearColorBuffer:c.clearColorBuffer,clearDepthBuffer:c.clearDepthBuffer,clearStencilBuffer:c.clearStencilBuffer,cullFaces:c.cullFaces,farClip:c.farClip,flipFaces:c.flipFaces,fov:c.fov,frustumCulling:c.frustumCulling,horizontalFov:c.horizontalFov,layers:c.layers,renderTarget:c.renderTarget,nearClip:c.nearClip,orthoHeight:c.orthoHeight,projection:c.projection,priority:c.priority,rect:c.rect,scissorRect:c.scissorRect})},_proto.onBeforeRemove=function onBeforeRemove(entity,component){this.removeCamera(component)},_proto.onUpdate=function onUpdate(dt){if(this.app.vr){var components=this.store;for(var id in components){var component=components[id];if(component.data.enabled&&component.entity.enabled){var cameraComponent=component.entity.camera,vrDisplay=cameraComponent.vrDisplay;vrDisplay&&(vrDisplay.setClipPlanes(cameraComponent.nearClip,cameraComponent.farClip),component.entity&&(component.entity.localTransform.copy(vrDisplay.combinedViewInv),component.entity._dirtyLocal=!1,component.entity._dirtifyWorld()))}}}},_proto.onAppPrerender=function onAppPrerender(){for(var i=0,len=this.cameras.length;i<len;i++)this.cameras[i].onAppPrerender()},_proto.addCamera=function addCamera(camera){this.cameras.push(camera),this.sortCamerasByPriority()},_proto.removeCamera=function removeCamera(camera){var index=this.cameras.indexOf(camera);index>=0&&(this.cameras.splice(index,1),this.sortCamerasByPriority())},_proto.sortCamerasByPriority=function sortCamerasByPriority(){this.cameras.sort((function(a,b){return a.priority-b.priority}))},CameraComponentSystem}(ComponentSystem);Component._buildAccessors(CameraComponent.prototype,_schema$g);var CollisionComponent=function(_Component){function CollisionComponent(system,entity){var _this;return(_this=_Component.call(this,system,entity)||this)._compoundParent=null,_this.entity.on("insert",_this._onInsert,_assertThisInitialized(_this)),_this.on("set_type",_this.onSetType,_assertThisInitialized(_this)),_this.on("set_halfExtents",_this.onSetHalfExtents,_assertThisInitialized(_this)),_this.on("set_radius",_this.onSetRadius,_assertThisInitialized(_this)),_this.on("set_height",_this.onSetHeight,_assertThisInitialized(_this)),_this.on("set_axis",_this.onSetAxis,_assertThisInitialized(_this)),_this.on("set_asset",_this.onSetAsset,_assertThisInitialized(_this)),_this.on("set_renderAsset",_this.onSetRenderAsset,_assertThisInitialized(_this)),_this.on("set_model",_this.onSetModel,_assertThisInitialized(_this)),_this.on("set_render",_this.onSetRender,_assertThisInitialized(_this)),_this}_inheritsLoose(CollisionComponent,_Component);var _proto=CollisionComponent.prototype;return _proto.onSetType=function onSetType(name,oldValue,newValue){oldValue!==newValue&&this.system.changeType(this,oldValue,newValue)},_proto.onSetHalfExtents=function onSetHalfExtents(name,oldValue,newValue){var t=this.data.type;this.data.initialized&&"box"===t&&this.system.recreatePhysicalShapes(this)},_proto.onSetRadius=function onSetRadius(name,oldValue,newValue){var t=this.data.type;!this.data.initialized||"sphere"!==t&&"capsule"!==t&&"cylinder"!==t&&"cone"!==t||this.system.recreatePhysicalShapes(this)},_proto.onSetHeight=function onSetHeight(name,oldValue,newValue){var t=this.data.type;!this.data.initialized||"capsule"!==t&&"cylinder"!==t&&"cone"!==t||this.system.recreatePhysicalShapes(this)},_proto.onSetAxis=function onSetAxis(name,oldValue,newValue){var t=this.data.type;!this.data.initialized||"capsule"!==t&&"cylinder"!==t&&"cone"!==t||this.system.recreatePhysicalShapes(this)},_proto.onSetAsset=function onSetAsset(name,oldValue,newValue){var asset,assets=this.system.app.assets;oldValue&&(asset=assets.get(oldValue))&&asset.off("remove",this.onAssetRemoved,this),newValue&&(newValue instanceof Asset&&(this.data.asset=newValue.id),(asset=assets.get(this.data.asset))&&(asset.off("remove",this.onAssetRemoved,this),asset.on("remove",this.onAssetRemoved,this))),this.data.initialized&&"mesh"===this.data.type&&(newValue||(this.data.model=null),this.system.recreatePhysicalShapes(this))},_proto.onSetRenderAsset=function onSetRenderAsset(name,oldValue,newValue){var asset,assets=this.system.app.assets;oldValue&&(asset=assets.get(oldValue))&&asset.off("remove",this.onRenderAssetRemoved,this),newValue&&(newValue instanceof Asset&&(this.data.renderAsset=newValue.id),(asset=assets.get(this.data.renderAsset))&&(asset.off("remove",this.onRenderAssetRemoved,this),asset.on("remove",this.onRenderAssetRemoved,this))),this.data.initialized&&"mesh"===this.data.type&&(newValue||(this.data.render=null),this.system.recreatePhysicalShapes(this))},_proto.onSetModel=function onSetModel(name,oldValue,newValue){this.data.initialized&&"mesh"===this.data.type&&this.system.implementations.mesh.doRecreatePhysicalShape(this)},_proto.onSetRender=function onSetRender(name,oldValue,newValue){this.onSetModel(name,oldValue,newValue)},_proto.onAssetRemoved=function onAssetRemoved(asset){asset.off("remove",this.onAssetRemoved,this),this.data.asset===asset.id&&(this.asset=null)},_proto.onRenderAssetRemoved=function onRenderAssetRemoved(asset){asset.off("remove",this.onRenderAssetRemoved,this),this.data.renderAsset===asset.id&&(this.renderAsset=null)},_proto._getCompoundChildShapeIndex=function _getCompoundChildShapeIndex(shape){for(var compound=this.data.shape,shapes=compound.getNumChildShapes(),i=0;i<shapes;i++){var childShape;if(compound.getChildShape(i).ptr===shape.ptr)return i}return null},_proto._onInsert=function _onInsert(parent){if("undefined"!=typeof Ammo)if(this._compoundParent)this.system.recreatePhysicalShapes(this);else if(!this.entity.rigidbody)for(var ancestor=this.entity.parent;ancestor;){if(ancestor.collision&&"compound"===ancestor.collision.type){0===ancestor.collision.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(ancestor.collision):this.system.recreatePhysicalShapes(this);break}ancestor=ancestor.parent}},_proto._updateCompound=function _updateCompound(){var entity=this.entity;if(entity._dirtyWorld){for(var dirty=entity._dirtyLocal,parent=entity;parent&&!dirty&&(!parent.collision||parent.collision!==this._compoundParent);)parent._dirtyLocal&&(dirty=!0),parent=parent.parent;if(dirty){entity.forEach(this.system.implementations.compound._updateEachDescendantTransform,entity);var bodyComponent=this._compoundParent.entity.rigidbody;bodyComponent&&bodyComponent.activate()}}},_proto.onEnable=function onEnable(){if("mesh"===this.data.type&&(this.data.asset||this.data.renderAsset)&&this.data.initialized){var asset=this.system.app.assets.get(this.data.asset||this.data.renderAsset);if(asset&&(!asset.resource||!this.data.shape))return void this.system.recreatePhysicalShapes(this)}if(this.entity.rigidbody)this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation();else if(this._compoundParent&&this!==this._compoundParent)if(0===this._compoundParent.shape.getNumChildShapes())this.system.recreatePhysicalShapes(this._compoundParent);else{var transform=this.system._getNodeTransform(this.entity,this._compoundParent.entity);this._compoundParent.shape.addChildShape(transform,this.data.shape),Ammo.destroy(transform),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()}else this.entity.trigger&&this.entity.trigger.enable()},_proto.onDisable=function onDisable(){this.entity.rigidbody?this.entity.rigidbody.disableSimulation():this._compoundParent&&this!==this._compoundParent?this._compoundParent.entity._destroying||(this.system._removeCompoundChild(this._compoundParent,this.data.shape),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&this.entity.trigger.disable()},_proto.onBeforeRemove=function onBeforeRemove(){this.asset&&(this.asset=null),this.renderAsset&&(this.renderAsset=null),this.entity.off("insert",this._onInsert,this),this.off()},CollisionComponent}(Component),CollisionComponentData=function CollisionComponentData(){this.enabled=!0,this.type="box",this.halfExtents=new Vec3(.5,.5,.5),this.radius=.5,this.axis=1,this.height=2,this.asset=null,this.renderAsset=null,this.shape=null,this.model=null,this.render=null,this.initialized=!1},BODYTYPE_STATIC="static",BODYTYPE_DYNAMIC="dynamic",BODYTYPE_KINEMATIC="kinematic",BODYFLAG_STATIC_OBJECT=1,BODYFLAG_KINEMATIC_OBJECT=2,BODYFLAG_NORESPONSE_OBJECT=4,BODYSTATE_ACTIVE_TAG=1,BODYSTATE_ISLAND_SLEEPING=2,BODYSTATE_WANTS_DEACTIVATION=3,BODYSTATE_DISABLE_DEACTIVATION=4,BODYSTATE_DISABLE_SIMULATION=5,BODYGROUP_NONE=0,BODYGROUP_DEFAULT=1,BODYGROUP_DYNAMIC=1,BODYGROUP_STATIC=2,BODYGROUP_KINEMATIC=4,BODYGROUP_ENGINE_1=8,BODYGROUP_TRIGGER=16,BODYGROUP_ENGINE_2=32,BODYGROUP_ENGINE_3=64,BODYGROUP_USER_1=128,BODYGROUP_USER_2=256,BODYGROUP_USER_3=512,BODYGROUP_USER_4=1024,BODYGROUP_USER_5=2048,BODYGROUP_USER_6=4096,BODYGROUP_USER_7=8192,BODYGROUP_USER_8=16384,BODYMASK_NONE=0,BODYMASK_ALL=65535,BODYMASK_STATIC=2,BODYMASK_NOT_STATIC=65533,BODYMASK_NOT_STATIC_KINEMATIC=65529,ammoVec1$1,ammoQuat$1,ammoTransform$1,Trigger=function(){function Trigger(app,component,data){this.entity=component.entity,this.component=component,this.app=app,"undefined"==typeof Ammo||ammoVec1$1||(ammoVec1$1=new Ammo.btVector3,ammoQuat$1=new Ammo.btQuaternion,ammoTransform$1=new Ammo.btTransform),this.initialize(data)}var _proto=Trigger.prototype;return _proto.initialize=function initialize(data){var entity=this.entity,shape=data.shape;if(shape&&"undefined"!=typeof Ammo){entity.trigger&&entity.trigger.destroy();var mass=1,pos=entity.getPosition(),rot=entity.getRotation();ammoVec1$1.setValue(pos.x,pos.y,pos.z),ammoQuat$1.setValue(rot.x,rot.y,rot.z,rot.w),ammoTransform$1.setOrigin(ammoVec1$1),ammoTransform$1.setRotation(ammoQuat$1);var body=this.app.systems.rigidbody.createBody(1,shape,ammoTransform$1);body.setRestitution(0),body.setFriction(0),body.setDamping(0,0),ammoVec1$1.setValue(0,0,0),body.setLinearFactor(ammoVec1$1),body.setAngularFactor(ammoVec1$1),body.setCollisionFlags(4|body.getCollisionFlags()),body.entity=entity,this.body=body,this.component.enabled&&entity.enabled&&this.enable()}},_proto.destroy=function destroy(){var body=this.body;body&&(this.disable(),this.app.systems.rigidbody.destroyBody(body))},_proto._getEntityTransform=function _getEntityTransform(transform){var pos=this.entity.getPosition(),rot=this.entity.getRotation();ammoVec1$1.setValue(pos.x,pos.y,pos.z),ammoQuat$1.setValue(rot.x,rot.y,rot.z,rot.w),transform.setOrigin(ammoVec1$1),transform.setRotation(ammoQuat$1)},_proto.updateTransform=function updateTransform(){this._getEntityTransform(ammoTransform$1);var body=this.body;body.setWorldTransform(ammoTransform$1),body.activate()},_proto.enable=function enable(){var body=this.body;if(body){var systems=this.app.systems;systems.rigidbody.addBody(body,16,65517),systems.rigidbody._triggers.push(this),body.forceActivationState(1),this.updateTransform()}},_proto.disable=function disable(){var body=this.body;if(body){var systems=this.app.systems,idx=systems.rigidbody._triggers.indexOf(this);idx>-1&&systems.rigidbody._triggers.splice(idx,1),systems.rigidbody.removeBody(body),body.forceActivationState(5)}},Trigger}(),mat4=new Mat4,vec3=new Vec3,quat=new Quat,tempGraphNode=new GraphNode,_schema$f=["enabled","type","halfExtents","radius","axis","height","asset","renderAsset","shape","model","render"],CollisionSystemImpl=function(){function CollisionSystemImpl(system){this.system=system}var _proto=CollisionSystemImpl.prototype;return _proto.beforeInitialize=function beforeInitialize(component,data){data.shape=null,data.model=new Model,data.model.graph=new GraphNode},_proto.afterInitialize=function afterInitialize(component,data){this.recreatePhysicalShapes(component),component.data.initialized=!0},_proto.reset=function reset(component,data){this.beforeInitialize(component,data),this.afterInitialize(component,data)},_proto.recreatePhysicalShapes=function recreatePhysicalShapes(component){var entity=component.entity,data=component.data;if("undefined"!=typeof Ammo){entity.trigger&&(entity.trigger.destroy(),delete entity.trigger),data.shape&&(component._compoundParent&&(this.system._removeCompoundChild(component._compoundParent,data.shape),component._compoundParent.entity.rigidbody&&component._compoundParent.entity.rigidbody.activate()),Ammo.destroy(data.shape),data.shape=null),data.shape=this.createPhysicalShape(component.entity,data);var firstCompoundChild=!component._compoundParent;if("compound"!==data.type||component._compoundParent&&component!==component._compoundParent){if("compound"!==data.type&&(component._compoundParent&&component===component._compoundParent&&entity.forEach(this.system.implementations.compound._updateEachDescendant,component),!component.rigidbody)){component._compoundParent=null;for(var parent=entity.parent;parent;){if(parent.collision&&"compound"===parent.collision.type){component._compoundParent=parent.collision;break}parent=parent.parent}}}else component._compoundParent=component,entity.forEach(this._addEachDescendant,component);component._compoundParent&&component!==component._compoundParent&&(firstCompoundChild&&0===component._compoundParent.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(component._compoundParent):(this.system.updateCompoundChildTransform(entity),component._compoundParent.entity.rigidbody&&component._compoundParent.entity.rigidbody.activate())),entity.rigidbody?(entity.rigidbody.disableSimulation(),entity.rigidbody.createBody(),entity.enabled&&entity.rigidbody.enabled&&entity.rigidbody.enableSimulation()):component._compoundParent||(entity.trigger?entity.trigger.initialize(data):entity.trigger=new Trigger(this.system.app,component,data))}},_proto.createPhysicalShape=function createPhysicalShape(entity,data){},_proto.updateTransform=function updateTransform(component,position,rotation,scale){component.entity.trigger&&component.entity.trigger.updateTransform()},_proto.beforeRemove=function beforeRemove(entity,component){component.data.shape&&(component._compoundParent&&!component._compoundParent.entity._destroying&&(this.system._removeCompoundChild(component._compoundParent,component.data.shape),component._compoundParent.entity.rigidbody&&component._compoundParent.entity.rigidbody.activate()),component._compoundParent=null,Ammo.destroy(component.data.shape),component.data.shape=null)},_proto.remove=function remove(entity,data){var app=this.system.app;entity.rigidbody&&entity.rigidbody.body&&entity.rigidbody.disableSimulation(),entity.trigger&&(entity.trigger.destroy(),delete entity.trigger),app.scene.containsModel(data.model)&&(app.root.removeChild(data.model.graph),app.scene.removeModel(data.model))},_proto.clone=function clone(entity,_clone){var src=this.system.store[entity.getGuid()],data={enabled:src.data.enabled,type:src.data.type,halfExtents:[src.data.halfExtents.x,src.data.halfExtents.y,src.data.halfExtents.z],radius:src.data.radius,axis:src.data.axis,height:src.data.height,asset:src.data.asset,renderAsset:src.data.renderAsset,model:src.data.model,render:src.data.render};return this.system.addComponent(_clone,data)},CollisionSystemImpl}(),CollisionBoxSystemImpl=function(_CollisionSystemImpl){function CollisionBoxSystemImpl(){return _CollisionSystemImpl.apply(this,arguments)||this}var _proto2;return _inheritsLoose(CollisionBoxSystemImpl,_CollisionSystemImpl),CollisionBoxSystemImpl.prototype.createPhysicalShape=function createPhysicalShape(entity,data){if("undefined"!=typeof Ammo){var he=data.halfExtents,ammoHe=new Ammo.btVector3(he?he.x:.5,he?he.y:.5,he?he.z:.5),shape=new Ammo.btBoxShape(ammoHe);return Ammo.destroy(ammoHe),shape}},CollisionBoxSystemImpl}(CollisionSystemImpl),CollisionSphereSystemImpl=function(_CollisionSystemImpl2){function CollisionSphereSystemImpl(){return _CollisionSystemImpl2.apply(this,arguments)||this}var _proto3;return _inheritsLoose(CollisionSphereSystemImpl,_CollisionSystemImpl2),CollisionSphereSystemImpl.prototype.createPhysicalShape=function createPhysicalShape(entity,data){if("undefined"!=typeof Ammo)return new Ammo.btSphereShape(data.radius)},CollisionSphereSystemImpl}(CollisionSystemImpl),CollisionCapsuleSystemImpl=function(_CollisionSystemImpl3){function CollisionCapsuleSystemImpl(){return _CollisionSystemImpl3.apply(this,arguments)||this}var _proto4;return _inheritsLoose(CollisionCapsuleSystemImpl,_CollisionSystemImpl3),CollisionCapsuleSystemImpl.prototype.createPhysicalShape=function createPhysicalShape(entity,data){var shape=null,axis=void 0!==data.axis?data.axis:1,radius=data.radius||.5,height=Math.max((data.height||2)-2*radius,0);if("undefined"!=typeof Ammo)switch(axis){case 0:shape=new Ammo.btCapsuleShapeX(radius,height);break;case 1:shape=new Ammo.btCapsuleShape(radius,height);break;case 2:shape=new Ammo.btCapsuleShapeZ(radius,height)}return shape},CollisionCapsuleSystemImpl}(CollisionSystemImpl),CollisionCylinderSystemImpl=function(_CollisionSystemImpl4){function CollisionCylinderSystemImpl(){return _CollisionSystemImpl4.apply(this,arguments)||this}var _proto5;return _inheritsLoose(CollisionCylinderSystemImpl,_CollisionSystemImpl4),CollisionCylinderSystemImpl.prototype.createPhysicalShape=function createPhysicalShape(entity,data){var halfExtents=null,shape=null,axis=void 0!==data.axis?data.axis:1,radius=void 0!==data.radius?data.radius:.5,height=void 0!==data.height?data.height:1;if("undefined"!=typeof Ammo)switch(axis){case 0:halfExtents=new Ammo.btVector3(.5*height,radius,radius),shape=new Ammo.btCylinderShapeX(halfExtents);break;case 1:halfExtents=new Ammo.btVector3(radius,.5*height,radius),shape=new Ammo.btCylinderShape(halfExtents);break;case 2:halfExtents=new Ammo.btVector3(radius,radius,.5*height),shape=new Ammo.btCylinderShapeZ(halfExtents)}return halfExtents&&Ammo.destroy(halfExtents),shape},CollisionCylinderSystemImpl}(CollisionSystemImpl),CollisionConeSystemImpl=function(_CollisionSystemImpl5){function CollisionConeSystemImpl(){return _CollisionSystemImpl5.apply(this,arguments)||this}var _proto6;return _inheritsLoose(CollisionConeSystemImpl,_CollisionSystemImpl5),CollisionConeSystemImpl.prototype.createPhysicalShape=function createPhysicalShape(entity,data){var shape=null,axis=void 0!==data.axis?data.axis:1,radius=void 0!==data.radius?data.radius:.5,height=void 0!==data.height?data.height:1;if("undefined"!=typeof Ammo)switch(axis){case 0:shape=new Ammo.btConeShapeX(radius,height);break;case 1:shape=new Ammo.btConeShape(radius,height);break;case 2:shape=new Ammo.btConeShapeZ(radius,height)}return shape},CollisionConeSystemImpl}(CollisionSystemImpl),CollisionMeshSystemImpl=function(_CollisionSystemImpl6){function CollisionMeshSystemImpl(){return _CollisionSystemImpl6.apply(this,arguments)||this}_inheritsLoose(CollisionMeshSystemImpl,_CollisionSystemImpl6);var _proto7=CollisionMeshSystemImpl.prototype;return _proto7.beforeInitialize=function beforeInitialize(component,data){},_proto7.createAmmoMesh=function createAmmoMesh(mesh,node,shape){var triMesh,i;if(this.system._triMeshCache[mesh.id])triMesh=this.system._triMeshCache[mesh.id];else{var vb=mesh.vertexBuffer,format=vb.getFormat(),stride,positions;for(i=0;i<format.elements.length;i++){var element=format.elements[i];if("POSITION"===element.name){positions=new Float32Array(vb.lock(),element.offset),stride=element.stride/4;break}}var indices=[];mesh.getIndices(indices);var numTriangles=mesh.primitive[0].count/3,v1=new Ammo.btVector3,v2=new Ammo.btVector3,v3=new Ammo.btVector3,i1,i2,i3,base=mesh.primitive[0].base;for(triMesh=new Ammo.btTriangleMesh,this.system._triMeshCache[mesh.id]=triMesh,i=0;i<numTriangles;i++)i1=indices[base+3*i]*stride,i2=indices[base+3*i+1]*stride,i3=indices[base+3*i+2]*stride,v1.setValue(positions[i1],positions[i1+1],positions[i1+2]),v2.setValue(positions[i2],positions[i2+1],positions[i2+2]),v3.setValue(positions[i3],positions[i3+1],positions[i3+2]),triMesh.addTriangle(v1,v2,v3,!0);Ammo.destroy(v1),Ammo.destroy(v2),Ammo.destroy(v3)}var useQuantizedAabbCompression=!0,triMeshShape=new Ammo.btBvhTriangleMeshShape(triMesh,!0),scaling=this.system._getNodeScaling(node);triMeshShape.setLocalScaling(scaling),Ammo.destroy(scaling);var transform=this.system._getNodeTransform(node);shape.addChildShape(transform,triMeshShape),Ammo.destroy(transform)},_proto7.createPhysicalShape=function createPhysicalShape(entity,data){if("undefined"!=typeof Ammo&&(data.model||data.render)){var shape=new Ammo.btCompoundShape;if(data.model)for(var meshInstances=data.model.meshInstances,i=0;i<meshInstances.length;i++)this.createAmmoMesh(meshInstances[i].mesh,meshInstances[i].node,shape);else if(data.render)for(var meshes=data.render.meshes,_i=0;_i<meshes.length;_i++)this.createAmmoMesh(meshes[_i],tempGraphNode,shape);var entityTransform,scale=entity.getWorldTransform().getScale(),vec=new Ammo.btVector3(scale.x,scale.y,scale.z);return shape.setLocalScaling(vec),Ammo.destroy(vec),shape}},_proto7.recreatePhysicalShapes=function recreatePhysicalShapes(component){var data=component.data;(data.renderAsset||data.asset)&&component.enabled&&component.entity.enabled?this.loadAsset(component,data.renderAsset||data.asset,data.renderAsset?"render":"model"):this.doRecreatePhysicalShape(component)},_proto7.loadAsset=function loadAsset(component,id,property){var self=this,data=component.data,assets=this.system.app.assets,asset=assets.get(id);asset?(asset.ready((function(asset){data[property]=asset.resource,self.doRecreatePhysicalShape(component)})),assets.load(asset)):assets.once("add:"+id,(function(asset){asset.ready((function(asset){data[property]=asset.resource,self.doRecreatePhysicalShape(component)})),assets.load(asset)}))},_proto7.doRecreatePhysicalShape=function doRecreatePhysicalShape(component){var entity=component.entity,data=component.data;data.model||data.render?(this.destroyShape(data),data.shape=this.createPhysicalShape(entity,data),entity.rigidbody?(entity.rigidbody.disableSimulation(),entity.rigidbody.createBody(),entity.enabled&&entity.rigidbody.enabled&&entity.rigidbody.enableSimulation()):entity.trigger?entity.trigger.initialize(data):entity.trigger=new Trigger(this.system.app,component,data)):(this.beforeRemove(entity,component),this.remove(entity,data))},_proto7.updateTransform=function updateTransform(component,position,rotation,scale){if(component.shape){var entityTransform,worldScale=component.entity.getWorldTransform().getScale(),previousScale=component.shape.getLocalScaling();worldScale.x===previousScale.x()&&worldScale.y===previousScale.y()&&worldScale.z===previousScale.z()||this.doRecreatePhysicalShape(component)}_CollisionSystemImpl6.prototype.updateTransform.call(this,component,position,rotation,scale)},_proto7.destroyShape=function destroyShape(data){if(data.shape){for(var numShapes=data.shape.getNumChildShapes(),i=0;i<numShapes;i++){var shape=data.shape.getChildShape(i);Ammo.destroy(shape)}Ammo.destroy(data.shape),data.shape=null}},_proto7.remove=function remove(entity,data){this.destroyShape(data),_CollisionSystemImpl6.prototype.remove.call(this,entity,data)},CollisionMeshSystemImpl}(CollisionSystemImpl),CollisionCompoundSystemImpl=function(_CollisionSystemImpl7){function CollisionCompoundSystemImpl(){return _CollisionSystemImpl7.apply(this,arguments)||this}_inheritsLoose(CollisionCompoundSystemImpl,_CollisionSystemImpl7);var _proto8=CollisionCompoundSystemImpl.prototype;return _proto8.createPhysicalShape=function createPhysicalShape(entity,data){if("undefined"!=typeof Ammo)return new Ammo.btCompoundShape},_proto8._addEachDescendant=function _addEachDescendant(entity){entity.collision&&!entity.rigidbody&&(entity.collision._compoundParent=this,entity!==this.entity&&entity.collision.system.recreatePhysicalShapes(entity.collision))},_proto8._updateEachDescendant=function _updateEachDescendant(entity){entity.collision&&entity.collision._compoundParent===this&&(entity.collision._compoundParent=null,entity===this.entity||entity.rigidbody||entity.collision.system.recreatePhysicalShapes(entity.collision))},_proto8._updateEachDescendantTransform=function _updateEachDescendantTransform(entity){entity.collision&&entity.collision._compoundParent===this.collision._compoundParent&&this.collision.system.updateCompoundChildTransform(entity)},CollisionCompoundSystemImpl}(CollisionSystemImpl),CollisionComponentSystem=function(_ComponentSystem){function CollisionComponentSystem(app){var _this;return(_this=_ComponentSystem.call(this,app)||this).id="collision",_this.ComponentType=CollisionComponent,_this.DataType=CollisionComponentData,_this.schema=_schema$f,_this.implementations={},_this._triMeshCache={},_this.on("beforeremove",_this.onBeforeRemove,_assertThisInitialized(_this)),_this.on("remove",_this.onRemove,_assertThisInitialized(_this)),_this}_inheritsLoose(CollisionComponentSystem,_ComponentSystem);var _proto9=CollisionComponentSystem.prototype;return _proto9.initializeComponentData=function initializeComponentData(component,_data,properties){for(var data={},i=0,len=(properties=["type","halfExtents","radius","axis","height","shape","model","asset","render","renderAsset","enabled"]).length,idx;i<len;i++){var property=properties[i];data[property]=_data[property]}_data.hasOwnProperty("asset")?(-1!==(idx=properties.indexOf("model"))&&properties.splice(idx,1),-1!==(idx=properties.indexOf("render"))&&properties.splice(idx,1)):_data.hasOwnProperty("model")&&-1!==(idx=properties.indexOf("asset"))&&properties.splice(idx,1),data.type||(data.type=component.data.type),component.data.type=data.type,data.halfExtents&&Array.isArray(data.halfExtents)&&(data.halfExtents=new Vec3(data.halfExtents[0],data.halfExtents[1],data.halfExtents[2]));var impl=this._createImplementation(data.type);impl.beforeInitialize(component,data),_ComponentSystem.prototype.initializeComponentData.call(this,component,data,properties),impl.afterInitialize(component,data)},_proto9._createImplementation=function _createImplementation(type){if(void 0===this.implementations[type]){var impl;switch(type){case"box":impl=new CollisionBoxSystemImpl(this);break;case"sphere":impl=new CollisionSphereSystemImpl(this);break;case"capsule":impl=new CollisionCapsuleSystemImpl(this);break;case"cylinder":impl=new CollisionCylinderSystemImpl(this);break;case"cone":impl=new CollisionConeSystemImpl(this);break;case"mesh":impl=new CollisionMeshSystemImpl(this);break;case"compound":impl=new CollisionCompoundSystemImpl(this)}this.implementations[type]=impl}return this.implementations[type]},_proto9._getImplementation=function _getImplementation(entity){return this.implementations[entity.collision.data.type]},_proto9.cloneComponent=function cloneComponent(entity,clone){return this._getImplementation(entity).clone(entity,clone)},_proto9.onBeforeRemove=function onBeforeRemove(entity,component){this.implementations[component.data.type].beforeRemove(entity,component),component.onBeforeRemove()},_proto9.onRemove=function onRemove(entity,data){this.implementations[data.type].remove(entity,data)},_proto9.updateCompoundChildTransform=function updateCompoundChildTransform(entity){if(this._removeCompoundChild(entity.collision._compoundParent,entity.collision.data.shape),entity.enabled&&entity.collision.enabled){var transform=this._getNodeTransform(entity,entity.collision._compoundParent.entity);entity.collision._compoundParent.shape.addChildShape(transform,entity.collision.data.shape),Ammo.destroy(transform)}},_proto9._removeCompoundChild=function _removeCompoundChild(collision,shape){if(collision.shape.removeChildShape)collision.shape.removeChildShape(shape);else{var ind=collision._getCompoundChildShapeIndex(shape);null!==ind&&collision.shape.removeChildShapeByIndex(ind)}},_proto9.onTransformChanged=function onTransformChanged(component,position,rotation,scale){this.implementations[component.data.type].updateTransform(component,position,rotation,scale)},_proto9.changeType=function changeType(component,previousType,newType){this.implementations[previousType].beforeRemove(component.entity,component),this.implementations[previousType].remove(component.entity,component.data),this._createImplementation(newType).reset(component,component.data)},_proto9.recreatePhysicalShapes=function recreatePhysicalShapes(component){this.implementations[component.data.type].recreatePhysicalShapes(component)},_proto9._calculateNodeRelativeTransform=function _calculateNodeRelativeTransform(node,relative){if(node===relative){var scale=node.getWorldTransform().getScale();mat4.setScale(scale.x,scale.y,scale.z)}else this._calculateNodeRelativeTransform(node.parent,relative),mat4.mul(node.getLocalTransform())},_proto9._getNodeScaling=function _getNodeScaling(node){var wtm,scl=node.getWorldTransform().getScale();return new Ammo.btVector3(scl.x,scl.y,scl.z)},_proto9._getNodeTransform=function _getNodeTransform(node,relative){var pos,rot;relative?(this._calculateNodeRelativeTransform(node,relative),pos=vec3,rot=quat,mat4.getTranslation(pos),rot.setFromMat4(mat4)):(pos=node.getPosition(),rot=node.getRotation());var transform=new Ammo.btTransform;transform.setIdentity();var origin=transform.getOrigin();origin.setValue(pos.x,pos.y,pos.z);var ammoQuat=new Ammo.btQuaternion;return ammoQuat.setValue(rot.x,rot.y,rot.z,rot.w),transform.setRotation(ammoQuat),Ammo.destroy(ammoQuat),Ammo.destroy(origin),transform},_proto9.destroy=function destroy(){for(var key in this._triMeshCache)Ammo.destroy(this._triMeshCache[key]);this._triMeshCache=null,_ComponentSystem.prototype.destroy.call(this)},CollisionComponentSystem}(ComponentSystem);Component._buildAccessors(CollisionComponent.prototype,_schema$f);var ComponentSystemRegistry=function(){function ComponentSystemRegistry(){this.list=[]}var _proto=ComponentSystemRegistry.prototype;return _proto.add=function add(system){var id=system.id;if(this[id])throw new Error("ComponentSystem name '"+id+"' already registered or not allowed");this[id]=system,this.list.push(system)},_proto.remove=function remove(system){var id=system.id;if(!this[id])throw new Error("No ComponentSystem named '"+id+"' registered");delete this[id];var index=this.list.indexOf(this[id]);-1!==index&&this.list.splice(index,1)},ComponentSystemRegistry}(),ELEMENTTYPE_GROUP="group",ELEMENTTYPE_IMAGE="image",ELEMENTTYPE_TEXT="text",StencilParameters=function(){function StencilParameters(options){this.func=void 0===options.func?7:options.func,this.ref=options.ref||0,this.readMask=void 0===options.readMask?255:options.readMask,this.writeMask=void 0===options.writeMask?255:options.writeMask,this.fail=options.fail||0,this.zfail=options.zfail||0,this.zpass=options.zpass||0}var _proto;return StencilParameters.prototype.clone=function clone(){return new StencilParameters({func:this.func,ref:this.ref,readMask:this.readMask,writeMask:this.writeMask,fail:this.fail,zfail:this.zfail,zpass:this.zpass})},StencilParameters}(),ImageRenderable=function(){function ImageRenderable(entity,mesh,material){this._entity=entity,this._element=entity.element,this.model=new Model,this.node=new GraphNode,this.model.graph=this.node,this.mesh=mesh,this.meshInstance=new MeshInstance(this.mesh,material,this.node),this.meshInstance.name="ImageElement: "+entity.name,this.meshInstance.castShadow=!1,this.meshInstance.receiveShadow=!1,this._meshDirty=!1,this.model.meshInstances.push(this.meshInstance),this._entity.addChild(this.model.graph),this.model._entity=this._entity,this.unmaskMeshInstance=null}var _proto=ImageRenderable.prototype;return _proto.destroy=function destroy(){this.setMaterial(null),this._element.removeModelFromLayers(this.model),this.model.destroy(),this.model=null,this.node=null,this.mesh=null,this.meshInstance=null,this._entity=null,this._element=null},_proto.setMesh=function setMesh(mesh){this.meshInstance&&(this.mesh=mesh,this.meshInstance.mesh=mesh,this.meshInstance.visible=!!mesh,this.unmaskMeshInstance&&(this.unmaskMeshInstance.mesh=mesh),this.forceUpdateAabb())},_proto.setMask=function setMask(mask){if(this.meshInstance){if(mask)for(var name in this.unmaskMeshInstance=new MeshInstance(this.mesh,this.meshInstance.material,this.node),this.unmaskMeshInstance.name="Unmask: "+this._entity.name,this.unmaskMeshInstance.castShadow=!1,this.unmaskMeshInstance.receiveShadow=!1,this.unmaskMeshInstance.pick=!1,this.model.meshInstances.push(this.unmaskMeshInstance),this.meshInstance.parameters)this.unmaskMeshInstance.setParameter(name,this.meshInstance.parameters[name].data);else{var idx=this.model.meshInstances.indexOf(this.unmaskMeshInstance);idx>=0&&this.model.meshInstances.splice(idx,1),this.unmaskMeshInstance=null}this._entity.enabled&&this._element.enabled&&(this._element.removeModelFromLayers(this.model),this._element.addModelToLayers(this.model))}},_proto.setMaterial=function setMaterial(material){this.meshInstance&&(this.meshInstance.material=material,this.unmaskMeshInstance&&(this.unmaskMeshInstance.material=material))},_proto.setParameter=function setParameter(name,value){this.meshInstance&&(this.meshInstance.setParameter(name,value),this.unmaskMeshInstance&&this.unmaskMeshInstance.setParameter(name,value))},_proto.deleteParameter=function deleteParameter(name){this.meshInstance&&(this.meshInstance.deleteParameter(name),this.unmaskMeshInstance&&this.unmaskMeshInstance.deleteParameter(name))},_proto.setUnmaskDrawOrder=function setUnmaskDrawOrder(){if(this.meshInstance){var getLastChild=function getLastChild(e){var last,c=e.children,l=c.length;if(l){for(var i=0;i<l;i++)c[i].element&&(last=c[i]);if(!last)return null;var child=getLastChild(last);return child||last}return null};if(this.unmaskMeshInstance){var lastChild=getLastChild(this._entity);lastChild&&lastChild.element?this.unmaskMeshInstance.drawOrder=lastChild.element.drawOrder+lastChild.element.getMaskOffset():this.unmaskMeshInstance.drawOrder=this.meshInstance.drawOrder+this._element.getMaskOffset()}}},_proto.setDrawOrder=function setDrawOrder(drawOrder){this.meshInstance&&(this.meshInstance.drawOrder=drawOrder)},_proto.setCull=function setCull(cull){if(this.meshInstance){var element=this._element,visibleFn=null;cull&&element._isScreenCulled()&&(visibleFn=function visibleFn(camera){return element.isVisibleForCamera(camera)}),this.meshInstance.cull=cull,this.meshInstance.isVisibleFunc=visibleFn,this.unmaskMeshInstance&&(this.unmaskMeshInstance.cull=cull,this.unmaskMeshInstance.isVisibleFunc=visibleFn)}},_proto.setScreenSpace=function setScreenSpace(screenSpace){this.meshInstance&&(this.meshInstance.screenSpace=screenSpace,this.unmaskMeshInstance&&(this.unmaskMeshInstance.screenSpace=screenSpace))},_proto.setLayer=function setLayer(layer){this.meshInstance&&(this.meshInstance.layer=layer,this.unmaskMeshInstance&&(this.unmaskMeshInstance.layer=layer))},_proto.forceUpdateAabb=function forceUpdateAabb(mask){this.meshInstance&&(this.meshInstance._aabbVer=-1,this.unmaskMeshInstance&&(this.unmaskMeshInstance._aabbVer=-1))},_proto.setAabbFunc=function setAabbFunc(fn){this.meshInstance&&(this.meshInstance._updateAabbFunc=fn,this.unmaskMeshInstance&&(this.unmaskMeshInstance._updateAabbFunc=fn))},ImageRenderable}(),ImageElement=function(){function ImageElement(element){this._element=element,this._entity=element.entity,this._system=element.system,this._textureAsset=null,this._texture=null,this._materialAsset=null,this._material=null,this._spriteAsset=null,this._sprite=null,this._spriteFrame=0,this._pixelsPerUnit=null,this._rect=new Vec4(0,0,1,1),this._mask=!1,this._maskRef=0,this._outerScale=new Vec2,this._outerScaleUniform=new Float32Array(2),this._innerOffset=new Vec4,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new Vec4,this._atlasRectUniform=new Float32Array(4),this._defaultMesh=this._createMesh(),this._renderable=new ImageRenderable(this._entity,this._defaultMesh,this._material),this._color=new Color(1,1,1,1),this._colorUniform=new Float32Array([1,1,1]),this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",1),this._updateAabbFunc=this._updateAabb.bind(this),this._onScreenChange(this._element.screen),this._element.on("resize",this._onParentResizeOrPivotChange,this),this._element.on("set:pivot",this._onParentResizeOrPivotChange,this),this._element.on("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.on("set:screen",this._onScreenChange,this),this._element.on("set:draworder",this._onDrawOrderChange,this),this._element.on("screen:set:resolution",this._onResolutionChange,this)}var _proto2=ImageElement.prototype;return _proto2.destroy=function destroy(){this.textureAsset=null,this.spriteAsset=null,this.materialAsset=null,this._renderable.setMesh(this._defaultMesh),this._renderable.destroy(),this._defaultMesh=null,this._element.off("resize",this._onParentResizeOrPivotChange,this),this._element.off("set:pivot",this._onParentResizeOrPivotChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("screen:set:resolution",this._onResolutionChange,this)},_proto2._onResolutionChange=function _onResolutionChange(res){},_proto2._onParentResizeOrPivotChange=function _onParentResizeOrPivotChange(){this._renderable.mesh&&this._updateMesh(this._renderable.mesh)},_proto2._onScreenSpaceChange=function _onScreenSpaceChange(value){this._updateMaterial(value)},_proto2._onScreenChange=function _onScreenChange(screen,previous){screen?this._updateMaterial(screen.screen.screenSpace):this._updateMaterial(!1)},_proto2._onDrawOrderChange=function _onDrawOrderChange(order){this._renderable.setDrawOrder(order),this.mask&&this._element.screen&&this._element.screen.screen.once("syncdraworder",(function(){this._renderable.setUnmaskDrawOrder()}),this)},_proto2._hasUserMaterial=function _hasUserMaterial(){return!!this._materialAsset||!!this._material&&-1===this._system.defaultImageMaterials.indexOf(this._material)},_proto2._use9Slicing=function _use9Slicing(){return this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)},_proto2._updateMaterial=function _updateMaterial(screenSpace){var mask=!!this._mask,nineSliced=!(!this.sprite||1!==this.sprite.renderMode),nineTiled=!(!this.sprite||2!==this.sprite.renderMode);this._hasUserMaterial()||(this._material=this._system.getImageElementMaterial(screenSpace,mask,nineSliced,nineTiled)),this._renderable&&(this._renderable.setCull(!0),this._renderable.setMaterial(this._material),this._renderable.setScreenSpace(screenSpace),this._renderable.setLayer(screenSpace?0:15))},_proto2._createMesh=function _createMesh(){var element=this._element,w=element.calculatedWidth,h=element.calculatedHeight,r=this._rect,vertexData=new ArrayBuffer(128),vertexDataF32=new Float32Array(vertexData);vertexDataF32[5]=1,vertexDataF32[6]=r.x,vertexDataF32[7]=r.y,vertexDataF32[8]=w,vertexDataF32[13]=1,vertexDataF32[14]=r.x+r.z,vertexDataF32[15]=r.y,vertexDataF32[16]=w,vertexDataF32[17]=h,vertexDataF32[21]=1,vertexDataF32[22]=r.x+r.z,vertexDataF32[23]=r.y+r.w,vertexDataF32[25]=h,vertexDataF32[29]=1,vertexDataF32[30]=r.x,vertexDataF32[31]=r.y+r.w;var vertexDesc=[{semantic:"POSITION",components:3,type:6},{semantic:"NORMAL",components:3,type:6},{semantic:"TEXCOORD0",components:2,type:6}],device=this._system.app.graphicsDevice,vertexFormat=new VertexFormat(device,vertexDesc),vertexBuffer=new VertexBuffer(device,vertexFormat,4,0,vertexData),mesh=new Mesh(device);return mesh.vertexBuffer=vertexBuffer,mesh.primitive[0].type=6,mesh.primitive[0].base=0,mesh.primitive[0].count=4,mesh.primitive[0].indexed=!1,mesh.aabb.setMinMax(Vec3.ZERO,new Vec3(w,h,0)),this._updateMesh(mesh),mesh},_proto2._updateMesh=function _updateMesh(mesh){var element=this._element,w=element.calculatedWidth,h=element.calculatedHeight,screenSpace=element._isScreenSpace();if(this._updateMaterial(screenSpace),this._renderable&&this._renderable.forceUpdateAabb(),!this.sprite||1!==this.sprite.renderMode&&2!==this.sprite.renderMode){var vb=mesh.vertexBuffer,vertexDataF32=new Float32Array(vb.lock()),hp=element.pivot.x,vp=element.pivot.y;vertexDataF32[0]=0-hp*w,vertexDataF32[1]=0-vp*h,vertexDataF32[8]=w-hp*w,vertexDataF32[9]=0-vp*h,vertexDataF32[16]=w-hp*w,vertexDataF32[17]=h-vp*h,vertexDataF32[24]=0-hp*w,vertexDataF32[25]=h-vp*h;var atlasTextureWidth=1,atlasTextureHeight=1,rect=this._rect;if(this._sprite&&this._sprite.frameKeys[this._spriteFrame]&&this._sprite.atlas){var frame=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];frame&&(rect=frame.rect,atlasTextureWidth=this._sprite.atlas.texture.width,atlasTextureHeight=this._sprite.atlas.texture.height)}vertexDataF32[6]=rect.x/atlasTextureWidth,vertexDataF32[7]=rect.y/atlasTextureHeight,vertexDataF32[14]=(rect.x+rect.z)/atlasTextureWidth,vertexDataF32[15]=rect.y/atlasTextureHeight,vertexDataF32[22]=(rect.x+rect.z)/atlasTextureWidth,vertexDataF32[23]=(rect.y+rect.w)/atlasTextureHeight,vertexDataF32[30]=rect.x/atlasTextureWidth,vertexDataF32[31]=(rect.y+rect.w)/atlasTextureHeight,vb.unlock();var min=new Vec3(0-hp*w,0-vp*h,0),max=new Vec3(w-hp*w,h-vp*h,0);mesh.aabb.setMinMax(min,max),this._renderable&&(this._renderable.node.setLocalScale(1,1,1),this._renderable.node.setLocalPosition(0,0,0),this._renderable.setAabbFunc(null))}else{var frameData=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]],borderWidthScale=2/frameData.rect.z,borderHeightScale=2/frameData.rect.w;this._innerOffset.set(frameData.border.x*borderWidthScale,frameData.border.y*borderHeightScale,frameData.border.z*borderWidthScale,frameData.border.w*borderHeightScale);var tex=this.sprite.atlas.texture;this._atlasRect.set(frameData.rect.x/tex.width,frameData.rect.y/tex.height,frameData.rect.z/tex.width,frameData.rect.w/tex.height);var ppu=null!==this._pixelsPerUnit?this._pixelsPerUnit:this.sprite.pixelsPerUnit,scaleMulX=frameData.rect.z/ppu,scaleMulY=frameData.rect.w/ppu;this._outerScale.set(Math.max(w,this._innerOffset.x*scaleMulX),Math.max(h,this._innerOffset.y*scaleMulY));var scaleX=scaleMulX,scaleY=scaleMulY;this._outerScale.x/=scaleMulX,this._outerScale.y/=scaleMulY,scaleX*=math.clamp(w/(this._innerOffset.x*scaleMulX),1e-4,1),scaleY*=math.clamp(h/(this._innerOffset.y*scaleMulY),1e-4,1),this._renderable&&(this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._renderable.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._renderable.setParameter("atlasRect",this._atlasRectUniform),this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._renderable.setParameter("outerScale",this._outerScaleUniform),this._renderable.setAabbFunc(this._updateAabbFunc),this._renderable.node.setLocalScale(scaleX,scaleY,1),this._renderable.node.setLocalPosition((.5-element.pivot.x)*w,(.5-element.pivot.y)*h,0))}this._meshDirty=!1},_proto2._updateSprite=function _updateSprite(){var nineSlice=!1,mesh=null;this._sprite&&this._sprite.atlas&&(mesh=this._sprite.meshes[this.spriteFrame],nineSlice=1===this._sprite.renderMode||2===this._sprite.renderMode),this.mesh=nineSlice?mesh:this._defaultMesh,this.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this.mesh))},_proto2._updateAabb=function _updateAabb(aabb){return aabb.center.set(0,0,0),aabb.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),aabb.setFromTransformedAabb(aabb,this._renderable.node.getWorldTransform()),aabb},_proto2._toggleMask=function _toggleMask(){this._element._dirtifyMask();var screenSpace=this._element._isScreenSpace();this._updateMaterial(screenSpace),this._renderable.setMask(!!this._mask)},_proto2._onMaterialLoad=function _onMaterialLoad(asset){this.material=asset.resource},_proto2._onMaterialAdded=function _onMaterialAdded(asset){this._system.app.assets.off("add:"+asset.id,this._onMaterialAdded,this),this._materialAsset===asset.id&&this._bindMaterialAsset(asset)},_proto2._bindMaterialAsset=function _bindMaterialAsset(asset){this._entity.enabled&&(asset.on("load",this._onMaterialLoad,this),asset.on("change",this._onMaterialChange,this),asset.on("remove",this._onMaterialRemove,this),asset.resource?this._onMaterialLoad(asset):this._system.app.assets.load(asset))},_proto2._unbindMaterialAsset=function _unbindMaterialAsset(asset){asset.off("load",this._onMaterialLoad,this),asset.off("change",this._onMaterialChange,this),asset.off("remove",this._onMaterialRemove,this)},_proto2._onMaterialChange=function _onMaterialChange(){},_proto2._onMaterialRemove=function _onMaterialRemove(){},_proto2._onTextureAdded=function _onTextureAdded(asset){this._system.app.assets.off("add:"+asset.id,this._onTextureAdded,this),this._textureAsset===asset.id&&this._bindTextureAsset(asset)},_proto2._bindTextureAsset=function _bindTextureAsset(asset){this._entity.enabled&&(asset.on("load",this._onTextureLoad,this),asset.on("change",this._onTextureChange,this),asset.on("remove",this._onTextureRemove,this),asset.resource?this._onTextureLoad(asset):this._system.app.assets.load(asset))},_proto2._unbindTextureAsset=function _unbindTextureAsset(asset){asset.off("load",this._onTextureLoad,this),asset.off("change",this._onTextureChange,this),asset.off("remove",this._onTextureRemove,this)},_proto2._onTextureLoad=function _onTextureLoad(asset){this.texture=asset.resource},_proto2._onTextureChange=function _onTextureChange(asset){},_proto2._onTextureRemove=function _onTextureRemove(asset){},_proto2._onSpriteAssetAdded=function _onSpriteAssetAdded(asset){this._system.app.assets.off("add:"+asset.id,this._onSpriteAssetAdded,this),this._spriteAsset===asset.id&&this._bindSpriteAsset(asset)},_proto2._bindSpriteAsset=function _bindSpriteAsset(asset){this._entity.enabled&&(asset.on("load",this._onSpriteAssetLoad,this),asset.on("change",this._onSpriteAssetChange,this),asset.on("remove",this._onSpriteAssetRemove,this),asset.resource?this._onSpriteAssetLoad(asset):this._system.app.assets.load(asset))},_proto2._unbindSpriteAsset=function _unbindSpriteAsset(asset){asset.off("load",this._onSpriteAssetLoad,this),asset.off("change",this._onSpriteAssetChange,this),asset.off("remove",this._onSpriteAssetRemove,this),asset.data.textureAtlasAsset&&this._system.app.assets.off("load:"+asset.data.textureAtlasAsset,this._onTextureAtlasLoad,this)},_proto2._onSpriteAssetLoad=function _onSpriteAssetLoad(asset){if(asset&&asset.resource)if(asset.resource.atlas)this.sprite=asset.resource;else{var atlasAssetId=asset.data.textureAtlasAsset;if(atlasAssetId){var assets=this._system.app.assets;assets.off("load:"+atlasAssetId,this._onTextureAtlasLoad,this),assets.once("load:"+atlasAssetId,this._onTextureAtlasLoad,this)}}else this.sprite=null},_proto2._onSpriteAssetChange=function _onSpriteAssetChange(asset){this._onSpriteAssetLoad(asset)},_proto2._onSpriteAssetRemove=function _onSpriteAssetRemove(asset){},_proto2._bindSprite=function _bindSprite(sprite){sprite.on("set:meshes",this._onSpriteMeshesChange,this),sprite.on("set:pixelsPerUnit",this._onSpritePpuChange,this),sprite.on("set:atlas",this._onAtlasTextureChange,this),sprite.atlas&&sprite.atlas.on("set:texture",this._onAtlasTextureChange,this)},_proto2._unbindSprite=function _unbindSprite(sprite){sprite.off("set:meshes",this._onSpriteMeshesChange,this),sprite.off("set:pixelsPerUnit",this._onSpritePpuChange,this),sprite.off("set:atlas",this._onAtlasTextureChange,this),sprite.atlas&&sprite.atlas.off("set:texture",this._onAtlasTextureChange,this)},_proto2._onSpriteMeshesChange=function _onSpriteMeshesChange(){this._sprite&&(this._spriteFrame=math.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()},_proto2._onSpritePpuChange=function _onSpritePpuChange(){0!==this.sprite.renderMode&&null===this._pixelsPerUnit&&this._updateSprite()},_proto2._onAtlasTextureChange=function _onAtlasTextureChange(){this.sprite&&this.sprite.atlas&&this.sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))},_proto2._onTextureAtlasLoad=function _onTextureAtlasLoad(atlasAsset){var spriteAsset=this._spriteAsset;spriteAsset instanceof Asset?this._onSpriteAssetLoad(spriteAsset):this._onSpriteAssetLoad(this._system.app.assets.get(spriteAsset))},_proto2.onEnable=function onEnable(){var asset;this._materialAsset&&(asset=this._system.app.assets.get(this._materialAsset))&&asset.resource!==this._material&&this._bindMaterialAsset(asset),this._textureAsset&&(asset=this._system.app.assets.get(this._textureAsset))&&asset.resource!==this._texture&&this._bindTextureAsset(asset),this._spriteAsset&&(asset=this._system.app.assets.get(this._spriteAsset))&&asset.resource!==this._sprite&&this._bindSpriteAsset(asset),this._element.addModelToLayers(this._renderable.model)},_proto2.onDisable=function onDisable(){this._element.removeModelFromLayers(this._renderable.model)},_proto2._setStencil=function _setStencil(stencilParams){this._renderable.meshInstance.stencilFront=stencilParams,this._renderable.meshInstance.stencilBack=stencilParams;var ref=0;if(this._element.maskedBy&&(ref=this._element.maskedBy.element._image._maskRef),this._renderable.unmaskMeshInstance){var sp=new StencilParameters({ref:ref+1,func:2,zpass:5});this._renderable.unmaskMeshInstance.stencilFront=sp,this._renderable.unmaskMeshInstance.stencilBack=sp}},_createClass(ImageElement,[{key:"color",get:function get(){return this._color},set:function set(value){var r=value.r,g=value.g,b=value.b;this._color.r===r&&this._color.g===g&&this._color.b===b||(this._color.r=r,this._color.g=g,this._color.b=b,this._colorUniform[0]=r,this._colorUniform[1]=g,this._colorUniform[2]=b,this._renderable.setParameter("material_emissive",this._colorUniform),this._element&&this._element.fire("set:color",this._color))}},{key:"opacity",get:function get(){return this._color.a},set:function set(value){value!==this._color.a&&(this._color.a=value,this._renderable.setParameter("material_opacity",value),this._element&&this._element.fire("set:opacity",value))}},{key:"rect",get:function get(){return this._rect},set:function set(value){var x,y,z,w;value instanceof Vec4?(x=value.x,y=value.y,z=value.z,w=value.w):(x=value[0],y=value[1],z=value[2],w=value[3]),x===this._rect.x&&y===this._rect.y&&z===this._rect.z&&w===this._rect.w||(this._rect.set(x,y,z,w),this._renderable.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this._renderable.mesh)))}},{key:"material",get:function get(){return this._material},set:function set(value){if(this._material!==value){if(!value){var screenSpace=this._element._isScreenSpace();value=this.mask?screenSpace?this._system.defaultScreenSpaceImageMaskMaterial:this._system.defaultImageMaskMaterial:screenSpace?this._system.defaultScreenSpaceImageMaterial:this._system.defaultImageMaterial}this._material=value,value&&(this._renderable.setMaterial(value),this._hasUserMaterial()?(this._renderable.deleteParameter("material_opacity"),this._renderable.deleteParameter("material_emissive")):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)))}}},{key:"materialAsset",get:function get(){return this._materialAsset},set:function set(value){var assets=this._system.app.assets,_id=value;if(value instanceof Asset&&(_id=value.id),this._materialAsset!==_id){if(this._materialAsset){assets.off("add:"+this._materialAsset,this._onMaterialAdded,this);var _prev=assets.get(this._materialAsset);_prev&&(_prev.off("load",this._onMaterialLoad,this),_prev.off("change",this._onMaterialChange,this),_prev.off("remove",this._onMaterialRemove,this))}if(this._materialAsset=_id,this._materialAsset){var asset=assets.get(this._materialAsset);asset?this._bindMaterialAsset(asset):(this.material=null,assets.on("add:"+this._materialAsset,this._onMaterialAdded,this))}else this.material=null}}},{key:"texture",get:function get(){return this._texture},set:function set(value){if(this._texture!==value){if(this._textureAsset){var textureAsset=this._system.app.assets.get(this._textureAsset);textureAsset&&textureAsset.resource!==value&&(this.textureAsset=null)}this._texture=value,value?(this._spriteAsset&&(this.spriteAsset=null),this._renderable.setParameter("texture_emissiveMap",this._texture),this._renderable.setParameter("texture_opacityMap",this._texture),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))}}},{key:"textureAsset",get:function get(){return this._textureAsset},set:function set(value){var assets=this._system.app.assets,_id=value;if(value instanceof Asset&&(_id=value.id),this._textureAsset!==_id){if(this._textureAsset){assets.off("add:"+this._textureAsset,this._onTextureAdded,this);var _prev=assets.get(this._textureAsset);_prev&&(_prev.off("load",this._onTextureLoad,this),_prev.off("change",this._onTextureChange,this),_prev.off("remove",this._onTextureRemove,this))}if(this._textureAsset=_id,this._textureAsset){var asset=assets.get(this._textureAsset);asset?this._bindTextureAsset(asset):(this.texture=null,assets.on("add:"+this._textureAsset,this._onTextureAdded,this))}else this.texture=null}}},{key:"spriteAsset",get:function get(){return this._spriteAsset},set:function set(value){var assets=this._system.app.assets,_id=value;if(value instanceof Asset&&(_id=value.id),this._spriteAsset!==_id){if(this._spriteAsset){assets.off("add:"+this._spriteAsset,this._onSpriteAssetAdded,this);var _prev=assets.get(this._spriteAsset);_prev&&this._unbindSpriteAsset(_prev)}if(this._spriteAsset=_id,this._spriteAsset){var asset=assets.get(this._spriteAsset);asset?this._bindSpriteAsset(asset):(this.sprite=null,assets.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this))}else this.sprite=null;this._element&&this._element.fire("set:spriteAsset",_id)}}},{key:"sprite",get:function get(){return this._sprite},set:function set(value){if(this._sprite!==value){if(this._sprite&&this._unbindSprite(this._sprite),this._spriteAsset){var spriteAsset=this._system.app.assets.get(this._spriteAsset);spriteAsset&&spriteAsset.resource!==value&&(this.spriteAsset=null)}this._sprite=value,this._sprite&&(this._bindSprite(this._sprite),this._textureAsset&&(this.textureAsset=null)),this._sprite&&this._sprite.atlas&&this._sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap")),this._sprite&&(this._spriteFrame=math.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()}}},{key:"spriteFrame",get:function get(){return this._spriteFrame},set:function set(value){var oldValue=this._spriteFrame;this._sprite?this._spriteFrame=math.clamp(value,0,this._sprite.frameKeys.length-1):this._spriteFrame=value,this._spriteFrame!==oldValue&&(this._updateSprite(),this._element&&this._element.fire("set:spriteFrame",value))}},{key:"mesh",get:function get(){return this._renderable.mesh},set:function set(value){this._renderable.setMesh(value),this._defaultMesh===value?this._renderable.setAabbFunc(null):this._renderable.setAabbFunc(this._updateAabbFunc)}},{key:"mask",get:function get(){return this._mask},set:function set(value){this._mask!==value&&(this._mask=value,this._toggleMask())}},{key:"pixelsPerUnit",get:function get(){return this._pixelsPerUnit},set:function set(value){this._pixelsPerUnit!==value&&(this._pixelsPerUnit=value,!this._sprite||1!==this._sprite.renderMode&&2!==this._sprite.renderMode||this._updateSprite())}},{key:"aabb",get:function get(){return this._renderable.meshInstance?this._renderable.meshInstance.aabb:null}}]),ImageElement}(),LocalizedAsset=function(_EventHandler){function LocalizedAsset(app){var _this;return(_this=_EventHandler.call(this)||this)._app=app,app.i18n.on("set:locale",_this._onSetLocale,_assertThisInitialized(_this)),_this._autoLoad=!1,_this._disableLocalization=!1,_this._defaultAsset=null,_this._localizedAsset=null,_this}_inheritsLoose(LocalizedAsset,_EventHandler);var _proto=LocalizedAsset.prototype;return _proto._bindDefaultAsset=function _bindDefaultAsset(){var asset=this._app.assets.get(this._defaultAsset);asset?this._onDefaultAssetAdd(asset):this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this)},_proto._unbindDefaultAsset=function _unbindDefaultAsset(){if(this._defaultAsset){this._app.assets.off("add:"+this._defaultAsset,this._onDefaultAssetAdd,this);var asset=this._app.assets.get(this._defaultAsset);asset&&(asset.off("add:localized",this._onLocaleAdd,this),asset.off("remove:localized",this._onLocaleRemove,this),asset.off("remove",this._onDefaultAssetRemove,this))}},_proto._onDefaultAssetAdd=function _onDefaultAssetAdd(asset){this._defaultAsset===asset.id&&(asset.on("add:localized",this._onLocaleAdd,this),asset.on("remove:localized",this._onLocaleRemove,this),asset.once("remove",this._onDefaultAssetRemove,this))},_proto._onDefaultAssetRemove=function _onDefaultAssetRemove(asset){this._defaultAsset===asset.id&&(asset.off("add:localized",this._onLocaleAdd,this),asset.off("remove:localized",this._onLocaleAdd,this),this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this))},_proto._bindLocalizedAsset=function _bindLocalizedAsset(){if(this._autoLoad){var asset=this._app.assets.get(this._localizedAsset);asset&&(asset.on("load",this._onLocalizedAssetLoad,this),asset.on("change",this._onLocalizedAssetChange,this),asset.on("remove",this._onLocalizedAssetRemove,this),asset.resource?this._onLocalizedAssetLoad(asset):this._app.assets.load(asset))}},_proto._unbindLocalizedAsset=function _unbindLocalizedAsset(){var asset=this._app.assets.get(this._localizedAsset);asset&&(asset.off("load",this._onLocalizedAssetLoad,this),asset.off("change",this._onLocalizedAssetChange,this),asset.off("remove",this._onLocalizedAssetRemove,this))},_proto._onLocalizedAssetAdd=function _onLocalizedAssetAdd(asset){this._localizedAsset===asset.id&&this._bindLocalizedAsset()},_proto._onLocalizedAssetLoad=function _onLocalizedAssetLoad(asset){this.fire("load",asset)},_proto._onLocalizedAssetChange=function _onLocalizedAssetChange(asset,name,newValue,oldValue){this.fire("change",asset,name,newValue,oldValue)},_proto._onLocalizedAssetRemove=function _onLocalizedAssetRemove(asset){this._localizedAsset===asset.id&&(this.localizedAsset=this._defaultAsset),this.fire("remove",asset)},_proto._onLocaleAdd=function _onLocaleAdd(locale,assetId){this._app.i18n.locale===locale&&this._onSetLocale(locale)},_proto._onLocaleRemove=function _onLocaleRemove(locale,assetId){this._app.i18n.locale===locale&&this._onSetLocale(locale)},_proto._onSetLocale=function _onSetLocale(locale){if(this._defaultAsset){var asset=this._app.assets.get(this._defaultAsset);if(asset&&!this._disableLocalization){var localizedAssetId=asset.getLocalizedAssetId(locale);this.localizedAsset=localizedAssetId||this._defaultAsset}else this.localizedAsset=this._defaultAsset}else this.localizedAsset=null},_proto.destroy=function destroy(){this.defaultAsset=null,this._app.i18n.off("set:locale",this._onSetLocale,this),this.off()},_createClass(LocalizedAsset,[{key:"defaultAsset",get:function get(){return this._defaultAsset},set:function set(value){var id=value instanceof Asset?value.id:value;this._defaultAsset!==id&&(this._defaultAsset&&this._unbindDefaultAsset(),this._defaultAsset=id,this._defaultAsset&&this._bindDefaultAsset(),this._onSetLocale(this._app.i18n.locale))}},{key:"localizedAsset",get:function get(){return this._localizedAsset},set:function set(value){var id=value instanceof Asset?value.id:value,asset;this._localizedAsset!==id&&(this._localizedAsset&&(this._app.assets.off("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this),this._unbindLocalizedAsset(),this._localizedAsset=null),this._localizedAsset=id,this._localizedAsset&&(this._app.assets.get(this._localizedAsset)?this._bindLocalizedAsset():this._app.assets.once("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this)))}},{key:"autoLoad",get:function get(){return this._autoLoad},set:function set(value){this._autoLoad!==value&&(this._autoLoad=value,this._autoLoad&&this._localizedAsset&&(this._unbindLocalizedAsset(),this._bindLocalizedAsset()))}},{key:"disableLocalization",get:function get(){return this._disableLocalization},set:function set(value){this._disableLocalization!==value&&(this._disableLocalization=value,this._onSetLocale(this._app.i18n.locale))}}]),LocalizedAsset}(EventHandler),EOF_TOKEN=0,ERROR_TOKEN=1,TEXT_TOKEN=2,OPEN_BRACKET_TOKEN=3,CLOSE_BRACKET_TOKEN=4,EQUALS_TOKEN=5,STRING_TOKEN=6,IDENTIFIER_TOKEN=7,WHITESPACE_TOKEN=8,WHITESPACE_CHARS=" \t\n\r\v\f",IDENTIFIER_REGEX=/[A-Z|a-z|0-9|_|-|/]/,Scanner=function(){function Scanner(symbols){this._symbols=symbols,this._index=0,this._last=0,this._cur=this._symbols.length>0?this._symbols[0]:null,this._buf=[],this._mode="text",this._error=null}var _proto=Scanner.prototype;return _proto.read=function read(){for(var token=this._read();8===token;)token=this._read();return 0!==token&&1!==token&&(this._last=this._index),token},_proto.buf=function buf(){return this._buf},_proto.last=function last(){return this._last},_proto.error=function error(){return this._error},_proto.debugPrint=function debugPrint(){for(var tokenStrings=["EOF","ERROR","TEXT","OPEN_BRACKET","CLOSE_BRACKET","EQUALS","STRING","IDENTIFIER","WHITESPACE"],token=this.read(),result="";result+=(result.length>0?"\n":"")+tokenStrings[token]+" '"+this.buf().join("")+"'",0!==token&&1!==token;)token=this.read();return result},_proto._read=function _read(){return this._buf=[],this._eof()?0:"text"===this._mode?this._text():this._tag()},_proto._text=function _text(){for(;;)switch(this._cur){case null:return this._buf.length>0?2:0;case"[":return this._mode="tag",this._buf.length>0?2:this._tag();case"\\":switch(this._next(),this._cur){case"[":this._store();break;default:this._output("\\")}break;default:this._store()}},_proto._tag=function _tag(){for(;;)switch(this._cur){case null:return this._error="unexpected end of input reading tag",1;case"[":return this._store(),3;case"]":return this._store(),this._mode="text",4;case"=":return this._store(),5;case" ":case"\t":case"\n":case"\r":case"\v":case"\f":return this._whitespace();case'"':return this._string();default:return this._isIdentifierSymbol(this._cur)?this._identifier():(this._error="unrecognized character",1)}},_proto._whitespace=function _whitespace(){for(this._store();-1!==" \t\n\r\v\f".indexOf(this._cur);)this._store();return 8},_proto._string=function _string(){for(this._next();;)switch(this._cur){case null:return this._error="unexpected end of input reading string",1;case'"':return this._next(),6;default:this._store()}},_proto._identifier=function _identifier(){for(this._store();null!==this._cur&&this._isIdentifierSymbol(this._cur);)this._store();return 7},_proto._isIdentifierSymbol=function _isIdentifierSymbol(s){return 1===s.length&&null!==s.match(IDENTIFIER_REGEX)},_proto._eof=function _eof(){return null===this._cur},_proto._next=function _next(){return this._eof()||(this._index++,this._cur=this._index<this._symbols.length?this._symbols[this._index]:null),this._cur},_proto._store=function _store(){return this._buf.push(this._cur),this._next()},_proto._output=function _output(c){this._buf.push(c)},Scanner}(),Parser=function(){function Parser(symbols){this._scanner=new Scanner(symbols),this._error=null}var _proto2=Parser.prototype;return _proto2.parse=function parse(symbols,tags){for(;;){var token;switch(this._scanner.read()){case 0:return!0;case 1:return!1;case 2:Array.prototype.push.apply(symbols,this._scanner.buf());break;case 3:if(!this._parseTag(symbols,tags))return!1;break;default:return!1}}},_proto2.error=function error(){return"Error evaluating markup at #"+this._scanner.last().toString()+" ("+(this._scanner.error()||this._error)+")"},_proto2._parseTag=function _parseTag(symbols,tags){var token=this._scanner.read();if(7!==token)return this._error="expected identifier",!1;var name=this._scanner.buf().join("");if("/"===name[0]){for(var index=tags.length-1;index>=0;--index)if(name==="/"+tags[index].name&&null===tags[index].end)return tags[index].end=symbols.length,4===(token=this._scanner.read())||(this._error="expected close bracket",!1);return this._error="failed to find matching tag",!1}var tag={name:name,value:null,attributes:{},start:symbols.length,end:null};if(5===(token=this._scanner.read())){if(6!==(token=this._scanner.read()))return this._error="expected string",!1;tag.value=this._scanner.buf().join(""),token=this._scanner.read()}for(;;){switch(token){case 4:return tags.push(tag),!0;case 7:var identifier=this._scanner.buf().join("");if(5!==(token=this._scanner.read()))return this._error="expected equals",!1;if(6!==(token=this._scanner.read()))return this._error="expected string",!1;var value=this._scanner.buf().join("");tag.attributes[identifier]=value;break;default:return this._error="expected close bracket or identifier",!1}token=this._scanner.read()}},Parser}();function merge(target,source){for(var key in source)if(source.hasOwnProperty(key)){var value=source[key];value instanceof Object?(target.hasOwnProperty(key)||(target[key]={}),merge(target[key],source[key])):target[key]=value}}function combineTags(tags){if(0===tags.length)return null;for(var result={},index=0;index<tags.length;++index){var tag=tags[index],tmp={};tmp[tag.name]={value:tag.value,attributes:tag.attributes},merge(result,tmp)}return result}function resolveMarkupTags(tags,numSymbols){var index;if(0===tags.length)return null;var edges={};for(index=0;index<tags.length;++index){var tag=tags[index];edges.hasOwnProperty(tag.start)?null===edges[tag.start].open?edges[tag.start].open=[tag]:edges[tag.start].open.push(tag):edges[tag.start]={open:[tag],close:null},edges.hasOwnProperty(tag.end)?null===edges[tag.end].close?edges[tag.end].close=[tag]:edges[tag.end].close.push(tag):edges[tag.end]={open:null,close:[tag]}}var tagStack=[];function removeTags(tags){tagStack=tagStack.filter((function(tag){return void 0===tags.find((function(t){return t===tag}))}))}function addTags(tags){for(var index=0;index<tags.length;++index)tagStack.push(tags[index])}var edgeKeys=Object.keys(edges).sort((function(a,b){return a-b})),resolvedTags=[];for(index=0;index<edgeKeys.length;++index){var edge=edges[edgeKeys[index]];null!==edge.close&&removeTags(edge.close),null!==edge.open&&addTags(edge.open),resolvedTags.push({start:edgeKeys[index],tags:combineTags(tagStack)})}var result=[],prevTag=null;for(index=0;index<resolvedTags.length;++index){for(var resolvedTag=resolvedTags[index];result.length<resolvedTag.start;)result.push(prevTag?prevTag.tags:null);prevTag=resolvedTag}for(;result.length<numSymbols;)result.push(null);return result}function evaluateMarkup(symbols){var parser=new Parser(symbols),stripped_symbols=[],tags=[];if(!parser.parse(stripped_symbols,tags))return console.warn(parser.error()),{symbols:symbols,tags:null};var invalidTag=tags.find((function(t){return null===t.end})),resolved_tags;return invalidTag?(console.warn("Markup error: found unclosed tag='"+invalidTag.name+"'"),{symbols:symbols,tags:null}):{symbols:stripped_symbols,tags:resolveMarkupTags(tags,stripped_symbols.length)}}var Markup=function(){function Markup(){}return Markup.evaluate=function evaluate(symbols){return evaluateMarkup(symbols)},Markup}(),MeshInfo=function MeshInfo(){this.count=0,this.quad=0,this.lines={},this.positions=[],this.normals=[],this.uvs=[],this.colors=[],this.indices=[],this.meshInstance=null},LINE_BREAK_CHAR=/^[\r\n]$/,WHITESPACE_CHAR=/^[ \t]$/,WORD_BOUNDARY_CHAR=/^[ \t\-]|[\u200b]$/,ALPHANUMERIC_CHAR=/^[a-z0-9]$/i,CJK_CHAR=/^[\u1100-\u11ff]|[\u3000-\u9fff]|[\ua960-\ua97f]|[\uac00-\ud7ff]$/,NO_LINE_BREAK_CJK_CHAR=/^[]$/,CONTROL_CHARS=["","","","","","","","","","","","",""],CONTROL_GLYPH_DATA={width:0,height:0,xadvance:0,xoffset:0,yoffset:0},TextElement=function(){function TextElement(element){this._element=element,this._system=element.system,this._entity=element.entity,this._text="",this._symbols=[],this._colorPalette=[],this._symbolColors=null,this._i18nKey=null,this._fontAsset=new LocalizedAsset(this._system.app),this._fontAsset.disableLocalization=!0,this._fontAsset.on("load",this._onFontLoad,this),this._fontAsset.on("change",this._onFontChange,this),this._fontAsset.on("remove",this._onFontRemove,this),this._font=null,this._color=new Color(1,1,1,1),this._colorUniform=new Float32Array(3),this._spacing=1,this._fontSize=32,this._fontMinY=0,this._fontMaxY=0,this._originalFontSize=32,this._maxFontSize=32,this._minFontSize=8,this._autoFitWidth=!1,this._autoFitHeight=!1,this._maxLines=-1,this._lineHeight=32,this._scaledLineHeight=32,this._wrapLines=!1,this._drawOrder=0,this._alignment=new Vec2(.5,.5),this._autoWidth=!0,this._autoHeight=!0,this.width=0,this.height=0,this._node=new GraphNode,this._model=new Model,this._model.graph=this._node,this._entity.addChild(this._node),this._meshInfo=[],this._material=null,this._aabbDirty=!0,this._aabb=new BoundingBox,this._noResize=!1,this._currentMaterialType=null,this._maskedMaterialSrc=null,this._rtlReorder=!1,this._unicodeConverter=!1,this._rtl=!1,this._outlineColor=new Color(0,0,0,1),this._outlineColorUniform=new Float32Array(4),this._outlineThicknessScale=.2,this._outlineThickness=0,this._shadowColor=new Color(0,0,0,1),this._shadowColorUniform=new Float32Array(4),this._shadowOffsetScale=.005,this._shadowOffset=new Vec2(0,0),this._shadowOffsetUniform=new Float32Array(2),this._enableMarkup=!1,this._onScreenChange(this._element.screen),element.on("resize",this._onParentResize,this),element.on("set:screen",this._onScreenChange,this),element.on("screen:set:screenspace",this._onScreenSpaceChange,this),element.on("set:draworder",this._onDrawOrderChange,this),element.on("set:pivot",this._onPivotChange,this),this._system.app.i18n.on("set:locale",this._onLocaleSet,this),this._system.app.i18n.on("data:add",this._onLocalizationData,this),this._system.app.i18n.on("data:remove",this._onLocalizationData,this),this._rangeStart=0,this._rangeEnd=0}var _proto=TextElement.prototype;return _proto.destroy=function destroy(){this._setMaterial(null),this._model&&(this._element.removeModelFromLayers(this._model),this._model.destroy(),this._model=null),this._fontAsset.destroy(),this.font=null,this._element.off("resize",this._onParentResize,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("set:pivot",this._onPivotChange,this),this._system.app.i18n.off("set:locale",this._onLocaleSet,this),this._system.app.i18n.off("data:add",this._onLocalizationData,this),this._system.app.i18n.off("data:remove",this._onLocalizationData,this)},_proto._onParentResize=function _onParentResize(width,height){this._noResize||this._font&&this._updateText()},_proto._onScreenChange=function _onScreenChange(screen){screen?this._updateMaterial(screen.screen.screenSpace):this._updateMaterial(!1)},_proto._onScreenSpaceChange=function _onScreenSpaceChange(value){this._updateMaterial(value)},_proto._onDrawOrderChange=function _onDrawOrderChange(order){var i,len;if(this._drawOrder=order,this._model)for(i=0,len=this._model.meshInstances.length;i<len;i++)this._model.meshInstances[i].drawOrder=order},_proto._onPivotChange=function _onPivotChange(pivot){this._font&&this._updateText()},_proto._onLocaleSet=function _onLocaleSet(locale){if(this._i18nKey){if(this.fontAsset){var asset=this._system.app.assets.get(this.fontAsset);asset&&asset.resource&&asset.resource===this._font||(this.font=null)}this._resetLocalizedText()}},_proto._onLocalizationData=function _onLocalizationData(locale,messages){this._i18nKey&&messages[this._i18nKey]&&this._resetLocalizedText()},_proto._resetLocalizedText=function _resetLocalizedText(){this._setText(this._system.app.i18n.getText(this._i18nKey))},_proto._setText=function _setText(text){if(this.unicodeConverter){var unicodeConverterFunc=this._system.getUnicodeConverter();unicodeConverterFunc?text=unicodeConverterFunc(text):console.warn("Element created with unicodeConverter option but no unicodeConverter function registered")}this._text!==text&&(this._font&&this._updateText(text),this._text=text)},_proto._updateText=function _updateText(text){var i,len,results,tags;if(void 0===text&&(text=this._text),this._symbols=string.getSymbols(text.normalize?text.normalize("NFC"):text),0===this._symbols.length&&(this._symbols=[" "]),this._enableMarkup&&(results=Markup.evaluate(this._symbols),this._symbols=results.symbols,tags=results.tags),this._rtlReorder){var rtlReorderFunc=this._system.app.systems.element.getRtlReorder();rtlReorderFunc?(results=rtlReorderFunc(this._symbols),this._rtl=results.rtl,this._symbols=results.mapping.map((function(v){return this._symbols[v]}),this),tags&&(tags=results.mapping.map((function(v){return tags[v]})))):console.warn("Element created with rtlReorder option but no rtlReorder function registered")}else this._rtl=!1;if(tags){var paletteMap={};for(this._colorPalette=[Math.round(255*this._color.r),Math.round(255*this._color.g),Math.round(255*this._color.b)],this._symbolColors=[],paletteMap[this._color.toString(!1).toLowerCase()]=0,i=0,len=this._symbols.length;i<len;++i){var tag=tags[i],color=0;if(tag&&tag.color&&tag.color.value){var c=tag.color.value;if(7===c.length&&"#"===c[0]){var hex=c.substring(1).toLowerCase();paletteMap.hasOwnProperty(hex)?color=paletteMap[hex]:/^([0-9a-f]{2}){3}$/.test(hex)&&(color=this._colorPalette.length/3,paletteMap[hex]=color,this._colorPalette.push(parseInt(hex.substring(0,2),16)),this._colorPalette.push(parseInt(hex.substring(2,4),16)),this._colorPalette.push(parseInt(hex.substring(4,6),16)))}}this._symbolColors.push(color)}}else this._colorPalette=[],this._symbolColors=null;var charactersPerTexture=this._calculateCharsPerTexture(),removedModel=!1,element=this._element,screenSpace=element._isScreenSpace(),screenCulled=element._isScreenCulled(),visibleFn=function visibleFn(camera){return element.isVisibleForCamera(camera)};for(i=0,len=this._meshInfo.length;i<len;i++){var l=charactersPerTexture[i]||0,meshInfo=this._meshInfo[i];if(meshInfo.count!==l){if(removedModel||(element.removeModelFromLayers(this._model),removedModel=!0),meshInfo.count=l,meshInfo.positions.length=meshInfo.normals.length=3*l*4,meshInfo.indices.length=3*l*2,meshInfo.uvs.length=2*l*4,meshInfo.colors.length=4*l*4,meshInfo.meshInstance&&this._removeMeshInstance(meshInfo.meshInstance),0===l){meshInfo.meshInstance=null;continue}for(var v=0;v<l;v++)meshInfo.indices[3*v*2+0]=4*v,meshInfo.indices[3*v*2+1]=4*v+1,meshInfo.indices[3*v*2+2]=4*v+3,meshInfo.indices[3*v*2+3]=4*v+2,meshInfo.indices[3*v*2+4]=4*v+3,meshInfo.indices[3*v*2+5]=4*v+1,meshInfo.normals[4*v*3+0]=0,meshInfo.normals[4*v*3+1]=0,meshInfo.normals[4*v*3+2]=-1,meshInfo.normals[4*v*3+3]=0,meshInfo.normals[4*v*3+4]=0,meshInfo.normals[4*v*3+5]=-1,meshInfo.normals[4*v*3+6]=0,meshInfo.normals[4*v*3+7]=0,meshInfo.normals[4*v*3+8]=-1,meshInfo.normals[4*v*3+9]=0,meshInfo.normals[4*v*3+10]=0,meshInfo.normals[4*v*3+11]=-1;var mesh=createMesh$1(this._system.app.graphicsDevice,meshInfo.positions,{uvs:meshInfo.uvs,normals:meshInfo.normals,colors:meshInfo.colors,indices:meshInfo.indices}),mi=new MeshInstance(mesh,this._material,this._node);mi.name="Text Element: "+this._entity.name,mi.castShadow=!1,mi.receiveShadow=!1,mi.cull=!screenSpace,mi.screenSpace=screenSpace,mi.drawOrder=this._drawOrder,screenCulled&&(mi.cull=!0,mi.isVisibleFunc=visibleFn),this._setTextureParams(mi,this._font.textures[i]),this._symbolColors?(this._colorUniform[0]=1,this._colorUniform[1]=1,this._colorUniform[2]=1):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b),mi.setParameter("material_emissive",this._colorUniform),mi.setParameter("material_opacity",this._color.a),mi.setParameter("font_sdfIntensity",this._font.intensity),mi.setParameter("font_pxrange",this._getPxRange(this._font)),mi.setParameter("font_textureWidth",this._font.data.info.maps[i].width),this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a,mi.setParameter("outline_color",this._outlineColorUniform),mi.setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness),this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a,mi.setParameter("shadow_color",this._shadowColorUniform);var ratio=this._font.data.info.maps[i].width/this._font.data.info.maps[i].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=ratio*this._shadowOffsetScale*this._shadowOffset.y,mi.setParameter("shadow_offset",this._shadowOffsetUniform),meshInfo.meshInstance=mi,this._model.meshInstances.push(mi)}}this._element.maskedBy&&this._element._setMaskedBy(this._element.maskedBy),removedModel&&this._element.enabled&&this._entity.enabled&&this._element.addModelToLayers(this._model),this._updateMeshes(),this._rangeStart=0,this._rangeEnd=this._symbols.length,this._updateRenderRange()},_proto._removeMeshInstance=function _removeMeshInstance(meshInstance){meshInstance.material=null;var oldMesh=meshInstance.mesh;oldMesh&&oldMesh.destroy();var idx=this._model.meshInstances.indexOf(meshInstance);-1!==idx&&this._model.meshInstances.splice(idx,1)},_proto._setMaterial=function _setMaterial(material){var i,len;if(this._material=material,this._model)for(i=0,len=this._model.meshInstances.length;i<len;i++){var mi;this._model.meshInstances[i].material=material}},_proto._updateMaterial=function _updateMaterial(screenSpace){var element=this._element,screenCulled=element._isScreenCulled(),visibleFn=function visibleFn(camera){return element.isVisibleForCamera(camera)},msdf=this._font&&"msdf"===this._font.type;if(this._material=this._system.getTextElementMaterial(screenSpace,msdf),this._model)for(var i=0,len=this._model.meshInstances.length;i<len;i++){var mi=this._model.meshInstances[i];mi.cull=!screenSpace,mi.material=this._material,mi.screenSpace=screenSpace,screenCulled?(mi.cull=!0,mi.isVisibleFunc=visibleFn):mi.isVisibleFunc=null}},_proto._isWordBoundary=function _isWordBoundary(char){return WORD_BOUNDARY_CHAR.test(char)},_proto._isValidNextChar=function _isValidNextChar(nextchar){return null!==nextchar&&!NO_LINE_BREAK_CJK_CHAR.test(nextchar)},_proto._isNextCJKBoundary=function _isNextCJKBoundary(char,nextchar){return CJK_CHAR.test(char)&&(WORD_BOUNDARY_CHAR.test(nextchar)||ALPHANUMERIC_CHAR.test(nextchar))},_proto._isNextCJKWholeWord=function _isNextCJKWholeWord(nextchar){return CJK_CHAR.test(nextchar)},_proto._updateMeshes=function _updateMeshes(){var json=this._font.data,self=this,minFont=Math.min(this._minFontSize,this._maxFontSize),maxFont=this._maxFontSize,autoFit=this._shouldAutoFit();autoFit&&(this._fontSize=this._maxFontSize);var MAGIC=32,l=this._symbols.length,_x=0,_y=0,_z=0,_xMinusTrailingWhitespace=0,lines=1,wordStartX=0,wordStartIndex=0,lineStartIndex=0,numWordsThisLine=0,numCharsThisLine=0,numBreaksThisLine=0,splitHorizontalAnchors=Math.abs(this._element.anchor.x-this._element.anchor.z)>=1e-4,maxLineWidth=this._element.calculatedWidth;(this.autoWidth&&!splitHorizontalAnchors||!this._wrapLines)&&(maxLineWidth=Number.POSITIVE_INFINITY);var fontMinY=0,fontMaxY=0,scale=1,char,data,i,j,quad,nextchar;function breakLine(symbols,lineBreakIndex,lineBreakX){self._lineWidths.push(Math.abs(lineBreakX));var sliceStart=lineStartIndex>lineBreakIndex?lineBreakIndex+1:lineStartIndex,sliceEnd=lineStartIndex>lineBreakIndex?lineStartIndex+1:lineBreakIndex,chars=symbols.slice(sliceStart,sliceEnd);if(numBreaksThisLine)for(var i=chars.length;i--&&numBreaksThisLine>0;)LINE_BREAK_CHAR.test(chars[i])&&(chars.splice(i,1),numBreaksThisLine--);self._lineContents.push(chars.join("")),_x=0,_y-=self._scaledLineHeight,lines++,numWordsThisLine=0,numCharsThisLine=0,numBreaksThisLine=0,wordStartX=0,lineStartIndex=lineBreakIndex}for(var retryUpdateMeshes=!0;retryUpdateMeshes;){for(retryUpdateMeshes=!1,this._scaledLineHeight=autoFit?this._lineHeight*this._fontSize/(this._maxFontSize||1e-4):this._lineHeight,this.width=0,this.height=0,this._lineWidths=[],this._lineContents=[],_x=0,_y=0,_z=0,_xMinusTrailingWhitespace=0,lines=1,wordStartX=0,wordStartIndex=0,lineStartIndex=0,numWordsThisLine=0,numCharsThisLine=0,numBreaksThisLine=0,scale=this._fontSize/32,fontMinY=this._fontMinY*scale,fontMaxY=this._fontMaxY*scale,i=0;i<this._meshInfo.length;i++)this._meshInfo[i].quad=0,this._meshInfo[i].lines={};var color_r=255,color_g=255,color_b=255;for(i=0;i<l;i++){var isLineBreak;if(char=this._symbols[i],nextchar=i+1>=l?null:this._symbols[i+1],LINE_BREAK_CHAR.test(char))numBreaksThisLine++,(this._maxLines<0||lines<this._maxLines)&&(breakLine(this._symbols,i,_xMinusTrailingWhitespace),wordStartIndex=i+1,lineStartIndex=i+1);else{var x=0,y=0,advance=0,quadsize=1,dataScale,size;if(!(data=json.chars[char]))if(-1!==CONTROL_CHARS.indexOf(char))data=CONTROL_GLYPH_DATA;else if(json.chars[" "])data=json.chars[" "];else for(var key in json.chars){data=json.chars[key];break}if(data){var kerning=0;if(numCharsThisLine>0){var kernTable=this._font.data.kerning;if(kernTable){var kernLeft=kernTable[string.getCodePoint(this._symbols[i-1])||0];kernLeft&&(kerning=kernLeft[string.getCodePoint(this._symbols[i])||0]||0)}}dataScale=data.scale||1,quadsize=scale*(size=(data.width+data.height)/2)/dataScale,advance=(data.xadvance+kerning)*scale,x=(data.xoffset-kerning)*scale,y=data.yoffset*scale}else console.error("Couldn't substitute missing character: '"+char+"'");var isWhitespace=WHITESPACE_CHAR.test(char),meshInfo=this._meshInfo[data&&data.map||0],candidateLineWidth=_x+this._spacing*advance;if(candidateLineWidth>maxLineWidth&&numCharsThisLine>0&&!isWhitespace&&(this._maxLines<0||lines<this._maxLines)){if(0!==numWordsThisLine){var backtrack=Math.max(i-wordStartIndex,0);if(this._meshInfo.length<=1)meshInfo.lines[lines-1]-=backtrack,meshInfo.quad-=backtrack;else{var backtrackStart,backtrackEnd=i;for(j=wordStartIndex;j<backtrackEnd;j++){var backChar=this._symbols[j],backCharData=json.chars[backChar],backMeshInfo=this._meshInfo[backCharData&&backCharData.map||0];backMeshInfo.lines[lines-1]-=1,backMeshInfo.quad-=1}}i-=backtrack+1,breakLine(this._symbols,wordStartIndex,wordStartX);continue}wordStartIndex=i,breakLine(this._symbols,i,_xMinusTrailingWhitespace)}quad=meshInfo.quad,meshInfo.lines[lines-1]=quad;var left=_x-x,right=left+quadsize,bottom=_y-y,top=bottom+quadsize,fontSize;if(this._rtl){var shift=quadsize-x-this._spacing*advance-x;left-=shift,right-=shift}if(meshInfo.positions[4*quad*3+0]=left,meshInfo.positions[4*quad*3+1]=bottom,meshInfo.positions[4*quad*3+2]=_z,meshInfo.positions[4*quad*3+3]=right,meshInfo.positions[4*quad*3+4]=bottom,meshInfo.positions[4*quad*3+5]=_z,meshInfo.positions[4*quad*3+6]=right,meshInfo.positions[4*quad*3+7]=top,meshInfo.positions[4*quad*3+8]=_z,meshInfo.positions[4*quad*3+9]=left,meshInfo.positions[4*quad*3+10]=top,meshInfo.positions[4*quad*3+11]=_z,this.width=Math.max(this.width,candidateLineWidth),this._shouldAutoFitWidth()&&this.width>this._element.calculatedWidth&&(fontSize=Math.floor(this._element.fontSize*this._element.calculatedWidth/(this.width||1e-4)),(fontSize=math.clamp(fontSize,minFont,maxFont))!==this._element.fontSize)){this._fontSize=fontSize,retryUpdateMeshes=!0;break}if(this.height=Math.max(this.height,fontMaxY-(_y+fontMinY)),this._shouldAutoFitHeight()&&this.height>this._element.calculatedHeight&&(fontSize=math.clamp(this._fontSize-1,minFont,maxFont))!==this._element.fontSize){this._fontSize=fontSize,retryUpdateMeshes=!0;break}_x+=this._spacing*advance,isWhitespace||(_xMinusTrailingWhitespace=_x),(this._isWordBoundary(char)||this._isValidNextChar(nextchar)&&(this._isNextCJKBoundary(char,nextchar)||this._isNextCJKWholeWord(nextchar)))&&(numWordsThisLine++,wordStartX=_xMinusTrailingWhitespace,wordStartIndex=i+1),numCharsThisLine++;var uv=this._getUv(char);if(meshInfo.uvs[4*quad*2+0]=uv[0],meshInfo.uvs[4*quad*2+1]=uv[1],meshInfo.uvs[4*quad*2+2]=uv[2],meshInfo.uvs[4*quad*2+3]=uv[1],meshInfo.uvs[4*quad*2+4]=uv[2],meshInfo.uvs[4*quad*2+5]=uv[3],meshInfo.uvs[4*quad*2+6]=uv[0],meshInfo.uvs[4*quad*2+7]=uv[3],this._symbolColors){var colorIdx=3*this._symbolColors[i];color_r=this._colorPalette[colorIdx],color_g=this._colorPalette[colorIdx+1],color_b=this._colorPalette[colorIdx+2]}meshInfo.colors[4*quad*4+0]=color_r,meshInfo.colors[4*quad*4+1]=color_g,meshInfo.colors[4*quad*4+2]=color_b,meshInfo.colors[4*quad*4+3]=255,meshInfo.colors[4*quad*4+4]=color_r,meshInfo.colors[4*quad*4+5]=color_g,meshInfo.colors[4*quad*4+6]=color_b,meshInfo.colors[4*quad*4+7]=255,meshInfo.colors[4*quad*4+8]=color_r,meshInfo.colors[4*quad*4+9]=color_g,meshInfo.colors[4*quad*4+10]=color_b,meshInfo.colors[4*quad*4+11]=255,meshInfo.colors[4*quad*4+12]=color_r,meshInfo.colors[4*quad*4+13]=color_g,meshInfo.colors[4*quad*4+14]=color_b,meshInfo.colors[4*quad*4+15]=255,meshInfo.quad++}}retryUpdateMeshes||lineStartIndex<l&&breakLine(this._symbols,l,_x)}this._noResize=!0,this.autoWidth=this._autoWidth,this.autoHeight=this._autoHeight,this._noResize=!1;var hp=this._element.pivot.x,vp=this._element.pivot.y,ha=this._alignment.x,va=this._alignment.y;for(i=0;i<this._meshInfo.length;i++)if(0!==this._meshInfo[i].count){var prevQuad=0;for(var line in this._meshInfo[i].lines){var index=this._meshInfo[i].lines[line],lw=this._lineWidths[parseInt(line,10)],hoffset=-hp*this._element.calculatedWidth+ha*(this._element.calculatedWidth-lw)*(this._rtl?-1:1),voffset=(1-vp)*this._element.calculatedHeight-fontMaxY-(1-va)*(this._element.calculatedHeight-this.height);for(quad=prevQuad;quad<=index;quad++)this._meshInfo[i].positions[4*quad*3]+=hoffset,this._meshInfo[i].positions[4*quad*3+3]+=hoffset,this._meshInfo[i].positions[4*quad*3+6]+=hoffset,this._meshInfo[i].positions[4*quad*3+9]+=hoffset,this._meshInfo[i].positions[4*quad*3+1]+=voffset,this._meshInfo[i].positions[4*quad*3+4]+=voffset,this._meshInfo[i].positions[4*quad*3+7]+=voffset,this._meshInfo[i].positions[4*quad*3+10]+=voffset;if(this._rtl)for(quad=prevQuad;quad<=index;quad++){for(var idx=4*quad*3,vert=0;vert<4;++vert)this._meshInfo[i].positions[idx+3*vert]=this._element.calculatedWidth-this._meshInfo[i].positions[idx+3*vert]+2*hoffset;var tmp0=this._meshInfo[i].positions[idx+3],tmp1=this._meshInfo[i].positions[idx+6];this._meshInfo[i].positions[idx+3]=this._meshInfo[i].positions[idx+0],this._meshInfo[i].positions[idx+6]=this._meshInfo[i].positions[idx+9],this._meshInfo[i].positions[idx+0]=tmp0,this._meshInfo[i].positions[idx+9]=tmp1}prevQuad=index+1}for(var numVertices=4*this._meshInfo[i].count,vertMax=4*this._meshInfo[i].quad,it=new VertexIterator(this._meshInfo[i].meshInstance.mesh.vertexBuffer),v=0;v<numVertices;v++)v>=vertMax?(it.element.POSITION.set(0,0,0),it.element.TEXCOORD0.set(0,0),it.element.COLOR.set(0,0,0,0)):(it.element.POSITION.set(this._meshInfo[i].positions[3*v+0],this._meshInfo[i].positions[3*v+1],this._meshInfo[i].positions[3*v+2]),it.element.TEXCOORD0.set(this._meshInfo[i].uvs[2*v+0],this._meshInfo[i].uvs[2*v+1]),it.element.COLOR.set(this._meshInfo[i].colors[4*v+0],this._meshInfo[i].colors[4*v+1],this._meshInfo[i].colors[4*v+2],this._meshInfo[i].colors[4*v+3])),it.next();it.end(),this._meshInfo[i].meshInstance.mesh.aabb.compute(this._meshInfo[i].positions),this._meshInfo[i].meshInstance._aabbVer=-1}this._aabbDirty=!0},_proto._onFontRender=function _onFontRender(){this.font=this._font},_proto._onFontLoad=function _onFontLoad(asset){this.font!==asset.resource&&(this.font=asset.resource)},_proto._onFontChange=function _onFontChange(asset,name,_new,_old){if("data"===name){this._font.data=_new;for(var maps=this._font.data.info.maps.length,i=0;i<maps;i++)if(this._meshInfo[i]){var mi=this._meshInfo[i].meshInstance;mi&&(mi.setParameter("font_sdfIntensity",this._font.intensity),mi.setParameter("font_pxrange",this._getPxRange(this._font)),mi.setParameter("font_textureWidth",this._font.data.info.maps[i].width))}}},_proto._onFontRemove=function _onFontRemove(asset){},_proto._setTextureParams=function _setTextureParams(mi,texture){this._font&&("msdf"===this._font.type?(mi.deleteParameter("texture_emissiveMap"),mi.deleteParameter("texture_opacityMap"),mi.setParameter("texture_msdfMap",texture)):"bitmap"===this._font.type&&(mi.deleteParameter("texture_msdfMap"),mi.setParameter("texture_emissiveMap",texture),mi.setParameter("texture_opacityMap",texture)))},_proto._getPxRange=function _getPxRange(font){for(var keys=Object.keys(this._font.data.chars),i=0;i<keys.length;i++){var char=this._font.data.chars[keys[i]];if(char.range)return(char.scale||1)*char.range}return 2},_proto._getUv=function _getUv(char){var data=this._font.data;if(!data.chars[char]){var space=" ";return data.chars[" "]?this._getUv(" "):[0,0,0,0]}var map=data.chars[char].map,width=data.info.maps[map].width,height=data.info.maps[map].height,x=data.chars[char].x,y=data.chars[char].y,x1=x,y1=y,x2=x+data.chars[char].width,y2=y-data.chars[char].height,edge=1-data.chars[char].height/height;return[x1/width,edge-y1/height,x2/width,edge-y2/height]},_proto.onEnable=function onEnable(){this._fontAsset.autoLoad=!0,this._model&&this._element.addModelToLayers(this._model)},_proto.onDisable=function onDisable(){this._fontAsset.autoLoad=!1,this._model&&this._element.removeModelFromLayers(this._model)},_proto._setStencil=function _setStencil(stencilParams){if(this._model)for(var instances=this._model.meshInstances,i=0;i<instances.length;i++)instances[i].stencilFront=stencilParams,instances[i].stencilBack=stencilParams},_proto._shouldAutoFitWidth=function _shouldAutoFitWidth(){return this._autoFitWidth&&!this._autoWidth},_proto._shouldAutoFitHeight=function _shouldAutoFitHeight(){return this._autoFitHeight&&!this._autoHeight},_proto._shouldAutoFit=function _shouldAutoFit(){return this._autoFitWidth&&!this._autoWidth||this._autoFitHeight&&!this._autoHeight},_proto._calculateCharsPerTexture=function _calculateCharsPerTexture(symbolIndex){var charactersPerTexture={},i,len,char,info,map;for(void 0===symbolIndex&&(symbolIndex=this._symbols.length),i=0,len=symbolIndex;i<len;i++)char=this._symbols[i],(info=this._font.data.chars[char])||(info=this._font.data.chars[" "])||(info=this._font.data.chars[Object.keys(this._font.data.chars)[0]]),charactersPerTexture[map=info.map]?charactersPerTexture[map]++:charactersPerTexture[map]=1;return charactersPerTexture},_proto._updateRenderRange=function _updateRenderRange(){var startChars=0===this._rangeStart?0:this._calculateCharsPerTexture(this._rangeStart),endChars=0===this._rangeEnd?0:this._calculateCharsPerTexture(this._rangeEnd),i,len;for(i=0,len=this._meshInfo.length;i<len;i++){var start=startChars[i]||0,end=endChars[i]||0,instance=this._meshInfo[i].meshInstance;if(instance){var mesh=instance.mesh;mesh&&(mesh.primitive[0].base=3*start*2,mesh.primitive[0].count=3*(end-start)*2)}}},_createClass(TextElement,[{key:"text",get:function get(){return this._text},set:function set(value){this._i18nKey=null;var str=null!=value&&value.toString()||"";this._setText(str)}},{key:"key",get:function get(){return this._i18nKey},set:function set(value){var str=null!==value?value.toString():null;this._i18nKey!==str&&(this._i18nKey=str,str?(this._fontAsset.disableLocalization=!1,this._resetLocalizedText()):this._fontAsset.disableLocalization=!0)}},{key:"color",get:function get(){return this._color},set:function set(value){var r=value.r,g=value.g,b=value.b;if(this._color.r!==r||this._color.g!==g||this._color.b!==b)if(this._color.r=r,this._color.g=g,this._color.b=b,this._symbolColors)this._font&&this._updateText();else{this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b;for(var i=0,len=this._model.meshInstances.length;i<len;i++){var mi;this._model.meshInstances[i].setParameter("material_emissive",this._colorUniform)}}}},{key:"opacity",get:function get(){return this._color.a},set:function set(value){if(this._color.a!==value&&(this._color.a=value,this._model))for(var i=0,len=this._model.meshInstances.length;i<len;i++){var mi;this._model.meshInstances[i].setParameter("material_opacity",value)}}},{key:"lineHeight",get:function get(){return this._lineHeight},set:function set(value){var _prev=this._lineHeight;this._lineHeight=value,this._scaledLineHeight=value,_prev!==value&&this._font&&this._updateText()}},{key:"wrapLines",get:function get(){return this._wrapLines},set:function set(value){var _prev=this._wrapLines;this._wrapLines=value,_prev!==value&&this._font&&this._updateText()}},{key:"lines",get:function get(){return this._lineContents}},{key:"spacing",get:function get(){return this._spacing},set:function set(value){var _prev=this._spacing;this._spacing=value,_prev!==value&&this._font&&this._updateText()}},{key:"fontSize",get:function get(){return this._fontSize},set:function set(value){var _prev=this._fontSize;this._fontSize=value,this._originalFontSize=value,_prev!==value&&this._font&&this._updateText()}},{key:"fontAsset",get:function get(){return this._fontAsset.localizedAsset},set:function set(value){this._fontAsset.defaultAsset=value}},{key:"font",get:function get(){return this._font},set:function set(value){var i,len,previousFontType;if(this._font&&(previousFontType=this._font.type,this._font.off&&this._font.off("render",this._onFontRender,this)),this._font=value,this._fontMinY=0,this._fontMaxY=0,value){var json=this._font.data,asset;for(var charId in json.chars){var data=json.chars[charId];data.bounds&&(this._fontMinY=Math.min(this._fontMinY,data.bounds[1]),this._fontMaxY=Math.max(this._fontMaxY,data.bounds[3]))}if(this._font.on&&this._font.on("render",this._onFontRender,this),this._fontAsset.localizedAsset)this._system.app.assets.get(this._fontAsset.localizedAsset).resource!==this._font&&(this._fontAsset.defaultAsset=null);if(value.type!==previousFontType){var screenSpace=this._element._isScreenSpace();this._updateMaterial(screenSpace)}for(i=0,len=this._font.textures.length;i<len;i++)if(this._meshInfo[i]){var mi=this._meshInfo[i].meshInstance;mi&&(mi.setParameter("font_sdfIntensity",this._font.intensity),mi.setParameter("font_pxrange",this._getPxRange(this._font)),mi.setParameter("font_textureWidth",this._font.data.info.maps[i].width),this._setTextureParams(mi,this._font.textures[i]))}else this._meshInfo[i]=new MeshInfo;var removedModel=!1;for(i=this._font.textures.length;i<this._meshInfo.length;i++)this._meshInfo[i].meshInstance&&(removedModel||(this._element.removeModelFromLayers(this._model),removedModel=!0),this._removeMeshInstance(this._meshInfo[i].meshInstance));this._meshInfo.length>this._font.textures.length&&(this._meshInfo.length=this._font.textures.length),this._updateText()}}},{key:"alignment",get:function get(){return this._alignment},set:function set(value){value instanceof Vec2?this._alignment.set(value.x,value.y):this._alignment.set(value[0],value[1]),this._font&&this._updateText()}},{key:"autoWidth",get:function get(){return this._autoWidth},set:function set(value){var old=this._autoWidth;if(this._autoWidth=value,value&&Math.abs(this._element.anchor.x-this._element.anchor.z)<1e-4&&(this._element.width=this.width),old!==value){var newFontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;newFontSize!==this._fontSize&&(this._fontSize=newFontSize,this._font&&this._updateText())}}},{key:"autoHeight",get:function get(){return this._autoHeight},set:function set(value){var old=this._autoHeight;if(this._autoHeight=value,value&&Math.abs(this._element.anchor.y-this._element.anchor.w)<1e-4&&(this._element.height=this.height),old!==value){var newFontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;newFontSize!==this._fontSize&&(this._fontSize=newFontSize,this._font&&this._updateText())}}},{key:"rtlReorder",get:function get(){return this._rtlReorder},set:function set(value){this._rtlReorder!==value&&(this._rtlReorder=value,this._font&&this._updateText())}},{key:"unicodeConverter",get:function get(){return this._unicodeConverter},set:function set(value){this._unicodeConverter!==value&&(this._unicodeConverter=value,this._setText(this._text))}},{key:"aabb",get:function get(){if(this._aabbDirty){for(var initialized=!1,i=0;i<this._meshInfo.length;i++)this._meshInfo[i].meshInstance&&(initialized?this._aabb.add(this._meshInfo[i].meshInstance.aabb):(this._aabb.copy(this._meshInfo[i].meshInstance.aabb),initialized=!0));this._aabbDirty=!1}return this._aabb}},{key:"outlineColor",get:function get(){return this._outlineColor},set:function set(value){var r=value instanceof Color?value.r:value[0],g=value instanceof Color?value.g:value[1],b=value instanceof Color?value.b:value[2],a=value instanceof Color?value.a:value[3];if((this._outlineColor.r!==r||this._outlineColor.g!==g||this._outlineColor.b!==b||this._outlineColor.a!==a)&&(this._outlineColor.r=r,this._outlineColor.g=g,this._outlineColor.b=b,this._outlineColor.a=a,this._model)){this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a;for(var i=0,len=this._model.meshInstances.length;i<len;i++){var mi;this._model.meshInstances[i].setParameter("outline_color",this._outlineColorUniform)}}}},{key:"outlineThickness",get:function get(){return this._outlineThickness},set:function set(value){var _prev=this._outlineThickness;if(this._outlineThickness=value,_prev!==value&&this._font&&this._model)for(var i=0,len=this._model.meshInstances.length;i<len;i++){var mi;this._model.meshInstances[i].setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness)}}},{key:"shadowColor",get:function get(){return this._shadowColor},set:function set(value){var r=value instanceof Color?value.r:value[0],g=value instanceof Color?value.g:value[1],b=value instanceof Color?value.b:value[2],a=value instanceof Color?value.a:value[3];if((this._shadowColor.r!==r||this._shadowColor.g!==g||this._shadowColor.b!==b||this._shadowColor.a!==a)&&(this._shadowColor.r=r,this._shadowColor.g=g,this._shadowColor.b=b,this._shadowColor.a=a,this._model)){this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a;for(var i=0,len=this._model.meshInstances.length;i<len;i++){var mi;this._model.meshInstances[i].setParameter("shadow_color",this._shadowColorUniform)}}}},{key:"shadowOffset",get:function get(){return this._shadowOffset},set:function set(value){var x=value instanceof Vec2?value.x:value[0],y=value instanceof Vec2?value.y:value[1];if((this._shadowOffset.x!==x||this._shadowOffset.y!==y)&&(this._shadowOffset.set(x,y),this._font&&this._model))for(var i=0,len=this._model.meshInstances.length;i<len;i++){var ratio=this._font.data.info.maps[i].width/this._font.data.info.maps[i].height,mi;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=ratio*this._shadowOffsetScale*this._shadowOffset.y,this._model.meshInstances[i].setParameter("shadow_offset",this._shadowOffsetUniform)}}},{key:"minFontSize",get:function get(){return this._minFontSize},set:function set(value){this._minFontSize!==value&&(this._minFontSize=value,this.font&&this._shouldAutoFit()&&this._updateText())}},{key:"maxFontSize",get:function get(){return this._maxFontSize},set:function set(value){this._maxFontSize!==value&&(this._maxFontSize=value,this.font&&this._shouldAutoFit()&&this._updateText())}},{key:"autoFitWidth",get:function get(){return this._autoFitWidth},set:function set(value){this._autoFitWidth!==value&&(this._autoFitWidth=value,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}},{key:"autoFitHeight",get:function get(){return this._autoFitHeight},set:function set(value){this._autoFitHeight!==value&&(this._autoFitHeight=value,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}},{key:"maxLines",get:function get(){return this._maxLines},set:function set(value){this._maxLines!==value&&(null===value&&-1===this._maxLines||(this._maxLines=null===value?-1:value,this.font&&this._wrapLines&&this._updateText()))}},{key:"enableMarkup",get:function get(){return this._enableMarkup},set:function set(value){value=!!value,this._enableMarkup!==value&&(this._enableMarkup=value,this.font&&this._updateText())}},{key:"symbols",get:function get(){return this._symbols}},{key:"symbolColors",get:function get(){return null===this._symbolColors?null:this._symbolColors.map((function(c){return this._colorPalette.slice(3*c,3*c+3)}),this)}},{key:"rtl",get:function get(){return this._rtl}},{key:"rangeStart",get:function get(){return this._rangeStart},set:function set(rangeStart){(rangeStart=Math.max(0,Math.min(rangeStart,this._symbols.length)))!==this._rangeStart&&(this._rangeStart=rangeStart,this._updateRenderRange())}},{key:"rangeEnd",get:function get(){return this._rangeEnd},set:function set(rangeEnd){(rangeEnd=Math.max(this._rangeStart,Math.min(rangeEnd,this._symbols.length)))!==this._rangeEnd&&(this._rangeEnd=rangeEnd,this._updateRenderRange())}}]),TextElement}(),position=new Vec3,invParentWtm=new Mat4,vecA$1=new Vec3,vecB$1=new Vec3,matA=new Mat4,matB=new Mat4,matC=new Mat4,matD=new Mat4,ElementComponent=function(_Component){function ElementComponent(system,entity){var _this;return(_this=_Component.call(this,system,entity)||this)._beingInitialized=!1,_this._anchor=new Vec4,_this._localAnchor=new Vec4,_this._pivot=new Vec2,_this._width=_this._calculatedWidth=32,_this._height=_this._calculatedHeight=32,_this._margin=new Vec4(0,0,-32,-32),_this._modelTransform=new Mat4,_this._screenToWorld=new Mat4,_this._anchorTransform=new Mat4,_this._anchorDirty=!0,_this._parentWorldTransform=new Mat4,_this._screenTransform=new Mat4,_this._screenCorners=[new Vec3,new Vec3,new Vec3,new Vec3],_this._canvasCorners=[new Vec2,new Vec2,new Vec2,new Vec2],_this._worldCorners=[new Vec3,new Vec3,new Vec3,new Vec3],_this._cornersDirty=!0,_this._canvasCornersDirty=!0,_this._worldCornersDirty=!0,_this.entity.on("insert",_this._onInsert,_assertThisInitialized(_this)),_this._patch(),_this.screen=null,_this._type="group",_this._image=null,_this._text=null,_this._group=null,_this._drawOrder=0,_this._useInput=!1,_this._layers=[4],_this._addedModels=[],_this._batchGroupId=-1,_this._offsetReadAt=0,_this._maskOffset=.5,_this._maskedBy=null,_this}_inheritsLoose(ElementComponent,_Component);var _proto=ElementComponent.prototype;return _proto._patch=function _patch(){this.entity._sync=this._sync,this.entity.setPosition=this._setPosition,this.entity.setLocalPosition=this._setLocalPosition},_proto._unpatch=function _unpatch(){this.entity._sync=Entity.prototype._sync,this.entity.setPosition=Entity.prototype.setPosition,this.entity.setLocalPosition=Entity.prototype.setLocalPosition},_proto._setPosition=function _setPosition(x,y,z){if(!this.element.screen)return Entity.prototype.setPosition.call(this,x,y,z);x instanceof Vec3?position.copy(x):position.set(x,y,z),this.getWorldTransform(),invParentWtm.copy(this.element._screenToWorld).invert(),invParentWtm.transformPoint(position,this.localPosition),this._dirtyLocal||this._dirtifyLocal()},_proto._setLocalPosition=function _setLocalPosition(x,y,z){x instanceof Vec3?this.localPosition.copy(x):this.localPosition.set(x,y,z);var element=this.element,p=this.localPosition,pvt=element._pivot;element._margin.x=p.x-element._calculatedWidth*pvt.x,element._margin.z=element._localAnchor.z-element._localAnchor.x-element._calculatedWidth-element._margin.x,element._margin.y=p.y-element._calculatedHeight*pvt.y,element._margin.w=element._localAnchor.w-element._localAnchor.y-element._calculatedHeight-element._margin.y,this._dirtyLocal||this._dirtifyLocal()},_proto._sync=function _sync(){var element=this.element,screen=element.screen;if(screen){if(element._anchorDirty){var resx=0,resy=0,px=0,py=1;if(this._parent&&this._parent.element)resx=this._parent.element.calculatedWidth,resy=this._parent.element.calculatedHeight,px=this._parent.element.pivot.x,py=this._parent.element.pivot.y;else{var resolution=screen.screen.resolution;resx=resolution.x/screen.screen.scale,resy=resolution.y/screen.screen.scale}element._anchorTransform.setTranslate(resx*(element.anchor.x-px),-resy*(py-element.anchor.y),0),element._anchorDirty=!1,element._calculateLocalAnchors()}element._sizeDirty&&element._calculateSize(!1,!1)}if(this._dirtyLocal){this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale);var p=this.localPosition,pvt=element._pivot;element._margin.x=p.x-element._calculatedWidth*pvt.x,element._margin.z=element._localAnchor.z-element._localAnchor.x-element._calculatedWidth-element._margin.x,element._margin.y=p.y-element._calculatedHeight*pvt.y,element._margin.w=element._localAnchor.w-element._localAnchor.y-element._calculatedHeight-element._margin.y,this._dirtyLocal=!1}if(!screen)return this._dirtyWorld&&(element._cornersDirty=!0,element._canvasCornersDirty=!0,element._worldCornersDirty=!0),Entity.prototype._sync.call(this);if(this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this._parent.element?element._screenToWorld.mul2(this._parent.element._modelTransform,element._anchorTransform):element._screenToWorld.copy(element._anchorTransform),element._modelTransform.mul2(element._screenToWorld,this.localTransform),screen){element._screenToWorld.mul2(screen.screen._screenMatrix,element._screenToWorld),screen.screen.screenSpace||element._screenToWorld.mul2(screen.worldTransform,element._screenToWorld),this.worldTransform.mul2(element._screenToWorld,this.localTransform);var parentWorldTransform=element._parentWorldTransform;parentWorldTransform.setIdentity();var parent=this._parent;parent&&parent.element&&parent!==screen&&(matA.setTRS(Vec3.ZERO,parent.getLocalRotation(),parent.getLocalScale()),parentWorldTransform.mul2(parent.element._parentWorldTransform,matA));var depthOffset=vecA$1;depthOffset.set(0,0,this.localPosition.z);var pivotOffset=vecB$1;pivotOffset.set(element._absLeft+element._pivot.x*element.calculatedWidth,element._absBottom+element._pivot.y*element.calculatedHeight,0),matA.setTranslate(-pivotOffset.x,-pivotOffset.y,-pivotOffset.z),matB.setTRS(depthOffset,this.getLocalRotation(),this.getLocalScale()),matC.setTranslate(pivotOffset.x,pivotOffset.y,pivotOffset.z),element._screenTransform.mul2(element._parentWorldTransform,matC).mul(matB).mul(matA),element._cornersDirty=!0,element._canvasCornersDirty=!0,element._worldCornersDirty=!0}else this.worldTransform.copy(element._modelTransform);this._dirtyWorld=!1}},_proto._onInsert=function _onInsert(parent){var result=this._parseUpToScreen();this.entity._dirtifyWorld(),this._updateScreen(result.screen),this._dirtifyMask()},_proto._dirtifyMask=function _dirtifyMask(){for(var current=this.entity;current;){var next=current.parent;if((null===next||next.screen)&&current.element){this.system._prerender&&this.system._prerender.length||(this.system._prerender=[],this.system.app.once("prerender",this._onPrerender,this));var i=this.system._prerender.indexOf(this.entity),j;i>=0&&this.system._prerender.splice(i,1),this.system._prerender.indexOf(current)<0&&this.system._prerender.push(current)}current=next}},_proto._onPrerender=function _onPrerender(){for(var i=0;i<this.system._prerender.length;i++){var mask=this.system._prerender[i];if(mask.element){var depth=1;mask.element.syncMask(1)}}this.system._prerender.length=0},_proto._bindScreen=function _bindScreen(screen){screen._bindElement(this)},_proto._unbindScreen=function _unbindScreen(screen){screen._unbindElement(this)},_proto._updateScreen=function _updateScreen(screen){this.screen&&this.screen!==screen&&this._unbindScreen(this.screen.screen);var previousScreen=this.screen;this.screen=screen,this.screen&&this._bindScreen(this.screen.screen),this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("set:screen",this.screen,previousScreen),this._anchorDirty=!0;for(var children=this.entity.children,i=0,l=children.length;i<l;i++)children[i].element&&children[i].element._updateScreen(screen);this.screen&&this.screen.screen.syncDrawOrder()},_proto.syncMask=function syncMask(depth){var result=this._parseUpToScreen();this._updateMask(result.mask,depth)},_proto._setMaskedBy=function _setMaskedBy(mask){var renderableElement=this._image||this._text;if(mask){var ref=mask.element._image._maskRef,sp=new StencilParameters({ref:ref,func:2});renderableElement&&renderableElement._setStencil&&renderableElement._setStencil(sp),this._maskedBy=mask}else renderableElement&&renderableElement._setStencil&&renderableElement._setStencil(null),this._maskedBy=null},_proto._updateMask=function _updateMask(currentMask,depth){var i,l,sp,children;if(currentMask){if(this._setMaskedBy(currentMask),this.mask){var ref=currentMask.element._image._maskRef;sp=new StencilParameters({ref:ref,func:2,zpass:3}),this._image._setStencil(sp),this._image._maskRef=depth,depth++,currentMask=this.entity}for(i=0,l=(children=this.entity.children).length;i<l;i++)children[i].element&&children[i].element._updateMask(currentMask,depth);this.mask&&depth--}else{for(this._setMaskedBy(null),this.mask&&(sp=new StencilParameters({ref:depth,func:7,zpass:2}),this._image._setStencil(sp),this._image._maskRef=depth,depth++,currentMask=this.entity),i=0,l=(children=this.entity.children).length;i<l;i++)children[i].element&&children[i].element._updateMask(currentMask,depth);this.mask&&depth--}},_proto._parseUpToScreen=function _parseUpToScreen(){for(var result={screen:null,mask:null},parent=this.entity._parent;parent&&!parent.screen;)parent.element&&parent.element.mask&&(result.mask||(result.mask=parent)),parent=parent.parent;return parent&&parent.screen&&(result.screen=parent),result},_proto._onScreenResize=function _onScreenResize(res){this._anchorDirty=!0,this._cornersDirty=!0,this._worldCornersDirty=!0,this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("screen:set:resolution",res)},_proto._onScreenSpaceChange=function _onScreenSpaceChange(){this.fire("screen:set:screenspace",this.screen.screen.screenSpace)},_proto._onScreenRemove=function _onScreenRemove(){this.screen&&(this.screen._destroying?this.screen=null:this._updateScreen(null))},_proto._calculateLocalAnchors=function _calculateLocalAnchors(){var resx=1e3,resy=1e3,parent=this.entity._parent;if(parent&&parent.element)resx=parent.element.calculatedWidth,resy=parent.element.calculatedHeight;else if(this.screen){var res=this.screen.screen.resolution,scale=this.screen.screen.scale;resx=res.x/scale,resy=res.y/scale}this._localAnchor.set(this._anchor.x*resx,this._anchor.y*resy,this._anchor.z*resx,this._anchor.w*resy)},_proto.getOffsetPosition=function getOffsetPosition(x,y){var p=this.entity.getLocalPosition().clone();return p.x+=x,p.y+=y,this._screenToWorld.transformPoint(p,p),p},_proto.onLayersChanged=function onLayersChanged(oldComp,newComp){this.addModelToLayers(this._image?this._image._renderable.model:this._text._model),oldComp.off("add",this.onLayerAdded,this),oldComp.off("remove",this.onLayerRemoved,this),newComp.on("add",this.onLayerAdded,this),newComp.on("remove",this.onLayerRemoved,this)},_proto.onLayerAdded=function onLayerAdded(layer){var index;this.layers.indexOf(layer.id)<0||(this._image?layer.addMeshInstances(this._image._renderable.model.meshInstances):this._text&&layer.addMeshInstances(this._text._model.meshInstances))},_proto.onLayerRemoved=function onLayerRemoved(layer){var index;this.layers.indexOf(layer.id)<0||(this._image?layer.removeMeshInstances(this._image._renderable.model.meshInstances):this._text&&layer.removeMeshInstances(this._text._model.meshInstances))},_proto.onEnable=function onEnable(){this._image&&this._image.onEnable(),this._text&&this._text.onEnable(),this._group&&this._group.onEnable(),this.useInput&&this.system.app.elementInput&&this.system.app.elementInput.addElement(this),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this._batchGroupId>=0&&this.system.app.batcher.insert(BatchGroup.ELEMENT,this.batchGroupId,this.entity),this.fire("enableelement")},_proto.onDisable=function onDisable(){this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this._image&&this._image.onDisable(),this._text&&this._text.onDisable(),this._group&&this._group.onDisable(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this._batchGroupId>=0&&this.system.app.batcher.remove(BatchGroup.ELEMENT,this.batchGroupId,this.entity),this.fire("disableelement")},_proto.onRemove=function onRemove(){this.entity.off("insert",this._onInsert,this),this._unpatch(),this._image&&this._image.destroy(),this._text&&this._text.destroy(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this.screen&&this.screen.screen&&(this._unbindScreen(this.screen.screen),this.screen.screen.syncDrawOrder()),this.off()},_proto._calculateSize=function _calculateSize(propagateCalculatedWidth,propagateCalculatedHeight){if(this.entity._parent||this.screen){this._calculateLocalAnchors();var newWidth=this._absRight-this._absLeft,newHeight=this._absTop-this._absBottom;propagateCalculatedWidth?this._setWidth(newWidth):this._setCalculatedWidth(newWidth,!1),propagateCalculatedHeight?this._setHeight(newHeight):this._setCalculatedHeight(newHeight,!1);var p=this.entity.getLocalPosition();p.x=this._margin.x+this._calculatedWidth*this._pivot.x,p.y=this._margin.y+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(p),this._sizeDirty=!1}},_proto._setWidth=function _setWidth(w){this._width=w,this._setCalculatedWidth(w,!1),this.fire("set:width",this._width)},_proto._setHeight=function _setHeight(h){this._height=h,this._setCalculatedHeight(h,!1),this.fire("set:height",this._height)},_proto._setCalculatedWidth=function _setCalculatedWidth(value,updateMargins){if(!(Math.abs(value-this._calculatedWidth)<=1e-4)){if(this._calculatedWidth=value,this.entity._dirtifyLocal(),updateMargins){var p=this.entity.getLocalPosition(),pvt=this._pivot;this._margin.x=p.x-this._calculatedWidth*pvt.x,this._margin.z=this._localAnchor.z-this._localAnchor.x-this._calculatedWidth-this._margin.x}this._flagChildrenAsDirty(),this.fire("set:calculatedWidth",this._calculatedWidth),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}},_proto._setCalculatedHeight=function _setCalculatedHeight(value,updateMargins){if(!(Math.abs(value-this._calculatedHeight)<=1e-4)){if(this._calculatedHeight=value,this.entity._dirtifyLocal(),updateMargins){var p=this.entity.getLocalPosition(),pvt=this._pivot;this._margin.y=p.y-this._calculatedHeight*pvt.y,this._margin.w=this._localAnchor.w-this._localAnchor.y-this._calculatedHeight-this._margin.y}this._flagChildrenAsDirty(),this.fire("set:calculatedHeight",this._calculatedHeight),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}},_proto._flagChildrenAsDirty=function _flagChildrenAsDirty(){var i,l,c=this.entity._children;for(i=0,l=c.length;i<l;i++)c[i].element&&(c[i].element._anchorDirty=!0,c[i].element._sizeDirty=!0)},_proto.addModelToLayers=function addModelToLayers(model){var layer;this._addedModels.push(model);for(var i=0;i<this.layers.length;i++)(layer=this.system.app.scene.layers.getLayerById(this.layers[i]))&&layer.addMeshInstances(model.meshInstances)},_proto.removeModelFromLayers=function removeModelFromLayers(model){var layer,idx=this._addedModels.indexOf(model);idx>=0&&this._addedModels.splice(idx,1);for(var i=0;i<this.layers.length;i++)(layer=this.system.app.scene.layers.getLayerById(this.layers[i]))&&layer.removeMeshInstances(model.meshInstances)},_proto.getMaskOffset=function getMaskOffset(){var frame=this.system.app.frame;this._offsetReadAt!==frame&&(this._maskOffset=.5,this._offsetReadAt=frame);var mo=this._maskOffset;return this._maskOffset-=.001,mo},_proto.isVisibleForCamera=function isVisibleForCamera(camera){var clipL,clipR,clipT,clipB;if(this.maskedBy){var corners=this.maskedBy.element.screenCorners;clipL=Math.min(Math.min(corners[0].x,corners[1].x),Math.min(corners[2].x,corners[3].x)),clipR=Math.max(Math.max(corners[0].x,corners[1].x),Math.max(corners[2].x,corners[3].x)),clipB=Math.min(Math.min(corners[0].y,corners[1].y),Math.min(corners[2].y,corners[3].y)),clipT=Math.max(Math.max(corners[0].y,corners[1].y),Math.max(corners[2].y,corners[3].y))}else{var sw=this.system.app.graphicsDevice.width,sh=this.system.app.graphicsDevice.height,cameraWidth=camera._rect.z*sw,cameraHeight=camera._rect.w*sh;clipR=(clipL=camera._rect.x*sw)+cameraWidth,clipB=(clipT=(1-camera._rect.y)*sh)-cameraHeight}var hitCorners=this.screenCorners,left=Math.min(Math.min(hitCorners[0].x,hitCorners[1].x),Math.min(hitCorners[2].x,hitCorners[3].x)),right=Math.max(Math.max(hitCorners[0].x,hitCorners[1].x),Math.max(hitCorners[2].x,hitCorners[3].x)),bottom=Math.min(Math.min(hitCorners[0].y,hitCorners[1].y),Math.min(hitCorners[2].y,hitCorners[3].y)),top=Math.max(Math.max(hitCorners[0].y,hitCorners[1].y),Math.max(hitCorners[2].y,hitCorners[3].y));return!(right<clipL||left>clipR||bottom>clipT||top<clipB)},_proto._isScreenSpace=function _isScreenSpace(){return!(!this.screen||!this.screen.screen)&&this.screen.screen.screenSpace},_proto._isScreenCulled=function _isScreenCulled(){return!(!this.screen||!this.screen.screen)&&this.screen.screen.cull},ElementComponent}(Component);Object.defineProperty(ElementComponent.prototype,"type",{get:function get(){return this._type},set:function set(value){value!==this._type&&(this._type=value,this._image&&(this._image.destroy(),this._image=null),this._text&&(this._text.destroy(),this._text=null),"image"===value?this._image=new ImageElement(this):"text"===value&&(this._text=new TextElement(this)))}}),Object.defineProperty(ElementComponent.prototype,"layers",{get:function get(){return this._layers},set:function set(value){var i,j,layer;if(this._addedModels.length)for(i=0;i<this._layers.length;i++)if(layer=this.system.app.scene.layers.getLayerById(this._layers[i]))for(j=0;j<this._addedModels.length;j++)layer.removeMeshInstances(this._addedModels[j].meshInstances);if(this._layers=value,this.enabled&&this.entity.enabled&&this._addedModels.length)for(i=0;i<this._layers.length;i++)if(layer=this.system.app.scene.layers.getLayerById(this._layers[i]))for(j=0;j<this._addedModels.length;j++)layer.addMeshInstances(this._addedModels[j].meshInstances)}}),Object.defineProperty(ElementComponent.prototype,"drawOrder",{get:function get(){return this._drawOrder},set:function set(value){var priority=0;this.screen&&(priority=this.screen.screen.priority),value>16777215&&(value=16777215),this._drawOrder=(priority<<24)+value,this.fire("set:draworder",this._drawOrder)}}),Object.defineProperty(ElementComponent.prototype,"_absLeft",{get:function get(){return this._localAnchor.x+this._margin.x}}),Object.defineProperty(ElementComponent.prototype,"_absRight",{get:function get(){return this._localAnchor.z-this._margin.z}}),Object.defineProperty(ElementComponent.prototype,"_absTop",{get:function get(){return this._localAnchor.w-this._margin.w}}),Object.defineProperty(ElementComponent.prototype,"_absBottom",{get:function get(){return this._localAnchor.y+this._margin.y}}),Object.defineProperty(ElementComponent.prototype,"margin",{get:function get(){return this._margin},set:function set(value){this._margin.copy(value),this._calculateSize(!0,!0),this.fire("set:margin",this._margin)}}),Object.defineProperty(ElementComponent.prototype,"left",{get:function get(){return this._margin.x},set:function set(value){this._margin.x=value;var p=this.entity.getLocalPosition(),wr=this._absRight,wl=this._localAnchor.x+value;this._setWidth(wr-wl),p.x=value+this._calculatedWidth*this._pivot.x,this.entity.setLocalPosition(p)}}),Object.defineProperty(ElementComponent.prototype,"right",{get:function get(){return this._margin.z},set:function set(value){this._margin.z=value;var p=this.entity.getLocalPosition(),wl=this._absLeft,wr=this._localAnchor.z-value;this._setWidth(wr-wl),p.x=this._localAnchor.z-this._localAnchor.x-value-this._calculatedWidth*(1-this._pivot.x),this.entity.setLocalPosition(p)}}),Object.defineProperty(ElementComponent.prototype,"top",{get:function get(){return this._margin.w},set:function set(value){this._margin.w=value;var p=this.entity.getLocalPosition(),wb=this._absBottom,wt=this._localAnchor.w-value;this._setHeight(wt-wb),p.y=this._localAnchor.w-this._localAnchor.y-value-this._calculatedHeight*(1-this._pivot.y),this.entity.setLocalPosition(p)}}),Object.defineProperty(ElementComponent.prototype,"bottom",{get:function get(){return this._margin.y},set:function set(value){this._margin.y=value;var p=this.entity.getLocalPosition(),wt=this._absTop,wb=this._localAnchor.y+value;this._setHeight(wt-wb),p.y=value+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(p)}}),Object.defineProperty(ElementComponent.prototype,"width",{get:function get(){return this._width},set:function set(value){this._width=value,this._hasSplitAnchorsX||this._setCalculatedWidth(value,!0),this.fire("set:width",this._width)}}),Object.defineProperty(ElementComponent.prototype,"height",{get:function get(){return this._height},set:function set(value){this._height=value,this._hasSplitAnchorsY||this._setCalculatedHeight(value,!0),this.fire("set:height",this._height)}}),Object.defineProperty(ElementComponent.prototype,"calculatedWidth",{get:function get(){return this._calculatedWidth},set:function set(value){this._setCalculatedWidth(value,!0)}}),Object.defineProperty(ElementComponent.prototype,"calculatedHeight",{get:function get(){return this._calculatedHeight},set:function set(value){this._setCalculatedHeight(value,!0)}}),Object.defineProperty(ElementComponent.prototype,"pivot",{get:function get(){return this._pivot},set:function set(value){var prevX=this._pivot.x,prevY=this._pivot.y;value instanceof Vec2?this._pivot.set(value.x,value.y):this._pivot.set(value[0],value[1]);var mx=this._margin.x+this._margin.z,dx=this._pivot.x-prevX;this._margin.x+=mx*dx,this._margin.z-=mx*dx;var my=this._margin.y+this._margin.w,dy=this._pivot.y-prevY;this._margin.y+=my*dy,this._margin.w-=my*dy,this._anchorDirty=!0,this._cornersDirty=!0,this._worldCornersDirty=!0,this._calculateSize(!1,!1),this._flagChildrenAsDirty(),this.fire("set:pivot",this._pivot)}}),Object.defineProperty(ElementComponent.prototype,"anchor",{get:function get(){return this._anchor},set:function set(value){value instanceof Vec4?this._anchor.set(value.x,value.y,value.z,value.w):this._anchor.set(value[0],value[1],value[2],value[3]),this.entity._parent||this.screen?this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY):this._calculateLocalAnchors(),this._anchorDirty=!0,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:anchor",this._anchor)}}),Object.defineProperty(ElementComponent.prototype,"_hasSplitAnchorsX",{get:function get(){return Math.abs(this._anchor.x-this._anchor.z)>.001}}),Object.defineProperty(ElementComponent.prototype,"_hasSplitAnchorsY",{get:function get(){return Math.abs(this._anchor.y-this._anchor.w)>.001}}),Object.defineProperty(ElementComponent.prototype,"aabb",{get:function get(){return this._image?this._image.aabb:this._text?this._text.aabb:null}}),Object.defineProperty(ElementComponent.prototype,"screenCorners",{get:function get(){if(!this._cornersDirty||!this.screen)return this._screenCorners;var parentBottomLeft=this.entity.parent&&this.entity.parent.element&&this.entity.parent.element.screenCorners[0];this._screenCorners[0].set(this._absLeft,this._absBottom,0),this._screenCorners[1].set(this._absRight,this._absBottom,0),this._screenCorners[2].set(this._absRight,this._absTop,0),this._screenCorners[3].set(this._absLeft,this._absTop,0);for(var screenSpace=this.screen.screen.screenSpace,i=0;i<4;i++)this._screenTransform.transformPoint(this._screenCorners[i],this._screenCorners[i]),screenSpace&&this._screenCorners[i].mulScalar(this.screen.screen.scale),parentBottomLeft&&this._screenCorners[i].add(parentBottomLeft);return this._cornersDirty=!1,this._canvasCornersDirty=!0,this._worldCornersDirty=!0,this._screenCorners}}),Object.defineProperty(ElementComponent.prototype,"canvasCorners",{get:function get(){if(!this._canvasCornersDirty||!this.screen||!this.screen.screen.screenSpace)return this._canvasCorners;for(var device=this.system.app.graphicsDevice,screenCorners=this.screenCorners,sx=device.canvas.clientWidth/device.width,sy=device.canvas.clientHeight/device.height,i=0;i<4;i++)this._canvasCorners[i].set(screenCorners[i].x*sx,(device.height-screenCorners[i].y)*sy);return this._canvasCornersDirty=!1,this._canvasCorners}}),Object.defineProperty(ElementComponent.prototype,"worldCorners",{get:function get(){if(!this._worldCornersDirty)return this._worldCorners;if(this.screen){var screenCorners=this.screenCorners;if(!this.screen.screen.screenSpace){matA.copy(this.screen.screen._screenMatrix),matA.data[13]=-matA.data[13],matA.mul2(this.screen.getWorldTransform(),matA);for(var i=0;i<4;i++)matA.transformPoint(screenCorners[i],this._worldCorners[i])}}else{var localPos=this.entity.getLocalPosition();matA.setTranslate(-localPos.x,-localPos.y,-localPos.z),matB.setTRS(Vec3.ZERO,this.entity.getLocalRotation(),this.entity.getLocalScale()),matC.setTranslate(localPos.x,localPos.y,localPos.z);var entity=this.entity.parent?this.entity.parent:this.entity;matD.copy(entity.getWorldTransform()),matD.mul(matC).mul(matB).mul(matA),vecA$1.set(localPos.x-this.pivot.x*this.calculatedWidth,localPos.y-this.pivot.y*this.calculatedHeight,localPos.z),matD.transformPoint(vecA$1,this._worldCorners[0]),vecA$1.set(localPos.x+(1-this.pivot.x)*this.calculatedWidth,localPos.y-this.pivot.y*this.calculatedHeight,localPos.z),matD.transformPoint(vecA$1,this._worldCorners[1]),vecA$1.set(localPos.x+(1-this.pivot.x)*this.calculatedWidth,localPos.y+(1-this.pivot.y)*this.calculatedHeight,localPos.z),matD.transformPoint(vecA$1,this._worldCorners[2]),vecA$1.set(localPos.x-this.pivot.x*this.calculatedWidth,localPos.y+(1-this.pivot.y)*this.calculatedHeight,localPos.z),matD.transformPoint(vecA$1,this._worldCorners[3])}return this._worldCornersDirty=!1,this._worldCorners}}),Object.defineProperty(ElementComponent.prototype,"textWidth",{get:function get(){return this._text?this._text.width:0}}),Object.defineProperty(ElementComponent.prototype,"textHeight",{get:function get(){return this._text?this._text.height:0}}),Object.defineProperty(ElementComponent.prototype,"useInput",{get:function get(){return this._useInput},set:function set(value){this._useInput!==value&&(this._useInput=value,this.system.app.elementInput?value?this.enabled&&this.entity.enabled&&this.system.app.elementInput.addElement(this):this.system.app.elementInput.removeElement(this):!0===this._useInput&&console.warn("Elements will not get any input events because this.system.app.elementInput is not created"),this.fire("set:useInput",value))}}),Object.defineProperty(ElementComponent.prototype,"batchGroupId",{get:function get(){return this._batchGroupId},set:function set(value){this._batchGroupId!==value&&(this.entity.enabled&&this._batchGroupId>=0&&this.system.app.batcher.remove(BatchGroup.ELEMENT,this.batchGroupId,this.entity),this.entity.enabled&&value>=0&&this.system.app.batcher.insert(BatchGroup.ELEMENT,value,this.entity),value<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&(this._image&&this._image._renderable.model?this.addModelToLayers(this._image._renderable.model):this._text&&this._text._model&&this.addModelToLayers(this._text._model)),this._batchGroupId=value)}}),Object.defineProperty(ElementComponent.prototype,"maskedBy",{get:function get(){return this._maskedBy}});var _define=function _define(name){Object.defineProperty(ElementComponent.prototype,name,{get:function get(){return this._text?this._text[name]:this._image?this._image[name]:null},set:function set(value){this._text?this._text[name]=value:this._image&&(this._image[name]=value)}})};_define("fontSize"),_define("minFontSize"),_define("maxFontSize"),_define("maxLines"),_define("autoFitWidth"),_define("autoFitHeight"),_define("color"),_define("font"),_define("fontAsset"),_define("spacing"),_define("lineHeight"),_define("wrapLines"),_define("lines"),_define("alignment"),_define("autoWidth"),_define("autoHeight"),_define("rtlReorder"),_define("unicodeConverter"),_define("text"),_define("key"),_define("texture"),_define("textureAsset"),_define("material"),_define("materialAsset"),_define("sprite"),_define("spriteAsset"),_define("spriteFrame"),_define("pixelsPerUnit"),_define("opacity"),_define("rect"),_define("mask"),_define("outlineColor"),_define("outlineThickness"),_define("shadowColor"),_define("shadowOffset"),_define("enableMarkup"),_define("rangeStart"),_define("rangeEnd");var ElementComponentData=function ElementComponentData(){this.enabled=!0},_schema$e=["enabled"],ElementComponentSystem=function(_ComponentSystem){function ElementComponentSystem(app){var _this;(_this=_ComponentSystem.call(this,app)||this).id="element",_this.ComponentType=ElementComponent,_this.DataType=ElementComponentData,_this.schema=_schema$e,_this._unicodeConverter=null,_this._rtlReorder=null,_this._defaultTexture=new Texture(app.graphicsDevice,{width:1,height:1,format:7}),_this._defaultTexture.name="element-system";var pixels=_this._defaultTexture.lock(),pixelData=new Uint8Array(4);return pixelData[0]=255,pixelData[1]=255,pixelData[2]=255,pixelData[3]=255,pixels.set(pixelData),_this._defaultTexture.unlock(),_this.defaultImageMaterial=null,_this.defaultImage9SlicedMaterial=null,_this.defaultImage9TiledMaterial=null,_this.defaultImageMaskMaterial=null,_this.defaultImage9SlicedMaskMaterial=null,_this.defaultImage9TiledMaskMaterial=null,_this.defaultScreenSpaceImageMaterial=null,_this.defaultScreenSpaceImage9SlicedMaterial=null,_this.defaultScreenSpaceImage9TiledMaterial=null,_this.defaultScreenSpaceImageMask9SlicedMaterial=null,_this.defaultScreenSpaceImageMask9TiledMaterial=null,_this.defaultScreenSpaceImageMaskMaterial=null,_this.defaultTextMaterial=null,_this.defaultBitmapTextMaterial=null,_this.defaultScreenSpaceTextMaterial=null,_this.defaultScreenSpaceBitmapTextMaterial=null,_this.defaultImageMaterials=[],_this.on("beforeremove",_this.onRemoveComponent,_assertThisInitialized(_this)),_this}_inheritsLoose(ElementComponentSystem,_ComponentSystem);var _proto=ElementComponentSystem.prototype;return _proto.destroy=function destroy(){this._defaultTexture.destroy()},_proto.initializeComponentData=function initializeComponentData(component,data,properties){component._beingInitialized=!0,void 0!==data.anchor&&(data.anchor instanceof Vec4?component.anchor.copy(data.anchor):component.anchor.set(data.anchor[0],data.anchor[1],data.anchor[2],data.anchor[3])),void 0!==data.pivot&&(data.pivot instanceof Vec2?component.pivot.copy(data.pivot):component.pivot.set(data.pivot[0],data.pivot[1]));var splitHorAnchors=Math.abs(component.anchor.x-component.anchor.z)>.001,splitVerAnchors=Math.abs(component.anchor.y-component.anchor.w)>.001,_marginChange=!1,color;void 0!==data.margin&&(data.margin instanceof Vec4?component.margin.copy(data.margin):component._margin.set(data.margin[0],data.margin[1],data.margin[2],data.margin[3]),_marginChange=!0),void 0!==data.left&&(component._margin.x=data.left,_marginChange=!0),void 0!==data.bottom&&(component._margin.y=data.bottom,_marginChange=!0),void 0!==data.right&&(component._margin.z=data.right,_marginChange=!0),void 0!==data.top&&(component._margin.w=data.top,_marginChange=!0),_marginChange&&(component.margin=component._margin);var shouldForceSetAnchor=!1;void 0===data.width||splitHorAnchors?splitHorAnchors&&(shouldForceSetAnchor=!0):component.width=data.width,void 0===data.height||splitVerAnchors?splitVerAnchors&&(shouldForceSetAnchor=!0):component.height=data.height,shouldForceSetAnchor&&(component.anchor=component.anchor),void 0!==data.enabled&&(component.enabled=data.enabled),void 0!==data.useInput&&(component.useInput=data.useInput),component.batchGroupId=void 0===data.batchGroupId||null===data.batchGroupId?-1:data.batchGroupId,data.layers&&Array.isArray(data.layers)&&(component.layers=data.layers.slice(0)),void 0!==data.type&&(component.type=data.type),"image"===component.type?(void 0!==data.rect&&(component.rect=data.rect),void 0!==data.color&&((color=data.color)instanceof Color||(color=new Color(data.color[0],data.color[1],data.color[2])),component.color=color),void 0!==data.opacity&&(component.opacity=data.opacity),void 0!==data.textureAsset&&(component.textureAsset=data.textureAsset),data.texture&&(component.texture=data.texture),void 0!==data.spriteAsset&&(component.spriteAsset=data.spriteAsset),data.sprite&&(component.sprite=data.sprite),void 0!==data.spriteFrame&&(component.spriteFrame=data.spriteFrame),void 0!==data.pixelsPerUnit&&null!==data.pixelsPerUnit&&(component.pixelsPerUnit=data.pixelsPerUnit),void 0!==data.materialAsset&&(component.materialAsset=data.materialAsset),data.material&&(component.material=data.material),void 0!==data.mask&&(component.mask=data.mask)):"text"===component.type&&(void 0!==data.autoWidth&&(component.autoWidth=data.autoWidth),void 0!==data.autoHeight&&(component.autoHeight=data.autoHeight),void 0!==data.rtlReorder&&(component.rtlReorder=data.rtlReorder),void 0!==data.unicodeConverter&&(component.unicodeConverter=data.unicodeConverter),null!==data.text&&void 0!==data.text?component.text=data.text:null!==data.key&&void 0!==data.key&&(component.key=data.key),void 0!==data.color&&((color=data.color)instanceof Color||(color=new Color(color[0],color[1],color[2])),component.color=color),void 0!==data.opacity&&(component.opacity=data.opacity),void 0!==data.spacing&&(component.spacing=data.spacing),void 0!==data.fontSize&&(component.fontSize=data.fontSize,data.lineHeight||(component.lineHeight=data.fontSize)),void 0!==data.lineHeight&&(component.lineHeight=data.lineHeight),void 0!==data.maxLines&&(component.maxLines=data.maxLines),void 0!==data.wrapLines&&(component.wrapLines=data.wrapLines),void 0!==data.minFontSize&&(component.minFontSize=data.minFontSize),void 0!==data.maxFontSize&&(component.maxFontSize=data.maxFontSize),data.autoFitWidth&&(component.autoFitWidth=data.autoFitWidth),data.autoFitHeight&&(component.autoFitHeight=data.autoFitHeight),void 0!==data.fontAsset&&(component.fontAsset=data.fontAsset),void 0!==data.font&&(component.font=data.font),void 0!==data.alignment&&(component.alignment=data.alignment),void 0!==data.outlineColor&&(component.outlineColor=data.outlineColor),void 0!==data.outlineThickness&&(component.outlineThickness=data.outlineThickness),void 0!==data.shadowColor&&(component.shadowColor=data.shadowColor),void 0!==data.shadowOffset&&(component.shadowOffset=data.shadowOffset),void 0!==data.enableMarkup&&(component.enableMarkup=data.enableMarkup));var result=component._parseUpToScreen();result.screen&&component._updateScreen(result.screen),_ComponentSystem.prototype.initializeComponentData.call(this,component,data,properties),component._beingInitialized=!1,"image"===component.type&&component._image._meshDirty&&component._image._updateMesh(component._image.mesh)},_proto.onRemoveComponent=function onRemoveComponent(entity,component){component.onRemove()},_proto.cloneComponent=function cloneComponent(entity,clone){var source=entity.element,data={enabled:source.enabled,width:source.width,height:source.height,anchor:source.anchor.clone(),pivot:source.pivot.clone(),margin:source.margin.clone(),alignment:source.alignment&&source.alignment.clone()||source.alignment,autoWidth:source.autoWidth,autoHeight:source.autoHeight,type:source.type,rect:source.rect&&source.rect.clone()||source.rect,rtlReorder:source.rtlReorder,unicodeConverter:source.unicodeConverter,materialAsset:source.materialAsset,material:source.material,color:source.color&&source.color.clone()||source.color,opacity:source.opacity,textureAsset:source.textureAsset,texture:source.texture,spriteAsset:source.spriteAsset,sprite:source.sprite,spriteFrame:source.spriteFrame,pixelsPerUnit:source.pixelsPerUnit,spacing:source.spacing,lineHeight:source.lineHeight,wrapLines:source.wrapLines,layers:source.layers,fontSize:source.fontSize,minFontSize:source.minFontSize,maxFontSize:source.maxFontSize,autoFitWidth:source.autoFitWidth,autoFitHeight:source.autoFitHeight,maxLines:source.maxLines,fontAsset:source.fontAsset,font:source.font,useInput:source.useInput,batchGroupId:source.batchGroupId,mask:source.mask,outlineColor:source.outlineColor&&source.outlineColor.clone()||source.outlineColor,outlineThickness:source.outlineThickness,shadowColor:source.shadowColor&&source.shadowColor.clone()||source.shadowColor,shadowOffset:source.shadowOffset&&source.shadowOffset.clone()||source.shadowOffset,enableMarkup:source.enableMarkup};return void 0!==source.key&&null!==source.key?data.key=source.key:data.text=source.text,this.addComponent(clone,data)},_proto.getTextElementMaterial=function getTextElementMaterial(screenSpace,msdf){return screenSpace?msdf?(this.defaultScreenSpaceTextMaterial||(this.defaultScreenSpaceTextMaterial=new StandardMaterial,this.defaultScreenSpaceTextMaterial.name="defaultScreenSpaceTextMaterial",this.defaultScreenSpaceTextMaterial.msdfMap=this._defaultTexture,this.defaultScreenSpaceTextMaterial.useLighting=!1,this.defaultScreenSpaceTextMaterial.useGammaTonemap=!1,this.defaultScreenSpaceTextMaterial.useFog=!1,this.defaultScreenSpaceTextMaterial.useSkybox=!1,this.defaultScreenSpaceTextMaterial.diffuse.set(0,0,0),this.defaultScreenSpaceTextMaterial.emissive.set(1,1,1),this.defaultScreenSpaceTextMaterial.opacity=.5,this.defaultScreenSpaceTextMaterial.blendType=4,this.defaultScreenSpaceTextMaterial.depthWrite=!1,this.defaultScreenSpaceTextMaterial.depthTest=!1,this.defaultScreenSpaceTextMaterial.emissiveVertexColor=!0,this.defaultScreenSpaceTextMaterial.update()),this.defaultScreenSpaceTextMaterial):(this.defaultScreenSpaceBitmapTextMaterial||(this.defaultScreenSpaceBitmapTextMaterial=new StandardMaterial,this.defaultScreenSpaceBitmapTextMaterial.name="defaultScreenSpaceBitmapTextMaterial",this.defaultScreenSpaceBitmapTextMaterial.emissive.set(.5,.5,.5),this.defaultScreenSpaceBitmapTextMaterial.emissiveMap=this._defaultTexture,this.defaultScreenSpaceBitmapTextMaterial.emissiveTint=!0,this.defaultScreenSpaceBitmapTextMaterial.opacity=.5,this.defaultScreenSpaceBitmapTextMaterial.opacityMap=this._defaultTexture,this.defaultScreenSpaceBitmapTextMaterial.opacityMapChannel="a",this.defaultScreenSpaceBitmapTextMaterial.useLighting=!1,this.defaultScreenSpaceBitmapTextMaterial.useGammaTonemap=!1,this.defaultScreenSpaceBitmapTextMaterial.useFog=!1,this.defaultScreenSpaceBitmapTextMaterial.useSkybox=!1,this.defaultScreenSpaceBitmapTextMaterial.diffuse.set(0,0,0),this.defaultScreenSpaceBitmapTextMaterial.blendType=4,this.defaultScreenSpaceBitmapTextMaterial.depthWrite=!1,this.defaultScreenSpaceBitmapTextMaterial.depthTest=!1,this.defaultScreenSpaceBitmapTextMaterial.emissiveVertexColor=!0,this.defaultScreenSpaceBitmapTextMaterial.update()),this.defaultScreenSpaceBitmapTextMaterial):msdf?(this.defaultTextMaterial||(this.defaultTextMaterial=new StandardMaterial,this.defaultTextMaterial.name="defaultTextMaterial",this.defaultTextMaterial.msdfMap=this._defaultTexture,this.defaultTextMaterial.useLighting=!1,this.defaultTextMaterial.useGammaTonemap=!1,this.defaultTextMaterial.useFog=!1,this.defaultTextMaterial.useSkybox=!1,this.defaultTextMaterial.diffuse.set(0,0,0),this.defaultTextMaterial.emissive.set(1,1,1),this.defaultTextMaterial.opacity=.5,this.defaultTextMaterial.blendType=4,this.defaultTextMaterial.depthWrite=!1,this.defaultTextMaterial.emissiveVertexColor=!0,this.defaultTextMaterial.update()),this.defaultTextMaterial):(this.defaultBitmapTextMaterial||(this.defaultBitmapTextMaterial=new StandardMaterial,this.defaultBitmapTextMaterial.name="defaultBitmapTextMaterial",this.defaultBitmapTextMaterial.emissive.set(.5,.5,.5),this.defaultBitmapTextMaterial.emissiveTint=!0,this.defaultBitmapTextMaterial.emissiveMap=this._defaultTexture,this.defaultBitmapTextMaterial.opacity=.5,this.defaultBitmapTextMaterial.opacityMap=this._defaultTexture,this.defaultBitmapTextMaterial.opacityMapChannel="a",this.defaultBitmapTextMaterial.useLighting=!1,this.defaultBitmapTextMaterial.useGammaTonemap=!1,this.defaultBitmapTextMaterial.useFog=!1,this.defaultBitmapTextMaterial.useSkybox=!1,this.defaultBitmapTextMaterial.diffuse.set(0,0,0),this.defaultBitmapTextMaterial.blendType=4,this.defaultBitmapTextMaterial.depthWrite=!1,this.defaultBitmapTextMaterial.emissiveVertexColor=!0,this.defaultBitmapTextMaterial.update()),this.defaultBitmapTextMaterial)},_proto._createBaseImageMaterial=function _createBaseImageMaterial(){var material=new StandardMaterial;return material.diffuse.set(0,0,0),material.emissive.set(.5,.5,.5),material.emissiveMap=this._defaultTexture,material.emissiveTint=!0,material.opacityMap=this._defaultTexture,material.opacityMapChannel="a",material.opacityTint=!0,material.opacity=0,material.useLighting=!1,material.useGammaTonemap=!1,material.useFog=!1,material.useSkybox=!1,material.blendType=4,material.depthWrite=!1,material},_proto.getImageElementMaterial=function getImageElementMaterial(screenSpace,mask,nineSliced,nineSliceTiled){return screenSpace?mask?nineSliced?(this.defaultScreenSpaceImageMask9SlicedMaterial||(this.defaultScreenSpaceImageMask9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMask9SlicedMaterial.name="defaultScreenSpaceImageMask9SlicedMaterial",this.defaultScreenSpaceImageMask9SlicedMaterial.nineSlicedMode=1,this.defaultScreenSpaceImageMask9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9SlicedMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9SlicedMaterial)),this.defaultScreenSpaceImageMask9SlicedMaterial):nineSliceTiled?(this.defaultScreenSpaceImageMask9TiledMaterial||(this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImage9TiledMaterial.clone(),this.defaultScreenSpaceImageMask9TiledMaterial.name="defaultScreenSpaceImageMask9TiledMaterial",this.defaultScreenSpaceImageMask9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImageMask9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9TiledMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9TiledMaterial)),this.defaultScreenSpaceImageMask9TiledMaterial):(this.defaultScreenSpaceImageMaskMaterial||(this.defaultScreenSpaceImageMaskMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaskMaterial.name="defaultScreenSpaceImageMaskMaterial",this.defaultScreenSpaceImageMaskMaterial.depthTest=!1,this.defaultScreenSpaceImageMaskMaterial.alphaTest=1,this.defaultScreenSpaceImageMaskMaterial.redWrite=!1,this.defaultScreenSpaceImageMaskMaterial.greenWrite=!1,this.defaultScreenSpaceImageMaskMaterial.blueWrite=!1,this.defaultScreenSpaceImageMaskMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaskMaterial)),this.defaultScreenSpaceImageMaskMaterial):nineSliced?(this.defaultScreenSpaceImage9SlicedMaterial||(this.defaultScreenSpaceImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9SlicedMaterial.name="defaultScreenSpaceImage9SlicedMaterial",this.defaultScreenSpaceImage9SlicedMaterial.nineSlicedMode=1,this.defaultScreenSpaceImage9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9SlicedMaterial)),this.defaultScreenSpaceImage9SlicedMaterial):nineSliceTiled?(this.defaultScreenSpaceImage9TiledMaterial||(this.defaultScreenSpaceImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9TiledMaterial.name="defaultScreenSpaceImage9TiledMaterial",this.defaultScreenSpaceImage9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImage9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9TiledMaterial)),this.defaultScreenSpaceImage9TiledMaterial):(this.defaultScreenSpaceImageMaterial||(this.defaultScreenSpaceImageMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaterial.name="defaultScreenSpaceImageMaterial",this.defaultScreenSpaceImageMaterial.depthTest=!1,this.defaultScreenSpaceImageMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaterial)),this.defaultScreenSpaceImageMaterial):mask?nineSliced?(this.defaultImage9SlicedMaskMaterial||(this.defaultImage9SlicedMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaskMaterial.name="defaultImage9SlicedMaskMaterial",this.defaultImage9SlicedMaskMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaskMaterial.alphaTest=1,this.defaultImage9SlicedMaskMaterial.redWrite=!1,this.defaultImage9SlicedMaskMaterial.greenWrite=!1,this.defaultImage9SlicedMaskMaterial.blueWrite=!1,this.defaultImage9SlicedMaskMaterial.alphaWrite=!1,this.defaultImage9SlicedMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaskMaterial)),this.defaultImage9SlicedMaskMaterial):nineSliceTiled?(this.defaultImage9TiledMaskMaterial||(this.defaultImage9TiledMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaskMaterial.name="defaultImage9TiledMaskMaterial",this.defaultImage9TiledMaskMaterial.nineSlicedMode=2,this.defaultImage9TiledMaskMaterial.alphaTest=1,this.defaultImage9TiledMaskMaterial.redWrite=!1,this.defaultImage9TiledMaskMaterial.greenWrite=!1,this.defaultImage9TiledMaskMaterial.blueWrite=!1,this.defaultImage9TiledMaskMaterial.alphaWrite=!1,this.defaultImage9TiledMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaskMaterial)),this.defaultImage9TiledMaskMaterial):(this.defaultImageMaskMaterial||(this.defaultImageMaskMaterial=this._createBaseImageMaterial(),this.defaultImageMaskMaterial.name="defaultImageMaskMaterial",this.defaultImageMaskMaterial.alphaTest=1,this.defaultImageMaskMaterial.redWrite=!1,this.defaultImageMaskMaterial.greenWrite=!1,this.defaultImageMaskMaterial.blueWrite=!1,this.defaultImageMaskMaterial.alphaWrite=!1,this.defaultImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaskMaterial)),this.defaultImageMaskMaterial):nineSliced?(this.defaultImage9SlicedMaterial||(this.defaultImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaterial.name="defaultImage9SlicedMaterial",this.defaultImage9SlicedMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaterial)),this.defaultImage9SlicedMaterial):nineSliceTiled?(this.defaultImage9TiledMaterial||(this.defaultImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaterial.name="defaultImage9TiledMaterial",this.defaultImage9TiledMaterial.nineSlicedMode=2,this.defaultImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaterial)),this.defaultImage9TiledMaterial):(this.defaultImageMaterial||(this.defaultImageMaterial=this._createBaseImageMaterial(),this.defaultImageMaterial.name="defaultImageMaterial",this.defaultImageMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaterial)),this.defaultImageMaterial)},_proto.registerUnicodeConverter=function registerUnicodeConverter(func){this._unicodeConverter=func},_proto.registerRtlReorder=function registerRtlReorder(func){this._rtlReorder=func},_proto.getUnicodeConverter=function getUnicodeConverter(){return this._unicodeConverter},_proto.getRtlReorder=function getRtlReorder(){return this._rtlReorder},ElementComponentSystem}(ComponentSystem);Component._buildAccessors(ElementComponent.prototype,_schema$e);var MOTION_FREE="free",MOTION_LIMITED="limited",MOTION_LOCKED="locked",properties=["angularDampingX","angularDampingY","angularDampingZ","angularEquilibriumX","angularEquilibriumY","angularEquilibriumZ","angularLimitsX","angularLimitsY","angularLimitsZ","angularMotionX","angularMotionY","angularMotionZ","angularSpringX","angularSpringY","angularSpringZ","angularStiffnessX","angularStiffnessY","angularStiffnessZ","breakForce","enableCollision","enabled","entityA","entityB","linearDampingX","linearDampingY","linearDampingZ","linearEquilibriumX","linearEquilibriumY","linearEquilibriumZ","linearLimitsX","linearLimitsY","linearLimitsZ","linearMotionX","linearMotionY","linearMotionZ","linearSpringX","linearSpringY","linearSpringZ","linearStiffnessX","linearStiffnessY","linearStiffnessZ"],JointComponent=function(_Component){function JointComponent(system,entity){var _this;return(_this=_Component.call(this,system,entity)||this)._constraint=null,_this._entityA=null,_this._entityB=null,_this._breakForce=34e37,_this._enableCollision=!0,_this._linearMotionX="locked",_this._linearLimitsX=new Vec2(0,0),_this._linearSpringX=!1,_this._linearStiffnessX=0,_this._linearDampingX=1,_this._linearEquilibriumX=0,_this._linearMotionY="locked",_this._linearLimitsY=new Vec2(0,0),_this._linearSpringY=!1,_this._linearStiffnessY=0,_this._linearDampingY=1,_this._linearEquilibriumY=0,_this._linearMotionZ="locked",_this._linearLimitsZ=new Vec2(0,0),_this._linearSpringZ=!1,_this._linearStiffnessZ=0,_this._linearDampingZ=1,_this._linearEquilibriumZ=0,_this._angularMotionX="locked",_this._angularLimitsX=new Vec2(0,0),_this._angularSpringX=!1,_this._angularStiffnessX=0,_this._angularDampingX=1,_this._angularEquilibriumX=0,_this._angularMotionY="locked",_this._angularLimitsY=new Vec2(0,0),_this._angularSpringY=!1,_this._angularStiffnessY=0,_this._angularDampingY=1,_this._angularEquilibriumY=0,_this._angularMotionZ="locked",_this._angularLimitsZ=new Vec2(0,0),_this._angularSpringZ=!1,_this._angularEquilibriumZ=0,_this._angularDampingZ=1,_this._angularStiffnessZ=0,_this.on("set_enabled",_this._onSetEnabled,_assertThisInitialized(_this)),_this}_inheritsLoose(JointComponent,_Component);var _proto=JointComponent.prototype;return _proto._convertTransform=function _convertTransform(pcTransform,ammoTransform){var pos=pcTransform.getTranslation(),rot=new Quat;rot.setFromMat4(pcTransform);var ammoVec=new Ammo.btVector3(pos.x,pos.y,pos.z),ammoQuat=new Ammo.btQuaternion(rot.x,rot.y,rot.z,rot.w);ammoTransform.setOrigin(ammoVec),ammoTransform.setRotation(ammoQuat),Ammo.destroy(ammoVec),Ammo.destroy(ammoQuat)},_proto._updateAngularLimits=function _updateAngularLimits(){var constraint=this._constraint;if(constraint){var lx,ly,lz,ux,uy,uz;"limited"===this._angularMotionX?(lx=this._angularLimitsX.x*math.DEG_TO_RAD,ux=this._angularLimitsX.y*math.DEG_TO_RAD):"free"===this._angularMotionX?(lx=1,ux=0):lx=ux=0,"limited"===this._angularMotionY?(ly=this._angularLimitsY.x*math.DEG_TO_RAD,uy=this._angularLimitsY.y*math.DEG_TO_RAD):"free"===this._angularMotionY?(ly=1,uy=0):ly=uy=0,"limited"===this._angularMotionZ?(lz=this._angularLimitsZ.x*math.DEG_TO_RAD,uz=this._angularLimitsZ.y*math.DEG_TO_RAD):"free"===this._angularMotionZ?(lz=1,uz=0):lz=uz=0;var limits=new Ammo.btVector3(lx,ly,lz);constraint.setAngularLowerLimit(limits),limits.setValue(ux,uy,uz),constraint.setAngularUpperLimit(limits),Ammo.destroy(limits)}},_proto._updateLinearLimits=function _updateLinearLimits(){var constraint=this._constraint;if(constraint){var lx,ly,lz,ux,uy,uz;"limited"===this._linearMotionX?(lx=this._linearLimitsX.x,ux=this._linearLimitsX.y):"free"===this._linearMotionX?(lx=1,ux=0):lx=ux=0,"limited"===this._linearMotionY?(ly=this._linearLimitsY.x,uy=this._linearLimitsY.y):"free"===this._linearMotionY?(ly=1,uy=0):ly=uy=0,"limited"===this._linearMotionZ?(lz=this._linearLimitsZ.x,uz=this._linearLimitsZ.y):"free"===this._linearMotionZ?(lz=1,uz=0):lz=uz=0;var limits=new Ammo.btVector3(lx,ly,lz);constraint.setLinearLowerLimit(limits),limits.setValue(ux,uy,uz),constraint.setLinearUpperLimit(limits),Ammo.destroy(limits)}},_proto._createConstraint=function _createConstraint(){if(this._entityA&&this._entityA.rigidbody){this._destroyConstraint();var mat=new Mat4,bodyA=this._entityA.rigidbody.body;bodyA.activate();var jointWtm=this.entity.getWorldTransform(),entityAWtm,invEntityAWtm=this._entityA.getWorldTransform().clone().invert();mat.mul2(invEntityAWtm,jointWtm);var frameA=new Ammo.btTransform,app,dynamicsWorld;if(this._convertTransform(mat,frameA),this._entityB&&this._entityB.rigidbody){var bodyB=this._entityB.rigidbody.body;bodyB.activate();var entityBWtm,invEntityBWtm=this._entityB.getWorldTransform().clone().invert();mat.mul2(invEntityBWtm,jointWtm);var frameB=new Ammo.btTransform;this._convertTransform(mat,frameB),this._constraint=new Ammo.btGeneric6DofSpringConstraint(bodyA,bodyB,frameA,frameB,!this._enableCollision),Ammo.destroy(frameB)}else this._constraint=new Ammo.btGeneric6DofSpringConstraint(bodyA,frameA,!this._enableCollision);Ammo.destroy(frameA);for(var axis=["X","Y","Z","X","Y","Z"],i=0;i<6;i++){var type=i<3?"_linear":"_angular";this._constraint.enableSpring(i,this[type+"Spring"+axis[i]]),this._constraint.setDamping(i,this[type+"Damping"+axis[i]]),this._constraint.setEquilibriumPoint(i,this[type+"Equilibrium"+axis[i]]),this._constraint.setStiffness(i,this[type+"Stiffness"+axis[i]])}this._constraint.setBreakingImpulseThreshold(this._breakForce),this._updateLinearLimits(),this._updateAngularLimits(),this.system.app.systems.rigidbody.dynamicsWorld.addConstraint(this._constraint,!this._enableCollision)}},_proto._destroyConstraint=function _destroyConstraint(){var app,dynamicsWorld;this._constraint&&(this.system.app.systems.rigidbody.dynamicsWorld.removeConstraint(this._constraint),Ammo.destroy(this._constraint),this._constraint=null)},_proto.initFromData=function initFromData(data){for(var _iterator=_createForOfIteratorHelperLoose(properties),_step;!(_step=_iterator()).done;){var prop=_step.value;data.hasOwnProperty(prop)&&(data[prop]instanceof Vec2?this["_"+prop].copy(data[prop]):this["_"+prop]=data[prop])}this._createConstraint()},_proto.onEnable=function onEnable(){this._createConstraint()},_proto.onDisable=function onDisable(){this._destroyConstraint()},_proto._onSetEnabled=function _onSetEnabled(prop,old,value){},_proto._onBeforeRemove=function _onBeforeRemove(){this.fire("remove")},_createClass(JointComponent,[{key:"entityA",get:function get(){return this._entityA},set:function set(body){this._destroyConstraint(),this._entityA=body,this._createConstraint()}},{key:"entityB",get:function get(){return this._entityB},set:function set(body){this._destroyConstraint(),this._entityB=body,this._createConstraint()}},{key:"breakForce",get:function get(){return this._breakForce},set:function set(force){this._constraint&&this._breakForce!==force&&(this._constraint.setBreakingImpulseThreshold(force),this._breakForce=force)}},{key:"enableCollision",get:function get(){return this._enableCollision},set:function set(enableCollision){this._destroyConstraint(),this._enableCollision=enableCollision,this._createConstraint()}},{key:"angularLimitsX",get:function get(){return this._angularLimitsX},set:function set(limits){this._angularLimitsX.equals(limits)||(this._angularLimitsX.copy(limits),this._updateAngularLimits())}},{key:"angularMotionX",get:function get(){return this._angularMotionX},set:function set(value){this._angularMotionX!==value&&(this._angularMotionX=value,this._updateAngularLimits())}},{key:"angularLimitsY",get:function get(){return this._angularLimitsY},set:function set(limits){this._angularLimitsY.equals(limits)||(this._angularLimitsY.copy(limits),this._updateAngularLimits())}},{key:"angularMotionY",get:function get(){return this._angularMotionY},set:function set(value){this._angularMotionY!==value&&(this._angularMotionY=value,this._updateAngularLimits())}},{key:"angularLimitsZ",get:function get(){return this._angularLimitsZ},set:function set(limits){this._angularLimitsZ.equals(limits)||(this._angularLimitsZ.copy(limits),this._updateAngularLimits())}},{key:"angularMotionZ",get:function get(){return this._angularMotionZ},set:function set(value){this._angularMotionZ!==value&&(this._angularMotionZ=value,this._updateAngularLimits())}},{key:"linearLimitsX",get:function get(){return this._linearLimitsX},set:function set(limits){this._linearLimitsX.equals(limits)||(this._linearLimitsX.copy(limits),this._updateLinearLimits())}},{key:"linearMotionX",get:function get(){return this._linearMotionX},set:function set(value){this._linearMotionX!==value&&(this._linearMotionX=value,this._updateLinearLimits())}},{key:"linearLimitsY",get:function get(){return this._linearLimitsY},set:function set(limits){this._linearLimitsY.equals(limits)||(this._linearLimitsY.copy(limits),this._updateLinearLimits())}},{key:"linearMotionY",get:function get(){return this._linearMotionY},set:function set(value){this._linearMotionY!==value&&(this._linearMotionY=value,this._updateLinearLimits())}},{key:"linearLimitsZ",get:function get(){return this._linearLimitsZ},set:function set(limits){this._linearLimitsZ.equals(limits)||(this._linearLimitsZ.copy(limits),this._updateLinearLimits())}},{key:"linearMotionZ",get:function get(){return this._linearMotionZ},set:function set(value){this._linearMotionZ!==value&&(this._linearMotionZ=value,this._updateLinearLimits())}}]),JointComponent}(Component),functionMap={Damping:"setDamping",Equilibrium:"setEquilibriumPoint",Spring:"enableSpring",Stiffness:"setStiffness"};["linear","angular"].forEach((function(type){["Damping","Equilibrium","Spring","Stiffness"].forEach((function(name){["X","Y","Z"].forEach((function(axis){var prop=type+name+axis,propInternal="_"+prop,index="linear"===type?0:3;"Y"===axis&&(index+=1),"Z"===axis&&(index+=2),Object.defineProperty(JointComponent.prototype,prop,{get:function get(){return this[propInternal]},set:function set(value){this[propInternal]!==value&&(this[propInternal]=value,this._constraint[functionMap[name]](index,value))}})}))}))}));var JointComponentData=function JointComponentData(){this.enabled=!0},_schema$d=["enabled"],JointComponentSystem=function(_ComponentSystem){function JointComponentSystem(app){var _this;return(_this=_ComponentSystem.call(this,app)||this).id="joint",_this.app=app,_this.ComponentType=JointComponent,_this.DataType=JointComponentData,_this.schema=_schema$d,_this}var _proto;return _inheritsLoose(JointComponentSystem,_ComponentSystem),JointComponentSystem.prototype.initializeComponentData=function initializeComponentData(component,data,properties){component.initFromData(data)},JointComponentSystem}(ComponentSystem);Component._buildAccessors(JointComponent.prototype,_schema$d);var LayoutChildComponent=function(_Component){function LayoutChildComponent(system,entity){var _this;return(_this=_Component.call(this,system,entity)||this)._minWidth=0,_this._minHeight=0,_this._maxWidth=null,_this._maxHeight=null,_this._fitWidthProportion=0,_this._fitHeightProportion=0,_this._excludeFromLayout=!1,_this}return _inheritsLoose(LayoutChildComponent,_Component),LayoutChildComponent}(Component);function defineResizeProperty(name){var _name="_"+name;Object.defineProperty(LayoutChildComponent.prototype,name,{get:function get(){return this[_name]},set:function set(value){this[_name]!==value&&(this[_name]=value,this.fire("resize"))}})}defineResizeProperty("minWidth"),defineResizeProperty("minHeight"),defineResizeProperty("maxWidth"),defineResizeProperty("maxHeight"),defineResizeProperty("fitWidthProportion"),defineResizeProperty("fitHeightProportion"),defineResizeProperty("excludeFromLayout");var LayoutChildComponentData=function LayoutChildComponentData(){this.enabled=!0},_schema$c=["enabled"],LayoutChildComponentSystem=function(_ComponentSystem){function LayoutChildComponentSystem(app){var _this;return(_this=_ComponentSystem.call(this,app)||this).id="layoutchild",_this.ComponentType=LayoutChildComponent,_this.DataType=LayoutChildComponentData,_this.schema=_schema$c,_this}_inheritsLoose(LayoutChildComponentSystem,_ComponentSystem);var _proto=LayoutChildComponentSystem.prototype;return _proto.initializeComponentData=function initializeComponentData(component,data,properties){void 0!==data.enabled&&(component.enabled=data.enabled),void 0!==data.minWidth&&(component.minWidth=data.minWidth),void 0!==data.minHeight&&(component.minHeight=data.minHeight),void 0!==data.maxWidth&&(component.maxWidth=data.maxWidth),void 0!==data.maxHeight&&(component.maxHeight=data.maxHeight),void 0!==data.fitWidthProportion&&(component.fitWidthProportion=data.fitWidthProportion),void 0!==data.fitHeightProportion&&(component.fitHeightProportion=data.fitHeightProportion),void 0!==data.excludeFromLayout&&(component.excludeFromLayout=data.excludeFromLayout),_ComponentSystem.prototype.initializeComponentData.call(this,component,data,properties)},_proto.cloneComponent=function cloneComponent(entity,clone){var layoutChild=entity.layoutchild;return this.addComponent(clone,{enabled:layoutChild.enabled,minWidth:layoutChild.minWidth,minHeight:layoutChild.minHeight,maxWidth:layoutChild.maxWidth,maxHeight:layoutChild.maxHeight,fitWidthProportion:layoutChild.fitWidthProportion,fitHeightProportion:layoutChild.fitHeightProportion,excludeFromLayout:layoutChild.excludeFromLayout})},LayoutChildComponentSystem}(ComponentSystem);Component._buildAccessors(LayoutChildComponent.prototype,_schema$c);var FITTING_NONE=0,FITTING_STRETCH=1,FITTING_SHRINK=2,FITTING_BOTH=3,AXIS_MAPPINGS={0:{axis:"x",size:"width",calculatedSize:"calculatedWidth",minSize:"minWidth",maxSize:"maxWidth",fitting:"widthFitting",fittingProportion:"fitWidthProportion"},1:{axis:"y",size:"height",calculatedSize:"calculatedHeight",minSize:"minHeight",maxSize:"maxHeight",fitting:"heightFitting",fittingProportion:"fitHeightProportion"}},OPPOSITE_ORIENTATION={0:1,1:0},PROPERTY_DEFAULTS={minWidth:0,minHeight:0,maxWidth:Number.POSITIVE_INFINITY,maxHeight:Number.POSITIVE_INFINITY,width:null,height:null,fitWidthProportion:0,fitHeightProportion:0},FITTING_ACTION_NONE="NONE",FITTING_ACTION_APPLY_STRETCHING="APPLY_STRETCHING",FITTING_ACTION_APPLY_SHRINKING="APPLY_SHRINKING",availableSpace=new Vec2;function createCalculator(orientation){var options,a=AXIS_MAPPINGS[orientation],b=AXIS_MAPPINGS[OPPOSITE_ORIENTATION[orientation]];function minExtentA(element,size){return-size[a.size]*element.pivot[a.axis]}function minExtentB(element,size){return-size[b.size]*element.pivot[b.axis]}function maxExtentA(element,size){return size[a.size]*(1-element.pivot[a.axis])}function calculateAll(allElements,layoutOptions){allElements=allElements.filter(shouldIncludeInLayout),options=layoutOptions,availableSpace.x=options.containerSize.x-options.padding.x-options.padding.z,availableSpace.y=options.containerSize.y-options.padding.y-options.padding.w,resetAnchors(allElements);var lines=reverseLinesIfRequired(splitLines(allElements)),sizes=calculateSizesOnAxisB(lines,calculateSizesOnAxisA(lines)),positions=calculateBasePositions(lines,sizes);return applyAlignmentAndPadding(lines,sizes,positions),applySizesAndPositions(lines,sizes,positions),createLayoutInfo(lines)}function shouldIncludeInLayout(element){var layoutChildComponent=element.entity.layoutchild;return!layoutChildComponent||!layoutChildComponent.enabled||!layoutChildComponent.excludeFromLayout}function resetAnchors(allElements){for(var i=0;i<allElements.length;++i){var element=allElements[i],anchor=element.anchor;0===anchor.x&&0===anchor.y&&0===anchor.z&&0===anchor.w||(element.anchor=Vec4.ZERO)}}function splitLines(allElements){if(!options.wrap)return[allElements];for(var lines=[[]],sizes=getElementSizeProperties(allElements),runningSize=0,allowOverrun=2===options[a.fitting],i=0;i<allElements.length;++i){lines[lines.length-1].length>0&&(runningSize+=options.spacing[a.axis]);var idealElementSize=sizes[i][a.size];runningSize+=idealElementSize,!allowOverrun&&runningSize>availableSpace[a.axis]&&0!==lines[lines.length-1].length&&(runningSize=idealElementSize,lines.push([])),lines[lines.length-1].push(allElements[i]),allowOverrun&&runningSize>availableSpace[a.axis]&&i!==allElements.length-1&&(runningSize=0,lines.push([]))}return lines}function reverseLinesIfRequired(lines){var reverseAxisA=0===options.orientation&&options.reverseX||1===options.orientation&&options.reverseY,reverseAxisB=0===options.orientation&&options.reverseY||1===options.orientation&&options.reverseX;if(reverseAxisA)for(var lineIndex=0;lineIndex<lines.length;++lineIndex)reverseAxisA&&lines[lineIndex].reverse();return reverseAxisB&&lines.reverse(),lines}function calculateSizesOnAxisA(lines){for(var sizesAllLines=[],lineIndex=0;lineIndex<lines.length;++lineIndex){var line,sizesThisLine=getElementSizeProperties(lines[lineIndex]),idealRequiredSpace=calculateTotalSpace(sizesThisLine,a),fittingAction=determineFittingAction(options[a.fitting],idealRequiredSpace,availableSpace[a.axis]);fittingAction===FITTING_ACTION_APPLY_STRETCHING?stretchSizesToFitContainer(sizesThisLine,idealRequiredSpace,a):fittingAction===FITTING_ACTION_APPLY_SHRINKING&&shrinkSizesToFitContainer(sizesThisLine,idealRequiredSpace,a),sizesAllLines.push(sizesThisLine)}return sizesAllLines}function calculateSizesOnAxisB(lines,sizesAllLines){var largestElementsForEachLine=[],largestSizesForEachLine=[],elementIndex,lineIndex,line;for(lineIndex=0;lineIndex<lines.length;++lineIndex){for((line=lines[lineIndex]).largestElement=null,line.largestSize={width:Number.NEGATIVE_INFINITY,height:Number.NEGATIVE_INFINITY},elementIndex=0;elementIndex<line.length;++elementIndex){var sizesThisElement=sizesAllLines[lineIndex][elementIndex];sizesThisElement[b.size]>line.largestSize[b.size]&&(line.largestElement=line[elementIndex],line.largestSize=sizesThisElement)}largestElementsForEachLine.push(line.largestElement),largestSizesForEachLine.push(line.largestSize)}var idealRequiredSpace=calculateTotalSpace(largestSizesForEachLine,b),fittingAction=determineFittingAction(options[b.fitting],idealRequiredSpace,availableSpace[b.axis]);for(fittingAction===FITTING_ACTION_APPLY_STRETCHING?stretchSizesToFitContainer(largestSizesForEachLine,idealRequiredSpace,b):fittingAction===FITTING_ACTION_APPLY_SHRINKING&&shrinkSizesToFitContainer(largestSizesForEachLine,idealRequiredSpace,b),lineIndex=0;lineIndex<lines.length;++lineIndex)for(line=lines[lineIndex],elementIndex=0;elementIndex<line.length;++elementIndex){var sizesForThisElement=sizesAllLines[lineIndex][elementIndex],currentSize=sizesForThisElement[b.size],availableSize=1===lines.length?availableSpace[b.axis]:line.largestSize[b.size],elementFittingAction=determineFittingAction(options[b.fitting],currentSize,availableSize);elementFittingAction===FITTING_ACTION_APPLY_STRETCHING?sizesForThisElement[b.size]=Math.min(availableSize,sizesForThisElement[b.maxSize]):elementFittingAction===FITTING_ACTION_APPLY_SHRINKING&&(sizesForThisElement[b.size]=Math.max(availableSize,sizesForThisElement[b.minSize]))}return sizesAllLines}function determineFittingAction(fittingMode,currentSize,availableSize){switch(fittingMode){case 0:return FITTING_ACTION_NONE;case 1:return currentSize<availableSize?FITTING_ACTION_APPLY_STRETCHING:FITTING_ACTION_NONE;case 2:return currentSize>=availableSize?FITTING_ACTION_APPLY_SHRINKING:FITTING_ACTION_NONE;case 3:return currentSize<availableSize?FITTING_ACTION_APPLY_STRETCHING:currentSize>=availableSize?FITTING_ACTION_APPLY_SHRINKING:FITTING_ACTION_NONE;default:throw new Error("Unrecognized fitting mode: "+fittingMode)}}function calculateTotalSpace(sizes,axis){var totalSizes,totalSpacing;return sumValues(sizes,axis.size)+(sizes.length-1)*options.spacing[axis.axis]}function stretchSizesToFitContainer(sizesThisLine,idealRequiredSpace,axis){for(var ascendingMaxSizeOrder=getTraversalOrder(sizesThisLine,axis.maxSize),fittingProportions=getNormalizedValues(sizesThisLine,axis.fittingProportion),fittingProportionSums=createSumArray(fittingProportions,ascendingMaxSizeOrder),remainingUndershoot=availableSpace[axis.axis]-idealRequiredSpace,i=0;i<sizesThisLine.length;++i){var index=ascendingMaxSizeOrder[i],targetIncrease=calculateAdjustment(index,remainingUndershoot,fittingProportions,fittingProportionSums),targetSize=sizesThisLine[index][axis.size]+targetIncrease,maxSize=sizesThisLine[index][axis.maxSize],actualSize=Math.min(targetSize,maxSize),actualIncrease,appliedIncrease;sizesThisLine[index][axis.size]=actualSize,remainingUndershoot-=targetIncrease-Math.max(targetSize-actualSize,0)}}function shrinkSizesToFitContainer(sizesThisLine,idealRequiredSpace,axis){for(var descendingMinSizeOrder=getTraversalOrder(sizesThisLine,axis.minSize,!0),fittingProportions,inverseFittingProportions=invertNormalizedValues(getNormalizedValues(sizesThisLine,axis.fittingProportion)),inverseFittingProportionSums=createSumArray(inverseFittingProportions,descendingMinSizeOrder),remainingOvershoot=idealRequiredSpace-availableSpace[axis.axis],i=0;i<sizesThisLine.length;++i){var index=descendingMinSizeOrder[i],targetReduction=calculateAdjustment(index,remainingOvershoot,inverseFittingProportions,inverseFittingProportionSums),targetSize=sizesThisLine[index][axis.size]-targetReduction,minSize=sizesThisLine[index][axis.minSize],actualSize=Math.max(targetSize,minSize),actualReduction,appliedReduction;sizesThisLine[index][axis.size]=actualSize,remainingOvershoot-=targetReduction-Math.max(actualSize-targetSize,0)}}function calculateAdjustment(index,remainingAdjustment,fittingProportions,fittingProportionSums){var proportion=fittingProportions[index],sumOfRemainingProportions=fittingProportionSums[index];return Math.abs(proportion)<1e-5&&Math.abs(sumOfRemainingProportions)<1e-5?remainingAdjustment:remainingAdjustment*proportion/sumOfRemainingProportions}function calculateBasePositions(lines,sizes){var cursor={};cursor[a.axis]=0,cursor[b.axis]=0,lines[a.size]=Number.NEGATIVE_INFINITY;for(var positionsAllLines=[],lineIndex=0;lineIndex<lines.length;++lineIndex){var line=lines[lineIndex];if(0===line.length)return;for(var positionsThisLine=[],sizesThisLine=sizes[lineIndex],elementIndex=0;elementIndex<line.length;++elementIndex){var element=line[elementIndex],sizesThisElement=sizesThisLine[elementIndex];cursor[b.axis]-=minExtentB(element,sizesThisElement),cursor[a.axis]-=minExtentA(element,sizesThisElement),positionsThisLine[elementIndex]={},positionsThisLine[elementIndex][a.axis]=cursor[a.axis],positionsThisLine[elementIndex][b.axis]=cursor[b.axis],cursor[b.axis]+=minExtentB(element,sizesThisElement),cursor[a.axis]+=maxExtentA(element,sizesThisElement)+options.spacing[a.axis]}line[a.size]=cursor[a.axis]-options.spacing[a.axis],line[b.size]=line.largestSize[b.size],lines[a.size]=Math.max(lines[a.size],line[a.size]),cursor[a.axis]=0,cursor[b.axis]+=line[b.size]+options.spacing[b.axis],positionsAllLines.push(positionsThisLine)}return lines[b.size]=cursor[b.axis]-options.spacing[b.axis],positionsAllLines}function applyAlignmentAndPadding(lines,sizes,positions){for(var alignmentA=options.alignment[a.axis],alignmentB=options.alignment[b.axis],paddingA=options.padding[a.axis],paddingB=options.padding[b.axis],lineIndex=0;lineIndex<lines.length;++lineIndex)for(var line=lines[lineIndex],sizesThisLine=sizes[lineIndex],positionsThisLine=positions[lineIndex],axisAOffset=(availableSpace[a.axis]-line[a.size])*alignmentA+paddingA,axisBOffset=(availableSpace[b.axis]-lines[b.size])*alignmentB+paddingB,elementIndex=0;elementIndex<line.length;++elementIndex){var withinLineAxisBOffset=(line[b.size]-sizesThisLine[elementIndex][b.size])*options.alignment[b.axis];positionsThisLine[elementIndex][a.axis]+=axisAOffset,positionsThisLine[elementIndex][b.axis]+=axisBOffset+withinLineAxisBOffset}}function applySizesAndPositions(lines,sizes,positions){for(var lineIndex=0;lineIndex<lines.length;++lineIndex)for(var line=lines[lineIndex],sizesThisLine=sizes[lineIndex],positionsThisLine=positions[lineIndex],elementIndex=0;elementIndex<line.length;++elementIndex){var element=line[elementIndex];element[a.calculatedSize]=sizesThisLine[elementIndex][a.size],element[b.calculatedSize]=sizesThisLine[elementIndex][b.size],0===options.orientation?element.entity.setLocalPosition(positionsThisLine[elementIndex][a.axis],positionsThisLine[elementIndex][b.axis],element.entity.getLocalPosition().z):element.entity.setLocalPosition(positionsThisLine[elementIndex][b.axis],positionsThisLine[elementIndex][a.axis],element.entity.getLocalPosition().z)}}function createLayoutInfo(lines){var layoutWidth=lines.width,layoutHeight=lines.height,xOffset=(availableSpace.x-layoutWidth)*options.alignment.x+options.padding.x,yOffset=(availableSpace.y-layoutHeight)*options.alignment.y+options.padding.y;return{bounds:new Vec4(xOffset,yOffset,layoutWidth,layoutHeight)}}function getElementSizeProperties(elements){for(var sizeProperties=[],i=0;i<elements.length;++i){var element=elements[i],minWidth=Math.max(getProperty(element,"minWidth"),0),minHeight=Math.max(getProperty(element,"minHeight"),0),maxWidth=Math.max(getProperty(element,"maxWidth"),minWidth),maxHeight=Math.max(getProperty(element,"maxHeight"),minHeight),width=clamp(getProperty(element,"width"),minWidth,maxWidth),height=clamp(getProperty(element,"height"),minHeight,maxHeight),fitWidthProportion=getProperty(element,"fitWidthProportion"),fitHeightProportion=getProperty(element,"fitHeightProportion");sizeProperties.push({minWidth:minWidth,minHeight:minHeight,maxWidth:maxWidth,maxHeight:maxHeight,width:width,height:height,fitWidthProportion:fitWidthProportion,fitHeightProportion:fitHeightProportion})}return sizeProperties}function getProperty(element,propertyName){var layoutChildComponent=element.entity.layoutchild;return layoutChildComponent&&layoutChildComponent.enabled&&void 0!==layoutChildComponent[propertyName]&&null!==layoutChildComponent[propertyName]?layoutChildComponent[propertyName]:void 0!==element[propertyName]?element[propertyName]:PROPERTY_DEFAULTS[propertyName]}function clamp(value,min,max){return Math.min(Math.max(value,min),max)}function sumValues(items,propertyName){return items.reduce((function(accumulator,current){return accumulator+current[propertyName]}),0)}function getNormalizedValues(items,propertyName){var sum=sumValues(items,propertyName),normalizedValues=[],numItems=items.length,i;if(0===sum)for(i=0;i<numItems;++i)normalizedValues.push(1/numItems);else for(i=0;i<numItems;++i)normalizedValues.push(items[i][propertyName]/sum);return normalizedValues}function invertNormalizedValues(values){if(1===values.length)return[1];for(var invertedValues=[],numValues=values.length,i=0;i<numValues;++i)invertedValues.push((1-values[i])/(numValues-1));return invertedValues}function getTraversalOrder(items,orderBy,descending){return items.forEach(assignIndex),items.slice().sort((function(itemA,itemB){return descending?itemB[orderBy]-itemA[orderBy]:itemA[orderBy]-itemB[orderBy]})).map(getIndex)}function assignIndex(item,index){item.index=index}function getIndex(item){return item.index}function createSumArray(values,order){var sumArray=[];sumArray[order[values.length-1]]=values[order[values.length-1]];for(var i=values.length-2;i>=0;--i)sumArray[order[i]]=sumArray[order[i+1]]+values[order[i]];return sumArray}return calculateAll}var CALCULATE_FNS={};CALCULATE_FNS[0]=createCalculator(0),CALCULATE_FNS[1]=createCalculator(1);var LayoutCalculator=function(){function LayoutCalculator(){}var _proto;return LayoutCalculator.prototype.calculateLayout=function calculateLayout(elements,options){var calculateFn=CALCULATE_FNS[options.orientation];if(calculateFn)return calculateFn(elements,options);throw new Error("Unrecognized orientation value: "+options.orientation)},LayoutCalculator}();function getElement(entity){return entity.element}function isEnabledAndHasEnabledElement(entity){return entity.enabled&&entity.element&&entity.element.enabled}var LayoutGroupComponent=function(_Component){function LayoutGroupComponent(system,entity){var _this;return(_this=_Component.call(this,system,entity)||this)._orientation=0,_this._reverseX=!1,_this._reverseY=!0,_this._alignment=new Vec2(0,1),_this._padding=new Vec4,_this._spacing=new Vec2,_this._widthFitting=0,_this._heightFitting=0,_this._wrap=!1,_this._layoutCalculator=new LayoutCalculator,_this._listenForReflowEvents(_this.entity,"on"),_this.entity.children.forEach(function(child){this._listenForReflowEvents(child,"on")}.bind(_assertThisInitialized(_this))),_this.entity.on("childinsert",_this._onChildInsert,_assertThisInitialized(_this)),_this.entity.on("childremove",_this._onChildRemove,_assertThisInitialized(_this)),system.app.systems.element.on("add",_this._onElementOrLayoutComponentAdd,_assertThisInitialized(_this)),system.app.systems.element.on("beforeremove",_this._onElementOrLayoutComponentRemove,_assertThisInitialized(_this)),system.app.systems.layoutchild.on("add",_this._onElementOrLayoutComponentAdd,_assertThisInitialized(_this)),system.app.systems.layoutchild.on("beforeremove",_this._onElementOrLayoutComponentRemove,_assertThisInitialized(_this)),_this}_inheritsLoose(LayoutGroupComponent,_Component);var _proto=LayoutGroupComponent.prototype;return _proto._isSelfOrChild=function _isSelfOrChild(entity){return entity===this.entity||-1!==this.entity.children.indexOf(entity)},_proto._listenForReflowEvents=function _listenForReflowEvents(target,onOff){target.element&&(target.element[onOff]("enableelement",this._scheduleReflow,this),target.element[onOff]("disableelement",this._scheduleReflow,this),target.element[onOff]("resize",this._scheduleReflow,this),target.element[onOff]("set:pivot",this._scheduleReflow,this)),target.layoutchild&&(target.layoutchild[onOff]("set_enabled",this._scheduleReflow,this),target.layoutchild[onOff]("resize",this._scheduleReflow,this))},_proto._onElementOrLayoutComponentAdd=function _onElementOrLayoutComponentAdd(entity){this._isSelfOrChild(entity)&&(this._listenForReflowEvents(entity,"on"),this._scheduleReflow())},_proto._onElementOrLayoutComponentRemove=function _onElementOrLayoutComponentRemove(entity){this._isSelfOrChild(entity)&&(this._listenForReflowEvents(entity,"off"),this._scheduleReflow())},_proto._onChildInsert=function _onChildInsert(child){this._listenForReflowEvents(child,"on"),this._scheduleReflow()},_proto._onChildRemove=function _onChildRemove(child){this._listenForReflowEvents(child,"off"),this._scheduleReflow()},_proto._scheduleReflow=function _scheduleReflow(){this.enabled&&this.entity&&this.entity.enabled&&!this._isPerformingReflow&&this.system.scheduleReflow(this)},_proto.reflow=function reflow(){var container=getElement(this.entity),elements=this.entity.children.filter(isEnabledAndHasEnabledElement).map(getElement);if(container&&0!==elements.length){var containerWidth=Math.max(container.calculatedWidth,0),containerHeight=Math.max(container.calculatedHeight,0),options={orientation:this._orientation,reverseX:this._reverseX,reverseY:this._reverseY,alignment:this._alignment,padding:this._padding,spacing:this._spacing,widthFitting:this._widthFitting,heightFitting:this._heightFitting,wrap:this._wrap,containerSize:new Vec2(containerWidth,containerHeight)};this._isPerformingReflow=!0;var layoutInfo=this._layoutCalculator.calculateLayout(elements,options);this._isPerformingReflow=!1,this.fire("reflow",layoutInfo)}},_proto.onEnable=function onEnable(){this._scheduleReflow()},_proto.onRemove=function onRemove(){this.entity.off("childinsert",this._onChildInsert,this),this.entity.off("childremove",this._onChildRemove,this),this._listenForReflowEvents(this.entity,"off"),this.entity.children.forEach(function(child){this._listenForReflowEvents(child,"off")}.bind(this)),this.system.app.systems.element.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.element.off("beforeremove",this._onElementOrLayoutComponentRemove,this),this.system.app.systems.layoutchild.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.layoutchild.off("beforeremove",this._onElementOrLayoutComponentRemove,this)},LayoutGroupComponent}(Component);function defineReflowSchedulingProperty(name){var _name="_"+name;Object.defineProperty(LayoutGroupComponent.prototype,name,{get:function get(){return this[_name]},set:function set(value){this[_name]!==value&&(this[_name]=value,this._scheduleReflow())}})}defineReflowSchedulingProperty("orientation"),defineReflowSchedulingProperty("reverseX"),defineReflowSchedulingProperty("reverseY"),defineReflowSchedulingProperty("alignment"),defineReflowSchedulingProperty("padding"),defineReflowSchedulingProperty("spacing"),defineReflowSchedulingProperty("widthFitting"),defineReflowSchedulingProperty("heightFitting"),defineReflowSchedulingProperty("wrap");var LayoutGroupComponentData=function LayoutGroupComponentData(){this.enabled=!0},_schema$b=["enabled"],MAX_ITERATIONS=100,LayoutGroupComponentSystem=function(_ComponentSystem){function LayoutGroupComponentSystem(app){var _this;return(_this=_ComponentSystem.call(this,app)||this).id="layoutgroup",_this.ComponentType=LayoutGroupComponent,_this.DataType=LayoutGroupComponentData,_this.schema=_schema$b,_this._reflowQueue=[],_this.on("beforeremove",_this._onRemoveComponent,_assertThisInitialized(_this)),ComponentSystem.bind("postUpdate",_this._onPostUpdate,_assertThisInitialized(_this)),_this}_inheritsLoose(LayoutGroupComponentSystem,_ComponentSystem);var _proto=LayoutGroupComponentSystem.prototype;return _proto.initializeComponentData=function initializeComponentData(component,data,properties){void 0!==data.enabled&&(component.enabled=data.enabled),void 0!==data.orientation&&(component.orientation=data.orientation),void 0!==data.reverseX&&(component.reverseX=data.reverseX),void 0!==data.reverseY&&(component.reverseY=data.reverseY),void 0!==data.alignment&&(data.alignment instanceof Vec2?component.alignment.copy(data.alignment):component.alignment.set(data.alignment[0],data.alignment[1]),component.alignment=component.alignment),void 0!==data.padding&&(data.padding instanceof Vec4?component.padding.copy(data.padding):component.padding.set(data.padding[0],data.padding[1],data.padding[2],data.padding[3]),component.padding=component.padding),void 0!==data.spacing&&(data.spacing instanceof Vec2?component.spacing.copy(data.spacing):component.spacing.set(data.spacing[0],data.spacing[1]),component.spacing=component.spacing),void 0!==data.widthFitting&&(component.widthFitting=data.widthFitting),void 0!==data.heightFitting&&(component.heightFitting=data.heightFitting),void 0!==data.wrap&&(component.wrap=data.wrap),_ComponentSystem.prototype.initializeComponentData.call(this,component,data,properties)},_proto.cloneComponent=function cloneComponent(entity,clone){var layoutGroup=entity.layoutgroup;return this.addComponent(clone,{enabled:layoutGroup.enabled,orientation:layoutGroup.orientation,reverseX:layoutGroup.reverseX,reverseY:layoutGroup.reverseY,alignment:layoutGroup.alignment,padding:layoutGroup.padding,spacing:layoutGroup.spacing,widthFitting:layoutGroup.widthFitting,heightFitting:layoutGroup.heightFitting,wrap:layoutGroup.wrap})},_proto.scheduleReflow=function scheduleReflow(component){-1===this._reflowQueue.indexOf(component)&&this._reflowQueue.push(component)},_proto._onPostUpdate=function _onPostUpdate(){this._processReflowQueue()},_proto._processReflowQueue=function _processReflowQueue(){if(0!==this._reflowQueue.length)for(var iterationCount=0;this._reflowQueue.length>0;){var queue=this._reflowQueue.slice();this._reflowQueue.length=0,queue.sort((function(componentA,componentB){return componentA.entity.graphDepth-componentB.entity.graphDepth}));for(var i=0;i<queue.length;++i)queue[i].reflow();if(++iterationCount>=100){console.warn("Max reflow iterations limit reached, bailing.");break}}},_proto._onRemoveComponent=function _onRemoveComponent(entity,component){component.onRemove()},LayoutGroupComponentSystem}(ComponentSystem);Component._buildAccessors(LayoutGroupComponent.prototype,_schema$b);var _lightProps=[],_lightPropsDefault=[],LightComponent=function(_Component){function LightComponent(system,entity){var _this;return(_this=_Component.call(this,system,entity)||this)._cookieAsset=null,_this._cookieAssetId=null,_this._cookieAssetAdd=!1,_this._cookieMatrix=null,_this}_inheritsLoose(LightComponent,_Component);var _proto=LightComponent.prototype;return _proto.addLightToLayers=function addLightToLayers(){for(var layer,i=0;i<this.layers.length;i++)(layer=this.system.app.scene.layers.getLayerById(this.layers[i]))&&layer.addLight(this)},_proto.removeLightFromLayers=function removeLightFromLayers(){for(var layer,i=0;i<this.layers.length;i++)(layer=this.system.app.scene.layers.getLayerById(this.layers[i]))&&layer.removeLight(this)},_proto.onLayersChanged=function onLayersChanged(oldComp,newComp){this.enabled&&this.entity.enabled&&this.addLightToLayers(),oldComp.off("add",this.onLayerAdded,this),oldComp.off("remove",this.onLayerRemoved,this),newComp.on("add",this.onLayerAdded,this),newComp.on("remove",this.onLayerRemoved,this)},_proto.onLayerAdded=function onLayerAdded(layer){var index;this.layers.indexOf(layer.id)>=0&&this.enabled&&this.entity.enabled&&layer.addLight(this)},_proto.onLayerRemoved=function onLayerRemoved(layer){var index;this.layers.indexOf(layer.id)>=0&&layer.removeLight(this)},_proto.refreshProperties=function refreshProperties(){for(var name,i=0;i<_lightProps.length;i++)this[name=_lightProps[i]]=this[name];this.enabled&&this.entity.enabled&&this.onEnable()},_proto.updateShadow=function updateShadow(){this.light.updateShadow()},_proto.onCookieAssetSet=function onCookieAssetSet(){var forceLoad=!1;"cubemap"!==this._cookieAsset.type||this._cookieAsset.loadFaces||(this._cookieAsset.loadFaces=!0,forceLoad=!0),this._cookieAsset.resource&&!forceLoad||this.system.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad()},_proto.onCookieAssetAdd=function onCookieAssetAdd(asset){this._cookieAssetId===asset.id&&(this._cookieAsset=asset,this.light.enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this))},_proto.onCookieAssetLoad=function onCookieAssetLoad(){this._cookieAsset&&this._cookieAsset.resource&&(this.cookie=this._cookieAsset.resource)},_proto.onCookieAssetRemove=function onCookieAssetRemove(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)},_proto.onEnable=function onEnable(){this.light.enabled=!0,this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addLightToLayers(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet()},_proto.onDisable=function onDisable(){this.light.enabled=!1,this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.removeLightFromLayers()},_proto.onRemove=function onRemove(){this.onDisable(),this.light.destroy(),this.cookieAsset=null},LightComponent}(Component);function _defineProperty(name,defaultValue,setFunc,skipEqualsCheck){var c=LightComponent.prototype;_lightProps.push(name),_lightPropsDefault.push(defaultValue),Object.defineProperty(c,name,{get:function get(){return this.data[name]},set:function set(value){var data=this.data,oldValue=data[name];(skipEqualsCheck||oldValue!==value)&&(data[name]=value,setFunc&&setFunc.call(this,value,oldValue))},configurable:!0})}function _defineProps(){_defineProperty("enabled",!0,(function(newValue,oldValue){this.onSetEnabled(null,oldValue,newValue)})),_defineProperty("light",null),_defineProperty("type","directional",(function(newValue,oldValue){this.system.changeType(this,oldValue,newValue),this.refreshProperties()})),_defineProperty("color",new Color(1,1,1),(function(newValue,oldValue){this.light.setColor(newValue)}),!0),_defineProperty("intensity",1,(function(newValue,oldValue){this.light.intensity=newValue})),_defineProperty("shape",0,(function(newValue,oldValue){this.light.shape=newValue})),_defineProperty("castShadows",!1,(function(newValue,oldValue){this.light.castShadows=newValue})),_defineProperty("shadowDistance",40,(function(newValue,oldValue){this.light.shadowDistance=newValue})),_defineProperty("shadowResolution",1024,(function(newValue,oldValue){this.light.shadowResolution=newValue})),_defineProperty("shadowBias",.05,(function(newValue,oldValue){this.light.shadowBias=-.01*newValue})),_defineProperty("numCascades",1,(function(newValue,oldValue){this.light.numCascades=math.clamp(Math.floor(newValue),1,4)})),_defineProperty("cascadeDistribution",.5,(function(newValue,oldValue){this.light.cascadeDistribution=math.clamp(newValue,0,1)})),_defineProperty("normalOffsetBias",0,(function(newValue,oldValue){this.light.normalOffsetBias=newValue})),_defineProperty("range",10,(function(newValue,oldValue){this.light.attenuationEnd=newValue})),_defineProperty("innerConeAngle",40,(function(newValue,oldValue){this.light.innerConeAngle=newValue})),_defineProperty("outerConeAngle",45,(function(newValue,oldValue){this.light.outerConeAngle=newValue})),_defineProperty("falloffMode",0,(function(newValue,oldValue){this.light.falloffMode=newValue})),_defineProperty("shadowType",0,(function(newValue,oldValue){this.light.shadowType=newValue})),_defineProperty("vsmBlurSize",11,(function(newValue,oldValue){this.light.vsmBlurSize=newValue})),_defineProperty("vsmBlurMode",1,(function(newValue,oldValue){this.light.vsmBlurMode=newValue})),_defineProperty("vsmBias",.0025,(function(newValue,oldValue){this.light.vsmBias=newValue})),_defineProperty("cookieAsset",null,(function(newValue,oldValue){if(!this._cookieAssetId||!(newValue instanceof Asset&&newValue.id===this._cookieAssetId||newValue===this._cookieAssetId))if(this.onCookieAssetRemove(),this._cookieAssetId=null,newValue instanceof Asset)this.data.cookieAsset=newValue.id,this._cookieAssetId=newValue.id,this.onCookieAssetAdd(newValue);else if("number"==typeof newValue){this._cookieAssetId=newValue;var asset=this.system.app.assets.get(newValue);asset?this.onCookieAssetAdd(asset):(this._cookieAssetAdd=!0,this.system.app.assets.on("add:"+this._cookieAssetId,this.onCookieAssetAdd,this))}})),_defineProperty("cookie",null,(function(newValue,oldValue){this.light.cookie=newValue})),_defineProperty("cookieIntensity",1,(function(newValue,oldValue){this.light.cookieIntensity=newValue})),_defineProperty("cookieFalloff",!0,(function(newValue,oldValue){this.light.cookieFalloff=newValue})),_defineProperty("cookieChannel","rgb",(function(newValue,oldValue){this.light.cookieChannel=newValue})),_defineProperty("cookieAngle",0,(function(newValue,oldValue){if(0!==newValue||null!==this.cookieScale){this._cookieMatrix||(this._cookieMatrix=new Vec4);var scx=1,scy=1;this.cookieScale&&(scx=this.cookieScale.x,scy=this.cookieScale.y);var c=Math.cos(newValue*math.DEG_TO_RAD),s=Math.sin(newValue*math.DEG_TO_RAD);this._cookieMatrix.set(c/scx,-s/scx,s/scy,c/scy),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null})),_defineProperty("cookieScale",null,(function(newValue,oldValue){if(null!==newValue||0!==this.cookieAngle){this._cookieMatrix||(this._cookieMatrix=new Vec4);var scx=newValue.x,scy=newValue.y,c=Math.cos(this.cookieAngle*math.DEG_TO_RAD),s=Math.sin(this.cookieAngle*math.DEG_TO_RAD);this._cookieMatrix.set(c/scx,-s/scx,s/scy,c/scy),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null}),!0),_defineProperty("cookieOffset",null,(function(newValue,oldValue){this.light.cookieOffset=newValue}),!0),_defineProperty("shadowUpdateMode",2,(function(newValue,oldValue){this.light.shadowUpdateMode=newValue})),_defineProperty("mask",1,(function(newValue,oldValue){this.light.mask=newValue})),_defineProperty("affectDynamic",!0,(function(newValue,oldValue){newValue?this.light.mask|=1:this.light.mask&=-2,this.light.layersDirty()})),_defineProperty("affectLightmapped",!1,(function(newValue,oldValue){newValue?(this.light.mask|=2,this.bake&&(this.light.mask&=-5)):(this.light.mask&=-3,this.bake&&(this.light.mask|=4))})),_defineProperty("bake",!1,(function(newValue,oldValue){newValue?(this.light.mask|=4,this.affectLightmapped&&(this.light.mask&=-3)):(this.light.mask&=-5,this.affectLightmapped&&(this.light.mask|=2))})),_defineProperty("bakeDir",!0,(function(newValue,oldValue){this.light.bakeDir=newValue})),_defineProperty("isStatic",!1,(function(newValue,oldValue){this.light.isStatic=newValue})),_defineProperty("layers",[0],(function(newValue,oldValue){var i,layer;for(i=0;i<oldValue.length;i++)(layer=this.system.app.scene.layers.getLayerById(oldValue[i]))&&layer.removeLight(this);for(i=0;i<newValue.length;i++)(layer=this.system.app.scene.layers.getLayerById(newValue[i]))&&this.enabled&&this.entity.enabled&&layer.addLight(this)}))}_defineProps();var LightComponentData=function LightComponentData(){for(var _props=_lightProps,_propsDefault=_lightPropsDefault,value,i=0;i<_props.length;i++)(value=_propsDefault[i])&&value.clone?this[_props[i]]=value.clone():this[_props[i]]=value},lightTypes={directional:0,omni:1,point:1,spot:2},LightComponentSystem=function(_ComponentSystem){function LightComponentSystem(app){var _this;return(_this=_ComponentSystem.call(this,app)||this).id="light",_this.ComponentType=LightComponent,_this.DataType=LightComponentData,_this.on("beforeremove",_this._onRemoveComponent,_assertThisInitialized(_this)),_this}_inheritsLoose(LightComponentSystem,_ComponentSystem);var _proto=LightComponentSystem.prototype;return _proto.initializeComponentData=function initializeComponentData(component,_data){for(var properties=_lightProps,data={},i=0,len=properties.length;i<len;i++){var property=properties[i];data[property]=_data[property]}data.type||(data.type=component.data.type),component.data.type=data.type,data.layers&&Array.isArray(data.layers)&&(data.layers=data.layers.slice(0)),data.color&&Array.isArray(data.color)&&(data.color=new Color(data.color[0],data.color[1],data.color[2])),data.cookieOffset&&data.cookieOffset instanceof Array&&(data.cookieOffset=new Vec2(data.cookieOffset[0],data.cookieOffset[1])),data.cookieScale&&data.cookieScale instanceof Array&&(data.cookieScale=new Vec2(data.cookieScale[0],data.cookieScale[1])),data.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),data.enabled=data.enable),data.shape||(data.shape=0);var light=new Light(this.app.graphicsDevice);light.type=lightTypes[data.type],light._node=component.entity,light._scene=this.app.scene,component.data.light=light,_ComponentSystem.prototype.initializeComponentData.call(this,component,data,properties)},_proto._onRemoveComponent=function _onRemoveComponent(entity,component){component.onRemove()},_proto.cloneComponent=function cloneComponent(entity,clone){for(var light=entity.light,data=[],name,_props=_lightProps,i=0;i<_props.length;i++)"light"!==(name=_props[i])&&(light[name]&&light[name].clone?data[name]=light[name].clone():data[name]=light[name]);this.addComponent(clone,data)},_proto.changeType=function changeType(component,oldValue,newValue){oldValue!==newValue&&(component.light.type=lightTypes[newValue])},LightComponentSystem}(ComponentSystem),ModelComponent=function(_Component){function ModelComponent(system,entity){var _this;return(_this=_Component.call(this,system,entity)||this)._type="asset",_this._asset=null,_this._model=null,_this._mapping={},_this._castShadows=!0,_this._receiveShadows=!0,_this._materialAsset=null,_this._material=system.defaultMaterial,_this._castShadowsLightmap=!0,_this._lightmapped=!1,_this._lightmapSizeMultiplier=1,_this._isStatic=!1,_this._layers=[0],_this._batchGroupId=-1,_this._customAabb=null,_this._area=null,_this._assetOld=0,_this._materialEvents=null,_this._dirtyModelAsset=!1,_this._dirtyMaterialAsset=!1,_this._clonedModel=!1,entity.on("remove",_this.onRemoveChild,_assertThisInitialized(_this)),entity.on("insert",_this.onInsertChild,_assertThisInitialized(_this)),_this}_inheritsLoose(ModelComponent,_Component);var _proto=ModelComponent.prototype;return _proto.addModelToLayers=function addModelToLayers(){for(var layers=this.system.app.scene.layers,i=0;i<this._layers.length;i++){var layer=layers.getLayerById(this._layers[i]);layer&&layer.addMeshInstances(this.meshInstances)}},_proto.removeModelFromLayers=function removeModelFromLayers(){for(var layer,layers=this.system.app.scene.layers,i=0;i<this._layers.length;i++)(layer=layers.getLayerById(this._layers[i]))&&layer.removeMeshInstances(this.meshInstances)},_proto.onRemoveChild=function onRemoveChild(){this._model&&this.removeModelFromLayers()},_proto.onInsertChild=function onInsertChild(){this._model&&this.enabled&&this.entity.enabled&&this.addModelToLayers()},_proto.onRemove=function onRemove(){"asset"===this.type?this.asset=null:this.model=null,this.materialAsset=null,this._unsetMaterialEvents(),this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)},_proto.onLayersChanged=function onLayersChanged(oldComp,newComp){this.addModelToLayers(),oldComp.off("add",this.onLayerAdded,this),oldComp.off("remove",this.onLayerRemoved,this),newComp.on("add",this.onLayerAdded,this),newComp.on("remove",this.onLayerRemoved,this)},_proto.onLayerAdded=function onLayerAdded(layer){var index;this.layers.indexOf(layer.id)<0||layer.addMeshInstances(this.meshInstances)},_proto.onLayerRemoved=function onLayerRemoved(layer){var index;this.layers.indexOf(layer.id)<0||layer.removeMeshInstances(this.meshInstances)},_proto._setMaterialEvent=function _setMaterialEvent(index,event,id,handler){var evt=event+":"+id;this.system.app.assets.on(evt,handler,this),this._materialEvents||(this._materialEvents=[]),this._materialEvents[index]||(this._materialEvents[index]={}),this._materialEvents[index][evt]={id:id,handler:handler}},_proto._unsetMaterialEvents=function _unsetMaterialEvents(){var assets=this.system.app.assets,events=this._materialEvents;if(events){for(var i=0,len=events.length;i<len;i++)if(events[i]){var evt=events[i];for(var key in evt)assets.off(key,evt[key].handler,this)}this._materialEvents=null}},_proto._getAssetByIdOrPath=function _getAssetByIdOrPath(idOrPath){var asset=null,isPath;if(isNaN(parseInt(idOrPath,10))){if(this.asset){var url=this._getMaterialAssetUrl(idOrPath);url&&(asset=this.system.app.assets.getByUrl(url))}}else asset=this.system.app.assets.get(idOrPath);return asset},_proto._getMaterialAssetUrl=function _getMaterialAssetUrl(path){if(!this.asset)return null;var modelAsset=this.system.app.assets.get(this.asset);return modelAsset?modelAsset.getAbsoluteUrl(path):null},_proto._loadAndSetMeshInstanceMaterial=function _loadAndSetMeshInstanceMaterial(materialAsset,meshInstance,index){var assets=this.system.app.assets;materialAsset&&(materialAsset.resource?(meshInstance.material=materialAsset.resource,this._setMaterialEvent(index,"remove",materialAsset.id,(function(){meshInstance.material=this.system.defaultMaterial}))):(this._setMaterialEvent(index,"load",materialAsset.id,(function(asset){meshInstance.material=asset.resource,this._setMaterialEvent(index,"remove",materialAsset.id,(function(){meshInstance.material=this.system.defaultMaterial}))})),this.enabled&&this.entity.enabled&&assets.load(materialAsset)))},_proto.onEnable=function onEnable(){var app=this.system.app,scene=app.scene;scene.on("set:layers",this.onLayersChanged,this),scene.layers&&(scene.layers.on("add",this.onLayerAdded,this),scene.layers.on("remove",this.onLayerRemoved,this));var isAsset="asset"===this._type,asset;if(this._model?this.addModelToLayers():isAsset&&this._asset&&(asset=app.assets.get(this._asset))&&asset.resource!==this._model&&this._bindModelAsset(asset),this._materialAsset&&(asset=app.assets.get(this._materialAsset))&&asset.resource!==this._material&&this._bindMaterialAsset(asset),isAsset&&this._mapping)for(var index in this._mapping)this._mapping[index]&&(asset=this._getAssetByIdOrPath(this._mapping[index]))&&!asset.resource&&app.assets.load(asset);this._batchGroupId>=0&&app.batcher.insert(BatchGroup.MODEL,this.batchGroupId,this.entity)},_proto.onDisable=function onDisable(){var app=this.system.app,scene=app.scene;scene.off("set:layers",this.onLayersChanged,this),scene.layers&&(scene.layers.off("add",this.onLayerAdded,this),scene.layers.off("remove",this.onLayerRemoved,this)),this._batchGroupId>=0&&app.batcher.remove(BatchGroup.MODEL,this.batchGroupId,this.entity),this._model&&this.removeModelFromLayers()},_proto.hide=function hide(){if(this._model){var i,l,instances=this._model.meshInstances;for(i=0,l=instances.length;i<l;i++)instances[i].visible=!1}},_proto.show=function show(){if(this._model){var i,l,instances=this._model.meshInstances;for(i=0,l=instances.length;i<l;i++)instances[i].visible=!0}},_proto._bindMaterialAsset=function _bindMaterialAsset(asset){if(asset.on("load",this._onMaterialAssetLoad,this),asset.on("unload",this._onMaterialAssetUnload,this),asset.on("remove",this._onMaterialAssetRemove,this),asset.on("change",this._onMaterialAssetChange,this),asset.resource)this._onMaterialAssetLoad(asset);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(asset)}},_proto._unbindMaterialAsset=function _unbindMaterialAsset(asset){asset.off("load",this._onMaterialAssetLoad,this),asset.off("unload",this._onMaterialAssetUnload,this),asset.off("remove",this._onMaterialAssetRemove,this),asset.off("change",this._onMaterialAssetChange,this)},_proto._onMaterialAssetAdd=function _onMaterialAssetAdd(asset){this.system.app.assets.off("add:"+asset.id,this._onMaterialAssetAdd,this),this._materialAsset===asset.id&&this._bindMaterialAsset(asset)},_proto._onMaterialAssetLoad=function _onMaterialAssetLoad(asset){this._setMaterial(asset.resource)},_proto._onMaterialAssetUnload=function _onMaterialAssetUnload(asset){this._setMaterial(this.system.defaultMaterial)},_proto._onMaterialAssetRemove=function _onMaterialAssetRemove(asset){this._onMaterialAssetUnload(asset)},_proto._onMaterialAssetChange=function _onMaterialAssetChange(asset){},_proto._bindModelAsset=function _bindModelAsset(asset){if(this._unbindModelAsset(asset),asset.on("load",this._onModelAssetLoad,this),asset.on("unload",this._onModelAssetUnload,this),asset.on("change",this._onModelAssetChange,this),asset.on("remove",this._onModelAssetRemove,this),asset.resource)this._onModelAssetLoad(asset);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(asset)}},_proto._unbindModelAsset=function _unbindModelAsset(asset){asset.off("load",this._onModelAssetLoad,this),asset.off("unload",this._onModelAssetUnload,this),asset.off("change",this._onModelAssetChange,this),asset.off("remove",this._onModelAssetRemove,this)},_proto._onModelAssetAdded=function _onModelAssetAdded(asset){this.system.app.assets.off("add:"+asset.id,this._onModelAssetAdded,this),asset.id===this._asset&&this._bindModelAsset(asset)},_proto._onModelAssetLoad=function _onModelAssetLoad(asset){this.model=asset.resource.clone(),this._clonedModel=!0},_proto._onModelAssetUnload=function _onModelAssetUnload(asset){this.model=null},_proto._onModelAssetChange=function _onModelAssetChange(asset,attr,_new,_old){"data"===attr&&(this.mapping=this._mapping)},_proto._onModelAssetRemove=function _onModelAssetRemove(asset){this.model=null},_proto._setMaterial=function _setMaterial(material){if(this._material!==material){this._material=material;var model=this._model;if(model&&"asset"!==this._type)for(var meshInstances=model.meshInstances,i=0,len=meshInstances.length;i<len;i++)meshInstances[i].material=material}},_createClass(ModelComponent,[{key:"meshInstances",get:function get(){return this._model?this._model.meshInstances:null},set:function set(value){this._model&&(this._model.meshInstances=value)}},{key:"customAabb",get:function get(){return this._customAabb},set:function set(value){if(this._customAabb=value,this._model){var mi=this._model.meshInstances;if(mi)for(var i=0;i<mi.length;i++)mi[i].setCustomAabb(this._customAabb)}}},{key:"type",get:function get(){return this._type},set:function set(value){if(this._type!==value)if(this._area=null,this._type=value,"asset"===value)null!==this._asset?this._bindModelAsset(this._asset):this.model=null;else{var primData=getShapePrimitive(this.system.app.graphicsDevice,value);this._area=primData.area;var mesh=primData.mesh,node=new GraphNode,model=new Model;model.graph=node,model.meshInstances=[new MeshInstance(mesh,this._material,node)],this.model=model,this._asset=null}}},{key:"asset",get:function get(){return this._asset},set:function set(value){var assets=this.system.app.assets,_id=value;if(value instanceof Asset&&(_id=value.id),this._asset!==_id){if(this._asset){assets.off("add:"+this._asset,this._onModelAssetAdded,this);var _prev=assets.get(this._asset);_prev&&this._unbindModelAsset(_prev)}if(this._asset=_id,this._asset){var asset=assets.get(this._asset);asset?this._bindModelAsset(asset):(this.model=null,assets.on("add:"+this._asset,this._onModelAssetAdded,this))}else this.model=null}}},{key:"model",get:function get(){return this._model},set:function set(value){var i;if(this._model!==value&&(!value||!value._immutable)&&(this._model&&(this._model._immutable=!1,this.removeModelFromLayers(),this.entity.removeChild(this._model.getGraph()),delete this._model._entity,this._clonedModel&&(this._model.destroy(),this._clonedModel=!1)),this._model=value,this._model)){this._model._immutable=!0;var meshInstances=this._model.meshInstances;for(i=0;i<meshInstances.length;i++)meshInstances[i].castShadow=this._castShadows,meshInstances[i].receiveShadow=this._receiveShadows,meshInstances[i].isStatic=this._isStatic,meshInstances[i].setCustomAabb(this._customAabb);this.lightmapped=this._lightmapped,this.entity.addChild(this._model.graph),this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._model._entity=this.entity,this.entity.animation&&this.entity.animation.setModel(this._model),this.entity.anim&&(this.entity.anim.playing?this.entity.anim.rebind():this.entity.anim.resetStateGraph()),"asset"===this.type?this.mapping=this._mapping:this._unsetMaterialEvents()}}},{key:"lightmapped",get:function get(){return this._lightmapped},set:function set(value){if(value!==this._lightmapped&&(this._lightmapped=value,this._model))for(var mi=this._model.meshInstances,i=0;i<mi.length;i++)mi[i].setLightmapped(value)}},{key:"castShadows",get:function get(){return this._castShadows},set:function set(value){if(this._castShadows!==value){var layer,i,model=this._model;if(model){var layers=this.layers,scene=this.system.app.scene;if(this._castShadows&&!value)for(i=0;i<layers.length;i++)(layer=this.system.app.scene.layers.getLayerById(this.layers[i]))&&layer.removeShadowCasters(model.meshInstances);var meshInstances=model.meshInstances;for(i=0;i<meshInstances.length;i++)meshInstances[i].castShadow=value;if(!this._castShadows&&value)for(i=0;i<layers.length;i++)(layer=scene.layers.getLayerById(layers[i]))&&layer.addShadowCasters(model.meshInstances)}this._castShadows=value}}},{key:"receiveShadows",get:function get(){return this._receiveShadows},set:function set(value){if(this._receiveShadows!==value&&(this._receiveShadows=value,this._model))for(var meshInstances=this._model.meshInstances,i=0,len=meshInstances.length;i<len;i++)meshInstances[i].receiveShadow=value}},{key:"castShadowsLightmap",get:function get(){return this._castShadowsLightmap},set:function set(value){this._castShadowsLightmap=value}},{key:"lightmapSizeMultiplier",get:function get(){return this._lightmapSizeMultiplier},set:function set(value){this._lightmapSizeMultiplier=value}},{key:"isStatic",get:function get(){return this._isStatic},set:function set(value){var i,m;if(this._isStatic!==value&&(this._isStatic=value,this._model)){var rcv=this._model.meshInstances;for(i=0;i<rcv.length;i++)(m=rcv[i]).isStatic=value}}},{key:"layers",get:function get(){return this._layers},set:function set(value){var i,layer,layers=this.system.app.scene.layers;if(this.meshInstances)for(i=0;i<this._layers.length;i++)(layer=layers.getLayerById(this._layers[i]))&&layer.removeMeshInstances(this.meshInstances);for(this._layers.length=0,i=0;i<value.length;i++)this._layers[i]=value[i];if(this.enabled&&this.entity.enabled&&this.meshInstances)for(i=0;i<this._layers.length;i++)(layer=layers.getLayerById(this._layers[i]))&&layer.addMeshInstances(this.meshInstances)}},{key:"batchGroupId",get:function get(){return this._batchGroupId},set:function set(value){if(this._batchGroupId!==value){var batcher=this.system.app.batcher;this.entity.enabled&&this._batchGroupId>=0&&batcher.remove(BatchGroup.MODEL,this.batchGroupId,this.entity),this.entity.enabled&&value>=0&&batcher.insert(BatchGroup.MODEL,value,this.entity),value<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._batchGroupId=value}}},{key:"materialAsset",get:function get(){return this._materialAsset},set:function set(value){var _id=value;value instanceof Asset&&(_id=value.id);var assets=this.system.app.assets;if(_id!==this._materialAsset){if(this._materialAsset){assets.off("add:"+this._materialAsset,this._onMaterialAssetAdd,this);var _prev=assets.get(this._materialAsset);_prev&&this._unbindMaterialAsset(_prev)}if(this._materialAsset=_id,this._materialAsset){var asset=assets.get(this._materialAsset);asset?this._bindMaterialAsset(asset):(this._setMaterial(this.system.defaultMaterial),assets.on("add:"+this._materialAsset,this._onMaterialAssetAdd,this))}else this._setMaterial(this.system.defaultMaterial)}}},{key:"material",get:function get(){return this._material},set:function set(value){this._material!==value&&(this.materialAsset=null,this._setMaterial(value))}},{key:"mapping",get:function get(){return this._mapping},set:function set(value){if("asset"===this._type&&(this._unsetMaterialEvents(),value||(value={}),this._mapping=value,this._model))for(var meshInstances=this._model.meshInstances,modelAsset=this.asset?this.system.app.assets.get(this.asset):null,assetMapping=modelAsset?modelAsset.data.mapping:null,asset=null,i=0,len=meshInstances.length;i<len;i++)if(void 0!==value[i])value[i]?(asset=this.system.app.assets.get(value[i]),this._loadAndSetMeshInstanceMaterial(asset,meshInstances[i],i)):meshInstances[i].material=this.system.defaultMaterial;else if(assetMapping)if(assetMapping[i]&&(assetMapping[i].material||assetMapping[i].path)){if(void 0!==assetMapping[i].material)asset=this.system.app.assets.get(assetMapping[i].material);else if(void 0!==assetMapping[i].path){var url=this._getMaterialAssetUrl(assetMapping[i].path);url&&(asset=this.system.app.assets.getByUrl(url))}this._loadAndSetMeshInstanceMaterial(asset,meshInstances[i],i)}else meshInstances[i].material=this.system.defaultMaterial}}]),ModelComponent}(Component),ModelComponentData=function ModelComponentData(){this.enabled=!0},_schema$a=["enabled"],ModelComponentSystem=function(_ComponentSystem){function ModelComponentSystem(app){var _this;return(_this=_ComponentSystem.call(this,app)||this).id="model",_this.ComponentType=ModelComponent,_this.DataType=ModelComponentData,_this.schema=_schema$a,_this.defaultMaterial=app.scene.defaultMaterial,_this.on("beforeremove",_this.onRemove,_assertThisInitialized(_this)),_this}_inheritsLoose(ModelComponentSystem,_ComponentSystem);var _proto=ModelComponentSystem.prototype;return _proto.initializeComponentData=function initializeComponentData(component,_data,properties){properties=["material","materialAsset","asset","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","type","mapping","layers","isStatic","batchGroupId"],null!==_data.batchGroupId&&void 0!==_data.batchGroupId||(_data.batchGroupId=-1),_data.layers&&_data.layers.length&&(_data.layers=_data.layers.slice(0));for(var i=0;i<properties.length;i++)_data.hasOwnProperty(properties[i])&&(component[properties[i]]=_data[properties[i]]);_data.aabbCenter&&_data.aabbHalfExtents&&(component.customAabb=new BoundingBox(new Vec3(_data.aabbCenter),new Vec3(_data.aabbHalfExtents))),_ComponentSystem.prototype.initializeComponentData.call(this,component,_data,["enabled"])},_proto.cloneComponent=function cloneComponent(entity,clone){var data={type:entity.model.type,asset:entity.model.asset,castShadows:entity.model.castShadows,receiveShadows:entity.model.receiveShadows,castShadowsLightmap:entity.model.castShadowsLightmap,lightmapped:entity.model.lightmapped,lightmapSizeMultiplier:entity.model.lightmapSizeMultiplier,isStatic:entity.model.isStatic,enabled:entity.model.enabled,layers:entity.model.layers,batchGroupId:entity.model.batchGroupId,mapping:extend({},entity.model.mapping)},materialAsset=entity.model.materialAsset;materialAsset instanceof Asset||null==materialAsset||(materialAsset=this.app.assets.get(materialAsset));var material=entity.model.material;material&&material!==this.defaultMaterial&&materialAsset&&material!==materialAsset.resource||(data.materialAsset=materialAsset);var component=this.addComponent(clone,data);if(entity.model.model&&"asset"===entity.model.type&&!entity.model.asset&&(component.model=entity.model.model.clone(),component._clonedModel=!0),data.materialAsset||(component.material=material),entity.model.model)for(var meshInstances=entity.model.model.meshInstances,meshInstancesClone=component.model.meshInstances,i=0;i<meshInstances.length;i++)meshInstancesClone[i].mask=meshInstances[i].mask,meshInstancesClone[i].material=meshInstances[i].material,meshInstancesClone[i].layer=meshInstances[i].layer,meshInstancesClone[i].receiveShadow=meshInstances[i].receiveShadow;entity.model.customAabb&&(component.customAabb=entity.model.aabb.clone())},_proto.onRemove=function onRemove(entity,component){component.onRemove()},ModelComponentSystem}(ComponentSystem);Component._buildAccessors(ModelComponent.prototype,_schema$a);var SkinInstanceCachedObject=function(_RefCountedObject){function SkinInstanceCachedObject(skin,skinInstance){var _this;return(_this=_RefCountedObject.call(this)||this).skin=skin,_this.skinInstance=skinInstance,_this}return _inheritsLoose(SkinInstanceCachedObject,_RefCountedObject),SkinInstanceCachedObject}(RefCountedObject),RenderComponent=function(_Component){function RenderComponent(system,entity){var _this2;return(_this2=_Component.call(this,system,entity)||this)._type="asset",_this2._castShadows=!0,_this2._receiveShadows=!0,_this2._castShadowsLightmap=!0,_this2._lightmapped=!1,_this2._lightmapSizeMultiplier=1,_this2._isStatic=!1,_this2._batchGroupId=-1,_this2._meshInstances=[],_this2._layers=[0],_this2._renderStyle=0,_this2._customAabb=null,_this2._area=null,_this2._rootBone=new EntityReference(_assertThisInitialized(_this2),"rootBone"),_this2._rootBone.on("set:entity",_this2._onSetRootBone,_assertThisInitialized(_this2)),_this2._assetReference=new AssetReference("asset",_assertThisInitialized(_this2),system.app.assets,{add:_this2._onRenderAssetAdded,load:_this2._onRenderAssetLoad,remove:_this2._onRenderAssetRemove,unload:_this2._onRenderAssetUnload},_assertThisInitialized(_this2)),_this2._material=system.defaultMaterial,_this2._materialReferences=[],entity.on("remove",_this2.onRemoveChild,_assertThisInitialized(_this2)),entity.on("insert",_this2.onInsertChild,_assertThisInitialized(_this2)),_this2}_inheritsLoose(RenderComponent,_Component),RenderComponent.getCachedSkinInstance=function getCachedSkinInstance(skin,rootBone){var skinInstance=null,cachedObjArray=RenderComponent._skinInstanceCache.get(rootBone);if(cachedObjArray){var cachedObj=cachedObjArray.find((function(element){return element.skin===skin}));cachedObj&&(cachedObj.incRefCount(),skinInstance=cachedObj.skinInstance)}return skinInstance},RenderComponent.addCachedSkinInstance=function addCachedSkinInstance(skin,rootBone,skinInstance){var cachedObjArray=RenderComponent._skinInstanceCache.get(rootBone);cachedObjArray||(cachedObjArray=[],RenderComponent._skinInstanceCache.set(rootBone,cachedObjArray));var cachedObj=cachedObjArray.find((function(element){return element.skin===skin}));cachedObj||(cachedObj=new SkinInstanceCachedObject(skin,skinInstance),cachedObjArray.push(cachedObj)),cachedObj.incRefCount()},RenderComponent.removeCachedSkinInstance=function removeCachedSkinInstance(skinInstance){if(skinInstance){var rootBone=skinInstance.rootBone;if(rootBone){var cachedObjArray=RenderComponent._skinInstanceCache.get(rootBone);if(cachedObjArray){var cachedObjIndex=cachedObjArray.findIndex((function(element){return element.skinInstance===skinInstance}));if(cachedObjIndex>=0){var cachedObj=cachedObjArray[cachedObjIndex];cachedObj.decRefCount(),0===cachedObj.getRefCount()&&(cachedObjArray.splice(cachedObjIndex,1),cachedObjArray.length||RenderComponent._skinInstanceCache.delete(rootBone),skinInstance&&(skinInstance.destroy(),cachedObj.skinInstance=null))}}}}};var _proto=RenderComponent.prototype;return _proto._onSetRootBone=function _onSetRootBone(entity){entity&&this._onRootBoneChanged()},_proto._onRootBoneChanged=function _onRootBoneChanged(){this._clearSkinInstances(),this._cloneSkinInstances()},_proto.destroyMeshInstances=function destroyMeshInstances(){var meshInstances=this._meshInstances;if(meshInstances){this.removeFromLayers(),this._clearSkinInstances();for(var i=0;i<meshInstances.length;i++)meshInstances[i].destroy();this._meshInstances.length=0}},_proto.addToLayers=function addToLayers(){for(var layers=this.system.app.scene.layers,i=0;i<this._layers.length;i++){var layer=layers.getLayerById(this._layers[i]);layer&&layer.addMeshInstances(this._meshInstances)}},_proto.removeFromLayers=function removeFromLayers(){if(this._meshInstances&&this._meshInstances.length)for(var layer,layers=this.system.app.scene.layers,i=0;i<this._layers.length;i++)(layer=layers.getLayerById(this._layers[i]))&&layer.removeMeshInstances(this._meshInstances)},_proto.onRemoveChild=function onRemoveChild(){this.removeFromLayers()},_proto.onInsertChild=function onInsertChild(){this._meshInstances&&this.enabled&&this.entity.enabled&&this.addToLayers()},_proto.onRemove=function onRemove(){this.destroyMeshInstances(),this.asset=null,this.materialAsset=null,this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)},_proto.onLayersChanged=function onLayersChanged(oldComp,newComp){this.addToLayers(),oldComp.off("add",this.onLayerAdded,this),oldComp.off("remove",this.onLayerRemoved,this),newComp.on("add",this.onLayerAdded,this),newComp.on("remove",this.onLayerRemoved,this)},_proto.onLayerAdded=function onLayerAdded(layer){var index;this.layers.indexOf(layer.id)<0||layer.addMeshInstances(this._meshInstances)},_proto.onLayerRemoved=function onLayerRemoved(layer){var index;this.layers.indexOf(layer.id)<0||layer.removeMeshInstances(this._meshInstances)},_proto.onEnable=function onEnable(){var app=this.system.app,scene=app.scene;this._rootBone.onParentComponentEnable(),scene.on("set:layers",this.onLayersChanged,this),scene.layers&&(scene.layers.on("add",this.onLayerAdded,this),scene.layers.on("remove",this.onLayerRemoved,this));var isAsset="asset"===this._type;this._meshInstances&&this._meshInstances.length?this.addToLayers():isAsset&&this.asset&&this._onRenderAssetAdded();for(var i=0;i<this._materialReferences.length;i++)this._materialReferences[i].asset&&this.system.app.assets.load(this._materialReferences[i].asset);this._batchGroupId>=0&&app.batcher.insert(BatchGroup.RENDER,this.batchGroupId,this.entity)},_proto.onDisable=function onDisable(){var app=this.system.app,scene=app.scene;scene.off("set:layers",this.onLayersChanged,this),scene.layers&&(scene.layers.off("add",this.onLayerAdded,this),scene.layers.off("remove",this.onLayerRemoved,this)),this._batchGroupId>=0&&app.batcher.remove(BatchGroup.RENDER,this.batchGroupId,this.entity),this.removeFromLayers()},_proto.hide=function hide(){if(this._meshInstances)for(var i=0;i<this._meshInstances.length;i++)this._meshInstances[i].visible=!1},_proto.show=function show(){if(this._meshInstances)for(var i=0;i<this._meshInstances.length;i++)this._meshInstances[i].visible=!0},_proto._onRenderAssetAdded=function _onRenderAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onRenderAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))},_proto._onRenderAssetLoad=function _onRenderAssetLoad(){if(this.destroyMeshInstances(),this._assetReference.asset){var render=this._assetReference.asset.resource;render.off("set:meshes",this._onSetMeshes,this),render.on("set:meshes",this._onSetMeshes,this),render.meshes&&this._onSetMeshes(render.meshes)}},_proto._onSetMeshes=function _onSetMeshes(meshes){this._cloneMeshes(meshes)},_proto._clearSkinInstances=function _clearSkinInstances(){for(var i=0;i<this._meshInstances.length;i++){var meshInstance=this._meshInstances[i];RenderComponent.removeCachedSkinInstance(meshInstance.skinInstance),meshInstance.skinInstance=null}},_proto._cloneSkinInstances=function _cloneSkinInstances(){if(this._meshInstances.length&&this._rootBone.entity instanceof GraphNode)for(var j,skin,skinInst,i=0;i<this._meshInstances.length;i++){var meshInstance=this._meshInstances[i],mesh=meshInstance.mesh;if(mesh.skin&&!mesh.skinInstance){skin=mesh.skin;var rootBone=this._rootBone.entity;if(!(skinInst=RenderComponent.getCachedSkinInstance(skin,rootBone))){(skinInst=new SkinInstance(skin)).rootBone=rootBone,RenderComponent.addCachedSkinInstance(skin,rootBone,skinInst);var bones=[];for(j=0;j<skin.boneNames.length;j++){var boneName=skin.boneNames[j],bone=this._rootBone.entity.findByName(boneName);bone||(console.error("Failed to find bone ["+boneName+"] in the entity hierarchy, RenderComponent on "+this.entity.name+", rootBone: "+this._rootBone.entity.name),bone=this.entity),bones.push(bone)}skinInst.bones=bones}meshInstance.skinInstance=skinInst}}},_proto._cloneMeshes=function _cloneMeshes(meshes){if(meshes&&meshes.length){for(var meshInstances=[],i=0;i<meshes.length;i++){var mesh=meshes[i],material=this._materialReferences[i]&&this._materialReferences[i].asset&&this._materialReferences[i].asset.resource,meshInst=new MeshInstance(mesh,material||this.system.defaultMaterial,this.entity);meshInstances.push(meshInst),mesh.morph&&(meshInst.morphInstance=new MorphInstance(mesh.morph))}this.meshInstances=meshInstances,this._cloneSkinInstances()}},_proto._onRenderAssetUnload=function _onRenderAssetUnload(){"asset"===this._type&&this.destroyMeshInstances()},_proto._onRenderAssetRemove=function _onRenderAssetRemove(){this._assetReference.asset&&this._assetReference.asset.resource&&this._assetReference.asset.resource.off("set:meshes",this._onSetMeshes,this),this._onRenderAssetUnload()},_proto._onMaterialAdded=function _onMaterialAdded(index,component,asset){asset.resource?this._onMaterialLoad(index,component,asset):this.enabled&&this.entity.enabled&&this.system.app.assets.load(asset)},_proto._onMaterialLoad=function _onMaterialLoad(index,component,asset){this._meshInstances[index]&&(this._meshInstances[index].material=asset.resource)},_proto._onMaterialRemove=function _onMaterialRemove(index,component,asset){this._meshInstances[index]&&(this._meshInstances[index].material=this.system.defaultMaterial)},_proto._onMaterialUnload=function _onMaterialUnload(index,component,asset){this._meshInstances[index]&&(this._meshInstances[index].material=this.system.defaultMaterial)},_createClass(RenderComponent,[{key:"renderStyle",get:function get(){return this._renderStyle},set:function set(renderStyle){this._renderStyle!==renderStyle&&(this._renderStyle=renderStyle,MeshInstance._prepareRenderStyleForArray(this._meshInstances,renderStyle))}},{key:"customAabb",get:function get(){return this._customAabb},set:function set(value){this._customAabb=value;var mi=this._meshInstances;if(mi)for(var i=0;i<mi.length;i++)mi[i].setCustomAabb(this._customAabb)}},{key:"type",get:function get(){return this._type},set:function set(value){if(this._type!==value&&(this._area=null,this._type=value,this.destroyMeshInstances(),"asset"!==value)){var material=this._material;material&&material!==this.system.defaultMaterial||(material=this._materialReferences[0]&&this._materialReferences[0].asset&&this._materialReferences[0].asset.resource);var primData=getShapePrimitive(this.system.app.graphicsDevice,value);this._area=primData.area,this.meshInstances=[new MeshInstance(primData.mesh,material||this.system.defaultMaterial,this.entity)]}}},{key:"meshInstances",get:function get(){return this._meshInstances},set:function set(value){if(this.destroyMeshInstances(),this._meshInstances=value,this._meshInstances){for(var mi=this._meshInstances,i=0;i<mi.length;i++)mi[i].node||(mi[i].node=this.entity),mi[i].castShadow=this._castShadows,mi[i].receiveShadow=this._receiveShadows,mi[i].isStatic=this._isStatic,mi[i].renderStyle=this._renderStyle,mi[i].setLightmapped(this._lightmapped),mi[i].setCustomAabb(this._customAabb);this.enabled&&this.entity.enabled&&this.addToLayers()}}},{key:"lightmapped",get:function get(){return this._lightmapped},set:function set(value){if(value!==this._lightmapped){this._lightmapped=value;var mi=this._meshInstances;if(mi)for(var i=0;i<mi.length;i++)mi[i].setLightmapped(value)}}},{key:"castShadows",get:function get(){return this._castShadows},set:function set(value){if(this._castShadows!==value){var i,layer,mi=this._meshInstances;if(mi){var layers=this.layers,scene=this.system.app.scene;if(this._castShadows&&!value)for(i=0;i<layers.length;i++)(layer=scene.layers.getLayerById(this.layers[i]))&&layer.removeShadowCasters(mi);for(i=0;i<mi.length;i++)mi[i].castShadow=value;if(!this._castShadows&&value)for(i=0;i<layers.length;i++)(layer=scene.layers.getLayerById(layers[i]))&&layer.addShadowCasters(mi)}this._castShadows=value}}},{key:"receiveShadows",get:function get(){return this._receiveShadows},set:function set(value){if(this._receiveShadows!==value){this._receiveShadows=value;var mi=this._meshInstances;if(mi)for(var i=0;i<mi.length;i++)mi[i].receiveShadow=value}}},{key:"castShadowsLightmap",get:function get(){return this._castShadowsLightmap},set:function set(value){this._castShadowsLightmap=value}},{key:"lightmapSizeMultiplier",get:function get(){return this._lightmapSizeMultiplier},set:function set(value){this._lightmapSizeMultiplier=value}},{key:"isStatic",get:function get(){return this._isStatic},set:function set(value){if(this._isStatic!==value){this._isStatic=value;var mi=this._meshInstances;if(mi)for(var i=0;i<mi.length;i++)mi[i].isStatic=value}}},{key:"layers",get:function get(){return this._layers},set:function set(value){var i,layer,layers=this.system.app.scene.layers;if(this._meshInstances)for(i=0;i<this._layers.length;i++)(layer=layers.getLayerById(this._layers[i]))&&layer.removeMeshInstances(this._meshInstances);for(this._layers.length=0,i=0;i<value.length;i++)this._layers[i]=value[i];if(this.enabled&&this.entity.enabled&&this._meshInstances)for(i=0;i<this._layers.length;i++)(layer=layers.getLayerById(this._layers[i]))&&layer.addMeshInstances(this._meshInstances)}},{key:"batchGroupId",get:function get(){return this._batchGroupId},set:function set(value){if(this._batchGroupId!==value){var batcher=this.system.app.batcher;this.entity.enabled&&this._batchGroupId>=0&&batcher.remove(BatchGroup.RENDER,this.batchGroupId,this.entity),this.entity.enabled&&value>=0&&batcher.insert(BatchGroup.RENDER,value,this.entity),value<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addToLayers(),this._batchGroupId=value}}},{key:"material",get:function get(){return this._material},set:function set(value){if(this._material!==value&&(this._material=value,this._meshInstances&&"asset"!==this._type))for(var i=0;i<this._meshInstances.length;i++)this._meshInstances[i].material=value}},{key:"materialAssets",get:function get(){return this._materialReferences.map((function(ref){return ref.id}))},set:function set(value){var i;if(value=value||[],this._materialReferences.length>value.length){for(i=value.length;i<this._materialReferences.length;i++)this._materialReferences[i].id=null;this._materialReferences.length=value.length}for(i=0;i<value.length;i++)if(this._materialReferences[i]||this._materialReferences.push(new AssetReference(i,this,this.system.app.assets,{add:this._onMaterialAdded,load:this._onMaterialLoad,remove:this._onMaterialRemove,unload:this._onMaterialUnload},this)),value[i]){var id=value[i]instanceof Asset?value[i].id:value[i];this._materialReferences[i].id!==id&&(this._materialReferences[i].id=id),this._materialReferences[i].asset&&this._onMaterialAdded(i,this,this._materialReferences[i].asset)}else this._materialReferences[i].id=null,this._meshInstances[i]&&(this._meshInstances[i].material=this.system.defaultMaterial)}},{key:"asset",get:function get(){return this._assetReference.id},set:function set(value){var id=value instanceof Asset?value.id:value;this._assetReference.id!==id&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onRenderAssetRemove(),this._assetReference.id=id,this._assetReference.asset&&this._onRenderAssetAdded())}}]),RenderComponent}(Component);RenderComponent._skinInstanceCache=new Map;var RenderComponentData=function RenderComponentData(){this.enabled=!0,this.rootBone=null},_schema$9=[{name:"rootBone",type:"entity"},"enabled"],_properties=["material","meshInstances","asset","materialAssets","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","renderStyle","type","layers","isStatic","batchGroupId"],RenderComponentSystem=function(_ComponentSystem){function RenderComponentSystem(app){var _this;return(_this=_ComponentSystem.call(this,app)||this).id="render",_this.ComponentType=RenderComponent,_this.DataType=RenderComponentData,_this.schema=_schema$9,_this.defaultMaterial=app.scene.defaultMaterial,_this.on("beforeremove",_this.onRemove,_assertThisInitialized(_this)),_this}_inheritsLoose(RenderComponentSystem,_ComponentSystem);var _proto=RenderComponentSystem.prototype;return _proto.initializeComponentData=function initializeComponentData(component,_data,properties){null!==_data.batchGroupId&&void 0!==_data.batchGroupId||(_data.batchGroupId=-1),_data.layers&&_data.layers.length&&(_data.layers=_data.layers.slice(0));for(var i=0;i<_properties.length;i++)_data.hasOwnProperty(_properties[i])&&(component[_properties[i]]=_data[_properties[i]]);_data.aabbCenter&&_data.aabbHalfExtents&&(component.customAabb=new BoundingBox(new Vec3(_data.aabbCenter),new Vec3(_data.aabbHalfExtents))),_ComponentSystem.prototype.initializeComponentData.call(this,component,_data,_schema$9)},_proto.cloneComponent=function cloneComponent(entity,clone){for(var data={},i=0;i<_properties.length;i++)data[_properties[i]]=entity.render[_properties[i]];delete data.meshInstances;var component=this.addComponent(clone,data),srcMeshInstances=entity.render.meshInstances,meshes=srcMeshInstances.map((function(mi){return mi.mesh}));component._onSetMeshes(meshes);for(var m=0;m<srcMeshInstances.length;m++)component.meshInstances[m].material=srcMeshInstances[m].material;entity.render.customAabb&&(component.customAabb=entity.render.customAabb.clone())},_proto.onRemove=function onRemove(entity,component){component.onRemove()},RenderComponentSystem}(ComponentSystem);Component._buildAccessors(RenderComponent.prototype,_schema$9);var SIMPLE_PROPERTIES=["emitterExtents","emitterRadius","emitterExtentsInner","emitterRadiusInner","loop","initialVelocity","animSpeed","normalMap","particleNormal"],COMPLEX_PROPERTIES=["numParticles","lifetime","rate","rate2","startAngle","startAngle2","lighting","halfLambert","intensity","wrap","wrapBounds","depthWrite","noFog","sort","stretch","alignToMotion","preWarm","emitterShape","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animLoop","colorMap","localSpace","screenSpace","orientation"],GRAPH_PROPERTIES=["scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","velocityGraph","velocityGraph2","localVelocityGraph","localVelocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2"],ASSET_PROPERTIES=["colorMapAsset","normalMapAsset","meshAsset","renderAsset"],depthLayer,ParticleSystemComponent=function(_Component){function ParticleSystemComponent(system,entity){var _this;return(_this=_Component.call(this,system,entity)||this).on("set_colorMapAsset",_this.onSetColorMapAsset,_assertThisInitialized(_this)),_this.on("set_normalMapAsset",_this.onSetNormalMapAsset,_assertThisInitialized(_this)),_this.on("set_meshAsset",_this.onSetMeshAsset,_assertThisInitialized(_this)),_this.on("set_mesh",_this.onSetMesh,_assertThisInitialized(_this)),_this.on("set_renderAsset",_this.onSetRenderAsset,_assertThisInitialized(_this)),_this.on("set_loop",_this.onSetLoop,_assertThisInitialized(_this)),_this.on("set_blendType",_this.onSetBlendType,_assertThisInitialized(_this)),_this.on("set_depthSoftening",_this.onSetDepthSoftening,_assertThisInitialized(_this)),_this.on("set_layers",_this.onSetLayers,_assertThisInitialized(_this)),SIMPLE_PROPERTIES.forEach(function(prop){this.on("set_"+prop,this.onSetSimpleProperty,this)}.bind(_assertThisInitialized(_this))),COMPLEX_PROPERTIES.forEach(function(prop){this.on("set_"+prop,this.onSetComplexProperty,this)}.bind(_assertThisInitialized(_this))),GRAPH_PROPERTIES.forEach(function(prop){this.on("set_"+prop,this.onSetGraphProperty,this)}.bind(_assertThisInitialized(_this))),_this._requestedDepth=!1,_this._drawOrder=0,_this}_inheritsLoose(ParticleSystemComponent,_Component);var _proto=ParticleSystemComponent.prototype;return _proto.addModelToLayers=function addModelToLayers(){if(this.data.model)for(var layer,i=0;i<this.layers.length;i++)(layer=this.system.app.scene.layers.getLayerById(this.layers[i]))&&(layer.addMeshInstances(this.data.model.meshInstances),this.emitter._layer=layer)},_proto.removeModelFromLayers=function removeModelFromLayers(model){if(this.data.model)for(var layer,i=0;i<this.layers.length;i++)(layer=this.system.app.scene.layers.getLayerById(this.layers[i]))&&layer.removeMeshInstances(this.data.model.meshInstances)},_proto.onSetLayers=function onSetLayers(name,oldValue,newValue){if(this.data.model){var i,layer;for(i=0;i<oldValue.length;i++)(layer=this.system.app.scene.layers.getLayerById(oldValue[i]))&&layer.removeMeshInstances(this.data.model.meshInstances);if(this.enabled&&this.entity.enabled)for(i=0;i<newValue.length;i++)(layer=this.system.app.scene.layers.getLayerById(newValue[i]))&&layer.addMeshInstances(this.data.model.meshInstances)}},_proto.onLayersChanged=function onLayersChanged(oldComp,newComp){this.addModelToLayers(),oldComp.off("add",this.onLayerAdded,this),oldComp.off("remove",this.onLayerRemoved,this),newComp.on("add",this.onLayerAdded,this),newComp.on("remove",this.onLayerRemoved,this)},_proto.onLayerAdded=function onLayerAdded(layer){var index;this.data.model&&(this.layers.indexOf(layer.id)<0||layer.addMeshInstances(this.data.model.meshInstances))},_proto.onLayerRemoved=function onLayerRemoved(layer){var index;this.data.model&&(this.layers.indexOf(layer.id)<0||layer.removeMeshInstances(this.data.model.meshInstances))},_proto._bindColorMapAsset=function _bindColorMapAsset(asset){if(asset.on("load",this._onColorMapAssetLoad,this),asset.on("unload",this._onColorMapAssetUnload,this),asset.on("remove",this._onColorMapAssetRemove,this),asset.on("change",this._onColorMapAssetChange,this),asset.resource)this._onColorMapAssetLoad(asset);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(asset)}},_proto._unbindColorMapAsset=function _unbindColorMapAsset(asset){asset.off("load",this._onColorMapAssetLoad,this),asset.off("unload",this._onColorMapAssetUnload,this),asset.off("remove",this._onColorMapAssetRemove,this),asset.off("change",this._onColorMapAssetChange,this)},_proto._onColorMapAssetLoad=function _onColorMapAssetLoad(asset){this.colorMap=asset.resource},_proto._onColorMapAssetUnload=function _onColorMapAssetUnload(asset){this.colorMap=null},_proto._onColorMapAssetRemove=function _onColorMapAssetRemove(asset){this._onColorMapAssetUnload(asset)},_proto._onColorMapAssetChange=function _onColorMapAssetChange(asset){},_proto.onSetColorMapAsset=function onSetColorMapAsset(name,oldValue,newValue){var self=this,asset,assets=this.system.app.assets;oldValue&&(asset=assets.get(oldValue))&&this._unbindColorMapAsset(asset),newValue?(newValue instanceof Asset&&(this.data.colorMapAsset=newValue.id,newValue=newValue.id),(asset=assets.get(newValue))?self._bindColorMapAsset(asset):assets.once("add:"+newValue,(function(asset){self._bindColorMapAsset(asset)}))):this.colorMap=null},_proto._bindNormalMapAsset=function _bindNormalMapAsset(asset){if(asset.on("load",this._onNormalMapAssetLoad,this),asset.on("unload",this._onNormalMapAssetUnload,this),asset.on("remove",this._onNormalMapAssetRemove,this),asset.on("change",this._onNormalMapAssetChange,this),asset.resource)this._onNormalMapAssetLoad(asset);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(asset)}},_proto._unbindNormalMapAsset=function _unbindNormalMapAsset(asset){asset.off("load",this._onNormalMapAssetLoad,this),asset.off("unload",this._onNormalMapAssetUnload,this),asset.off("remove",this._onNormalMapAssetRemove,this),asset.off("change",this._onNormalMapAssetChange,this)},_proto._onNormalMapAssetLoad=function _onNormalMapAssetLoad(asset){this.normalMap=asset.resource},_proto._onNormalMapAssetUnload=function _onNormalMapAssetUnload(asset){this.normalMap=null},_proto._onNormalMapAssetRemove=function _onNormalMapAssetRemove(asset){this._onNormalMapAssetUnload(asset)},_proto._onNormalMapAssetChange=function _onNormalMapAssetChange(asset){},_proto.onSetNormalMapAsset=function onSetNormalMapAsset(name,oldValue,newValue){var self=this,asset,assets=this.system.app.assets;oldValue&&(asset=assets.get(oldValue))&&this._unbindNormalMapAsset(asset),newValue?(newValue instanceof Asset&&(this.data.normalMapAsset=newValue.id,newValue=newValue.id),(asset=assets.get(newValue))?self._bindNormalMapAsset(asset):assets.once("add:"+newValue,(function(asset){self._bindNormalMapAsset(asset)}))):this.normalMap=null},_proto._bindMeshAsset=function _bindMeshAsset(asset){if(asset.on("load",this._onMeshAssetLoad,this),asset.on("unload",this._onMeshAssetUnload,this),asset.on("remove",this._onMeshAssetRemove,this),asset.on("change",this._onMeshAssetChange,this),asset.resource)this._onMeshAssetLoad(asset);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(asset)}},_proto._unbindMeshAsset=function _unbindMeshAsset(asset){asset.off("load",this._onMeshAssetLoad,this),asset.off("unload",this._onMeshAssetUnload,this),asset.off("remove",this._onMeshAssetRemove,this),asset.off("change",this._onMeshAssetChange,this)},_proto._onMeshAssetLoad=function _onMeshAssetLoad(asset){this._onMeshChanged(asset.resource)},_proto._onMeshAssetUnload=function _onMeshAssetUnload(asset){this.mesh=null},_proto._onMeshAssetRemove=function _onMeshAssetRemove(asset){this._onMeshAssetUnload(asset)},_proto._onMeshAssetChange=function _onMeshAssetChange(asset){},_proto.onSetMeshAsset=function onSetMeshAsset(name,oldValue,newValue){var asset,assets=this.system.app.assets;oldValue&&(asset=assets.get(oldValue))&&this._unbindMeshAsset(asset),newValue?(newValue instanceof Asset&&(this.data.meshAsset=newValue.id,newValue=newValue.id),(asset=assets.get(newValue))&&this._bindMeshAsset(asset)):this._onMeshChanged(null)},_proto.onSetMesh=function onSetMesh(name,oldValue,newValue){!newValue||newValue instanceof Asset||"number"==typeof newValue?this.meshAsset=newValue:this._onMeshChanged(newValue)},_proto._onMeshChanged=function _onMeshChanged(mesh){!mesh||mesh instanceof Mesh||(mesh=mesh.meshInstances[0]?mesh.meshInstances[0].mesh:null),this.data.mesh=mesh,this.emitter&&(this.emitter.mesh=mesh,this.emitter.resetMaterial(),this.rebuild())},_proto.onSetRenderAsset=function onSetRenderAsset(name,oldValue,newValue){var asset,assets=this.system.app.assets;oldValue&&(asset=assets.get(oldValue))&&this._unbindRenderAsset(asset),newValue?(newValue instanceof Asset&&(this.data.renderAsset=newValue.id,newValue=newValue.id),(asset=assets.get(newValue))&&this._bindRenderAsset(asset)):this._onRenderChanged(null)},_proto._bindRenderAsset=function _bindRenderAsset(asset){if(asset.on("load",this._onRenderAssetLoad,this),asset.on("unload",this._onRenderAssetUnload,this),asset.on("remove",this._onRenderAssetRemove,this),asset.resource)this._onRenderAssetLoad(asset);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(asset)}},_proto._unbindRenderAsset=function _unbindRenderAsset(asset){asset.off("load",this._onRenderAssetLoad,this),asset.off("unload",this._onRenderAssetUnload,this),asset.off("remove",this._onRenderAssetRemove,this),asset.resource&&asset.resource.off("set:meshes",this._onRenderSetMeshes,this)},_proto._onRenderAssetLoad=function _onRenderAssetLoad(asset){this._onRenderChanged(asset.resource)},_proto._onRenderAssetUnload=function _onRenderAssetUnload(asset){this._onRenderChanged(null)},_proto._onRenderAssetRemove=function _onRenderAssetRemove(asset){this._onRenderAssetUnload(asset)},_proto._onRenderChanged=function _onRenderChanged(render){render?(render.off("set:meshes",this._onRenderSetMeshes,this),render.on("set:meshes",this._onRenderSetMeshes,this),render.meshes&&this._onRenderSetMeshes(render.meshes)):this._onMeshChanged(null)},_proto._onRenderSetMeshes=function _onRenderSetMeshes(meshes){this._onMeshChanged(meshes&&meshes[0])},_proto.onSetLoop=function onSetLoop(name,oldValue,newValue){this.emitter&&(this.emitter[name]=newValue,this.emitter.resetTime())},_proto.onSetBlendType=function onSetBlendType(name,oldValue,newValue){this.emitter&&(this.emitter[name]=newValue,this.emitter.material.blendType=newValue,this.emitter.resetMaterial(),this.rebuild())},_proto._requestDepth=function _requestDepth(){this._requestedDepth||(depthLayer||(depthLayer=this.system.app.scene.layers.getLayerById(1)),depthLayer&&(depthLayer.incrementCounter(),this._requestedDepth=!0))},_proto._releaseDepth=function _releaseDepth(){this._requestedDepth&&depthLayer&&(depthLayer.decrementCounter(),this._requestedDepth=!1)},_proto.onSetDepthSoftening=function onSetDepthSoftening(name,oldValue,newValue){oldValue!==newValue&&(newValue?(this.enabled&&this.entity.enabled&&this._requestDepth(),this.emitter&&(this.emitter[name]=newValue)):(this.enabled&&this.entity.enabled&&this._releaseDepth(),this.emitter&&(this.emitter[name]=newValue)),this.emitter&&(this.reset(),this.emitter.resetMaterial(),this.rebuild()))},_proto.onSetSimpleProperty=function onSetSimpleProperty(name,oldValue,newValue){this.emitter&&(this.emitter[name]=newValue,this.emitter.resetMaterial())},_proto.onSetComplexProperty=function onSetComplexProperty(name,oldValue,newValue){this.emitter&&(this.emitter[name]=newValue,this.emitter.resetMaterial(),this.rebuild(),this.reset())},_proto.onSetGraphProperty=function onSetGraphProperty(name,oldValue,newValue){this.emitter&&(this.emitter[name]=newValue,this.emitter.rebuildGraphs(),this.emitter.resetMaterial())},_proto.onEnable=function onEnable(){for(var data=this.data,i=0,len=ASSET_PROPERTIES.length;i<len;i++){var asset=data[ASSET_PROPERTIES[i]];if(asset){if(!(asset instanceof Asset)){var id;if(!(parseInt(asset,10)>=0))continue;asset=this.system.app.assets.get(asset)}asset&&!asset.resource&&this.system.app.assets.load(asset)}}if(!this.emitter){var mesh=data.mesh;mesh instanceof Mesh||(mesh=null),this.emitter=new ParticleEmitter(this.system.app.graphicsDevice,{numParticles:data.numParticles,emitterExtents:data.emitterExtents,emitterExtentsInner:data.emitterExtentsInner,emitterRadius:data.emitterRadius,emitterRadiusInner:data.emitterRadiusInner,emitterShape:data.emitterShape,initialVelocity:data.initialVelocity,wrap:data.wrap,localSpace:data.localSpace,screenSpace:data.screenSpace,wrapBounds:data.wrapBounds,lifetime:data.lifetime,rate:data.rate,rate2:data.rate2,orientation:data.orientation,particleNormal:data.particleNormal,animTilesX:data.animTilesX,animTilesY:data.animTilesY,animStartFrame:data.animStartFrame,animNumFrames:data.animNumFrames,animNumAnimations:data.animNumAnimations,animIndex:data.animIndex,randomizeAnimIndex:data.randomizeAnimIndex,animSpeed:data.animSpeed,animLoop:data.animLoop,startAngle:data.startAngle,startAngle2:data.startAngle2,scaleGraph:data.scaleGraph,scaleGraph2:data.scaleGraph2,colorGraph:data.colorGraph,colorGraph2:data.colorGraph2,alphaGraph:data.alphaGraph,alphaGraph2:data.alphaGraph2,localVelocityGraph:data.localVelocityGraph,localVelocityGraph2:data.localVelocityGraph2,velocityGraph:data.velocityGraph,velocityGraph2:data.velocityGraph2,rotationSpeedGraph:data.rotationSpeedGraph,rotationSpeedGraph2:data.rotationSpeedGraph2,radialSpeedGraph:data.radialSpeedGraph,radialSpeedGraph2:data.radialSpeedGraph2,colorMap:data.colorMap,normalMap:data.normalMap,loop:data.loop,preWarm:data.preWarm,sort:data.sort,stretch:data.stretch,alignToMotion:data.alignToMotion,lighting:data.lighting,halfLambert:data.halfLambert,intensity:data.intensity,depthSoftening:data.depthSoftening,scene:this.system.app.scene,mesh:mesh,depthWrite:data.depthWrite,noFog:data.noFog,node:this.entity,blendType:data.blendType}),this.emitter.meshInstance.node=this.entity,this.emitter.drawOrder=this.drawOrder,this.psys=new Model,this.psys.graph=this.entity,this.psys.emitter=this.emitter,this.psys.meshInstances=[this.emitter.meshInstance],data.model=this.psys,this.emitter.psys=this.psys,data.autoPlay||(this.pause(),this.emitter.meshInstance.visible=!1)}data.model&&this.emitter.colorMap&&this.addModelToLayers(),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&data.depthSoftening&&this._requestDepth()},_proto.onDisable=function onDisable(){this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.data.model&&(this.removeModelFromLayers(),this.data.depthSoftening&&this._releaseDepth()),this.emitter&&(this.emitter.camera=null)},_proto.onBeforeRemove=function onBeforeRemove(){this.enabled&&(this.enabled=!1);var data=this.data;data.model&&(this.entity.removeChild(data.model.getGraph()),data.model.destroy(),data.model=null),this.emitter&&(this.emitter.destroy(),this.emitter=null);for(var i=0;i<ASSET_PROPERTIES.length;i++){var prop=ASSET_PROPERTIES[i];data[prop]&&(this[prop]=null)}this.off()},_proto.reset=function reset(){this.emitter&&this.emitter.reset()},_proto.stop=function stop(){this.emitter&&(this.emitter.loop=!1,this.emitter.resetTime(),this.emitter.addTime(0,!0))},_proto.pause=function pause(){this.data.paused=!0},_proto.unpause=function unpause(){this.data.paused=!1},_proto.play=function play(){this.data.paused=!1,this.emitter&&(this.emitter.meshInstance.visible=!0,this.emitter.loop=this.data.loop,this.emitter.resetTime())},_proto.isPlaying=function isPlaying(){return!this.data.paused&&(!(!this.emitter||!this.emitter.loop)||Date.now()<=this.emitter.endTime)},_proto.rebuild=function rebuild(){var enabled=this.enabled;this.enabled=!1,this.emitter&&(this.emitter.rebuild(),this.emitter.meshInstance.node=this.entity,this.data.model.meshInstances=[this.emitter.meshInstance]),this.enabled=enabled},_createClass(ParticleSystemComponent,[{key:"drawOrder",get:function get(){return this._drawOrder},set:function set(drawOrder){this._drawOrder=drawOrder,this.emitter&&(this.emitter.drawOrder=drawOrder)}}]),ParticleSystemComponent}(Component),ParticleSystemComponentData=function ParticleSystemComponentData(){this.numParticles=1,this.rate=1,this.rate2=null,this.startAngle=0,this.startAngle2=null,this.lifetime=50,this.emitterExtents=new Vec3,this.emitterExtentsInner=new Vec3,this.emitterRadius=0,this.emitterRadiusInner=0,this.emitterShape=0,this.initialVelocity=0,this.wrapBounds=new Vec3,this.localSpace=!1,this.screenSpace=!1,this.colorMap=null,this.colorMapAsset=null,this.normalMap=null,this.normalMapAsset=null,this.loop=!0,this.preWarm=!1,this.sort=0,this.mode=0,this.scene=null,this.lighting=!1,this.halfLambert=!1,this.intensity=1,this.stretch=0,this.alignToMotion=!1,this.depthSoftening=0,this.meshAsset=null,this.mesh=null,this.depthWrite=!1,this.noFog=!1,this.orientation=0,this.particleNormal=new Vec3(0,1,0),this.animTilesX=1,this.animTilesY=1,this.animStartFrame=0,this.animNumFrames=1,this.animNumAnimations=1,this.animIndex=0,this.randomizeAnimIndex=!1,this.animSpeed=1,this.animLoop=!0,this.scaleGraph=null,this.scaleGraph2=null,this.colorGraph=null,this.colorGraph2=null,this.alphaGraph=null,this.alphaGraph2=null,this.localVelocityGraph=null,this.localVelocityGraph2=null,this.velocityGraph=null,this.velocityGraph2=null,this.rotationSpeedGraph=null,this.rotationSpeedGraph2=null,this.radialSpeedGraph=null,this.radialSpeedGraph2=null,this.blendType=2,this.model=null,this.enabled=!0,this.paused=!1,this.autoPlay=!0,this.layers=[0]},_schema$8=["enabled","autoPlay","numParticles","lifetime","rate","rate2","startAngle","startAngle2","loop","preWarm","lighting","halfLambert","intensity","depthWrite","noFog","depthSoftening","sort","blendType","stretch","alignToMotion","emitterShape","emitterExtents","emitterExtentsInner","emitterRadius","emitterRadiusInner","initialVelocity","wrap","wrapBounds","localSpace","screenSpace","colorMapAsset","normalMapAsset","mesh","meshAsset","renderAsset","orientation","particleNormal","localVelocityGraph","localVelocityGraph2","velocityGraph","velocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2","scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","colorMap","normalMap","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animSpeed","animLoop","layers"],ParticleSystemComponentSystem=function(_ComponentSystem){function ParticleSystemComponentSystem(app){var _this;return(_this=_ComponentSystem.call(this,app)||this).id="particlesystem",_this.ComponentType=ParticleSystemComponent,_this.DataType=ParticleSystemComponentData,_this.schema=_schema$8,_this.propertyTypes={emitterExtents:"vec3",emitterExtentsInner:"vec3",particleNormal:"vec3",wrapBounds:"vec3",localVelocityGraph:"curveset",localVelocityGraph2:"curveset",velocityGraph:"curveset",velocityGraph2:"curveset",colorGraph:"curveset",colorGraph2:"curveset",alphaGraph:"curve",alphaGraph2:"curve",rotationSpeedGraph:"curve",rotationSpeedGraph2:"curve",radialSpeedGraph:"curve",radialSpeedGraph2:"curve",scaleGraph:"curve",scaleGraph2:"curve"},_this.on("beforeremove",_this.onBeforeRemove,_assertThisInitialized(_this)),ComponentSystem.bind("update",_this.onUpdate,_assertThisInitialized(_this)),_this}_inheritsLoose(ParticleSystemComponentSystem,_ComponentSystem);var _proto=ParticleSystemComponentSystem.prototype;return _proto.initializeComponentData=function initializeComponentData(component,_data,properties){var data={};properties=[];var types=this.propertyTypes,t;for(var prop in(_data.mesh instanceof Asset||"number"==typeof _data.mesh)&&(_data.meshAsset=_data.mesh,delete _data.mesh),_data)_data.hasOwnProperty(prop)&&(properties.push(prop),data[prop]=_data[prop]),"vec3"===types[prop]?Array.isArray(data[prop])&&(data[prop]=new Vec3(data[prop][0],data[prop][1],data[prop][2])):"curve"===types[prop]?data[prop]instanceof Curve||(t=data[prop].type,data[prop]=new Curve(data[prop].keys),data[prop].type=t):"curveset"===types[prop]&&(data[prop]instanceof CurveSet||(t=data[prop].type,data[prop]=new CurveSet(data[prop].keys),data[prop].type=t)),data.layers&&Array.isArray(data.layers)&&(data.layers=data.layers.slice(0));_ComponentSystem.prototype.initializeComponentData.call(this,component,data,properties)},_proto.cloneComponent=function cloneComponent(entity,clone){for(var source=entity.particlesystem.data,schema=this.schema,data={},i=0,len=schema.length;i<len;i++){var prop=schema[i],sourceProp=source[prop];sourceProp instanceof Vec3||sourceProp instanceof Curve||sourceProp instanceof CurveSet?(sourceProp=sourceProp.clone(),data[prop]=sourceProp):"layers"===prop?data.layers=source.layers.slice(0):null!=sourceProp&&(data[prop]=sourceProp)}return this.addComponent(clone,data)},_proto.onUpdate=function onUpdate(dt){var components=this.store,numSteps,i,j,c,stats=this.app.stats.particles;for(var id in components)if(components.hasOwnProperty(id)){var entity=(c=components[id]).entity,data=c.data;if(data.enabled&&entity.enabled){var emitter=data.model.emitter;if(!emitter.meshInstance.visible)continue;if(emitter.lighting){var layer,lightCube,layers=data.layers;for(i=0;i<layers.length;i++)if(layer=this.app.scene.layers.getLayerById(layers[i])){for(layer._lightCube||(layer._lightCube=new Float32Array(18)),lightCube=layer._lightCube,i=0;i<6;i++)lightCube[3*i]=this.app.scene.ambientLight.r,lightCube[3*i+1]=this.app.scene.ambientLight.g,lightCube[3*i+2]=this.app.scene.ambientLight.b;var dirs=layer._splitLights[0];for(j=0;j<dirs.length;j++)for(c=0;c<6;c++){var weight=Math.max(emitter.lightCubeDir[c].dot(dirs[j]._direction),0)*dirs[j]._intensity;lightCube[3*c]+=dirs[j]._color.r*weight,lightCube[3*c+1]+=dirs[j]._color.g*weight,lightCube[3*c+2]+=dirs[j]._color.b*weight}}emitter.constantLightCube.setValue(lightCube)}if(!data.paused){if(emitter.simTime+=dt,emitter.simTime>emitter.fixedTimeStep&&(numSteps=Math.floor(emitter.simTime/emitter.fixedTimeStep),emitter.simTime-=numSteps*emitter.fixedTimeStep),numSteps){for(numSteps=Math.min(numSteps,emitter.maxSubSteps),i=0;i<numSteps;i++)emitter.addTime(emitter.fixedTimeStep,!1);stats._updatesPerFrame+=numSteps,stats._frameTime+=emitter._addTimeTime,emitter._addTimeTime=0}emitter.finishFrame()}}}},_proto.onBeforeRemove=function onBeforeRemove(entity,component){component.onBeforeRemove()},ParticleSystemComponentSystem}(ComponentSystem);Component._buildAccessors(ParticleSystemComponent.prototype,_schema$8);var ObjectPool=function(){function ObjectPool(constructorFunc,size){this._constructor=constructorFunc,this._pool=[],this._count=0,this._resize(size)}var _proto=ObjectPool.prototype;return _proto._resize=function _resize(size){if(size>this._pool.length)for(var i=this._pool.length;i<size;i++)this._pool[i]=new this._constructor},_proto.allocate=function allocate(){return this._count>=this._pool.length&&this._resize(2*this._pool.length),this._pool[this._count++]},_proto.freeAll=function freeAll(){this._count=0},ObjectPool}(),ammoTransform,ammoVec1,ammoVec2,ammoQuat,ammoOrigin,RigidBodyComponent=function(_Component){function RigidBodyComponent(system,entity){var _this;return _this=_Component.call(this,system,entity)||this,"undefined"==typeof Ammo||ammoTransform||(ammoTransform=new Ammo.btTransform,ammoVec1=new Ammo.btVector3,ammoVec2=new Ammo.btVector3,ammoQuat=new Ammo.btQuaternion,ammoOrigin=new Ammo.btVector3(0,0,0)),_this._angularDamping=0,_this._angularFactor=new Vec3(1,1,1),_this._angularVelocity=new Vec3,_this._body=null,_this._friction=.5,_this._group=2,_this._linearDamping=0,_this._linearFactor=new Vec3(1,1,1),_this._linearVelocity=new Vec3,_this._mask=65533,_this._mass=1,_this._restitution=0,_this._rollingFriction=0,_this._simulationEnabled=!1,_this._type="static",_this}_inheritsLoose(RigidBodyComponent,_Component);var _proto=RigidBodyComponent.prototype;return _proto.createBody=function createBody(){var entity=this.entity,shape;if(entity.collision&&(shape=entity.collision.shape,entity.trigger&&(entity.trigger.destroy(),delete entity.trigger)),shape){this._body&&this.system.onRemove(entity,this);var mass="dynamic"===this._type?this._mass:0;this._getEntityTransform(ammoTransform);var body=this.system.createBody(mass,shape,ammoTransform);if(body.setRestitution(this._restitution),body.setFriction(this._friction),body.setRollingFriction(this._rollingFriction),body.setDamping(this._linearDamping,this._angularDamping),"dynamic"===this._type){var linearFactor=this._linearFactor;ammoVec1.setValue(linearFactor.x,linearFactor.y,linearFactor.z),body.setLinearFactor(ammoVec1);var angularFactor=this._angularFactor;ammoVec1.setValue(angularFactor.x,angularFactor.y,angularFactor.z),body.setAngularFactor(ammoVec1)}else"kinematic"===this._type&&(body.setCollisionFlags(2|body.getCollisionFlags()),body.setActivationState(4));body.entity=entity,this.body=body,this.enabled&&entity.enabled&&this.enableSimulation()}},_proto.isActive=function isActive(){return!!this._body&&this._body.isActive()},_proto.activate=function activate(){this._body&&this._body.activate()},_proto.enableSimulation=function enableSimulation(){var entity=this.entity;if(entity.collision&&entity.collision.enabled&&!this._simulationEnabled){var body=this._body;if(body){switch(this.system.addBody(body,this._group,this._mask),this._type){case"dynamic":this.system._dynamic.push(this),body.forceActivationState(1),this.syncEntityToBody();break;case"kinematic":this.system._kinematic.push(this),body.forceActivationState(4);break;case"static":body.forceActivationState(1),this.syncEntityToBody()}"compound"===entity.collision.type&&this.system._compounds.push(entity.collision),body.activate(),this._simulationEnabled=!0}}},_proto.disableSimulation=function disableSimulation(){var body=this._body;if(body&&this._simulationEnabled){var system=this.system,idx=system._compounds.indexOf(this.entity.collision);idx>-1&&system._compounds.splice(idx,1),(idx=system._dynamic.indexOf(this))>-1&&system._dynamic.splice(idx,1),(idx=system._kinematic.indexOf(this))>-1&&system._kinematic.splice(idx,1),system.removeBody(body),body.forceActivationState(5),this._simulationEnabled=!1}},_proto.applyForce=function applyForce(){var x,y,z,px,py,pz;switch(arguments.length){case 1:x=arguments[0].x,y=arguments[0].y,z=arguments[0].z;break;case 2:x=arguments[0].x,y=arguments[0].y,z=arguments[0].z,px=arguments[1].x,py=arguments[1].y,pz=arguments[1].z;break;case 3:x=arguments[0],y=arguments[1],z=arguments[2];break;case 6:x=arguments[0],y=arguments[1],z=arguments[2],px=arguments[3],py=arguments[4],pz=arguments[5]}var body=this._body;body&&(body.activate(),ammoVec1.setValue(x,y,z),void 0!==px?(ammoVec2.setValue(px,py,pz),body.applyForce(ammoVec1,ammoVec2)):body.applyForce(ammoVec1,ammoOrigin))},_proto.applyTorque=function applyTorque(){var x,y,z;switch(arguments.length){case 1:x=arguments[0].x,y=arguments[0].y,z=arguments[0].z;break;case 3:x=arguments[0],y=arguments[1],z=arguments[2];break;default:return}var body=this._body;body&&(body.activate(),ammoVec1.setValue(x,y,z),body.applyTorque(ammoVec1))},_proto.applyImpulse=function applyImpulse(){var x,y,z,px,py,pz;switch(arguments.length){case 1:x=arguments[0].x,y=arguments[0].y,z=arguments[0].z;break;case 2:x=arguments[0].x,y=arguments[0].y,z=arguments[0].z,px=arguments[1].x,py=arguments[1].y,pz=arguments[1].z;break;case 3:x=arguments[0],y=arguments[1],z=arguments[2];break;case 6:x=arguments[0],y=arguments[1],z=arguments[2],px=arguments[3],py=arguments[4],pz=arguments[5];break;default:return}var body=this._body;body&&(body.activate(),ammoVec1.setValue(x,y,z),void 0!==px?(ammoVec2.setValue(px,py,pz),body.applyImpulse(ammoVec1,ammoVec2)):body.applyImpulse(ammoVec1,ammoOrigin))},_proto.applyTorqueImpulse=function applyTorqueImpulse(){var x,y,z;switch(arguments.length){case 1:x=arguments[0].x,y=arguments[0].y,z=arguments[0].z;break;case 3:x=arguments[0],y=arguments[1],z=arguments[2];break;default:return}var body=this._body;body&&(body.activate(),ammoVec1.setValue(x,y,z),body.applyTorqueImpulse(ammoVec1))},_proto.isStatic=function isStatic(){return"static"===this._type},_proto.isStaticOrKinematic=function isStaticOrKinematic(){return"static"===this._type||"kinematic"===this._type},_proto.isKinematic=function isKinematic(){return"kinematic"===this._type},_proto._getEntityTransform=function _getEntityTransform(transform){var entity=this.entity,pos=entity.getPosition(),rot=entity.getRotation();ammoVec1.setValue(pos.x,pos.y,pos.z),ammoQuat.setValue(rot.x,rot.y,rot.z,rot.w),transform.setOrigin(ammoVec1),transform.setRotation(ammoQuat)},_proto.syncEntityToBody=function syncEntityToBody(){var body=this._body;if(body){if(this._getEntityTransform(ammoTransform),body.setWorldTransform(ammoTransform),"kinematic"===this._type){var motionState=body.getMotionState();motionState&&motionState.setWorldTransform(ammoTransform)}body.activate()}},_proto._updateDynamic=function _updateDynamic(){var body=this._body;if(body.isActive()){var motionState=body.getMotionState();if(motionState){motionState.getWorldTransform(ammoTransform);var p=ammoTransform.getOrigin(),q=ammoTransform.getRotation();this.entity.setPosition(p.x(),p.y(),p.z()),this.entity.setRotation(q.x(),q.y(),q.z(),q.w())}}},_proto._updateKinematic=function _updateKinematic(){var motionState=this._body.getMotionState();motionState&&(this._getEntityTransform(ammoTransform),motionState.setWorldTransform(ammoTransform))},_proto.teleport=function teleport(){arguments.length<3?(arguments[0]&&this.entity.setPosition(arguments[0]),arguments[1]&&(arguments[1]instanceof Quat?this.entity.setRotation(arguments[1]):this.entity.setEulerAngles(arguments[1]))):(6===arguments.length&&this.entity.setEulerAngles(arguments[3],arguments[4],arguments[5]),this.entity.setPosition(arguments[0],arguments[1],arguments[2])),this.syncEntityToBody()},_proto.onEnable=function onEnable(){this._body||this.createBody(),this.enableSimulation()},_proto.onDisable=function onDisable(){this.disableSimulation()},_createClass(RigidBodyComponent,[{key:"angularDamping",get:function get(){return this._angularDamping},set:function set(damping){this._angularDamping!==damping&&(this._angularDamping=damping,this._body&&this._body.setDamping(this._linearDamping,damping))}},{key:"angularFactor",get:function get(){return this._angularFactor},set:function set(factor){this._angularFactor.equals(factor)||(this._angularFactor.copy(factor),this._body&&"dynamic"===this._type&&(ammoVec1.setValue(factor.x,factor.y,factor.z),this._body.setAngularFactor(ammoVec1)))}},{key:"angularVelocity",get:function get(){if(this._body&&"dynamic"===this._type){var velocity=this._body.getAngularVelocity();this._angularVelocity.set(velocity.x(),velocity.y(),velocity.z())}return this._angularVelocity},set:function set(velocity){this._body&&"dynamic"===this._type&&(this._body.activate(),ammoVec1.setValue(velocity.x,velocity.y,velocity.z),this._body.setAngularVelocity(ammoVec1),this._angularVelocity.copy(velocity))}},{key:"body",get:function get(){return this._body},set:function set(body){this._body!==body&&(this._body=body,body&&this._simulationEnabled&&body.activate())}},{key:"friction",get:function get(){return this._friction},set:function set(friction){this._friction!==friction&&(this._friction=friction,this._body&&this._body.setFriction(friction))}},{key:"group",get:function get(){return this._group},set:function set(group){this._group!==group&&(this._group=group,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}},{key:"linearDamping",get:function get(){return this._linearDamping},set:function set(damping){this._linearDamping!==damping&&(this._linearDamping=damping,this._body&&this._body.setDamping(damping,this._angularDamping))}},{key:"linearFactor",get:function get(){return this._linearFactor},set:function set(factor){this._linearFactor.equals(factor)||(this._linearFactor.copy(factor),this._body&&"dynamic"===this._type&&(ammoVec1.setValue(factor.x,factor.y,factor.z),this._body.setLinearFactor(ammoVec1)))}},{key:"linearVelocity",get:function get(){if(this._body&&"dynamic"===this._type){var velocity=this._body.getLinearVelocity();this._linearVelocity.set(velocity.x(),velocity.y(),velocity.z())}return this._linearVelocity},set:function set(velocity){this._body&&"dynamic"===this._type&&(this._body.activate(),ammoVec1.setValue(velocity.x,velocity.y,velocity.z),this._body.setLinearVelocity(ammoVec1),this._linearVelocity.copy(velocity))}},{key:"mask",get:function get(){return this._mask},set:function set(mask){this._mask!==mask&&(this._mask=mask,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}},{key:"mass",get:function get(){return this._mass},set:function set(mass){if(this._mass!==mass&&(this._mass=mass,this._body&&"dynamic"===this._type)){var enabled=this.enabled&&this.entity.enabled;enabled&&this.disableSimulation(),this._body.getCollisionShape().calculateLocalInertia(mass,ammoVec1),this._body.setMassProps(mass,ammoVec1),this._body.updateInertiaTensor(),enabled&&this.enableSimulation()}}},{key:"restitution",get:function get(){return this._restitution},set:function set(restitution){this._restitution!==restitution&&(this._restitution=restitution,this._body&&this._body.setRestitution(restitution))}},{key:"rollingFriction",get:function get(){return this._rollingFriction},set:function set(friction){this._rollingFriction!==friction&&(this._rollingFriction=friction,this._body&&this._body.setRollingFriction(friction))}},{key:"type",get:function get(){return this._type},set:function set(type){if(this._type!==type){switch(this._type=type,this.disableSimulation(),type){case"dynamic":this._group=1,this._mask=65535;break;case"kinematic":this._group=4,this._mask=65535;break;case"static":default:this._group=2,this._mask=65533}this.createBody()}}}]),RigidBodyComponent}(Component),RigidBodyComponentData=function RigidBodyComponentData(){this.enabled=!0},ammoRayStart,ammoRayEnd,collisions={},frameCollisions={},RaycastResult=function RaycastResult(entity,point,normal){this.entity=entity,this.point=point,this.normal=normal},SingleContactResult=function SingleContactResult(a,b,contactPoint){0===arguments.length?(this.a=null,this.b=null,this.localPointA=new Vec3,this.localPointB=new Vec3,this.pointA=new Vec3,this.pointB=new Vec3,this.normal=new Vec3):(this.a=a,this.b=b,this.localPointA=contactPoint.localPoint,this.localPointB=contactPoint.localPointOther,this.pointA=contactPoint.point,this.pointB=contactPoint.pointOther,this.normal=contactPoint.normal)},ContactPoint=function ContactPoint(localPoint,localPointOther,point,pointOther,normal){void 0===localPoint&&(localPoint=new Vec3),void 0===localPointOther&&(localPointOther=new Vec3),void 0===point&&(point=new Vec3),void 0===pointOther&&(pointOther=new Vec3),void 0===normal&&(normal=new Vec3),this.localPoint=localPoint,this.localPointOther=localPointOther,this.point=point,this.pointOther=pointOther,this.normal=normal},ContactResult=function ContactResult(other,contacts){this.other=other,this.contacts=contacts},_schema$7=["enabled"],RigidBodyComponentSystem=function(_ComponentSystem){function RigidBodyComponentSystem(app){var _this;return(_this=_ComponentSystem.call(this,app)||this).id="rigidbody",_this._stats=app.stats.frame,_this.ComponentType=RigidBodyComponent,_this.DataType=RigidBodyComponentData,_this.contactPointPool=null,_this.contactResultPool=null,_this.singleContactResultPool=null,_this.schema=_schema$7,_this.maxSubSteps=10,_this.fixedTimeStep=1/60,_this.gravity=new Vec3(0,-9.81,0),_this._dynamic=[],_this._kinematic=[],_this._triggers=[],_this._compounds=[],_this.on("beforeremove",_this.onBeforeRemove,_assertThisInitialized(_this)),_this.on("remove",_this.onRemove,_assertThisInitialized(_this)),_this}_inheritsLoose(RigidBodyComponentSystem,_ComponentSystem);var _proto=RigidBodyComponentSystem.prototype;return _proto.onLibraryLoaded=function onLibraryLoaded(){if("undefined"!=typeof Ammo){if(this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.overlappingPairCache=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration),this.dynamicsWorld.setInternalTickCallback){var checkForCollisionsPointer=Ammo.addFunction(this._checkForCollisions.bind(this),"vif");this.dynamicsWorld.setInternalTickCallback(checkForCollisionsPointer)}ammoRayStart=new Ammo.btVector3,ammoRayEnd=new Ammo.btVector3,this.contactPointPool=new ObjectPool(ContactPoint,1),this.contactResultPool=new ObjectPool(ContactResult,1),this.singleContactResultPool=new ObjectPool(SingleContactResult,1),ComponentSystem.bind("update",this.onUpdate,this)}else ComponentSystem.unbind("update",this.onUpdate,this)},_proto.initializeComponentData=function initializeComponentData(component,data,properties){for(var props,_i=0,_props=["mass","linearDamping","angularDamping","linearFactor","angularFactor","friction","rollingFriction","restitution","type","group","mask"];_i<_props.length;_i++){var property=_props[_i];if(data.hasOwnProperty(property)){var value=data[property];Array.isArray(value)?component[property]=new Vec3(value[0],value[1],value[2]):component[property]=value}}_ComponentSystem.prototype.initializeComponentData.call(this,component,data,["enabled"])},_proto.cloneComponent=function cloneComponent(entity,clone){var rigidbody=entity.rigidbody,data={enabled:rigidbody.enabled,mass:rigidbody.mass,linearDamping:rigidbody.linearDamping,angularDamping:rigidbody.angularDamping,linearFactor:[rigidbody.linearFactor.x,rigidbody.linearFactor.y,rigidbody.linearFactor.z],angularFactor:[rigidbody.angularFactor.x,rigidbody.angularFactor.y,rigidbody.angularFactor.z],friction:rigidbody.friction,rollingFriction:rigidbody.rollingFriction,restitution:rigidbody.restitution,type:rigidbody.type,group:rigidbody.group,mask:rigidbody.mask};this.addComponent(clone,data)},_proto.onBeforeRemove=function onBeforeRemove(entity,component){component.enabled&&(component.enabled=!1)},_proto.onRemove=function onRemove(entity,component){var body=component.body;body&&(this.removeBody(body),this.destroyBody(body),component.body=null)},_proto.addBody=function addBody(body,group,mask){void 0!==group&&void 0!==mask?this.dynamicsWorld.addRigidBody(body,group,mask):this.dynamicsWorld.addRigidBody(body)},_proto.removeBody=function removeBody(body){this.dynamicsWorld.removeRigidBody(body)},_proto.createBody=function createBody(mass,shape,transform){var localInertia=new Ammo.btVector3(0,0,0);0!==mass&&shape.calculateLocalInertia(mass,localInertia);var motionState=new Ammo.btDefaultMotionState(transform),bodyInfo=new Ammo.btRigidBodyConstructionInfo(mass,motionState,shape,localInertia),body=new Ammo.btRigidBody(bodyInfo);return Ammo.destroy(bodyInfo),Ammo.destroy(localInertia),body},_proto.destroyBody=function destroyBody(body){var motionState=body.getMotionState();motionState&&Ammo.destroy(motionState),Ammo.destroy(body)},_proto.raycastFirst=function raycastFirst(start,end){var result=null;ammoRayStart.setValue(start.x,start.y,start.z),ammoRayEnd.setValue(end.x,end.y,end.z);var rayCallback=new Ammo.ClosestRayResultCallback(ammoRayStart,ammoRayEnd);if(this.dynamicsWorld.rayTest(ammoRayStart,ammoRayEnd,rayCallback),rayCallback.hasHit()){var collisionObj=rayCallback.get_m_collisionObject(),body=Ammo.castObject(collisionObj,Ammo.btRigidBody);if(body){var point=rayCallback.get_m_hitPointWorld(),normal=rayCallback.get_m_hitNormalWorld();if(result=new RaycastResult(body.entity,new Vec3(point.x(),point.y(),point.z()),new Vec3(normal.x(),normal.y(),normal.z())),arguments.length>2){var callback=arguments[2];callback(result)}}}return Ammo.destroy(rayCallback),result},_proto.raycastAll=function raycastAll(start,end){var results=[];ammoRayStart.setValue(start.x,start.y,start.z),ammoRayEnd.setValue(end.x,end.y,end.z);var rayCallback=new Ammo.AllHitsRayResultCallback(ammoRayStart,ammoRayEnd);if(this.dynamicsWorld.rayTest(ammoRayStart,ammoRayEnd,rayCallback),rayCallback.hasHit())for(var collisionObjs=rayCallback.get_m_collisionObjects(),points=rayCallback.get_m_hitPointWorld(),normals=rayCallback.get_m_hitNormalWorld(),numHits=collisionObjs.size(),i=0;i<numHits;i++){var body=Ammo.castObject(collisionObjs.at(i),Ammo.btRigidBody);if(body){var point=points.at(i),normal=normals.at(i),result=new RaycastResult(body.entity,new Vec3(point.x(),point.y(),point.z()),new Vec3(normal.x(),normal.y(),normal.z()));results.push(result)}}return Ammo.destroy(rayCallback),results},_proto._storeCollision=function _storeCollision(entity,other){var isNewCollision=!1,guid=entity.getGuid();return collisions[guid]=collisions[guid]||{others:[],entity:entity},collisions[guid].others.indexOf(other)<0&&(collisions[guid].others.push(other),isNewCollision=!0),frameCollisions[guid]=frameCollisions[guid]||{others:[],entity:entity},frameCollisions[guid].others.push(other),isNewCollision},_proto._createContactPointFromAmmo=function _createContactPointFromAmmo(contactPoint){var localPointA=contactPoint.get_m_localPointA(),localPointB=contactPoint.get_m_localPointB(),positionWorldOnA=contactPoint.getPositionWorldOnA(),positionWorldOnB=contactPoint.getPositionWorldOnB(),normalWorldOnB=contactPoint.get_m_normalWorldOnB(),contact=this.contactPointPool.allocate();return contact.localPoint.set(localPointA.x(),localPointA.y(),localPointA.z()),contact.localPointOther.set(localPointB.x(),localPointB.y(),localPointB.z()),contact.point.set(positionWorldOnA.x(),positionWorldOnA.y(),positionWorldOnA.z()),contact.pointOther.set(positionWorldOnB.x(),positionWorldOnB.y(),positionWorldOnB.z()),contact.normal.set(normalWorldOnB.x(),normalWorldOnB.y(),normalWorldOnB.z()),contact},_proto._createReverseContactPointFromAmmo=function _createReverseContactPointFromAmmo(contactPoint){var localPointA=contactPoint.get_m_localPointA(),localPointB=contactPoint.get_m_localPointB(),positionWorldOnA=contactPoint.getPositionWorldOnA(),positionWorldOnB=contactPoint.getPositionWorldOnB(),normalWorldOnB=contactPoint.get_m_normalWorldOnB(),contact=this.contactPointPool.allocate();return contact.localPointOther.set(localPointA.x(),localPointA.y(),localPointA.z()),contact.localPoint.set(localPointB.x(),localPointB.y(),localPointB.z()),contact.pointOther.set(positionWorldOnA.x(),positionWorldOnA.y(),positionWorldOnA.z()),contact.point.set(positionWorldOnB.x(),positionWorldOnB.y(),positionWorldOnB.z()),contact.normal.set(normalWorldOnB.x(),normalWorldOnB.y(),normalWorldOnB.z()),contact},_proto._createSingleContactResult=function _createSingleContactResult(a,b,contactPoint){var result=this.singleContactResultPool.allocate();return result.a=a,result.b=b,result.localPointA=contactPoint.localPoint,result.localPointB=contactPoint.localPointOther,result.pointA=contactPoint.point,result.pointB=contactPoint.pointOther,result.normal=contactPoint.normal,result},_proto._createContactResult=function _createContactResult(other,contacts){var result=this.contactResultPool.allocate();return result.other=other,result.contacts=contacts,result},_proto._cleanOldCollisions=function _cleanOldCollisions(){for(var guid in collisions)if(collisions.hasOwnProperty(guid)){for(var frameCollision=frameCollisions[guid],collision=collisions[guid],entity=collision.entity,entityCollision=entity.collision,entityRigidbody=entity.rigidbody,others=collision.others,length,i=others.length;i--;){var other=others[i];(!frameCollision||frameCollision.others.indexOf(other)<0)&&(others.splice(i,1),entity.trigger?(entityCollision&&entityCollision.fire("triggerleave",other),other.rigidbody&&other.rigidbody.fire("triggerleave",entity)):other.trigger||(entityRigidbody&&entityRigidbody.fire("collisionend",other),entityCollision&&entityCollision.fire("collisionend",other)))}0===others.length&&delete collisions[guid]}},_proto._hasContactEvent=function _hasContactEvent(entity){var c=entity.collision;if(c&&(c.hasEvent("collisionstart")||c.hasEvent("collisionend")||c.hasEvent("contact")))return!0;var r=entity.rigidbody;return r&&(r.hasEvent("collisionstart")||r.hasEvent("collisionend")||r.hasEvent("contact"))},_proto._checkForCollisions=function _checkForCollisions(world,timeStep){var dynamicsWorld,dispatcher=Ammo.wrapPointer(world,Ammo.btDynamicsWorld).getDispatcher(),numManifolds=dispatcher.getNumManifolds();frameCollisions={};for(var i=0;i<numManifolds;i++){var manifold=dispatcher.getManifoldByIndexInternal(i),body0=manifold.getBody0(),body1=manifold.getBody1(),wb0=Ammo.castObject(body0,Ammo.btRigidBody),wb1=Ammo.castObject(body1,Ammo.btRigidBody),e0=wb0.entity,e1=wb1.entity;if(e0&&e1){var flags0=wb0.getCollisionFlags(),flags1=wb1.getCollisionFlags(),numContacts=manifold.getNumContacts(),forwardContacts=[],reverseContacts=[],newCollision=void 0;if(numContacts>0)if(4&flags0||4&flags1){var e0Events=e0.collision&&(e0.collision.hasEvent("triggerenter")||e0.collision.hasEvent("triggerleave")),e1Events=e1.collision&&(e1.collision.hasEvent("triggerenter")||e1.collision.hasEvent("triggerleave")),e0BodyEvents=e0.rigidbody&&(e0.rigidbody.hasEvent("triggerenter")||e0.rigidbody.hasEvent("triggerleave")),e1BodyEvents=e1.rigidbody&&(e1.rigidbody.hasEvent("triggerenter")||e1.rigidbody.hasEvent("triggerleave"));e0Events&&(!(newCollision=this._storeCollision(e0,e1))||4&flags1||e0.collision.fire("triggerenter",e1)),e1Events&&(!(newCollision=this._storeCollision(e1,e0))||4&flags0||e1.collision.fire("triggerenter",e0)),e0BodyEvents&&(newCollision||(newCollision=this._storeCollision(e1,e0)),newCollision&&e0.rigidbody.fire("triggerenter",e1)),e1BodyEvents&&(newCollision||(newCollision=this._storeCollision(e0,e1)),newCollision&&e1.rigidbody.fire("triggerenter",e0))}else{var _e0Events=this._hasContactEvent(e0),_e1Events=this._hasContactEvent(e1),globalEvents=this.hasEvent("contact");if(globalEvents||_e0Events||_e1Events){for(var j=0;j<numContacts;j++){var btContactPoint=manifold.getContactPoint(j),contactPoint=this._createContactPointFromAmmo(btContactPoint);if(_e0Events||_e1Events){forwardContacts.push(contactPoint);var reverseContactPoint=this._createReverseContactPointFromAmmo(btContactPoint);reverseContacts.push(reverseContactPoint)}if(globalEvents){var result=this._createSingleContactResult(e0,e1,contactPoint);this.fire("contact",result)}}if(_e0Events){var forwardResult=this._createContactResult(e1,forwardContacts);newCollision=this._storeCollision(e0,e1),e0.collision&&(e0.collision.fire("contact",forwardResult),newCollision&&e0.collision.fire("collisionstart",forwardResult)),e0.rigidbody&&(e0.rigidbody.fire("contact",forwardResult),newCollision&&e0.rigidbody.fire("collisionstart",forwardResult))}if(_e1Events){var reverseResult=this._createContactResult(e0,reverseContacts);newCollision=this._storeCollision(e1,e0),e1.collision&&(e1.collision.fire("contact",reverseResult),newCollision&&e1.collision.fire("collisionstart",reverseResult)),e1.rigidbody&&(e1.rigidbody.fire("contact",reverseResult),newCollision&&e1.rigidbody.fire("collisionstart",reverseResult))}}}}}this._cleanOldCollisions(),this.contactPointPool.freeAll(),this.contactResultPool.freeAll(),this.singleContactResultPool.freeAll()},_proto.onUpdate=function onUpdate(dt){var i,len,gravity=this.dynamicsWorld.getGravity();gravity.x()===this.gravity.x&&gravity.y()===this.gravity.y&&gravity.z()===this.gravity.z||(gravity.setValue(this.gravity.x,this.gravity.y,this.gravity.z),this.dynamicsWorld.setGravity(gravity));var triggers=this._triggers;for(i=0,len=triggers.length;i<len;i++)triggers[i].updateTransform();var compounds=this._compounds;for(i=0,len=compounds.length;i<len;i++)compounds[i]._updateCompound();var kinematic=this._kinematic;for(i=0,len=kinematic.length;i<len;i++)kinematic[i]._updateKinematic();this.dynamicsWorld.stepSimulation(dt,this.maxSubSteps,this.fixedTimeStep);var dynamic=this._dynamic;for(i=0,len=dynamic.length;i<len;i++)dynamic[i]._updateDynamic();this.dynamicsWorld.setInternalTickCallback||this._checkForCollisions(Ammo.getPointer(this.dynamicsWorld),dt)},_proto.destroy=function destroy(){"undefined"!=typeof Ammo&&(Ammo.destroy(this.dynamicsWorld),Ammo.destroy(this.solver),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.dispatcher),Ammo.destroy(this.collisionConfiguration),this.dynamicsWorld=null,this.solver=null,this.overlappingPairCache=null,this.dispatcher=null,this.collisionConfiguration=null)},RigidBodyComponentSystem}(ComponentSystem);Component._buildAccessors(RigidBodyComponent.prototype,_schema$7);var SCALEMODE_NONE="none",SCALEMODE_BLEND="blend",_transform=new Mat4,ScreenComponent=function(_Component){function ScreenComponent(system,entity){var _this;return(_this=_Component.call(this,system,entity)||this)._resolution=new Vec2(640,320),_this._referenceResolution=new Vec2(640,320),_this._scaleMode="none",_this.scale=1,_this._scaleBlend=.5,_this._priority=0,_this._screenSpace=!1,_this.cull=_this._screenSpace,_this._screenMatrix=new Mat4,_this._elements=new Set,system.app.graphicsDevice.on("resizecanvas",_this._onResize,_assertThisInitialized(_this)),_this}_inheritsLoose(ScreenComponent,_Component);var _proto=ScreenComponent.prototype;return _proto.syncDrawOrder=function syncDrawOrder(){this.system.queueDrawOrderSync(this.entity.getGuid(),this._processDrawOrderSync,this)},_proto._recurseDrawOrderSync=function _recurseDrawOrderSync(e,i){if(!(e instanceof Entity))return i;if(e.element){var prevDrawOrder=e.element.drawOrder;e.element.drawOrder=i++,e.element._batchGroupId>=0&&prevDrawOrder!==e.element.drawOrder&&this.system.app.batcher.markGroupDirty(e.element._batchGroupId)}e.particlesystem&&(e.particlesystem.drawOrder=i++);for(var children=e.children,j=0;j<children.length;j++)i=this._recurseDrawOrderSync(children[j],i);return i},_proto._processDrawOrderSync=function _processDrawOrderSync(){var i=1;this._recurseDrawOrderSync(this.entity,1),this.fire("syncdraworder")},_proto._calcProjectionMatrix=function _calcProjectionMatrix(){var left,right,bottom,top,near=1,far=-1,w=this._resolution.x/this.scale,h=this._resolution.y/this.scale;left=0,right=w,bottom=-h,top=0,this._screenMatrix.setOrtho(0,right,bottom,0,1,-1),this._screenSpace||(_transform.setScale(.5*w,.5*h,1),this._screenMatrix.mul2(_transform,this._screenMatrix))},_proto._updateScale=function _updateScale(){this.scale=this._calcScale(this._resolution,this.referenceResolution)},_proto._calcScale=function _calcScale(resolution,referenceResolution){var lx=Math.log2(resolution.x/referenceResolution.x),ly=Math.log2(resolution.y/referenceResolution.y);return Math.pow(2,lx*(1-this._scaleBlend)+ly*this._scaleBlend)},_proto._onResize=function _onResize(width,height){this._screenSpace&&(this._resolution.set(width,height),this.resolution=this._resolution)},_proto._bindElement=function _bindElement(element){this._elements.add(element)},_proto._unbindElement=function _unbindElement(element){this._elements.delete(element)},_proto.onRemove=function onRemove(){this.system.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.fire("remove"),this._elements.forEach((function(element){return element._onScreenRemove()})),this._elements.clear(),this.off()},_createClass(ScreenComponent,[{key:"resolution",get:function get(){return this._resolution},set:function set(value){var _this2=this;this._screenSpace?this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height):this._resolution.set(value.x,value.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:resolution",this._resolution),this._elements.forEach((function(element){return element._onScreenResize(_this2._resolution)}))}},{key:"referenceResolution",get:function get(){return"none"===this._scaleMode?this._resolution:this._referenceResolution},set:function set(value){var _this3=this;this._referenceResolution.set(value.x,value.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:referenceresolution",this._resolution),this._elements.forEach((function(element){return element._onScreenResize(_this3._resolution)}))}},{key:"screenSpace",get:function get(){return this._screenSpace},set:function set(value){this._screenSpace=value,this._screenSpace&&this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height),this.resolution=this._resolution,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:screenspace",this._screenSpace),this._elements.forEach((function(element){return element._onScreenSpaceChange()}))}},{key:"scaleMode",get:function get(){return this._scaleMode},set:function set(value){"none"!==value&&"blend"!==value&&(value="none"),this._screenSpace||"none"===value||(value="none"),this._scaleMode=value,this.resolution=this._resolution,this.fire("set:scalemode",this._scaleMode)}},{key:"scaleBlend",get:function get(){return this._scaleBlend},set:function set(value){var _this4=this;this._scaleBlend=value,this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:scaleblend",this._scaleBlend),this._elements.forEach((function(element){return element._onScreenResize(_this4._resolution)}))}},{key:"priority",get:function get(){return this._priority},set:function set(value){value>255&&(value=255),this._priority=value}}]),ScreenComponent}(Component),ScreenComponentData=function ScreenComponentData(){this.enabled=!0},_schema$6=["enabled"],ScreenComponentSystem=function(_ComponentSystem){function ScreenComponentSystem(app){var _this;return(_this=_ComponentSystem.call(this,app)||this).id="screen",_this.ComponentType=ScreenComponent,_this.DataType=ScreenComponentData,_this.schema=_schema$6,_this.windowResolution=new Vec2,_this._drawOrderSyncQueue=new IndexedList,_this.app.graphicsDevice.on("resizecanvas",_this._onResize,_assertThisInitialized(_this)),ComponentSystem.bind("update",_this._onUpdate,_assertThisInitialized(_this)),_this.on("beforeremove",_this.onRemoveComponent,_assertThisInitialized(_this)),_this}_inheritsLoose(ScreenComponentSystem,_ComponentSystem);var _proto=ScreenComponentSystem.prototype;return _proto.initializeComponentData=function initializeComponentData(component,data,properties){void 0!==data.priority&&(component.priority=data.priority),void 0!==data.screenSpace&&(component.screenSpace=data.screenSpace),component.cull=component.screenSpace,void 0!==data.scaleMode&&(component.scaleMode=data.scaleMode),void 0!==data.scaleBlend&&(component.scaleBlend=data.scaleBlend),void 0!==data.resolution&&(data.resolution instanceof Vec2?component._resolution.copy(data.resolution):component._resolution.set(data.resolution[0],data.resolution[1]),component.resolution=component._resolution),void 0!==data.referenceResolution&&(data.referenceResolution instanceof Vec2?component._referenceResolution.copy(data.referenceResolution):component._referenceResolution.set(data.referenceResolution[0],data.referenceResolution[1]),component.referenceResolution=component._referenceResolution),component.syncDrawOrder(),_ComponentSystem.prototype.initializeComponentData.call(this,component,data,properties)},_proto.destroy=function destroy(){this.off(),this.app.graphicsDevice.off("resizecanvas",this._onResize,this)},_proto._onUpdate=function _onUpdate(dt){var components=this.store;for(var id in components)components[id].entity.screen.update&&components[id].entity.screen.update(dt)},_proto._onResize=function _onResize(width,height){this.windowResolution.x=width,this.windowResolution.y=height},_proto.cloneComponent=function cloneComponent(entity,clone){var screen=entity.screen;return this.addComponent(clone,{enabled:screen.enabled,screenSpace:screen.screenSpace,scaleMode:screen.scaleMode,resolution:screen.resolution.clone(),referenceResolution:screen.referenceResolution.clone()})},_proto.onRemoveComponent=function onRemoveComponent(entity,component){component.onRemove()},_proto.processDrawOrderSyncQueue=function processDrawOrderSyncQueue(){for(var list=this._drawOrderSyncQueue.list(),i=0;i<list.length;i++){var item=list[i];item.callback.call(item.scope)}this._drawOrderSyncQueue.clear()},_proto.queueDrawOrderSync=function queueDrawOrderSync(id,fn,scope){this._drawOrderSyncQueue.list().length||this.app.once("prerender",this.processDrawOrderSyncQueue,this),this._drawOrderSyncQueue.has(id)||this._drawOrderSyncQueue.push(id,{callback:fn,scope:scope})},ScreenComponentSystem}(ComponentSystem);Component._buildAccessors(ScreenComponent.prototype,_schema$6);var components=["x","y","z","w"],vecLookup=[void 0,void 0,Vec2,Vec3,Vec4];function rawToValue(app,args,value,old){var i,j;switch(args.type){case"boolean":return!!value;case"number":if("number"==typeof value)return value;if("string"==typeof value){var v=parseInt(value,10);return isNaN(v)?null:v}return"boolean"==typeof value?0+value:null;case"json":var result={};if(Array.isArray(args.schema))for(value&&"object"==typeof value||(value={}),i=0;i<args.schema.length;i++){var field=args.schema[i];if(field.name)if(field.array){result[field.name]=[];var arr=Array.isArray(value[field.name])?value[field.name]:[];for(j=0;j<arr.length;j++)result[field.name].push(rawToValue(app,field,arr[j]))}else{var val=value.hasOwnProperty(field.name)?value[field.name]:field.default;result[field.name]=rawToValue(app,field,val)}}return result;case"asset":return value instanceof Asset?value:"number"==typeof value?app.assets.get(value)||null:"string"==typeof value&&app.assets.get(parseInt(value,10))||null;case"entity":return value instanceof GraphNode?value:"string"==typeof value?app.getEntityFromIndex(value):null;case"rgb":case"rgba":if(value instanceof Color)return old instanceof Color?(old.copy(value),old):value.clone();if(value instanceof Array&&value.length>=3&&value.length<=4){for(i=0;i<value.length;i++)if("number"!=typeof value[i])return null;return old||(old=new Color),old.r=value[0],old.g=value[1],old.b=value[2],old.a=3===value.length?1:value[3],old}return"string"==typeof value&&/#([0-9abcdef]{2}){3,4}/i.test(value)?(old||(old=new Color),old.fromString(value),old):null;case"vec2":case"vec3":case"vec4":var len=parseInt(args.type.slice(3),10),vecType=vecLookup[len];if(value instanceof vecType)return old instanceof vecType?(old.copy(value),old):value.clone();if(value instanceof Array&&value.length===len){for(i=0;i<value.length;i++)if("number"!=typeof value[i])return null;for(old||(old=new vecType),i=0;i<len;i++)old[components[i]]=value[i];return old}return null;case"curve":if(value){var curve,CurveType;if(value instanceof Curve||value instanceof CurveSet)curve=value.clone();else(curve=new(value.keys[0]instanceof Array?CurveSet:Curve)(value.keys)).type=value.type;return curve}}return value}var ScriptAttributes=function(){function ScriptAttributes(scriptType){this.scriptType=scriptType,this.index={}}var _proto=ScriptAttributes.prototype;return _proto.add=function add(name,args){this.index[name]||ScriptAttributes.reservedNames.has(name)||(this.index[name]=args,Object.defineProperty(this.scriptType.prototype,name,{get:function get(){return this.__attributes[name]},set:function set(raw){var evt="attr",evtName="attr:"+name,old=this.__attributes[name],oldCopy=old,i,len;if(old&&"json"!==args.type&&old.clone&&(this._callbacks.attr||this._callbacks[evtName])&&(oldCopy=old.clone()),args.array){if(this.__attributes[name]=[],raw)for(i=0,len=raw.length;i<len;i++)this.__attributes[name].push(rawToValue(this.app,args,raw[i],old?old[i]:null))}else this.__attributes[name]=rawToValue(this.app,args,raw,old);this.fire(evt,name,this.__attributes[name],oldCopy),this.fire(evtName,this.__attributes[name],oldCopy)}}))},_proto.remove=function remove(name){return!!this.index[name]&&(delete this.index[name],delete this.scriptType.prototype[name],!0)},_proto.has=function has(name){return!!this.index[name]},_proto.get=function get(name){return this.index[name]||null},ScriptAttributes}();ScriptAttributes.reservedNames=new Set(["app","entity","enabled","_enabled","_enabledOld","_destroyed","__attributes","__attributesRaw","__scriptType","__executionOrder","_callbacks","has","get","on","off","fire","once","hasEvent"]);var ScriptComponent=function(_Component){function ScriptComponent(system,entity){var _this;return(_this=_Component.call(this,system,entity)||this)._scripts=[],_this._updateList=new SortedLoopArray({sortBy:"__executionOrder"}),_this._postUpdateList=new SortedLoopArray({sortBy:"__executionOrder"}),_this._scriptsIndex={},_this._destroyedScripts=[],_this._destroyed=!1,_this._scriptsData=null,_this._oldState=!0,_this._enabled=!0,_this._beingEnabled=!1,_this._isLoopingThroughScripts=!1,_this._executionOrder=-1,_this.on("set_enabled",_this._onSetEnabled,_assertThisInitialized(_this)),_this}_inheritsLoose(ScriptComponent,_Component);var _proto=ScriptComponent.prototype;return _proto.onEnable=function onEnable(){this._beingEnabled=!0,this._checkState(),this.entity._beingEnabled||this.onPostStateChange(),this._beingEnabled=!1},_proto.onDisable=function onDisable(){this._checkState()},_proto.onPostStateChange=function onPostStateChange(){for(var script,wasLooping=this._beginLooping(),i=0,len=this.scripts.length;i<len;i++)(script=this.scripts[i])._initialized&&!script._postInitialized&&script.enabled&&(script._postInitialized=!0,script.postInitialize&&this._scriptMethod(script,ScriptComponent.scriptMethods.postInitialize));this._endLooping(wasLooping)},_proto._beginLooping=function _beginLooping(){var looping=this._isLoopingThroughScripts;return this._isLoopingThroughScripts=!0,looping},_proto._endLooping=function _endLooping(wasLoopingBefore){this._isLoopingThroughScripts=wasLoopingBefore,this._isLoopingThroughScripts||this._removeDestroyedScripts()},_proto._onSetEnabled=function _onSetEnabled(prop,old,value){this._beingEnabled=!0,this._checkState(),this._beingEnabled=!1},_proto._checkState=function _checkState(){var state=this.enabled&&this.entity.enabled;if(state!==this._oldState){this._oldState=state,this.fire(state?"enable":"disable"),this.fire("state",state),state?this.system._addComponentToEnabled(this):this.system._removeComponentFromEnabled(this);for(var wasLooping=this._beginLooping(),script,i=0,len=this.scripts.length;i<len;i++)(script=this.scripts[i]).enabled=script._enabled;this._endLooping(wasLooping)}},_proto._onBeforeRemove=function _onBeforeRemove(){this.fire("remove");for(var wasLooping=this._beginLooping(),i=0;i<this.scripts.length;i++){var script=this.scripts[i];script&&this.destroy(script.__scriptType.__name)}this._endLooping(wasLooping)},_proto._removeDestroyedScripts=function _removeDestroyedScripts(){var len=this._destroyedScripts.length;if(len){var i;for(i=0;i<len;i++){var script=this._destroyedScripts[i];this._removeScriptInstance(script)}this._destroyedScripts.length=0,this._resetExecutionOrder(0,this._scripts.length)}},_proto._onInitializeAttributes=function _onInitializeAttributes(){for(var i=0,len=this.scripts.length;i<len;i++)this.scripts[i].__initializeAttributes()},_proto._scriptMethod=function _scriptMethod(script,method,arg){script[method](arg)},_proto._onInitialize=function _onInitialize(){for(var script,scripts=this._scripts,wasLooping=this._beginLooping(),i=0,len=scripts.length;i<len;i++)!(script=scripts[i])._initialized&&script.enabled&&(script._initialized=!0,script.initialize&&this._scriptMethod(script,ScriptComponent.scriptMethods.initialize));this._endLooping(wasLooping)},_proto._onPostInitialize=function _onPostInitialize(){this.onPostStateChange()},_proto._onUpdate=function _onUpdate(dt){var self=this,list=this._updateList;if(list.length){var script,wasLooping=this._beginLooping();for(list.loopIndex=0;list.loopIndex<list.length;list.loopIndex++)(script=list.items[list.loopIndex]).enabled&&this._scriptMethod(script,ScriptComponent.scriptMethods.update,dt);this._endLooping(wasLooping)}},_proto._onPostUpdate=function _onPostUpdate(dt){var self=this,list=this._postUpdateList;if(list.length){var wasLooping=this._beginLooping(),script;for(list.loopIndex=0;list.loopIndex<list.length;list.loopIndex++)(script=list.items[list.loopIndex]).enabled&&this._scriptMethod(script,ScriptComponent.scriptMethods.postUpdate,dt);this._endLooping(wasLooping)}},_proto._insertScriptInstance=function _insertScriptInstance(scriptInstance,index,scriptsLength){-1===index?(this._scripts.push(scriptInstance),scriptInstance.__executionOrder=scriptsLength,scriptInstance.update&&this._updateList.append(scriptInstance),scriptInstance.postUpdate&&this._postUpdateList.append(scriptInstance)):(this._scripts.splice(index,0,scriptInstance),scriptInstance.__executionOrder=index,this._resetExecutionOrder(index+1,scriptsLength+1),scriptInstance.update&&this._updateList.insert(scriptInstance),scriptInstance.postUpdate&&this._postUpdateList.insert(scriptInstance))},_proto._removeScriptInstance=function _removeScriptInstance(scriptInstance){var idx=this._scripts.indexOf(scriptInstance);return-1===idx?idx:(this._scripts.splice(idx,1),scriptInstance.update&&this._updateList.remove(scriptInstance),scriptInstance.postUpdate&&this._postUpdateList.remove(scriptInstance),idx)},_proto._resetExecutionOrder=function _resetExecutionOrder(startIndex,scriptsLength){for(var i=startIndex;i<scriptsLength;i++)this._scripts[i].__executionOrder=i},_proto._resolveEntityScriptAttribute=function _resolveEntityScriptAttribute(attribute,attributeName,oldValue,useGuid,newAttributes,duplicatedIdsMap){if(attribute.array){var len=oldValue.length;if(!len)return;for(var newGuidArray=oldValue.slice(),i=0;i<len;i++){var guid=newGuidArray[i]instanceof Entity?newGuidArray[i].getGuid():newGuidArray[i];duplicatedIdsMap[guid]&&(newGuidArray[i]=useGuid?duplicatedIdsMap[guid].getGuid():duplicatedIdsMap[guid])}newAttributes[attributeName]=newGuidArray}else{if(oldValue instanceof Entity)oldValue=oldValue.getGuid();else if("string"!=typeof oldValue)return;duplicatedIdsMap[oldValue]&&(newAttributes[attributeName]=duplicatedIdsMap[oldValue])}},_proto.has=function has(nameOrType){if("string"==typeof nameOrType)return!!this._scriptsIndex[nameOrType];if(!nameOrType)return!1;var scriptType=nameOrType,scriptName=scriptType.__name,scriptData=this._scriptsIndex[scriptName],scriptInstance;return(scriptData&&scriptData.instance)instanceof scriptType},_proto.get=function get(nameOrType){if("string"==typeof nameOrType){var data=this._scriptsIndex[nameOrType];return data?data.instance:null}if(!nameOrType)return null;var scriptType=nameOrType,scriptName=scriptType.__name,scriptData=this._scriptsIndex[scriptName],scriptInstance=scriptData&&scriptData.instance;return scriptInstance instanceof scriptType?scriptInstance:null},_proto.create=function create(nameOrType,args){void 0===args&&(args={});var self=this,scriptType=nameOrType,scriptName=nameOrType;if("string"==typeof scriptType?scriptType=this.system.app.scripts.get(scriptType):scriptType&&(scriptName=scriptType.__name),scriptType){if(!this._scriptsIndex[scriptName]||!this._scriptsIndex[scriptName].instance){var scriptInstance=new scriptType({app:this.system.app,entity:this.entity,enabled:!args.hasOwnProperty("enabled")||args.enabled,attributes:args.attributes}),len=this._scripts.length,ind=-1;return"number"==typeof args.ind&&-1!==args.ind&&len>args.ind&&(ind=args.ind),this._insertScriptInstance(scriptInstance,ind,len),this._scriptsIndex[scriptName]={instance:scriptInstance,onSwap:function onSwap(){self.swap(scriptName)}},this[scriptName]=scriptInstance,args.preloading||scriptInstance.__initializeAttributes(),this.fire("create",scriptName,scriptInstance),this.fire("create:"+scriptName,scriptInstance),this.system.app.scripts.on("swap:"+scriptName,this._scriptsIndex[scriptName].onSwap),args.preloading||(scriptInstance.enabled&&!scriptInstance._initialized&&(scriptInstance._initialized=!0,scriptInstance.initialize&&this._scriptMethod(scriptInstance,ScriptComponent.scriptMethods.initialize)),scriptInstance.enabled&&!scriptInstance._postInitialized&&(scriptInstance._postInitialized=!0,scriptInstance.postInitialize&&this._scriptMethod(scriptInstance,ScriptComponent.scriptMethods.postInitialize))),scriptInstance}console.warn("script '"+scriptName+"' is already added to entity '"+this.entity.name+"'")}else this._scriptsIndex[scriptName]={awaiting:!0,ind:this._scripts.length},console.warn("script '"+scriptName+"' is not found, awaiting it to be added to registry");return null},_proto.destroy=function destroy(nameOrType){var scriptName=nameOrType,scriptType=nameOrType;"string"==typeof scriptType?scriptType=this.system.app.scripts.get(scriptType):scriptType&&(scriptName=scriptType.__name);var scriptData=this._scriptsIndex[scriptName];if(delete this._scriptsIndex[scriptName],!scriptData)return!1;var scriptInstance=scriptData.instance;if(scriptInstance&&!scriptInstance._destroyed)if(scriptInstance.enabled=!1,scriptInstance._destroyed=!0,this._isLoopingThroughScripts)this._destroyedScripts.push(scriptInstance);else{var ind=this._removeScriptInstance(scriptInstance);ind>=0&&this._resetExecutionOrder(ind,this._scripts.length)}return this.system.app.scripts.off("swap:"+scriptName,scriptData.onSwap),delete this[scriptName],this.fire("destroy",scriptName,scriptInstance||null),this.fire("destroy:"+scriptName,scriptInstance||null),scriptInstance&&scriptInstance.fire("destroy"),!0},_proto.swap=function swap(nameOrType){var scriptName=nameOrType,scriptType=nameOrType;"string"==typeof scriptType?scriptType=this.system.app.scripts.get(scriptType):scriptType&&(scriptName=scriptType.__name);var old=this._scriptsIndex[scriptName];if(!old||!old.instance)return!1;var scriptInstanceOld=old.instance,ind=this._scripts.indexOf(scriptInstanceOld),scriptInstance=new scriptType({app:this.system.app,entity:this.entity,enabled:scriptInstanceOld.enabled,attributes:scriptInstanceOld.__attributes});return!!scriptInstance.swap&&(scriptInstance.__initializeAttributes(),this._scripts[ind]=scriptInstance,this._scriptsIndex[scriptName].instance=scriptInstance,this[scriptName]=scriptInstance,scriptInstance.__executionOrder=ind,scriptInstanceOld.update&&this._updateList.remove(scriptInstanceOld),scriptInstanceOld.postUpdate&&this._postUpdateList.remove(scriptInstanceOld),scriptInstance.update&&this._updateList.insert(scriptInstance),scriptInstance.postUpdate&&this._postUpdateList.insert(scriptInstance),this._scriptMethod(scriptInstance,ScriptComponent.scriptMethods.swap,scriptInstanceOld),this.fire("swap",scriptName,scriptInstance),this.fire("swap:"+scriptName,scriptInstance),!0)},_proto.resolveDuplicatedEntityReferenceProperties=function resolveDuplicatedEntityReferenceProperties(oldScriptComponent,duplicatedIdsMap){var newScriptComponent=this.entity.script,i,j;for(var scriptName in oldScriptComponent._scriptsIndex){var scriptType=this.system.app.scripts.get(scriptName);if(scriptType){var script=oldScriptComponent._scriptsIndex[scriptName];if(script&&script.instance){var newAttributesRaw=newScriptComponent[scriptName].__attributesRaw,newAttributes=newScriptComponent[scriptName].__attributes;if(newAttributesRaw||newAttributes){var useGuid=!!newAttributesRaw,oldAttributes=script.instance.__attributes;for(var attributeName in oldAttributes)if(oldAttributes[attributeName]){var attribute=scriptType.attributes.get(attributeName);if(attribute)if("entity"===attribute.type)this._resolveEntityScriptAttribute(attribute,attributeName,oldAttributes[attributeName],useGuid,newAttributesRaw||newAttributes,duplicatedIdsMap);else if("json"===attribute.type&&Array.isArray(attribute.schema)){var oldValue=oldAttributes[attributeName],newJsonValue=newAttributesRaw?newAttributesRaw[attributeName]:newAttributes[attributeName];for(i=0;i<attribute.schema.length;i++){var field=attribute.schema[i];if("entity"===field.type)if(attribute.array)for(j=0;j<oldValue.length;j++)this._resolveEntityScriptAttribute(field,field.name,oldValue[j][field.name],useGuid,newJsonValue[j],duplicatedIdsMap);else this._resolveEntityScriptAttribute(field,field.name,oldValue[field.name],useGuid,newJsonValue,duplicatedIdsMap)}}}}}}}},_proto.move=function move(nameOrType,ind){var len=this._scripts.length;if(ind>=len||ind<0)return!1;var scriptType=nameOrType,scriptName=nameOrType;"string"!=typeof scriptName?scriptName=nameOrType.__name:scriptType=null;var scriptData=this._scriptsIndex[scriptName];if(!scriptData||!scriptData.instance)return!1;var scriptInstance=scriptData.instance;if(scriptType&&!(scriptInstance instanceof scriptType))return!1;var indOld=this._scripts.indexOf(scriptInstance);return-1!==indOld&&indOld!==ind&&(this._scripts.splice(ind,0,this._scripts.splice(indOld,1)[0]),this._resetExecutionOrder(0,len),this._updateList.sort(),this._postUpdateList.sort(),this.fire("move",scriptName,scriptInstance,ind,indOld),this.fire("move:"+scriptName,scriptInstance,ind,indOld),!0)},_createClass(ScriptComponent,[{key:"enabled",get:function get(){return this._enabled},set:function set(value){var oldValue=this._enabled;this._enabled=value,this.fire("set","enabled",oldValue,value)}},{key:"scripts",get:function get(){return this._scripts},set:function set(value){for(var key in this._scriptsData=value,value)if(value.hasOwnProperty(key)){var script=this._scriptsIndex[key];if(script){if("boolean"==typeof value[key].enabled&&(script.enabled=!!value[key].enabled),"object"==typeof value[key].attributes)for(var attr in value[key].attributes)if(!ScriptAttributes.reservedNames.has(attr)){if(!script.__attributes.hasOwnProperty(attr)){var scriptType=this.system.app.scripts.get(key);scriptType&&scriptType.attributes.add(attr,{})}script[attr]=value[key].attributes[attr]}}else console.log(this.order)}}}]),ScriptComponent}(Component);ScriptComponent.scriptMethods={initialize:"initialize",postInitialize:"postInitialize",update:"update",postUpdate:"postUpdate",swap:"swap"};var ScriptComponentData=function ScriptComponentData(){this.enabled=!0},METHOD_INITIALIZE_ATTRIBUTES="_onInitializeAttributes",METHOD_INITIALIZE="_onInitialize",METHOD_POST_INITIALIZE="_onPostInitialize",METHOD_UPDATE="_onUpdate",METHOD_POST_UPDATE="_onPostUpdate",executionOrderCounter=0,ScriptComponentSystem=function(_ComponentSystem){function ScriptComponentSystem(app){var _this;return(_this=_ComponentSystem.call(this,app)||this).id="script",_this.ComponentType=ScriptComponent,_this.DataType=ScriptComponentData,_this._components=new SortedLoopArray({sortBy:"_executionOrder"}),_this._enabledComponents=new SortedLoopArray({sortBy:"_executionOrder"}),_this.preloading=!0,_this.on("beforeremove",_this._onBeforeRemove,_assertThisInitialized(_this)),ComponentSystem.bind("initialize",_this._onInitialize,_assertThisInitialized(_this)),ComponentSystem.bind("postInitialize",_this._onPostInitialize,_assertThisInitialized(_this)),ComponentSystem.bind("update",_this._onUpdate,_assertThisInitialized(_this)),ComponentSystem.bind("postUpdate",_this._onPostUpdate,_assertThisInitialized(_this)),_this}_inheritsLoose(ScriptComponentSystem,_ComponentSystem);var _proto=ScriptComponentSystem.prototype;return _proto.initializeComponentData=function initializeComponentData(component,data){if(component._executionOrder=executionOrderCounter++,this._components.append(component),executionOrderCounter>Number.MAX_SAFE_INTEGER&&this._resetExecutionOrder(),component.enabled=!data.hasOwnProperty("enabled")||!!data.enabled,component.enabled&&component.entity.enabled&&this._enabledComponents.append(component),data.hasOwnProperty("order")&&data.hasOwnProperty("scripts")){component._scriptsData=data.scripts;for(var i=0;i<data.order.length;i++)component.create(data.order[i],{enabled:data.scripts[data.order[i]].enabled,attributes:data.scripts[data.order[i]].attributes,preloading:this.preloading})}},_proto.cloneComponent=function cloneComponent(entity,clone){var i,key,order=[],scripts={};for(i=0;i<entity.script._scripts.length;i++){var scriptInstance=entity.script._scripts[i],scriptName=scriptInstance.__scriptType.__name;order.push(scriptName);var attributes={};for(key in scriptInstance.__attributes)attributes[key]=scriptInstance.__attributes[key];scripts[scriptName]={enabled:scriptInstance._enabled,attributes:attributes}}for(key in entity.script._scriptsIndex)key.awaiting&&order.splice(key.ind,0,key);var data={enabled:entity.script.enabled,order:order,scripts:scripts};return this.addComponent(clone,data)},_proto._resetExecutionOrder=function _resetExecutionOrder(){executionOrderCounter=0;for(var i=0,len=this._components.length;i<len;i++)this._components.items[i]._executionOrder=executionOrderCounter++},_proto._callComponentMethod=function _callComponentMethod(components,name,dt){for(components.loopIndex=0;components.loopIndex<components.length;components.loopIndex++)components.items[components.loopIndex][name](dt)},_proto._onInitialize=function _onInitialize(){this.preloading=!1,this._callComponentMethod(this._components,"_onInitializeAttributes"),this._callComponentMethod(this._enabledComponents,"_onInitialize")},_proto._onPostInitialize=function _onPostInitialize(){this._callComponentMethod(this._enabledComponents,"_onPostInitialize")},_proto._onUpdate=function _onUpdate(dt){this._callComponentMethod(this._enabledComponents,"_onUpdate",dt)},_proto._onPostUpdate=function _onPostUpdate(dt){this._callComponentMethod(this._enabledComponents,"_onPostUpdate",dt)},_proto._addComponentToEnabled=function _addComponentToEnabled(component){this._enabledComponents.insert(component)},_proto._removeComponentFromEnabled=function _removeComponentFromEnabled(component){this._enabledComponents.remove(component)},_proto._onBeforeRemove=function _onBeforeRemove(entity,component){var ind;this._components.items.indexOf(component)>=0&&component._onBeforeRemove(),this._removeComponentFromEnabled(component),this._components.remove(component)},ScriptComponentSystem}(ComponentSystem),ScriptLegacyComponent=function(_Component){function ScriptLegacyComponent(system,entity){var _this;return(_this=_Component.call(this,system,entity)||this).on("set_scripts",_this.onSetScripts,_assertThisInitialized(_this)),_this}_inheritsLoose(ScriptLegacyComponent,_Component);var _proto=ScriptLegacyComponent.prototype;return _proto.send=function send(name,functionName){var args=Array.prototype.slice.call(arguments,2),instances=this.entity.script.instances,fn;if(instances&&instances[name]&&(fn=instances[name].instance[functionName]))return fn.apply(instances[name].instance,args)},_proto.onEnable=function onEnable(){this.data.areScriptsLoaded&&!this.system.preloading&&(this.data.initialized?this.system._enableScriptComponent(this):this.system._initializeScriptComponent(this),this.data.postInitialized||this.system._postInitializeScriptComponent(this))},_proto.onDisable=function onDisable(){this.system._disableScriptComponent(this)},_proto.onSetScripts=function onSetScripts(name,oldValue,newValue){if(!this.system._inTools||this.runInTools){if(this._updateScriptAttributes(oldValue,newValue))return;this.enabled&&this.system._disableScriptComponent(this),this.system._destroyScriptComponent(this),this.data.areScriptsLoaded=!1;var scripts,urls=newValue.map((function(s){return s.url}));if(this._loadFromCache(urls))return;this._loadScripts(urls)}},_proto._updateScriptAttributes=function _updateScriptAttributes(oldValue,newValue){var onlyUpdateAttributes=!0;if(oldValue.length!==newValue.length)onlyUpdateAttributes=!1;else{var i,len=newValue.length;for(i=0;i<len;i++)if(oldValue[i].url!==newValue[i].url){onlyUpdateAttributes=!1;break}}if(onlyUpdateAttributes)for(var key in this.instances)this.instances.hasOwnProperty(key)&&this.system._updateAccessors(this.entity,this.instances[key]);return onlyUpdateAttributes},_proto._loadFromCache=function _loadFromCache(urls){var i,len,cached=[],prefix=this.system.app._scriptPrefix||"",regex=/^http(s)?:\/\//i;for(i=0,len=urls.length;i<len;i++){var url=urls[i];regex.test(url)||(url=path.join(prefix,url));var type=this.system.app.loader.getFromCache(url,"script");if(!type)return!1;cached.push(type)}for(i=0,len=cached.length;i<len;i++){var ScriptType=cached[i];if(!0!==ScriptType&&(ScriptType&&this.entity.script&&!this.entity.script.instances[ScriptType._pcScriptName])){var instance=new ScriptType(this.entity);this.system._preRegisterInstance(this.entity,urls[i],ScriptType._pcScriptName,instance)}}return this.data&&(this.data.areScriptsLoaded=!0),this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)),!0},_proto._loadScripts=function _loadScripts(urls){var count=urls.length,prefix=this.system.app._scriptPrefix||"";urls.forEach(function(url){var _url=null,_unprefixed=null;url.toLowerCase().startsWith("http://")||url.toLowerCase().startsWith("https://")?(_unprefixed=url,_url=url):(_unprefixed=url,_url=path.join(prefix,url)),this.system.app.loader.load(_url,"script",function(err,ScriptType){if(count--,err)console.error(err);else if(ScriptType&&this.entity.script&&!this.entity.script.instances[ScriptType._pcScriptName]){var instance=new ScriptType(this.entity);this.system._preRegisterInstance(this.entity,_unprefixed,ScriptType._pcScriptName,instance)}0===count&&(this.data.areScriptsLoaded=!0,this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)))}.bind(this))}.bind(this))},ScriptLegacyComponent}(Component),ScriptLegacyComponentData=function ScriptLegacyComponentData(){this.scripts=[],this.enabled=!0,this.instances={},this._instances={},this.runInTools=!1,this.attributes={},this.initialized=!1,this.postInitialized=!1,this.areScriptsLoaded=!1},_schema$5=["enabled","scripts","instances","runInTools"],INITIALIZE="initialize",POST_INITIALIZE="postInitialize",UPDATE="update",POST_UPDATE="postUpdate",FIXED_UPDATE="fixedUpdate",TOOLS_UPDATE="toolsUpdate",ON_ENABLE="onEnable",ON_DISABLE="onDisable",ScriptLegacyComponentSystem=function(_ComponentSystem){function ScriptLegacyComponentSystem(app){var _this;return(_this=_ComponentSystem.call(this,app)||this).id="script",_this.ComponentType=ScriptLegacyComponent,_this.DataType=ScriptLegacyComponentData,_this.schema=_schema$5,_this.preloading=!1,_this.instancesWithUpdate=[],_this.instancesWithFixedUpdate=[],_this.instancesWithPostUpdate=[],_this.instancesWithToolsUpdate=[],_this.on("beforeremove",_this.onBeforeRemove,_assertThisInitialized(_this)),ComponentSystem.bind(INITIALIZE,_this.onInitialize,_assertThisInitialized(_this)),ComponentSystem.bind(POST_INITIALIZE,_this.onPostInitialize,_assertThisInitialized(_this)),ComponentSystem.bind(UPDATE,_this.onUpdate,_assertThisInitialized(_this)),ComponentSystem.bind(FIXED_UPDATE,_this.onFixedUpdate,_assertThisInitialized(_this)),ComponentSystem.bind(POST_UPDATE,_this.onPostUpdate,_assertThisInitialized(_this)),ComponentSystem.bind(TOOLS_UPDATE,_this.onToolsUpdate,_assertThisInitialized(_this)),_this}_inheritsLoose(ScriptLegacyComponentSystem,_ComponentSystem);var _proto=ScriptLegacyComponentSystem.prototype;return _proto.initializeComponentData=function initializeComponentData(component,data,properties){properties=["runInTools","enabled","scripts"],data.scripts&&data.scripts.length&&data.scripts.forEach((function(script){if(script.attributes&&Array.isArray(script.attributes)){for(var dict={},i=0;i<script.attributes.length;i++)dict[script.attributes[i].name]=script.attributes[i];script.attributes=dict}})),_ComponentSystem.prototype.initializeComponentData.call(this,component,data,properties)},_proto.cloneComponent=function cloneComponent(entity,clone){for(var src=this.store[entity.getGuid()],data={runInTools:src.data.runInTools,scripts:[],enabled:src.data.enabled},scripts=src.data.scripts,i=0,len=scripts.length;i<len;i++){var attributes=scripts[i].attributes;attributes&&delete scripts[i].attributes,data.scripts.push(extend({},scripts[i])),attributes&&(data.scripts[i].attributes=this._cloneAttributes(attributes),scripts[i].attributes=attributes)}return this.addComponent(clone,data)},_proto.onBeforeRemove=function onBeforeRemove(entity,component){component.enabled&&this._disableScriptComponent(component),this._destroyScriptComponent(component)},_proto.onInitialize=function onInitialize(root){if(this._registerInstances(root),root.enabled){root.script&&root.script.enabled&&this._initializeScriptComponent(root.script);var children=root._children,i,len=children.length;for(i=0;i<len;i++)children[i]instanceof Entity&&this.onInitialize(children[i])}},_proto.onPostInitialize=function onPostInitialize(root){if(root.enabled){root.script&&root.script.enabled&&this._postInitializeScriptComponent(root.script);var children=root._children,i,len=children.length;for(i=0;i<len;i++)children[i]instanceof Entity&&this.onPostInitialize(children[i])}},_proto._callInstancesMethod=function _callInstancesMethod(script,method){var instances=script.data.instances;for(var name in instances)if(instances.hasOwnProperty(name)){var instance=instances[name].instance;instance[method]&&instance[method]()}},_proto._initializeScriptComponent=function _initializeScriptComponent(script){this._callInstancesMethod(script,INITIALIZE),script.data.initialized=!0,script.enabled&&script.entity.enabled&&this._enableScriptComponent(script)},_proto._enableScriptComponent=function _enableScriptComponent(script){this._callInstancesMethod(script,ON_ENABLE)},_proto._disableScriptComponent=function _disableScriptComponent(script){this._callInstancesMethod(script,ON_DISABLE)},_proto._destroyScriptComponent=function _destroyScriptComponent(script){var index,instances=script.data.instances;for(var name in instances)if(instances.hasOwnProperty(name)){var instance=instances[name].instance;instance.destroy&&instance.destroy(),instance.update&&(index=this.instancesWithUpdate.indexOf(instance))>=0&&this.instancesWithUpdate.splice(index,1),instance.fixedUpdate&&(index=this.instancesWithFixedUpdate.indexOf(instance))>=0&&this.instancesWithFixedUpdate.splice(index,1),instance.postUpdate&&(index=this.instancesWithPostUpdate.indexOf(instance))>=0&&this.instancesWithPostUpdate.splice(index,1),instance.toolsUpdate&&(index=this.instancesWithToolsUpdate.indexOf(instance))>=0&&this.instancesWithToolsUpdate.splice(index,1),script.instances[name].instance===script[name]&&delete script[name],delete script.instances[name]}},_proto._postInitializeScriptComponent=function _postInitializeScriptComponent(script){this._callInstancesMethod(script,POST_INITIALIZE),script.data.postInitialized=!0},_proto._updateInstances=function _updateInstances(method,updateList,dt){for(var item,i=0,len=updateList.length;i<len;i++)(item=updateList[i])&&item.entity&&item.entity.enabled&&item.entity.script.enabled&&item[method](dt)},_proto.onUpdate=function onUpdate(dt){this._updateInstances(UPDATE,this.instancesWithUpdate,dt)},_proto.onFixedUpdate=function onFixedUpdate(dt){this._updateInstances(FIXED_UPDATE,this.instancesWithFixedUpdate,dt)},_proto.onPostUpdate=function onPostUpdate(dt){this._updateInstances(POST_UPDATE,this.instancesWithPostUpdate,dt)},_proto.onToolsUpdate=function onToolsUpdate(dt){this._updateInstances(TOOLS_UPDATE,this.instancesWithToolsUpdate,dt)},_proto.broadcast=function broadcast(name,functionName){var args=Array.prototype.slice.call(arguments,2),id,data,fn,dataStore=this.store;for(id in dataStore)dataStore.hasOwnProperty(id)&&(data=dataStore[id].data).instances[name]&&(fn=data.instances[name].instance[functionName])&&fn.apply(data.instances[name].instance,args)},_proto._preRegisterInstance=function _preRegisterInstance(entity,url,name,instance){if(entity.script){if(entity.script.data._instances=entity.script.data._instances||{},entity.script.data._instances[name])throw Error("Script name collision '"+name+"'. Scripts from '"+url+"' and '"+entity.script.data._instances[name].url+"' {"+entity.getGuid()+"}");entity.script.data._instances[name]={url:url,name:name,instance:instance}}},_proto._registerInstances=function _registerInstances(entity){var preRegistered,instance,instanceName;if(entity.script&&entity.script.data._instances){for(instanceName in entity.script.instances=entity.script.data._instances,entity.script.instances){if(instance=(preRegistered=entity.script.instances[instanceName]).instance,events.attach(instance),instance.update&&this.instancesWithUpdate.push(instance),instance.fixedUpdate&&this.instancesWithFixedUpdate.push(instance),instance.postUpdate&&this.instancesWithPostUpdate.push(instance),instance.toolsUpdate&&this.instancesWithToolsUpdate.push(instance),entity.script.scripts&&this._createAccessors(entity,preRegistered),entity.script[instanceName])throw Error("Script with name '"+instanceName+"' is already attached to Script Component");entity.script[instanceName]=instance}delete entity.script.data._instances}var children=entity._children,i,len=children.length;for(i=0;i<len;i++)children[i]instanceof Entity&&this._registerInstances(children[i])},_proto._cloneAttributes=function _cloneAttributes(attributes){var result={};for(var key in attributes)if(attributes.hasOwnProperty(key))if("entity"!==attributes[key].type)result[key]=extend({},attributes[key]);else{var val=attributes[key].value;delete attributes[key].value,result[key]=extend({},attributes[key]),result[key].value=val,attributes[key].value=val}return result},_proto._createAccessors=function _createAccessors(entity,instance){var self=this,i,len=entity.script.scripts.length,url=instance.url;for(i=0;i<len;i++){var script=entity.script.scripts[i];if(script.url===url){var attributes=script.attributes;if(script.name&&attributes){for(var key in attributes)attributes.hasOwnProperty(key)&&this._createAccessor(attributes[key],instance);entity.script.data.attributes[script.name]=this._cloneAttributes(attributes)}break}}},_proto._createAccessor=function _createAccessor(attribute,instance){var self=this;attribute={name:attribute.name,value:attribute.value,type:attribute.type},self._convertAttributeValue(attribute),Object.defineProperty(instance.instance,attribute.name,{get:function get(){return attribute.value},set:function set(value){var oldValue=attribute.value;attribute.value=value,self._convertAttributeValue(attribute),instance.instance.fire("set",attribute.name,oldValue,attribute.value)},configurable:!0})},_proto._updateAccessors=function _updateAccessors(entity,instance){var self=this,i,len=entity.script.scripts.length,key,url=instance.url,scriptComponent,script,name,attributes,previousAttributes,oldAttribute;for(i=0;i<len;i++)if((script=(scriptComponent=entity.script).scripts[i]).url===url){if(name=script.name,attributes=script.attributes,name){if(attributes)for(key in attributes)attributes.hasOwnProperty(key)&&this._createAccessor(attributes[key],instance);if(previousAttributes=scriptComponent.data.attributes[name])for(key in previousAttributes)oldAttribute=previousAttributes[key],key in attributes?attributes[key].value!==oldAttribute.value&&instance.instance.onAttributeChanged&&instance.instance.onAttributeChanged(oldAttribute.name,oldAttribute.value,attributes[key].value):delete instance.instance[oldAttribute.name];attributes?scriptComponent.data.attributes[name]=this._cloneAttributes(attributes):delete scriptComponent.data.attributes[name]}break}},_proto._convertAttributeValue=function _convertAttributeValue(attribute){if("rgb"===attribute.type||"rgba"===attribute.type)Array.isArray(attribute.value)&&(attribute.value=3===attribute.value.length?new Color(attribute.value[0],attribute.value[1],attribute.value[2]):new Color(attribute.value[0],attribute.value[1],attribute.value[2],attribute.value[3]));else if("vec2"===attribute.type)Array.isArray(attribute.value)&&(attribute.value=new Vec2(attribute.value[0],attribute.value[1]));else if("vec3"===attribute.type||"vector"===attribute.type)Array.isArray(attribute.value)&&(attribute.value=new Vec3(attribute.value[0],attribute.value[1],attribute.value[2]));else if("vec4"===attribute.type)Array.isArray(attribute.value)&&(attribute.value=new Vec4(attribute.value[0],attribute.value[1],attribute.value[2],attribute.value[3]));else if("entity"===attribute.type)null!==attribute.value&&"string"==typeof attribute.value&&(attribute.value=this.app.root.findByGuid(attribute.value));else if("curve"===attribute.type||"colorcurve"===attribute.type){var curveType=attribute.value.keys[0]instanceof Array?CurveSet:Curve;attribute.value=new curveType(attribute.value.keys),attribute.value.type=attribute.value.type}},ScriptLegacyComponentSystem}(ComponentSystem);Component._buildAccessors(ScriptLegacyComponent.prototype,_schema$5);var _inputScreenPosition=new Vec2,_inputWorldPosition=new Vec3,_rayOrigin=new Vec3,_rayDirection=new Vec3,_planeOrigin=new Vec3,_planeNormal=new Vec3,_entityRotation=new Quat,OPPOSITE_AXIS={x:"y",y:"x"},ElementDragHelper=function(_EventHandler){function ElementDragHelper(element,axis){var _this;if(_this=_EventHandler.call(this)||this,!(element&&element instanceof ElementComponent))throw new Error("Element was null or not an ElementComponent");if(axis&&"x"!==axis&&"y"!==axis)throw new Error("Unrecognized axis: "+axis);return _this._element=element,_this._app=element.system.app,_this._axis=axis||null,_this._enabled=!0,_this._dragScale=new Vec3,_this._dragStartMousePosition=new Vec3,_this._dragStartHandlePosition=new Vec3,_this._deltaMousePosition=new Vec3,_this._deltaHandlePosition=new Vec3,_this._isDragging=!1,_this._toggleLifecycleListeners("on"),_this}_inheritsLoose(ElementDragHelper,_EventHandler);var _proto=ElementDragHelper.prototype;return _proto._toggleLifecycleListeners=function _toggleLifecycleListeners(onOrOff){this._element[onOrOff]("mousedown",this._onMouseDownOrTouchStart,this),this._element[onOrOff]("touchstart",this._onMouseDownOrTouchStart,this)},_proto._toggleDragListeners=function _toggleDragListeners(onOrOff){var isOn="on"===onOrOff,addOrRemoveEventListener=isOn?"addEventListener":"removeEventListener";this._hasDragListeners&&isOn||(this._handleMouseUpOrTouchEnd||(this._handleMouseUpOrTouchEnd=this._onMouseUpOrTouchEnd.bind(this)),this._app.mouse&&(this._app.mouse[onOrOff]("mousemove",this._onMove,this),window[addOrRemoveEventListener]("mouseup",this._handleMouseUpOrTouchEnd,!1)),platform.touch&&(this._app.touch[onOrOff]("touchmove",this._onMove,this),window[addOrRemoveEventListener]("touchend",this._handleMouseUpOrTouchEnd,!1),window[addOrRemoveEventListener]("touchcancel",this._handleMouseUpOrTouchEnd,!1)),this._hasDragListeners=isOn)},_proto._onMouseDownOrTouchStart=function _onMouseDownOrTouchStart(event){if(this._element&&!this._isDragging&&this.enabled){this._dragCamera=event.camera,this._calculateDragScale();var currentMousePosition=this._screenToLocal(event);currentMousePosition&&(this._toggleDragListeners("on"),this._isDragging=!0,this._dragStartMousePosition.copy(currentMousePosition),this._dragStartHandlePosition.copy(this._element.entity.getLocalPosition()),this.fire("drag:start"))}},_proto._onMouseUpOrTouchEnd=function _onMouseUpOrTouchEnd(){this._isDragging&&(this._isDragging=!1,this._toggleDragListeners("off"),this.fire("drag:end"))},_proto._screenToLocal=function _screenToLocal(event){this._determineInputPosition(event),this._chooseRayOriginAndDirection(),_planeOrigin.copy(this._element.entity.getPosition()),_planeNormal.copy(this._element.entity.forward).mulScalar(-1);var denominator=_planeNormal.dot(_rayDirection);if(Math.abs(denominator)>0){var rayOriginToPlaneOrigin,collisionDistance=_planeOrigin.sub(_rayOrigin).dot(_planeNormal)/denominator,position=_rayOrigin.add(_rayDirection.mulScalar(collisionDistance));return _entityRotation.copy(this._element.entity.getRotation()).invert().transformVector(position,position),position.mul(this._dragScale),position}return null},_proto._determineInputPosition=function _determineInputPosition(event){var devicePixelRatio=this._app.graphicsDevice.maxPixelRatio;void 0!==event.x&&void 0!==event.y?(_inputScreenPosition.x=event.x*devicePixelRatio,_inputScreenPosition.y=event.y*devicePixelRatio):event.changedTouches?(_inputScreenPosition.x=event.changedTouches[0].x*devicePixelRatio,_inputScreenPosition.y=event.changedTouches[0].y*devicePixelRatio):console.warn("Could not determine position from input event")},_proto._chooseRayOriginAndDirection=function _chooseRayOriginAndDirection(){this._element.screen&&this._element.screen.screen.screenSpace?(_rayOrigin.set(_inputScreenPosition.x,-_inputScreenPosition.y,0),_rayDirection.set(0,0,-1)):(_inputWorldPosition.copy(this._dragCamera.screenToWorld(_inputScreenPosition.x,_inputScreenPosition.y,1)),_rayOrigin.copy(this._dragCamera.entity.getPosition()),_rayDirection.copy(_inputWorldPosition).sub(_rayOrigin).normalize())},_proto._calculateDragScale=function _calculateDragScale(){var current=this._element.entity.parent,screen=this._element.screen&&this._element.screen.screen,isWithin2DScreen=screen&&screen.screenSpace,screenScale=isWithin2DScreen?screen.scale:1,dragScale=this._dragScale;for(dragScale.set(screenScale,screenScale,screenScale);current&&(dragScale.mul(current.getLocalScale()),current=current.parent,!isWithin2DScreen||!current.screen););dragScale.x=1/dragScale.x,dragScale.y=1/dragScale.y,dragScale.z=1/dragScale.z},_proto._onMove=function _onMove(event){if(this._element&&this._isDragging&&this.enabled&&this._element.enabled&&this._element.entity.enabled){var currentMousePosition=this._screenToLocal(event);if(this._dragStartMousePosition&&currentMousePosition){if(this._deltaMousePosition.copy(currentMousePosition).sub(this._dragStartMousePosition),this._deltaHandlePosition.copy(this._dragStartHandlePosition).add(this._deltaMousePosition),this._axis){var currentPosition=this._element.entity.getLocalPosition(),constrainedAxis=OPPOSITE_AXIS[this._axis];this._deltaHandlePosition[constrainedAxis]=currentPosition[constrainedAxis]}this._element.entity.setLocalPosition(this._deltaHandlePosition),this.fire("drag:move",this._deltaHandlePosition)}}},_proto.destroy=function destroy(){this._toggleLifecycleListeners("off"),this._toggleDragListeners("off")},_createClass(ElementDragHelper,[{key:"enabled",get:function get(){return this._enabled},set:function set(value){this._enabled=value}},{key:"isDragging",get:function get(){return this._isDragging}}]),ElementDragHelper}(EventHandler),SCROLL_MODE_CLAMP=0,SCROLL_MODE_BOUNCE=1,SCROLL_MODE_INFINITE=2,SCROLLBAR_VISIBILITY_SHOW_ALWAYS=0,SCROLLBAR_VISIBILITY_SHOW_WHEN_REQUIRED=1,_tempScrollValue=new Vec2,ScrollViewComponent=function(_Component){function ScrollViewComponent(system,entity){var _this;return(_this=_Component.call(this,system,entity)||this)._viewportReference=new EntityReference(_assertThisInitialized(_this),"viewportEntity",{"element#gain":_this._onViewportElementGain,"element#resize":_this._onSetContentOrViewportSize}),_this._contentReference=new EntityReference(_assertThisInitialized(_this),"contentEntity",{"element#gain":_this._onContentElementGain,"element#lose":_this._onContentElementLose,"element#resize":_this._onSetContentOrViewportSize}),_this._scrollbarUpdateFlags={},_this._scrollbarReferences={},_this._scrollbarReferences[0]=new EntityReference(_assertThisInitialized(_this),"horizontalScrollbarEntity",{"scrollbar#set:value":_this._onSetHorizontalScrollbarValue,"scrollbar#gain":_this._onHorizontalScrollbarGain}),_this._scrollbarReferences[1]=new EntityReference(_assertThisInitialized(_this),"verticalScrollbarEntity",{"scrollbar#set:value":_this._onSetVerticalScrollbarValue,"scrollbar#gain":_this._onVerticalScrollbarGain}),_this._prevContentSizes={},_this._prevContentSizes[0]=null,_this._prevContentSizes[1]=null,_this._scroll=new Vec2,_this._velocity=new Vec3,_this._dragStartPosition=new Vec3,_this._disabledContentInput=!1,_this._disabledContentInputEntities=[],_this._toggleLifecycleListeners("on",system),_this._toggleElementListeners("on"),_this}_inheritsLoose(ScrollViewComponent,_Component);var _proto=ScrollViewComponent.prototype;return _proto._toggleLifecycleListeners=function _toggleLifecycleListeners(onOrOff,system){this[onOrOff]("set_horizontal",this._onSetHorizontalScrollingEnabled,this),this[onOrOff]("set_vertical",this._onSetVerticalScrollingEnabled,this),system.app.systems.element[onOrOff]("add",this._onElementComponentAdd,this),system.app.systems.element[onOrOff]("beforeremove",this._onElementComponentRemove,this)},_proto._toggleElementListeners=function _toggleElementListeners(onOrOff){if(this.entity.element){if("on"===onOrOff&&this._hasElementListeners)return;this.entity.element[onOrOff]("resize",this._onSetContentOrViewportSize,this),this._hasElementListeners="on"===onOrOff}},_proto._onElementComponentAdd=function _onElementComponentAdd(entity){this.entity===entity&&this._toggleElementListeners("on")},_proto._onElementComponentRemove=function _onElementComponentRemove(entity){this.entity===entity&&this._toggleElementListeners("off")},_proto._onViewportElementGain=function _onViewportElementGain(){this._syncAll()},_proto._onContentElementGain=function _onContentElementGain(){this._destroyDragHelper(),this._contentDragHelper=new ElementDragHelper(this._contentReference.entity.element),this._contentDragHelper.on("drag:start",this._onContentDragStart,this),this._contentDragHelper.on("drag:end",this._onContentDragEnd,this),this._contentDragHelper.on("drag:move",this._onContentDragMove,this),this._prevContentSizes[0]=null,this._prevContentSizes[1]=null,this._syncAll()},_proto._onContentElementLose=function _onContentElementLose(){this._destroyDragHelper()},_proto._onContentDragStart=function _onContentDragStart(){this._contentReference.entity&&this.enabled&&this.entity.enabled&&this._dragStartPosition.copy(this._contentReference.entity.getLocalPosition())},_proto._onContentDragEnd=function _onContentDragEnd(){this._prevContentDragPosition=null,this._enableContentInput()},_proto._onContentDragMove=function _onContentDragMove(position){if(this._contentReference.entity&&this.enabled&&this.entity.enabled&&(this._wasDragged=!0,this._setScrollFromContentPosition(position),this._setVelocityFromContentPositionDelta(position),!this._disabledContentInput)){var dx=position.x-this._dragStartPosition.x,dy=position.y-this._dragStartPosition.y;(Math.abs(dx)>this.dragThreshold||Math.abs(dy)>this.dragThreshold)&&this._disableContentInput()}},_proto._onSetContentOrViewportSize=function _onSetContentOrViewportSize(){this._syncAll()},_proto._onSetHorizontalScrollbarValue=function _onSetHorizontalScrollbarValue(scrollValueX){!this._scrollbarUpdateFlags[0]&&this.enabled&&this.entity.enabled&&this._onSetScroll(scrollValueX,null)},_proto._onSetVerticalScrollbarValue=function _onSetVerticalScrollbarValue(scrollValueY){!this._scrollbarUpdateFlags[1]&&this.enabled&&this.entity.enabled&&this._onSetScroll(null,scrollValueY)},_proto._onSetHorizontalScrollingEnabled=function _onSetHorizontalScrollingEnabled(){this._syncScrollbarEnabledState(0)},_proto._onSetVerticalScrollingEnabled=function _onSetVerticalScrollingEnabled(){this._syncScrollbarEnabledState(1)},_proto._onHorizontalScrollbarGain=function _onHorizontalScrollbarGain(){this._syncScrollbarEnabledState(0),this._syncScrollbarPosition(0)},_proto._onVerticalScrollbarGain=function _onVerticalScrollbarGain(){this._syncScrollbarEnabledState(1),this._syncScrollbarPosition(1)},_proto._onSetScroll=function _onSetScroll(x,y,resetVelocity){!1!==resetVelocity&&this._velocity.set(0,0,0);var hasChanged=!1;hasChanged|=this._updateAxis(x,"x",0),(hasChanged|=this._updateAxis(y,"y",1))&&this.fire("set:scroll",this._scroll)},_proto._updateAxis=function _updateAxis(scrollValue,axis,orientation){var hasChanged=null!==scrollValue&&Math.abs(scrollValue-this._scroll[axis])>1e-5;return(hasChanged||this._isDragging()||0===scrollValue)&&(this._scroll[axis]=this._determineNewScrollValue(scrollValue,axis,orientation),this._syncContentPosition(orientation),this._syncScrollbarPosition(orientation)),hasChanged},_proto._determineNewScrollValue=function _determineNewScrollValue(scrollValue,axis,orientation){if(!this._getScrollingEnabled(orientation))return this._scroll[axis];switch(this.scrollMode){case 0:return math.clamp(scrollValue,0,this._getMaxScrollValue(orientation));case 1:return this._setVelocityFromOvershoot(scrollValue,axis,orientation),scrollValue;case 2:return scrollValue;default:return console.warn("Unhandled scroll mode:"+this.scrollMode),scrollValue}},_proto._syncAll=function _syncAll(){this._syncContentPosition(0),this._syncContentPosition(1),this._syncScrollbarPosition(0),this._syncScrollbarPosition(1),this._syncScrollbarEnabledState(0),this._syncScrollbarEnabledState(1)},_proto._syncContentPosition=function _syncContentPosition(orientation){var axis=this._getAxis(orientation),sign=this._getSign(orientation),contentEntity=this._contentReference.entity;if(contentEntity){var prevContentSize=this._prevContentSizes[orientation],currContentSize=this._getContentSize(orientation);if(null!==prevContentSize&&Math.abs(prevContentSize-currContentSize)>1e-4){var prevMaxOffset=this._getMaxOffset(orientation,prevContentSize),currMaxOffset=this._getMaxOffset(orientation,currContentSize);this._scroll[axis]=0===currMaxOffset?1:math.clamp(this._scroll[axis]*prevMaxOffset/currMaxOffset,0,1)}var offset=this._scroll[axis]*this._getMaxOffset(orientation),contentPosition=contentEntity.getLocalPosition();contentPosition[axis]=offset*sign,contentEntity.setLocalPosition(contentPosition),this._prevContentSizes[orientation]=currContentSize}},_proto._syncScrollbarPosition=function _syncScrollbarPosition(orientation){var axis=this._getAxis(orientation),scrollbarEntity=this._scrollbarReferences[orientation].entity;scrollbarEntity&&scrollbarEntity.scrollbar&&(this._scrollbarUpdateFlags[orientation]=!0,scrollbarEntity.scrollbar.value=this._scroll[axis],scrollbarEntity.scrollbar.handleSize=this._getScrollbarHandleSize(axis,orientation),this._scrollbarUpdateFlags[orientation]=!1)},_proto._syncScrollbarEnabledState=function _syncScrollbarEnabledState(orientation){var entity=this._scrollbarReferences[orientation].entity;if(entity){var isScrollingEnabled=this._getScrollingEnabled(orientation),requestedVisibility=this._getScrollbarVisibility(orientation);switch(requestedVisibility){case 0:return void(entity.enabled=isScrollingEnabled);case 1:return void(entity.enabled=isScrollingEnabled&&this._contentIsLargerThanViewport(orientation));default:console.warn("Unhandled scrollbar visibility:"+requestedVisibility),entity.enabled=isScrollingEnabled}}},_proto._contentIsLargerThanViewport=function _contentIsLargerThanViewport(orientation){return this._getContentSize(orientation)>this._getViewportSize(orientation)},_proto._contentPositionToScrollValue=function _contentPositionToScrollValue(contentPosition){var maxOffsetH=this._getMaxOffset(0),maxOffsetV=this._getMaxOffset(1);return _tempScrollValue.x=0===maxOffsetH?0:contentPosition.x/maxOffsetH,_tempScrollValue.y=0===maxOffsetV?0:contentPosition.y/-maxOffsetV,_tempScrollValue},_proto._getMaxOffset=function _getMaxOffset(orientation,contentSize){contentSize=void 0===contentSize?this._getContentSize(orientation):contentSize;var viewportSize=this._getViewportSize(orientation);return contentSize<viewportSize?-this._getViewportSize(orientation):viewportSize-contentSize},_proto._getMaxScrollValue=function _getMaxScrollValue(orientation){return this._contentIsLargerThanViewport(orientation)?1:0},_proto._getScrollbarHandleSize=function _getScrollbarHandleSize(axis,orientation){var viewportSize=this._getViewportSize(orientation),contentSize=this._getContentSize(orientation);if(Math.abs(contentSize)<.001)return 1;var handleSize=Math.min(viewportSize/contentSize,1),overshoot=this._toOvershoot(this._scroll[axis],orientation);return 0===overshoot?handleSize:handleSize/(1+Math.abs(overshoot))},_proto._getViewportSize=function _getViewportSize(orientation){return this._getSize(orientation,this._viewportReference)},_proto._getContentSize=function _getContentSize(orientation){return this._getSize(orientation,this._contentReference)},_proto._getSize=function _getSize(orientation,entityReference){return entityReference.entity&&entityReference.entity.element?entityReference.entity.element[this._getCalculatedDimension(orientation)]:0},_proto._getScrollingEnabled=function _getScrollingEnabled(orientation){return 0===orientation?this.horizontal:1===orientation?this.vertical:void console.warn("Unrecognized orientation: "+orientation)},_proto._getScrollbarVisibility=function _getScrollbarVisibility(orientation){return 0===orientation?this.horizontalScrollbarVisibility:1===orientation?this.verticalScrollbarVisibility:void console.warn("Unrecognized orientation: "+orientation)},_proto._getSign=function _getSign(orientation){return 0===orientation?1:-1},_proto._getAxis=function _getAxis(orientation){return 0===orientation?"x":"y"},_proto._getCalculatedDimension=function _getCalculatedDimension(orientation){return 0===orientation?"calculatedWidth":"calculatedHeight"},_proto._destroyDragHelper=function _destroyDragHelper(){this._contentDragHelper&&this._contentDragHelper.destroy()},_proto.onUpdate=function onUpdate(){this._contentReference.entity&&(this._updateVelocity(),this._syncScrollbarEnabledState(0),this._syncScrollbarEnabledState(1))},_proto._updateVelocity=function _updateVelocity(){if(!this._isDragging()&&(1===this.scrollMode&&(this._hasOvershoot("x",0)&&this._setVelocityFromOvershoot(this.scroll.x,"x",0),this._hasOvershoot("y",1)&&this._setVelocityFromOvershoot(this.scroll.y,"y",1)),this._velocity.x*=1-this.friction,this._velocity.y*=1-this.friction,Math.abs(this._velocity.x)>1e-4||Math.abs(this._velocity.y)>1e-4)){var position=this._contentReference.entity.getLocalPosition();position.x+=this._velocity.x,position.y+=this._velocity.y,this._contentReference.entity.setLocalPosition(position),this._setScrollFromContentPosition(position)}},_proto._hasOvershoot=function _hasOvershoot(axis,orientation){return Math.abs(this._toOvershoot(this.scroll[axis],orientation))>.001},_proto._toOvershoot=function _toOvershoot(scrollValue,orientation){var maxScrollValue=this._getMaxScrollValue(orientation);return scrollValue<0?scrollValue:scrollValue>maxScrollValue?scrollValue-maxScrollValue:0},_proto._setVelocityFromOvershoot=function _setVelocityFromOvershoot(scrollValue,axis,orientation){var overshootValue,overshootPixels=this._toOvershoot(scrollValue,orientation)*this._getMaxOffset(orientation)*this._getSign(orientation);Math.abs(overshootPixels)>0&&(this._velocity[axis]=-overshootPixels/(50*this.bounceAmount+1))},_proto._setVelocityFromContentPositionDelta=function _setVelocityFromContentPositionDelta(position){this._prevContentDragPosition?(this._velocity.sub2(position,this._prevContentDragPosition),this._prevContentDragPosition.copy(position)):(this._velocity.set(0,0,0),this._prevContentDragPosition=position.clone())},_proto._setScrollFromContentPosition=function _setScrollFromContentPosition(position){var scrollValue=this._contentPositionToScrollValue(position);this._isDragging()&&(scrollValue=this._applyScrollValueTension(scrollValue)),this._onSetScroll(scrollValue.x,scrollValue.y,!1)},_proto._applyScrollValueTension=function _applyScrollValueTension(scrollValue){var max,overshoot,factor=1;return max=this._getMaxScrollValue(0),(overshoot=this._toOvershoot(scrollValue.x,0))>0?scrollValue.x=max+1*Math.log10(1+overshoot):overshoot<0&&(scrollValue.x=-1*Math.log10(1-overshoot)),max=this._getMaxScrollValue(1),(overshoot=this._toOvershoot(scrollValue.y,1))>0?scrollValue.y=max+1*Math.log10(1+overshoot):overshoot<0&&(scrollValue.y=-1*Math.log10(1-overshoot)),scrollValue},_proto._isDragging=function _isDragging(){return this._contentDragHelper&&this._contentDragHelper.isDragging},_proto._setScrollbarComponentsEnabled=function _setScrollbarComponentsEnabled(enabled){this._scrollbarReferences[0].hasComponent("scrollbar")&&(this._scrollbarReferences[0].entity.scrollbar.enabled=enabled),this._scrollbarReferences[1].hasComponent("scrollbar")&&(this._scrollbarReferences[1].entity.scrollbar.enabled=enabled)},_proto._setContentDraggingEnabled=function _setContentDraggingEnabled(enabled){this._contentDragHelper&&(this._contentDragHelper.enabled=enabled)},_proto._enableContentInput=function _enableContentInput(){for(;this._disabledContentInputEntities.length;){var e=this._disabledContentInputEntities.pop();e.element&&(e.element.useInput=!0)}this._disabledContentInput=!1},_proto._disableContentInput=function _disableContentInput(){var self=this,_disableInput=function _disableInput(e){e.element&&e.element.useInput&&(self._disabledContentInputEntities.push(e),e.element.useInput=!1);var children=e.children,i,l;for(i=0,l=children.length;i<l;i++)_disableInput(children[i])},contentEntity=this._contentReference.entity;if(contentEntity){var children=contentEntity.children,i,l=children.length;for(i=0;i<l;i++)_disableInput(children[i])}this._disabledContentInput=!0},_proto.onEnable=function onEnable(){this._viewportReference.onParentComponentEnable(),this._contentReference.onParentComponentEnable(),this._scrollbarReferences[0].onParentComponentEnable(),this._scrollbarReferences[1].onParentComponentEnable(),this._setScrollbarComponentsEnabled(!0),this._setContentDraggingEnabled(!0),this._syncAll()},_proto.onDisable=function onDisable(){this._setScrollbarComponentsEnabled(!1),this._setContentDraggingEnabled(!1)},_proto.onRemove=function onRemove(){this._toggleLifecycleListeners("off",this.system),this._toggleElementListeners("off"),this._destroyDragHelper()},_createClass(ScrollViewComponent,[{key:"scroll",get:function get(){return this._scroll},set:function set(value){this._onSetScroll(value.x,value.y)}}]),ScrollViewComponent}(Component),ScrollViewComponentData=function ScrollViewComponentData(){this.enabled=!0},_schema$4=[{name:"enabled",type:"boolean"},{name:"horizontal",type:"boolean"},{name:"vertical",type:"boolean"},{name:"scrollMode",type:"number"},{name:"bounceAmount",type:"number"},{name:"friction",type:"number"},{name:"dragThreshold",type:"number"},{name:"horizontalScrollbarVisibility",type:"number"},{name:"verticalScrollbarVisibility",type:"number"},{name:"viewportEntity",type:"entity"},{name:"contentEntity",type:"entity"},{name:"horizontalScrollbarEntity",type:"entity"},{name:"verticalScrollbarEntity",type:"entity"}],DEFAULT_DRAG_THRESHOLD=10,ScrollViewComponentSystem=function(_ComponentSystem){function ScrollViewComponentSystem(app){var _this;return(_this=_ComponentSystem.call(this,app)||this).id="scrollview",_this.ComponentType=ScrollViewComponent,_this.DataType=ScrollViewComponentData,_this.schema=_schema$4,_this.on("beforeremove",_this._onRemoveComponent,_assertThisInitialized(_this)),ComponentSystem.bind("update",_this.onUpdate,_assertThisInitialized(_this)),_this}_inheritsLoose(ScrollViewComponentSystem,_ComponentSystem);var _proto=ScrollViewComponentSystem.prototype;return _proto.initializeComponentData=function initializeComponentData(component,data,properties){void 0===data.dragThreshold&&(data.dragThreshold=10),_ComponentSystem.prototype.initializeComponentData.call(this,component,data,_schema$4)},_proto.onUpdate=function onUpdate(dt){var components=this.store;for(var id in components){var entity=components[id].entity,component=entity.scrollview;component.enabled&&entity.enabled&&component.onUpdate()}},_proto._onRemoveComponent=function _onRemoveComponent(entity,component){component.onRemove()},ScrollViewComponentSystem}(ComponentSystem);Component._buildAccessors(ScrollViewComponent.prototype,_schema$4);var ScrollbarComponent=function(_Component){function ScrollbarComponent(system,entity){var _this;return(_this=_Component.call(this,system,entity)||this)._app=system.app,_this._handleReference=new EntityReference(_assertThisInitialized(_this),"handleEntity",{"element#gain":_this._onHandleElementGain,"element#lose":_this._onHandleElementLose,"element#set:anchor":_this._onSetHandleAlignment,"element#set:margin":_this._onSetHandleAlignment,"element#set:pivot":_this._onSetHandleAlignment}),_this._toggleLifecycleListeners("on"),_this}_inheritsLoose(ScrollbarComponent,_Component);var _proto=ScrollbarComponent.prototype;return _proto._toggleLifecycleListeners=function _toggleLifecycleListeners(onOrOff){this[onOrOff]("set_value",this._onSetValue,this),this[onOrOff]("set_handleSize",this._onSetHandleSize,this),this[onOrOff]("set_orientation",this._onSetOrientation,this)},_proto._onHandleElementGain=function _onHandleElementGain(){this._destroyDragHelper(),this._handleDragHelper=new ElementDragHelper(this._handleReference.entity.element,this._getAxis()),this._handleDragHelper.on("drag:move",this._onHandleDrag,this),this._updateHandlePositionAndSize()},_proto._onHandleElementLose=function _onHandleElementLose(){this._destroyDragHelper()},_proto._onHandleDrag=function _onHandleDrag(position){this._handleReference.entity&&this.enabled&&this.entity.enabled&&(this.value=this._handlePositionToScrollValue(position[this._getAxis()]))},_proto._onSetValue=function _onSetValue(name,oldValue,newValue){Math.abs(newValue-oldValue)>1e-5&&(this.data.value=math.clamp(newValue,0,1),this._updateHandlePositionAndSize(),this.fire("set:value",this.data.value))},_proto._onSetHandleSize=function _onSetHandleSize(name,oldValue,newValue){Math.abs(newValue-oldValue)>1e-5&&(this.data.handleSize=math.clamp(newValue,0,1),this._updateHandlePositionAndSize())},_proto._onSetHandleAlignment=function _onSetHandleAlignment(){this._updateHandlePositionAndSize()},_proto._onSetOrientation=function _onSetOrientation(name,oldValue,newValue){newValue!==oldValue&&this._handleReference.hasComponent("element")&&(this._handleReference.entity.element[this._getOppositeDimension()]=0)},_proto._updateHandlePositionAndSize=function _updateHandlePositionAndSize(){var handleEntity=this._handleReference.entity,handleElement=handleEntity&&handleEntity.element;if(handleEntity){var position=handleEntity.getLocalPosition();position[this._getAxis()]=this._getHandlePosition(),this._handleReference.entity.setLocalPosition(position)}handleElement&&(handleElement[this._getDimension()]=this._getHandleLength())},_proto._handlePositionToScrollValue=function _handlePositionToScrollValue(handlePosition){return handlePosition*this._getSign()/this._getUsableTrackLength()},_proto._scrollValueToHandlePosition=function _scrollValueToHandlePosition(value){return value*this._getSign()*this._getUsableTrackLength()},_proto._getUsableTrackLength=function _getUsableTrackLength(){return Math.max(this._getTrackLength()-this._getHandleLength(),.001)},_proto._getTrackLength=function _getTrackLength(){return this.entity.element?0===this.orientation?this.entity.element.calculatedWidth:this.entity.element.calculatedHeight:0},_proto._getHandleLength=function _getHandleLength(){return this._getTrackLength()*this.handleSize},_proto._getHandlePosition=function _getHandlePosition(){return this._scrollValueToHandlePosition(this.value)},_proto._getSign=function _getSign(){return 0===this.orientation?1:-1},_proto._getAxis=function _getAxis(){return 0===this.orientation?"x":"y"},_proto._getDimension=function _getDimension(){return 0===this.orientation?"width":"height"},_proto._getOppositeDimension=function _getOppositeDimension(){return 0===this.orientation?"height":"width"},_proto._destroyDragHelper=function _destroyDragHelper(){this._handleDragHelper&&this._handleDragHelper.destroy()},_proto._setHandleDraggingEnabled=function _setHandleDraggingEnabled(enabled){this._handleDragHelper&&(this._handleDragHelper.enabled=enabled)},_proto.onEnable=function onEnable(){this._handleReference.onParentComponentEnable(),this._setHandleDraggingEnabled(!0)},_proto.onDisable=function onDisable(){this._setHandleDraggingEnabled(!1)},_proto.onRemove=function onRemove(){this._destroyDragHelper(),this._toggleLifecycleListeners("off")},ScrollbarComponent}(Component),ScrollbarComponentData=function ScrollbarComponentData(){this.enabled=!0},_schema$3=[{name:"enabled",type:"boolean"},{name:"orientation",type:"number"},{name:"value",type:"number"},{name:"handleSize",type:"number"},{name:"handleEntity",type:"entity"}],ScrollbarComponentSystem=function(_ComponentSystem){function ScrollbarComponentSystem(app){var _this;return(_this=_ComponentSystem.call(this,app)||this).id="scrollbar",_this.ComponentType=ScrollbarComponent,_this.DataType=ScrollbarComponentData,_this.schema=_schema$3,_this.on("beforeremove",_this._onRemoveComponent,_assertThisInitialized(_this)),_this}_inheritsLoose(ScrollbarComponentSystem,_ComponentSystem);var _proto=ScrollbarComponentSystem.prototype;return _proto.initializeComponentData=function initializeComponentData(component,data,properties){_ComponentSystem.prototype.initializeComponentData.call(this,component,data,_schema$3)},_proto._onRemoveComponent=function _onRemoveComponent(entity,component){component.onRemove()},ScrollbarComponentSystem}(ComponentSystem);Component._buildAccessors(ScrollbarComponent.prototype,_schema$3);var STATE_PLAYING=0,STATE_PAUSED=1,STATE_STOPPED=2;function capTime(time,duration){return time%duration||0}var SoundInstance=function(_EventHandler){function SoundInstance(manager,sound,options){var _this;return(_this=_EventHandler.call(this)||this)._manager=manager,_this._volume=void 0!==options.volume?math.clamp(Number(options.volume)||0,0,1):1,_this._pitch=void 0!==options.pitch?Math.max(.01,Number(options.pitch)||0):1,_this._loop=!(void 0===options.loop||!options.loop),_this._sound=sound,_this._state=2,_this._suspended=!1,_this._suspendEndEvent=!1,_this._suspendInstanceEvents=!1,_this._playWhenLoaded=!0,_this._startTime=Math.max(0,Number(options.startTime)||0),_this._duration=Math.max(0,Number(options.duration)||0),_this._startOffset=null,_this.source=null,_this._onPlayCallback=options.onPlay,_this._onPauseCallback=options.onPause,_this._onResumeCallback=options.onResume,_this._onStopCallback=options.onStop,_this._onEndCallback=options.onEnd,hasAudioContext()?(_this._startedAt=0,_this._currentTime=0,_this._currentOffset=0,_this._inputNode=null,_this._connectorNode=null,_this._firstNode=null,_this._lastNode=null,_this._initializeNodes(),_this._endedHandler=_this._onEnded.bind(_assertThisInitialized(_this))):(_this._isReady=!1,_this._loadedMetadataHandler=_this._onLoadedMetadata.bind(_assertThisInitialized(_this)),_this._timeUpdateHandler=_this._onTimeUpdate.bind(_assertThisInitialized(_this)),_this._endedHandler=_this._onEnded.bind(_assertThisInitialized(_this)),_this._createSource()),_this}_inheritsLoose(SoundInstance,_EventHandler);var _proto=SoundInstance.prototype;return _proto._onPlay=function _onPlay(){this.fire("play"),this._onPlayCallback&&this._onPlayCallback(this)},_proto._onPause=function _onPause(){this.fire("pause"),this._onPauseCallback&&this._onPauseCallback(this)},_proto._onResume=function _onResume(){this.fire("resume"),this._onResumeCallback&&this._onResumeCallback(this)},_proto._onStop=function _onStop(){this.fire("stop"),this._onStopCallback&&this._onStopCallback(this)},_proto._onEnded=function _onEnded(){this._suspendEndEvent?this._suspendEndEvent=!1:(this.fire("end"),this._onEndCallback&&this._onEndCallback(this),this.stop())},_proto._onManagerVolumeChange=function _onManagerVolumeChange(){this.volume=this._volume},_proto._onManagerSuspend=function _onManagerSuspend(){0!==this._state||this._suspended||(this._suspended=!0,this.pause())},_proto._onManagerResume=function _onManagerResume(){this._suspended&&(this._suspended=!1,this.resume())},_createClass(SoundInstance,[{key:"loop",get:function get(){return this._loop},set:function set(value){this._loop=!!value,this.source&&(this.source.loop=this._loop)}},{key:"startTime",get:function get(){return this._startTime},set:function set(value){this._startTime=Math.max(0,Number(value)||0);var isPlaying=0===this._state;this.stop(),isPlaying&&this.play()}},{key:"duration",get:function get(){return this._sound?this._duration?capTime(this._duration,this._sound.duration):this._sound.duration:0},set:function set(value){this._duration=Math.max(0,Number(value)||0);var isPlaying=0===this._state;this.stop(),isPlaying&&this.play()}},{key:"isPlaying",get:function get(){return 0===this._state}},{key:"isPaused",get:function get(){return 1===this._state}},{key:"isStopped",get:function get(){return 2===this._state}},{key:"isSuspended",get:function get(){return this._suspended}}]),SoundInstance}(EventHandler);hasAudioContext()?(Object.assign(SoundInstance.prototype,{_initializeNodes:function _initializeNodes(){this.gain=this._manager.context.createGain(),this._inputNode=this.gain,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)},play:function play(){2!==this._state&&this.stop(),this.source||this._createSource();var offset=capTime(this._startOffset,this.duration);return offset=capTime(this._startTime+offset,this._sound.duration),this._startOffset=null,this._duration?this.source.start(0,offset,this._duration):this.source.start(0,offset),this._startedAt=this._manager.context.currentTime,this._currentTime=0,this._currentOffset=offset,this._state=0,this._playWhenLoaded=!1,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),!0},pause:function pause(){return this._playWhenLoaded=!1,!(0!==this._state||!this.source)&&(this._updateCurrentTime(),this._state=1,this._suspendEndEvent=!0,this.source.stop(0),this.source=null,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),!0)},resume:function resume(){if(1!==this._state)return!1;this.source||this._createSource();var offset=this.currentTime;return null!==this._startOffset&&(offset=capTime(this._startOffset,this.duration),offset=capTime(this._startTime+offset,this._sound.duration),this._startOffset=null),this._duration?this.source.start(0,offset,this._duration):this.source.start(0,offset),this._state=0,this._startedAt=this._manager.context.currentTime,this._currentOffset=offset,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._playWhenLoaded=!1,this._suspendInstanceEvents||this._onResume(),!0},stop:function stop(){return this._playWhenLoaded=!1,!(2===this._state||!this.source)&&(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._startOffset=null,this._suspendEndEvent=!0,0===this._state&&this.source.stop(0),this.source=null,this._state=2,this._suspendInstanceEvents||this._onStop(),!0)},setExternalNodes:function setExternalNodes(firstNode,lastNode){if(firstNode){lastNode||(lastNode=firstNode);var speakers=this._manager.context.destination;this._firstNode!==firstNode&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(speakers),this._firstNode=firstNode,this._connectorNode.connect(firstNode)),this._lastNode!==lastNode&&(this._lastNode&&this._lastNode.disconnect(speakers),this._lastNode=lastNode,this._lastNode.connect(speakers))}else console.error("The firstNode must be a valid Audio Node")},clearExternalNodes:function clearExternalNodes(){var speakers=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null),this._lastNode&&(this._lastNode.disconnect(speakers),this._lastNode=null),this._connectorNode.connect(speakers)},getExternalNodes:function getExternalNodes(){return[this._firstNode,this._lastNode]},_createSource:function _createSource(){if(!this._sound)return null;var context=this._manager.context;return this._sound.buffer&&(this.source=context.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),this.source.onended=this._endedHandler,this.source.loopStart=capTime(this._startTime,this.source.buffer.duration),this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,capTime(this._startTime+this._duration,this.source.buffer.duration)))),this.source},_updateCurrentTime:function _updateCurrentTime(){this._currentTime=capTime((this._manager.context.currentTime-this._startedAt)*this._pitch+this._currentOffset,this.duration)},_onManagerDestroy:function _onManagerDestroy(){this.source&&0===this._state&&(this.source.stop(0),this.source=null)}}),Object.defineProperty(SoundInstance.prototype,"volume",{get:function get(){return this._volume},set:function set(volume){volume=math.clamp(volume,0,1),this._volume=volume,this.gain&&(this.gain.gain.value=volume*this._manager.volume)}}),Object.defineProperty(SoundInstance.prototype,"pitch",{get:function get(){return this._pitch},set:function set(pitch){this._currentOffset=this.currentTime,this._startedAt=this._manager.context.currentTime,this._pitch=Math.max(Number(pitch)||0,.01),this.source&&(this.source.playbackRate.value=this._pitch)}}),Object.defineProperty(SoundInstance.prototype,"sound",{get:function get(){return this._sound},set:function set(value){this._sound=value,2!==this._state?this.stop():this._createSource()}}),Object.defineProperty(SoundInstance.prototype,"currentTime",{get:function get(){return null!==this._startOffset?this._startOffset:1===this._state?this._currentTime:2!==this._state&&this.source?(this._updateCurrentTime(),this._currentTime):0},set:function set(value){if(!(value<0))if(0===this._state){var suspend=this._suspendInstanceEvents;this._suspendInstanceEvents=!0,this.stop(),this._startOffset=value,this.play(),this._suspendInstanceEvents=suspend}else this._startOffset=value,this._currentTime=value}})):(Object.assign(SoundInstance.prototype,{play:function play(){return 2!==this._state&&this.stop(),!(!this.source&&!this._createSource())&&(this.volume=this._volume,this.pitch=this._pitch,this.loop=this._loop,this.source.play(),this._state=0,this._playWhenLoaded=!1,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),!0)},pause:function pause(){return!(!this.source||0!==this._state)&&(this._suspendEndEvent=!0,this.source.pause(),this._playWhenLoaded=!1,this._state=1,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),!0)},resume:function resume(){return!(!this.source||1!==this._state)&&(this._state=0,this._playWhenLoaded=!1,this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this._onResume()),!0)},stop:function stop(){return!(!this.source||2===this._state)&&(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._suspendEndEvent=!0,this.source.pause(),this._playWhenLoaded=!1,this._state=2,this._startOffset=null,this._suspendInstanceEvents||this._onStop(),!0)},setExternalNodes:function setExternalNodes(){},clearExternalNodes:function clearExternalNodes(){},getExternalNodes:function getExternalNodes(){return[null,null]},_onLoadedMetadata:function _onLoadedMetadata(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler),this._isReady=!0;var offset=capTime(this._startOffset,this.duration);offset=capTime(this._startTime+offset,this._sound.duration),this._startOffset=null,this.source.currentTime=offset},_createSource:function _createSource(){return this._sound&&this._sound.audio&&(this._isReady=!1,this.source=this._sound.audio.cloneNode(!0),this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler),this.source.addEventListener("timeupdate",this._timeUpdateHandler),this.source.onended=this._endedHandler),this.source},_onTimeUpdate:function _onTimeUpdate(){this._duration&&this.source.currentTime>capTime(this._startTime+this._duration,this.source.duration)&&(this.loop?this.source.currentTime=capTime(this._startTime,this.source.duration):(this.source.removeEventListener("timeupdate",this._timeUpdateHandler),this.source.pause(),this._onEnded()))},_onManagerDestroy:function _onManagerDestroy(){this.source&&this.source.pause()}}),Object.defineProperty(SoundInstance.prototype,"volume",{get:function get(){return this._volume},set:function set(volume){volume=math.clamp(volume,0,1),this._volume=volume,this.source&&(this.source.volume=volume*this._manager.volume)}}),Object.defineProperty(SoundInstance.prototype,"pitch",{get:function get(){return this._pitch},set:function set(pitch){this._pitch=Math.max(Number(pitch)||0,.01),this.source&&(this.source.playbackRate=this._pitch)}}),Object.defineProperty(SoundInstance.prototype,"sound",{get:function get(){return this._sound},set:function set(value){this.stop(),this._sound=value}}),Object.defineProperty(SoundInstance.prototype,"currentTime",{get:function get(){return null!==this._startOffset?this._startOffset:2!==this._state&&this.source?this.source.currentTime-this._startTime:0},set:function set(value){value<0||(this._startOffset=value,this.source&&this._isReady&&(this.source.currentTime=capTime(this._startTime+capTime(value,this.duration),this._sound.duration),this._startOffset=null))}}));var MAX_DISTANCE=1e4,SoundInstance3d=function(_SoundInstance){function SoundInstance3d(manager,sound,options){var _this;return _this=_SoundInstance.call(this,manager,sound,options)||this,options=options||{},_this._position=new Vec3,options.position&&(_this.position=options.position),_this._velocity=new Vec3,options.velocity&&(_this.velocity=options.velocity),_this.maxDistance=void 0!==options.maxDistance?Number(options.maxDistance):1e4,_this.refDistance=void 0!==options.refDistance?Number(options.refDistance):1,_this.rollOffFactor=void 0!==options.rollOffFactor?Number(options.rollOffFactor):1,_this.distanceModel=void 0!==options.distanceModel?options.distanceModel:"linear",_this}return _inheritsLoose(SoundInstance3d,_SoundInstance),SoundInstance3d}(SoundInstance);if(hasAudioContext())Object.assign(SoundInstance3d.prototype,{_initializeNodes:function _initializeNodes(){this.gain=this._manager.context.createGain(),this.panner=this._manager.context.createPanner(),this.panner.connect(this.gain),this._inputNode=this.panner,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)}}),Object.defineProperty(SoundInstance3d.prototype,"position",{get:function get(){return this._position},set:function set(position){this._position.copy(position),this.panner.setPosition(position.x,position.y,position.z)}}),Object.defineProperty(SoundInstance3d.prototype,"velocity",{get:function get(){return this._velocity},set:function set(velocity){this._velocity.copy(velocity),this.panner.setVelocity(velocity.x,velocity.y,velocity.z)}}),Object.defineProperty(SoundInstance3d.prototype,"maxDistance",{get:function get(){return this.panner.maxDistance},set:function set(value){this.panner.maxDistance=value}}),Object.defineProperty(SoundInstance3d.prototype,"refDistance",{get:function get(){return this.panner.refDistance},set:function set(value){this.panner.refDistance=value}}),Object.defineProperty(SoundInstance3d.prototype,"rollOffFactor",{get:function get(){return this.panner.rolloffFactor},set:function set(value){this.panner.rolloffFactor=value}}),Object.defineProperty(SoundInstance3d.prototype,"distanceModel",{get:function get(){return this.panner.distanceModel},set:function set(value){this.panner.distanceModel=value}});else{var offset=new Vec3,fallOff=function fallOff(posOne,posTwo,refDistance,maxDistance,rollOffFactor,distanceModel){var distance=(offset=offset.sub2(posOne,posTwo)).length();if(distance<refDistance)return 1;if(distance>maxDistance)return 0;var result=0;return"linear"===distanceModel?result=1-rollOffFactor*(distance-refDistance)/(maxDistance-refDistance):"inverse"===distanceModel?result=refDistance/(refDistance+rollOffFactor*(distance-refDistance)):"exponential"===distanceModel&&(result=Math.pow(distance/refDistance,-rollOffFactor)),math.clamp(result,0,1)};Object.defineProperty(SoundInstance3d.prototype,"position",{get:function get(){return this._position},set:function set(position){if(this._position.copy(position),this.source){var listener,lpos=this._manager.listener.getPosition(),factor=fallOff(lpos,this._position,this.refDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),v=this.volume;this.source.volume=v*factor*this._manager.volume}}}),Object.defineProperty(SoundInstance3d.prototype,"velocity",{get:function get(){return this._velocity},set:function set(velocity){this._velocity.copy(velocity)}}),Object.defineProperty(SoundInstance3d.prototype,"maxDistance",{get:function get(){return this._maxDistance},set:function set(value){this._maxDistance=value}}),Object.defineProperty(SoundInstance3d.prototype,"refDistance",{get:function get(){return this._refDistance},set:function set(value){this._refDistance=value}}),Object.defineProperty(SoundInstance3d.prototype,"rollOffFactor",{get:function get(){return this._rollOffFactor},set:function set(value){this._rollOffFactor=value}}),Object.defineProperty(SoundInstance3d.prototype,"distanceModel",{get:function get(){return this._distanceModel},set:function set(value){this._distanceModel=value}})}var instanceOptions={volume:0,pitch:0,loop:!1,startTime:0,duration:0,position:new Vec3,maxDistance:0,refDistance:0,rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null},SoundSlot=function(_EventHandler){function SoundSlot(component,name,options){var _this;return(_this=_EventHandler.call(this)||this)._component=component,_this._assets=component.system.app.assets,_this._manager=component.system.manager,_this.name=name||"Untitled",options=options||{},_this._volume=void 0!==options.volume?math.clamp(Number(options.volume)||0,0,1):1,_this._pitch=void 0!==options.pitch?Math.max(.01,Number(options.pitch)||0):1,_this._loop=!(void 0===options.loop||!options.loop),_this._duration=options.duration>0?options.duration:null,_this._startTime=Math.max(0,Number(options.startTime)||0),_this._overlap=!!options.overlap,_this._autoPlay=!!options.autoPlay,_this._firstNode=null,_this._lastNode=null,_this._asset=options.asset,_this._asset instanceof Asset&&(_this._asset=_this._asset.id),_this._onInstancePlayHandler=_this._onInstancePlay.bind(_assertThisInitialized(_this)),_this._onInstancePauseHandler=_this._onInstancePause.bind(_assertThisInitialized(_this)),_this._onInstanceResumeHandler=_this._onInstanceResume.bind(_assertThisInitialized(_this)),_this._onInstanceStopHandler=_this._onInstanceStop.bind(_assertThisInitialized(_this)),_this._onInstanceEndHandler=_this._onInstanceEnd.bind(_assertThisInitialized(_this)),_this.instances=[],_this}_inheritsLoose(SoundSlot,_EventHandler);var _proto=SoundSlot.prototype;return _proto.play=function play(){if(this.overlap||this.stop(),this.isLoaded||this._hasAsset()){var instance=this._createInstance();if(this.instances.push(instance),this.isLoaded)instance.play();else{var onLoad=function onLoad(sound){var playWhenLoaded=instance._playWhenLoaded;instance.sound=sound,playWhenLoaded&&instance.play()};this.off("load",onLoad),this.once("load",onLoad),this.load()}return instance}},_proto.pause=function pause(){for(var paused=!1,instances=this.instances,i=0,len=instances.length;i<len;i++)instances[i].pause()&&(paused=!0);return paused},_proto.resume=function resume(){for(var resumed=!1,instances=this.instances,i=0,len=instances.length;i<len;i++)instances[i].resume()&&(resumed=!0);return resumed},_proto.stop=function stop(){for(var stopped=!1,instances=this.instances,i=instances.length;i--;)instances[i].stop(),stopped=!0;return instances.length=0,stopped},_proto.load=function load(){if(this._hasAsset()){var asset=this._assets.get(this._asset);if(!asset)return this._assets.off("add:"+this._asset,this._onAssetAdd,this),void this._assets.once("add:"+this._asset,this._onAssetAdd,this);if(asset.off("remove",this._onAssetRemoved,this),asset.on("remove",this._onAssetRemoved,this),!asset.resource)return asset.off("load",this._onAssetLoad,this),asset.once("load",this._onAssetLoad,this),void this._assets.load(asset);this.fire("load",asset.resource)}},_proto.setExternalNodes=function setExternalNodes(firstNode,lastNode){if(firstNode){if(lastNode||(lastNode=firstNode),this._firstNode=firstNode,this._lastNode=lastNode,!this._overlap)for(var instances=this.instances,i=0,len=instances.length;i<len;i++)instances[i].setExternalNodes(firstNode,lastNode)}else console.error("The firstNode must have a valid AudioNode")},_proto.clearExternalNodes=function clearExternalNodes(){if(this._firstNode=null,this._lastNode=null,!this._overlap)for(var instances=this.instances,i=0,len=instances.length;i<len;i++)instances[i].clearExternalNodes()},_proto.getExternalNodes=function getExternalNodes(){return[this._firstNode,this._lastNode]},_proto._hasAsset=function _hasAsset(){return null!=this._asset},_proto._createInstance=function _createInstance(){var instance=null,component=this._component,sound=null;if(this._hasAsset()){var asset=this._assets.get(this._asset);asset&&(sound=asset.resource)}var data=instanceOptions;return data.volume=this._volume*component.volume,data.pitch=this._pitch*component.pitch,data.loop=this._loop,data.startTime=this._startTime,data.duration=this._duration,data.onPlay=this._onInstancePlayHandler,data.onPause=this._onInstancePauseHandler,data.onResume=this._onInstanceResumeHandler,data.onStop=this._onInstanceStopHandler,data.onEnd=this._onInstanceEndHandler,component.positional?(data.position.copy(component.entity.getPosition()),data.maxDistance=component.maxDistance,data.refDistance=component.refDistance,data.rollOffFactor=component.rollOffFactor,data.distanceModel=component.distanceModel,instance=new SoundInstance3d(this._manager,sound,data)):instance=new SoundInstance(this._manager,sound,data),this._firstNode&&instance.setExternalNodes(this._firstNode,this._lastNode),instance},_proto._onInstancePlay=function _onInstancePlay(instance){this.fire("play",instance),this._component.fire("play",this,instance)},_proto._onInstancePause=function _onInstancePause(instance){this.fire("pause",instance),this._component.fire("pause",this,instance)},_proto._onInstanceResume=function _onInstanceResume(instance){this.fire("resume",instance),this._component.fire("resume",this,instance)},_proto._onInstanceStop=function _onInstanceStop(instance){var idx=this.instances.indexOf(instance);-1!==idx&&this.instances.splice(idx,1),this.fire("stop",instance),this._component.fire("stop",this,instance)},_proto._onInstanceEnd=function _onInstanceEnd(instance){var idx=this.instances.indexOf(instance);-1!==idx&&this.instances.splice(idx,1),this.fire("end",instance),this._component.fire("end",this,instance)},_proto._onAssetAdd=function _onAssetAdd(asset){this.load()},_proto._onAssetLoad=function _onAssetLoad(asset){this.load()},_proto._onAssetRemoved=function _onAssetRemoved(asset){asset.off("remove",this._onAssetRemoved,this),this._assets.off("add:"+asset.id,this._onAssetAdd,this),this.stop()},_proto.updatePosition=function updatePosition(position){for(var instances=this.instances,i=0,len=instances.length;i<len;i++)instances[i].position=position},_createClass(SoundSlot,[{key:"volume",get:function get(){return this._volume},set:function set(value){if(this._volume=math.clamp(Number(value)||0,0,1),!this._overlap)for(var instances=this.instances,i=0,len=instances.length;i<len;i++)instances[i].volume=this._volume*this._component.volume}},{key:"pitch",get:function get(){return this._pitch},set:function set(value){if(this._pitch=Math.max(Number(value)||0,.01),!this._overlap)for(var instances=this.instances,i=0,len=instances.length;i<len;i++)instances[i].pitch=this.pitch*this._component.pitch}},{key:"loop",get:function get(){return this._loop},set:function set(value){this._loop=!!value;for(var instances=this.instances,i=0,len=instances.length;i<len;i++)instances[i].loop=this._loop}},{key:"autoPlay",get:function get(){return this._autoPlay},set:function set(value){this._autoPlay=!!value}},{key:"overlap",get:function get(){return this._overlap},set:function set(value){this._overlap=!!value}},{key:"startTime",get:function get(){return this._startTime},set:function set(value){if(this._startTime=Math.max(0,Number(value)||0),!this._overlap)for(var instances=this.instances,i=0,len=instances.length;i<len;i++)instances[i].startTime=this._startTime}},{key:"duration",get:function get(){var assetDuration=0;if(this._hasAsset()){var asset=this._assets.get(this._asset);assetDuration=asset.resource?asset.resource.duration:0}return null!=this._duration?this._duration%(assetDuration||1):assetDuration},set:function set(value){if(this._duration=Math.max(0,Number(value)||0)||null,!this._overlap)for(var instances=this.instances,i=0,len=instances.length;i<len;i++)instances[i].duration=this._duration}},{key:"asset",get:function get(){return this._asset},set:function set(value){var old=this._asset;if(old){this._assets.off("add:"+old,this._onAssetAdd,this);var oldAsset=this._assets.get(old);oldAsset&&oldAsset.off("remove",this._onAssetRemoved,this)}this._asset=value,this._asset instanceof Asset&&(this._asset=this._asset.id),this._hasAsset()&&this._component.enabled&&this._component.entity.enabled&&this.load()}},{key:"isLoaded",get:function get(){if(this._hasAsset()){var asset=this._assets.get(this._asset);if(asset)return!!asset.resource}return!1}},{key:"isPlaying",get:function get(){for(var instances=this.instances,i=0,len=instances.length;i<len;i++)if(instances[i].isPlaying)return!0;return!1}},{key:"isPaused",get:function get(){var instances=this.instances,len=instances.length;if(0===len)return!1;for(var i=0;i<len;i++)if(!instances[i].isPaused)return!1;return!0}},{key:"isStopped",get:function get(){for(var instances=this.instances,i=0,len=instances.length;i<len;i++)if(!instances[i].isStopped)return!1;return!0}}]),SoundSlot}(EventHandler),SoundComponent=function(_Component){function SoundComponent(system,entity){var _this;return(_this=_Component.call(this,system,entity)||this)._volume=1,_this._pitch=1,_this._positional=!0,_this._refDistance=1,_this._maxDistance=1e4,_this._rollOffFactor=1,_this._distanceModel="linear",_this._slots={},_this._playingBeforeDisable={},_this}_inheritsLoose(SoundComponent,_Component);var _proto=SoundComponent.prototype;return _proto.onEnable=function onEnable(){if(!this.system._inTools){var slots=this._slots,playingBeforeDisable=this._playingBeforeDisable;for(var key in slots){var slot=slots[key];slot.autoPlay&&slot.isStopped?slot.play():playingBeforeDisable[key]?slot.resume():slot.isLoaded||slot.load()}}},_proto.onDisable=function onDisable(){var slots=this._slots,playingBeforeDisable={};for(var key in slots)slots[key].overlap||slots[key].isPlaying&&(slots[key].pause(),playingBeforeDisable[key]=!0);this._playingBeforeDisable=playingBeforeDisable},_proto.onRemove=function onRemove(){this.off()},_proto.addSlot=function addSlot(name,options){var slots=this._slots;if(slots[name])return null;var slot=new SoundSlot(this,name,options);return slots[name]=slot,slot.autoPlay&&this.enabled&&this.entity.enabled&&slot.play(),slot},_proto.removeSlot=function removeSlot(name){var slots=this._slots;slots[name]&&(slots[name].stop(),delete slots[name])},_proto.slot=function slot(name){return this._slots[name]},_proto.play=function play(name){if(!this.enabled||!this.entity.enabled)return null;var slot=this._slots[name];return slot?slot.play():null},_proto.pause=function pause(name){var slot,slots=this._slots;if(name){if(!(slot=slots[name]))return;slot.pause()}else for(var key in slots)slots[key].pause()},_proto.resume=function resume(name){var slots=this._slots;if(name){var slot=slots[name];if(!slot)return;slot.isPaused&&slot.resume()}else for(var key in slots)slots[key].resume()},_proto.stop=function stop(name){var slots=this._slots;if(name){var slot=slots[name];if(!slot)return;slot.stop()}else for(var key in slots)slots[key].stop()},_createClass(SoundComponent,[{key:"positional",get:function get(){return this._positional},set:function set(newValue){this._positional=newValue;var slots=this._slots;for(var key in slots){var slot=slots[key];if(!slot.overlap)for(var instances=slot.instances,oldLength,i=instances.length-1;i>=0;i--){var isPlaying=instances[i].isPlaying||instances[i].isSuspended,currentTime=instances[i].currentTime;isPlaying&&instances[i].stop();var instance=slot._createInstance();isPlaying&&(instance.play(),instance.currentTime=currentTime),instances.push(instance)}}}},{key:"slots",get:function get(){return this._slots},set:function set(newValue){var key,oldValue=this._slots;if(oldValue)for(key in oldValue)oldValue[key].stop();var slots={};for(key in newValue)newValue[key]instanceof SoundSlot?slots[newValue[key].name]=newValue[key]:newValue[key].name&&(slots[newValue[key].name]=new SoundSlot(this,newValue[key].name,newValue[key]));this._slots=slots,this.enabled&&this.entity.enabled&&this.onEnable()}}]),SoundComponent}(Component);function defineSoundPropertyBasic(publicName,privateName){Object.defineProperty(SoundComponent.prototype,publicName,{get:function get(){return this[privateName]},set:function set(newValue){this[privateName]=newValue;var slots=this._slots;for(var key in slots){var slot=slots[key];if(!slot.overlap)for(var instances=slot.instances,i=0,len=instances.length;i<len;i++)instances[i][publicName]=newValue}}})}function defineSoundPropertyFactor(publicName,privateName){Object.defineProperty(SoundComponent.prototype,publicName,{get:function get(){return this[privateName]},set:function set(newValue){this[privateName]=newValue;var slots=this._slots;for(var key in slots){var slot=slots[key];if(!slot.overlap)for(var instances=slot.instances,i=0,len=instances.length;i<len;i++)instances[i][publicName]=slot[publicName]*newValue}}})}defineSoundPropertyFactor("pitch","_pitch"),defineSoundPropertyFactor("volume","_volume"),defineSoundPropertyBasic("refDistance","_refDistance"),defineSoundPropertyBasic("maxDistance","_maxDistance"),defineSoundPropertyBasic("rollOffFactor","_rollOffFactor"),defineSoundPropertyBasic("distanceModel","_distanceModel");var SoundComponentData=function SoundComponentData(){this.enabled=!0},_schema$2=["enabled"],SoundComponentSystem=function(_ComponentSystem){function SoundComponentSystem(app,manager){var _this;return(_this=_ComponentSystem.call(this,app)||this).id="sound",_this.ComponentType=SoundComponent,_this.DataType=SoundComponentData,_this.schema=_schema$2,_this.manager=manager,ComponentSystem.bind("update",_this.onUpdate,_assertThisInitialized(_this)),_this.on("beforeremove",_this.onBeforeRemove,_assertThisInitialized(_this)),_this}_inheritsLoose(SoundComponentSystem,_ComponentSystem);var _proto=SoundComponentSystem.prototype;return _proto.initializeComponentData=function initializeComponentData(component,data,properties){properties=["volume","pitch","positional","refDistance","maxDistance","rollOffFactor","distanceModel","slots"];for(var i=0;i<properties.length;i++)data.hasOwnProperty(properties[i])&&(component[properties[i]]=data[properties[i]]);_ComponentSystem.prototype.initializeComponentData.call(this,component,data,["enabled"])},_proto.cloneComponent=function cloneComponent(entity,clone){var srcComponent=entity.sound,srcSlots=srcComponent.slots,slots={};for(var key in srcSlots){var srcSlot=srcSlots[key];slots[key]={name:srcSlot.name,volume:srcSlot.volume,pitch:srcSlot.pitch,loop:srcSlot.loop,duration:srcSlot.duration,startTime:srcSlot.startTime,overlap:srcSlot.overlap,autoPlay:srcSlot.autoPlay,asset:srcSlot.asset}}var cloneData={distanceModel:srcComponent.distanceModel,enabled:srcComponent.enabled,maxDistance:srcComponent.maxDistance,pitch:srcComponent.pitch,positional:srcComponent.positional,refDistance:srcComponent.refDistance,rollOffFactor:srcComponent.rollOffFactor,slots:slots,volume:srcComponent.volume};return this.addComponent(clone,cloneData)},_proto.onUpdate=function onUpdate(dt){var store=this.store;for(var id in store)if(store.hasOwnProperty(id)){var item,entity=store[id].entity;if(entity.enabled){var component=entity.sound;if(component.enabled&&component.positional){var position=entity.getPosition(),slots=component.slots;for(var key in slots)slots[key].updatePosition(position)}}}},_proto.onBeforeRemove=function onBeforeRemove(entity,component){var slots=component.slots;for(var key in slots)slots[key].overlap||slots[key].stop();component.onRemove()},_createClass(SoundComponentSystem,[{key:"volume",get:function get(){return this.manager.volume},set:function set(volume){this.manager.volume=volume}},{key:"context",get:function get(){return hasAudioContext()?this.manager.context:null}}]),SoundComponentSystem}(ComponentSystem);Component._buildAccessors(SoundComponent.prototype,_schema$2);var SPRITETYPE_SIMPLE="simple",SPRITETYPE_ANIMATED="animated",SpriteAnimationClip=function(_EventHandler){function SpriteAnimationClip(component,data){var _this;return(_this=_EventHandler.call(this)||this)._component=component,_this._frame=0,_this._sprite=null,_this._spriteAsset=null,_this.spriteAsset=data.spriteAsset,_this.name=data.name,_this.fps=data.fps||0,_this.loop=data.loop||!1,_this._playing=!1,_this._paused=!1,_this._time=0,_this}_inheritsLoose(SpriteAnimationClip,_EventHandler);var _proto=SpriteAnimationClip.prototype;return _proto._onSpriteAssetAdded=function _onSpriteAssetAdded(asset){this._component.system.app.assets.off("add:"+asset.id,this._onSpriteAssetAdded,this),this._spriteAsset===asset.id&&this._bindSpriteAsset(asset)},_proto._bindSpriteAsset=function _bindSpriteAsset(asset){asset.on("load",this._onSpriteAssetLoad,this),asset.on("remove",this._onSpriteAssetRemove,this),asset.resource?this._onSpriteAssetLoad(asset):this._component.system.app.assets.load(asset)},_proto._unbindSpriteAsset=function _unbindSpriteAsset(asset){asset.off("load",this._onSpriteAssetLoad,this),asset.off("remove",this._onSpriteAssetRemove,this),asset.resource&&asset.resource.atlas&&this._component.system.app.assets.off("load:"+asset.data.textureAtlasAsset,this._onTextureAtlasLoad,this)},_proto._onSpriteAssetLoad=function _onSpriteAssetLoad(asset){if(asset.resource)if(asset.resource.atlas)this.sprite=asset.resource;else{var atlasAssetId=asset.data.textureAtlasAsset,assets=this._component.system.app.assets;assets.off("load:"+atlasAssetId,this._onTextureAtlasLoad,this),assets.once("load:"+atlasAssetId,this._onTextureAtlasLoad,this)}else this.sprite=null},_proto._onTextureAtlasLoad=function _onTextureAtlasLoad(atlasAsset){var spriteAsset=this._spriteAsset;spriteAsset instanceof Asset?this._onSpriteAssetLoad(spriteAsset):this._onSpriteAssetLoad(this._component.system.app.assets.get(spriteAsset))},_proto._onSpriteAssetRemove=function _onSpriteAssetRemove(asset){this.sprite=null},_proto._onSpriteMeshesChange=function _onSpriteMeshesChange(){this._component.currentClip===this&&this._component._showFrame(this.frame)},_proto._onSpritePpuChanged=function _onSpritePpuChanged(){this._component.currentClip===this&&0!==this.sprite.renderMode&&this._component._showFrame(this.frame)},_proto._update=function _update(dt){if(0!==this.fps&&this._playing&&!this._paused&&this._sprite){var dir=this.fps<0?-1:1,time=this._time+dt*this._component.speed*dir,duration=this.duration,end=time>duration||time<0;this._setTime(time);var frame=this.frame;(frame=this._sprite?Math.floor(this._sprite.frameKeys.length*this._time/duration):0)!==this._frame&&this._setFrame(frame),end&&(this.loop?(this.fire("loop"),this._component.fire("loop",this)):(this._playing=!1,this._paused=!1,this.fire("end"),this._component.fire("end",this)))}},_proto._setTime=function _setTime(value){this._time=value;var duration=this.duration;this._time<0?this.loop?this._time=this._time%duration+duration:this._time=0:this._time>duration&&(this.loop?this._time%=duration:this._time=duration)},_proto._setFrame=function _setFrame(value){this._sprite?this._frame=math.clamp(value,0,this._sprite.frameKeys.length-1):this._frame=value,this._component.currentClip===this&&this._component._showFrame(this._frame)},_proto._destroy=function _destroy(){this._sprite&&(this.sprite=null),this._spriteAsset&&(this.spriteAsset=null)},_proto.play=function play(){this._playing||(this._playing=!0,this._paused=!1,this.frame=0,this.fire("play"),this._component.fire("play",this))},_proto.pause=function pause(){this._playing&&!this._paused&&(this._paused=!0,this.fire("pause"),this._component.fire("pause",this))},_proto.resume=function resume(){this._paused&&(this._paused=!1,this.fire("resume"),this._component.fire("resume",this))},_proto.stop=function stop(){this._playing&&(this._playing=!1,this._paused=!1,this._time=0,this.frame=0,this.fire("stop"),this._component.fire("stop",this))},_createClass(SpriteAnimationClip,[{key:"spriteAsset",get:function get(){return this._spriteAsset},set:function set(value){var assets=this._component.system.app.assets,id=value;if(value instanceof Asset&&(id=value.id),this._spriteAsset!==id){if(this._spriteAsset){var prev=assets.get(this._spriteAsset);prev&&this._unbindSpriteAsset(prev)}if(this._spriteAsset=id,this._spriteAsset){var asset=assets.get(this._spriteAsset);asset?this._bindSpriteAsset(asset):(this.sprite=null,assets.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this))}else this.sprite=null}}},{key:"sprite",get:function get(){return this._sprite},set:function set(value){var mi;(this._sprite&&(this._sprite.off("set:meshes",this._onSpriteMeshesChange,this),this._sprite.off("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.off("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.off("set:texture",this._onSpriteMeshesChange,this)),this._sprite=value,this._sprite&&(this._sprite.on("set:meshes",this._onSpriteMeshesChange,this),this._sprite.on("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.on("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.on("set:texture",this._onSpriteMeshesChange,this)),this._component.currentClip===this)&&(value&&value.atlas?(value.atlas.texture&&((mi=this._component._meshInstance)&&(mi.setParameter("texture_emissiveMap",value.atlas.texture),mi.setParameter("texture_opacityMap",value.atlas.texture)),this._component.enabled&&this._component.entity.enabled&&this._component._showModel()),this.time&&this.fps?this.time=this.time:this.frame=this.frame):((mi=this._component._meshInstance)&&(mi.deleteParameter("texture_emissiveMap"),mi.deleteParameter("texture_opacityMap")),this._component._hideModel()))}},{key:"frame",get:function get(){return this._frame},set:function set(value){this._setFrame(value);var fps=this.fps||Number.MIN_VALUE;this._setTime(this._frame/fps)}},{key:"isPlaying",get:function get(){return this._playing}},{key:"isPaused",get:function get(){return this._paused}},{key:"duration",get:function get(){if(this._sprite){var fps=this.fps||Number.MIN_VALUE;return this._sprite.frameKeys.length/Math.abs(fps)}return 0}},{key:"time",get:function get(){return this._time},set:function set(value){this._setTime(value),this._sprite?this.frame=Math.min(this._sprite.frameKeys.length-1,Math.floor(this._time*Math.abs(this.fps))):this.frame=0}}]),SpriteAnimationClip}(EventHandler),PARAM_EMISSIVE_MAP="texture_emissiveMap",PARAM_OPACITY_MAP="texture_opacityMap",PARAM_EMISSIVE="material_emissive",PARAM_OPACITY="material_opacity",PARAM_INNER_OFFSET="innerOffset",PARAM_OUTER_SCALE="outerScale",PARAM_ATLAS_RECT="atlasRect",SpriteComponent=function(_Component){function SpriteComponent(system,entity){var _this;return(_this=_Component.call(this,system,entity)||this)._type="simple",_this._material=system.defaultMaterial,_this._color=new Color(1,1,1,1),_this._colorUniform=new Float32Array(3),_this._speed=1,_this._flipX=!1,_this._flipY=!1,_this._width=1,_this._height=1,_this._drawOrder=0,_this._layers=[0],_this._outerScale=new Vec2(1,1),_this._outerScaleUniform=new Float32Array(2),_this._innerOffset=new Vec4,_this._innerOffsetUniform=new Float32Array(4),_this._atlasRect=new Vec4,_this._atlasRectUniform=new Float32Array(4),_this._batchGroupId=-1,_this._batchGroup=null,_this._node=new GraphNode,_this._model=new Model,_this._model.graph=_this._node,_this._meshInstance=null,entity.addChild(_this._model.graph),_this._model._entity=entity,_this._updateAabbFunc=_this._updateAabb.bind(_assertThisInitialized(_this)),_this._addedModel=!1,_this._autoPlayClip=null,_this._clips={},_this._defaultClip=new SpriteAnimationClip(_assertThisInitialized(_this),{name:_this.entity.name,fps:0,loop:!1,spriteAsset:null}),_this._currentClip=_this._defaultClip,_this}_inheritsLoose(SpriteComponent,_Component);var _proto=SpriteComponent.prototype;return _proto.onEnable=function onEnable(){var app=this.system.app,scene=app.scene;scene.on("set:layers",this._onLayersChanged,this),scene.layers&&(scene.layers.on("add",this._onLayerAdded,this),scene.layers.on("remove",this._onLayerRemoved,this)),this._showModel(),this._autoPlayClip&&this._tryAutoPlay(),this._batchGroupId>=0&&app.batcher.insert(BatchGroup.SPRITE,this._batchGroupId,this.entity)},_proto.onDisable=function onDisable(){var app=this.system.app,scene=app.scene;scene.off("set:layers",this._onLayersChanged,this),scene.layers&&(scene.layers.off("add",this._onLayerAdded,this),scene.layers.off("remove",this._onLayerRemoved,this)),this.stop(),this._hideModel(),this._batchGroupId>=0&&app.batcher.remove(BatchGroup.SPRITE,this._batchGroupId,this.entity)},_proto.onDestroy=function onDestroy(){for(var key in this._currentClip=null,this._defaultClip&&(this._defaultClip._destroy(),this._defaultClip=null),this._clips)this._clips[key]._destroy();this._clips=null,this._hideModel(),this._model=null,this._node&&(this._node.parent&&this._node.parent.removeChild(this._node),this._node=null),this._meshInstance&&(this._meshInstance.material=null,this._meshInstance.mesh=null,this._meshInstance=null)},_proto._showModel=function _showModel(){if(!this._addedModel&&this._meshInstance){var i,len,meshInstances=[this._meshInstance];for(i=0,len=this._layers.length;i<len;i++){var layer=this.system.app.scene.layers.getLayerById(this._layers[i]);layer&&layer.addMeshInstances(meshInstances)}this._addedModel=!0}},_proto._hideModel=function _hideModel(){if(this._addedModel&&this._meshInstance){var i,len,meshInstances=[this._meshInstance];for(i=0,len=this._layers.length;i<len;i++){var layer=this.system.app.scene.layers.getLayerById(this._layers[i]);layer&&layer.removeMeshInstances(meshInstances)}this._addedModel=!1}},_proto._showFrame=function _showFrame(frame){if(this.sprite){var mesh=this.sprite.meshes[frame];if(mesh){var material;if(material=1===this.sprite.renderMode?this.system.default9SlicedMaterialSlicedMode:2===this.sprite.renderMode?this.system.default9SlicedMaterialTiledMode:this.system.defaultMaterial,this._meshInstance||(this._meshInstance=new MeshInstance(mesh,this._material,this._node),this._meshInstance.castShadow=!1,this._meshInstance.receiveShadow=!1,this._meshInstance.drawOrder=this._drawOrder,this._model.meshInstances.push(this._meshInstance),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter(PARAM_EMISSIVE,this._colorUniform),this._meshInstance.setParameter(PARAM_OPACITY,this._color.a),this.enabled&&this.entity.enabled&&this._showModel()),this._meshInstance.material!==material&&(this._meshInstance.material=material),this._meshInstance.mesh!==mesh&&(this._meshInstance.mesh=mesh,this._meshInstance.visible=!0,this._meshInstance._aabbVer=-1),this.sprite.atlas&&this.sprite.atlas.texture?(this._meshInstance.setParameter(PARAM_EMISSIVE_MAP,this.sprite.atlas.texture),this._meshInstance.setParameter(PARAM_OPACITY_MAP,this.sprite.atlas.texture)):(this._meshInstance.deleteParameter(PARAM_EMISSIVE_MAP),this._meshInstance.deleteParameter(PARAM_OPACITY_MAP)),!this.sprite.atlas||1!==this.sprite.renderMode&&2!==this.sprite.renderMode)this._meshInstance._updateAabbFunc=null;else{this._meshInstance._updateAabbFunc=this._updateAabbFunc;var frameData=this.sprite.atlas.frames[this.sprite.frameKeys[frame]];if(frameData){var borderWidthScale=2/frameData.rect.z,borderHeightScale=2/frameData.rect.w;this._innerOffset.set(frameData.border.x*borderWidthScale,frameData.border.y*borderHeightScale,frameData.border.z*borderWidthScale,frameData.border.w*borderHeightScale);var tex=this.sprite.atlas.texture;this._atlasRect.set(frameData.rect.x/tex.width,frameData.rect.y/tex.height,frameData.rect.z/tex.width,frameData.rect.w/tex.height)}else this._innerOffset.set(0,0,0,0);this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._meshInstance.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._meshInstance.setParameter("atlasRect",this._atlasRectUniform)}this._updateTransform()}else this._meshInstance&&(this._meshInstance.mesh=null,this._meshInstance.visible=!1)}},_proto._updateTransform=function _updateTransform(){var scaleX=this.flipX?-1:1,scaleY=this.flipY?-1:1,posX=0,posY=0;if(this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)){var w=1,h=1;if(this.sprite.atlas){var frameData=this.sprite.atlas.frames[this.sprite.frameKeys[this.frame]];frameData&&(w=frameData.rect.z,h=frameData.rect.w,posX=(.5-frameData.pivot.x)*this._width,posY=(.5-frameData.pivot.y)*this._height)}var scaleMulX=w/this.sprite.pixelsPerUnit,scaleMulY=h/this.sprite.pixelsPerUnit;this._outerScale.set(Math.max(this._width,this._innerOffset.x*scaleMulX),Math.max(this._height,this._innerOffset.y*scaleMulY)),scaleX*=scaleMulX,scaleY*=scaleMulY,this._outerScale.x/=scaleMulX,this._outerScale.y/=scaleMulY,scaleX*=math.clamp(this._width/(this._innerOffset.x*scaleMulX),1e-4,1),scaleY*=math.clamp(this._height/(this._innerOffset.y*scaleMulY),1e-4,1),this._meshInstance&&(this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._meshInstance.setParameter("outerScale",this._outerScaleUniform))}this._node.setLocalScale(scaleX,scaleY,1),this._node.setLocalPosition(posX,posY,0)},_proto._updateAabb=function _updateAabb(aabb){return aabb.center.set(0,0,0),aabb.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),aabb.setFromTransformedAabb(aabb,this._node.getWorldTransform()),aabb},_proto._tryAutoPlay=function _tryAutoPlay(){if(this._autoPlayClip&&"animated"===this.type){var clip=this._clips[this._autoPlayClip];!clip||clip.isPlaying||this._currentClip&&this._currentClip.isPlaying||this.enabled&&this.entity.enabled&&this.play(clip.name)}},_proto._onLayersChanged=function _onLayersChanged(oldComp,newComp){oldComp.off("add",this.onLayerAdded,this),oldComp.off("remove",this.onLayerRemoved,this),newComp.on("add",this.onLayerAdded,this),newComp.on("remove",this.onLayerRemoved,this),this.enabled&&this.entity.enabled&&this._showModel()},_proto._onLayerAdded=function _onLayerAdded(layer){var index;this.layers.indexOf(layer.id)<0||this._addedModel&&this.enabled&&this.entity.enabled&&this._meshInstance&&layer.addMeshInstances([this._meshInstance])},_proto._onLayerRemoved=function _onLayerRemoved(layer){var index;this._meshInstance&&(this.layers.indexOf(layer.id)<0||layer.removeMeshInstances([this._meshInstance]))},_proto.removeModelFromLayers=function removeModelFromLayers(){for(var layer,i=0;i<this.layers.length;i++)(layer=this.system.app.scene.layers.getLayerById(this.layers[i]))&&layer.removeMeshInstances([this._meshInstance])},_proto.addClip=function addClip(data){var clip=new SpriteAnimationClip(this,{name:data.name,fps:data.fps,loop:data.loop,spriteAsset:data.spriteAsset});return this._clips[data.name]=clip,clip.name&&clip.name===this._autoPlayClip&&this._tryAutoPlay(),clip},_proto.removeClip=function removeClip(name){delete this._clips[name]},_proto.clip=function clip(name){return this._clips[name]},_proto.play=function play(name){var clip=this._clips[name],current=this._currentClip;return current&&current!==clip&&(current._playing=!1),this._currentClip=clip,this._currentClip&&(this._currentClip=clip,this._currentClip.play()),clip},_proto.pause=function pause(){this._currentClip!==this._defaultClip&&this._currentClip.isPlaying&&this._currentClip.pause()},_proto.resume=function resume(){this._currentClip!==this._defaultClip&&this._currentClip.isPaused&&this._currentClip.resume()},_proto.stop=function stop(){this._currentClip!==this._defaultClip&&this._currentClip.stop()},_createClass(SpriteComponent,[{key:"type",get:function get(){return this._type},set:function set(value){this._type!==value&&(this._type=value,"simple"===this._type?(this.stop(),this._currentClip=this._defaultClip,this.enabled&&this.entity.enabled&&(this._currentClip.frame=this.frame,this._currentClip.sprite?this._showModel():this._hideModel())):"animated"===this._type&&(this.stop(),this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.isPlaying&&this.enabled&&this.entity.enabled?this._showModel():this._hideModel()))}},{key:"frame",get:function get(){return this._currentClip.frame},set:function set(value){this._currentClip.frame=value}},{key:"spriteAsset",get:function get(){return this._defaultClip._spriteAsset},set:function set(value){this._defaultClip.spriteAsset=value}},{key:"sprite",get:function get(){return this._currentClip.sprite},set:function set(value){this._currentClip.sprite=value}},{key:"material",get:function get(){return this._material},set:function set(value){this._material=value,this._meshInstance&&(this._meshInstance.material=value)}},{key:"color",get:function get(){return this._color},set:function set(value){this._color.r=value.r,this._color.g=value.g,this._color.b=value.b,this._meshInstance&&(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter(PARAM_EMISSIVE,this._colorUniform))}},{key:"opacity",get:function get(){return this._color.a},set:function set(value){this._color.a=value,this._meshInstance&&this._meshInstance.setParameter(PARAM_OPACITY,value)}},{key:"clips",get:function get(){return this._clips},set:function set(value){var name,key;if(value){for(name in this._clips){var found=!1;for(key in value)if(value[key].name===name){found=!0,this._clips[name].fps=value[key].fps,this._clips[name].loop=value[key].loop,value[key].hasOwnProperty("sprite")?this._clips[name].sprite=value[key].sprite:value[key].hasOwnProperty("spriteAsset")&&(this._clips[name].spriteAsset=value[key].spriteAsset);break}found||this.removeClip(name)}for(key in value)this._clips[value[key].name]||this.addClip(value[key]);this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.sprite||this._hideModel()}else for(name in this._clips)this.removeClip(name)}},{key:"currentClip",get:function get(){return this._currentClip}},{key:"speed",get:function get(){return this._speed},set:function set(value){this._speed=value}},{key:"flipX",get:function get(){return this._flipX},set:function set(value){this._flipX!==value&&(this._flipX=value,this._updateTransform())}},{key:"flipY",get:function get(){return this._flipY},set:function set(value){this._flipY!==value&&(this._flipY=value,this._updateTransform())}},{key:"width",get:function get(){return this._width},set:function set(value){value!==this._width&&(this._width=value,this._outerScale.x=this._width,!this.sprite||2!==this.sprite.renderMode&&1!==this.sprite.renderMode||this._updateTransform())}},{key:"height",get:function get(){return this._height},set:function set(value){value!==this._height&&(this._height=value,this._outerScale.y=this.height,!this.sprite||2!==this.sprite.renderMode&&1!==this.sprite.renderMode||this._updateTransform())}},{key:"batchGroupId",get:function get(){return this._batchGroupId},set:function set(value){if(this._batchGroupId!==value){var prev=this._batchGroupId;this._batchGroupId=value,this.entity.enabled&&prev>=0&&this.system.app.batcher.remove(BatchGroup.SPRITE,prev,this.entity),this.entity.enabled&&value>=0?this.system.app.batcher.insert(BatchGroup.SPRITE,value,this.entity):prev>=0&&this._currentClip&&this._currentClip.sprite&&this.enabled&&this.entity.enabled&&this._showModel()}}},{key:"autoPlayClip",get:function get(){return this._autoPlayClip},set:function set(value){this._autoPlayClip=value instanceof SpriteAnimationClip?value.name:value,this._tryAutoPlay()}},{key:"drawOrder",get:function get(){return this._drawOrder},set:function set(value){this._drawOrder=value,this._meshInstance&&(this._meshInstance.drawOrder=value)}},{key:"layers",get:function get(){return this._layers},set:function set(value){this._addedModel&&this._hideModel(),this._layers=value,this._meshInstance&&this.enabled&&this.entity.enabled&&this._showModel()}},{key:"aabb",get:function get(){return this._meshInstance?this._meshInstance.aabb:null}}]),SpriteComponent}(Component),SpriteComponentData=function SpriteComponentData(){this.enabled=!0},_schema$1=["enabled"],SpriteComponentSystem=function(_ComponentSystem){function SpriteComponentSystem(app){var _this;return(_this=_ComponentSystem.call(this,app)||this).id="sprite",_this.ComponentType=SpriteComponent,_this.DataType=SpriteComponentData,_this.schema=_schema$1,_this._defaultTexture=null,_this._defaultMaterial=null,_this._default9SlicedMaterialSlicedMode=null,_this._default9SlicedMaterialTiledMode=null,ComponentSystem.bind("update",_this.onUpdate,_assertThisInitialized(_this)),_this.on("beforeremove",_this.onBeforeRemove,_assertThisInitialized(_this)),_this}_inheritsLoose(SpriteComponentSystem,_ComponentSystem);var _proto=SpriteComponentSystem.prototype;return _proto.destroy=function destroy(){this._defaultTexture&&(this._defaultTexture.destroy(),this._defaultTexture=null)},_proto.initializeComponentData=function initializeComponentData(component,data,properties){if(void 0!==data.enabled&&(component.enabled=data.enabled),component.type=data.type,data.layers&&Array.isArray(data.layers)&&(component.layers=data.layers.slice(0)),void 0!==data.drawOrder&&(component.drawOrder=data.drawOrder),void 0!==data.color&&(data.color instanceof Color?component.color.set(data.color.r,data.color.g,data.color.b,void 0!==data.opacity?data.opacity:1):component.color.set(data.color[0],data.color[1],data.color[2],void 0!==data.opacity?data.opacity:1),component.color=component.color),void 0!==data.opacity&&(component.opacity=data.opacity),void 0!==data.flipX&&(component.flipX=data.flipX),void 0!==data.flipY&&(component.flipY=data.flipY),void 0!==data.width&&(component.width=data.width),void 0!==data.height&&(component.height=data.height),void 0!==data.spriteAsset&&(component.spriteAsset=data.spriteAsset),data.sprite&&(component.sprite=data.sprite),void 0!==data.frame&&(component.frame=data.frame),data.clips)for(var name in data.clips)component.addClip(data.clips[name]);void 0!==data.speed&&(component.speed=data.speed),data.autoPlayClip&&(component.autoPlayClip=data.autoPlayClip),component.batchGroupId=void 0===data.batchGroupId||null===data.batchGroupId?-1:data.batchGroupId,_ComponentSystem.prototype.initializeComponentData.call(this,component,data,properties)},_proto.cloneComponent=function cloneComponent(entity,clone){var source=entity.sprite;return this.addComponent(clone,{enabled:source.enabled,type:source.type,spriteAsset:source.spriteAsset,sprite:source.sprite,frame:source.frame,color:source.color.clone(),opacity:source.opacity,flipX:source.flipX,flipY:source.flipY,speed:source.speed,clips:source.clips,autoPlayClip:source.autoPlayClip,batchGroupId:source.batchGroupId,drawOrder:source.drawOrder,layers:source.layers.slice(0)})},_proto.onUpdate=function onUpdate(dt){var components=this.store;for(var id in components)if(components.hasOwnProperty(id)){var component=components[id];if(component.data.enabled&&component.entity.enabled){var sprite=component.entity.sprite;sprite._currentClip&&sprite._currentClip._update(dt)}}},_proto.onBeforeRemove=function onBeforeRemove(entity,component){component.onDestroy()},_createClass(SpriteComponentSystem,[{key:"defaultMaterial",get:function get(){if(!this._defaultMaterial){var texture=new Texture(this.app.graphicsDevice,{width:1,height:1,format:7}),pixels=new Uint8Array(texture.lock());pixels[0]=pixels[1]=pixels[2]=pixels[3]=255,texture.name="sprite",texture.unlock();var material=new StandardMaterial;material.diffuse.set(0,0,0),material.emissive.set(.5,.5,.5),material.emissiveMap=texture,material.emissiveMapTint=!0,material.opacityMap=texture,material.opacityMapChannel="a",material.opacityTint=!0,material.opacity=0,material.useLighting=!1,material.useGammaTonemap=!1,material.useFog=!1,material.useSkybox=!1,material.blendType=4,material.depthWrite=!1,material.pixelSnap=!1,material.cull=0,material.update(),this._defaultTexture=texture,this._defaultMaterial=material}return this._defaultMaterial},set:function set(material){this._defaultMaterial=material}},{key:"default9SlicedMaterialSlicedMode",get:function get(){if(!this._default9SlicedMaterialSlicedMode){var material=this.defaultMaterial.clone();material.nineSlicedMode=1,material.update(),this._default9SlicedMaterialSlicedMode=material}return this._default9SlicedMaterialSlicedMode},set:function set(material){this._default9SlicedMaterialSlicedMode=material}},{key:"default9SlicedMaterialTiledMode",get:function get(){if(!this._default9SlicedMaterialTiledMode){var material=this.defaultMaterial.clone();material.nineSlicedMode=2,material.update(),this._default9SlicedMaterialTiledMode=material}return this._default9SlicedMaterialTiledMode},set:function set(material){this._default9SlicedMaterialTiledMode=material}}]),SpriteComponentSystem}(ComponentSystem);Component._buildAccessors(SpriteComponent.prototype,_schema$1);var ZoneComponent=function(_Component){function ZoneComponent(system,entity){var _this;return(_this=_Component.call(this,system,entity)||this)._oldState=!0,_this._size=new Vec3,_this.on("set_enabled",_this._onSetEnabled,_assertThisInitialized(_this)),_this}_inheritsLoose(ZoneComponent,_Component);var _proto=ZoneComponent.prototype;return _proto.onEnable=function onEnable(){this._checkState()},_proto.onDisable=function onDisable(){this._checkState()},_proto._onSetEnabled=function _onSetEnabled(prop,old,value){this._checkState()},_proto._checkState=function _checkState(){var state=this.enabled&&this.entity.enabled;state!==this._oldState&&(this._oldState=state,this.fire("enable"),this.fire("state",this.enabled))},_proto._onBeforeRemove=function _onBeforeRemove(){this.fire("remove")},_createClass(ZoneComponent,[{key:"size",get:function get(){return this._size},set:function set(data){data instanceof Vec3?this._size.copy(data):data instanceof Array&&data.length>=3&&this.size.set(data[0],data[1],data[2])}}]),ZoneComponent}(Component),ZoneComponentData=function ZoneComponentData(){this.enabled=!0},_schema=["enabled"],ZoneComponentSystem=function(_ComponentSystem){function ZoneComponentSystem(app){var _this;return(_this=_ComponentSystem.call(this,app)||this).id="zone",_this.ComponentType=ZoneComponent,_this.DataType=ZoneComponentData,_this.schema=_schema,_this.on("beforeremove",_this._onBeforeRemove,_assertThisInitialized(_this)),_this}_inheritsLoose(ZoneComponentSystem,_ComponentSystem);var _proto=ZoneComponentSystem.prototype;return _proto.initializeComponentData=function initializeComponentData(component,data,properties){component.enabled=!data.hasOwnProperty("enabled")||!!data.enabled,data.size&&(data.size instanceof Vec3?component.size.copy(data.size):data.size instanceof Array&&data.size.length>=3&&component.size.set(data.size[0],data.size[1],data.size[2]))},_proto.cloneComponent=function cloneComponent(entity,clone){var data={size:entity.zone.size};return this.addComponent(clone,data)},_proto._onBeforeRemove=function _onBeforeRemove(entity,component){component._onBeforeRemove()},ZoneComponentSystem}(ComponentSystem);Component._buildAccessors(ZoneComponent.prototype,_schema);var ApplicationStats=function(){function ApplicationStats(device){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,lightClustersTime:0,lightClusters:0,_timeToCountFrames:0,_fpsAccum:0},this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0},this.misc={renderTargetCreationTime:0},this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0},this.shaders=device._shaderStats,this.vram=device._vram,Object.defineProperty(this.vram,"totalUsed",{get:function get(){return this.tex+this.vb+this.ib}}),Object.defineProperty(this.vram,"geom",{get:function get(){return this.vb+this.ib}})}return _createClass(ApplicationStats,[{key:"scene",get:function get(){return getApplication().scene._stats}},{key:"lightmapper",get:function get(){return getApplication().lightmapper._stats}},{key:"batcher",get:function get(){return getApplication().batcher._stats}}]),ApplicationStats}(),SceneRegistryItem=function(){function SceneRegistryItem(name,url){this.name=name,this.url=url,this.data=null,this._loading=!1,this._onLoadedCallbacks=[]}return _createClass(SceneRegistryItem,[{key:"loaded",get:function get(){return!!this.data}},{key:"loading",get:function get(){return this._loading}}]),SceneRegistryItem}(),SceneRegistry=function(){function SceneRegistry(app){this._app=app,this._list=[],this._index={},this._urlIndex={}}var _proto=SceneRegistry.prototype;return _proto.destroy=function destroy(){this._app=null},_proto.list=function list(){return this._list},_proto.add=function add(name,url){if(this._index.hasOwnProperty(name))return!1;var item=new SceneRegistryItem(name,url),i=this._list.push(item);return this._index[item.name]=i-1,this._urlIndex[item.url]=i-1,!0},_proto.find=function find(name){return this._index.hasOwnProperty(name)?this._list[this._index[name]]:null},_proto.findByUrl=function findByUrl(url){return this._urlIndex.hasOwnProperty(url)?this._list[this._urlIndex[url]]:null},_proto.remove=function remove(name){if(this._index.hasOwnProperty(name)){var i=this._index[name],item=this._list[i];for(delete this._urlIndex[item.url],delete this._index[name],this._list.splice(i,1),i=0;i<this._list.length;i++)item=this._list[i],this._index[item.name]=i,this._urlIndex[item.url]=i}},_proto._loadSceneData=function _loadSceneData(sceneItem,storeInCache,callback){var url=sceneItem;if(sceneItem instanceof SceneRegistryItem?url=sceneItem.url:(sceneItem=this.findByUrl(url))||(sceneItem=new SceneRegistryItem("Untitled",url)),sceneItem.url)if(sceneItem.loaded)callback(null,sceneItem);else{var handler=this._app.loader.getHandler("hierarchy");this._app.assets&&this._app.assets.prefix&&!ABSOLUTE_URL.test(url)&&(url=path.join(this._app.assets.prefix,url)),sceneItem._onLoadedCallbacks.push(callback),sceneItem._loading||handler.load(url,(function(err,data){sceneItem.data=data,sceneItem._loading=!1;for(var i=0;i<sceneItem._onLoadedCallbacks.length;i++)sceneItem._onLoadedCallbacks[i](err,sceneItem);storeInCache||(sceneItem.data=null),sceneItem._onLoadedCallbacks.length=0})),sceneItem._loading=!0}else callback("URL or SceneRegistryItem is null when loading a scene")},_proto.loadSceneData=function loadSceneData(sceneItem,callback){this._loadSceneData(sceneItem,!0,callback)},_proto.unloadSceneData=function unloadSceneData(sceneItem){"string"==typeof sceneItem&&(sceneItem=this.findByUrl(sceneItem)),sceneItem&&(sceneItem.data=null)},_proto.loadSceneHierarchy=function loadSceneHierarchy(sceneItem,callback){var self=this,handler=this._app.loader.getHandler("hierarchy");this._loadSceneData(sceneItem,!1,(function(err,sceneItem){if(err)callback&&callback(err);else{var url=sceneItem.url,data=sceneItem.data,_loaded=function _loaded(){self._app.systems.script.preloading=!0;var entity=handler.open(url,data);self._app.systems.script.preloading=!1,self._app.loader.clearCache(url,"hierarchy"),self._app.root.addChild(entity),ComponentSystem.initialize(entity),ComponentSystem.postInitialize(entity),callback&&callback(err,entity)};self._app._preloadScripts(data,_loaded)}}))},_proto.loadSceneSettings=function loadSceneSettings(sceneItem,callback){var self=this;this._loadSceneData(sceneItem,!1,(function(err,sceneItem){err?callback&&callback(err):(self._app.applySceneSettings(sceneItem.data.settings),callback&&callback(null))}))},_proto.loadScene=function loadScene(url,callback){var self=this,handler=this._app.loader.getHandler("scene");this._app.assets&&this._app.assets.prefix&&!ABSOLUTE_URL.test(url)&&(url=path.join(this._app.assets.prefix,url)),handler.load(url,(function(err,data){if(err)callback&&callback(err);else{var _loaded=function _loaded(){self._app.systems.script.preloading=!0;var scene=handler.open(url,data),sceneItem=self.findByUrl(url);sceneItem&&!sceneItem.loaded&&(sceneItem.data=data),self._app.systems.script.preloading=!1,self._app.loader.clearCache(url,"scene"),self._app.loader.patch({resource:scene,type:"scene"},self._app.assets),self._app.root.addChild(scene.root),self._app.systems.rigidbody&&"undefined"!=typeof Ammo&&self._app.systems.rigidbody.gravity.set(scene._gravity.x,scene._gravity.y,scene._gravity.z),callback&&callback(null,scene)};self._app._preloadScripts(data,_loaded)}}))},SceneRegistry}(),SceneDepth=function(){function SceneDepth(application){this.application=application,this.device=application.graphicsDevice,this.clearOptions=null,this.layer=null,this.init()}var _proto=SceneDepth.prototype;return _proto.allocateTexture=function allocateTexture(device,name,format){var texture=new Texture(device,{format:format,width:device.width,height:device.height,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});return texture.name=name,device.scope.resolve("uDepthMap").setValue(texture),texture},_proto.allocateRenderTarget=function allocateRenderTarget(renderTarget,device,name,format,isDepth){var buffer=this.allocateTexture(device,name,format);return renderTarget?(renderTarget.destroyFrameBuffers(),isDepth?renderTarget._depthBuffer=buffer:renderTarget._colorBuffer=buffer):renderTarget=new RenderTarget({colorBuffer:isDepth?null:buffer,depthBuffer:isDepth?buffer:null,depth:!isDepth,stencil:device.supportsStencil,autoResolve:!1}),renderTarget},_proto.releaseRenderTarget=function releaseRenderTarget(rt){rt&&(rt.destroyTextureBuffers(),rt.destroy())},_proto.initWebGl2=function initWebGl2(){var app=this.application,self=this;this.clearOptions={flags:0},this.layer=new Layer({enabled:!1,name:"Depth",id:1,onEnable:function onEnable(){this.renderTarget=self.allocateRenderTarget(this.renderTarget,app.graphicsDevice,"rt-depth2",17,!0)},onDisable:function onDisable(){self.releaseRenderTarget(this.renderTarget),this.renderTarget=null},onPreRenderOpaque:function onPreRenderOpaque(cameraPass){var gl=app.graphicsDevice.gl;this.srcFbo=gl.getParameter(gl.FRAMEBUFFER_BINDING),this.renderTarget.width===app.graphicsDevice.width&&this.renderTarget.height===app.graphicsDevice.height||this.onEnable(),this.oldClear=this.cameras[cameraPass].camera._clearOptions,this.cameras[cameraPass].camera._clearOptions=self.clearOptions},onPostRenderOpaque:function onPostRenderOpaque(cameraPass){if(this.renderTarget){this.cameras[cameraPass].camera._clearOptions=this.oldClear,app.graphicsDevice.setRenderTarget(this.renderTarget),app.graphicsDevice.updateBegin();var gl=app.graphicsDevice.gl;gl.bindFramebuffer(gl.READ_FRAMEBUFFER,this.srcFbo),gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,this.renderTarget._glFrameBuffer),gl.blitFramebuffer(0,0,this.renderTarget.width,this.renderTarget.height,0,0,this.renderTarget.width,this.renderTarget.height,gl.DEPTH_BUFFER_BIT,gl.NEAREST)}}})},_proto.initWebGl1=function initWebGl1(){var app=this.application,self=this;this.clearOptions={color:[254/255,254/255,254/255,254/255],depth:1,flags:3},this.layer=new Layer({enabled:!1,name:"Depth",id:1,shaderPass:2,onEnable:function onEnable(){this.renderTarget=self.allocateRenderTarget(this.renderTarget,app.graphicsDevice,"rt-depth1",7,!1)},onDisable:function onDisable(){self.releaseRenderTarget(this.renderTarget),this.renderTarget=null},onPostCull:function onPostCull(cameraPass){for(var visibleObjects=this.instances.visibleOpaque[cameraPass],visibleList=visibleObjects.list,layerComposition=app.scene.layers,subLayerEnabled=layerComposition.subLayerEnabled,isTransparent=layerComposition.subLayerList,rt=app.scene.layers.getLayerById(0).renderTarget,cam=this.cameras[cameraPass],visibleLength=0,layers=layerComposition.layerList,i=0;i<layers.length;i++){var layer=layers[i];if(layer===this)break;if(layer.renderTarget===rt&&layer.enabled&&subLayerEnabled[i]){var layerCamId=layer.cameras.indexOf(cam);if(!(layerCamId<0)){var transparent,layerVisibleList=isTransparent[i]?layer.instances.visibleTransparent[layerCamId]:layer.instances.visibleOpaque[layerCamId],layerVisibleListLength=layerVisibleList.length;layerVisibleList=layerVisibleList.list;for(var j=0;j<layerVisibleListLength;j++){var drawCall=layerVisibleList[j];drawCall.material&&drawCall.material.depthWrite&&!drawCall._noDepthDrawGl1&&(visibleList[visibleLength]=drawCall,visibleLength++)}}}}visibleObjects.length=visibleLength},onPreRenderOpaque:function onPreRenderOpaque(cameraPass){this.renderTarget.width===app.graphicsDevice.width&&this.renderTarget.height===app.graphicsDevice.height||this.onEnable(),this.oldClear=this.cameras[cameraPass].camera._clearOptions,this.cameras[cameraPass].camera._clearOptions=self.clearOptions},onDrawCall:function onDrawCall(){app.graphicsDevice.setColorWrite(!0,!0,!0,!0)},onPostRenderOpaque:function onPostRenderOpaque(cameraPass){this.renderTarget&&(this.cameras[cameraPass].camera._clearOptions=this.oldClear)}})},_proto.init=function init(){this.device.webgl2?this.initWebGl2():this.initWebGl1()},_proto.patch=function patch(layer){layer.onEnable=this.layer.onEnable,layer.onDisable=this.layer.onDisable,layer.onPreRenderOpaque=this.layer.onPreRenderOpaque,layer.onPostRenderOpaque=this.layer.onPostRenderOpaque,layer.shaderPass=this.layer.shaderPass,layer.onPostCull=this.layer.onPostCull,layer.onDrawCall=this.layer.onDrawCall},SceneDepth}(),Progress=function(){function Progress(length){this.length=length,this.count=0}var _proto=Progress.prototype;return _proto.inc=function inc(){this.count++},_proto.done=function done(){return this.count===this.length},Progress}(),_deprecationWarning=!1;exports.app=null;var Application=function(_EventHandler){function Application(canvas,options){var _this;void 0===options&&(options={}),_this=_EventHandler.call(this)||this,console.log("Powered by PlayCanvas 1.43.1 49927b7"),Application._applications[canvas.id]=_assertThisInitialized(_this),setApplication(_assertThisInitialized(_this)),exports.app=_assertThisInitialized(_this),_this._destroyRequested=!1,_this._inFrameUpdate=!1,_this._time=0,_this.timeScale=1,_this.maxDeltaTime=.1,_this.frame=0,_this.autoRender=!0,_this.renderNextFrame=!1,_this.useLegacyScriptAttributeCloning=script.legacy,_this._librariesLoaded=!1,_this._fillMode="KEEP_ASPECT",_this._resolutionMode="FIXED",_this._allowResize=!0,_this.context=_assertThisInitialized(_this),options.graphicsDeviceOptions||(options.graphicsDeviceOptions={}),options.graphicsDeviceOptions.xrCompatible=!0,options.graphicsDeviceOptions.alpha=options.graphicsDeviceOptions.alpha||!1,_this.graphicsDevice=new GraphicsDevice(canvas,options.graphicsDeviceOptions),_this.stats=new ApplicationStats(_this.graphicsDevice),_this._soundManager=new SoundManager(options),_this.loader=new ResourceLoader(_assertThisInitialized(_this)),WorldClusters.init(_this.graphicsDevice),_this._entityIndex={},_this.scene=new Scene,_this.root=new Entity(_assertThisInitialized(_this)),_this.root._enabledInHierarchy=!0,_this._enableList=[],_this._enableList.size=0,_this.assets=new AssetRegistry(_this.loader),options.assetPrefix&&(_this.assets.prefix=options.assetPrefix),_this.bundles=new BundleRegistry(_this.assets),_this.enableBundles="undefined"!=typeof TextDecoder,_this.scriptsOrder=options.scriptsOrder||[],_this.scripts=new ScriptRegistry(_assertThisInitialized(_this)),_this.i18n=new I18n(_assertThisInitialized(_this)),_this.scenes=new SceneRegistry(_assertThisInitialized(_this));var self=_assertThisInitialized(_this);_this.defaultLayerWorld=new Layer({name:"World",id:0}),_this.sceneDepth=new SceneDepth(_assertThisInitialized(_this)),_this.defaultLayerDepth=_this.sceneDepth.layer,_this.defaultLayerSkybox=new Layer({enabled:!0,name:"Skybox",id:2,opaqueSortMode:0}),_this.defaultLayerUi=new Layer({enabled:!0,name:"UI",id:4,transparentSortMode:1,passThrough:!1}),_this.defaultLayerImmediate=new Layer({enabled:!0,name:"Immediate",id:3,opaqueSortMode:0,passThrough:!0});var defaultLayerComposition=new LayerComposition(_this.graphicsDevice,"default");return defaultLayerComposition.pushOpaque(_this.defaultLayerWorld),defaultLayerComposition.pushOpaque(_this.defaultLayerDepth),defaultLayerComposition.pushOpaque(_this.defaultLayerSkybox),defaultLayerComposition.pushTransparent(_this.defaultLayerWorld),defaultLayerComposition.pushOpaque(_this.defaultLayerImmediate),defaultLayerComposition.pushTransparent(_this.defaultLayerImmediate),defaultLayerComposition.pushTransparent(_this.defaultLayerUi),_this.scene.layers=defaultLayerComposition,_this._immediateLayer=_this.defaultLayerImmediate,_this.scene.on("set:layers",(function(oldComp,newComp){for(var list=newComp.layerList,layer,i=0;i<list.length;i++)switch((layer=list[i]).id){case 1:self.sceneDepth.patch(layer);break;case 4:layer.passThrough=self.defaultLayerUi.passThrough;break;case 3:layer.passThrough=self.defaultLayerImmediate.passThrough}})),AreaLightLuts.createPlaceholder(_this.graphicsDevice),_this.renderer=new ForwardRenderer(_this.graphicsDevice),_this.renderer.scene=_this.scene,_this.lightmapper=new Lightmapper(_this.graphicsDevice,_this.root,_this.scene,_this.renderer,_this.assets),_this.once("prerender",_this._firstBake,_assertThisInitialized(_this)),_this.batcher=new BatchManager(_this.graphicsDevice,_this.root,_this.scene),_this.once("prerender",_this._firstBatch,_assertThisInitialized(_this)),_this.keyboard=options.keyboard||null,_this.mouse=options.mouse||null,_this.touch=options.touch||null,_this.gamepads=options.gamepads||null,_this.elementInput=options.elementInput||null,_this.elementInput&&(_this.elementInput.app=_assertThisInitialized(_this)),_this.vr=null,_this.xr=new XrManager(_assertThisInitialized(_this)),_this.elementInput&&_this.elementInput.attachSelectEvents(),_this._inTools=!1,_this._skyboxLast=0,_this._scriptPrefix=options.scriptPrefix||"",_this.enableBundles&&_this.loader.addHandler("bundle",new BundleHandler(_this.assets)),_this.loader.addHandler("animation",new AnimationHandler),_this.loader.addHandler("animclip",new AnimClipHandler),_this.loader.addHandler("animstategraph",new AnimStateGraphHandler),_this.loader.addHandler("model",new ModelHandler(_this.graphicsDevice,_this.scene.defaultMaterial)),_this.loader.addHandler("render",new RenderHandler(_this.assets)),_this.loader.addHandler("material",new MaterialHandler(_assertThisInitialized(_this))),_this.loader.addHandler("texture",new TextureHandler(_this.graphicsDevice,_this.assets,_this.loader)),_this.loader.addHandler("text",new TextHandler),_this.loader.addHandler("json",new JsonHandler),_this.loader.addHandler("audio",new AudioHandler(_this._soundManager)),_this.loader.addHandler("script",new ScriptHandler(_assertThisInitialized(_this))),_this.loader.addHandler("scene",new SceneHandler(_assertThisInitialized(_this))),_this.loader.addHandler("cubemap",new CubemapHandler(_this.graphicsDevice,_this.assets,_this.loader)),_this.loader.addHandler("html",new HtmlHandler),_this.loader.addHandler("css",new CssHandler),_this.loader.addHandler("shader",new ShaderHandler),_this.loader.addHandler("hierarchy",new HierarchyHandler(_assertThisInitialized(_this))),_this.loader.addHandler("folder",new FolderHandler),_this.loader.addHandler("font",new FontHandler(_this.loader)),_this.loader.addHandler("binary",new BinaryHandler),_this.loader.addHandler("textureatlas",new TextureAtlasHandler(_this.loader)),_this.loader.addHandler("sprite",new SpriteHandler(_this.assets,_this.graphicsDevice)),_this.loader.addHandler("template",new TemplateHandler(_assertThisInitialized(_this))),_this.loader.addHandler("container",new ContainerHandler(_this.graphicsDevice,_this.scene.defaultMaterial)),_this.systems=new ComponentSystemRegistry,_this.systems.add(new RigidBodyComponentSystem(_assertThisInitialized(_this))),_this.systems.add(new CollisionComponentSystem(_assertThisInitialized(_this))),_this.systems.add(new JointComponentSystem(_assertThisInitialized(_this))),_this.systems.add(new AnimationComponentSystem(_assertThisInitialized(_this))),_this.systems.add(new AnimComponentSystem(_assertThisInitialized(_this))),_this.systems.add(new ModelComponentSystem(_assertThisInitialized(_this))),_this.systems.add(new RenderComponentSystem(_assertThisInitialized(_this))),_this.systems.add(new CameraComponentSystem(_assertThisInitialized(_this))),_this.systems.add(new LightComponentSystem(_assertThisInitialized(_this))),script.legacy?_this.systems.add(new ScriptLegacyComponentSystem(_assertThisInitialized(_this))):_this.systems.add(new ScriptComponentSystem(_assertThisInitialized(_this))),_this.systems.add(new AudioSourceComponentSystem(_assertThisInitialized(_this),_this._soundManager)),_this.systems.add(new SoundComponentSystem(_assertThisInitialized(_this),_this._soundManager)),_this.systems.add(new AudioListenerComponentSystem(_assertThisInitialized(_this),_this._soundManager)),_this.systems.add(new ParticleSystemComponentSystem(_assertThisInitialized(_this))),_this.systems.add(new ScreenComponentSystem(_assertThisInitialized(_this))),_this.systems.add(new ElementComponentSystem(_assertThisInitialized(_this))),_this.systems.add(new ButtonComponentSystem(_assertThisInitialized(_this))),_this.systems.add(new ScrollViewComponentSystem(_assertThisInitialized(_this))),_this.systems.add(new ScrollbarComponentSystem(_assertThisInitialized(_this))),_this.systems.add(new SpriteComponentSystem(_assertThisInitialized(_this))),_this.systems.add(new LayoutGroupComponentSystem(_assertThisInitialized(_this))),_this.systems.add(new LayoutChildComponentSystem(_assertThisInitialized(_this))),_this.systems.add(new ZoneComponentSystem(_assertThisInitialized(_this))),_this._visibilityChangeHandler=_this.onVisibilityChange.bind(_assertThisInitialized(_this)),"undefined"!=typeof document&&(void 0!==document.hidden?(_this._hiddenAttr="hidden",document.addEventListener("visibilitychange",_this._visibilityChangeHandler,!1)):void 0!==document.mozHidden?(_this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",_this._visibilityChangeHandler,!1)):void 0!==document.msHidden?(_this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",_this._visibilityChangeHandler,!1)):void 0!==document.webkitHidden&&(_this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",_this._visibilityChangeHandler,!1))),_this.tick=makeTick(_assertThisInitialized(_this)),_this}_inheritsLoose(Application,_EventHandler),Application.getApplication=function getApplication$1(id){return id?Application._applications[id]:getApplication()};var _proto2=Application.prototype;return _proto2.configure=function configure(url,callback){var self=this;http.get(url,(function(err,response){if(err)callback(err);else{var props=response.application_properties,scenes=response.scenes,assets=response.assets;self._parseApplicationProperties(props,(function(err){self._parseScenes(scenes),self._parseAssets(assets),callback(err||null)}))}}))},_proto2.configure_additive=function configure_additive(url,callback){var self=this;http.get(url,(function(err,response){if(err)callback(err);else{var props=response.application_properties,scenes=response.scenes,assets=response.assets;self._parseScenes(scenes),self._parseAssets(assets),callback(err||null)}}))},_proto2.preload=function preload(callback){var self=this,i,total;self.fire("preload:start");var assets=this.assets.list({preload:!0}),_assets=new Progress(assets.length),_done=!1,done=function done(){self.graphicsDevice&&!_done&&_assets.done()&&(_done=!0,self.fire("preload:end"),callback())};total=assets.length;var count=function count(){return _assets.count};if(_assets.length){var onAssetLoad=function onAssetLoad(asset){_assets.inc(),self.fire("preload:progress",count()/total),_assets.done()&&done()},onAssetError=function onAssetError(err,asset){_assets.inc(),self.fire("preload:progress",count()/total),_assets.done()&&done()};for(i=0;i<assets.length;i++)assets[i].loaded?(_assets.inc(),self.fire("preload:progress",count()/total),_assets.done()&&done()):(assets[i].once("load",onAssetLoad),assets[i].once("error",onAssetError),this.assets.load(assets[i]))}else done()},_proto2._preloadScripts=function _preloadScripts(sceneData,callback){if(script.legacy){var self=this;self.systems.script.preloading=!0;var scripts=this._getScriptReferences(sceneData),i=0,l=scripts.length,progress=new Progress(l),scriptUrl,regex=/^http(s)?:\/\//;if(l){var onLoad=function onLoad(err,ScriptType){err&&console.error(err),progress.inc(),progress.done()&&(self.systems.script.preloading=!1,callback())};for(i=0;i<l;i++)scriptUrl=scripts[i],!regex.test(scriptUrl.toLowerCase())&&self._scriptPrefix&&(scriptUrl=path.join(self._scriptPrefix,scripts[i])),this.loader.load(scriptUrl,"script",onLoad)}else self.systems.script.preloading=!1,callback()}else callback()},_proto2._handleAreaLightDataProperty=function _handleAreaLightDataProperty(prop){var asset=this.assets.get(prop);asset?this.setAreaLightLuts(asset):this.assets.once("add:"+prop,this.setAreaLightLuts,this)},_proto2._parseApplicationProperties=function _parseApplicationProperties(props,callback){var i,len;if("number"==typeof props.maxAssetRetries&&props.maxAssetRetries>0&&this.loader.enableRetry(props.maxAssetRetries),props.useDevicePixelRatio||(props.useDevicePixelRatio=props.use_device_pixel_ratio),props.resolutionMode||(props.resolutionMode=props.resolution_mode),props.fillMode||(props.fillMode=props.fill_mode),this._width=props.width,this._height=props.height,props.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio),this.setCanvasResolution(props.resolutionMode,this._width,this._height),this.setCanvasFillMode(props.fillMode,this._width,this._height),props.layers&&props.layerOrder){var composition=new LayerComposition(this.graphicsDevice,"application"),layers={};for(var key in props.layers){var data=props.layers[key];data.id=parseInt(key,10),data.enabled=1!==data.id,layers[key]=new Layer(data)}for(i=0,len=props.layerOrder.length;i<len;i++){var sublayer=props.layerOrder[i],layer=layers[sublayer.layer];layer&&(sublayer.transparent?composition.pushTransparent(layer):composition.pushOpaque(layer),composition.subLayerEnabled[i]=sublayer.enabled)}this.scene.layers=composition}if(props.batchGroups)for(i=0,len=props.batchGroups.length;i<len;i++){var grp=props.batchGroups[i];this.batcher.addGroup(grp.name,grp.dynamic,grp.maxAabbSize,grp.id,grp.layers)}props.i18nAssets&&(this.i18n.assets=props.i18nAssets),props.areaLightDataAsset&&this._handleAreaLightDataProperty(props.areaLightDataAsset),this._loadLibraries(props.libraries,callback)},_proto2._loadLibraries=function _loadLibraries(urls,callback){var len=urls.length,count=len,self=this,regex=/^http(s)?:\/\//;if(len)for(var onLoad=function onLoad(err,script){count--,err?callback(err):0===count&&(self.onLibrariesLoaded(),callback(null))},i=0;i<len;++i){var url=urls[i];!regex.test(url.toLowerCase())&&self._scriptPrefix&&(url=path.join(self._scriptPrefix,url)),this.loader.load(url,"script",onLoad)}else self.onLibrariesLoaded(),callback(null)},_proto2._parseScenes=function _parseScenes(scenes){if(scenes)for(var i=0;i<scenes.length;i++)this.scenes.add(scenes[i].name,scenes[i].url)},_proto2._parseAssets=function _parseAssets(assets){var i,id,list=[],scriptsIndex={},bundlesIndex={};if(script.legacy){if(this.enableBundles)for(id in assets)"bundle"===assets[id].type&&(bundlesIndex[id]=!0,list.push(assets[id]));for(id in assets)bundlesIndex[id]||list.push(assets[id])}else{for(i=0;i<this.scriptsOrder.length;i++)assets[id=this.scriptsOrder[i]]&&(scriptsIndex[id]=!0,list.push(assets[id]));if(this.enableBundles)for(id in assets)"bundle"===assets[id].type&&(bundlesIndex[id]=!0,list.push(assets[id]));for(id in assets)scriptsIndex[id]||bundlesIndex[id]||list.push(assets[id])}for(i=0;i<list.length;i++){var data=list[i],asset=new Asset(data.name,data.type,data.file,data.data);if(asset.id=parseInt(data.id,10),asset.preload=!!data.preload&&data.preload,asset.loaded="script"===data.type&&data.data&&data.data.loadingType>0,asset.tags.add(data.tags),data.i18n)for(var locale in data.i18n)asset.addLocalizedAssetId(locale,data.i18n[locale]);this.assets.add(asset)}},_proto2._getScriptReferences=function _getScriptReferences(scene){var i,key,priorityScripts=[];scene.settings.priority_scripts&&(priorityScripts=scene.settings.priority_scripts);var _scripts=[],_index={};for(i=0;i<priorityScripts.length;i++)_scripts.push(priorityScripts[i]),_index[priorityScripts[i]]=!0;var entities=scene.entities;for(key in entities)if(entities[key].components.script){var scripts=entities[key].components.script.scripts;for(i=0;i<scripts.length;i++)_index[scripts[i].url]||(_scripts.push(scripts[i].url),_index[scripts[i].url]=!0)}return _scripts},_proto2.start=function start(){this.frame=0,this.fire("start",{timestamp:now(),target:this}),this._librariesLoaded||this.onLibrariesLoaded(),ComponentSystem.initialize(this.root),this.fire("initialize"),ComponentSystem.postInitialize(this.root),this.fire("postinitialize"),this.tick()},_proto2.inputUpdate=function inputUpdate(dt){this.controller&&this.controller.update(dt),this.mouse&&this.mouse.update(dt),this.keyboard&&this.keyboard.update(dt),this.gamepads&&this.gamepads.update(dt)},_proto2.update=function update(dt){this.frame++,this.graphicsDevice.updateClientRect(),this.vr&&this.vr.poll(),script.legacy&&ComponentSystem.fixedUpdate(1/60,this._inTools),ComponentSystem.update(dt,this._inTools),ComponentSystem.animationUpdate(dt,this._inTools),ComponentSystem.postUpdate(dt,this._inTools),this.fire("update",dt),this.inputUpdate(dt)},_proto2.render=function render(){this.fire("prerender"),this.root.syncHierarchy(),this.batcher.updateAll(),this.renderer.renderComposition(this.scene.layers),this.fire("postrender")},_proto2._fillFrameStatsBasic=function _fillFrameStatsBasic(now,dt,ms){var stats=this.stats.frame;stats.dt=dt,stats.ms=ms,now>stats._timeToCountFrames?(stats.fps=stats._fpsAccum,stats._fpsAccum=0,stats._timeToCountFrames=now+1e3):stats._fpsAccum++,this.stats.drawCalls.total=this.graphicsDevice._drawCallsPerFrame,this.graphicsDevice._drawCallsPerFrame=0},_proto2._fillFrameStats=function _fillFrameStats(){var stats=this.stats.frame;stats.cameras=this.renderer._camerasRendered,stats.materials=this.renderer._materialSwitches,stats.shaders=this.graphicsDevice._shaderSwitchesPerFrame,stats.shadowMapUpdates=this.renderer._shadowMapUpdates,stats.shadowMapTime=this.renderer._shadowMapTime,stats.depthMapTime=this.renderer._depthMapTime,stats.forwardTime=this.renderer._forwardTime;var prims=this.graphicsDevice._primsPerFrame;stats.triangles=prims[4]/3+Math.max(prims[5]-2,0)+Math.max(prims[6]-2,0),stats.cullTime=this.renderer._cullTime,stats.sortTime=this.renderer._sortTime,stats.skinTime=this.renderer._skinTime,stats.morphTime=this.renderer._morphTime,stats.instancingTime=this.renderer._instancingTime,stats.lightClusters=this.renderer._lightClusters,stats.lightClustersTime=this.renderer._lightClustersTime,stats.otherPrimitives=0;for(var i=0;i<prims.length;i++)i<4&&(stats.otherPrimitives+=prims[i]),prims[i]=0;this.renderer._camerasRendered=0,this.renderer._materialSwitches=0,this.renderer._shadowMapUpdates=0,this.graphicsDevice._shaderSwitchesPerFrame=0,this.renderer._cullTime=0,this.renderer._layerCompositionUpdateTime=0,this.renderer._lightClustersTime=0,this.renderer._sortTime=0,this.renderer._skinTime=0,this.renderer._morphTime=0,this.renderer._instancingTime=0,this.renderer._shadowMapTime=0,this.renderer._depthMapTime=0,this.renderer._forwardTime=0,(stats=this.stats.drawCalls).forward=this.renderer._forwardDrawCalls,stats.culled=this.renderer._numDrawCallsCulled,stats.depth=0,stats.shadow=this.renderer._shadowDrawCalls,stats.skinned=this.renderer._skinDrawCalls,stats.immediate=0,stats.instanced=0,stats.removedByInstancing=0,stats.misc=stats.total-(stats.forward+stats.shadow),this.renderer._depthDrawCalls=0,this.renderer._shadowDrawCalls=0,this.renderer._forwardDrawCalls=0,this.renderer._numDrawCallsCulled=0,this.renderer._skinDrawCalls=0,this.renderer._immediateRendered=0,this.renderer._instancedDrawCalls=0,this.renderer._removedByInstancing=0,this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime,(stats=this.stats.particles).updatesPerFrame=stats._updatesPerFrame,stats.frameTime=stats._frameTime,stats._updatesPerFrame=0,stats._frameTime=0},_proto2.setCanvasFillMode=function setCanvasFillMode(mode,width,height){this._fillMode=mode,this.resizeCanvas(width,height)},_proto2.setCanvasResolution=function setCanvasResolution(mode,width,height){this._resolutionMode=mode,"AUTO"===mode&&void 0===width&&(width=this.graphicsDevice.canvas.clientWidth,height=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(width,height)},_proto2.isHidden=function isHidden(){return document[this._hiddenAttr]},_proto2.onVisibilityChange=function onVisibilityChange(){this.isHidden()?this._soundManager.suspend():this._soundManager.resume()},_proto2.resizeCanvas=function resizeCanvas(width,height){if(this._allowResize&&(!this.xr||!this.xr.session)){var windowWidth=window.innerWidth,windowHeight=window.innerHeight;if("KEEP_ASPECT"===this._fillMode){var r=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height,winR;r>windowWidth/windowHeight?height=(width=windowWidth)/r:width=(height=windowHeight)*r}else"FILL_WINDOW"===this._fillMode&&(width=windowWidth,height=windowHeight);return this.graphicsDevice.canvas.style.width=width+"px",this.graphicsDevice.canvas.style.height=height+"px",this.updateCanvasSize(),{width:width,height:height}}},_proto2.updateCanvasSize=function updateCanvasSize(){if(!(this.vr&&this.vr.display||this.xr.active&&this.xr.type===XRTYPE_VR)&&"AUTO"===this._resolutionMode){var canvas=this.graphicsDevice.canvas;this.graphicsDevice.resizeCanvas(canvas.clientWidth,canvas.clientHeight)}},_proto2.onLibrariesLoaded=function onLibrariesLoaded(){this._librariesLoaded=!0,this.systems.rigidbody.onLibraryLoaded()},_proto2.applySceneSettings=function applySceneSettings(settings){var asset;if(this.systems.rigidbody&&"undefined"!=typeof Ammo){var gravity=settings.physics.gravity;this.systems.rigidbody.gravity.set(gravity[0],gravity[1],gravity[2])}this.scene.applySettings(settings),settings.render.hasOwnProperty("skybox")&&(settings.render.skybox?(asset=this.assets.get(settings.render.skybox))?this.setSkybox(asset):this.assets.once("add:"+settings.render.skybox,this.setSkybox,this):this.setSkybox(null))},_proto2.setAreaLightLuts=function setAreaLightLuts(asset){if(asset){var device=this.graphicsDevice;asset.ready((function(asset){AreaLightLuts.set(device,asset.resource)})),this.assets.load(asset)}},_proto2.setSkybox=function setSkybox(asset){if(asset){if(this._skyboxLast===asset.id)return void(0!==this.scene.skyboxMip||asset.loadFaces?this._onSkyboxChange(asset):this._skyboxLoad(asset));this._skyboxLast&&(this.assets.off("add:"+this._skyboxLast,this.setSkybox,this),this.assets.off("load:"+this._skyboxLast,this._onSkyboxChange,this),this.assets.off("remove:"+this._skyboxLast,this._skyboxRemove,this)),this._skyboxLast=asset.id,this.assets.on("load:"+asset.id,this._onSkyboxChange,this),this.assets.once("remove:"+asset.id,this._skyboxRemove,this),asset.resource&&this.scene.setSkybox(asset.resources),this._skyboxLoad(asset)}else{if(!this._skyboxLast)return;this._skyboxRemove({id:this._skyboxLast})}},_proto2.enableVr=function enableVr(){this.vr||(this.vr=new VrManager(this))},_proto2.disableVr=function disableVr(){this.vr&&(this.vr.destroy(),this.vr=null)},_proto2._onSkyboxChange=function _onSkyboxChange(asset){this.scene.setSkybox(asset.resources)},_proto2._skyboxLoad=function _skyboxLoad(asset){0===this.scene.skyboxMip&&(asset.loadFaces=!0),this.assets.load(asset),this._onSkyboxChange(asset)},_proto2._skyboxRemove=function _skyboxRemove(asset){this._skyboxLast&&(this.assets.off("add:"+asset.id,this.setSkybox,this),this.assets.off("load:"+asset.id,this._onSkyboxChange,this),this.assets.off("remove:"+asset.id,this._skyboxRemove,this),this.scene.setSkybox(null),this._skyboxLast=null)},_proto2._firstBake=function _firstBake(){this.lightmapper.bake(null,this.scene.lightmapMode)},_proto2._firstBatch=function _firstBatch(){this.scene._needsStaticPrepare&&(this.renderer.prepareStaticMeshes(this.graphicsDevice,this.scene),this.scene._needsStaticPrepare=!1),this.batcher.generate()},_proto2._processTimestamp=function _processTimestamp(timestamp){return timestamp},_proto2._preRenderImmediate=function _preRenderImmediate(){this._immediateData.finalize()},_proto2._postRenderImmediate=function _postRenderImmediate(){this._immediateData.clear()},_proto2._initImmediate=function _initImmediate(){this._immediateData||(this._immediateData=new ImmediateData(this.graphicsDevice),this.on("prerender",this._preRenderImmediate,this),this.on("postrender",this._postRenderImmediate,this))},_proto2._addLines=function _addLines(position,color,options){var layer=options&&options.layer?options.layer:this.scene.layers.getLayerById(3),depthTest=!options||void 0===options.depthTest||options.depthTest,mask=options&&options.mask?options.mask:void 0,lineBatch;this._initImmediate(),this._immediateData.prepareLineBatch(layer,depthTest,mask,position.length/2).addLines(position,color)},_proto2.renderLine=function renderLine(start,end,color){var endColor=color,options,arg3=arguments[3],arg4=arguments[4];arg3 instanceof Color?(endColor=arg3,"number"==typeof arg4?(_deprecationWarning||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),_deprecationWarning=!0),options=1===arg4?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}):options=arg4):"number"==typeof arg3?(_deprecationWarning||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),_deprecationWarning=!0),endColor=color,options=1===arg3?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}):arg3&&(options=arg3),this._addLines([start,end],[color,endColor],options)},_proto2.renderLines=function renderLines(position,color,options){var multiColor;options?"number"==typeof options&&(_deprecationWarning||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),_deprecationWarning=!0),options=1===options?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}):options={layer:this.scene.layers.getLayerById(3),depthTest:!0},!color.length||position.length===color.length?position.length%2==0?this._addLines(position,color,options):console.error("renderLines: array length is not divisible by 2"):console.error("renderLines: position/color arrays have different lengths")},_proto2._getDefaultImmediateOptions=function _getDefaultImmediateOptions(depthTest){return void 0===depthTest&&(depthTest=!1),{layer:this.scene.layers.getLayerById(3),depthTest:depthTest}},_proto2.renderWireCube=function renderWireCube(matrix,color,options){void 0===options&&(options=this._getDefaultImmediateOptions(!0)),this._initImmediate(),this._immediateData.renderWireCube(matrix,color,options)},_proto2.renderWireSphere=function renderWireSphere(center,radius,color,options){void 0===options&&(options=this._getDefaultImmediateOptions(!0)),this._initImmediate(),this._immediateData.renderWireSphere(center,radius,color,options)},_proto2.renderMeshInstance=function renderMeshInstance(meshInstance,options){void 0===options&&(options=this._getDefaultImmediateOptions(!0)),this._initImmediate(),this._immediateData.renderMesh(null,null,null,meshInstance,options)},_proto2.renderMesh=function renderMesh(mesh,material,matrix,options){void 0===options&&(options=this._getDefaultImmediateOptions(!0)),this._initImmediate(),this._immediateData.renderMesh(material,matrix,mesh,null,options)},_proto2.renderQuad=function renderQuad(matrix,material,options){void 0===options&&(options=this._getDefaultImmediateOptions()),this._initImmediate(),this._immediateData.renderMesh(material,matrix,this._immediateData.getQuadMesh(),null,options)},_proto2.renderTexture=function renderTexture(x,y,width,height,texture,material,options){this._initImmediate();var matrix=new Mat4;matrix.setTRS(new Vec3(x,y,0),Quat.IDENTITY,new Vec3(width,height,0)),material||((material=new Material).setParameter("colorMap",texture),material.shader=this._immediateData.getTextureShader(),material.update()),this.renderQuad(matrix,material,options)},_proto2.renderDepthTexture=function renderDepthTexture(x,y,width,height,options){this._initImmediate();var material=new Material;material.shader=this._immediateData.getDepthTextureShader(),material.update(),this.renderTexture(x,y,width,height,null,material,options)},_proto2.destroy=function destroy(){if(this._inFrameUpdate)this._destroyRequested=!0;else{var i,l,canvasId=this.graphicsDevice.canvas.id;this.off("librariesloaded"),document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1),this._visibilityChangeHandler=null,this.onVisibilityChange=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.controller&&(this.controller=null);var systems=this.systems.list;for(i=0,l=systems.length;i<l;i++)systems[i].destroy();ComponentSystem.destroy(),this.scene.layers&&this.scene.layers.destroy();var assets=this.assets.list();for(i=0;i<assets.length;i++)assets[i].unload(),assets[i].off();for(var key in this.assets.off(),this.bundles.destroy(),this.bundles=null,this.i18n.destroy(),this.i18n=null,this.loader.getHandler("script")._cache){var element=this.loader.getHandler("script")._cache[key],parent=element.parentNode;parent&&parent.removeChild(element)}this.loader.getHandler("script")._cache={},this.loader.destroy(),this.loader=null,this.scene.destroy(),this.scene=null,this.systems=[],this.context=null,this.scripts.destroy(),this.scripts=null,this.scenes.destroy(),this.scenes=null,this.lightmapper.destroy(),this.lightmapper=null,this.batcher.destroyManager(),this.batcher=null,this._entityIndex={},this.defaultLayerDepth.onPreRenderOpaque=null,this.defaultLayerDepth.onPostRenderOpaque=null,this.defaultLayerDepth.onDisable=null,this.defaultLayerDepth.onEnable=null,this.defaultLayerDepth=null,this.defaultLayerWorld=null,destroyPostEffectQuad(),this.vr&&(this.vr.destroy(),this.vr=null),this.xr.end(),this.graphicsDevice.destroy(),this.graphicsDevice=null,this.renderer.destroy(),this.renderer=null,this.tick=null,this.off(),this._soundManager&&(this._soundManager.destroy(),this._soundManager=null),script.app=null,ParticleEmitter.DEFAULT_PARAM_TEXTURE=null,Application._applications[canvasId]=null,getApplication()===this&&setApplication(null)}},_proto2.getEntityFromIndex=function getEntityFromIndex(guid){return this._entityIndex[guid]},_createClass(Application,[{key:"fillMode",get:function get(){return this._fillMode}},{key:"resolutionMode",get:function get(){return this._resolutionMode}}]),Application}(EventHandler);Application._applications={};var _frameEndData={},makeTick=function makeTick(_app){var application=_app,frameRequest;return function(timestamp,frame){if(application.graphicsDevice){setApplication(application),frameRequest&&(window.cancelAnimationFrame(frameRequest),frameRequest=null),exports.app=application;var currentTime=application._processTimestamp(timestamp)||now(),ms=currentTime-(application._time||currentTime),dt=ms/1e3;dt=math.clamp(dt,0,application.maxDeltaTime),dt*=application.timeScale,application._time=currentTime,frameRequest=application.vr&&application.vr.display?application.vr.display.requestAnimationFrame(application.tick):application.xr.session?application.xr.session.requestAnimationFrame(application.tick):window.requestAnimationFrame(application.tick),application.graphicsDevice.contextLost||(application._fillFrameStatsBasic(currentTime,dt,ms),application._inFrameUpdate=!0,application.fire("frameupdate",ms),frame?(application.xr.update(frame),application.graphicsDevice.defaultFramebuffer=frame.session.renderState.baseLayer.framebuffer):application.graphicsDevice.defaultFramebuffer=null,application.update(dt),application.fire("framerender"),(application.autoRender||application.renderNextFrame)&&(application.updateCanvasSize(),application.render(),application.renderNextFrame=!1),_frameEndData.timestamp=now(),_frameEndData.target=application,application.fire("frameend",_frameEndData),application.fire("frameEnd",_frameEndData),application.vr&&application.vr.display&&application.vr.display.presenting&&application.vr.display.submitFrame(),application._inFrameUpdate=!1,application._destroyRequested&&application.destroy())}}},Entity=function(_GraphNode){function Entity(name,app){var _this;if(_this=_GraphNode.call(this,name)||this,name instanceof Application&&(app=name),_this._batchHandle=null,_this.c={},_this._app=app,!app&&(_this._app=Application.getApplication(),!_this._app))throw new Error("Couldn't find current application");return _this._guid=null,_this._destroying=!1,_this._template=!1,_this}_inheritsLoose(Entity,_GraphNode);var _proto=Entity.prototype;return _proto.addComponent=function addComponent(type,data){var system=this._app.systems[type];return system?this.c[type]?null:system.addComponent(this,data):null},_proto.removeComponent=function removeComponent(type){var system=this._app.systems[type];system&&this.c[type]&&system.removeComponent(this)},_proto.findComponent=function findComponent(type){var entity=this.findOne((function(node){return node.c&&node.c[type]}));return entity&&entity.c[type]},_proto.findComponents=function findComponents(type){var entities;return this.find((function(node){return node.c&&node.c[type]})).map((function(entity){return entity.c[type]}))},_proto.getGuid=function getGuid(){return this._guid||this.setGuid(guid.create()),this._guid},_proto.setGuid=function setGuid(guid){var index=this._app._entityIndex;this._guid&&delete index[this._guid],this._guid=guid,index[this._guid]=this},_proto._notifyHierarchyStateChanged=function _notifyHierarchyStateChanged(node,enabled){var enableFirst=!1,i,len;node===this&&0===this._app._enableList.length&&(enableFirst=!0),node._beingEnabled=!0,node._onHierarchyStateChanged(enabled),node._onHierarchyStatePostChanged&&this._app._enableList.push(node);var c=node._children;for(i=0,len=c.length;i<len;i++)c[i]._enabled&&this._notifyHierarchyStateChanged(c[i],enabled);if(node._beingEnabled=!1,enableFirst){for(i=0;i<this._app._enableList.length;i++)this._app._enableList[i]._onHierarchyStatePostChanged();this._app._enableList.length=0}},_proto._onHierarchyStateChanged=function _onHierarchyStateChanged(enabled){var component;_GraphNode.prototype._onHierarchyStateChanged.call(this,enabled);var components=this.c;for(var type in components)components.hasOwnProperty(type)&&(component=components[type]).enabled&&(enabled?component.onEnable():component.onDisable())},_proto._onHierarchyStatePostChanged=function _onHierarchyStatePostChanged(){var components=this.c;for(var type in components)components.hasOwnProperty(type)&&components[type].onPostStateChange()},_proto.findByGuid=function findByGuid(guid){if(this._guid===guid)return this;var e=this._app._entityIndex[guid];return e&&(e===this||e.isDescendantOf(this))?e:null},_proto.destroy=function destroy(){var name;for(name in this._destroying=!0,this.c)this.c[name].enabled=!1;for(name in this.c)this.c[name].system.removeComponent(this);this._parent&&this._parent.removeChild(this);for(var children=this._children,child=children.shift();child;)child instanceof Entity&&child.destroy(),child._parent=null,child=children.shift();this.fire("destroy",this),this.off(),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=!1},_proto.clone=function clone(){var duplicatedIdsMap={},clone=this._cloneRecursively(duplicatedIdsMap);return duplicatedIdsMap[this.getGuid()]=clone,resolveDuplicatedEntityReferenceProperties(this,this,clone,duplicatedIdsMap),clone},_proto._cloneRecursively=function _cloneRecursively(duplicatedIdsMap){var clone=new Entity(this._app),i;for(var type in _GraphNode.prototype._cloneInternal.call(this,clone),this.c){var component;this.c[type].system.cloneComponent(this,clone)}for(i=0;i<this._children.length;i++){var oldChild=this._children[i];if(oldChild instanceof Entity){var newChild=oldChild._cloneRecursively(duplicatedIdsMap);clone.addChild(newChild),duplicatedIdsMap[oldChild.getGuid()]=newChild}}return clone},Entity}(GraphNode);function resolveDuplicatedEntityReferenceProperties(oldSubtreeRoot,oldEntity,newEntity,duplicatedIdsMap){var i,len;if(oldEntity instanceof Entity){var components=oldEntity.c;for(var componentName in components){var component=components[componentName],entityProperties=component.system.getPropertiesOfType("entity");for(i=0,len=entityProperties.length;i<len;i++){var propertyDescriptor,propertyName=entityProperties[i].name,oldEntityReferenceId=component[propertyName],entityIsWithinOldSubtree;if(!!oldSubtreeRoot.findByGuid(oldEntityReferenceId)){var newEntityReferenceId=duplicatedIdsMap[oldEntityReferenceId].getGuid();newEntityReferenceId?newEntity.c[componentName][propertyName]=newEntityReferenceId:console.warn("Could not find corresponding entity id when resolving duplicated entity references")}}}components.script&&!newEntity._app.useLegacyScriptAttributeCloning&&newEntity.script.resolveDuplicatedEntityReferenceProperties(components.script,duplicatedIdsMap);var _old=oldEntity.children.filter((function(e){return e instanceof Entity})),_new=newEntity.children.filter((function(e){return e instanceof Entity}));for(i=0,len=_old.length;i<len;i++)resolveDuplicatedEntityReferenceProperties(oldSubtreeRoot,_old[i],_new[i],duplicatedIdsMap)}}var tempSet=new Set,clearDepthOptions={depth:1,flags:2},Picker=function(){function Picker(app,width,height){app instanceof GraphicsDevice&&(app=getApplication()),this.app=app,this.device=app.graphicsDevice,this.pickColor=new Float32Array(4),this.pickColor[3]=1,this.mapping=[],this.cameraEntity=null,this.layer=null,this.layerComp=null,this.initLayerComposition(),this._renderTarget=null;var device=this.device;this.clearDepthCommand=new Command(0,0,(function(){device.clear(clearDepthOptions)})),this.width=0,this.height=0,this.resize(width,height)}var _proto=Picker.prototype;return _proto.getSelection=function getSelection(x,y,width,height){var device=this.device;if("object"==typeof x){var rect=x;x=rect.x,y=rect.y,width=rect.width,height=rect.height}else y=this.renderTarget.height-(y+(height||1));x=Math.floor(x),y=Math.floor(y),width=Math.floor(Math.max(width||1,1)),height=Math.floor(Math.max(height||1,1));var origRenderTarget=device.renderTarget;device.setRenderTarget(this.renderTarget),device.updateBegin();var pixels=new Uint8Array(4*width*height);device.readPixels(x,y,width,height,pixels),device.updateEnd(),device.setRenderTarget(origRenderTarget);for(var mapping=this.mapping,i=0;i<width*height;i++){var r,g,b,index=pixels[4*i+0]<<16|pixels[4*i+1]<<8|pixels[4*i+2];16777215!==index&&tempSet.add(mapping[index])}var selection=[];return tempSet.forEach((function(meshInstance){return selection.push(meshInstance)})),tempSet.clear(),selection},_proto.allocateRenderTarget=function allocateRenderTarget(){var colorBuffer=new Texture(this.device,{format:7,width:this.width,height:this.height,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});colorBuffer.name="pick",this.renderTarget=new RenderTarget({colorBuffer:colorBuffer,depth:!0})},_proto.releaseRenderTarget=function releaseRenderTarget(){this.cameraEntity.camera.renderTarget=null,this._renderTarget&&(this._renderTarget._colorBuffer.destroy(),this._renderTarget.destroy(),this._renderTarget=null)},_proto.initLayerComposition=function initLayerComposition(){var device=this.device,self=this,pickColorId=device.scope.resolve("uColor");this.cameraEntity=new Entity,this.cameraEntity.addComponent("camera"),this.layer=new Layer({name:"Picker",shaderPass:18,opaqueSortMode:0,onDrawCall:function onDrawCall(meshInstance,index){self.pickColor[0]=(index>>16&255)/255,self.pickColor[1]=(index>>8&255)/255,self.pickColor[2]=(255&index)/255,pickColorId.setValue(self.pickColor),device.setBlending(!1),self.mapping[index]=meshInstance}}),this.layer.addCamera(this.cameraEntity.camera),this.layerComp=new LayerComposition("picker"),this.layerComp.pushOpaque(this.layer)},_proto.prepare=function prepare(camera,scene,layers){camera instanceof Camera&&(camera=camera.node.camera),layers instanceof Layer&&(layers=[layers]),this.layer.clearMeshInstances();for(var destMeshInstances=this.layer.opaqueMeshInstances,srcLayers=scene.layers.layerList,subLayerEnabled=scene.layers.subLayerEnabled,isTransparent=scene.layers.subLayerList,i=0;i<srcLayers.length;i++){var srcLayer=srcLayers[i],layerCamId;if(!(layers&&layers.indexOf(srcLayer)<0))if(srcLayer.enabled&&subLayerEnabled[i])if(srcLayer.cameras.indexOf(camera)>=0){srcLayer._clearDepthBuffer&&destMeshInstances.push(this.clearDepthCommand);for(var meshInstances=isTransparent[i]?srcLayer.instances.transparentMeshInstances:srcLayer.instances.opaqueMeshInstances,j=0;j<meshInstances.length;j++){var meshInstance=meshInstances[j];meshInstance.pick&&destMeshInstances.push(meshInstance)}}}this.renderTarget&&this.width===this.renderTarget.width&&this.height===this.renderTarget.height||(this.releaseRenderTarget(),this.allocateRenderTarget()),this.updateCamera(camera),this.mapping.length=0,this.app.renderer.renderComposition(this.layerComp)},_proto.updateCamera=function updateCamera(srcCamera){this.cameraEntity.copy(srcCamera.entity),this.cameraEntity.name="PickerCamera";var destCamera=this.cameraEntity.camera;destCamera.copy(srcCamera),destCamera.clearColorBuffer=!0,destCamera.clearDepthBuffer=!0,destCamera.clearStencilBuffer=!0,destCamera.clearColor=Color.WHITE,destCamera.renderTarget=this.renderTarget,this.layer.clearCameras(),this.layer.addCamera(destCamera),destCamera.layers=[this.layer.id]},_proto.resize=function resize(width,height){this.width=Math.floor(width),this.height=Math.floor(height)},Picker}(),MAX_TEXTURE_SIZE=4096,DEFAULT_TEXTURE_SIZE=512,CanvasFont=function(_EventHandler){function CanvasFont(app,options){var _this;void 0===options&&(options={}),(_this=_EventHandler.call(this)||this).type="bitmap",_this.app=app,_this.intensity=0,_this.fontWeight=options.fontWeight||"normal",_this.fontSize=parseInt(options.fontSize,10),_this.glyphSize=_this.fontSize,_this.fontName=options.fontName||"Arial",_this.color=options.color||new Color(1,1,1),_this.padding=options.padding||0;var w=options.width>4096?4096:options.width||512,h=options.height>4096?4096:options.height||512,canvas=document.createElement("canvas");canvas.height=h,canvas.width=w;var texture=new Texture(_this.app.graphicsDevice,{format:7,autoMipmap:!0});return texture.name="font",texture.setSource(canvas),texture.minFilter=5,texture.magFilter=1,texture.addressU=1,texture.addressV=1,_this.textures=[texture],_this.chars="",_this.data={},_this}_inheritsLoose(CanvasFont,_EventHandler);var _proto=CanvasFont.prototype;return _proto.createTextures=function createTextures(text){var _chars=this._normalizeCharsSet(text);if(_chars.length===this.chars.length){for(var i=0;i<_chars.length;i++)if(_chars[i]!==this.chars[i])return void this._renderAtlas(_chars)}else this._renderAtlas(_chars)},_proto.updateTextures=function updateTextures(text){for(var _chars=this._normalizeCharsSet(text),newCharsSet=[],i=0;i<_chars.length;i++){var char=_chars[i];this.data.chars[char]||newCharsSet.push(char)}newCharsSet.length>0&&this._renderAtlas(this.chars.concat(newCharsSet))},_proto.destroy=function destroy(){for(var i=0;i<this.textures.length;i++)this.textures[i].destroy();this.chars=null,this.color=null,this.data=null,this.fontName=null,this.fontSize=null,this.glyphSize=null,this.intensity=null,this.textures=null,this.type=null,this.fontWeight=null},_proto._getAndClearContext=function _getAndClearContext(canvas,clearColor){var w=canvas.width,h=canvas.height,ctx=canvas.getContext("2d",{alpha:!0});return ctx.clearRect(0,0,w,h),ctx.fillStyle=clearColor,ctx.fillRect(0,0,w,h),ctx},_proto._colorToRgbString=function _colorToRgbString(color,alpha){var str,r=Math.round(255*color.r),g=Math.round(255*color.g),b=Math.round(255*color.b);return str=alpha?"rgba("+r+", "+g+", "+b+", "+color.a+")":"rgb("+r+", "+g+", "+b+")"},_proto.renderCharacter=function renderCharacter(context,char,x,y,color){context.fillStyle=color,context.fillText(char,x,y)},_proto._renderAtlas=function _renderAtlas(charsArray){this.chars=charsArray;var numTextures=1,canvas=this.textures[numTextures-1].getSource(),w=canvas.width,h=canvas.height,color=this._colorToRgbString(this.color,!1),a=this.color.a;this.color.a=1/255;var transparent=this._colorToRgbString(this.color,!0);this.color.a=a;var TEXT_ALIGN="center",TEXT_BASELINE="alphabetic",ctx=this._getAndClearContext(canvas,transparent);ctx.font=this.fontWeight+" "+this.fontSize.toString()+"px "+this.fontName,ctx.textAlign="center",ctx.textBaseline="alphabetic",this.data=this._createJson(this.chars,this.fontName,w,h);var symbols=string.getSymbols(this.chars.join("")),prevNumTextures=this.textures.length,maxHeight=0,maxDescent=0,metrics={},i,ch;for(i=0;i<symbols.length;i++)metrics[ch=symbols[i]]=this._getTextMetrics(ch),maxHeight=Math.max(maxHeight,metrics[ch].height),maxDescent=Math.max(maxDescent,metrics[ch].descent);this.glyphSize=Math.max(this.glyphSize,maxHeight);var sx=this.glyphSize+2*this.padding,sy=this.glyphSize+2*this.padding,_xOffset=this.glyphSize/2+this.padding,_yOffset=sy-maxDescent-this.padding,_x=0,_y=0;for(i=0;i<symbols.length;i++){ch=symbols[i];var code=string.getCodePoint(symbols[i]),fs=this.fontSize;ctx.font=this.fontWeight+" "+fs.toString()+"px "+this.fontName,ctx.textAlign="center",ctx.textBaseline="alphabetic";var width=ctx.measureText(ch).width;width>fs&&(fs=this.fontSize*this.fontSize/width,ctx.font=this.fontWeight+" "+fs.toString()+"px "+this.fontName,width=this.fontSize),this.renderCharacter(ctx,ch,_x+_xOffset,_y+_yOffset,color);var xoffset=this.padding+(this.glyphSize-width)/2,yoffset=-this.padding+metrics[ch].descent-maxDescent,xadvance=width;if(this._addChar(this.data,ch,code,_x,_y,sx,sy,xoffset,yoffset,xadvance,numTextures-1,w,h),(_x+=sx)+sx>w&&(_x=0,(_y+=sy)+sy>h))if(this.textures[numTextures-1].upload(),_y=0,++numTextures>prevNumTextures){(canvas=document.createElement("canvas")).height=h,canvas.width=w,ctx=this._getAndClearContext(canvas,transparent);var texture=new Texture(this.app.graphicsDevice,{format:7,autoMipmap:!0});texture.name="font-atlas",texture.setSource(canvas),texture.minFilter=5,texture.magFilter=1,texture.addressU=1,texture.addressV=1,this.textures.push(texture)}else canvas=this.textures[numTextures-1].getSource(),ctx=this._getAndClearContext(canvas,transparent)}if(this.textures[numTextures-1].upload(),numTextures<prevNumTextures){for(i=numTextures;i<prevNumTextures;i++)this.textures[i].destroy();this.textures.splice(numTextures)}this.fire("render")},_proto._createJson=function _createJson(chars,fontName,width,height){var base;return{version:3,intensity:this.intensity,info:{face:fontName,width:width,height:height,maps:[{width:width,height:height}]},chars:{}}},_proto._addChar=function _addChar(json,char,charCode,x,y,w,h,xoffset,yoffset,xadvance,mapNum,mapW,mapH){json.info.maps.length<mapNum+1&&json.info.maps.push({width:mapW,height:mapH});var scale=this.fontSize/32;json.chars[char]={id:charCode,letter:char,x:x,y:y,width:w,height:h,xadvance:xadvance/scale,xoffset:xoffset/scale,yoffset:(yoffset+this.padding)/scale,scale:scale,range:1,map:mapNum,bounds:[0,0,w/scale,h/scale]}},_proto._normalizeCharsSet=function _normalizeCharsSet(text){var unicodeConverterFunc=this.app.systems.element.getUnicodeConverter();unicodeConverterFunc&&(text=unicodeConverterFunc(text));var set={},symbols=string.getSymbols(text),i,chars;for(i=0;i<symbols.length;i++){var ch=symbols[i];set[ch]||(set[ch]=ch)}return Object.keys(set).sort()},_proto._getTextMetrics=function _getTextMetrics(text){var textSpan=document.createElement("span");textSpan.id="content-span",textSpan.innerHTML=text;var block=document.createElement("div");block.id="content-block",block.style.display="inline-block",block.style.width="1px",block.style.height="0px";var div=document.createElement("div"),body;div.appendChild(textSpan),div.appendChild(block),div.style.font=this.fontSize+"px "+this.fontName,document.body.appendChild(div);var ascent=-1,descent=-1,height=-1;try{block.style["vertical-align"]="baseline",ascent=block.offsetTop-textSpan.offsetTop,block.style["vertical-align"]="bottom",descent=(height=block.offsetTop-textSpan.offsetTop)-ascent}finally{document.body.removeChild(div)}return{ascent:ascent,descent:descent,height:height}},CanvasFont}(EventHandler),ResourceHandler=function(){function ResourceHandler(){}var _proto=ResourceHandler.prototype;return _proto.load=function load(url,callback,asset){throw new Error("not implemented")},_proto.open=function open(url,data,asset){throw new Error("not implemented")},_proto.patch=function patch(asset,assets){},ResourceHandler}(),SceneSettingsHandler=function(){function SceneSettingsHandler(app){this._app=app,this.maxRetries=0}var _proto=SceneSettingsHandler.prototype;return _proto.load=function load(url,callback){SceneUtils.load(url,callback)},_proto.open=function open(url,data){return data.settings},SceneSettingsHandler}(),AssetListLoader=function(_EventHandler){function AssetListLoader(assetList,assetRegistry){var _this;if((_this=_EventHandler.call(this)||this)._assets=[],_this._registry=assetRegistry,_this._loaded=!1,_this._count=0,_this._total=0,_this._failed=[],_this._waitingAssets=[],assetList.length&&assetList[0]instanceof Asset)_this._assets=assetList;else for(var i=0;i<assetList.length;i++){var asset=assetRegistry.get(assetList[i]);asset?_this._assets.push(asset):(_this._waitForAsset(assetList[i]),_this._total++)}return _this}_inheritsLoose(AssetListLoader,_EventHandler);var _proto=AssetListLoader.prototype;return _proto.destroy=function destroy(){var self=this;this._registry.off("load",this._onLoad),this._registry.off("error",this._onError),this._waitingAssets.forEach((function(id){self._registry.off("add:"+id,this._onAddAsset)})),this.off("progress"),this.off("load")},_proto.load=function load(done,scope){var i=0,l=this._assets.length,asset;for(this._count=0,this._failed=[],this._callback=done,this._scope=scope,this._registry.on("load",this._onLoad,this),this._registry.on("error",this._onError,this),i=0;i<l;i++)(asset=this._assets[i]).loading||asset.loaded||(this._registry.load(asset),this._total++)},_proto.ready=function ready(done,scope){scope=scope||this,this._loaded?done.call(scope,this._assets):this.once("load",(function(assets){done.call(scope,assets)}))},_proto._loadingComplete=function _loadingComplete(){this._loaded=!0,this._registry.off("load",this._onLoad,this),this._registry.off("error",this._onError,this),this._failed&&this._failed.length?(this._callback&&this._callback.call(this._scope,"Failed to load some assets",this._failed),this.fire("error",this._failed)):(this._callback&&this._callback.call(this._scope),this.fire("load",this._assets))},_proto._onLoad=function _onLoad(asset){var self=this;this._assets.indexOf(asset)>=0&&(this._count++,this.fire("progress",asset)),this._count===this._total&&setTimeout((function(){self._loadingComplete(self._failed)}),0)},_proto._onError=function _onError(err,asset){var self=this;this._assets.indexOf(asset)>=0&&(this._count++,this._failed.push(asset)),this._count===this._total&&setTimeout((function(){self._loadingComplete(self._failed)}),0)},_proto._onAddAsset=function _onAddAsset(asset){var index=this._waitingAssets.indexOf(asset),i;index>=0&&this._waitingAssets.splice(index,1),this._assets.push(asset);var l=this._assets.length;for(i=0;i<l;i++)(asset=this._assets[i]).loading||asset.loaded||this._registry.load(asset)},_proto._waitForAsset=function _waitForAsset(assetId){this._waitingAssets.push(assetId),this._registry.once("add:"+assetId,this._onAddAsset,this)},AssetListLoader}(EventHandler),funcNameRegex=new RegExp("^\\s*function(?:\\s|\\s*\\/\\*.*\\*\\/\\s*)+([^\\(\\s\\/]*)\\s*"),ScriptType=function(_EventHandler){function ScriptType(args){var _this;return(_this=_EventHandler.call(this)||this).initScriptType(args),_this}_inheritsLoose(ScriptType,_EventHandler);var _proto=ScriptType.prototype;return _proto.initScriptType=function initScriptType(args){var script=this.constructor;this.app=args.app,this.entity=args.entity,this._enabled="boolean"!=typeof args.enabled||args.enabled,this._enabledOld=this.enabled,this.__destroyed=!1,this.__attributes={},this.__attributesRaw=args.attributes||{},this.__scriptType=script,this.__executionOrder=-1},ScriptType.__getScriptName=function __getScriptName(constructorFn){if("function"==typeof constructorFn){if("name"in Function.prototype)return constructorFn.name;if(constructorFn===Function||constructorFn===Function.prototype.constructor)return"Function";var match=(""+constructorFn).match(funcNameRegex);return match?match[1]:void 0}},_proto.__initializeAttributes=function __initializeAttributes(force){if(force||this.__attributesRaw){for(var key in this.__scriptType.attributes.index)this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(key)?this[key]=this.__attributesRaw[key]:this.__attributes.hasOwnProperty(key)||(this.__scriptType.attributes.index[key].hasOwnProperty("default")?this[key]=this.__scriptType.attributes.index[key].default:this[key]=null);this.__attributesRaw=null}},ScriptType.extend=function extend(methods){for(var key in methods)methods.hasOwnProperty(key)&&(this.prototype[key]=methods[key])},_createClass(ScriptType,[{key:"enabled",get:function get(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled},set:function set(value){this._enabled=!!value,this.enabled!==this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=!0,this.__initializeAttributes(!0),this.initialize&&this.entity.script._scriptMethod(this,ScriptComponent.scriptMethods.initialize)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=!0,this.postInitialize&&this.entity.script._scriptMethod(this,ScriptComponent.scriptMethods.postInitialize)))}}],[{key:"scriptName",get:function get(){return this.__name}},{key:"attributes",get:function get(){return this.hasOwnProperty("__attributes")||(this.__attributes=new ScriptAttributes(this)),this.__attributes}}]),ScriptType}(EventHandler);ScriptType.__name=null;var reservedScriptNames=new Set(["system","entity","create","destroy","swap","move","scripts","_scripts","_scriptsIndex","_scriptsData","enabled","_oldState","onEnable","onDisable","onPostStateChange","_onSetEnabled","_checkState","_onBeforeRemove","_onInitializeAttributes","_onInitialize","_onPostInitialize","_onUpdate","_onPostUpdate","_callbacks","has","get","on","off","fire","once","hasEvent"]);function createScript(name,app){if(script.legacy)return null;if(reservedScriptNames.has(name))throw new Error("script name: '"+name+"' is reserved, please change script name");var scriptType=function scriptType(args){EventHandler.prototype.initEventHandler.call(this),ScriptType.prototype.initScriptType.call(this,args)};return(scriptType.prototype=Object.create(ScriptType.prototype)).constructor=scriptType,scriptType.extend=ScriptType.extend,scriptType.attributes=new ScriptAttributes(scriptType),registerScript(scriptType,name,app),scriptType}var reservedAttributes={};function registerScript(script,name,app){if(!script.legacy){if("function"!=typeof script)throw new Error("script class: '"+script+"' must be a constructor function (i.e. class).");if(!(script.prototype instanceof ScriptType))throw new Error("script class: '"+ScriptType.__getScriptName(script)+"' does not extend pc.ScriptType.");if(name=name||script.__name||ScriptType.__getScriptName(script),reservedScriptNames.has(name))throw new Error("script name: '"+name+"' is reserved, please change script name");var registry;script.__name=name,(app?app.scripts:Application.getApplication().scripts).add(script),ScriptHandler._push(script)}}ScriptAttributes.reservedNames.forEach((function(value,value2,set){reservedAttributes[value]=1})),createScript.reservedAttributes=reservedAttributes;var ACTION_MOUSE="mouse",ACTION_KEYBOARD="keyboard",ACTION_GAMEPAD="gamepad",AXIS_MOUSE_X="mousex",AXIS_MOUSE_Y="mousey",AXIS_PAD_L_X="padlx",AXIS_PAD_L_Y="padly",AXIS_PAD_R_X="padrx",AXIS_PAD_R_Y="padry",AXIS_KEY="key",EVENT_KEYDOWN="keydown",EVENT_KEYUP="keyup",EVENT_MOUSEDOWN="mousedown",EVENT_MOUSEMOVE="mousemove",EVENT_MOUSEUP="mouseup",EVENT_MOUSEWHEEL="mousewheel",EVENT_TOUCHSTART="touchstart",EVENT_TOUCHEND="touchend",EVENT_TOUCHMOVE="touchmove",EVENT_TOUCHCANCEL="touchcancel",EVENT_SELECT="select",EVENT_SELECTSTART="selectstart",EVENT_SELECTEND="selectend",KEY_BACKSPACE=8,KEY_TAB=9,KEY_RETURN=13,KEY_ENTER=13,KEY_SHIFT=16,KEY_CONTROL=17,KEY_ALT=18,KEY_PAUSE=19,KEY_CAPS_LOCK=20,KEY_ESCAPE=27,KEY_SPACE=32,KEY_PAGE_UP=33,KEY_PAGE_DOWN=34,KEY_END=35,KEY_HOME=36,KEY_LEFT=37,KEY_UP=38,KEY_RIGHT=39,KEY_DOWN=40,KEY_PRINT_SCREEN=44,KEY_INSERT=45,KEY_DELETE=46,KEY_0=48,KEY_1=49,KEY_2=50,KEY_3=51,KEY_4=52,KEY_5=53,KEY_6=54,KEY_7=55,KEY_8=56,KEY_9=57,KEY_SEMICOLON=59,KEY_EQUAL=61,KEY_A=65,KEY_B=66,KEY_C=67,KEY_D=68,KEY_E=69,KEY_F=70,KEY_G=71,KEY_H=72,KEY_I=73,KEY_J=74,KEY_K=75,KEY_L=76,KEY_M=77,KEY_N=78,KEY_O=79,KEY_P=80,KEY_Q=81,KEY_R=82,KEY_S=83,KEY_T=84,KEY_U=85,KEY_V=86,KEY_W=87,KEY_X=88,KEY_Y=89,KEY_Z=90,KEY_WINDOWS=91,KEY_CONTEXT_MENU=93,KEY_NUMPAD_0=96,KEY_NUMPAD_1=97,KEY_NUMPAD_2=98,KEY_NUMPAD_3=99,KEY_NUMPAD_4=100,KEY_NUMPAD_5=101,KEY_NUMPAD_6=102,KEY_NUMPAD_7=103,KEY_NUMPAD_8=104,KEY_NUMPAD_9=105,KEY_MULTIPLY=106,KEY_ADD=107,KEY_SEPARATOR=108,KEY_SUBTRACT=109,KEY_DECIMAL=110,KEY_DIVIDE=111,KEY_F1=112,KEY_F2=113,KEY_F3=114,KEY_F4=115,KEY_F5=116,KEY_F6=117,KEY_F7=118,KEY_F8=119,KEY_F9=120,KEY_F10=121,KEY_F11=122,KEY_F12=123,KEY_COMMA=188,KEY_PERIOD=190,KEY_SLASH=191,KEY_OPEN_BRACKET=219,KEY_BACK_SLASH=220,KEY_CLOSE_BRACKET=221,KEY_META=224,MOUSEBUTTON_NONE=-1,MOUSEBUTTON_LEFT=0,MOUSEBUTTON_MIDDLE=1,MOUSEBUTTON_RIGHT=2,PAD_1=0,PAD_2=1,PAD_3=2,PAD_4=3,PAD_FACE_1=0,PAD_FACE_2=1,PAD_FACE_3=2,PAD_FACE_4=3,PAD_L_SHOULDER_1=4,PAD_R_SHOULDER_1=5,PAD_L_SHOULDER_2=6,PAD_R_SHOULDER_2=7,PAD_SELECT=8,PAD_START=9,PAD_L_STICK_BUTTON=10,PAD_R_STICK_BUTTON=11,PAD_UP=12,PAD_DOWN=13,PAD_LEFT=14,PAD_RIGHT=15,PAD_VENDOR=16,PAD_L_STICK_X=0,PAD_L_STICK_Y=1,PAD_R_STICK_X=2,PAD_R_STICK_Y=3,KeyboardEvent=function KeyboardEvent(keyboard,event){event?(this.key=event.keyCode,this.element=event.target,this.event=event):(this.key=null,this.element=null,this.event=null)},_keyboardEvent=new KeyboardEvent;function makeKeyboardEvent(event){return _keyboardEvent.key=event.keyCode,_keyboardEvent.element=event.target,_keyboardEvent.event=event,_keyboardEvent}function toKeyCode(s){return"string"==typeof s?s.toUpperCase().charCodeAt(0):s}var _keyCodeToKeyIdentifier={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"},Keyboard=function(_EventHandler){function Keyboard(element,options){var _this;return void 0===options&&(options={}),(_this=_EventHandler.call(this)||this)._element=null,_this._keyDownHandler=_this._handleKeyDown.bind(_assertThisInitialized(_this)),_this._keyUpHandler=_this._handleKeyUp.bind(_assertThisInitialized(_this)),_this._keyPressHandler=_this._handleKeyPress.bind(_assertThisInitialized(_this)),_this._visibilityChangeHandler=_this._handleVisibilityChange.bind(_assertThisInitialized(_this)),_this._windowBlurHandler=_this._handleWindowBlur.bind(_assertThisInitialized(_this)),_this._keymap={},_this._lastmap={},element&&_this.attach(element),_this.preventDefault=options.preventDefault||!1,_this.stopPropagation=options.stopPropagation||!1,_this}_inheritsLoose(Keyboard,_EventHandler);var _proto=Keyboard.prototype;return _proto.attach=function attach(element){this._element&&this.detach(),this._element=element,this._element.addEventListener("keydown",this._keyDownHandler,!1),this._element.addEventListener("keypress",this._keyPressHandler,!1),this._element.addEventListener("keyup",this._keyUpHandler,!1),document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.addEventListener("blur",this._windowBlurHandler,!1)},_proto.detach=function detach(){this._element.removeEventListener("keydown",this._keyDownHandler),this._element.removeEventListener("keypress",this._keyPressHandler),this._element.removeEventListener("keyup",this._keyUpHandler),this._element=null,document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.removeEventListener("blur",this._windowBlurHandler,!1)},_proto.toKeyIdentifier=function toKeyIdentifier(keyCode){var count,hex,length;keyCode=toKeyCode(keyCode);var id=_keyCodeToKeyIdentifier[keyCode.toString()];if(id)return id;for(length=(hex=keyCode.toString(16).toUpperCase()).length,count=0;count<4-length;count++)hex="0"+hex;return"U+"+hex},_proto._handleKeyDown=function _handleKeyDown(event){var code=event.keyCode||event.charCode;if(void 0!==code){var id=this.toKeyIdentifier(code);this._keymap[id]=!0,this.fire("keydown",makeKeyboardEvent(event)),this.preventDefault&&event.preventDefault(),this.stopPropagation&&event.stopPropagation()}},_proto._handleKeyUp=function _handleKeyUp(event){var code=event.keyCode||event.charCode;if(void 0!==code){var id=this.toKeyIdentifier(code);delete this._keymap[id],this.fire("keyup",makeKeyboardEvent(event)),this.preventDefault&&event.preventDefault(),this.stopPropagation&&event.stopPropagation()}},_proto._handleKeyPress=function _handleKeyPress(event){this.fire("keypress",makeKeyboardEvent(event)),this.preventDefault&&event.preventDefault(),this.stopPropagation&&event.stopPropagation()},_proto._handleVisibilityChange=function _handleVisibilityChange(){"hidden"===document.visibilityState&&this._handleWindowBlur()},_proto._handleWindowBlur=function _handleWindowBlur(){this._keymap={},this._lastmap={}},_proto.update=function update(){var prop;for(prop in this._lastmap)delete this._lastmap[prop];for(prop in this._keymap)this._keymap.hasOwnProperty(prop)&&(this._lastmap[prop]=this._keymap[prop])},_proto.isPressed=function isPressed(key){var keyCode=toKeyCode(key),id=this.toKeyIdentifier(keyCode);return!!this._keymap[id]},_proto.wasPressed=function wasPressed(key){var keyCode=toKeyCode(key),id=this.toKeyIdentifier(keyCode);return!!this._keymap[id]&&!this._lastmap[id]},_proto.wasReleased=function wasReleased(key){var keyCode=toKeyCode(key),id=this.toKeyIdentifier(keyCode);return!this._keymap[id]&&!!this._lastmap[id]},Keyboard}(EventHandler);function isMousePointerLocked(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)}var MouseEvent=function MouseEvent(mouse,event){var coords={x:0,y:0};if(event){if(event instanceof MouseEvent)throw Error("Expected MouseEvent");coords=mouse._getTargetCoords(event)}else event={};if(coords)this.x=coords.x,this.y=coords.y;else{if(!isMousePointerLocked())return;this.x=0,this.y=0}this.wheelDelta=0,"wheel"===event.type&&(event.deltaY>0?this.wheelDelta=1:event.deltaY<0&&(this.wheelDelta=-1)),isMousePointerLocked()?(this.dx=event.movementX||event.webkitMovementX||event.mozMovementX||0,this.dy=event.movementY||event.webkitMovementY||event.mozMovementY||0):(this.dx=this.x-mouse._lastX,this.dy=this.y-mouse._lastY),"mousedown"===event.type||"mouseup"===event.type?this.button=event.button:this.button=-1,this.buttons=mouse._buttons.slice(0),this.element=event.target,this.ctrlKey=event.ctrlKey||!1,this.altKey=event.altKey||!1,this.shiftKey=event.shiftKey||!1,this.metaKey=event.metaKey||!1,this.event=event},Mouse=function(_EventHandler){function Mouse(element){var _this;return(_this=_EventHandler.call(this)||this)._lastX=0,_this._lastY=0,_this._buttons=[!1,!1,!1],_this._lastbuttons=[!1,!1,!1],_this._upHandler=_this._handleUp.bind(_assertThisInitialized(_this)),_this._downHandler=_this._handleDown.bind(_assertThisInitialized(_this)),_this._moveHandler=_this._handleMove.bind(_assertThisInitialized(_this)),_this._wheelHandler=_this._handleWheel.bind(_assertThisInitialized(_this)),_this._contextMenuHandler=function(event){event.preventDefault()},_this._target=null,_this._attached=!1,_this.attach(element),_this}_inheritsLoose(Mouse,_EventHandler),Mouse.isPointerLocked=function isPointerLocked(){return isMousePointerLocked()};var _proto=Mouse.prototype;return _proto.attach=function attach(element){if(this._target=element,!this._attached){this._attached=!0;var opts=!!platform.passiveEvents&&{passive:!1};window.addEventListener("mouseup",this._upHandler,opts),window.addEventListener("mousedown",this._downHandler,opts),window.addEventListener("mousemove",this._moveHandler,opts),window.addEventListener("wheel",this._wheelHandler,opts)}},_proto.detach=function detach(){if(this._attached){this._attached=!1,this._target=null;var opts=!!platform.passiveEvents&&{passive:!1};window.removeEventListener("mouseup",this._upHandler,opts),window.removeEventListener("mousedown",this._downHandler,opts),window.removeEventListener("mousemove",this._moveHandler,opts),window.removeEventListener("wheel",this._wheelHandler,opts)}},_proto.disableContextMenu=function disableContextMenu(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)},_proto.enableContextMenu=function enableContextMenu(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)},_proto.enablePointerLock=function enablePointerLock(success,error){if(document.body.requestPointerLock){var s=function s(){success(),document.removeEventListener("pointerlockchange",s)},e=function e(){error(),document.removeEventListener("pointerlockerror",e)};success&&document.addEventListener("pointerlockchange",s,!1),error&&document.addEventListener("pointerlockerror",e,!1),document.body.requestPointerLock()}else error&&error()},_proto.disablePointerLock=function disablePointerLock(success){if(document.exitPointerLock){var s=function s(){success(),document.removeEventListener("pointerlockchange",s)};success&&document.addEventListener("pointerlockchange",s,!1),document.exitPointerLock()}},_proto.update=function update(){this._lastbuttons[0]=this._buttons[0],this._lastbuttons[1]=this._buttons[1],this._lastbuttons[2]=this._buttons[2]},_proto.isPressed=function isPressed(button){return this._buttons[button]},_proto.wasPressed=function wasPressed(button){return this._buttons[button]&&!this._lastbuttons[button]},_proto.wasReleased=function wasReleased(button){return!this._buttons[button]&&this._lastbuttons[button]},_proto._handleUp=function _handleUp(event){this._buttons[event.button]=!1;var e=new MouseEvent(this,event);e.event&&this.fire("mouseup",e)},_proto._handleDown=function _handleDown(event){this._buttons[event.button]=!0;var e=new MouseEvent(this,event);e.event&&this.fire("mousedown",e)},_proto._handleMove=function _handleMove(event){var e=new MouseEvent(this,event);e.event&&(this.fire("mousemove",e),this._lastX=e.x,this._lastY=e.y)},_proto._handleWheel=function _handleWheel(event){var e=new MouseEvent(this,event);e.event&&this.fire("mousewheel",e)},_proto._getTargetCoords=function _getTargetCoords(event){var rect=this._target.getBoundingClientRect(),left=Math.floor(rect.left),top=Math.floor(rect.top);return event.clientX<left||event.clientX>=left+this._target.clientWidth||event.clientY<top||event.clientY>=top+this._target.clientHeight?null:{x:event.clientX-left,y:event.clientY-top}},Mouse}(EventHandler),Controller=function(){function Controller(element,options){void 0===options&&(options={}),this._keyboard=options.keyboard||null,this._mouse=options.mouse||null,this._gamepads=options.gamepads||null,this._element=null,this._actions={},this._axes={},this._axesValues={},element&&this.attach(element)}var _proto=Controller.prototype;return _proto.attach=function attach(element){this._element=element,this._keyboard&&this._keyboard.attach(element),this._mouse&&this._mouse.attach(element)},_proto.detach=function detach(){this._keyboard&&this._keyboard.detach(),this._mouse&&this._mouse.detach(),this._element=null},_proto.disableContextMenu=function disableContextMenu(){this._mouse||this._enableMouse(),this._mouse.disableContextMenu()},_proto.enableContextMenu=function enableContextMenu(){this._mouse||this._enableMouse(),this._mouse.enableContextMenu()},_proto.update=function update(dt){for(var key in this._keyboard&&this._keyboard.update(dt),this._mouse&&this._mouse.update(dt),this._gamepads&&this._gamepads.update(dt),this._axesValues={},this._axes)this._axesValues[key]=[]},_proto.registerKeys=function registerKeys(action,keys){if(this._keyboard||this._enableKeyboard(),this._actions[action])throw new Error("Action: "+action+" already registered");if(void 0===keys)throw new Error("Invalid button");keys.length||(keys=[keys]),this._actions[action]?this._actions[action].push({type:"keyboard",keys:keys}):this._actions[action]=[{type:"keyboard",keys:keys}]},_proto.registerMouse=function registerMouse(action,button){if(this._mouse||this._enableMouse(),void 0===button)throw new Error("Invalid button");this._actions[action]?this._actions[action].push({type:"mouse",button:button}):this._actions[action]=[{type:"mouse",button:-button}]},_proto.registerPadButton=function registerPadButton(action,pad,button){if(void 0===button)throw new Error("Invalid button");this._actions[action]?this._actions[action].push({type:"gamepad",button:button,pad:pad}):this._actions[action]=[{type:"gamepad",button:button,pad:pad}]},_proto.registerAxis=function registerAxis(options){var name=options.name;this._axes[name]||(this._axes[name]=[]);var i=this._axes[name].push(name);(options=options||{}).pad=options.pad||0;var bind=function bind(controller,source,value,key){switch(source){case"mousex":controller._mouse.on("mousemove",(function(e){controller._axesValues[name][i]=e.dx/10}));break;case"mousey":controller._mouse.on("mousemove",(function(e){controller._axesValues[name][i]=e.dy/10}));break;case"key":controller._axes[name].push((function(){return controller._keyboard.isPressed(key)?value:0}));break;case"padrx":controller._axes[name].push((function(){return controller._gamepads.getAxis(options.pad,2)}));break;case"padry":controller._axes[name].push((function(){return controller._gamepads.getAxis(options.pad,3)}));break;case"padlx":controller._axes[name].push((function(){return controller._gamepads.getAxis(options.pad,0)}));break;case"padly":controller._axes[name].push((function(){return controller._gamepads.getAxis(options.pad,1)}));break;default:throw new Error("Unknown axis")}};bind(this,options.positive,1,options.positiveKey),(options.negativeKey||options.negative!==options.positive)&&bind(this,options.negative,-1,options.negativeKey)},_proto.isPressed=function isPressed(actionName){if(!this._actions[actionName])return!1;var action,index=0,length=this._actions[actionName].length;for(index=0;index<length;++index)switch((action=this._actions[actionName][index]).type){case"keyboard":if(this._keyboard){var i,len=action.keys.length;for(i=0;i<len;i++)if(this._keyboard.isPressed(action.keys[i]))return!0}break;case"mouse":if(this._mouse&&this._mouse.isPressed(action.button))return!0;break;case"gamepad":if(this._gamepads&&this._gamepads.isPressed(action.pad,action.button))return!0}return!1},_proto.wasPressed=function wasPressed(actionName){if(!this._actions[actionName])return!1;var index=0,length=this._actions[actionName].length;for(index=0;index<length;++index){var action=this._actions[actionName][index];switch(action.type){case"keyboard":if(this._keyboard){var i,len=action.keys.length;for(i=0;i<len;i++)if(this._keyboard.wasPressed(action.keys[i]))return!0}break;case"mouse":if(this._mouse&&this._mouse.wasPressed(action.button))return!0;break;case"gamepad":if(this._gamepads&&this._gamepads.wasPressed(action.pad,action.button))return!0}}return!1},_proto.getAxis=function getAxis(name){var value=0;if(this._axes[name]){var i,len=this._axes[name].length;for(i=0;i<len;i++)if("function"===type$1(this._axes[name][i])){var v=this._axes[name][i]();Math.abs(v)>Math.abs(value)&&(value=v)}else this._axesValues[name]&&Math.abs(this._axesValues[name][i])>Math.abs(value)&&(value=this._axesValues[name][i])}return value},_proto._enableMouse=function _enableMouse(){if(this._mouse=new Mouse,!this._element)throw new Error("Controller must be attached to an Element");this._mouse.attach(this._element)},_proto._enableKeyboard=function _enableKeyboard(){if(this._keyboard=new Keyboard,!this._element)throw new Error("Controller must be attached to an Element");this._keyboard.attach(this._element)},Controller}(),targetX,targetY,vecA=new Vec3,vecB=new Vec3,rayA=new Ray,rayB=new Ray,rayC=new Ray;rayA.end=new Vec3,rayB.end=new Vec3,rayC.end=new Vec3;var _pq=new Vec3,_pa=new Vec3,_pb=new Vec3,_pc=new Vec3,_pd=new Vec3,_m=new Vec3,_sct=new Vec3,_accumulatedScale=new Vec2,_paddingTop=new Vec3,_paddingBottom=new Vec3,_paddingLeft=new Vec3,_paddingRight=new Vec3,_cornerBottomLeft=new Vec3,_cornerBottomRight=new Vec3,_cornerTopRight=new Vec3,_cornerTopLeft=new Vec3,ZERO_VEC4=new Vec4;function scalarTriple(p1,p2,p3){return _sct.cross(p1,p2).dot(p3)}function intersectLineQuad(p,q,corners){var v;if(_pq.sub2(q,p),_pa.sub2(corners[0],p),_pb.sub2(corners[1],p),_pc.sub2(corners[2],p),_m.cross(_pc,_pq),_pa.dot(_m)>=0){if(-_pb.dot(_m)<0)return!1;if(scalarTriple(_pq,_pb,_pa)<0)return!1}else{if(_pd.sub2(corners[3],p),_pd.dot(_m)<0)return!1;if(scalarTriple(_pq,_pa,_pd)<0)return!1}return!(_pq.sub2(corners[0],corners[2]).lengthSq()<1e-8)&&!(_pq.sub2(corners[1],corners[3]).lengthSq()<1e-8)}var ElementInputEvent=function(){function ElementInputEvent(event,element,camera){this.event=event,this.element=element,this.camera=camera,this._stopPropagation=!1}var _proto;return ElementInputEvent.prototype.stopPropagation=function stopPropagation(){this._stopPropagation=!0,this.event&&(this.event.stopImmediatePropagation(),this.event.stopPropagation())},ElementInputEvent}(),ElementMouseEvent=function(_ElementInputEvent){function ElementMouseEvent(event,element,camera,x,y,lastX,lastY){var _this;return(_this=_ElementInputEvent.call(this,event,element,camera)||this).x=x,_this.y=y,_this.ctrlKey=event.ctrlKey||!1,_this.altKey=event.altKey||!1,_this.shiftKey=event.shiftKey||!1,_this.metaKey=event.metaKey||!1,_this.button=event.button,Mouse.isPointerLocked()?(_this.dx=event.movementX||event.webkitMovementX||event.mozMovementX||0,_this.dy=event.movementY||event.webkitMovementY||event.mozMovementY||0):(_this.dx=x-lastX,_this.dy=y-lastY),_this.wheelDelta=0,"wheel"===event.type&&(event.deltaY>0?_this.wheelDelta=1:event.deltaY<0&&(_this.wheelDelta=-1)),_this}return _inheritsLoose(ElementMouseEvent,_ElementInputEvent),ElementMouseEvent}(ElementInputEvent),ElementTouchEvent=function(_ElementInputEvent2){function ElementTouchEvent(event,element,camera,x,y,touch){var _this2;return(_this2=_ElementInputEvent2.call(this,event,element,camera)||this).touches=event.touches,_this2.changedTouches=event.changedTouches,_this2.x=x,_this2.y=y,_this2.touch=touch,_this2}return _inheritsLoose(ElementTouchEvent,_ElementInputEvent2),ElementTouchEvent}(ElementInputEvent),ElementSelectEvent=function(_ElementInputEvent3){function ElementSelectEvent(event,element,camera,inputSource){var _this3;return(_this3=_ElementInputEvent3.call(this,event,element,camera)||this).inputSource=inputSource,_this3}return _inheritsLoose(ElementSelectEvent,_ElementInputEvent3),ElementSelectEvent}(ElementInputEvent),ElementInput=function(){function ElementInput(domElement,options){this._app=null,this._attached=!1,this._target=null,this._enabled=!0,this._lastX=0,this._lastY=0,this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._touchstartHandler=this._handleTouchStart.bind(this),this._touchendHandler=this._handleTouchEnd.bind(this),this._touchcancelHandler=this._touchendHandler,this._touchmoveHandler=this._handleTouchMove.bind(this),this._sortHandler=this._sortElements.bind(this),this._elements=[],this._hoveredElement=null,this._pressedElement=null,this._touchedElements={},this._touchesForWhichTouchLeaveHasFired={},this._selectedElements={},this._selectedPressedElements={},this._useMouse=!options||!1!==options.useMouse,this._useTouch=!options||!1!==options.useTouch,this._useXr=!options||!1!==options.useXr,this._selectEventsAttached=!1,platform.touch&&(this._clickedEntities={}),this.attach(domElement)}var _proto2=ElementInput.prototype;return _proto2.attach=function attach(domElement){this._attached&&(this._attached=!1,this.detach()),this._target=domElement,this._attached=!0;var opts=!!platform.passiveEvents&&{passive:!0};this._useMouse&&(window.addEventListener("mouseup",this._upHandler,opts),window.addEventListener("mousedown",this._downHandler,opts),window.addEventListener("mousemove",this._moveHandler,opts),window.addEventListener("wheel",this._wheelHandler,opts)),this._useTouch&&platform.touch&&(this._target.addEventListener("touchstart",this._touchstartHandler,opts),this._target.addEventListener("touchend",this._touchendHandler,!1),this._target.addEventListener("touchmove",this._touchmoveHandler,!1),this._target.addEventListener("touchcancel",this._touchcancelHandler,!1)),this.attachSelectEvents()},_proto2.attachSelectEvents=function attachSelectEvents(){!this._selectEventsAttached&&this._useXr&&this.app&&this.app.xr&&this.app.xr.supported&&(this._clickedEntities||(this._clickedEntities={}),this._selectEventsAttached=!0,this.app.xr.on("start",this._onXrStart,this))},_proto2.detach=function detach(){if(this._attached){this._attached=!1;var opts=!!platform.passiveEvents&&{passive:!0};this._useMouse&&(window.removeEventListener("mouseup",this._upHandler,opts),window.removeEventListener("mousedown",this._downHandler,opts),window.removeEventListener("mousemove",this._moveHandler,opts),window.removeEventListener("wheel",this._wheelHandler,opts)),this._useTouch&&(this._target.removeEventListener("touchstart",this._touchstartHandler,opts),this._target.removeEventListener("touchend",this._touchendHandler,!1),this._target.removeEventListener("touchmove",this._touchmoveHandler,!1),this._target.removeEventListener("touchcancel",this._touchcancelHandler,!1)),this._selectEventsAttached&&(this._selectEventsAttached=!1,this.app.xr.off("start",this._onXrStart,this),this.app.xr.off("end",this._onXrEnd,this),this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)),this._target=null}},_proto2.addElement=function addElement(element){-1===this._elements.indexOf(element)&&this._elements.push(element)},_proto2.removeElement=function removeElement(element){var idx=this._elements.indexOf(element);-1!==idx&&this._elements.splice(idx,1)},_proto2._handleUp=function _handleUp(event){this._enabled&&(Mouse.isPointerLocked()||(this._calcMouseCoords(event),null!==targetX&&this._onElementMouseEvent("mouseup",event)))},_proto2._handleDown=function _handleDown(event){this._enabled&&(Mouse.isPointerLocked()||(this._calcMouseCoords(event),null!==targetX&&this._onElementMouseEvent("mousedown",event)))},_proto2._handleMove=function _handleMove(event){this._enabled&&(this._calcMouseCoords(event),null!==targetX&&(this._onElementMouseEvent("mousemove",event),this._lastX=targetX,this._lastY=targetY))},_proto2._handleWheel=function _handleWheel(event){this._enabled&&(this._calcMouseCoords(event),null!==targetX&&this._onElementMouseEvent("mousewheel",event))},_proto2._determineTouchedElements=function _determineTouchedElements(event){var touchedElements={},cameras=this.app.systems.camera.cameras,i,j,len;for(i=cameras.length-1;i>=0;i--){var camera=cameras[i],done=0;for(j=0,len=event.changedTouches.length;j<len;j++)if(touchedElements[event.changedTouches[j].identifier])done++;else{var coords=this._calcTouchCoords(event.changedTouches[j]),element=this._getTargetElement(camera,coords.x,coords.y);element&&(done++,touchedElements[event.changedTouches[j].identifier]={element:element,camera:camera,x:coords.x,y:coords.y})}if(done===len)break}return touchedElements},_proto2._handleTouchStart=function _handleTouchStart(event){if(this._enabled){for(var newTouchedElements=this._determineTouchedElements(event),i=0,len=event.changedTouches.length;i<len;i++){var touch=event.changedTouches[i],newTouchInfo=newTouchedElements[touch.identifier],oldTouchInfo=this._touchedElements[touch.identifier];!newTouchInfo||oldTouchInfo&&newTouchInfo.element===oldTouchInfo.element||(this._fireEvent(event.type,new ElementTouchEvent(event,newTouchInfo.element,newTouchInfo.camera,newTouchInfo.x,newTouchInfo.y,touch)),this._touchesForWhichTouchLeaveHasFired[touch.identifier]=!1)}for(var touchId in newTouchedElements)this._touchedElements[touchId]=newTouchedElements[touchId]}},_proto2._handleTouchEnd=function _handleTouchEnd(event){if(this._enabled){var cameras=this.app.systems.camera.cameras;for(var key in this._clickedEntities)delete this._clickedEntities[key];for(var i=0,len=event.changedTouches.length;i<len;i++){var touch=event.changedTouches[i],touchInfo=this._touchedElements[touch.identifier];if(touchInfo){var element=touchInfo.element,camera=touchInfo.camera,x=touchInfo.x,y=touchInfo.y;if(delete this._touchedElements[touch.identifier],delete this._touchesForWhichTouchLeaveHasFired[touch.identifier],this._fireEvent(event.type,new ElementTouchEvent(event,element,camera,x,y,touch)),0===event.touches.length)for(var coords=this._calcTouchCoords(touch),c=cameras.length-1;c>=0;c--){var hovered;this._getTargetElement(cameras[c],coords.x,coords.y)===element&&(this._clickedEntities[element.entity.getGuid()]||(this._fireEvent("click",new ElementTouchEvent(event,element,camera,x,y,touch)),this._clickedEntities[element.entity.getGuid()]=!0))}}}}},_proto2._handleTouchMove=function _handleTouchMove(event){if(event.preventDefault(),this._enabled)for(var newTouchedElements=this._determineTouchedElements(event),i=0,len=event.changedTouches.length;i<len;i++){var touch=event.changedTouches[i],newTouchInfo=newTouchedElements[touch.identifier],oldTouchInfo=this._touchedElements[touch.identifier];if(oldTouchInfo){var coords=this._calcTouchCoords(touch);newTouchInfo&&newTouchInfo.element===oldTouchInfo.element||this._touchesForWhichTouchLeaveHasFired[touch.identifier]||(this._fireEvent("touchleave",new ElementTouchEvent(event,oldTouchInfo.element,oldTouchInfo.camera,coords.x,coords.y,touch)),this._touchesForWhichTouchLeaveHasFired[touch.identifier]=!0),this._fireEvent("touchmove",new ElementTouchEvent(event,oldTouchInfo.element,oldTouchInfo.camera,coords.x,coords.y,touch))}}},_proto2._onElementMouseEvent=function _onElementMouseEvent(eventType,event){var element,hovered=this._hoveredElement;this._hoveredElement=null;for(var cameras=this.app.systems.camera.cameras,camera,i=cameras.length-1;i>=0&&(camera=cameras[i],!(element=this._getTargetElement(camera,targetX,targetY)));i--);element&&(this._fireEvent(eventType,new ElementMouseEvent(event,element,camera,targetX,targetY,this._lastX,this._lastY)),this._hoveredElement=element,"mousedown"===eventType&&(this._pressedElement=element)),hovered!==this._hoveredElement&&(hovered&&this._fireEvent("mouseleave",new ElementMouseEvent(event,hovered,camera,targetX,targetY,this._lastX,this._lastY)),this._hoveredElement&&this._fireEvent("mouseenter",new ElementMouseEvent(event,this._hoveredElement,camera,targetX,targetY,this._lastX,this._lastY))),"mouseup"===eventType&&this._pressedElement&&(this._pressedElement===this._hoveredElement?(this._pressedElement=null,this._clickedEntities&&this._clickedEntities[this._hoveredElement.entity.getGuid()]||this._fireEvent("click",new ElementMouseEvent(event,this._hoveredElement,camera,targetX,targetY,this._lastX,this._lastY))):this._pressedElement=null)},_proto2._onXrStart=function _onXrStart(){this.app.xr.on("end",this._onXrEnd,this),this.app.xr.on("update",this._onXrUpdate,this),this.app.xr.input.on("selectstart",this._onSelectStart,this),this.app.xr.input.on("selectend",this._onSelectEnd,this),this.app.xr.input.on("remove",this._onXrInputRemove,this)},_proto2._onXrEnd=function _onXrEnd(){this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)},_proto2._onXrUpdate=function _onXrUpdate(){if(this._enabled)for(var inputSources=this.app.xr.input.inputSources,i=0;i<inputSources.length;i++)this._onElementSelectEvent("selectmove",inputSources[i],null)},_proto2._onXrInputRemove=function _onXrInputRemove(inputSource){var hovered=this._selectedElements[inputSource.id];hovered&&(inputSource._elementEntity=null,this._fireEvent("selectleave",new ElementSelectEvent(null,hovered,null,inputSource))),delete this._selectedElements[inputSource.id],delete this._selectedPressedElements[inputSource.id]},_proto2._onSelectStart=function _onSelectStart(inputSource,event){this._enabled&&this._onElementSelectEvent("selectstart",inputSource,event)},_proto2._onSelectEnd=function _onSelectEnd(inputSource,event){this._enabled&&this._onElementSelectEvent("selectend",inputSource,event)},_proto2._onElementSelectEvent=function _onElementSelectEvent(eventType,inputSource,event){var element,hoveredBefore=this._selectedElements[inputSource.id],hoveredNow,cameras=this.app.systems.camera.cameras,camera;if(inputSource.elementInput){rayC.set(inputSource.getOrigin(),inputSource.getDirection());for(var i=cameras.length-1;i>=0&&(camera=cameras[i],!(element=this._getTargetElementByRay(rayC,camera)));i--);}inputSource._elementEntity=element||null,element?(this._selectedElements[inputSource.id]=element,hoveredNow=element):delete this._selectedElements[inputSource.id],hoveredBefore!==hoveredNow&&(hoveredBefore&&this._fireEvent("selectleave",new ElementSelectEvent(event,hoveredBefore,camera,inputSource)),hoveredNow&&this._fireEvent("selectenter",new ElementSelectEvent(event,hoveredNow,camera,inputSource))),"selectstart"===eventType&&(this._selectedPressedElements[inputSource.id]=hoveredNow,hoveredNow&&this._fireEvent("selectstart",new ElementSelectEvent(event,hoveredNow,camera,inputSource)));var pressed=this._selectedPressedElements[inputSource.id];!inputSource.elementInput&&pressed&&(delete this._selectedPressedElements[inputSource.id],hoveredBefore&&this._fireEvent("selectend",new ElementSelectEvent(event,hoveredBefore,camera,inputSource))),"selectend"===eventType&&inputSource.elementInput&&(delete this._selectedPressedElements[inputSource.id],hoveredBefore&&this._fireEvent("selectend",new ElementSelectEvent(event,hoveredBefore,camera,inputSource)),pressed&&pressed===hoveredBefore&&this._fireEvent("click",new ElementSelectEvent(event,pressed,camera,inputSource)))},_proto2._fireEvent=function _fireEvent(name,evt){for(var element=evt.element;element.fire(name,evt),!evt._stopPropagation&&element.entity.parent&&(element=element.entity.parent.element););},_proto2._calcMouseCoords=function _calcMouseCoords(event){var rect=this._target.getBoundingClientRect(),left=Math.floor(rect.left),top=Math.floor(rect.top);event.clientX<left||event.clientX>=left+this._target.clientWidth||event.clientY<top||event.clientY>=top+this._target.clientHeight?(targetX=null,targetY=null):(targetX=event.clientX-left,targetY=event.clientY-top)},_proto2._calcTouchCoords=function _calcTouchCoords(touch){for(var totalOffsetX=0,totalOffsetY=0,target=touch.target;!(target instanceof HTMLElement);)target=target.parentNode;var currentElement=target;do{totalOffsetX+=currentElement.offsetLeft-currentElement.scrollLeft,totalOffsetY+=currentElement.offsetTop-currentElement.scrollTop,currentElement=currentElement.offsetParent}while(currentElement);return{x:touch.pageX-totalOffsetX,y:touch.pageY-totalOffsetY}},_proto2._sortElements=function _sortElements(a,b){var layerOrder=this.app.scene.layers.sortTransparentLayers(a.layers,b.layers);return 0!==layerOrder?layerOrder:a.screen&&!b.screen?-1:!a.screen&&b.screen?1:a.screen||b.screen?a.screen.screen.screenSpace&&!b.screen.screen.screenSpace?-1:b.screen.screen.screenSpace&&!a.screen.screen.screenSpace?1:b.drawOrder-a.drawOrder:0},_proto2._getTargetElement=function _getTargetElement(camera,x,y){var result=null,rayScreen,ray3d;this._elements.sort(this._sortHandler);for(var i=0,len=this._elements.length;i<len;i++){var element=this._elements[i],screen=!1,ray;if(element.screen&&element.screen.screen.screenSpace?(void 0===rayScreen&&(rayScreen=rayA,!1===this._calculateRayScreen(x,y,camera,rayScreen)&&(rayScreen=null)),ray=rayScreen,screen=!0):(void 0===ray3d&&(ray3d=rayB,!1===this._calculateRay3d(x,y,camera,ray3d)&&(ray3d=null)),ray=ray3d),ray&&this._checkElement(ray,element,screen)){result=element;break}}return result},_proto2._getTargetElementByRay=function _getTargetElementByRay(ray,camera){var result=null;rayA.origin.copy(ray.origin),rayA.direction.copy(ray.direction),rayA.end.copy(rayA.direction).mulScalar(2*camera.farClip).add(rayA.origin),this._elements.sort(this._sortHandler);for(var i=0,len=this._elements.length;i<len;i++){var element=this._elements[i];if((!element.screen||!element.screen.screen.screenSpace)&&this._checkElement(rayA,element,!1)){result=element;break}}return result},_proto2._buildHitCorners=function _buildHitCorners(element,screenOrWorldCorners,scaleX,scaleY){var hitCorners=screenOrWorldCorners,button;if(element.entity&&element.entity.button){var hitPadding=element.entity.button.hitPadding||ZERO_VEC4;_paddingTop.copy(element.entity.up),_paddingBottom.copy(_paddingTop).mulScalar(-1),_paddingRight.copy(element.entity.right),_paddingLeft.copy(_paddingRight).mulScalar(-1),_paddingTop.mulScalar(hitPadding.w*scaleY),_paddingBottom.mulScalar(hitPadding.y*scaleY),_paddingRight.mulScalar(hitPadding.z*scaleX),_paddingLeft.mulScalar(hitPadding.x*scaleX),_cornerBottomLeft.copy(hitCorners[0]).add(_paddingBottom).add(_paddingLeft),_cornerBottomRight.copy(hitCorners[1]).add(_paddingBottom).add(_paddingRight),_cornerTopRight.copy(hitCorners[2]).add(_paddingTop).add(_paddingRight),_cornerTopLeft.copy(hitCorners[3]).add(_paddingTop).add(_paddingLeft),hitCorners=[_cornerBottomLeft,_cornerBottomRight,_cornerTopRight,_cornerTopLeft]}return hitCorners},_proto2._calculateScaleToScreen=function _calculateScaleToScreen(element){var current=element.entity,screenScale=element.screen.screen.scale;for(_accumulatedScale.set(screenScale,screenScale);current&&!current.screen;)_accumulatedScale.mul(current.getLocalScale()),current=current.parent;return _accumulatedScale},_proto2._calculateRayScreen=function _calculateRayScreen(x,y,camera,ray){var sw=this.app.graphicsDevice.width,sh=this.app.graphicsDevice.height,cameraWidth=camera.rect.z*sw,cameraHeight=camera.rect.w*sh,cameraLeft=camera.rect.x*sw,cameraRight=cameraLeft+cameraWidth,cameraBottom=(1-camera.rect.y)*sh,cameraTop=cameraBottom-cameraHeight,_x=x*sw/this._target.clientWidth,_y=y*sh/this._target.clientHeight;return _x>=cameraLeft&&_x<=cameraRight&&_y<=cameraBottom&&_y>=cameraTop&&(_x=sw*(_x-cameraLeft)/cameraWidth,_y=sh-(_y=sh*(_y-cameraTop)/cameraHeight),ray.origin.set(_x,_y,1),ray.direction.set(0,0,-1),ray.end.copy(ray.direction).mulScalar(2).add(ray.origin),!0)},_proto2._calculateRay3d=function _calculateRay3d(x,y,camera,ray){var sw=this._target.clientWidth,sh=this._target.clientHeight,cameraWidth=camera.rect.z*sw,cameraHeight=camera.rect.w*sh,cameraLeft=camera.rect.x*sw,cameraRight=cameraLeft+cameraWidth,cameraBottom=(1-camera.rect.y)*sh,cameraTop=cameraBottom-cameraHeight,_x=x,_y=y;return x>=cameraLeft&&x<=cameraRight&&y<=cameraBottom&&_y>=cameraTop&&(_x=sw*(_x-cameraLeft)/cameraWidth,_y=sh*(_y-cameraTop)/cameraHeight,camera.screenToWorld(_x,_y,camera.nearClip,vecA),camera.screenToWorld(_x,_y,camera.farClip,vecB),ray.origin.copy(vecA),ray.direction.set(0,0,-1),ray.end.copy(vecB),!0)},_proto2._checkElement=function _checkElement(ray,element,screen){var result,scale;if(element.maskedBy&&!this._checkElement(ray,element.maskedBy.element,screen))return!1;scale=screen?this._calculateScaleToScreen(element):element.entity.getWorldTransform().getScale();var corners=this._buildHitCorners(element,screen?element.screenCorners:element.worldCorners,scale.x,scale.y);return!!intersectLineQuad(ray.origin,ray.end,corners)},_createClass(ElementInput,[{key:"enabled",get:function get(){return this._enabled},set:function set(value){this._enabled=value}},{key:"app",get:function get(){return this._app||getApplication()},set:function set(value){this._app=value}}]),ElementInput}(),MAPS={DEFAULT:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_3","PAD_FACE_4","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]},PS3:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_4","PAD_FACE_3","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]}},PRODUCT_CODES={"Product: 0268":"PS3"},GamePads=function(){function GamePads(){this.gamepadsSupported=!!navigator.getGamepads||!!navigator.webkitGetGamepads,this.current=[],this.previous=[],this.deadZone=.25}var _proto=GamePads.prototype;return _proto.update=function update(){var i,j,l,buttons,buttonsLen;for(i=0,l=this.current.length;i<l;i++)for(buttonsLen=(buttons=this.current[i].pad.buttons).length,j=0;j<buttonsLen;j++)void 0===this.previous[i]&&(this.previous[i]=[]),this.previous[i][j]=buttons[j].pressed;this.poll(this.current)},_proto.poll=function poll(pads){if(void 0===pads&&(pads=[]),pads.length>0&&(pads.length=0),this.gamepadsSupported){var padDevices=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads(),i,len=padDevices.length;for(i=0;i<len;i++)padDevices[i]&&pads.push({map:this.getMap(padDevices[i]),pad:padDevices[i]})}return pads},_proto.getMap=function getMap(pad){for(var code in PRODUCT_CODES)if(pad.id.indexOf(code)>=0)return MAPS[PRODUCT_CODES[code]];return MAPS.DEFAULT},_proto.isPressed=function isPressed(index,button){if(!this.current[index])return!1;var key=this.current[index].map.buttons[button];return this.current[index].pad.buttons[pc[key]].pressed},_proto.wasPressed=function wasPressed(index,button){if(!this.current[index])return!1;var key=this.current[index].map.buttons[button],i=pc[key];return this.current[index].pad.buttons[i].pressed&&!(this.previous[index]&&this.previous[index][i])},_proto.wasReleased=function wasReleased(index,button){if(!this.current[index])return!1;var key=this.current[index].map.buttons[button],i=pc[key];return!this.current[index].pad.buttons[i].pressed&&this.previous[index]&&this.previous[index][i]},_proto.getAxis=function getAxis(index,axes){if(!this.current[index])return 0;var key=this.current[index].map.axes[axes],value=this.current[index].pad.axes[pc[key]];return Math.abs(value)<this.deadZone&&(value=0),value},GamePads}();function getTouchTargetCoords(touch){for(var totalOffsetX=0,totalOffsetY=0,target=touch.target;!(target instanceof HTMLElement);)target=target.parentNode;var currentElement=target;do{totalOffsetX+=currentElement.offsetLeft-currentElement.scrollLeft,totalOffsetY+=currentElement.offsetTop-currentElement.scrollTop,currentElement=currentElement.offsetParent}while(currentElement);return{x:touch.pageX-totalOffsetX,y:touch.pageY-totalOffsetY}}var Touch=function Touch(touch){var coords=getTouchTargetCoords(touch);this.id=touch.identifier,this.x=coords.x,this.y=coords.y,this.target=touch.target,this.touch=touch},TouchEvent=function(){function TouchEvent(device,event){if(this.element=event.target,this.event=event,this.touches=[],this.changedTouches=[],event){var i,l=event.touches.length;for(i=0;i<l;i++)this.touches.push(new Touch(event.touches[i]));for(l=event.changedTouches.length,i=0;i<l;i++)this.changedTouches.push(new Touch(event.changedTouches[i]))}}var _proto;return TouchEvent.prototype.getTouchById=function getTouchById(id,list){var i,l=list.length;for(i=0;i<l;i++)if(list[i].id===id)return list[i];return null},TouchEvent}(),TouchDevice=function(_EventHandler){function TouchDevice(element){var _this;return(_this=_EventHandler.call(this)||this)._element=null,_this._startHandler=_this._handleTouchStart.bind(_assertThisInitialized(_this)),_this._endHandler=_this._handleTouchEnd.bind(_assertThisInitialized(_this)),_this._moveHandler=_this._handleTouchMove.bind(_assertThisInitialized(_this)),_this._cancelHandler=_this._handleTouchCancel.bind(_assertThisInitialized(_this)),_this.attach(element),_this}_inheritsLoose(TouchDevice,_EventHandler);var _proto=TouchDevice.prototype;return _proto.attach=function attach(element){this._element&&this.detach(),this._element=element,this._element.addEventListener("touchstart",this._startHandler,!1),this._element.addEventListener("touchend",this._endHandler,!1),this._element.addEventListener("touchmove",this._moveHandler,!1),this._element.addEventListener("touchcancel",this._cancelHandler,!1)},_proto.detach=function detach(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1)),this._element=null},_proto._handleTouchStart=function _handleTouchStart(e){this.fire("touchstart",new TouchEvent(this,e))},_proto._handleTouchEnd=function _handleTouchEnd(e){this.fire("touchend",new TouchEvent(this,e))},_proto._handleTouchMove=function _handleTouchMove(e){e.preventDefault(),this.fire("touchmove",new TouchEvent(this,e))},_proto._handleTouchCancel=function _handleTouchCancel(e){this.fire("touchcancel",new TouchEvent(this,e))},TouchDevice}(EventHandler),log={write:function write(text){console.log(text)},open:function open(){log.write("Powered by PlayCanvas 1.43.1 49927b7")},info:function info(text){console.info("INFO:\t\t"+text)},debug:function debug(text){console.debug("DEBUG:\t "+text)},error:function error(text){console.error("ERROR:\t "+text)},warning:function warning(text){console.warn("WARNING: "+text)},alert:function(_alert){function alert(_x){return _alert.apply(this,arguments)}return alert.toString=function(){return _alert.toString()},alert}((function(text){log.write("ALERT:\t "+text),alert(text)})),assert:function assert(condition,text){!1===condition&&log.write("ASSERT:\t"+text)}};string.endsWith=function(s,subs){return s.endsWith(subs)},string.startsWith=function(s,subs){return s.startsWith(subs)};var time={now:now,Timer:Timer};function inherits(Self,Super){var Temp=function Temp(){},Func=function Func(arg1,arg2,arg3,arg4,arg5,arg6,arg7,arg8){Super.call(this,arg1,arg2,arg3,arg4,arg5,arg6,arg7,arg8),Self.call(this,arg1,arg2,arg3,arg4,arg5,arg6,arg7,arg8)};return Func._super=Super.prototype,Temp.prototype=Super.prototype,Func.prototype=new Temp,Func}function makeArray(arr){return Array.prototype.slice.call(arr)}Object.defineProperty(Color.prototype,"data",{get:function get(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.r,this._data[1]=this.g,this._data[2]=this.b,this._data[3]=this.a,this._data}}),Object.defineProperty(Color.prototype,"data3",{get:function get(){return this._data3||(this._data3=new Float32Array(3)),this._data3[0]=this.r,this._data3[1]=this.g,this._data3[2]=this.b,this._data3}}),math.INV_LOG2=Math.LOG2E,math.intToBytes=math.intToBytes32,math.bytesToInt=math.bytesToInt32,Object.defineProperty(Vec2.prototype,"data",{get:function get(){return this._data||(this._data=new Float32Array(2)),this._data[0]=this.x,this._data[1]=this.y,this._data}}),Vec2.prototype.scale=Vec2.prototype.mulScalar,Object.defineProperty(Vec3.prototype,"data",{get:function get(){return this._data||(this._data=new Float32Array(3)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data}}),Vec3.prototype.scale=Vec3.prototype.mulScalar,Object.defineProperty(Vec4.prototype,"data",{get:function get(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data[3]=this.w,this._data}}),Vec4.prototype.scale=Vec4.prototype.mulScalar;var shape={Aabb:BoundingBox,Sphere:BoundingSphere,Plane:Plane};BoundingSphere.prototype.intersectRay=BoundingSphere.prototype.intersectsRay,Frustum.prototype.update=function(projectionMatrix,viewMatrix){var viewProj=new Mat4;viewProj.mul2(projectionMatrix,viewMatrix),this.setFromMat4(viewProj)};var ELEMENTTYPE_INT8=0,ELEMENTTYPE_UINT8=1,ELEMENTTYPE_INT16=2,ELEMENTTYPE_UINT16=3,ELEMENTTYPE_INT32=4,ELEMENTTYPE_UINT32=5,ELEMENTTYPE_FLOAT32=6;function UnsupportedBrowserError(message){this.name="UnsupportedBrowserError",this.message=message||""}function ContextCreationError(message){this.name="ContextCreationError",this.message=message||""}UnsupportedBrowserError.prototype=Error.prototype,ContextCreationError.prototype=Error.prototype;var gfx={ADDRESS_CLAMP_TO_EDGE:1,ADDRESS_MIRRORED_REPEAT:2,ADDRESS_REPEAT:0,BLENDMODE_ZERO:0,BLENDMODE_ONE:1,BLENDMODE_SRC_COLOR:2,BLENDMODE_ONE_MINUS_SRC_COLOR:3,BLENDMODE_DST_COLOR:4,BLENDMODE_ONE_MINUS_DST_COLOR:5,BLENDMODE_SRC_ALPHA:6,BLENDMODE_SRC_ALPHA_SATURATE:7,BLENDMODE_ONE_MINUS_SRC_ALPHA:8,BLENDMODE_DST_ALPHA:9,BLENDMODE_ONE_MINUS_DST_ALPHA:10,BUFFER_STATIC:0,BUFFER_DYNAMIC:1,BUFFER_STREAM:2,CULLFACE_NONE:0,CULLFACE_BACK:1,CULLFACE_FRONT:2,CULLFACE_FRONTANDBACK:3,ELEMENTTYPE_INT8:0,ELEMENTTYPE_UINT8:1,ELEMENTTYPE_INT16:2,ELEMENTTYPE_UINT16:3,ELEMENTTYPE_INT32:4,ELEMENTTYPE_UINT32:5,ELEMENTTYPE_FLOAT32:6,FILTER_NEAREST:0,FILTER_LINEAR:1,FILTER_NEAREST_MIPMAP_NEAREST:2,FILTER_NEAREST_MIPMAP_LINEAR:3,FILTER_LINEAR_MIPMAP_NEAREST:4,FILTER_LINEAR_MIPMAP_LINEAR:5,INDEXFORMAT_UINT8:0,INDEXFORMAT_UINT16:1,INDEXFORMAT_UINT32:2,PIXELFORMAT_R5_G6_B5:3,PIXELFORMAT_R8_G8_B8:6,PIXELFORMAT_R8_G8_B8_A8:7,PRIMITIVE_POINTS:0,PRIMITIVE_LINES:1,PRIMITIVE_LINELOOP:2,PRIMITIVE_LINESTRIP:3,PRIMITIVE_TRIANGLES:4,PRIMITIVE_TRISTRIP:5,PRIMITIVE_TRIFAN:6,SEMANTIC_POSITION:"POSITION",SEMANTIC_NORMAL:"NORMAL",SEMANTIC_COLOR:"COLOR",SEMANTIC_TEXCOORD:"TEXCOORD",SEMANTIC_TEXCOORD0:"TEXCOORD0",SEMANTIC_TEXCOORD1:"TEXCOORD1",SEMANTIC_ATTR0:"ATTR0",SEMANTIC_ATTR1:"ATTR1",SEMANTIC_ATTR2:"ATTR2",SEMANTIC_ATTR3:"ATTR3",TEXTURELOCK_READ:1,TEXTURELOCK_WRITE:2,drawQuadWithShader:drawQuadWithShader,programlib:programlib,shaderChunks:shaderChunks,ContextCreationError:ContextCreationError,Device:GraphicsDevice,IndexBuffer:IndexBuffer,ProgramLibrary:ProgramLibrary,RenderTarget:RenderTarget,ScopeId:ScopeId,Shader:Shader,ShaderInput:ShaderInput,Texture:Texture,UnsupportedBrowserError:UnsupportedBrowserError,VertexBuffer:VertexBuffer,VertexFormat:VertexFormat,VertexIterator:VertexIterator},posteffect={createFullscreenQuad:createFullscreenQuad,drawFullscreenQuad:drawFullscreenQuad,PostEffect:PostEffect$1,PostEffectQueue:PostEffectQueue};Object.defineProperty(shaderChunks,"transformSkinnedVS",{get:function get(){return"#define SKIN\n"+shaderChunks.transformVS}}),Object.defineProperties(Texture.prototype,{rgbm:{get:function get(){return"rgbm"===this.type},set:function set(rgbm){this.type=rgbm?"rgbm":"default"}},swizzleGGGR:{get:function get(){return"swizzleGGGR"===this.type},set:function set(swizzleGGGR){this.type=swizzleGGGR?"swizzleGGGR":"default"}}});var PhongMaterial=StandardMaterial,scene={partitionSkin:partitionSkin,procedural:{calculateTangents:calculateTangents,createMesh:createMesh$1,createTorus:createTorus,createCylinder:createCylinder,createCapsule:createCapsule,createCone:createCone,createSphere:createSphere,createPlane:createPlane,createBox:createBox},BasicMaterial:BasicMaterial,Command:Command,DepthMaterial:DepthMaterial,ForwardRenderer:ForwardRenderer,GraphNode:GraphNode,Material:Material,Mesh:Mesh,MeshInstance:MeshInstance,Model:Model,ParticleEmitter:ParticleEmitter,PhongMaterial:StandardMaterial,Picker:Picker,Projection:{ORTHOGRAPHIC:1,PERSPECTIVE:0},Scene:Scene,Skin:Skin,SkinInstance:SkinInstance};GraphNode.prototype._dirtify=function(local){local?this._dirtifyLocal():this._dirtifyWorld()},GraphNode.prototype.addLabel=function(label){this._labels[label]=!0},GraphNode.prototype.getLabels=function(){return Object.keys(this._labels)},GraphNode.prototype.hasLabel=function(label){return!!this._labels[label]},GraphNode.prototype.removeLabel=function(label){delete this._labels[label]},GraphNode.prototype.findByLabel=function(label,results){var i,length=this._children.length;for(results=results||[],this.hasLabel(label)&&results.push(this),i=0;i<length;++i)results=this._children[i].findByLabel(label,results);return results},GraphNode.prototype.getChildren=function(){return this.children},GraphNode.prototype.getName=function(){return this.name},GraphNode.prototype.getPath=function(){return this.path},GraphNode.prototype.getRoot=function(){return this.root},GraphNode.prototype.getParent=function(){return this.parent},GraphNode.prototype.setName=function(name){this.name=name},Material.prototype.getName=function(){return this.name},Material.prototype.setName=function(name){this.name=name},Material.prototype.getShader=function(){return this.shader},Material.prototype.setShader=function(shader){this.shader=shader};var anim={Animation:Animation,Key:Key,Node:Node,Skeleton:Skeleton};Animation.prototype.getDuration=function(){return this.duration},Animation.prototype.getName=function(){return this.name},Animation.prototype.getNodes=function(){return this.nodes},Animation.prototype.setDuration=function(duration){this.duration=duration},Animation.prototype.setName=function(name){this.name=name},Skeleton.prototype.getAnimation=function(){return this.animation},Skeleton.prototype.getCurrentTime=function(){return this.currentTime},Skeleton.prototype.getLooping=function(){return this.looping},Skeleton.prototype.getNumNodes=function(){return this.numNodes},Skeleton.prototype.setAnimation=function(animation){this.animation=animation},Skeleton.prototype.setCurrentTime=function(time){this.currentTime=time},Skeleton.prototype.setLooping=function(looping){this.looping=looping};var audio={AudioManager:SoundManager,Channel:Channel,Channel3d:Channel3d,Listener:Listener,Sound:Sound};SoundManager.prototype.getListener=function(){return this.listener},SoundManager.prototype.getVolume=function(){return this.volume},SoundManager.prototype.setVolume=function(volume){this.volume=volume};var asset={ASSET_ANIMATION:"animation",ASSET_AUDIO:"audio",ASSET_IMAGE:"image",ASSET_JSON:"json",ASSET_MODEL:"model",ASSET_MATERIAL:"material",ASSET_TEXT:"text",ASSET_TEXTURE:"texture",ASSET_CUBEMAP:"cubemap",ASSET_SCRIPT:"script"};AssetRegistry.prototype.getAssetById=function(id){return this.get(id)},Object.defineProperty(XrInputSource.prototype,"ray",{get:function get(){return this._rayLocal}}),Object.defineProperty(XrInputSource.prototype,"position",{get:function get(){return this._localPosition}}),Object.defineProperty(XrInputSource.prototype,"rotation",{get:function get(){return this._localRotation}});var input={getTouchTargetCoords:getTouchTargetCoords,Controller:Controller,GamePads:GamePads,Keyboard:Keyboard,KeyboardEvent:KeyboardEvent,Mouse:Mouse,MouseEvent:MouseEvent,Touch:Touch,TouchDevice:TouchDevice,TouchEvent:TouchEvent};Object.defineProperty(ElementInput.prototype,"wheel",{get:function get(){return-2*this.wheelDelta}}),Object.defineProperty(MouseEvent.prototype,"wheel",{get:function get(){return-2*this.wheelDelta}});var RIGIDBODY_TYPE_STATIC="static",RIGIDBODY_TYPE_DYNAMIC="dynamic",RIGIDBODY_TYPE_KINEMATIC="kinematic",RIGIDBODY_CF_STATIC_OBJECT=1,RIGIDBODY_CF_KINEMATIC_OBJECT=2,RIGIDBODY_CF_NORESPONSE_OBJECT=4,RIGIDBODY_ACTIVE_TAG=1,RIGIDBODY_ISLAND_SLEEPING=2,RIGIDBODY_WANTS_DEACTIVATION=3,RIGIDBODY_DISABLE_DEACTIVATION=4,RIGIDBODY_DISABLE_SIMULATION=5,fw={Application:Application,Component:Component,ComponentSystem:ComponentSystem,Entity:Entity,FillMode:{NONE:"NONE",FILL_WINDOW:"FILL_WINDOW",KEEP_ASPECT:"KEEP_ASPECT"},ResolutionMode:{AUTO:"AUTO",FIXED:"FIXED"}};Application.prototype.isFullscreen=function(){return!!document.fullscreenElement},Application.prototype.enableFullscreen=function(element,success,error){element=element||this.graphicsDevice.canvas;var s=function s(){success(),document.removeEventListener("fullscreenchange",s)},e=function e(){error(),document.removeEventListener("fullscreenerror",e)};success&&document.addEventListener("fullscreenchange",s,!1),error&&document.addEventListener("fullscreenerror",e,!1),element.requestFullscreen?element.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):error()},Application.prototype.disableFullscreen=function(success){var s=function s(){success(),document.removeEventListener("fullscreenchange",s)};success&&document.addEventListener("fullscreenchange",s,!1),document.exitFullscreen()},Application.prototype.getSceneUrl=function(name){var entry=this.scenes.find(name);return entry?entry.url:null},Application.prototype.loadScene=function(url,callback){this.scenes.loadScene(url,callback)},Application.prototype.loadSceneHierarchy=function(url,callback){this.scenes.loadSceneHierarchy(url,callback)},Application.prototype.loadSceneSettings=function(url,callback){this.scenes.loadSceneSettings(url,callback)},Object.defineProperty(CameraComponent.prototype,"node",{get:function get(){return this.entity}}),Object.defineProperty(LightComponent.prototype,"enable",{get:function get(){return this.enabled},set:function set(value){this.enabled=value}}),ModelComponent.prototype.setVisible=function(visible){this.enabled=visible},Object.defineProperty(ModelComponent.prototype,"aabb",{get:function get(){return null},set:function set(type){}}),Object.defineProperty(RenderComponent.prototype,"aabb",{get:function get(){return null},set:function set(type){}}),Object.defineProperty(RigidBodyComponent.prototype,"bodyType",{get:function get(){return this.type},set:function set(type){this.type=type}}),RigidBodyComponent.prototype.syncBodyToEntity=function(){this._updateDynamic()},RigidBodyComponentSystem.prototype.setGravity=function(){1===arguments.length?this.gravity.copy(arguments[0]):this.gravity.set(arguments[0],arguments[1],arguments[2])},exports.ABSOLUTE_URL=ABSOLUTE_URL,exports.ACTION_GAMEPAD="gamepad",exports.ACTION_KEYBOARD="keyboard",exports.ACTION_MOUSE="mouse",exports.ADDRESS_CLAMP_TO_EDGE=1,exports.ADDRESS_MIRRORED_REPEAT=2,exports.ADDRESS_REPEAT=0,exports.ANIM_BLEND_1D="1D",exports.ANIM_BLEND_2D_CARTESIAN="2D_CARTESIAN",exports.ANIM_BLEND_2D_DIRECTIONAL="2D_DIRECTIONAL",exports.ANIM_BLEND_DIRECT="DIRECT",exports.ANIM_CONTROL_STATES=ANIM_CONTROL_STATES,exports.ANIM_EQUAL_TO="EQUAL_TO",exports.ANIM_GREATER_THAN="GREATER_THAN",exports.ANIM_GREATER_THAN_EQUAL_TO="GREATER_THAN_EQUAL_TO",exports.ANIM_INTERRUPTION_NEXT="NEXT_STATE",exports.ANIM_INTERRUPTION_NEXT_PREV="NEXT_STATE_PREV_STATE",exports.ANIM_INTERRUPTION_NONE="NONE",exports.ANIM_INTERRUPTION_PREV="PREV_STATE",exports.ANIM_INTERRUPTION_PREV_NEXT="PREV_STATE_NEXT_STATE",exports.ANIM_LESS_THAN="LESS_THAN",exports.ANIM_LESS_THAN_EQUAL_TO="LESS_THAN_EQUAL_TO",exports.ANIM_NOT_EQUAL_TO="NOT_EQUAL_TO",exports.ANIM_PARAMETER_BOOLEAN="BOOLEAN",exports.ANIM_PARAMETER_FLOAT="FLOAT",exports.ANIM_PARAMETER_INTEGER="INTEGER",exports.ANIM_PARAMETER_TRIGGER="TRIGGER",exports.ANIM_STATE_ANY="ANY",exports.ANIM_STATE_END="END",exports.ANIM_STATE_START="START",exports.ASPECT_AUTO=0,exports.ASPECT_MANUAL=1,exports.ASSET_ANIMATION="animation",exports.ASSET_AUDIO="audio",exports.ASSET_CONTAINER="container",exports.ASSET_CSS="css",exports.ASSET_CUBEMAP="cubemap",exports.ASSET_HTML="html",exports.ASSET_IMAGE="image",exports.ASSET_JSON="json",exports.ASSET_MATERIAL="material",exports.ASSET_MODEL="model",exports.ASSET_SCRIPT="script",exports.ASSET_SHADER="shader",exports.ASSET_TEXT="text",exports.ASSET_TEXTURE="texture",exports.AXIS_KEY="key",exports.AXIS_MOUSE_X="mousex",exports.AXIS_MOUSE_Y="mousey",exports.AXIS_PAD_L_X="padlx",exports.AXIS_PAD_L_Y="padly",exports.AXIS_PAD_R_X="padrx",exports.AXIS_PAD_R_Y="padry",exports.AnimBinder=AnimBinder,exports.AnimClip=AnimClip,exports.AnimClipHandler=AnimClipHandler,exports.AnimComponent=AnimComponent,exports.AnimComponentLayer=AnimComponentLayer,exports.AnimComponentSystem=AnimComponentSystem,exports.AnimController=AnimController,exports.AnimCurve=AnimCurve,exports.AnimData=AnimData,exports.AnimEvaluator=AnimEvaluator,exports.AnimEvents=AnimEvents,exports.AnimSnapshot=AnimSnapshot,exports.AnimStateGraph=AnimStateGraph,exports.AnimStateGraphHandler=AnimStateGraphHandler,exports.AnimTarget=AnimTarget,exports.AnimTrack=AnimTrack,exports.Animation=Animation,exports.AnimationComponent=AnimationComponent,exports.AnimationComponentSystem=AnimationComponentSystem,exports.AnimationHandler=AnimationHandler,exports.Application=Application,exports.Asset=Asset,exports.AssetListLoader=AssetListLoader,exports.AssetReference=AssetReference,exports.AssetRegistry=AssetRegistry,exports.AudioHandler=AudioHandler,exports.AudioListenerComponent=AudioListenerComponent,exports.AudioListenerComponentSystem=AudioListenerComponentSystem,exports.AudioSourceComponent=AudioSourceComponent,exports.AudioSourceComponentSystem=AudioSourceComponentSystem,exports.BAKE_COLOR=0,exports.BAKE_COLORDIR=1,exports.BLENDEQUATION_ADD=0,exports.BLENDEQUATION_MAX=4,exports.BLENDEQUATION_MIN=3,exports.BLENDEQUATION_REVERSE_SUBTRACT=2,exports.BLENDEQUATION_SUBTRACT=1,exports.BLENDMODE_DST_ALPHA=9,exports.BLENDMODE_DST_COLOR=4,exports.BLENDMODE_ONE=1,exports.BLENDMODE_ONE_MINUS_DST_ALPHA=10,exports.BLENDMODE_ONE_MINUS_DST_COLOR=5,exports.BLENDMODE_ONE_MINUS_SRC_ALPHA=8,exports.BLENDMODE_ONE_MINUS_SRC_COLOR=3,exports.BLENDMODE_SRC_ALPHA=6,exports.BLENDMODE_SRC_ALPHA_SATURATE=7,exports.BLENDMODE_SRC_COLOR=2,exports.BLENDMODE_ZERO=0,exports.BLEND_ADDITIVE=1,exports.BLEND_ADDITIVEALPHA=6,exports.BLEND_MAX=10,exports.BLEND_MIN=9,exports.BLEND_MULTIPLICATIVE=5,exports.BLEND_MULTIPLICATIVE2X=7,exports.BLEND_NONE=3,exports.BLEND_NORMAL=2,exports.BLEND_PREMULTIPLIED=4,exports.BLEND_SCREEN=8,exports.BLEND_SUBTRACTIVE=0,exports.BLUR_BOX=0,exports.BLUR_GAUSSIAN=1,exports.BODYFLAG_KINEMATIC_OBJECT=2,exports.BODYFLAG_NORESPONSE_OBJECT=4,exports.BODYFLAG_STATIC_OBJECT=1,exports.BODYGROUP_DEFAULT=1,exports.BODYGROUP_DYNAMIC=1,exports.BODYGROUP_ENGINE_1=8,exports.BODYGROUP_ENGINE_2=32,exports.BODYGROUP_ENGINE_3=64,exports.BODYGROUP_KINEMATIC=4,exports.BODYGROUP_NONE=0,exports.BODYGROUP_STATIC=2,exports.BODYGROUP_TRIGGER=16,exports.BODYGROUP_USER_1=128,exports.BODYGROUP_USER_2=256,exports.BODYGROUP_USER_3=512,exports.BODYGROUP_USER_4=1024,exports.BODYGROUP_USER_5=2048,exports.BODYGROUP_USER_6=4096,exports.BODYGROUP_USER_7=8192,exports.BODYGROUP_USER_8=16384,exports.BODYMASK_ALL=65535,exports.BODYMASK_NONE=0,exports.BODYMASK_NOT_STATIC=65533,exports.BODYMASK_NOT_STATIC_KINEMATIC=65529,exports.BODYMASK_STATIC=2,exports.BODYSTATE_ACTIVE_TAG=1,exports.BODYSTATE_DISABLE_DEACTIVATION=4,exports.BODYSTATE_DISABLE_SIMULATION=5,exports.BODYSTATE_ISLAND_SLEEPING=2,exports.BODYSTATE_WANTS_DEACTIVATION=3,exports.BODYTYPE_DYNAMIC="dynamic",exports.BODYTYPE_KINEMATIC="kinematic",exports.BODYTYPE_STATIC="static",exports.BUFFER_DYNAMIC=1,exports.BUFFER_GPUDYNAMIC=3,exports.BUFFER_STATIC=0,exports.BUFFER_STREAM=2,exports.BUTTON_TRANSITION_MODE_SPRITE_CHANGE=1,exports.BUTTON_TRANSITION_MODE_TINT=0,exports.BasicMaterial=BasicMaterial,exports.Batch=Batch,exports.BatchGroup=BatchGroup,exports.BatchManager=BatchManager,exports.BinaryHandler=BinaryHandler,exports.BoundingBox=BoundingBox,exports.BoundingSphere=BoundingSphere,exports.Bundle=Bundle,exports.BundleHandler=BundleHandler,exports.BundleRegistry=BundleRegistry,exports.ButtonComponent=ButtonComponent,exports.ButtonComponentSystem=ButtonComponentSystem,exports.CLEARFLAG_COLOR=1,exports.CLEARFLAG_DEPTH=2,exports.CLEARFLAG_STENCIL=4,exports.COMPUPDATED_BLEND=8,exports.COMPUPDATED_CAMERAS=4,exports.COMPUPDATED_INSTANCES=1,exports.COMPUPDATED_LIGHTS=2,exports.CUBEFACE_NEGX=1,exports.CUBEFACE_NEGY=3,exports.CUBEFACE_NEGZ=5,exports.CUBEFACE_POSX=0,exports.CUBEFACE_POSY=2,exports.CUBEFACE_POSZ=4,exports.CUBEPROJ_BOX=1,exports.CUBEPROJ_NONE=0,exports.CULLFACE_BACK=1,exports.CULLFACE_FRONT=2,exports.CULLFACE_FRONTANDBACK=3,exports.CULLFACE_NONE=0,exports.CURVE_CARDINAL=3,exports.CURVE_CATMULL=2,exports.CURVE_LINEAR=0,exports.CURVE_SMOOTHSTEP=1,exports.CURVE_SPLINE=4,exports.CURVE_STEP=5,exports.Camera=Camera,exports.CameraComponent=CameraComponent,exports.CameraComponentSystem=CameraComponentSystem,exports.CanvasFont=CanvasFont,exports.CollisionComponent=CollisionComponent,exports.CollisionComponentSystem=CollisionComponentSystem,exports.Color=Color,exports.Command=Command,exports.Component=Component,exports.ComponentSystem=ComponentSystem,exports.ComponentSystemRegistry=ComponentSystemRegistry,exports.ContactPoint=ContactPoint,exports.ContactResult=ContactResult,exports.ContainerHandler=ContainerHandler,exports.ContainerResource=ContainerResource,exports.ContextCreationError=ContextCreationError,exports.Controller=Controller,exports.CssHandler=CssHandler,exports.CubemapHandler=CubemapHandler,exports.Curve=Curve,exports.CurveSet=CurveSet,exports.DETAILMODE_ADD="add",exports.DETAILMODE_MAX="max",exports.DETAILMODE_MIN="min",exports.DETAILMODE_MUL="mul",exports.DETAILMODE_OVERLAY="overlay",exports.DETAILMODE_SCREEN="screen",exports.DISTANCE_EXPONENTIAL="exponential",exports.DISTANCE_INVERSE="inverse",exports.DISTANCE_LINEAR="linear",exports.DefaultAnimBinder=DefaultAnimBinder,exports.DepthMaterial=DepthMaterial,exports.ELEMENTTYPE_FLOAT32=6,exports.ELEMENTTYPE_GROUP="group",exports.ELEMENTTYPE_IMAGE="image",exports.ELEMENTTYPE_INT16=2,exports.ELEMENTTYPE_INT32=4,exports.ELEMENTTYPE_INT8=0,exports.ELEMENTTYPE_TEXT="text",exports.ELEMENTTYPE_UINT16=3,exports.ELEMENTTYPE_UINT32=5,exports.ELEMENTTYPE_UINT8=1,exports.EMITTERSHAPE_BOX=0,exports.EMITTERSHAPE_SPHERE=1,exports.EVENT_KEYDOWN="keydown",exports.EVENT_KEYUP="keyup",exports.EVENT_MOUSEDOWN="mousedown",exports.EVENT_MOUSEMOVE="mousemove",exports.EVENT_MOUSEUP="mouseup",exports.EVENT_MOUSEWHEEL="mousewheel",exports.EVENT_SELECT="select",exports.EVENT_SELECTEND="selectend",exports.EVENT_SELECTSTART="selectstart",exports.EVENT_TOUCHCANCEL="touchcancel",exports.EVENT_TOUCHEND="touchend",exports.EVENT_TOUCHMOVE="touchmove",exports.EVENT_TOUCHSTART="touchstart",exports.ElementComponent=ElementComponent,exports.ElementComponentSystem=ElementComponentSystem,exports.ElementDragHelper=ElementDragHelper,exports.ElementInput=ElementInput,exports.ElementInputEvent=ElementInputEvent,exports.ElementMouseEvent=ElementMouseEvent,exports.ElementSelectEvent=ElementSelectEvent,exports.ElementTouchEvent=ElementTouchEvent,exports.Entity=Entity,exports.EntityReference=EntityReference,exports.EventHandler=EventHandler,exports.FILLMODE_FILL_WINDOW="FILL_WINDOW",exports.FILLMODE_KEEP_ASPECT="KEEP_ASPECT",exports.FILLMODE_NONE="NONE",exports.FILTER_LINEAR=1,exports.FILTER_LINEAR_MIPMAP_LINEAR=5,exports.FILTER_LINEAR_MIPMAP_NEAREST=4,exports.FILTER_NEAREST=0,exports.FILTER_NEAREST_MIPMAP_LINEAR=3,exports.FILTER_NEAREST_MIPMAP_NEAREST=2,exports.FITTING_BOTH=3,exports.FITTING_NONE=0,exports.FITTING_SHRINK=2,exports.FITTING_STRETCH=1,exports.FOG_EXP="exp",exports.FOG_EXP2="exp2",exports.FOG_LINEAR="linear",exports.FOG_NONE="none",exports.FONT_BITMAP="bitmap",exports.FONT_MSDF="msdf",exports.FRESNEL_NONE=0,exports.FRESNEL_SCHLICK=2,exports.FUNC_ALWAYS=7,exports.FUNC_EQUAL=2,exports.FUNC_GREATER=4,exports.FUNC_GREATEREQUAL=6,exports.FUNC_LESS=1,exports.FUNC_LESSEQUAL=3,exports.FUNC_NEVER=0,exports.FUNC_NOTEQUAL=5,exports.FolderHandler=FolderHandler,exports.Font=Font,exports.FontHandler=FontHandler,exports.ForwardRenderer=ForwardRenderer,exports.Frustum=Frustum,exports.GAMMA_NONE=0,exports.GAMMA_SRGB=1,exports.GAMMA_SRGBFAST=2,exports.GAMMA_SRGBHDR=3,exports.GamePads=GamePads,exports.GraphNode=GraphNode,exports.GraphicsDevice=GraphicsDevice,exports.HierarchyHandler=HierarchyHandler,exports.HtmlHandler=HtmlHandler,exports.Http=Http,exports.I18n=I18n,exports.INDEXFORMAT_UINT16=1,exports.INDEXFORMAT_UINT32=2,exports.INDEXFORMAT_UINT8=0,exports.INTERPOLATION_CUBIC=2,exports.INTERPOLATION_LINEAR=1,exports.INTERPOLATION_STEP=0,exports.ImageElement=ImageElement,exports.IndexBuffer=IndexBuffer,exports.IndexedList=IndexedList,exports.JointComponent=JointComponent,exports.JointComponentSystem=JointComponentSystem,exports.JsonHandler=JsonHandler,exports.JsonStandardMaterialParser=JsonStandardMaterialParser,exports.KEY_0=48,exports.KEY_1=49,exports.KEY_2=50,exports.KEY_3=51,exports.KEY_4=52,exports.KEY_5=53,exports.KEY_6=54,exports.KEY_7=55,exports.KEY_8=56,exports.KEY_9=57,exports.KEY_A=65,exports.KEY_ADD=107,exports.KEY_ALT=18,exports.KEY_B=66,exports.KEY_BACKSPACE=8,exports.KEY_BACK_SLASH=220,exports.KEY_C=67,exports.KEY_CAPS_LOCK=20,exports.KEY_CLOSE_BRACKET=221,exports.KEY_COMMA=188,exports.KEY_CONTEXT_MENU=93,exports.KEY_CONTROL=17,exports.KEY_D=68,exports.KEY_DECIMAL=110,exports.KEY_DELETE=46,exports.KEY_DIVIDE=111,exports.KEY_DOWN=40,exports.KEY_E=69,exports.KEY_END=35,exports.KEY_ENTER=13,exports.KEY_EQUAL=61,exports.KEY_ESCAPE=27,exports.KEY_F=70,exports.KEY_F1=112,exports.KEY_F10=121,exports.KEY_F11=122,exports.KEY_F12=123,exports.KEY_F2=113,exports.KEY_F3=114,exports.KEY_F4=115,exports.KEY_F5=116,exports.KEY_F6=117,exports.KEY_F7=118,exports.KEY_F8=119,exports.KEY_F9=120,exports.KEY_G=71,exports.KEY_H=72,exports.KEY_HOME=36,exports.KEY_I=73,exports.KEY_INSERT=45,exports.KEY_J=74,exports.KEY_K=75,exports.KEY_L=76,exports.KEY_LEFT=37,exports.KEY_M=77,exports.KEY_META=224,exports.KEY_MULTIPLY=106,exports.KEY_N=78,exports.KEY_NUMPAD_0=96,exports.KEY_NUMPAD_1=97,exports.KEY_NUMPAD_2=98,exports.KEY_NUMPAD_3=99,exports.KEY_NUMPAD_4=100,exports.KEY_NUMPAD_5=101,exports.KEY_NUMPAD_6=102,exports.KEY_NUMPAD_7=103,exports.KEY_NUMPAD_8=104,exports.KEY_NUMPAD_9=105,exports.KEY_O=79,exports.KEY_OPEN_BRACKET=219,exports.KEY_P=80,exports.KEY_PAGE_DOWN=34,exports.KEY_PAGE_UP=33,exports.KEY_PAUSE=19,exports.KEY_PERIOD=190,exports.KEY_PRINT_SCREEN=44,exports.KEY_Q=81,exports.KEY_R=82,exports.KEY_RETURN=13,exports.KEY_RIGHT=39,exports.KEY_S=83,exports.KEY_SEMICOLON=59,exports.KEY_SEPARATOR=108,exports.KEY_SHIFT=16,exports.KEY_SLASH=191,exports.KEY_SPACE=32,exports.KEY_SUBTRACT=109,exports.KEY_T=84,exports.KEY_TAB=9,exports.KEY_U=85,exports.KEY_UP=38,exports.KEY_V=86,exports.KEY_W=87,exports.KEY_WINDOWS=91,exports.KEY_X=88,exports.KEY_Y=89,exports.KEY_Z=90,exports.Key=Key,exports.Keyboard=Keyboard,exports.KeyboardEvent=KeyboardEvent,exports.LAYERID_DEPTH=1,exports.LAYERID_IMMEDIATE=3,exports.LAYERID_SKYBOX=2,exports.LAYERID_UI=4,exports.LAYERID_WORLD=0,exports.LAYER_FX=2,exports.LAYER_GIZMO=1,exports.LAYER_HUD=0,exports.LAYER_WORLD=15,exports.LIGHTFALLOFF_INVERSESQUARED=1,exports.LIGHTFALLOFF_LINEAR=0,exports.LIGHTSHAPE_DISK=2,exports.LIGHTSHAPE_PUNCTUAL=0,exports.LIGHTSHAPE_RECT=1,exports.LIGHTSHAPE_SPHERE=3,exports.LIGHTTYPE_DIRECTIONAL=0,exports.LIGHTTYPE_OMNI=1,exports.LIGHTTYPE_POINT=1,exports.LIGHTTYPE_SPOT=2,exports.LINEBATCH_GIZMO=2,exports.LINEBATCH_OVERLAY=1,exports.LINEBATCH_WORLD=0,exports.Layer=Layer,exports.LayerComposition=LayerComposition,exports.LayoutCalculator=LayoutCalculator,exports.LayoutChildComponent=LayoutChildComponent,exports.LayoutChildComponentSystem=LayoutChildComponentSystem,exports.LayoutGroupComponent=LayoutGroupComponent,exports.LayoutGroupComponentSystem=LayoutGroupComponentSystem,exports.Light=Light,exports.LightComponent=LightComponent,exports.LightComponentSystem=LightComponentSystem,exports.Lightmapper=Lightmapper,exports.LocalizedAsset=LocalizedAsset,exports.MASK_BAKED=2,exports.MASK_DYNAMIC=1,exports.MASK_LIGHTMAP=4,exports.MOTION_FREE="free",exports.MOTION_LIMITED="limited",exports.MOTION_LOCKED="locked",exports.MOUSEBUTTON_LEFT=0,exports.MOUSEBUTTON_MIDDLE=1,exports.MOUSEBUTTON_NONE=-1,exports.MOUSEBUTTON_RIGHT=2,exports.Mat3=Mat3,exports.Mat4=Mat4,exports.Material=Material,exports.MaterialHandler=MaterialHandler,exports.Mesh=Mesh,exports.MeshInstance=MeshInstance,exports.Model=Model,exports.ModelComponent=ModelComponent,exports.ModelComponentSystem=ModelComponentSystem,exports.ModelHandler=ModelHandler,exports.Morph=Morph,exports.MorphInstance=MorphInstance,exports.MorphTarget=MorphTarget,exports.Mouse=Mouse,exports.MouseEvent=MouseEvent,exports.Node=Node,exports.ORIENTATION_HORIZONTAL=0,exports.ORIENTATION_VERTICAL=1,exports.OrientedBox=OrientedBox,exports.PAD_1=0,exports.PAD_2=1,exports.PAD_3=2,exports.PAD_4=3,exports.PAD_DOWN=13,exports.PAD_FACE_1=0,exports.PAD_FACE_2=1,exports.PAD_FACE_3=2,exports.PAD_FACE_4=3,exports.PAD_LEFT=14,exports.PAD_L_SHOULDER_1=4,exports.PAD_L_SHOULDER_2=6,exports.PAD_L_STICK_BUTTON=10,exports.PAD_L_STICK_X=0,exports.PAD_L_STICK_Y=1,exports.PAD_RIGHT=15,exports.PAD_R_SHOULDER_1=5,exports.PAD_R_SHOULDER_2=7,exports.PAD_R_STICK_BUTTON=11,exports.PAD_R_STICK_X=2,exports.PAD_R_STICK_Y=3,exports.PAD_SELECT=8,exports.PAD_START=9,exports.PAD_UP=12,exports.PAD_VENDOR=16,exports.PARTICLEMODE_CPU=1,exports.PARTICLEMODE_GPU=0,exports.PARTICLEORIENTATION_EMITTER=2,exports.PARTICLEORIENTATION_SCREEN=0,exports.PARTICLEORIENTATION_WORLD=1,exports.PARTICLESORT_DISTANCE=1,exports.PARTICLESORT_NEWER_FIRST=2,exports.PARTICLESORT_NONE=0,exports.PARTICLESORT_OLDER_FIRST=3,exports.PIXELFORMAT_111110F=18,exports.PIXELFORMAT_A8=0,exports.PIXELFORMAT_ASTC_4x4=28,exports.PIXELFORMAT_ATC_RGB=29,exports.PIXELFORMAT_ATC_RGBA=30,exports.PIXELFORMAT_DEPTH=16,exports.PIXELFORMAT_DEPTHSTENCIL=17,exports.PIXELFORMAT_DXT1=8,exports.PIXELFORMAT_DXT3=9,exports.PIXELFORMAT_DXT5=10,exports.PIXELFORMAT_ETC1=21,exports.PIXELFORMAT_ETC2_RGB=22,exports.PIXELFORMAT_ETC2_RGBA=23,exports.PIXELFORMAT_L8=1,exports.PIXELFORMAT_L8_A8=2,exports.PIXELFORMAT_PVRTC_2BPP_RGBA_1=25,exports.PIXELFORMAT_PVRTC_2BPP_RGB_1=24,exports.PIXELFORMAT_PVRTC_4BPP_RGBA_1=27,exports.PIXELFORMAT_PVRTC_4BPP_RGB_1=26,exports.PIXELFORMAT_R32F=15,exports.PIXELFORMAT_R4_G4_B4_A4=5,exports.PIXELFORMAT_R5_G5_B5_A1=4,exports.PIXELFORMAT_R5_G6_B5=3,exports.PIXELFORMAT_R8_G8_B8=6,exports.PIXELFORMAT_R8_G8_B8_A8=7,exports.PIXELFORMAT_RGB16F=11,exports.PIXELFORMAT_RGB32F=13,exports.PIXELFORMAT_RGBA16F=12,exports.PIXELFORMAT_RGBA32F=14,exports.PIXELFORMAT_SRGB=19,exports.PIXELFORMAT_SRGBA=20,exports.PRIMITIVE_LINELOOP=2,exports.PRIMITIVE_LINES=1,exports.PRIMITIVE_LINESTRIP=3,exports.PRIMITIVE_POINTS=0,exports.PRIMITIVE_TRIANGLES=4,exports.PRIMITIVE_TRIFAN=6,exports.PRIMITIVE_TRISTRIP=5,exports.PROJECTION_ORTHOGRAPHIC=1,exports.PROJECTION_PERSPECTIVE=0,exports.ParticleEmitter=ParticleEmitter,exports.ParticleSystemComponent=ParticleSystemComponent,exports.ParticleSystemComponentSystem=ParticleSystemComponentSystem,exports.PhongMaterial=PhongMaterial,exports.Picker=Picker,exports.Plane=Plane,exports.PostEffect=PostEffect$1,exports.PostEffectQueue=PostEffectQueue,exports.ProgramLibrary=ProgramLibrary,exports.Quat=Quat,exports.RENDERSTYLE_POINTS=2,exports.RENDERSTYLE_SOLID=0,exports.RENDERSTYLE_WIREFRAME=1,exports.RESOLUTION_AUTO="AUTO",exports.RESOLUTION_FIXED="FIXED",exports.RIGIDBODY_ACTIVE_TAG=1,exports.RIGIDBODY_CF_KINEMATIC_OBJECT=2,exports.RIGIDBODY_CF_NORESPONSE_OBJECT=4,exports.RIGIDBODY_CF_STATIC_OBJECT=1,exports.RIGIDBODY_DISABLE_DEACTIVATION=4,exports.RIGIDBODY_DISABLE_SIMULATION=5,exports.RIGIDBODY_ISLAND_SLEEPING=2,exports.RIGIDBODY_TYPE_DYNAMIC="dynamic",exports.RIGIDBODY_TYPE_KINEMATIC="kinematic",exports.RIGIDBODY_TYPE_STATIC="static",exports.RIGIDBODY_WANTS_DEACTIVATION=3,exports.Ray=Ray,exports.RaycastResult=RaycastResult,exports.RenderComponent=RenderComponent,exports.RenderComponentSystem=RenderComponentSystem,exports.RenderHandler=RenderHandler,exports.RenderTarget=RenderTarget,exports.ResourceHandler=ResourceHandler,exports.ResourceLoader=ResourceLoader,exports.RigidBodyComponent=RigidBodyComponent,exports.RigidBodyComponentSystem=RigidBodyComponentSystem,exports.SCALEMODE_BLEND="blend",exports.SCALEMODE_NONE="none",exports.SCROLLBAR_VISIBILITY_SHOW_ALWAYS=0,exports.SCROLLBAR_VISIBILITY_SHOW_WHEN_REQUIRED=1,exports.SCROLL_MODE_BOUNCE=1,exports.SCROLL_MODE_CLAMP=0,exports.SCROLL_MODE_INFINITE=2,exports.SEMANTIC_ATTR="ATTR",exports.SEMANTIC_ATTR0="ATTR0",exports.SEMANTIC_ATTR1="ATTR1",exports.SEMANTIC_ATTR10="ATTR10",exports.SEMANTIC_ATTR11="ATTR11",exports.SEMANTIC_ATTR12="ATTR12",exports.SEMANTIC_ATTR13="ATTR13",exports.SEMANTIC_ATTR14="ATTR14",exports.SEMANTIC_ATTR15="ATTR15",exports.SEMANTIC_ATTR2="ATTR2",exports.SEMANTIC_ATTR3="ATTR3",exports.SEMANTIC_ATTR4="ATTR4",exports.SEMANTIC_ATTR5="ATTR5",exports.SEMANTIC_ATTR6="ATTR6",exports.SEMANTIC_ATTR7="ATTR7",exports.SEMANTIC_ATTR8="ATTR8",exports.SEMANTIC_ATTR9="ATTR9",exports.SEMANTIC_BLENDINDICES="BLENDINDICES",exports.SEMANTIC_BLENDWEIGHT="BLENDWEIGHT",exports.SEMANTIC_COLOR="COLOR",exports.SEMANTIC_NORMAL="NORMAL",exports.SEMANTIC_POSITION="POSITION",exports.SEMANTIC_TANGENT="TANGENT",exports.SEMANTIC_TEXCOORD="TEXCOORD",exports.SEMANTIC_TEXCOORD0="TEXCOORD0",exports.SEMANTIC_TEXCOORD1="TEXCOORD1",exports.SEMANTIC_TEXCOORD2="TEXCOORD2",exports.SEMANTIC_TEXCOORD3="TEXCOORD3",exports.SEMANTIC_TEXCOORD4="TEXCOORD4",exports.SEMANTIC_TEXCOORD5="TEXCOORD5",exports.SEMANTIC_TEXCOORD6="TEXCOORD6",exports.SEMANTIC_TEXCOORD7="TEXCOORD7",exports.SHADERDEF_DIRLM=128,exports.SHADERDEF_INSTANCING=32,exports.SHADERDEF_LM=64,exports.SHADERDEF_MORPH_NORMAL=2048,exports.SHADERDEF_MORPH_POSITION=1024,exports.SHADERDEF_MORPH_TEXTURE_BASED=4096,exports.SHADERDEF_NOSHADOW=1,exports.SHADERDEF_SCREENSPACE=256,exports.SHADERDEF_SKIN=2,exports.SHADERDEF_TANGENTS=512,exports.SHADERDEF_UV0=4,exports.SHADERDEF_UV1=8,exports.SHADERDEF_VCOLOR=16,exports.SHADERTAG_MATERIAL=1,exports.SHADER_DEPTH=2,exports.SHADER_FORWARD=0,exports.SHADER_FORWARDHDR=1,exports.SHADER_PICK=18,exports.SHADER_SHADOW=3,exports.SHADOWUPDATE_NONE=0,exports.SHADOWUPDATE_REALTIME=2,exports.SHADOWUPDATE_THISFRAME=1,exports.SHADOW_COUNT=5,exports.SHADOW_DEPTH=0,exports.SHADOW_PCF3=0,exports.SHADOW_PCF5=4,exports.SHADOW_VSM16=2,exports.SHADOW_VSM32=3,exports.SHADOW_VSM8=1,exports.SORTKEY_DEPTH=1,exports.SORTKEY_FORWARD=0,exports.SORTMODE_BACK2FRONT=3,exports.SORTMODE_CUSTOM=5,exports.SORTMODE_FRONT2BACK=4,exports.SORTMODE_MANUAL=1,exports.SORTMODE_MATERIALMESH=2,exports.SORTMODE_NONE=0,exports.SPECOCC_AO=1,exports.SPECOCC_GLOSSDEPENDENT=2,exports.SPECOCC_NONE=0,exports.SPECULAR_BLINN=1,exports.SPECULAR_PHONG=0,exports.SPRITETYPE_ANIMATED="animated",exports.SPRITETYPE_SIMPLE="simple",exports.SPRITE_RENDERMODE_SIMPLE=0,exports.SPRITE_RENDERMODE_SLICED=1,exports.SPRITE_RENDERMODE_TILED=2,exports.STENCILOP_DECREMENT=5,exports.STENCILOP_DECREMENTWRAP=6,exports.STENCILOP_INCREMENT=3,exports.STENCILOP_INCREMENTWRAP=4,exports.STENCILOP_INVERT=7,exports.STENCILOP_KEEP=0,exports.STENCILOP_REPLACE=2,exports.STENCILOP_ZERO=1,exports.Scene=Scene,exports.SceneHandler=SceneHandler,exports.SceneRegistry=SceneRegistry,exports.SceneRegistryItem=SceneRegistryItem,exports.SceneSettingsHandler=SceneSettingsHandler,exports.ScopeId=ScopeId,exports.ScopeSpace=ScopeSpace,exports.ScreenComponent=ScreenComponent,exports.ScreenComponentSystem=ScreenComponentSystem,exports.ScriptAttributes=ScriptAttributes,exports.ScriptComponent=ScriptComponent,exports.ScriptComponentSystem=ScriptComponentSystem,exports.ScriptHandler=ScriptHandler,exports.ScriptLegacyComponent=ScriptLegacyComponent,exports.ScriptLegacyComponentSystem=ScriptLegacyComponentSystem,exports.ScriptRegistry=ScriptRegistry,exports.ScriptType=ScriptType,exports.ScrollViewComponent=ScrollViewComponent,exports.ScrollViewComponentSystem=ScrollViewComponentSystem,exports.ScrollbarComponent=ScrollbarComponent,exports.ScrollbarComponentSystem=ScrollbarComponentSystem,exports.Shader=Shader,exports.ShaderHandler=ShaderHandler,exports.SingleContactResult=SingleContactResult,exports.Skeleton=Skeleton,exports.Skin=Skin,exports.SkinBatchInstance=SkinBatchInstance,exports.SkinInstance=SkinInstance,exports.SortedLoopArray=SortedLoopArray,exports.Sound=Sound,exports.SoundComponent=SoundComponent,exports.SoundComponentSystem=SoundComponentSystem,exports.SoundInstance=SoundInstance,exports.SoundInstance3d=SoundInstance3d,exports.SoundManager=SoundManager,exports.SoundSlot=SoundSlot,exports.Sprite=Sprite,exports.SpriteAnimationClip=SpriteAnimationClip,exports.SpriteComponent=SpriteComponent,exports.SpriteComponentSystem=SpriteComponentSystem,exports.SpriteHandler=SpriteHandler,exports.StandardMaterial=StandardMaterial,exports.StencilParameters=StencilParameters,exports.TEXHINT_ASSET=2,exports.TEXHINT_LIGHTMAP=3,exports.TEXHINT_NONE=0,exports.TEXHINT_SHADOWMAP=1,exports.TEXTURELOCK_READ=1,exports.TEXTURELOCK_WRITE=2,exports.TEXTUREPROJECTION_CUBE="cube",exports.TEXTUREPROJECTION_EQUIRECT="equirect",exports.TEXTUREPROJECTION_NONE="none",exports.TEXTUREPROJECTION_OCTAHEDRAL="octahedral",exports.TEXTURETYPE_DEFAULT="default",exports.TEXTURETYPE_RGBE="rgbe",exports.TEXTURETYPE_RGBM="rgbm",exports.TEXTURETYPE_SWIZZLEGGGR="swizzleGGGR",exports.TONEMAP_ACES=3,exports.TONEMAP_ACES2=4,exports.TONEMAP_FILMIC=1,exports.TONEMAP_HEJL=2,exports.TONEMAP_LINEAR=0,exports.TYPE_FLOAT32=6,exports.TYPE_INT16=2,exports.TYPE_INT32=4,exports.TYPE_INT8=0,exports.TYPE_UINT16=3,exports.TYPE_UINT32=5,exports.TYPE_UINT8=1,exports.Tags=Tags,exports.Template=Template,exports.TemplateHandler=TemplateHandler,exports.TextElement=TextElement,exports.TextHandler=TextHandler,exports.Texture=Texture,exports.TextureAtlas=TextureAtlas,exports.TextureAtlasHandler=TextureAtlasHandler,exports.TextureHandler=TextureHandler,exports.TextureParser=TextureParser,exports.Timer=Timer,exports.Touch=Touch,exports.TouchDevice=TouchDevice,exports.TouchEvent=TouchEvent,exports.TransformFeedback=TransformFeedback,exports.UNIFORMTYPE_BOOL=0,exports.UNIFORMTYPE_BVEC2=9,exports.UNIFORMTYPE_BVEC3=10,exports.UNIFORMTYPE_BVEC4=11,exports.UNIFORMTYPE_FLOAT=2,exports.UNIFORMTYPE_FLOATARRAY=17,exports.UNIFORMTYPE_INT=1,exports.UNIFORMTYPE_IVEC2=6,exports.UNIFORMTYPE_IVEC3=7,exports.UNIFORMTYPE_IVEC4=8,exports.UNIFORMTYPE_MAT2=12,exports.UNIFORMTYPE_MAT3=13,exports.UNIFORMTYPE_MAT4=14,exports.UNIFORMTYPE_TEXTURE2D=15,exports.UNIFORMTYPE_TEXTURE2D_SHADOW=18,exports.UNIFORMTYPE_TEXTURE3D=20,exports.UNIFORMTYPE_TEXTURECUBE=16,exports.UNIFORMTYPE_TEXTURECUBE_SHADOW=19;exports.UNIFORMTYPE_VEC2=3,exports.UNIFORMTYPE_VEC2ARRAY=21,exports.UNIFORMTYPE_VEC3=4,exports.UNIFORMTYPE_VEC3ARRAY=22,exports.UNIFORMTYPE_VEC4=5,exports.UNIFORMTYPE_VEC4ARRAY=23,exports.URI=URI,exports.UnsupportedBrowserError=UnsupportedBrowserError,exports.VIEW_CENTER=0,exports.VIEW_LEFT=1,exports.VIEW_RIGHT=2,exports.Vec2=Vec2,exports.Vec3=Vec3,exports.Vec4=Vec4,exports.VertexBuffer=VertexBuffer,exports.VertexFormat=VertexFormat,exports.VertexIterator=VertexIterator,exports.VrDisplay=VrDisplay,exports.VrManager=VrManager,exports.WorldClusters=WorldClusters,exports.XRDEPTHSENSINGFORMAT_F32="float32",exports.XRDEPTHSENSINGFORMAT_L8A8="luminance-alpha",exports.XRDEPTHSENSINGUSAGE_CPU="cpu-optimized",exports.XRDEPTHSENSINGUSAGE_GPU="gpu-optimized",exports.XRHAND_LEFT="left",exports.XRHAND_NONE="none",exports.XRHAND_RIGHT="right",exports.XRSPACE_BOUNDEDFLOOR="bounded-floor",exports.XRSPACE_LOCAL="local",exports.XRSPACE_LOCALFLOOR="local-floor",exports.XRSPACE_UNBOUNDED="unbounded",exports.XRSPACE_VIEWER="viewer",exports.XRTARGETRAY_GAZE="gaze",exports.XRTARGETRAY_POINTER="tracked-pointer",exports.XRTARGETRAY_SCREEN="screen",exports.XRTRACKABLE_MESH="mesh",exports.XRTRACKABLE_PLANE="plane",exports.XRTRACKABLE_POINT="point",exports.XRTYPE_AR=XRTYPE_AR,exports.XRTYPE_INLINE="inline",exports.XRTYPE_VR=XRTYPE_VR,exports.XrDepthSensing=XrDepthSensing,exports.XrDomOverlay=XrDomOverlay,exports.XrHitTest=XrHitTest,exports.XrHitTestSource=XrHitTestSource,exports.XrImageTracking=XrImageTracking,exports.XrInput=XrInput,exports.XrInputSource=XrInputSource,exports.XrLightEstimation=XrLightEstimation,exports.XrManager=XrManager,exports.XrPlane=XrPlane,exports.XrPlaneDetection=XrPlaneDetection,exports.XrTrackedImage=XrTrackedImage,exports.ZoneComponent=ZoneComponent,exports.ZoneComponentSystem=ZoneComponentSystem,exports.anim=anim,exports.apps=apps,exports.asset=asset,exports.audio=audio,exports.basisDownload=basisDownload,exports.basisDownloadFromConfig=basisDownloadFromConfig,exports.basisInitialize=basisInitialize,exports.basisSetDownloadConfig=basisSetDownloadConfig,exports.basisTargetFormat=basisTargetFormat,exports.basisTranscode=basisTranscode,exports.calculateNormals=calculateNormals,exports.calculateTangents=calculateTangents,exports.common=common,exports.config=config,exports.createBox=createBox,exports.createCapsule=createCapsule,exports.createCone=createCone,exports.createCylinder=createCylinder,exports.createMesh=createMesh$1,exports.createPlane=createPlane,exports.createScript=createScript,exports.createSphere=createSphere,exports.createStyle=createStyle,exports.createTorus=createTorus,exports.createURI=createURI,exports.data=data,exports.debug=debug,exports.drawFullscreenQuad=drawFullscreenQuad,exports.drawQuadWithShader=drawQuadWithShader,exports.drawTexture=drawTexture,exports.events=events,exports.extend=extend,exports.fw=fw,exports.getTouchTargetCoords=getTouchTargetCoords,exports.gfx=gfx,exports.guid=guid,exports.http=http,exports.inherits=inherits,exports.input=input,exports.isDefined=isDefined,exports.log=log,exports.makeArray=makeArray,exports.math=math,exports.now=now,exports.path=path,exports.platform=platform,exports.posteffect=posteffect,exports.prefilterCubemap=prefilterCubemap,exports.programlib=programlib,exports.registerScript=registerScript,exports.reprojectTexture=reprojectTexture,exports.revision=revision,exports.scene=scene,exports.script=script,exports.semanticToLocation=semanticToLocation,exports.shFromCubemap=shFromCubemap,exports.shaderChunks=shaderChunks,exports.shape=shape,exports.string=string,exports.time=time,exports.type=type$1,exports.typedArrayIndexFormats=typedArrayIndexFormats,exports.typedArrayIndexFormatsByteSize=typedArrayIndexFormatsByteSize,exports.typedArrayToType=typedArrayToType,exports.typedArrayTypes=typedArrayTypes,exports.typedArrayTypesByteSize=typedArrayTypesByteSize,exports.version=version,Object.defineProperty(exports,"__esModule",{value:!0})}));